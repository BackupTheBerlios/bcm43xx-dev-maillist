From linville at tuxdriver.com  Tue Oct  2 22:20:53 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Tue, 2 Oct 2007 16:20:53 -0400
Subject: [PATCH] b43: Leds spinlock SMP compilefix
In-Reply-To: <200709300004.36905.mb@bu3sch.de>
References: <200709300004.36905.mb@bu3sch.de>
Message-ID: <20071002202053.GB29361@tuxdriver.com>

I'll just roll this into the "b43: LED triggers support" patch.

Thanks,

John

On Sun, Sep 30, 2007 at 12:04:36AM +0200, Michael Buesch wrote:
> This was missing an address operator.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> 
> Index: wireless-2.6/drivers/net/wireless/b43/leds.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/b43/leds.c	2007-09-29 12:44:08.000000000 +0200
> +++ wireless-2.6/drivers/net/wireless/b43/leds.c	2007-09-30 00:02:18.000000000 +0200
> @@ -37,14 +37,14 @@ static void b43_led_turn_on(struct b43_w
>  	unsigned long flags;
>  	u16 ctl;
>  
> -	spin_lock_irqsave(wl->leds_lock, flags);
> +	spin_lock_irqsave(&wl->leds_lock, flags);
>  	ctl = b43_read16(dev, B43_MMIO_GPIO_CONTROL);
>  	if (activelow)
>  		ctl &= ~(1 << led_index);
>  	else
>  		ctl |= (1 << led_index);
>  	b43_write16(dev, B43_MMIO_GPIO_CONTROL, ctl);
> -	spin_unlock_irqrestore(wl->leds_lock, flags);
> +	spin_unlock_irqrestore(&wl->leds_lock, flags);
>  }
>  
>  static void b43_led_turn_off(struct b43_wldev *dev, u8 led_index,
> @@ -54,14 +54,14 @@ static void b43_led_turn_off(struct b43_
>  	unsigned long flags;
>  	u16 ctl;
>  
> -	spin_lock_irqsave(wl->leds_lock, flags);
> +	spin_lock_irqsave(&wl->leds_lock, flags);
>  	ctl = b43_read16(dev, B43_MMIO_GPIO_CONTROL);
>  	if (activelow)
>  		ctl |= (1 << led_index);
>  	else
>  		ctl &= ~(1 << led_index);
>  	b43_write16(dev, B43_MMIO_GPIO_CONTROL, ctl);
> -	spin_unlock_irqrestore(wl->leds_lock, flags);
> +	spin_unlock_irqrestore(&wl->leds_lock, flags);
>  }
>  
>  /* Callback from the LED subsystem. */

-- 
John W. Linville
linville at tuxdriver.com


From mb at bu3sch.de  Tue Oct  2 22:41:58 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 2 Oct 2007 22:41:58 +0200
Subject: [PATCH] b43: Leds spinlock SMP compilefix
In-Reply-To: <20071002202053.GB29361@tuxdriver.com>
References: <200709300004.36905.mb@bu3sch.de>
	<20071002202053.GB29361@tuxdriver.com>
Message-ID: <200710022241.58332.mb@bu3sch.de>

On Tuesday 02 October 2007 22:20:53 John W. Linville wrote:
> I'll just roll this into the "b43: LED triggers support" patch.

Yep, thanks a lot.

-- 
Greetings Michael.


From gavron at Wetwork.Net  Fri Oct  5 16:11:37 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Fri, 05 Oct 2007 07:11:37 -0700
Subject: What is the right way to pull the wireless-dev + b43 from the git
	tree?
Message-ID: <47064619.2020909@Wetwork.Net>

Here's the script that used to work:
#!/bin/sh
git clone 
git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git 
everything
cd everything
git checkout -b everything origin/everything


Here's what the first git buys me yesterday and today:
Initialized empty Git repository in /home/everything/.git/
fatal: The remote end hung up unexpectedly
fetch-pack from 
'git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git' 
failed.


What is the "right" way to pull the latest tree + the b43 drivers?

Thanks!

Ehud



From johannes at sipsolutions.net  Fri Oct  5 16:31:47 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 05 Oct 2007 16:31:47 +0200
Subject: What is the right way to pull the wireless-dev + b43 from the
	git tree?
In-Reply-To: <47064619.2020909@Wetwork.Net>
	(sfid-20071005_151242_793043_17972F4C)
References: <47064619.2020909@Wetwork.Net>
	(sfid-20071005_151242_793043_17972F4C)
Message-ID: <1191594707.7367.37.camel@johannes.berg>

wireless-dev is dead, see
http://marc.info/?l=linux-wireless&m=119152616425736&w=2

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071005/87a9246c/attachment.pgp>

From gavron at Wetwork.Net  Fri Oct  5 16:38:56 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Fri, 05 Oct 2007 07:38:56 -0700
Subject: What is the right way to pull the wireless-dev + b43 from the git
	tree?
In-Reply-To: <1191594707.7367.37.camel@johannes.berg>
References: <47064619.2020909@Wetwork.Net>
	<1191594707.7367.37.camel@johannes.berg>
Message-ID: <47064C80.7050505@Wetwork.Net>

Thank you.  I must have missed that note.  The new tree works great.  
RIP wireless-dev.  Long Live Everything.

Ehud

Johannes Berg wrote:
> wireless-dev is dead, see
> http://marc.info/?l=linux-wireless&m=119152616425736&w=2
>
> johannes
>   
> ------------------------------------------------------------------------
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   


From hs4233 at mail.mn-solutions.de  Fri Oct  5 16:36:20 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Fri, 5 Oct 2007 16:36:20 +0200
Subject: What is the right way to pull the wireless-dev + b43 from the git
	tree?
In-Reply-To: <47064619.2020909@Wetwork.Net>
References: <47064619.2020909@Wetwork.Net>
Message-ID: <200710051636.20434.hs4233@mail.mn-solutions.de>

wireless-dev has been declared "dead" by John W. Linville, use 
wireless-2.6.


From mb at bu3sch.de  Wed Oct 10 16:36:35 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 10 Oct 2007 16:36:35 +0200
Subject: [PATCH] b43: Use input-polldev for the rfkill switch
In-Reply-To: <d120d5000710100730j243247e1te570ff57522693eb@mail.gmail.com>
References: <200709281422.34434.mb@bu3sch.de>
	<d120d5000710100730j243247e1te570ff57522693eb@mail.gmail.com>
Message-ID: <200710101636.36082.mb@bu3sch.de>

On Wednesday 10 October 2007 16:30:35 Dmitry Torokhov wrote:
> Hi Michael,
> 
> On 9/28/07, Michael Buesch <mb at bu3sch.de> wrote:
> > This removes the direct call to rfkill on an rfkill event
> > and replaces it with an input device. This way userspace is also
> > notified about the event.
> >
> > Signed-off-by: Michael Buesch <mb at bu3sch.de>
> >
> > Index: wireless-2.6/drivers/net/wireless/b43/Kconfig
> > ===================================================================
> > --- wireless-2.6.orig/drivers/net/wireless/b43/Kconfig  2007-09-27 21:31:15.000000000 +0200
> > +++ wireless-2.6/drivers/net/wireless/b43/Kconfig       2007-09-28 12:34:23.000000000 +0200
> > @@ -70,7 +70,7 @@ config B43_LEDS
> >  # RFKILL support
> >  config B43_RFKILL
> >        bool
> > -       depends on B43 && RFKILL
> > +       depends on B43 && RFKILL && RFKILL_INPUT && INPUT_POLLDEV
> >        default y
> 
> I don't think that broadcom driver should depend on RFKILL_INPUT...
> RFKILL_INPUT is a default link between input and rfkill layers but it
> is by no means a mandatory component.
> 
> I think proper dependency should be:
> 
>         depends on B43 && RFKILL && INPUT
>         select INPUT_POLLDEV
> 

b43 rfkill support is useless without also having RFKILL_INPUT, as
the button reporting is done though it.
b43 does _not_ depend on RFKILL_INPUT, but b43-rfkill support is disabled,
if there's no RFKILL_INPUT compiled.

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Oct 10 17:00:47 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 10 Oct 2007 17:00:47 +0200
Subject: [PATCH] b43: Use input-polldev for the rfkill switch
In-Reply-To: <d120d5000710100751n7b43c3cek9a50e88661fa36c6@mail.gmail.com>
References: <200709281422.34434.mb@bu3sch.de> <200710101636.36082.mb@bu3sch.de>
	<d120d5000710100751n7b43c3cek9a50e88661fa36c6@mail.gmail.com>
Message-ID: <200710101700.47574.mb@bu3sch.de>

On Wednesday 10 October 2007 16:51:38 Dmitry Torokhov wrote:
> > > I don't think that broadcom driver should depend on RFKILL_INPUT...
> > > RFKILL_INPUT is a default link between input and rfkill layers but it
> > > is by no means a mandatory component.
> > >
> > > I think proper dependency should be:
> > >
> > >         depends on B43 && RFKILL && INPUT
> > >         select INPUT_POLLDEV
> > >
> >
> > b43 rfkill support is useless without also having RFKILL_INPUT, as
> > the button reporting is done though it.
> > b43 does _not_ depend on RFKILL_INPUT, but b43-rfkill support is disabled,
> > if there's no RFKILL_INPUT compiled.
> >
> 
> No, it is not. One can have a userspace daemon claiming the rfkill
> switch...

No, that's impossible with b43.

> We normally specify dependencies that are needed to build the code,
> not necessarily to use it. It's like various joystick drivers do not
> depend on joydev or evdev modules although most people would need
> these modules as well to use their joysticks. Or SCSI drivers don't
> depend on sd or sr being selected, etc, etc.

Yeah, well. As I said. This is not a dependency. It's an auto-select
option, which automatically selects the code.

-- 
Greetings Michael.


From seandarcy2 at gmail.com  Wed Oct 10 18:08:08 2007
From: seandarcy2 at gmail.com (sean darcy)
Date: Wed, 10 Oct 2007 12:08:08 -0400
Subject: 4311: trouble with Fedora 8 Test 3
Message-ID: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>

Compaq Presario C714NR, Intel GM965

uname -r
2.6.23-0.224.rc9.git6.fc8

lspci
01:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan
mini-PCI (rev 02)

Installed b43-fwcutter and followed the instructions at
http://linuxwireless.org/en/users/Drivers/b43#devicefirmware

Got http://downloads.openwrt.org/sources/broadcom-wl-4.80.53.0.tar.bz2

untarred that file and ran
b43-fwcutter -w /lib/firmare broadcom-wl-4.80.53.0/kmod/wl_apsta.o

that seemed to work, and populated /lib/firmware/b43/ with a bunch of
*.fw files.

Then rmmod b43; modprobe -vv b43. No errors. Nothing in syslog.

modprobe also loaded cfg80211 and mac80211.

Shouldn't I have seen the firmware being loaded in dmesg, or syslog?

Nothing at all about the 4311 card in dmesg.

Made sure NetworkManager was working. Restarted it. I can see the icon.
No connection. If I connect the wire it starts up the wired connection.

dmesg does show this error:

ssb: rev 60000000
WARNING: at drivers/ssb/main.c:889 ssb_tmslow_reject_bitmask() (Not tainted)

Call Trace:
 [<ffffffff88118878>] :ssb:ssb_tmslow_reject_bitmask+0x76/0x7f
 [<ffffffff88119062>] :ssb:ssb_device_is_enabled+0xf/0x39
 [<ffffffff8811b232>] :ssb:ssb_pcicore_init+0x19/0x4a
 [<ffffffff881185e2>] :ssb:ssb_attach_queued_buses+0x83/0x25e
 [<ffffffff88119ce8>] :ssb:ssb_pci_get_invariants+0x0/0x2ba
 [<ffffffff88118be8>] :ssb:ssb_bus_register+0x144/0x196
 [<ffffffff88118cea>] :ssb:ssb_bus_pcibus_register+0x2a/0x4b
 [<ffffffff8811a5a9>] :ssb:ssb_pcihost_probe+0x6f/0x9e
 [<ffffffff81137d8d>] pci_device_probe+0xd0/0x137
 [<ffffffff811a1033>] driver_probe_device+0xff/0x17c
 [<ffffffff811a11f8>] __driver_attach+0x90/0xcc
 [<ffffffff811a1168>] __driver_attach+0x0/0xcc
 [<ffffffff811a1168>] __driver_attach+0x0/0xcc
 [<ffffffff811a03ca>] bus_for_each_dev+0x43/0x6e
 [<ffffffff811a0742>] bus_add_driver+0x7b/0x19d
 [<ffffffff81137f6f>] __pci_register_driver+0x68/0x9a
 [<ffffffff880e9045>] :ssb:ssb_modinit+0x45/0x5d
 [<ffffffff8105d8b3>] sys_init_module+0x15d5/0x173a
 [<ffffffff8100bbfe>] system_call+0x7e/0x83

ssb: Sonics Silicon Backplane found on PCI device 0000:01:00.0

I also rmmod b43, and modprobe'd b43legacy. No help.

Any help appreciated.

sean


From linville at tuxdriver.com  Wed Oct 10 19:13:28 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 10 Oct 2007 13:13:28 -0400
Subject: 4311: trouble with Fedora 8 Test 3
In-Reply-To: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>
References: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>
Message-ID: <20071010171328.GH5962@tuxdriver.com>

On Wed, Oct 10, 2007 at 12:08:08PM -0400, sean darcy wrote:

> Nothing at all about the 4311 card in dmesg.
> 
> Made sure NetworkManager was working. Restarted it. I can see the icon.
> No connection. If I connect the wire it starts up the wired connection.

Please post the output of this command:

	cat /sys/bus/ssb/devices/ssb0\:0/uevent

I suspect that your device's core is too new to be supported.

> dmesg does show this error:
> 
> ssb: rev 60000000
> WARNING: at drivers/ssb/main.c:889 ssb_tmslow_reject_bitmask() (Not tainted)

Technically a warning, not an error. :-)

John
-- 
John W. Linville
linville at tuxdriver.com


From larry.finger at lwfinger.net  Thu Oct 11 03:21:51 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 10 Oct 2007 20:21:51 -0500
Subject: 4311: trouble with Fedora 8 Test 3
In-Reply-To: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>
References: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>
Message-ID: <470D7AAF.8070700@lwfinger.net>

sean darcy wrote:
> Compaq Presario C714NR, Intel GM965
> 
> uname -r
> 2.6.23-0.224.rc9.git6.fc8
> 
> lspci
> 01:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan
> mini-PCI (rev 02)

As John Linville suggested, rev 02 of the 4311's are not supported. At the moment, the reverse
engineers need to take apart the latest Broadcom driver and write the specifications for this
device. Until they find the time, this device will not work with either b43 or bcm43xx.

Sorry,

Larry



From Larry.Finger at lwfinger.net  Thu Oct 11 05:41:08 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 10 Oct 2007 22:41:08 -0500
Subject: [PATCH] b43legacy: LED triggers support
Message-ID: <470d9b54.jH9OkUY4SGOyxjaK%Larry.Finger@lwfinger.net>

Drive the LEDs through the generic LED triggers.

The patch to b43 by Michael Buesch <mb at bu3sch.de> has been ported to b43legacy.

Signed-off-by: Larry Finger <larry.finger at lwfinger.net>
---

John,

This patch is to be applied to the 'everything' branch of wireless-2.6.

Larry
---

 drivers/net/wireless/b43legacy/Kconfig     |    6
 drivers/net/wireless/b43legacy/Makefile    |   27 +
 drivers/net/wireless/b43legacy/b43legacy.h |    6
 drivers/net/wireless/b43legacy/leds.c      |  411 ++++++++++++-----------------
 drivers/net/wireless/b43legacy/leds.h      |   61 ++--
 drivers/net/wireless/b43legacy/main.c      |   40 --
 drivers/net/wireless/b43legacy/radio.c     |    2
 7 files changed, 242 insertions(+), 311 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Kconfig
+++ wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
@@ -34,6 +34,12 @@ config B43LEGACY_PCICORE_AUTOSELECT
 	select SSB_DRIVER_PCICORE
 	default y
 
+# LED support
+config B43LEGACY_LEDS
+	bool
+	depends on MAC80211_LEDS
+	default y
+
 config B43LEGACY_DEBUG
 	bool "Broadcom 43xx-legacy debugging"
 	depends on B43LEGACY
Index: wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/b43legacy.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
@@ -663,8 +663,10 @@ struct b43legacy_wldev {
 	/* Various statistics about the physical device. */
 	struct b43legacy_stats stats;
 
-#define B43legacy_NR_LEDS		4
-	struct b43legacy_led leds[B43legacy_NR_LEDS];
+	/* The device LEDs. */
+	struct b43legacy_led led_tx;
+	struct b43legacy_led led_rx;
+	struct b43legacy_led led_assoc;
 
 	/* Reason code of the last interrupt. */
 	u32 irq_reason;
Index: wireless-2.6/drivers/net/wireless/b43legacy/leds.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/leds.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/leds.c
@@ -1,13 +1,13 @@
 /*
 
-  Broadcom B43legacy wireless driver
+  Broadcom B43 wireless driver
+  LED control
 
   Copyright (c) 2005 Martin Langer <martin-langer at gmx.de>,
-		     Stefano Brivio <st3 at riseup.net>
-		     Michael Buesch <mb at bu3sch.de>
-		     Danny van Dyk <kugelfang at gentoo.org>
-		     Andreas Jaggi <andreas.jaggi at waterwave.ch>
-  Copyright (c) 2007 Larry Finger <Larry.Finger at lwfinger.net>
+  Copyright (c) 2005 Stefano Brivio <st3 at riseup.net>
+  Copyright (c) 2005-2007 Michael Buesch <mb at bu3sch.de>
+  Copyright (c) 2005 Danny van Dyk <kugelfang at gentoo.org>
+  Copyright (c) 2005 Andreas Jaggi <andreas.jaggi at waterwave.ch>
 
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
@@ -26,273 +26,208 @@
 
 */
 
-#include "leds.h"
 #include "b43legacy.h"
-#include "main.h"
-
-static void b43legacy_led_changestate(struct b43legacy_led *led)
-{
-	struct b43legacy_wldev *dev = led->dev;
-	const int index = led->index;
-	u16 ledctl;
+#include "leds.h"
 
-	B43legacy_WARN_ON(!(index >= 0 && index < B43legacy_NR_LEDS));
-	B43legacy_WARN_ON(!led->blink_interval);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	ledctl ^= (1 << index);
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-}
 
-static void b43legacy_led_blink(unsigned long d)
+static void b43legacy_led_turn_on(struct b43legacy_wldev *dev, u8 led_index,
+			    bool activelow)
 {
-	struct b43legacy_led *led = (struct b43legacy_led *)d;
-	struct b43legacy_wldev *dev = led->dev;
+	struct b43legacy_wl *wl = dev->wl;
 	unsigned long flags;
+	u16 ctl;
 
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	if (led->blink_interval) {
-		b43legacy_led_changestate(led);
-		mod_timer(&led->blink_timer, jiffies + led->blink_interval);
-	}
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
+	spin_lock_irqsave(&wl->leds_lock, flags);
+	ctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
+	if (activelow)
+		ctl &= ~(1 << led_index);
+	else
+		ctl |= (1 << led_index);
+	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ctl);
+	spin_unlock_irqrestore(&wl->leds_lock, flags);
 }
 
-static void b43legacy_led_blink_start(struct b43legacy_led *led,
-				      unsigned long interval)
+static void b43legacy_led_turn_off(struct b43legacy_wldev *dev, u8 led_index,
+			     bool activelow)
 {
-	if (led->blink_interval)
-		return;
-	led->blink_interval = interval;
-	b43legacy_led_changestate(led);
-	led->blink_timer.expires = jiffies + interval;
-	add_timer(&led->blink_timer);
+	struct b43legacy_wl *wl = dev->wl;
+	unsigned long flags;
+	u16 ctl;
+
+	spin_lock_irqsave(&wl->leds_lock, flags);
+	ctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
+	if (activelow)
+		ctl |= (1 << led_index);
+	else
+		ctl &= ~(1 << led_index);
+	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ctl);
+	spin_unlock_irqrestore(&wl->leds_lock, flags);
 }
 
-static void b43legacy_led_blink_stop(struct b43legacy_led *led, int sync)
+/* Callback from the LED subsystem. */
+static void b43legacy_led_brightness_set(struct led_classdev *led_dev,
+				   enum led_brightness brightness)
 {
+	struct b43legacy_led *led = container_of(led_dev, struct b43legacy_led,
+				    led_dev);
 	struct b43legacy_wldev *dev = led->dev;
-	const int index = led->index;
-	u16 ledctl;
+	bool radio_enabled;
 
-	if (!led->blink_interval)
-		return;
-	if (unlikely(sync))
-		del_timer_sync(&led->blink_timer);
-	else
-		del_timer(&led->blink_timer);
-	led->blink_interval = 0;
+	/* Checking the radio-enabled status here is slightly racy,
+	 * but we want to avoid the locking overhead and we don't care
+	 * whether the LED has the wrong state for a second. */
+	radio_enabled = (dev->phy.radio_on && dev->radio_hw_enable);
 
-	/* Make sure the LED is turned off. */
-	B43legacy_WARN_ON(!(index >= 0 && index < B43legacy_NR_LEDS));
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	if (led->activelow)
-		ledctl |= (1 << index);
+	if (brightness == LED_OFF || !radio_enabled)
+		b43legacy_led_turn_off(dev, led->index, led->activelow);
 	else
-		ledctl &= ~(1 << index);
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
+		b43legacy_led_turn_on(dev, led->index, led->activelow);
 }
 
-static void b43legacy_led_init_hardcoded(struct b43legacy_wldev *dev,
-					 struct b43legacy_led *led,
-					 int led_index)
-{
-	struct ssb_bus *bus = dev->dev->bus;
+static int b43legacy_register_led(struct b43legacy_wldev *dev,
+				  struct b43legacy_led *led,
+				  const char *name, char *default_trigger,
+				  u8 led_index, bool activelow)
+{
+	int err;
+
+	b43legacy_led_turn_off(dev, led_index, activelow);
+	if (led->dev)
+		return -EEXIST;
+	if (!default_trigger)
+		return -EINVAL;
+	led->dev = dev;
+	led->index = led_index;
+	led->activelow = activelow;
+	strncpy(led->name, name, sizeof(led->name));
+
+	led->led_dev.name = led->name;
+	led->led_dev.default_trigger = default_trigger;
+	led->led_dev.brightness_set = b43legacy_led_brightness_set;
+
+	err = led_classdev_register(dev->dev->dev, &led->led_dev);
+	if (err) {
+		b43legacywarn(dev->wl, "LEDs: Failed to register %s\n", name);
+		led->dev = NULL;
+		return err;
+	}
+	return 0;
+}
 
-	/* This function is called, if the behaviour (and activelow)
-	 * information for a LED is missing in the SPROM.
-	 * We hardcode the behaviour values for various devices here.
-	 * Note that the B43legacy_LED_TEST_XXX behaviour values can
-	 * be used to figure out which led is mapped to which index.
-	 */
-
-	switch (led_index) {
-	case 0:
-		led->behaviour = B43legacy_LED_ACTIVITY;
-		led->activelow = 1;
-		if (bus->boardinfo.vendor == PCI_VENDOR_ID_COMPAQ)
-			led->behaviour = B43legacy_LED_RADIO_ALL;
+static void b43legacy_unregister_led(struct b43legacy_led *led)
+{
+	if (!led->dev)
+		return;
+	led_classdev_unregister(&led->led_dev);
+	b43legacy_led_turn_off(led->dev, led->index, led->activelow);
+	led->dev = NULL;
+}
+
+static void b43legacy_map_led(struct b43legacy_wldev *dev,
+			u8 led_index,
+			enum b43legacy_led_behaviour behaviour,
+			bool activelow)
+{
+	struct ieee80211_hw *hw = dev->wl->hw;
+	char name[B43legacy_LED_MAX_NAME_LEN + 1];
+
+	/* Map the b43 specific LED behaviour value to the
+	 * generic LED triggers. */
+	switch (behaviour) {
+	case B43legacy_LED_INACTIVE:
+		break;
+	case B43legacy_LED_OFF:
+		b43legacy_led_turn_off(dev, led_index, activelow);
 		break;
-	case 1:
-		led->behaviour = B43legacy_LED_RADIO_B;
-		if (bus->boardinfo.vendor == PCI_VENDOR_ID_ASUSTEK)
-			led->behaviour = B43legacy_LED_ASSOC;
+	case B43legacy_LED_ON:
+		b43legacy_led_turn_on(dev, led_index, activelow);
 		break;
-	case 2:
-		led->behaviour = B43legacy_LED_RADIO_A;
+	case B43legacy_LED_ACTIVITY:
+	case B43legacy_LED_TRANSFER:
+	case B43legacy_LED_APTRANSFER:
+		snprintf(name, sizeof(name),
+			 "b43-%s:tx", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_tx, name,
+				 ieee80211_get_tx_led_name(hw),
+				 led_index, activelow);
+		snprintf(name, sizeof(name),
+			 "b43-%s:rx", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_rx, name,
+				 ieee80211_get_rx_led_name(hw),
+				 led_index, activelow);
 		break;
-	case 3:
-		led->behaviour = B43legacy_LED_OFF;
+	/*FIXME: We need another trigger for the "radio-on" LEDs below.
+	 *       Wiggle that somehow into the rfkill subsystem. */
+	case B43legacy_LED_RADIO_ALL:
+	case B43legacy_LED_RADIO_A:
+	case B43legacy_LED_RADIO_B:
+	case B43legacy_LED_MODE_BG:
+	case B43legacy_LED_WEIRD:
+	case B43legacy_LED_ASSOC:
+		snprintf(name, sizeof(name),
+			 "b43-%s:assoc", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_assoc, name,
+				 ieee80211_get_assoc_led_name(hw),
+				 led_index, activelow);
 		break;
 	default:
-		B43legacy_BUG_ON(1);
+		b43legacywarn(dev->wl, "LEDs: Unknown behaviour 0x%02X\n",
+			behaviour);
+		break;
 	}
 }
 
-int b43legacy_leds_init(struct b43legacy_wldev *dev)
+void b43legacy_leds_init(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_led *led;
+	struct ssb_bus *bus = dev->dev->bus;
 	u8 sprom[4];
 	int i;
+	enum b43legacy_led_behaviour behaviour;
+	bool activelow;
 
-	sprom[0] = dev->dev->bus->sprom.r1.gpio0;
-	sprom[1] = dev->dev->bus->sprom.r1.gpio1;
-	sprom[2] = dev->dev->bus->sprom.r1.gpio2;
-	sprom[3] = dev->dev->bus->sprom.r1.gpio3;
-
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		led->index = i;
-		led->dev = dev;
-		setup_timer(&led->blink_timer,
-			    b43legacy_led_blink,
-			    (unsigned long)led);
-
-		if (sprom[i] == 0xFF)
-			b43legacy_led_init_hardcoded(dev, led, i);
-		else {
-			led->behaviour = sprom[i] & B43legacy_LED_BEHAVIOUR;
-			led->activelow = !!(sprom[i] &
-					   B43legacy_LED_ACTIVELOW);
+	sprom[0] = bus->sprom.r1.gpio0;
+	sprom[1] = bus->sprom.r1.gpio1;
+	sprom[2] = bus->sprom.r1.gpio2;
+	sprom[3] = bus->sprom.r1.gpio3;
+
+	for (i = 0; i < 4; i++) {
+		if (sprom[i] == 0xFF) {
+			/* There is no LED information in the SPROM
+			 * for this LED. Hardcode it here. */
+			activelow = 0;
+			switch (i) {
+			case 0:
+				behaviour = B43legacy_LED_ACTIVITY;
+				activelow = 1;
+				if (bus->boardinfo.vendor == PCI_VENDOR_ID_COMPAQ)
+					behaviour = B43legacy_LED_RADIO_ALL;
+				break;
+			case 1:
+				behaviour = B43legacy_LED_RADIO_B;
+				if (bus->boardinfo.vendor == PCI_VENDOR_ID_ASUSTEK)
+					behaviour = B43legacy_LED_ASSOC;
+				break;
+			case 2:
+				behaviour = B43legacy_LED_RADIO_A;
+				break;
+			case 3:
+				behaviour = B43legacy_LED_OFF;
+				break;
+			default:
+				B43legacy_WARN_ON(1);
+				return;
+			}
+		} else {
+			behaviour = sprom[i] & B43legacy_LED_BEHAVIOUR;
+			activelow = !!(sprom[i] & B43legacy_LED_ACTIVELOW);
 		}
+		b43legacy_map_led(dev, i, behaviour, activelow);
 	}
-
-	return 0;
 }
 
 void b43legacy_leds_exit(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_led *led;
-	int i;
-
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		b43legacy_led_blink_stop(led, 1);
-	}
-	b43legacy_leds_switch_all(dev, 0);
-}
-
-void b43legacy_leds_update(struct b43legacy_wldev *dev, int activity)
-{
-	struct b43legacy_led *led;
-	struct b43legacy_phy *phy = &dev->phy;
-	const int transferring = (jiffies - dev->stats.last_tx)
-				  < B43legacy_LED_XFER_THRES;
-	int i;
-	int turn_on;
-	unsigned long interval = 0;
-	u16 ledctl;
-	unsigned long flags;
-	bool radio_enabled = (phy->radio_on && dev->radio_hw_enable);
-
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-
-		turn_on = 0;
-		switch (led->behaviour) {
-		case B43legacy_LED_INACTIVE:
-			continue;
-		case B43legacy_LED_OFF:
-			break;
-		case B43legacy_LED_ON:
-			turn_on = 1;
-			break;
-		case B43legacy_LED_ACTIVITY:
-			turn_on = activity;
-			break;
-		case B43legacy_LED_RADIO_ALL:
-			turn_on = radio_enabled;
-			break;
-		case B43legacy_LED_RADIO_A:
-			break;
-		case B43legacy_LED_RADIO_B:
-			turn_on = radio_enabled;
-			break;
-		case B43legacy_LED_MODE_BG:
-			if (phy->type == B43legacy_PHYTYPE_G && radio_enabled)
-				turn_on = 1;
-			break;
-		case B43legacy_LED_TRANSFER:
-			if (transferring)
-				b43legacy_led_blink_start(led,
-						B43legacy_LEDBLINK_MEDIUM);
-			else
-				b43legacy_led_blink_stop(led, 0);
-			continue;
-		case B43legacy_LED_APTRANSFER:
-			if (b43legacy_is_mode(dev->wl,
-						IEEE80211_IF_TYPE_AP)) {
-				if (transferring) {
-					interval = B43legacy_LEDBLINK_FAST;
-					turn_on = 1;
-				}
-			} else {
-				turn_on = 1;
-				if (transferring)
-					interval = B43legacy_LEDBLINK_FAST;
-				else
-					turn_on = 0;
-			}
-			if (turn_on)
-				b43legacy_led_blink_start(led, interval);
-			else
-				b43legacy_led_blink_stop(led, 0);
-			continue;
-		case B43legacy_LED_WEIRD:
-			break;
-		case B43legacy_LED_ASSOC:
-			turn_on = 1;
-#ifdef CONFIG_B43LEGACY_DEBUG
-		case B43legacy_LED_TEST_BLINKSLOW:
-			b43legacy_led_blink_start(led, B43legacy_LEDBLINK_SLOW);
-			continue;
-		case B43legacy_LED_TEST_BLINKMEDIUM:
-			b43legacy_led_blink_start(led,
-						   B43legacy_LEDBLINK_MEDIUM);
-			continue;
-		case B43legacy_LED_TEST_BLINKFAST:
-			b43legacy_led_blink_start(led, B43legacy_LEDBLINK_FAST);
-			continue;
-#endif /* CONFIG_B43LEGACY_DEBUG */
-		default:
-			B43legacy_BUG_ON(1);
-		};
-
-		if (led->activelow)
-			turn_on = !turn_on;
-		if (turn_on)
-			ledctl |= (1 << i);
-		else
-			ledctl &= ~(1 << i);
-	}
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
-}
-
-void b43legacy_leds_switch_all(struct b43legacy_wldev *dev, int on)
-{
-	struct b43legacy_led *led;
-	u16 ledctl;
-	int i;
-	int bit_on;
-	unsigned long flags;
-
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		if (led->behaviour == B43legacy_LED_INACTIVE)
-			continue;
-		if (on)
-			bit_on = led->activelow ? 0 : 1;
-		else
-			bit_on = led->activelow ? 1 : 0;
-		if (bit_on)
-			ledctl |= (1 << i);
-		else
-			ledctl &= ~(1 << i);
-	}
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
+	b43legacy_unregister_led(&dev->led_tx);
+	b43legacy_unregister_led(&dev->led_rx);
+	b43legacy_unregister_led(&dev->led_assoc);
 }
Index: wireless-2.6/drivers/net/wireless/b43legacy/Makefile
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Makefile
+++ wireless-2.6/drivers/net/wireless/b43legacy/Makefile
@@ -1,14 +1,17 @@
-obj-$(CONFIG_B43LEGACY) += b43legacy.o
-b43legacy-obj-$(CONFIG_B43LEGACY_DEBUG) += debugfs.o
+# b43legacy core
+b43legacy-y				+= main.o
+b43legacy-y				+= ilt.o
+b43legacy-y				+= phy.o
+b43legacy-y				+= radio.o
+b43legacy-y				+= sysfs.o
+b43legacy-y				+= xmit.o
+# b43legacy LED support
+b43legacy-$(CONFIG_B43LEGACY_LEDS)	+= leds.o
+# b43legacy debugging
+b43legacy-$(CONFIG_B43LEGACY_DEBUG)	+= debugfs.o
+# b43legacy DMA and PIO
+b43legacy-$(CONFIG_B43LEGACY_DMA)	+= dma.o
+b43legacy-$(CONFIG_B43LEGACY_PIO)	+= pio.o
 
-b43legacy-obj-$(CONFIG_B43LEGACY_DMA) += dma.o
-b43legacy-obj-$(CONFIG_B43LEGACY_PIO) += pio.o
+obj-$(CONFIG_B43LEGACY)			+= b43legacy.o
 
-b43legacy-objs := main.o \
-		ilt.o \
-		leds.o \
-		phy.o \
-		radio.o \
-		sysfs.o \
-		xmit.o \
-		$(b43legacy-obj-y)
Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -83,10 +83,6 @@ static int modparam_long_retry = B43lega
 module_param_named(long_retry, modparam_long_retry, int, 0444);
 MODULE_PARM_DESC(long_retry, "Long-Retry-Limit (0 - 15)");
 
-static int modparam_noleds;
-module_param_named(noleds, modparam_noleds, int, 0444);
-MODULE_PARM_DESC(noleds, "Turn off all LED activity");
-
 static char modparam_fwpostfix[16];
 module_param_string(fwpostfix, modparam_fwpostfix, 16, 0444);
 MODULE_PARM_DESC(fwpostfix, "Postfix for the firmware files to load.");
@@ -1217,7 +1213,6 @@ static void b43legacy_interrupt_tasklet(
 	u32 dma_reason[ARRAY_SIZE(dev->dma_reason)];
 	u32 merged_dma_reason = 0;
 	int i;
-	int activity = 0;
 	unsigned long flags;
 
 	spin_lock_irqsave(&dev->wl->irq_lock, flags);
@@ -1281,7 +1276,6 @@ static void b43legacy_interrupt_tasklet(
 			b43legacy_pio_rx(dev->pio.queue0);
 		else
 			b43legacy_dma_rx(dev->dma.rx_ring0);
-		/* We intentionally don't set "activity" to 1, here. */
 	}
 	B43legacy_WARN_ON(dma_reason[1] & B43legacy_DMAIRQ_RX_DONE);
 	B43legacy_WARN_ON(dma_reason[2] & B43legacy_DMAIRQ_RX_DONE);
@@ -1290,20 +1284,13 @@ static void b43legacy_interrupt_tasklet(
 			b43legacy_pio_rx(dev->pio.queue3);
 		else
 			b43legacy_dma_rx(dev->dma.rx_ring3);
-		activity = 1;
 	}
 	B43legacy_WARN_ON(dma_reason[4] & B43legacy_DMAIRQ_RX_DONE);
 	B43legacy_WARN_ON(dma_reason[5] & B43legacy_DMAIRQ_RX_DONE);
 
-	if (reason & B43legacy_IRQ_TX_OK) {
+	if (reason & B43legacy_IRQ_TX_OK)
 		handle_irq_transmit_status(dev);
-		activity = 1;
-		/* TODO: In AP mode, this also causes sending of powersave
-			 responses. */
-	}
 
-	if (!modparam_noleds)
-		b43legacy_leds_update(dev, activity);
 	b43legacy_interrupt_enable(dev, dev->irq_savedstate);
 	mmiowb();
 	spin_unlock_irqrestore(&dev->wl->irq_lock, flags);
@@ -1755,7 +1742,6 @@ static int b43legacy_gpio_init(struct b4
 			  B43legacy_MMIO_STATUS_BITFIELD)
 			  & 0xFFFF3FFF);
 
-	b43legacy_leds_switch_all(dev, 0);
 	b43legacy_write16(dev, B43legacy_MMIO_GPIO_MASK,
 			  b43legacy_read16(dev,
 			  B43legacy_MMIO_GPIO_MASK)
@@ -2008,8 +1994,7 @@ static bool b43legacy_is_hw_radio_enable
 static void b43legacy_chip_exit(struct b43legacy_wldev *dev)
 {
 	b43legacy_radio_turn_off(dev);
-	if (!modparam_noleds)
-		b43legacy_leds_exit(dev);
+	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
 	/* firmware is released later */
 }
@@ -2039,9 +2024,11 @@ static int b43legacy_chip_init(struct b4
 	err = b43legacy_gpio_init(dev);
 	if (err)
 		goto out; /* firmware is released later */
+	b43legacy_leds_init(dev);
+
 	err = b43legacy_upload_initvals(dev);
 	if (err)
-		goto err_gpio_cleanup;
+		goto err_leds_exit;
 	b43legacy_radio_turn_on(dev);
 
 	b43legacy_write16(dev, 0x03E6, 0x0000);
@@ -2120,7 +2107,8 @@ out:
 
 err_radio_off:
 	b43legacy_radio_turn_off(dev);
-err_gpio_cleanup:
+err_leds_exit:
+	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
 	goto out;
 }
@@ -2168,7 +2156,6 @@ static void b43legacy_periodic_every1sec
 		dev->radio_hw_enable = radio_hw_enable;
 		b43legacyinfo(dev->wl, "Radio hardware status changed to %s\n",
 		       (radio_hw_enable) ? "enabled" : "disabled");
-		b43legacy_leds_update(dev, 0);
 	}
 }
 
@@ -3494,18 +3481,13 @@ static int b43legacy_wireless_core_attac
 	else
 		have_bphy = 1;
 
-	/* Initialize LEDs structs. */
-	err = b43legacy_leds_init(dev);
-	if (err)
-		goto err_powerdown;
-
 	dev->phy.gmode = (have_gphy || have_bphy);
 	tmp = dev->phy.gmode ? B43legacy_TMSLOW_GMODE : 0;
 	b43legacy_wireless_core_reset(dev, tmp);
 
 	err = b43legacy_phy_versioning(dev);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 	/* Check if this device supports multiband. */
 	if (!pdev ||
 	    (pdev->device != 0x4312 &&
@@ -3531,10 +3513,10 @@ static int b43legacy_wireless_core_attac
 
 	err = b43legacy_validate_chipaccess(dev);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 	err = b43legacy_setup_modes(dev, have_bphy, have_gphy);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 
 	/* Now set some default "current_dev" */
 	if (!wl->current_dev)
@@ -3549,8 +3531,6 @@ static int b43legacy_wireless_core_attac
 out:
 	return err;
 
-err_leds_exit:
-	b43legacy_leds_exit(dev);
 err_powerdown:
 	ssb_bus_may_powerdown(bus);
 	return err;
Index: wireless-2.6/drivers/net/wireless/b43legacy/radio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/radio.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/radio.c
@@ -2113,7 +2113,6 @@ void b43legacy_radio_turn_on(struct b43l
 		B43legacy_BUG_ON(1);
 	}
 	phy->radio_on = 1;
-	b43legacy_leds_update(dev, 0);
 }
 
 void b43legacy_radio_turn_off(struct b43legacy_wldev *dev)
@@ -2135,7 +2134,6 @@ void b43legacy_radio_turn_off(struct b43
 		b43legacy_phy_write(dev, 0x0015, 0xAA00);
 	phy->radio_on = 0;
 	b43legacydbg(dev->wl, "Radio initialized\n");
-	b43legacy_leds_update(dev, 0);
 }
 
 void b43legacy_radio_clear_tssi(struct b43legacy_wldev *dev)
Index: wireless-2.6/drivers/net/wireless/b43legacy/leds.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/leds.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/leds.h
@@ -1,30 +1,33 @@
 #ifndef B43legacy_LEDS_H_
 #define B43legacy_LEDS_H_
 
+struct b43legacy_wldev;
+
+#ifdef CONFIG_B43LEGACY_LEDS
+
 #include <linux/types.h>
-#include <linux/timer.h>
+#include <linux/leds.h>
 
 
+#define B43legacy_LED_MAX_NAME_LEN	31
+
 struct b43legacy_led {
-	u8 behaviour;
-	bool activelow;
-	/* Index in the "leds" array in b43legacy_wldev */
-	u8 index;
 	struct b43legacy_wldev *dev;
-	struct timer_list blink_timer;
-	unsigned long blink_interval;
+	/* The LED class device */
+	struct led_classdev led_dev;
+	/* The index number of the LED. */
+	u8 index;
+	/* If activelow is true, the LED is ON if the
+	 * bit is switched off. */
+	bool activelow;
+	/* The unique name string for this LED device. */
+	char name[B43legacy_LED_MAX_NAME_LEN + 1];
 };
 
-/* Delay between state changes when blinking in jiffies */
-#define B43legacy_LEDBLINK_SLOW		(HZ / 1)
-#define B43legacy_LEDBLINK_MEDIUM	(HZ / 4)
-#define B43legacy_LEDBLINK_FAST		(HZ / 8)
-
-#define B43legacy_LED_XFER_THRES	(HZ / 100)
-
 #define B43legacy_LED_BEHAVIOUR		0x7F
 #define B43legacy_LED_ACTIVELOW		0x80
-enum { /* LED behaviour values */
+/* LED behaviour values */
+enum b43legacy_led_behaviour {
 	B43legacy_LED_OFF,
 	B43legacy_LED_ON,
 	B43legacy_LED_ACTIVITY,
@@ -37,20 +40,24 @@ enum { /* LED behaviour values */
 	B43legacy_LED_WEIRD,
 	B43legacy_LED_ASSOC,
 	B43legacy_LED_INACTIVE,
-
-	/* Behaviour values for testing.
-	 * With these values it is easier to figure out
-	 * the real behaviour of leds, in case the SPROM
-	 * is missing information.
-	 */
-	B43legacy_LED_TEST_BLINKSLOW,
-	B43legacy_LED_TEST_BLINKMEDIUM,
-	B43legacy_LED_TEST_BLINKFAST,
 };
 
-int b43legacy_leds_init(struct b43legacy_wldev *dev);
+void b43legacy_leds_init(struct b43legacy_wldev *dev);
 void b43legacy_leds_exit(struct b43legacy_wldev *dev);
-void b43legacy_leds_update(struct b43legacy_wldev *dev, int activity);
-void b43legacy_leds_switch_all(struct b43legacy_wldev *dev, int on);
+
+#else /* CONFIG_B43EGACY_LEDS */
+/* LED support disabled */
+
+struct b43legacy_led {
+	/* empty */
+};
+
+static inline void b43legacy_leds_init(struct b43legacy_wldev *dev)
+{
+}
+static inline void b43legacy_leds_exit(struct b43legacy_wldev *dev)
+{
+}
+#endif /* CONFIG_B43LEGACY_LEDS */
 
 #endif /* B43legacy_LEDS_H_ */


From Larry.Finger at lwfinger.net  Thu Oct 11 05:44:22 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 10 Oct 2007 22:44:22 -0500
Subject: [PATCH] b43legacy: RF-kill support
Message-ID: <470d9c16.jsEJ5S7w2qapRrTY%Larry.Finger@lwfinger.net>

This adds full support for the RFKILL button and the RFKILL LED trigger.

This is a port to b43legacy of a patch by Michael Buesch <mb at bu3sch.de>
for b43.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

John,

This patch is also to be applied to the everything branch of wireless-2.6.

Larry
---

 drivers/net/wireless/b43legacy/Kconfig     |    8 +
 drivers/net/wireless/b43legacy/Makefile    |    2
 drivers/net/wireless/b43legacy/b43legacy.h |    5
 drivers/net/wireless/b43legacy/leds.c      |    8 +
 drivers/net/wireless/b43legacy/main.c      |   18 ++-
 drivers/net/wireless/b43legacy/radio.c     |   13 +-
 drivers/net/wireless/b43legacy/radio.h     |    2
 drivers/net/wireless/b43legacy/rfkill.c    |  158 +++++++++++++++++++++++++++++
 drivers/net/wireless/b43legacy/rfkill.h    |   51 +++++++++
 9 files changed, 250 insertions(+), 15 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Kconfig
+++ wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
@@ -37,7 +37,13 @@ config B43LEGACY_PCICORE_AUTOSELECT
 # LED support
 config B43LEGACY_LEDS
 	bool
-	depends on MAC80211_LEDS
+	depends on B43LEGACY && MAC80211_LEDS
+	default y
+
+# RFKILL support
+config B43LEGACY_RFKILL
+	bool
+	depends on B43LEGACY && RFKILL
 	default y
 
 config B43LEGACY_DEBUG
Index: wireless-2.6/drivers/net/wireless/b43legacy/Makefile
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Makefile
+++ wireless-2.6/drivers/net/wireless/b43legacy/Makefile
@@ -5,6 +5,8 @@ b43legacy-y				+= phy.o
 b43legacy-y				+= radio.o
 b43legacy-y				+= sysfs.o
 b43legacy-y				+= xmit.o
+# b43 RFKILL button support
+b43legacy-$(CONFIG_B43LEGACY_RFKILL)	+= rfkill.o
 # b43legacy LED support
 b43legacy-$(CONFIG_B43LEGACY_LEDS)	+= leds.o
 # b43legacy debugging
Index: wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/b43legacy.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
@@ -19,6 +19,7 @@
 
 #include "debugfs.h"
 #include "leds.h"
+#include "rfkill.h"
 #include "phy.h"
 
 
@@ -592,6 +593,9 @@ struct b43legacy_wl {
 	u8 rng_initialized;
 	char rng_name[30 + 1];
 
+	/* The RF-kill button */
+	struct b43legacy_rfkill rfkill;
+
 	/* List of all wireless devices on this chip */
 	struct list_head devlist;
 	u8 nr_devs;
@@ -667,6 +671,7 @@ struct b43legacy_wldev {
 	struct b43legacy_led led_tx;
 	struct b43legacy_led led_rx;
 	struct b43legacy_led led_assoc;
+	struct b43legacy_led led_radio;
 
 	/* Reason code of the last interrupt. */
 	u32 irq_reason;
Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -1993,7 +1993,7 @@ static bool b43legacy_is_hw_radio_enable
 /* This is the opposite of b43legacy_chip_init() */
 static void b43legacy_chip_exit(struct b43legacy_wldev *dev)
 {
-	b43legacy_radio_turn_off(dev);
+	b43legacy_radio_turn_off(dev, 1);
 	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
 	/* firmware is released later */
@@ -2106,7 +2106,7 @@ out:
 	return err;
 
 err_radio_off:
-	b43legacy_radio_turn_off(dev);
+	b43legacy_radio_turn_off(dev, 1);
 err_leds_exit:
 	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
@@ -2154,8 +2154,7 @@ static void b43legacy_periodic_every1sec
 	radio_hw_enable = b43legacy_is_hw_radio_enabled(dev);
 	if (unlikely(dev->radio_hw_enable != radio_hw_enable)) {
 		dev->radio_hw_enable = radio_hw_enable;
-		b43legacyinfo(dev->wl, "Radio hardware status changed to %s\n",
-		       (radio_hw_enable) ? "enabled" : "disabled");
+		b43legacy_rfkill_toggled(dev, radio_hw_enable);
 	}
 }
 
@@ -2647,7 +2646,7 @@ static int b43legacy_dev_config(struct i
 					      " physically off. Press the"
 					      " button to turn it on.\n");
 		} else {
-			b43legacy_radio_turn_off(dev);
+			b43legacy_radio_turn_off(dev, 0);
 			b43legacyinfo(dev->wl, "Radio turned off by"
 				      " software\n");
 		}
@@ -3030,11 +3029,15 @@ static void b43legacy_wireless_core_exit
 	cancel_work_sync(&dev->restart_work);
 	mutex_lock(&wl->mutex);
 
+	mutex_unlock(&dev->wl->mutex);
+	b43legacy_rfkill_exit(dev);
+	mutex_lock(&dev->wl->mutex);
+
 	b43legacy_rng_exit(dev->wl);
 	b43legacy_pio_free(dev);
 	b43legacy_dma_free(dev);
 	b43legacy_chip_exit(dev);
-	b43legacy_radio_turn_off(dev);
+	b43legacy_radio_turn_off(dev, 1);
 	b43legacy_switch_analog(dev, 0);
 	if (phy->dyn_tssi_tbl)
 		kfree(phy->tssi2dbm);
@@ -3202,6 +3205,7 @@ static int b43legacy_wireless_core_init(
 	memset(wl->mac_addr, 0, ETH_ALEN);
 	b43legacy_upload_card_macaddress(dev);
 	b43legacy_security_init(dev);
+	b43legacy_rfkill_init(dev);
 	b43legacy_rng_init(wl);
 
 	b43legacy_set_status(dev, B43legacy_STAT_INITIALIZED);
@@ -3523,7 +3527,7 @@ static int b43legacy_wireless_core_attac
 		wl->current_dev = dev;
 	INIT_WORK(&dev->restart_work, b43legacy_chip_reset);
 
-	b43legacy_radio_turn_off(dev);
+	b43legacy_radio_turn_off(dev, 1);
 	b43legacy_switch_analog(dev, 0);
 	ssb_device_disable(dev->dev, 0);
 	ssb_bus_may_powerdown(bus);
Index: wireless-2.6/drivers/net/wireless/b43legacy/rfkill.c
===================================================================
--- /dev/null
+++ wireless-2.6/drivers/net/wireless/b43legacy/rfkill.c
@@ -0,0 +1,158 @@
+/*
+
+  Broadcom B43legacy wireless driver
+  RFKILL support
+
+  Copyright (c) 2007 Michael Buesch <mb at bu3sch.de>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; see the file COPYING.  If not, write to
+  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,
+  Boston, MA 02110-1301, USA.
+
+*/
+
+#include "rfkill.h"
+#include "radio.h"
+#include "b43legacy.h"
+
+
+static void b43legacy_notify_rfkill_press(struct work_struct *work)
+{
+	struct b43legacy_rfkill *rfk = container_of(work,
+						    struct b43legacy_rfkill,
+						    notify_work);
+	struct b43legacy_wl *wl = container_of(rfk, struct b43legacy_wl,
+				  rfkill);
+	struct b43legacy_wldev *dev;
+	enum rfkill_state state;
+
+	mutex_lock(&wl->mutex);
+	dev = wl->current_dev;
+	if (b43legacy_status(dev) < B43legacy_STAT_INITIALIZED) {
+		mutex_unlock(&wl->mutex);
+		return;
+	}
+	if (dev->radio_hw_enable)
+		state = RFKILL_STATE_ON;
+	else
+		state = RFKILL_STATE_OFF;
+	b43legacyinfo(wl, "Radio hardware status changed to %s\n",
+		dev->radio_hw_enable ? "ENABLED" : "DISABLED");
+	mutex_unlock(&wl->mutex);
+
+	if (rfk->rfkill) {
+		/* Be careful. This calls back into the software toggle
+		 * routines. So we must unlock before calling. */
+		rfkill_switch_all(rfk->rfkill->type, state);
+	}
+}
+
+/* Called when the RFKILL toggled in hardware.
+ * This is called with the mutex locked. */
+void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev, bool on)
+{
+	struct b43legacy_wl *wl = dev->wl;
+
+	B43legacy_WARN_ON(b43legacy_status(dev) < B43legacy_STAT_INITIALIZED);
+	/* Update the RF status asynchronously, as rfkill will
+	 * call back into the software toggle handler.
+	 * This would deadlock if done synchronously. */
+	queue_work(wl->hw->workqueue, &wl->rfkill.notify_work);
+}
+
+/* Called when the RFKILL toggled in software.
+ * This is called without locking. */
+static int b43legacy_rfkill_soft_toggle(void *data, enum rfkill_state state)
+{
+	struct b43legacy_wldev *dev = data;
+	struct b43legacy_wl *wl = dev->wl;
+	int err = 0;
+
+	mutex_lock(&wl->mutex);
+	if (b43legacy_status(dev) < B43legacy_STAT_INITIALIZED)
+		goto out_unlock;
+
+	switch (state) {
+	case RFKILL_STATE_ON:
+		if (!dev->radio_hw_enable) {
+			/* No luck. We can't toggle the hardware RF-kill
+			 * button from software. */
+			err = -EBUSY;
+			goto out_unlock;
+		}
+		if (!dev->phy.radio_on)
+			b43legacy_radio_turn_on(dev);
+		break;
+	case RFKILL_STATE_OFF:
+		if (dev->phy.radio_on)
+			b43legacy_radio_turn_off(dev, 0);
+		break;
+	}
+
+out_unlock:
+	mutex_unlock(&wl->mutex);
+
+	return err;
+}
+
+char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
+{
+	struct b43legacy_wl *wl = dev->wl;
+
+	if (!wl->rfkill.rfkill)
+		return NULL;
+	return rfkill_get_led_name(wl->rfkill.rfkill);
+}
+
+void b43legacy_rfkill_init(struct b43legacy_wldev *dev)
+{
+	struct b43legacy_wl *wl = dev->wl;
+	struct b43legacy_rfkill *rfk = &(wl->rfkill);
+	int err;
+
+	snprintf(rfk->name, sizeof(rfk->name),
+		 "b43legacy-%s", wiphy_name(wl->hw->wiphy));
+	rfk->rfkill = rfkill_allocate(dev->dev->dev, RFKILL_TYPE_WLAN);
+	if (!rfk->rfkill)
+		goto error;
+	rfk->rfkill->name = rfk->name;
+	rfk->rfkill->state = RFKILL_STATE_ON;
+	rfk->rfkill->data = dev;
+	rfk->rfkill->toggle_radio = b43legacy_rfkill_soft_toggle;
+	rfk->rfkill->user_claim_unsupported = 1;
+
+	INIT_WORK(&rfk->notify_work, b43legacy_notify_rfkill_press);
+
+	err = rfkill_register(rfk->rfkill);
+	if (err)
+		goto error;
+
+	return;
+error:
+	b43legacywarn(dev->wl, "Failed to initialize the RF-kill button\n");
+	rfkill_free(rfk->rfkill);
+	rfk->rfkill = NULL;
+}
+
+void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
+{
+	struct b43legacy_rfkill *rfk = &(dev->wl->rfkill);
+
+	if (!rfk->rfkill)
+		return;
+	cancel_work_sync(&rfk->notify_work);
+	rfkill_unregister(rfk->rfkill);
+	rfkill_free(rfk->rfkill);
+	rfk->rfkill = NULL;
+}
Index: wireless-2.6/drivers/net/wireless/b43legacy/rfkill.h
===================================================================
--- /dev/null
+++ wireless-2.6/drivers/net/wireless/b43legacy/rfkill.h
@@ -0,0 +1,51 @@
+#ifndef B43legacy_RFKILL_H_
+#define B43legacy_RFKILL_H_
+
+struct b43legacy_wldev;
+
+#ifdef CONFIG_B43LEGACY_RFKILL
+
+#include <linux/rfkill.h>
+#include <linux/workqueue.h>
+
+
+struct b43legacy_rfkill {
+	/* The RFKILL subsystem data structure */
+	struct rfkill *rfkill;
+	/* The unique name of this rfkill switch */
+	char name[32];
+	/* Workqueue for asynchronous notification. */
+	struct work_struct notify_work;
+};
+
+void b43legacy_rfkill_init(struct b43legacy_wldev *dev);
+void b43legacy_rfkill_exit(struct b43legacy_wldev *dev);
+void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev, bool on);
+char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev);
+
+
+#else /* CONFIG_B43LEGACY_RFKILL */
+/* No RFKILL support. */
+
+struct b43legacy_rfkill {
+	/* empty */
+};
+
+static inline void b43legacy_rfkill_init(struct b43legacy_wldev *dev)
+{
+}
+static inline void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
+{
+}
+static inline void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev,
+					    bool on)
+{
+}
+static inline char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
+{
+	return NULL;
+}
+
+#endif /* CONFIG_B43LEGACY_RFKILL */
+
+#endif /* B43legacy_RFKILL_H_ */
Index: wireless-2.6/drivers/net/wireless/b43legacy/leds.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/leds.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/leds.c
@@ -156,12 +156,16 @@ static void b43legacy_map_led(struct b43
 				 ieee80211_get_rx_led_name(hw),
 				 led_index, activelow);
 		break;
-	/*FIXME: We need another trigger for the "radio-on" LEDs below.
-	 *       Wiggle that somehow into the rfkill subsystem. */
 	case B43legacy_LED_RADIO_ALL:
 	case B43legacy_LED_RADIO_A:
 	case B43legacy_LED_RADIO_B:
 	case B43legacy_LED_MODE_BG:
+		snprintf(name, sizeof(name),
+			 "b43legacy-%s:radio", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_radio, name,
+				 b43legacy_rfkill_led_name(dev),
+				 led_index, activelow);
+		break;
 	case B43legacy_LED_WEIRD:
 	case B43legacy_LED_ASSOC:
 		snprintf(name, sizeof(name),
Index: wireless-2.6/drivers/net/wireless/b43legacy/radio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/radio.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/radio.c
@@ -2115,18 +2115,23 @@ void b43legacy_radio_turn_on(struct b43l
 	phy->radio_on = 1;
 }
 
-void b43legacy_radio_turn_off(struct b43legacy_wldev *dev)
+void b43legacy_radio_turn_off(struct b43legacy_wldev *dev, bool force)
 {
 	struct b43legacy_phy *phy = &dev->phy;
 
+	if (!phy->radio_on && !force)
+		return;
+
 	if (phy->type == B43legacy_PHYTYPE_G && dev->dev->id.revision >= 5) {
 		u16 rfover, rfoverval;
 
 		rfover = b43legacy_phy_read(dev, B43legacy_PHY_RFOVER);
 		rfoverval = b43legacy_phy_read(dev, B43legacy_PHY_RFOVERVAL);
-		phy->radio_off_context.rfover = rfover;
-		phy->radio_off_context.rfoverval = rfoverval;
-		phy->radio_off_context.valid = 1;
+		if (!force) {
+			phy->radio_off_context.rfover = rfover;
+			phy->radio_off_context.rfoverval = rfoverval;
+			phy->radio_off_context.valid = 1;
+		}
 		b43legacy_phy_write(dev, B43legacy_PHY_RFOVER, rfover | 0x008C);
 		b43legacy_phy_write(dev, B43legacy_PHY_RFOVERVAL,
 				    rfoverval & 0xFF73);
Index: wireless-2.6/drivers/net/wireless/b43legacy/radio.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/radio.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/radio.h
@@ -61,7 +61,7 @@ void b43legacy_radio_write16(struct b43l
 u16 b43legacy_radio_init2050(struct b43legacy_wldev *dev);
 
 void b43legacy_radio_turn_on(struct b43legacy_wldev *dev);
-void b43legacy_radio_turn_off(struct b43legacy_wldev *dev);
+void b43legacy_radio_turn_off(struct b43legacy_wldev *dev, bool force);
 
 int b43legacy_radio_selectchannel(struct b43legacy_wldev *dev, u8 channel,
 				  int synthetic_pu_workaround);


From Larry.Finger at lwfinger.net  Thu Oct 11 05:48:17 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 10 Oct 2007 22:48:17 -0500
Subject: [PATCH] b43legacy: Use input-polldev for the rfkill switch
Message-ID: <470d9d01.UuxzOJMBx/yAlBlD%Larry.Finger@lwfinger.net>

This removes the direct call to rfkill on an rfkill event
and replaces it with an input device. This way userspace is also
notified about the event.

This patch is the port to b43legacy of a patch for b43 by Michael Buesch
<mb at bu3sch.de>.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

As with the two previous LED-related patches, this is meant to be applied to
the everything branch of wireless-2.6.

Larry
---

 drivers/net/wireless/b43legacy/Kconfig  |    2
 drivers/net/wireless/b43legacy/main.c   |   49 ++---------
 drivers/net/wireless/b43legacy/rfkill.c |  135 +++++++++++++++++++-------------
 drivers/net/wireless/b43legacy/rfkill.h |   26 ++++--
 4 files changed, 109 insertions(+), 103 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Kconfig
+++ wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
@@ -43,7 +43,7 @@ config B43LEGACY_LEDS
 # RFKILL support
 config B43LEGACY_RFKILL
 	bool
-	depends on B43LEGACY && RFKILL
+	depends on B43LEGACY && RFKILL && RFKILL_INPUT && INPUT_POLLDEV
 	default y
 
 config B43LEGACY_DEBUG
Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -1975,21 +1975,6 @@ static void b43legacy_mgmtframe_txantenn
 			      B43legacy_SHM_SH_PRPHYCTL, tmp);
 }
 
-/* Returns TRUE, if the radio is enabled in hardware. */
-static bool b43legacy_is_hw_radio_enabled(struct b43legacy_wldev *dev)
-{
-	if (dev->phy.rev >= 3) {
-		if (!(b43legacy_read32(dev, B43legacy_MMIO_RADIO_HWENABLED_HI)
-		      & B43legacy_MMIO_RADIO_HWENABLED_HI_MASK))
-			return 1;
-	} else {
-		if (b43legacy_read16(dev, B43legacy_MMIO_RADIO_HWENABLED_LO)
-		    & B43legacy_MMIO_RADIO_HWENABLED_LO_MASK)
-			return 1;
-	}
-	return 0;
-}
-
 /* This is the opposite of b43legacy_chip_init() */
 static void b43legacy_chip_exit(struct b43legacy_wldev *dev)
 {
@@ -2146,32 +2131,18 @@ static void b43legacy_periodic_every15se
 	b43legacy_phy_xmitpower(dev); /* FIXME: unless scanning? */
 }
 
-static void b43legacy_periodic_every1sec(struct b43legacy_wldev *dev)
-{
-	bool radio_hw_enable;
-
-	/* check if radio hardware enabled status changed */
-	radio_hw_enable = b43legacy_is_hw_radio_enabled(dev);
-	if (unlikely(dev->radio_hw_enable != radio_hw_enable)) {
-		dev->radio_hw_enable = radio_hw_enable;
-		b43legacy_rfkill_toggled(dev, radio_hw_enable);
-	}
-}
-
 static void do_periodic_work(struct b43legacy_wldev *dev)
 {
 	unsigned int state;
 
 	state = dev->periodic_state;
-	if (state % 120 == 0)
+	if (state % 8 == 0)
 		b43legacy_periodic_every120sec(dev);
-	if (state % 60 == 0)
+	if (state % 4 == 0)
 		b43legacy_periodic_every60sec(dev);
-	if (state % 30 == 0)
+	if (state % 2 == 0)
 		b43legacy_periodic_every30sec(dev);
-	if (state % 15 == 0)
-		b43legacy_periodic_every15sec(dev);
-	b43legacy_periodic_every1sec(dev);
+	b43legacy_periodic_every15sec(dev);
 }
 
 /* Estimate a "Badness" value based on the periodic work
@@ -2182,13 +2153,11 @@ static int estimate_periodic_work_badnes
 {
 	int badness = 0;
 
-	if (state % 120 == 0) /* every 120 sec */
+	if (state % 8 == 0)	/* every 120 sec */
 		badness += 10;
-	if (state % 60 == 0) /* every 60 sec */
+	if (state % 4 == 0)	/* every 60 sec */
 		badness += 5;
-	if (state % 30 == 0) /* every 30 sec */
-		badness += 1;
-	if (state % 15 == 0) /* every 15 sec */
+	if (state % 2 == 0)	/* every 30 sec */
 		badness += 1;
 
 #define BADNESS_LIMIT	4
@@ -2246,7 +2215,7 @@ out_requeue:
 	if (b43legacy_debug(dev, B43legacy_DBG_PWORK_FAST))
 		delay = msecs_to_jiffies(50);
 	else
-		delay = round_jiffies(HZ);
+		delay = round_jiffies(HZ * 15);
 	queue_delayed_work(dev->wl->hw->workqueue,
 			   &dev->periodic_work, delay);
 out:
@@ -3445,6 +3414,7 @@ static int b43legacy_setup_modes(struct 
 
 static void b43legacy_wireless_core_detach(struct b43legacy_wldev *dev)
 {
+	b43legacy_rfkill_free(dev);
 	/* We release firmware that late to not be required to re-request
 	 * is all the time when we reinit the core. */
 	b43legacy_release_firmware(dev);
@@ -3526,6 +3496,7 @@ static int b43legacy_wireless_core_attac
 	if (!wl->current_dev)
 		wl->current_dev = dev;
 	INIT_WORK(&dev->restart_work, b43legacy_chip_reset);
+	b43legacy_rfkill_alloc(dev);
 
 	b43legacy_radio_turn_off(dev, 1);
 	b43legacy_switch_analog(dev, 0);
Index: wireless-2.6/drivers/net/wireless/b43legacy/rfkill.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/rfkill.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/rfkill.c
@@ -1,6 +1,6 @@
 /*
 
-  Broadcom B43legacy wireless driver
+  Broadcom B43 wireless driver
   RFKILL support
 
   Copyright (c) 2007 Michael Buesch <mb at bu3sch.de>
@@ -27,48 +27,39 @@
 #include "b43legacy.h"
 
 
-static void b43legacy_notify_rfkill_press(struct work_struct *work)
+/* Returns TRUE, if the radio is enabled in hardware. */
+static bool b43legacy_is_hw_radio_enabled(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_rfkill *rfk = container_of(work,
-						    struct b43legacy_rfkill,
-						    notify_work);
-	struct b43legacy_wl *wl = container_of(rfk, struct b43legacy_wl,
-				  rfkill);
-	struct b43legacy_wldev *dev;
-	enum rfkill_state state;
-
-	mutex_lock(&wl->mutex);
-	dev = wl->current_dev;
-	if (b43legacy_status(dev) < B43legacy_STAT_INITIALIZED) {
-		mutex_unlock(&wl->mutex);
-		return;
-	}
-	if (dev->radio_hw_enable)
-		state = RFKILL_STATE_ON;
-	else
-		state = RFKILL_STATE_OFF;
-	b43legacyinfo(wl, "Radio hardware status changed to %s\n",
-		dev->radio_hw_enable ? "ENABLED" : "DISABLED");
-	mutex_unlock(&wl->mutex);
-
-	if (rfk->rfkill) {
-		/* Be careful. This calls back into the software toggle
-		 * routines. So we must unlock before calling. */
-		rfkill_switch_all(rfk->rfkill->type, state);
+	if (dev->phy.rev >= 3) {
+		if (!(b43legacy_read32(dev, B43legacy_MMIO_RADIO_HWENABLED_HI)
+		      & B43legacy_MMIO_RADIO_HWENABLED_HI_MASK))
+			return 1;
+	} else {
+		if (b43legacy_read16(dev, B43legacy_MMIO_RADIO_HWENABLED_LO)
+		    & B43legacy_MMIO_RADIO_HWENABLED_LO_MASK)
+			return 1;
 	}
+	return 0;
 }
 
-/* Called when the RFKILL toggled in hardware.
- * This is called with the mutex locked. */
-void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev, bool on)
+/* The poll callback for the hardware button. */
+static void b43legacy_rfkill_poll(struct input_polled_dev *poll_dev)
 {
+	struct b43legacy_wldev *dev = poll_dev->private;
 	struct b43legacy_wl *wl = dev->wl;
+	bool enabled;
 
+	mutex_lock(&wl->mutex);
 	B43legacy_WARN_ON(b43legacy_status(dev) < B43legacy_STAT_INITIALIZED);
-	/* Update the RF status asynchronously, as rfkill will
-	 * call back into the software toggle handler.
-	 * This would deadlock if done synchronously. */
-	queue_work(wl->hw->workqueue, &wl->rfkill.notify_work);
+	enabled = b43legacy_is_hw_radio_enabled(dev);
+	if (unlikely(enabled != dev->radio_hw_enable)) {
+		dev->radio_hw_enable = enabled;
+		b43legacyinfo(wl, "Radio hardware status changed to %s\n",
+			enabled ? "ENABLED" : "DISABLED");
+		mutex_unlock(&wl->mutex);
+		input_report_key(poll_dev->input, KEY_WLAN, enabled);
+	} else
+		mutex_unlock(&wl->mutex);
 }
 
 /* Called when the RFKILL toggled in software.
@@ -106,7 +97,7 @@ out_unlock:
 	return err;
 }
 
-char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
+char * b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
 {
 	struct b43legacy_wl *wl = dev->wl;
 
@@ -121,38 +112,74 @@ void b43legacy_rfkill_init(struct b43leg
 	struct b43legacy_rfkill *rfk = &(wl->rfkill);
 	int err;
 
+	if (rfk->rfkill) {
+		err = rfkill_register(rfk->rfkill);
+		if (err) {
+			b43legacywarn(wl, "Failed to register RF-kill button\n");
+			goto err_free_rfk;
+		}
+	}
+	if (rfk->poll_dev) {
+		err = input_register_polled_device(rfk->poll_dev);
+		if (err) {
+			b43legacywarn(wl, "Failed to register RF-kill polldev\n");
+			goto err_free_polldev;
+		}
+	}
+
+	return;
+err_free_rfk:
+	rfkill_free(rfk->rfkill);
+	rfk->rfkill = NULL;
+err_free_polldev:
+	input_free_polled_device(rfk->poll_dev);
+	rfk->poll_dev = NULL;
+}
+
+void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
+{
+	struct b43legacy_rfkill *rfk = &(dev->wl->rfkill);
+
+	if (rfk->poll_dev)
+		input_unregister_polled_device(rfk->poll_dev);
+	if (rfk->rfkill)
+		rfkill_unregister(rfk->rfkill);
+}
+
+void b43legacy_rfkill_alloc(struct b43legacy_wldev *dev)
+{
+	struct b43legacy_wl *wl = dev->wl;
+	struct b43legacy_rfkill *rfk = &(wl->rfkill);
+
 	snprintf(rfk->name, sizeof(rfk->name),
 		 "b43legacy-%s", wiphy_name(wl->hw->wiphy));
+
 	rfk->rfkill = rfkill_allocate(dev->dev->dev, RFKILL_TYPE_WLAN);
-	if (!rfk->rfkill)
-		goto error;
+	if (!rfk->rfkill) {
+		b43legacywarn(wl, "Failed to allocate RF-kill button\n");
+		return;
+	}
 	rfk->rfkill->name = rfk->name;
 	rfk->rfkill->state = RFKILL_STATE_ON;
 	rfk->rfkill->data = dev;
 	rfk->rfkill->toggle_radio = b43legacy_rfkill_soft_toggle;
 	rfk->rfkill->user_claim_unsupported = 1;
 
-	INIT_WORK(&rfk->notify_work, b43legacy_notify_rfkill_press);
-
-	err = rfkill_register(rfk->rfkill);
-	if (err)
-		goto error;
-
-	return;
-error:
-	b43legacywarn(dev->wl, "Failed to initialize the RF-kill button\n");
-	rfkill_free(rfk->rfkill);
-	rfk->rfkill = NULL;
+	rfk->poll_dev = input_allocate_polled_device();
+	if (rfk->poll_dev) {
+		rfk->poll_dev->private = dev;
+		rfk->poll_dev->poll = b43legacy_rfkill_poll;
+		rfk->poll_dev->poll_interval = 1000; /* msecs */
+	} else
+		b43legacywarn(wl, "Failed to allocate RF-kill polldev\n");
 }
 
-void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
+void b43legacy_rfkill_free(struct b43legacy_wldev *dev)
 {
 	struct b43legacy_rfkill *rfk = &(dev->wl->rfkill);
 
-	if (!rfk->rfkill)
-		return;
-	cancel_work_sync(&rfk->notify_work);
-	rfkill_unregister(rfk->rfkill);
+	input_free_polled_device(rfk->poll_dev);
+	rfk->poll_dev = NULL;
 	rfkill_free(rfk->rfkill);
 	rfk->rfkill = NULL;
 }
Index: wireless-2.6/drivers/net/wireless/b43legacy/rfkill.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/rfkill.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/rfkill.h
@@ -7,21 +7,27 @@ struct b43legacy_wldev;
 
 #include <linux/rfkill.h>
 #include <linux/workqueue.h>
+#include <linux/input-polldev.h>
+
 
 
 struct b43legacy_rfkill {
 	/* The RFKILL subsystem data structure */
 	struct rfkill *rfkill;
+	/* The poll device for the RFKILL input button */
+	struct input_polled_dev *poll_dev;
 	/* The unique name of this rfkill switch */
 	char name[32];
-	/* Workqueue for asynchronous notification. */
-	struct work_struct notify_work;
 };
 
+/* All the init functions return void, because we are not interested
+ * in failing the b43 init process when rfkill init failed. */
+void b43legacy_rfkill_alloc(struct b43legacy_wldev *dev);
+void b43legacy_rfkill_free(struct b43legacy_wldev *dev);
 void b43legacy_rfkill_init(struct b43legacy_wldev *dev);
 void b43legacy_rfkill_exit(struct b43legacy_wldev *dev);
-void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev, bool on);
-char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev);
+
+char * b43legacy_rfkill_led_name(struct b43legacy_wldev *dev);
 
 
 #else /* CONFIG_B43LEGACY_RFKILL */
@@ -31,17 +37,19 @@ struct b43legacy_rfkill {
 	/* empty */
 };
 
-static inline void b43legacy_rfkill_init(struct b43legacy_wldev *dev)
+static inline void b43legacy_rfkill_alloc(struct b43legacy_wldev *dev)
 {
 }
-static inline void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
+static inline void b43legacy_rfkill_free(struct b43legacy_wldev *dev)
 {
 }
-static inline void b43legacy_rfkill_toggled(struct b43legacy_wldev *dev,
-					    bool on)
+static inline void b43legacy_rfkill_init(struct b43legacy_wldev *dev)
+{
+}
+static inline void b43legacy_rfkill_exit(struct b43legacy_wldev *dev)
 {
 }
-static inline char *b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
+static inline char * b43legacy_rfkill_led_name(struct b43legacy_wldev *dev)
 {
 	return NULL;
 }


From Larry.Finger at lwfinger.net  Thu Oct 11 07:05:57 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 11 Oct 2007 00:05:57 -0500
Subject: [PATCH] b43legacy: Rewrite pwork locking
Message-ID: <470daf35.ps3UdT7crk8kVap5%Larry.Finger@lwfinger.net>

Implement much easier and more lightweight locking for
the periodic work. This also removes the last big busywait
loop and replaces it by a sleeping loop.

This patch for b43legacy is patterned aftar the same patch
for b43 by Michael Buesch <mb at bu3sch.de>.

Signed-off-by: Larry Finger <larry.finger at lwfinger.net>
---

 drivers/net/wireless/b43legacy/main.c |   88 +++++++++++-----------------------
 1 file changed, 30 insertions(+), 58 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -1797,6 +1797,7 @@ void b43legacy_mac_enable(struct b43lega
 {
 	dev->mac_suspended--;
 	B43legacy_WARN_ON(dev->mac_suspended < 0);
+	B43legacy_WARN_ON(irqs_disabled());
 	if (dev->mac_suspended == 0) {
 		b43legacy_write32(dev, B43legacy_MMIO_STATUS_BITFIELD,
 				  b43legacy_read32(dev,
@@ -1808,6 +1809,11 @@ void b43legacy_mac_enable(struct b43lega
 		b43legacy_read32(dev, B43legacy_MMIO_STATUS_BITFIELD);
 		b43legacy_read32(dev, B43legacy_MMIO_GEN_IRQ_REASON);
 		b43legacy_power_saving_ctl_bits(dev, -1, -1);
+
+		/* Re-enable IRQs. */
+		spin_lock_irq(&dev->wl->irq_lock);
+		b43legacy_interrupt_enable(dev, dev->irq_savedstate);
+		spin_unlock_irq(&dev->wl->irq_lock);
 	}
 }
 
@@ -1817,20 +1823,31 @@ void b43legacy_mac_suspend(struct b43leg
 	int i;
 	u32 tmp;
 
+	might_sleep();
+	B43legacy_WARN_ON(irqs_disabled());
 	B43legacy_WARN_ON(dev->mac_suspended < 0);
+
 	if (dev->mac_suspended == 0) {
+		/* Mask IRQs before suspending MAC. Otherwise
+		 * the MAC stays busy and won't suspend. */
+		spin_lock_irq(&dev->wl->irq_lock);
+		tmp = b43legacy_interrupt_disable(dev, B43legacy_IRQ_ALL);
+		spin_unlock_irq(&dev->wl->irq_lock);
+		b43legacy_synchronize_irq(dev);
+		dev->irq_savedstate = tmp;
+
 		b43legacy_power_saving_ctl_bits(dev, -1, 1);
 		b43legacy_write32(dev, B43legacy_MMIO_STATUS_BITFIELD,
 				  b43legacy_read32(dev,
 				  B43legacy_MMIO_STATUS_BITFIELD)
 				  & ~B43legacy_SBF_MAC_ENABLED);
 		b43legacy_read32(dev, B43legacy_MMIO_GEN_IRQ_REASON);
-		for (i = 10000; i; i--) {
+		for (i = 40; i; i--) {
 			tmp = b43legacy_read32(dev,
 					       B43legacy_MMIO_GEN_IRQ_REASON);
 			if (tmp & B43legacy_IRQ_MAC_SUSPENDED)
 				goto out;
-			udelay(1);
+			msleep(1);
 		}
 		b43legacyerr(dev->wl, "MAC suspend failed\n");
 	}
@@ -2145,81 +2162,36 @@ static void do_periodic_work(struct b43l
 	b43legacy_periodic_every15sec(dev);
 }
 
-/* Estimate a "Badness" value based on the periodic work
- * state-machine state. "Badness" is worse (bigger), if the
- * periodic work will take longer.
+/* Periodic work locking policy:
+ * 	The whole periodic work handler is protected by
+ * 	wl->mutex. If another lock is needed somewhere in the
+ * 	pwork callchain, it's aquired in-place, where it's needed.
  */
-static int estimate_periodic_work_badness(unsigned int state)
-{
-	int badness = 0;
-
-	if (state % 8 == 0)	/* every 120 sec */
-		badness += 10;
-	if (state % 4 == 0)	/* every 60 sec */
-		badness += 5;
-	if (state % 2 == 0)	/* every 30 sec */
-		badness += 1;
-
-#define BADNESS_LIMIT	4
-	return badness;
-}
-
 static void b43legacy_periodic_work_handler(struct work_struct *work)
 {
-	struct b43legacy_wldev *dev =
-			     container_of(work, struct b43legacy_wldev,
-			     periodic_work.work);
-	unsigned long flags;
+	struct b43legacy_wldev *dev = container_of(work, struct b43legacy_wldev,
+					     periodic_work.work);
+	struct b43legacy_wl *wl = dev->wl;
 	unsigned long delay;
-	u32 savedirqs = 0;
-	int badness;
 
-	mutex_lock(&dev->wl->mutex);
+	mutex_lock(&wl->mutex);
 
 	if (unlikely(b43legacy_status(dev) != B43legacy_STAT_STARTED))
 		goto out;
 	if (b43legacy_debug(dev, B43legacy_DBG_PWORK_STOP))
 		goto out_requeue;
 
-	badness = estimate_periodic_work_badness(dev->periodic_state);
-	if (badness > BADNESS_LIMIT) {
-		spin_lock_irqsave(&dev->wl->irq_lock, flags);
-		/* Suspend TX as we don't want to transmit packets while
-		 * we recalibrate the hardware. */
-		b43legacy_tx_suspend(dev);
-		savedirqs = b43legacy_interrupt_disable(dev,
-							  B43legacy_IRQ_ALL);
-		/* Periodic work will take a long time, so we want it to
-		 * be preemtible and release the spinlock. */
-		spin_unlock_irqrestore(&dev->wl->irq_lock, flags);
-		b43legacy_synchronize_irq(dev);
-
-		do_periodic_work(dev);
+	do_periodic_work(dev);
 
-		spin_lock_irqsave(&dev->wl->irq_lock, flags);
-		b43legacy_interrupt_enable(dev, savedirqs);
-		b43legacy_tx_resume(dev);
-		mmiowb();
-		spin_unlock_irqrestore(&dev->wl->irq_lock, flags);
-	} else {
-		/* Take the global driver lock. This will lock any operation. */
-		spin_lock_irqsave(&dev->wl->irq_lock, flags);
-
-		do_periodic_work(dev);
-
-		mmiowb();
-		spin_unlock_irqrestore(&dev->wl->irq_lock, flags);
-	}
 	dev->periodic_state++;
 out_requeue:
 	if (b43legacy_debug(dev, B43legacy_DBG_PWORK_FAST))
 		delay = msecs_to_jiffies(50);
 	else
 		delay = round_jiffies(HZ * 15);
-	queue_delayed_work(dev->wl->hw->workqueue,
-			   &dev->periodic_work, delay);
+	queue_delayed_work(wl->hw->workqueue, &dev->periodic_work, delay);
 out:
-	mutex_unlock(&dev->wl->mutex);
+	mutex_unlock(&wl->mutex);
 }
 
 static void b43legacy_periodic_tasks_setup(struct b43legacy_wldev *dev)


From seandarcy2 at gmail.com  Thu Oct 11 22:48:46 2007
From: seandarcy2 at gmail.com (sean darcy)
Date: Thu, 11 Oct 2007 16:48:46 -0400
Subject: 4311: trouble with Fedora 8 Test 3
In-Reply-To: <20071010171328.GH5962@tuxdriver.com>
References: <c195ebf70710100908i5973f0b9ueb7084ecb13e1287@mail.gmail.com>
	<20071010171328.GH5962@tuxdriver.com>
Message-ID: <c195ebf70710111348t564f5b12h1c0ce67b1f81ff1f@mail.gmail.com>

On 10/10/07, John W. Linville <linville at tuxdriver.com> wrote:
> On Wed, Oct 10, 2007 at 12:08:08PM -0400, sean darcy wrote:
>
> > Nothing at all about the 4311 card in dmesg.
> >
> > Made sure NetworkManager was working. Restarted it. I can see the icon.
> > No connection. If I connect the wire it starts up the wired connection.
>
> Please post the output of this command:
>
>         cat /sys/bus/ssb/devices/ssb0\:0/uevent
>

cat /sys/bus/ssb/devices/ssb0\:0/uevent
PHYSDEVBUS=ssb
MODALIAS=ssb:v4243id0812rev0D


> I suspect that your device's core is too new to be supported.
>

OK, break my heart. I actually thought that since it had the intel 965
chipset, that it would have intel wlan, but I shoulda checked...

In the meantime, if I can supply any info, just let me know.

sean


From Larry.Finger at lwfinger.net  Sat Oct 13 06:04:51 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Oct 2007 23:04:51 -0500
Subject: [PATCH V2] b43legacy: LED triggers support
Message-ID: <471043e3.nbgnVprY8Ddg68MT%Larry.Finger@lwfinger.net>

Drive the LEDs through the generic LED triggers.

The patch to b43 by Michael Buesch <mb at bu3sch.de> has been ported to b43legacy.

Signed-off-by: Larry Finger <larry.finger at lwfinger.net>
---

John,

This patch is to be applied to the 'everything' branch of wireless-2.6.
The previous version missed some b43 => b43legacy renaming.

Larry
---

 drivers/net/wireless/b43legacy/Kconfig     |    6
 drivers/net/wireless/b43legacy/Makefile    |   27 +
 drivers/net/wireless/b43legacy/b43legacy.h |    6
 drivers/net/wireless/b43legacy/leds.c      |  411 ++++++++++++-----------------
 drivers/net/wireless/b43legacy/leds.h      |   61 ++--
 drivers/net/wireless/b43legacy/main.c      |   40 --
 drivers/net/wireless/b43legacy/radio.c     |    2
 7 files changed, 242 insertions(+), 311 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Kconfig
+++ wireless-2.6/drivers/net/wireless/b43legacy/Kconfig
@@ -34,6 +34,12 @@ config B43LEGACY_PCICORE_AUTOSELECT
 	select SSB_DRIVER_PCICORE
 	default y
 
+# LED support
+config B43LEGACY_LEDS
+	bool
+	depends on MAC80211_LEDS
+	default y
+
 config B43LEGACY_DEBUG
 	bool "Broadcom 43xx-legacy debugging"
 	depends on B43LEGACY
Index: wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/b43legacy.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/b43legacy.h
@@ -663,8 +663,10 @@ struct b43legacy_wldev {
 	/* Various statistics about the physical device. */
 	struct b43legacy_stats stats;
 
-#define B43legacy_NR_LEDS		4
-	struct b43legacy_led leds[B43legacy_NR_LEDS];
+	/* The device LEDs. */
+	struct b43legacy_led led_tx;
+	struct b43legacy_led led_rx;
+	struct b43legacy_led led_assoc;
 
 	/* Reason code of the last interrupt. */
 	u32 irq_reason;
Index: wireless-2.6/drivers/net/wireless/b43legacy/leds.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/leds.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/leds.c
@@ -1,13 +1,13 @@
 /*
 
-  Broadcom B43legacy wireless driver
+  Broadcom B43 wireless driver
+  LED control
 
   Copyright (c) 2005 Martin Langer <martin-langer at gmx.de>,
-		     Stefano Brivio <st3 at riseup.net>
-		     Michael Buesch <mb at bu3sch.de>
-		     Danny van Dyk <kugelfang at gentoo.org>
-		     Andreas Jaggi <andreas.jaggi at waterwave.ch>
-  Copyright (c) 2007 Larry Finger <Larry.Finger at lwfinger.net>
+  Copyright (c) 2005 Stefano Brivio <st3 at riseup.net>
+  Copyright (c) 2005-2007 Michael Buesch <mb at bu3sch.de>
+  Copyright (c) 2005 Danny van Dyk <kugelfang at gentoo.org>
+  Copyright (c) 2005 Andreas Jaggi <andreas.jaggi at waterwave.ch>
 
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
@@ -26,273 +26,208 @@
 
 */
 
-#include "leds.h"
 #include "b43legacy.h"
-#include "main.h"
-
-static void b43legacy_led_changestate(struct b43legacy_led *led)
-{
-	struct b43legacy_wldev *dev = led->dev;
-	const int index = led->index;
-	u16 ledctl;
+#include "leds.h"
 
-	B43legacy_WARN_ON(!(index >= 0 && index < B43legacy_NR_LEDS));
-	B43legacy_WARN_ON(!led->blink_interval);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	ledctl ^= (1 << index);
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-}
 
-static void b43legacy_led_blink(unsigned long d)
+static void b43legacy_led_turn_on(struct b43legacy_wldev *dev, u8 led_index,
+			    bool activelow)
 {
-	struct b43legacy_led *led = (struct b43legacy_led *)d;
-	struct b43legacy_wldev *dev = led->dev;
+	struct b43legacy_wl *wl = dev->wl;
 	unsigned long flags;
+	u16 ctl;
 
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	if (led->blink_interval) {
-		b43legacy_led_changestate(led);
-		mod_timer(&led->blink_timer, jiffies + led->blink_interval);
-	}
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
+	spin_lock_irqsave(&wl->leds_lock, flags);
+	ctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
+	if (activelow)
+		ctl &= ~(1 << led_index);
+	else
+		ctl |= (1 << led_index);
+	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ctl);
+	spin_unlock_irqrestore(&wl->leds_lock, flags);
 }
 
-static void b43legacy_led_blink_start(struct b43legacy_led *led,
-				      unsigned long interval)
+static void b43legacy_led_turn_off(struct b43legacy_wldev *dev, u8 led_index,
+			     bool activelow)
 {
-	if (led->blink_interval)
-		return;
-	led->blink_interval = interval;
-	b43legacy_led_changestate(led);
-	led->blink_timer.expires = jiffies + interval;
-	add_timer(&led->blink_timer);
+	struct b43legacy_wl *wl = dev->wl;
+	unsigned long flags;
+	u16 ctl;
+
+	spin_lock_irqsave(&wl->leds_lock, flags);
+	ctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
+	if (activelow)
+		ctl |= (1 << led_index);
+	else
+		ctl &= ~(1 << led_index);
+	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ctl);
+	spin_unlock_irqrestore(&wl->leds_lock, flags);
 }
 
-static void b43legacy_led_blink_stop(struct b43legacy_led *led, int sync)
+/* Callback from the LED subsystem. */
+static void b43legacy_led_brightness_set(struct led_classdev *led_dev,
+				   enum led_brightness brightness)
 {
+	struct b43legacy_led *led = container_of(led_dev, struct b43legacy_led,
+				    led_dev);
 	struct b43legacy_wldev *dev = led->dev;
-	const int index = led->index;
-	u16 ledctl;
+	bool radio_enabled;
 
-	if (!led->blink_interval)
-		return;
-	if (unlikely(sync))
-		del_timer_sync(&led->blink_timer);
-	else
-		del_timer(&led->blink_timer);
-	led->blink_interval = 0;
+	/* Checking the radio-enabled status here is slightly racy,
+	 * but we want to avoid the locking overhead and we don't care
+	 * whether the LED has the wrong state for a second. */
+	radio_enabled = (dev->phy.radio_on && dev->radio_hw_enable);
 
-	/* Make sure the LED is turned off. */
-	B43legacy_WARN_ON(!(index >= 0 && index < B43legacy_NR_LEDS));
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	if (led->activelow)
-		ledctl |= (1 << index);
+	if (brightness == LED_OFF || !radio_enabled)
+		b43legacy_led_turn_off(dev, led->index, led->activelow);
 	else
-		ledctl &= ~(1 << index);
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
+		b43legacy_led_turn_on(dev, led->index, led->activelow);
 }
 
-static void b43legacy_led_init_hardcoded(struct b43legacy_wldev *dev,
-					 struct b43legacy_led *led,
-					 int led_index)
-{
-	struct ssb_bus *bus = dev->dev->bus;
+static int b43legacy_register_led(struct b43legacy_wldev *dev,
+				  struct b43legacy_led *led,
+				  const char *name, char *default_trigger,
+				  u8 led_index, bool activelow)
+{
+	int err;
+
+	b43legacy_led_turn_off(dev, led_index, activelow);
+	if (led->dev)
+		return -EEXIST;
+	if (!default_trigger)
+		return -EINVAL;
+	led->dev = dev;
+	led->index = led_index;
+	led->activelow = activelow;
+	strncpy(led->name, name, sizeof(led->name));
+
+	led->led_dev.name = led->name;
+	led->led_dev.default_trigger = default_trigger;
+	led->led_dev.brightness_set = b43legacy_led_brightness_set;
+
+	err = led_classdev_register(dev->dev->dev, &led->led_dev);
+	if (err) {
+		b43legacywarn(dev->wl, "LEDs: Failed to register %s\n", name);
+		led->dev = NULL;
+		return err;
+	}
+	return 0;
+}
 
-	/* This function is called, if the behaviour (and activelow)
-	 * information for a LED is missing in the SPROM.
-	 * We hardcode the behaviour values for various devices here.
-	 * Note that the B43legacy_LED_TEST_XXX behaviour values can
-	 * be used to figure out which led is mapped to which index.
-	 */
-
-	switch (led_index) {
-	case 0:
-		led->behaviour = B43legacy_LED_ACTIVITY;
-		led->activelow = 1;
-		if (bus->boardinfo.vendor == PCI_VENDOR_ID_COMPAQ)
-			led->behaviour = B43legacy_LED_RADIO_ALL;
+static void b43legacy_unregister_led(struct b43legacy_led *led)
+{
+	if (!led->dev)
+		return;
+	led_classdev_unregister(&led->led_dev);
+	b43legacy_led_turn_off(led->dev, led->index, led->activelow);
+	led->dev = NULL;
+}
+
+static void b43legacy_map_led(struct b43legacy_wldev *dev,
+			u8 led_index,
+			enum b43legacy_led_behaviour behaviour,
+			bool activelow)
+{
+	struct ieee80211_hw *hw = dev->wl->hw;
+	char name[B43legacy_LED_MAX_NAME_LEN + 1];
+
+	/* Map the b43 specific LED behaviour value to the
+	 * generic LED triggers. */
+	switch (behaviour) {
+	case B43legacy_LED_INACTIVE:
+		break;
+	case B43legacy_LED_OFF:
+		b43legacy_led_turn_off(dev, led_index, activelow);
 		break;
-	case 1:
-		led->behaviour = B43legacy_LED_RADIO_B;
-		if (bus->boardinfo.vendor == PCI_VENDOR_ID_ASUSTEK)
-			led->behaviour = B43legacy_LED_ASSOC;
+	case B43legacy_LED_ON:
+		b43legacy_led_turn_on(dev, led_index, activelow);
 		break;
-	case 2:
-		led->behaviour = B43legacy_LED_RADIO_A;
+	case B43legacy_LED_ACTIVITY:
+	case B43legacy_LED_TRANSFER:
+	case B43legacy_LED_APTRANSFER:
+		snprintf(name, sizeof(name),
+			 "b43legacy-%s:tx", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_tx, name,
+				 ieee80211_get_tx_led_name(hw),
+				 led_index, activelow);
+		snprintf(name, sizeof(name),
+			 "b43legacy-%s:rx", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_rx, name,
+				 ieee80211_get_rx_led_name(hw),
+				 led_index, activelow);
 		break;
-	case 3:
-		led->behaviour = B43legacy_LED_OFF;
+	/*FIXME: We need another trigger for the "radio-on" LEDs below.
+	 *       Wiggle that somehow into the rfkill subsystem. */
+	case B43legacy_LED_RADIO_ALL:
+	case B43legacy_LED_RADIO_A:
+	case B43legacy_LED_RADIO_B:
+	case B43legacy_LED_MODE_BG:
+	case B43legacy_LED_WEIRD:
+	case B43legacy_LED_ASSOC:
+		snprintf(name, sizeof(name),
+			 "b43legacy-%s:assoc", wiphy_name(hw->wiphy));
+		b43legacy_register_led(dev, &dev->led_assoc, name,
+				 ieee80211_get_assoc_led_name(hw),
+				 led_index, activelow);
 		break;
 	default:
-		B43legacy_BUG_ON(1);
+		b43legacywarn(dev->wl, "LEDs: Unknown behaviour 0x%02X\n",
+			behaviour);
+		break;
 	}
 }
 
-int b43legacy_leds_init(struct b43legacy_wldev *dev)
+void b43legacy_leds_init(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_led *led;
+	struct ssb_bus *bus = dev->dev->bus;
 	u8 sprom[4];
 	int i;
+	enum b43legacy_led_behaviour behaviour;
+	bool activelow;
 
-	sprom[0] = dev->dev->bus->sprom.r1.gpio0;
-	sprom[1] = dev->dev->bus->sprom.r1.gpio1;
-	sprom[2] = dev->dev->bus->sprom.r1.gpio2;
-	sprom[3] = dev->dev->bus->sprom.r1.gpio3;
-
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		led->index = i;
-		led->dev = dev;
-		setup_timer(&led->blink_timer,
-			    b43legacy_led_blink,
-			    (unsigned long)led);
-
-		if (sprom[i] == 0xFF)
-			b43legacy_led_init_hardcoded(dev, led, i);
-		else {
-			led->behaviour = sprom[i] & B43legacy_LED_BEHAVIOUR;
-			led->activelow = !!(sprom[i] &
-					   B43legacy_LED_ACTIVELOW);
+	sprom[0] = bus->sprom.r1.gpio0;
+	sprom[1] = bus->sprom.r1.gpio1;
+	sprom[2] = bus->sprom.r1.gpio2;
+	sprom[3] = bus->sprom.r1.gpio3;
+
+	for (i = 0; i < 4; i++) {
+		if (sprom[i] == 0xFF) {
+			/* There is no LED information in the SPROM
+			 * for this LED. Hardcode it here. */
+			activelow = 0;
+			switch (i) {
+			case 0:
+				behaviour = B43legacy_LED_ACTIVITY;
+				activelow = 1;
+				if (bus->boardinfo.vendor == PCI_VENDOR_ID_COMPAQ)
+					behaviour = B43legacy_LED_RADIO_ALL;
+				break;
+			case 1:
+				behaviour = B43legacy_LED_RADIO_B;
+				if (bus->boardinfo.vendor == PCI_VENDOR_ID_ASUSTEK)
+					behaviour = B43legacy_LED_ASSOC;
+				break;
+			case 2:
+				behaviour = B43legacy_LED_RADIO_A;
+				break;
+			case 3:
+				behaviour = B43legacy_LED_OFF;
+				break;
+			default:
+				B43legacy_WARN_ON(1);
+				return;
+			}
+		} else {
+			behaviour = sprom[i] & B43legacy_LED_BEHAVIOUR;
+			activelow = !!(sprom[i] & B43legacy_LED_ACTIVELOW);
 		}
+		b43legacy_map_led(dev, i, behaviour, activelow);
 	}
-
-	return 0;
 }
 
 void b43legacy_leds_exit(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_led *led;
-	int i;
-
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		b43legacy_led_blink_stop(led, 1);
-	}
-	b43legacy_leds_switch_all(dev, 0);
-}
-
-void b43legacy_leds_update(struct b43legacy_wldev *dev, int activity)
-{
-	struct b43legacy_led *led;
-	struct b43legacy_phy *phy = &dev->phy;
-	const int transferring = (jiffies - dev->stats.last_tx)
-				  < B43legacy_LED_XFER_THRES;
-	int i;
-	int turn_on;
-	unsigned long interval = 0;
-	u16 ledctl;
-	unsigned long flags;
-	bool radio_enabled = (phy->radio_on && dev->radio_hw_enable);
-
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-
-		turn_on = 0;
-		switch (led->behaviour) {
-		case B43legacy_LED_INACTIVE:
-			continue;
-		case B43legacy_LED_OFF:
-			break;
-		case B43legacy_LED_ON:
-			turn_on = 1;
-			break;
-		case B43legacy_LED_ACTIVITY:
-			turn_on = activity;
-			break;
-		case B43legacy_LED_RADIO_ALL:
-			turn_on = radio_enabled;
-			break;
-		case B43legacy_LED_RADIO_A:
-			break;
-		case B43legacy_LED_RADIO_B:
-			turn_on = radio_enabled;
-			break;
-		case B43legacy_LED_MODE_BG:
-			if (phy->type == B43legacy_PHYTYPE_G && radio_enabled)
-				turn_on = 1;
-			break;
-		case B43legacy_LED_TRANSFER:
-			if (transferring)
-				b43legacy_led_blink_start(led,
-						B43legacy_LEDBLINK_MEDIUM);
-			else
-				b43legacy_led_blink_stop(led, 0);
-			continue;
-		case B43legacy_LED_APTRANSFER:
-			if (b43legacy_is_mode(dev->wl,
-						IEEE80211_IF_TYPE_AP)) {
-				if (transferring) {
-					interval = B43legacy_LEDBLINK_FAST;
-					turn_on = 1;
-				}
-			} else {
-				turn_on = 1;
-				if (transferring)
-					interval = B43legacy_LEDBLINK_FAST;
-				else
-					turn_on = 0;
-			}
-			if (turn_on)
-				b43legacy_led_blink_start(led, interval);
-			else
-				b43legacy_led_blink_stop(led, 0);
-			continue;
-		case B43legacy_LED_WEIRD:
-			break;
-		case B43legacy_LED_ASSOC:
-			turn_on = 1;
-#ifdef CONFIG_B43LEGACY_DEBUG
-		case B43legacy_LED_TEST_BLINKSLOW:
-			b43legacy_led_blink_start(led, B43legacy_LEDBLINK_SLOW);
-			continue;
-		case B43legacy_LED_TEST_BLINKMEDIUM:
-			b43legacy_led_blink_start(led,
-						   B43legacy_LEDBLINK_MEDIUM);
-			continue;
-		case B43legacy_LED_TEST_BLINKFAST:
-			b43legacy_led_blink_start(led, B43legacy_LEDBLINK_FAST);
-			continue;
-#endif /* CONFIG_B43LEGACY_DEBUG */
-		default:
-			B43legacy_BUG_ON(1);
-		};
-
-		if (led->activelow)
-			turn_on = !turn_on;
-		if (turn_on)
-			ledctl |= (1 << i);
-		else
-			ledctl &= ~(1 << i);
-	}
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
-}
-
-void b43legacy_leds_switch_all(struct b43legacy_wldev *dev, int on)
-{
-	struct b43legacy_led *led;
-	u16 ledctl;
-	int i;
-	int bit_on;
-	unsigned long flags;
-
-	spin_lock_irqsave(&dev->wl->leds_lock, flags);
-	ledctl = b43legacy_read16(dev, B43legacy_MMIO_GPIO_CONTROL);
-	for (i = 0; i < B43legacy_NR_LEDS; i++) {
-		led = &(dev->leds[i]);
-		if (led->behaviour == B43legacy_LED_INACTIVE)
-			continue;
-		if (on)
-			bit_on = led->activelow ? 0 : 1;
-		else
-			bit_on = led->activelow ? 1 : 0;
-		if (bit_on)
-			ledctl |= (1 << i);
-		else
-			ledctl &= ~(1 << i);
-	}
-	b43legacy_write16(dev, B43legacy_MMIO_GPIO_CONTROL, ledctl);
-	spin_unlock_irqrestore(&dev->wl->leds_lock, flags);
+	b43legacy_unregister_led(&dev->led_tx);
+	b43legacy_unregister_led(&dev->led_rx);
+	b43legacy_unregister_led(&dev->led_assoc);
 }
Index: wireless-2.6/drivers/net/wireless/b43legacy/Makefile
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/Makefile
+++ wireless-2.6/drivers/net/wireless/b43legacy/Makefile
@@ -1,14 +1,17 @@
-obj-$(CONFIG_B43LEGACY) += b43legacy.o
-b43legacy-obj-$(CONFIG_B43LEGACY_DEBUG) += debugfs.o
+# b43legacy core
+b43legacy-y				+= main.o
+b43legacy-y				+= ilt.o
+b43legacy-y				+= phy.o
+b43legacy-y				+= radio.o
+b43legacy-y				+= sysfs.o
+b43legacy-y				+= xmit.o
+# b43legacy LED support
+b43legacy-$(CONFIG_B43LEGACY_LEDS)	+= leds.o
+# b43legacy debugging
+b43legacy-$(CONFIG_B43LEGACY_DEBUG)	+= debugfs.o
+# b43legacy DMA and PIO
+b43legacy-$(CONFIG_B43LEGACY_DMA)	+= dma.o
+b43legacy-$(CONFIG_B43LEGACY_PIO)	+= pio.o
 
-b43legacy-obj-$(CONFIG_B43LEGACY_DMA) += dma.o
-b43legacy-obj-$(CONFIG_B43LEGACY_PIO) += pio.o
+obj-$(CONFIG_B43LEGACY)			+= b43legacy.o
 
-b43legacy-objs := main.o \
-		ilt.o \
-		leds.o \
-		phy.o \
-		radio.o \
-		sysfs.o \
-		xmit.o \
-		$(b43legacy-obj-y)
Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -83,10 +83,6 @@ static int modparam_long_retry = B43lega
 module_param_named(long_retry, modparam_long_retry, int, 0444);
 MODULE_PARM_DESC(long_retry, "Long-Retry-Limit (0 - 15)");
 
-static int modparam_noleds;
-module_param_named(noleds, modparam_noleds, int, 0444);
-MODULE_PARM_DESC(noleds, "Turn off all LED activity");
-
 static char modparam_fwpostfix[16];
 module_param_string(fwpostfix, modparam_fwpostfix, 16, 0444);
 MODULE_PARM_DESC(fwpostfix, "Postfix for the firmware files to load.");
@@ -1217,7 +1213,6 @@ static void b43legacy_interrupt_tasklet(
 	u32 dma_reason[ARRAY_SIZE(dev->dma_reason)];
 	u32 merged_dma_reason = 0;
 	int i;
-	int activity = 0;
 	unsigned long flags;
 
 	spin_lock_irqsave(&dev->wl->irq_lock, flags);
@@ -1281,7 +1276,6 @@ static void b43legacy_interrupt_tasklet(
 			b43legacy_pio_rx(dev->pio.queue0);
 		else
 			b43legacy_dma_rx(dev->dma.rx_ring0);
-		/* We intentionally don't set "activity" to 1, here. */
 	}
 	B43legacy_WARN_ON(dma_reason[1] & B43legacy_DMAIRQ_RX_DONE);
 	B43legacy_WARN_ON(dma_reason[2] & B43legacy_DMAIRQ_RX_DONE);
@@ -1290,20 +1284,13 @@ static void b43legacy_interrupt_tasklet(
 			b43legacy_pio_rx(dev->pio.queue3);
 		else
 			b43legacy_dma_rx(dev->dma.rx_ring3);
-		activity = 1;
 	}
 	B43legacy_WARN_ON(dma_reason[4] & B43legacy_DMAIRQ_RX_DONE);
 	B43legacy_WARN_ON(dma_reason[5] & B43legacy_DMAIRQ_RX_DONE);
 
-	if (reason & B43legacy_IRQ_TX_OK) {
+	if (reason & B43legacy_IRQ_TX_OK)
 		handle_irq_transmit_status(dev);
-		activity = 1;
-		/* TODO: In AP mode, this also causes sending of powersave
-			 responses. */
-	}
 
-	if (!modparam_noleds)
-		b43legacy_leds_update(dev, activity);
 	b43legacy_interrupt_enable(dev, dev->irq_savedstate);
 	mmiowb();
 	spin_unlock_irqrestore(&dev->wl->irq_lock, flags);
@@ -1755,7 +1742,6 @@ static int b43legacy_gpio_init(struct b4
 			  B43legacy_MMIO_STATUS_BITFIELD)
 			  & 0xFFFF3FFF);
 
-	b43legacy_leds_switch_all(dev, 0);
 	b43legacy_write16(dev, B43legacy_MMIO_GPIO_MASK,
 			  b43legacy_read16(dev,
 			  B43legacy_MMIO_GPIO_MASK)
@@ -2008,8 +1994,7 @@ static bool b43legacy_is_hw_radio_enable
 static void b43legacy_chip_exit(struct b43legacy_wldev *dev)
 {
 	b43legacy_radio_turn_off(dev);
-	if (!modparam_noleds)
-		b43legacy_leds_exit(dev);
+	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
 	/* firmware is released later */
 }
@@ -2039,9 +2024,11 @@ static int b43legacy_chip_init(struct b4
 	err = b43legacy_gpio_init(dev);
 	if (err)
 		goto out; /* firmware is released later */
+	b43legacy_leds_init(dev);
+
 	err = b43legacy_upload_initvals(dev);
 	if (err)
-		goto err_gpio_cleanup;
+		goto err_leds_exit;
 	b43legacy_radio_turn_on(dev);
 
 	b43legacy_write16(dev, 0x03E6, 0x0000);
@@ -2120,7 +2107,8 @@ out:
 
 err_radio_off:
 	b43legacy_radio_turn_off(dev);
-err_gpio_cleanup:
+err_leds_exit:
+	b43legacy_leds_exit(dev);
 	b43legacy_gpio_cleanup(dev);
 	goto out;
 }
@@ -2168,7 +2156,6 @@ static void b43legacy_periodic_every1sec
 		dev->radio_hw_enable = radio_hw_enable;
 		b43legacyinfo(dev->wl, "Radio hardware status changed to %s\n",
 		       (radio_hw_enable) ? "enabled" : "disabled");
-		b43legacy_leds_update(dev, 0);
 	}
 }
 
@@ -3494,18 +3481,13 @@ static int b43legacy_wireless_core_attac
 	else
 		have_bphy = 1;
 
-	/* Initialize LEDs structs. */
-	err = b43legacy_leds_init(dev);
-	if (err)
-		goto err_powerdown;
-
 	dev->phy.gmode = (have_gphy || have_bphy);
 	tmp = dev->phy.gmode ? B43legacy_TMSLOW_GMODE : 0;
 	b43legacy_wireless_core_reset(dev, tmp);
 
 	err = b43legacy_phy_versioning(dev);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 	/* Check if this device supports multiband. */
 	if (!pdev ||
 	    (pdev->device != 0x4312 &&
@@ -3531,10 +3513,10 @@ static int b43legacy_wireless_core_attac
 
 	err = b43legacy_validate_chipaccess(dev);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 	err = b43legacy_setup_modes(dev, have_bphy, have_gphy);
 	if (err)
-		goto err_leds_exit;
+		goto err_powerdown;
 
 	/* Now set some default "current_dev" */
 	if (!wl->current_dev)
@@ -3549,8 +3531,6 @@ static int b43legacy_wireless_core_attac
 out:
 	return err;
 
-err_leds_exit:
-	b43legacy_leds_exit(dev);
 err_powerdown:
 	ssb_bus_may_powerdown(bus);
 	return err;
Index: wireless-2.6/drivers/net/wireless/b43legacy/radio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/radio.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/radio.c
@@ -2113,7 +2113,6 @@ void b43legacy_radio_turn_on(struct b43l
 		B43legacy_BUG_ON(1);
 	}
 	phy->radio_on = 1;
-	b43legacy_leds_update(dev, 0);
 }
 
 void b43legacy_radio_turn_off(struct b43legacy_wldev *dev)
@@ -2135,7 +2134,6 @@ void b43legacy_radio_turn_off(struct b43
 		b43legacy_phy_write(dev, 0x0015, 0xAA00);
 	phy->radio_on = 0;
 	b43legacydbg(dev->wl, "Radio initialized\n");
-	b43legacy_leds_update(dev, 0);
 }
 
 void b43legacy_radio_clear_tssi(struct b43legacy_wldev *dev)
Index: wireless-2.6/drivers/net/wireless/b43legacy/leds.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/leds.h
+++ wireless-2.6/drivers/net/wireless/b43legacy/leds.h
@@ -1,30 +1,33 @@
 #ifndef B43legacy_LEDS_H_
 #define B43legacy_LEDS_H_
 
+struct b43legacy_wldev;
+
+#ifdef CONFIG_B43LEGACY_LEDS
+
 #include <linux/types.h>
-#include <linux/timer.h>
+#include <linux/leds.h>
 
 
+#define B43legacy_LED_MAX_NAME_LEN	31
+
 struct b43legacy_led {
-	u8 behaviour;
-	bool activelow;
-	/* Index in the "leds" array in b43legacy_wldev */
-	u8 index;
 	struct b43legacy_wldev *dev;
-	struct timer_list blink_timer;
-	unsigned long blink_interval;
+	/* The LED class device */
+	struct led_classdev led_dev;
+	/* The index number of the LED. */
+	u8 index;
+	/* If activelow is true, the LED is ON if the
+	 * bit is switched off. */
+	bool activelow;
+	/* The unique name string for this LED device. */
+	char name[B43legacy_LED_MAX_NAME_LEN + 1];
 };
 
-/* Delay between state changes when blinking in jiffies */
-#define B43legacy_LEDBLINK_SLOW		(HZ / 1)
-#define B43legacy_LEDBLINK_MEDIUM	(HZ / 4)
-#define B43legacy_LEDBLINK_FAST		(HZ / 8)
-
-#define B43legacy_LED_XFER_THRES	(HZ / 100)
-
 #define B43legacy_LED_BEHAVIOUR		0x7F
 #define B43legacy_LED_ACTIVELOW		0x80
-enum { /* LED behaviour values */
+/* LED behaviour values */
+enum b43legacy_led_behaviour {
 	B43legacy_LED_OFF,
 	B43legacy_LED_ON,
 	B43legacy_LED_ACTIVITY,
@@ -37,20 +40,24 @@ enum { /* LED behaviour values */
 	B43legacy_LED_WEIRD,
 	B43legacy_LED_ASSOC,
 	B43legacy_LED_INACTIVE,
-
-	/* Behaviour values for testing.
-	 * With these values it is easier to figure out
-	 * the real behaviour of leds, in case the SPROM
-	 * is missing information.
-	 */
-	B43legacy_LED_TEST_BLINKSLOW,
-	B43legacy_LED_TEST_BLINKMEDIUM,
-	B43legacy_LED_TEST_BLINKFAST,
 };
 
-int b43legacy_leds_init(struct b43legacy_wldev *dev);
+void b43legacy_leds_init(struct b43legacy_wldev *dev);
 void b43legacy_leds_exit(struct b43legacy_wldev *dev);
-void b43legacy_leds_update(struct b43legacy_wldev *dev, int activity);
-void b43legacy_leds_switch_all(struct b43legacy_wldev *dev, int on);
+
+#else /* CONFIG_B43EGACY_LEDS */
+/* LED support disabled */
+
+struct b43legacy_led {
+	/* empty */
+};
+
+static inline void b43legacy_leds_init(struct b43legacy_wldev *dev)
+{
+}
+static inline void b43legacy_leds_exit(struct b43legacy_wldev *dev)
+{
+}
+#endif /* CONFIG_B43LEGACY_LEDS */
 
 #endif /* B43legacy_LEDS_H_ */


From vitb at kernel.crashing.org  Sat Oct 13 10:17:30 2007
From: vitb at kernel.crashing.org (Vitaly Bordug)
Date: Sat, 13 Oct 2007 12:17:30 +0400
Subject: b43: regression on bcm4318
Message-ID: <20071013121730.1eef0d93@kernel.crashing.org>

Hello John et al,
(previous email had a typo in ML addr, sorry for the extra noise)

Both b43 and b43legacy fail to load on bcm4318 for a while now, while it used to work (with known issues) more or less
fine. The issue started happening not long before ssb united the support of b44 as well. Therefor, I noticed the difference
soon, because I am not able to use ndiswrapper instead anymore (it does not like ssb, and my NIC, b44, does not like
ssb missing either).

dmesg looks like the below:

b43-phy1: Broadcom 4318 WLAN found
b43-phy1 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
phy1: Failed to select rate control algorithm
phy1: Failed to initialize rate control algorithm
b43: probe of ssb0:0 failed with error -2

Currently this is latest rawhide kernel, but has been happening for awhile
(since, at least, 2.6.22.5, where ssb was not yet merged and I still able to use ndiswrapper.

Any hint to debug/investigate it appreciated. It does not look like hw malfunction, since ndiswrapper,
when able to load, still works fine.

-- 
Sincerely, Vitaly


From mb at bu3sch.de  Sat Oct 13 10:24:47 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Oct 2007 10:24:47 +0200
Subject: b43: regression on bcm4318
In-Reply-To: <20071013121730.1eef0d93@kernel.crashing.org>
References: <20071013121730.1eef0d93@kernel.crashing.org>
Message-ID: <200710131024.48113.mb@bu3sch.de>

On Saturday 13 October 2007 10:17:30 Vitaly Bordug wrote:
> phy1: Failed to select rate control algorithm
> phy1: Failed to initialize rate control algorithm

That's nothing b43 or ssb related.
Compile and load the rc80211_simple module.

-- 
Greetings Michael.


From vitb at kernel.crashing.org  Sat Oct 13 10:12:21 2007
From: vitb at kernel.crashing.org (Vitaly Bordug)
Date: Sat, 13 Oct 2007 12:12:21 +0400
Subject: b43: regression on bcm4318
Message-ID: <20071013121221.4bacd8dd@kernel.crashing.org>

Hello John et al,

Both b43 and b43legacy fail to load on bcm4318 for a while now, while it used to work (with known issues) more or less
fine. The issue started happening not long before ssb united the support of b44 as well. Therefor, I noticed the difference
soon, because I am not able to use ndiswrapper instead anymore (it does not like ssb, and my NIC, b44, does not like
ssb missing either).

dmesg looks like the below:

b43-phy1: Broadcom 4318 WLAN found
b43-phy1 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
phy1: Failed to select rate control algorithm
phy1: Failed to initialize rate control algorithm
b43: probe of ssb0:0 failed with error -2

Currently this is latest rawhide kernel, but has been happening for awhile
(since, at least, 2.6.22.5, where ssb was not yet merged and I still able to use ndiswrapper.

Any hint to debug/investigate it appreciated. It does not look like hw malfunction, since ndiswrapper,
when able to load, still works fine.

-- 
Sincerely, Vitaly


From vitb at kernel.crashing.org  Sat Oct 13 16:14:31 2007
From: vitb at kernel.crashing.org (Vitaly Bordug)
Date: Sat, 13 Oct 2007 18:14:31 +0400
Subject: b43: regression on bcm4318
In-Reply-To: <200710131024.48113.mb@bu3sch.de>
References: <20071013121730.1eef0d93@kernel.crashing.org>
	<200710131024.48113.mb@bu3sch.de>
Message-ID: <20071013181431.13bf50a3@kernel.crashing.org>

Hello Michael,

On Sat, 13 Oct 2007 10:24:47 +0200
Michael Buesch wrote:

> On Saturday 13 October 2007 10:17:30 Vitaly Bordug wrote:
> > phy1: Failed to select rate control algorithm
> > phy1: Failed to initialize rate control algorithm
> 
> That's nothing b43 or ssb related.
> Compile and load the rc80211_simple module.
> 
oh, thanks, that was broken module dependencies. Well at least it is saved in archive now, no nobody else
would step into it.

Another question: is this driver known to work okay in ad-hoc or master mode? I gave it a try and there is no
driver-side whine, but it does not seem to work either. I see couple of packages turnaround, sometimes even
dhcp server is able to feed IP via wlan (host is acting as kinda AP), but nothing after that.

And, soon after actual b43 replaced bcm... in rawhide, the same worked, e.g. for at least 5 minutes my wifi-enabled
E61 was able stay up and connected (b43 was in ad-hoc mode that time).

I would appreciate any feedback.
TIA

-- 
Sincerely, Vitaly


From email at christianhoffmann.info  Sat Oct 13 18:23:33 2007
From: email at christianhoffmann.info (Christian Hoffmann)
Date: Sat, 13 Oct 2007 18:23:33 +0200
Subject: b43 with upstream-davem stacktrace
Message-ID: <200710131823.33420.email@christianhoffmann.info>

Hi all,

I tried (I think) latest b43 driver on a bcm4318. It works quite well, but on 
a series of connect/reconnect I had attached stack in dmesg.

Any idea?

Chris

FYI (normal dmesg output)
b43-phy0: Broadcom 4318 WLAN found
b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
Registered led device: b43-phy0:tx
Registered led device: b43-phy0:rx
b43-phy0 debug: Chip initialized
b43-phy0 debug: 32-bit DMA initialized
b43-phy0 debug: Wireless interface started
b43-phy0 debug: Adding Interface type 2
-------------- next part --------------
b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
Registered led device: b43-phy0:tx
Registered led device: b43-phy0:rx
general protection fault: 0000 [1] SMP
CPU 0
Modules linked in: eeprom ircomm_tty ircomm af_packet snd_pcm_oss snd_mixer_oss
snd_seq snd_seq_device radeon drm cpufreq_conservative cpufreq_userspace cpufreq
_powersave powernow_k8 pcmcia snd_atiixp_modem arc4 snd_atiixp ecb blkcipher rc8
0211_simple snd_ac97_codec yenta_socket ac97_bus snd_pcm rsrc_nonstatic snd_time
r snd pcmcia_core b43 firmware_class parport_pc ohci1394 ide_cd ssb rfkill mac80
211 rtc_cmos irda crc_ccitt rtc_core k8temp rtc_lib cfg80211 led_class tifm_7xx1
 output battery ac parport ieee1394 button cdrom tifm_core container soundcore s
nd_page_alloc tg3 hwmon joydev input_polldev i2c_piix4 serio_raw ide_disk ehci_h
cd ohci_hcd usbcore radeonfb fb_ddc i2c_algo_bit i2c_core edd ext3 mbcache jbd f
an atiixp ide_core thermal processor
Pid: 2295, comm: NetworkManager Not tainted 2.6.23-rc9-default #1
RIP: 0010:[<ffffffff802f38aa>]  [<ffffffff802f38aa>] strcmp+0x0/0x1a
RSP: 0018:ffff810078fe5740  EFLAGS: 00010283
RAX: ffff81007d1f5f70 RBX: ffff81007d1f5f40 RCX: ffffffff80418988
RDX: ffffffff881ed3d0 RSI: ffffffff8048498b RDI: 66355f306e616c77
RBP: ffff81007da723a8 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff881ed3a0 R11: ffffffff803921b5 R12: ffff81007da72000
R13: 0000000000000001 R14: 0000000000000000 R15: 66355f306e616c77
FS:  0000000040800950(0063) GS:ffffffff804fc000(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000616278 CR3: 0000000079556000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process NetworkManager (pid: 2295, threadinfo ffff810078fe4000, task ffff810079f
be040)
Stack:  ffffffff803861f8 ffff81007da723a8 ffff81007da723a8 0000000000000000
 ffffffff881ec218 ffff81007da72000 ffff81007da7240a ffff81007da723a0
 ffffffff882da4ba ffff810078fe57f8 0000000000000000 ffff81007d5802e0
Call Trace:
 [<ffffffff803861f8>] led_trigger_set_default+0x3a/0x77
 [<ffffffff881ec218>] :led_class:led_classdev_register+0xb9/0x10d
 [<ffffffff882da4ba>] :b43:b43_register_led+0x83/0xb6
 [<ffffffff882da750>] :b43:b43_leds_init+0x263/0x293
 [<ffffffff8828501d>] :ssb:ssb_pci_switch_core+0x40/0x4b
 [<ffffffff882cae47>] :b43:b43_chip_init+0x56c/0x8d6
 [<ffffffff882cb435>] :b43:b43_wireless_core_init+0x284/0x766
 [<ffffffff882cc585>] :b43:b43_start+0x2e/0x6d
 [<ffffffff8824d8e9>] :mac80211:ieee80211_open+0x1b6/0x39d
 [<ffffffff8039704a>] dev_open+0x2f/0x67
 [<ffffffff80395c8a>] dev_change_flags+0xaa/0x161
 [<ffffffff8039db81>] do_setlink+0x279/0x34b
 [<ffffffff8039e60b>] rtnetlink_rcv_msg+0x0/0x1dc
 [<ffffffff8039edcf>] rtnl_setlink+0xf5/0x116
 [<ffffffff803ab484>] netlink_run_queue+0x68/0xf7
 [<ffffffff8039e587>] rtnetlink_rcv+0x28/0x43
 [<ffffffff803aba04>] netlink_data_ready+0x12/0x50
 [<ffffffff803aa6fa>] netlink_sendskb+0x23/0x3c
 [<ffffffff803ab9df>] netlink_sendmsg+0x2ac/0x2bf
 [<ffffffff80391845>] memcpy_fromiovec+0x36/0x66
 [<ffffffff8038a98c>] sock_sendmsg+0xea/0x107
 [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
 [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
 [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
 [<ffffffff8038abc0>] sys_sendmsg+0x217/0x28a
 [<ffffffff803aa9b8>] netlink_insert+0x13c/0x14b
 [<ffffffff8038bb35>] sys_getsockname+0x9c/0xb2
 [<ffffffff8020bc8e>] system_call+0x7e/0x83


Code: 8a 17 88 d0 2a 06 48 ff c6 84 c0 75 09 84 d2 74 05 48 ff c7
RIP  [<ffffffff802f38aa>] strcmp+0x0/0x1a
 RSP <ffff810078fe5740>
(none):~ #


From mb at bu3sch.de  Sat Oct 13 17:22:32 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Oct 2007 17:22:32 +0200
Subject: b43: regression on bcm4318
In-Reply-To: <20071013181431.13bf50a3@kernel.crashing.org>
References: <20071013121730.1eef0d93@kernel.crashing.org>
	<200710131024.48113.mb@bu3sch.de>
	<20071013181431.13bf50a3@kernel.crashing.org>
Message-ID: <200710131722.32949.mb@bu3sch.de>

On Saturday 13 October 2007 16:14:31 Vitaly Bordug wrote:
> Hello Michael,
> 
> On Sat, 13 Oct 2007 10:24:47 +0200
> Michael Buesch wrote:
> 
> > On Saturday 13 October 2007 10:17:30 Vitaly Bordug wrote:
> > > phy1: Failed to select rate control algorithm
> > > phy1: Failed to initialize rate control algorithm
> > 
> > That's nothing b43 or ssb related.
> > Compile and load the rc80211_simple module.
> > 
> oh, thanks, that was broken module dependencies. Well at least it is saved in archive now, no nobody else
> would step into it.
> 
> Another question: is this driver known to work okay in ad-hoc or master mode? I gave it a try and there is no
> driver-side whine, but it does not seem to work either. I see couple of packages turnaround, sometimes even
> dhcp server is able to feed IP via wlan (host is acting as kinda AP), but nothing after that.

Master and adhoc is not stable, yet.
It might work, though. But I didn't really test that recently.

-- 
Greetings Michael.


From mb at bu3sch.de  Sat Oct 13 17:26:14 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Oct 2007 17:26:14 +0200
Subject: b43 with upstream-davem stacktrace
In-Reply-To: <200710131823.33420.email@christianhoffmann.info>
References: <200710131823.33420.email@christianhoffmann.info>
Message-ID: <200710131726.14289.mb@bu3sch.de>

On Saturday 13 October 2007 18:23:33 Christian Hoffmann wrote:
> Hi all,
> 
> I tried (I think) latest b43 driver on a bcm4318. It works quite well, but on 
> a series of connect/reconnect I had attached stack in dmesg.
> 
> Any idea?
> 
> Chris
> 
> FYI (normal dmesg output)
> b43-phy0: Broadcom 4318 WLAN found
> b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7
> b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
> b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
> Registered led device: b43-phy0:tx
> Registered led device: b43-phy0:rx
> b43-phy0 debug: Chip initialized
> b43-phy0 debug: 32-bit DMA initialized
> b43-phy0 debug: Wireless interface started
> b43-phy0 debug: Adding Interface type 2
> 

I also saw this sometimes, but I have absolutely no idea how that happens.
Someone any idea?


> b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
> Registered led device: b43-phy0:tx
> Registered led device: b43-phy0:rx
> general protection fault: 0000 [1] SMP
> CPU 0
> Modules linked in: eeprom ircomm_tty ircomm af_packet snd_pcm_oss
> snd_mixer_oss snd_seq snd_seq_device radeon drm cpufreq_conservative
> cpufreq_userspace cpufreq _powersave powernow_k8 pcmcia snd_atiixp_modem
> arc4 snd_atiixp ecb blkcipher rc8 0211_simple snd_ac97_codec yenta_socket
> ac97_bus snd_pcm rsrc_nonstatic snd_time r snd pcmcia_core b43
> firmware_class parport_pc ohci1394 ide_cd ssb rfkill mac80 211 rtc_cmos
> irda crc_ccitt rtc_core k8temp rtc_lib cfg80211 led_class tifm_7xx1 output
> battery ac parport ieee1394 button cdrom tifm_core container soundcore s
> nd_page_alloc tg3 hwmon joydev input_polldev i2c_piix4 serio_raw ide_disk
> ehci_h cd ohci_hcd usbcore radeonfb fb_ddc i2c_algo_bit i2c_core edd ext3
> mbcache jbd f an atiixp ide_core thermal processor
> Pid: 2295, comm: NetworkManager Not tainted 2.6.23-rc9-default #1
> RIP: 0010:[<ffffffff802f38aa>]  [<ffffffff802f38aa>] strcmp+0x0/0x1a
> RSP: 0018:ffff810078fe5740  EFLAGS: 00010283
> RAX: ffff81007d1f5f70 RBX: ffff81007d1f5f40 RCX: ffffffff80418988
> RDX: ffffffff881ed3d0 RSI: ffffffff8048498b RDI: 66355f306e616c77
> RBP: ffff81007da723a8 R08: 0000000000000000 R09: 0000000000000000
> R10: ffffffff881ed3a0 R11: ffffffff803921b5 R12: ffff81007da72000
> R13: 0000000000000001 R14: 0000000000000000 R15: 66355f306e616c77
> FS:  0000000040800950(0063) GS:ffffffff804fc000(0000)
> knlGS:0000000000000000 CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
> CR2: 0000000000616278 CR3: 0000000079556000 CR4: 00000000000006e0
> DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
> DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
> Process NetworkManager (pid: 2295, threadinfo ffff810078fe4000, task
> ffff810079f be040)
> Stack:  ffffffff803861f8 ffff81007da723a8 ffff81007da723a8 0000000000000000
>  ffffffff881ec218 ffff81007da72000 ffff81007da7240a ffff81007da723a0
>  ffffffff882da4ba ffff810078fe57f8 0000000000000000 ffff81007d5802e0
> Call Trace:
>  [<ffffffff803861f8>] led_trigger_set_default+0x3a/0x77
>  [<ffffffff881ec218>] :led_class:led_classdev_register+0xb9/0x10d
>  [<ffffffff882da4ba>] :b43:b43_register_led+0x83/0xb6
>  [<ffffffff882da750>] :b43:b43_leds_init+0x263/0x293
>  [<ffffffff8828501d>] :ssb:ssb_pci_switch_core+0x40/0x4b
>  [<ffffffff882cae47>] :b43:b43_chip_init+0x56c/0x8d6
>  [<ffffffff882cb435>] :b43:b43_wireless_core_init+0x284/0x766
>  [<ffffffff882cc585>] :b43:b43_start+0x2e/0x6d
>  [<ffffffff8824d8e9>] :mac80211:ieee80211_open+0x1b6/0x39d
>  [<ffffffff8039704a>] dev_open+0x2f/0x67
>  [<ffffffff80395c8a>] dev_change_flags+0xaa/0x161
>  [<ffffffff8039db81>] do_setlink+0x279/0x34b
>  [<ffffffff8039e60b>] rtnetlink_rcv_msg+0x0/0x1dc
>  [<ffffffff8039edcf>] rtnl_setlink+0xf5/0x116
>  [<ffffffff803ab484>] netlink_run_queue+0x68/0xf7
>  [<ffffffff8039e587>] rtnetlink_rcv+0x28/0x43
>  [<ffffffff803aba04>] netlink_data_ready+0x12/0x50
>  [<ffffffff803aa6fa>] netlink_sendskb+0x23/0x3c
>  [<ffffffff803ab9df>] netlink_sendmsg+0x2ac/0x2bf
>  [<ffffffff80391845>] memcpy_fromiovec+0x36/0x66
>  [<ffffffff8038a98c>] sock_sendmsg+0xea/0x107
>  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
>  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
>  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
>  [<ffffffff8038abc0>] sys_sendmsg+0x217/0x28a
>  [<ffffffff803aa9b8>] netlink_insert+0x13c/0x14b
>  [<ffffffff8038bb35>] sys_getsockname+0x9c/0xb2
>  [<ffffffff8020bc8e>] system_call+0x7e/0x83
>
>
> Code: 8a 17 88 d0 2a 06 48 ff c6 84 c0 75 09 84 d2 74 05 48 ff c7
> RIP  [<ffffffff802f38aa>] strcmp+0x0/0x1a
>  RSP <ffff810078fe5740>
> (none):~ #

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Sun Oct 14 06:46:47 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 13 Oct 2007 23:46:47 -0500
Subject: [PATCH] ssb: Fix regression in 2.6.23-git3 due to change in
	calling add_uevent_var
Message-ID: <47119f37.hwmEVx/qSP6GAYhm%Larry.Finger@lwfinger.net>

In commit 7eff2e7a8b65c25920207324e56611150eb1cd9a, the calling sequence
for add_uevent_var was changed, but the ssb driver was not modified, which
leads to a "Unable to handle kernel paging request" oops. This patch fixes
the problem.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

 drivers/ssb/main.c |   11 +++--------
 1 file changed, 3 insertions(+), 8 deletions(-)

Index: linux-2.6/drivers/ssb/main.c
===================================================================
--- linux-2.6.orig/drivers/ssb/main.c
+++ linux-2.6/drivers/ssb/main.c
@@ -320,22 +320,17 @@ static int ssb_bus_match(struct device *
 	return 0;
 }
 
-static int ssb_device_uevent(struct device *dev, char **envp, int num_envp,
-			     char *buffer, int buffer_size)
+static int ssb_device_uevent(struct device *dev, struct kobj_uevent_env *env)
 {
 	struct ssb_device *ssb_dev = dev_to_ssb_dev(dev);
-	int ret, i = 0, length = 0;
+	int ret;
 
 	if (!dev)
 		return -ENODEV;
 
-	ret = add_uevent_var(envp, num_envp, &i,
-			     buffer, buffer_size, &length,
-			     "MODALIAS=ssb:v%04Xid%04Xrev%02X",
+	ret = add_uevent_var(env, "MODALIAS=ssb:v%04Xid%04Xrev%02X",
 			     ssb_dev->id.vendor, ssb_dev->id.coreid,
 			     ssb_dev->id.revision);
-	envp[i] = NULL;
-
 	return ret;
 }
 


From mb at bu3sch.de  Sun Oct 14 11:35:17 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 14 Oct 2007 11:35:17 +0200
Subject: [PATCH] ssb: Fix regression in 2.6.23-git3 due to change in
	calling add_uevent_var
In-Reply-To: <47119f37.hwmEVx/qSP6GAYhm%Larry.Finger@lwfinger.net>
References: <47119f37.hwmEVx/qSP6GAYhm%Larry.Finger@lwfinger.net>
Message-ID: <200710141135.17798.mb@bu3sch.de>

On Sunday 14 October 2007 06:46:47 Larry Finger wrote:
> In commit 7eff2e7a8b65c25920207324e56611150eb1cd9a, the calling sequence
> for add_uevent_var was changed, but the ssb driver was not modified, which
> leads to a "Unable to handle kernel paging request" oops. This patch fixes
> the problem.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>

Acked-by: Michael Buesch <mb at bu3sch.de>

> ---
> 
>  drivers/ssb/main.c |   11 +++--------
>  1 file changed, 3 insertions(+), 8 deletions(-)
> 
> Index: linux-2.6/drivers/ssb/main.c
> ===================================================================
> --- linux-2.6.orig/drivers/ssb/main.c
> +++ linux-2.6/drivers/ssb/main.c
> @@ -320,22 +320,17 @@ static int ssb_bus_match(struct device *
>  	return 0;
>  }
>  
> -static int ssb_device_uevent(struct device *dev, char **envp, int num_envp,
> -			     char *buffer, int buffer_size)
> +static int ssb_device_uevent(struct device *dev, struct kobj_uevent_env *env)
>  {
>  	struct ssb_device *ssb_dev = dev_to_ssb_dev(dev);
> -	int ret, i = 0, length = 0;
> +	int ret;
>  
>  	if (!dev)
>  		return -ENODEV;
>  
> -	ret = add_uevent_var(envp, num_envp, &i,
> -			     buffer, buffer_size, &length,
> -			     "MODALIAS=ssb:v%04Xid%04Xrev%02X",
> +	ret = add_uevent_var(env, "MODALIAS=ssb:v%04Xid%04Xrev%02X",
>  			     ssb_dev->id.vendor, ssb_dev->id.coreid,
>  			     ssb_dev->id.revision);
> -	envp[i] = NULL;
> -
>  	return ret;
>  }
>  
> 
> 



-- 
Greetings Michael.


From johannes at sipsolutions.net  Sun Oct 14 11:42:58 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 14 Oct 2007 11:42:58 +0200
Subject: b43 with upstream-davem stacktrace
In-Reply-To: <200710131726.14289.mb@bu3sch.de>
	(sfid-20071013_162714_205094_D26CE64D)
References: <200710131823.33420.email@christianhoffmann.info>
	<200710131726.14289.mb@bu3sch.de>
	(sfid-20071013_162714_205094_D26CE64D)
Message-ID: <1192354978.4770.100.camel@johannes.berg>

On Sat, 2007-10-13 at 17:26 +0200, Michael Buesch wrote:

> I also saw this sometimes, but I have absolutely no idea how that happens.
> Someone any idea?

Nope, but adding more CCs :) I briefly looked at the code and couldn't
track it. Got a powerpc oops with disassembly?

> > b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
> > Registered led device: b43-phy0:tx
> > Registered led device: b43-phy0:rx
> > general protection fault: 0000 [1] SMP
> > CPU 0
> > Modules linked in: eeprom ircomm_tty ircomm af_packet snd_pcm_oss
> > snd_mixer_oss snd_seq snd_seq_device radeon drm cpufreq_conservative
> > cpufreq_userspace cpufreq _powersave powernow_k8 pcmcia snd_atiixp_modem
> > arc4 snd_atiixp ecb blkcipher rc8 0211_simple snd_ac97_codec yenta_socket
> > ac97_bus snd_pcm rsrc_nonstatic snd_time r snd pcmcia_core b43
> > firmware_class parport_pc ohci1394 ide_cd ssb rfkill mac80 211 rtc_cmos
> > irda crc_ccitt rtc_core k8temp rtc_lib cfg80211 led_class tifm_7xx1 output
> > battery ac parport ieee1394 button cdrom tifm_core container soundcore s
> > nd_page_alloc tg3 hwmon joydev input_polldev i2c_piix4 serio_raw ide_disk
> > ehci_h cd ohci_hcd usbcore radeonfb fb_ddc i2c_algo_bit i2c_core edd ext3
> > mbcache jbd f an atiixp ide_core thermal processor
> > Pid: 2295, comm: NetworkManager Not tainted 2.6.23-rc9-default #1
> > RIP: 0010:[<ffffffff802f38aa>]  [<ffffffff802f38aa>] strcmp+0x0/0x1a
> > RSP: 0018:ffff810078fe5740  EFLAGS: 00010283
> > RAX: ffff81007d1f5f70 RBX: ffff81007d1f5f40 RCX: ffffffff80418988
> > RDX: ffffffff881ed3d0 RSI: ffffffff8048498b RDI: 66355f306e616c77
> > RBP: ffff81007da723a8 R08: 0000000000000000 R09: 0000000000000000
> > R10: ffffffff881ed3a0 R11: ffffffff803921b5 R12: ffff81007da72000
> > R13: 0000000000000001 R14: 0000000000000000 R15: 66355f306e616c77
> > FS:  0000000040800950(0063) GS:ffffffff804fc000(0000)
> > knlGS:0000000000000000 CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
> > CR2: 0000000000616278 CR3: 0000000079556000 CR4: 00000000000006e0
> > DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
> > DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
> > Process NetworkManager (pid: 2295, threadinfo ffff810078fe4000, task
> > ffff810079f be040)
> > Stack:  ffffffff803861f8 ffff81007da723a8 ffff81007da723a8 0000000000000000
> >  ffffffff881ec218 ffff81007da72000 ffff81007da7240a ffff81007da723a0
> >  ffffffff882da4ba ffff810078fe57f8 0000000000000000 ffff81007d5802e0
> > Call Trace:
> >  [<ffffffff803861f8>] led_trigger_set_default+0x3a/0x77
> >  [<ffffffff881ec218>] :led_class:led_classdev_register+0xb9/0x10d
> >  [<ffffffff882da4ba>] :b43:b43_register_led+0x83/0xb6
> >  [<ffffffff882da750>] :b43:b43_leds_init+0x263/0x293
> >  [<ffffffff8828501d>] :ssb:ssb_pci_switch_core+0x40/0x4b
> >  [<ffffffff882cae47>] :b43:b43_chip_init+0x56c/0x8d6
> >  [<ffffffff882cb435>] :b43:b43_wireless_core_init+0x284/0x766
> >  [<ffffffff882cc585>] :b43:b43_start+0x2e/0x6d
> >  [<ffffffff8824d8e9>] :mac80211:ieee80211_open+0x1b6/0x39d
> >  [<ffffffff8039704a>] dev_open+0x2f/0x67
> >  [<ffffffff80395c8a>] dev_change_flags+0xaa/0x161
> >  [<ffffffff8039db81>] do_setlink+0x279/0x34b
> >  [<ffffffff8039e60b>] rtnetlink_rcv_msg+0x0/0x1dc
> >  [<ffffffff8039edcf>] rtnl_setlink+0xf5/0x116
> >  [<ffffffff803ab484>] netlink_run_queue+0x68/0xf7
> >  [<ffffffff8039e587>] rtnetlink_rcv+0x28/0x43
> >  [<ffffffff803aba04>] netlink_data_ready+0x12/0x50
> >  [<ffffffff803aa6fa>] netlink_sendskb+0x23/0x3c
> >  [<ffffffff803ab9df>] netlink_sendmsg+0x2ac/0x2bf
> >  [<ffffffff80391845>] memcpy_fromiovec+0x36/0x66
> >  [<ffffffff8038a98c>] sock_sendmsg+0xea/0x107
> >  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
> >  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
> >  [<ffffffff8024699f>] autoremove_wake_function+0x0/0x2e
> >  [<ffffffff8038abc0>] sys_sendmsg+0x217/0x28a
> >  [<ffffffff803aa9b8>] netlink_insert+0x13c/0x14b
> >  [<ffffffff8038bb35>] sys_getsockname+0x9c/0xb2
> >  [<ffffffff8020bc8e>] system_call+0x7e/0x83
> >
> >
> > Code: 8a 17 88 d0 2a 06 48 ff c6 84 c0 75 09 84 d2 74 05 48 ff c7
> > RIP  [<ffffffff802f38aa>] strcmp+0x0/0x1a
> >  RSP <ffff810078fe5740>
> > (none):~ #
> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071014/84cb5df3/attachment.pgp>

From johannes at sipsolutions.net  Sun Oct 14 11:48:02 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 14 Oct 2007 11:48:02 +0200
Subject: b43: regression on bcm4318
In-Reply-To: <20071013181431.13bf50a3@kernel.crashing.org>
	(sfid-20071013_151459_365523_50FF43F1)
References: <20071013121730.1eef0d93@kernel.crashing.org>
	<200710131024.48113.mb@bu3sch.de>
	<20071013181431.13bf50a3@kernel.crashing.org>
	(sfid-20071013_151459_365523_50FF43F1)
Message-ID: <1192355282.4770.104.camel@johannes.berg>

On Sat, 2007-10-13 at 18:14 +0400, Vitaly Bordug wrote:

> Another question: is this driver known to work okay in ad-hoc or master mode? I gave it a try and there is no
> driver-side whine, but it does not seem to work either. I see couple of packages turnaround, sometimes even
> dhcp server is able to feed IP via wlan (host is acting as kinda AP), but nothing after that.

b43 works in master mode with all my hostapd enablement patches
(johannes.sipsolutions.net/patches/{hostap,kernel}

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071014/6868396f/attachment.pgp>

From Larry.Finger at lwfinger.net  Sun Oct 14 23:04:30 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 14 Oct 2007 16:04:30 -0500
Subject: [PATCH] b43legacy: Fix potential return of uninitialized variable
Message-ID: <4712845e.dLDtF9nZG6ErzRvs%Larry.Finger@lwfinger.net>

Using the Coverity checker, Adrian Bunk found that routine b43legacy_start
could return an unitialized variable. This patch fixes the problem.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This patch is intended for the everything branch of wireless-2.6.

Larry
---

 drivers/net/wireless/b43legacy/main.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/main.c
@@ -3237,7 +3237,7 @@ static int b43legacy_start(struct ieee80
 	struct b43legacy_wl *wl = hw_to_b43legacy_wl(hw);
 	struct b43legacy_wldev *dev = wl->current_dev;
 	int did_init = 0;
-	int err;
+	int err = 0;
 
 	mutex_lock(&wl->mutex);
 


From mb at bu3sch.de  Mon Oct 15 14:52:57 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 15 Oct 2007 14:52:57 +0200
Subject: [PATCH] b43: jiffies_round -> jiffies_round_relative conversion -
	b43/b43legacy
Message-ID: <200710151452.58150.mb@bu3sch.de>

When rounding a relative timeout we need to use round_jiffies_relative(). 

Signed-off-by: Anton Blanchard <anton at samba.org>
Signed-off-by: Michael Buesch <mb at bu3sch.de>
---

diff --git a/drivers/net/wireless/b43/main.c b/drivers/net/wireless/b43/main.c
index c141a26..41049a4 100644
--- a/drivers/net/wireless/b43/main.c
+++ b/drivers/net/wireless/b43/main.c
@@ -2392,7 +2392,7 @@ out_requeue:
 	if (b43_debug(dev, B43_DBG_PWORK_FAST))
 		delay = msecs_to_jiffies(50);
 	else
-		delay = round_jiffies(HZ * 15);
+		delay = round_jiffies_relative(HZ * 15);
 	queue_delayed_work(wl->hw->workqueue, &dev->periodic_work, delay);
 out:
 	mutex_unlock(&wl->mutex);
diff --git a/drivers/net/wireless/b43legacy/main.c b/drivers/net/wireless/b43legacy/main.c
index f074951..bd0bd9b 100644
--- a/drivers/net/wireless/b43legacy/main.c
+++ b/drivers/net/wireless/b43legacy/main.c
@@ -2260,7 +2260,7 @@ out_requeue:
 	if (b43legacy_debug(dev, B43legacy_DBG_PWORK_FAST))
 		delay = msecs_to_jiffies(50);
 	else
-		delay = round_jiffies(HZ);
+		delay = round_jiffies_relative(HZ);
 	queue_delayed_work(dev->wl->hw->workqueue,
 			   &dev->periodic_work, delay);
 out:


-------------------------------------------------------

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Oct 15 14:54:45 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 15 Oct 2007 14:54:45 +0200
Subject: Fwd: [-mm Patch] drivers/net/wireless/b43legacy/main.c: initialize
	the correct return value
Message-ID: <200710151454.46047.mb@bu3sch.de>

From: Adrian Bunk <bunk at kernel.org>

Initialize "err" in drivers/net/wireless/b43legacy/main.c::b43legacy_start()
in case of returning an uninitialized value.

Signed-off-by: WANG Cong <xiyou.wangcong at gmail.com>
Signed-off-by: Michael Buesch <mb at bu3sch.de>

---
 drivers/net/wireless/b43/main.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: linux-2.6.23-mm1/drivers/net/wireless/b43legacy/main.c
===================================================================
--- linux-2.6.23-mm1.orig/drivers/net/wireless/b43legacy/main.c
+++ linux-2.6.23-mm1/drivers/net/wireless/b43legacy/main.c
@@ -3306,7 +3306,7 @@ static int b43legacy_start(struct ieee80
 	struct b43legacy_wl *wl = hw_to_b43legacy_wl(hw);
 	struct b43legacy_wldev *dev = wl->current_dev;
 	int did_init = 0;
-	int err;
+	int err = 0;
 
 	mutex_lock(&wl->mutex);
 


-------------------------------------------------------

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Oct 15 14:56:16 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 15 Oct 2007 14:56:16 +0200
Subject: b43 with upstream-davem stacktrace
In-Reply-To: <1192439126.5684.13.camel@localhost.localdomain>
References: <200710131823.33420.email@christianhoffmann.info>
	<1192354978.4770.100.camel@johannes.berg>
	<1192439126.5684.13.camel@localhost.localdomain>
Message-ID: <200710151456.16459.mb@bu3sch.de>

On Monday 15 October 2007 11:05:26 Richard Purdie wrote:
> On Sun, 2007-10-14 at 11:42 +0200, Johannes Berg wrote:
> > On Sat, 2007-10-13 at 17:26 +0200, Michael Buesch wrote:
> > 
> > > I also saw this sometimes, but I have absolutely no idea how that happens.
> > > Someone any idea?
> > 
> > Nope, but adding more CCs :) I briefly looked at the code and couldn't
> > track it. Got a powerpc oops with disassembly?
> 
> It appears to be having a problem in the strcmp in
> led_trigger_set_default() which is odd. Code above that checks if one of
> the options is NULL so all I can think it either the default_trigger
> string being passed in is invalid or there is a trigger with an invalid
> name registered with the system.
> 
> Is this an SMP system and would something else be registering an LED
> trigger on another processor or similar? There is locking there which
> should be sufficient though. So no, I'm not sure whats going on
> either...
> 

I think this is some kind of a race, as it does only happen rarely and
is not really reproducible.


-- 
Greetings Michael.


From mb at bu3sch.de  Mon Oct 15 16:23:04 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 15 Oct 2007 16:23:04 +0200
Subject: [patch] ssb: fix build failure
Message-ID: <200710151623.04881.mb@bu3sch.de>

From: Ingo Molnar <mingo at elte.hu>

fix build failure if PCMCIA=m but SSB=y:

drivers/built-in.o: In function `ssb_pcmcia_switch_coreidx':
: undefined reference to `pcmcia_access_configuration_register'

(fix symmetric bug for PCI too.)

Signed-off-by: Ingo Molnar <mingo at elte.hu>
Signed-off-by: Michael Buesch <mb at bu3sch.de>

---
 drivers/ssb/Kconfig |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: linux/drivers/ssb/Kconfig
===================================================================
--- linux.orig/drivers/ssb/Kconfig
+++ linux/drivers/ssb/Kconfig
@@ -22,7 +22,7 @@ config SSB
 
 config SSB_PCIHOST_POSSIBLE
 	bool
-	depends on SSB && PCI
+	depends on SSB && (PCI = SSB)
 	default y
 
 config SSB_PCIHOST
@@ -37,7 +37,7 @@ config SSB_PCIHOST
 
 config SSB_PCMCIAHOST_POSSIBLE
 	bool
-	depends on SSB && PCMCIA && EXPERIMENTAL
+	depends on SSB && (PCMCIA = SSB) && EXPERIMENTAL
 	default y
 
 config SSB_PCMCIAHOST


-------------------------------------------------------

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Oct 15 17:12:51 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 15 Oct 2007 10:12:51 -0500
Subject: [PATCH] b43: jiffies_round -> jiffies_round_relative conversion
	- b43/b43legacy
In-Reply-To: <200710151452.58150.mb@bu3sch.de>
References: <200710151452.58150.mb@bu3sch.de>
Message-ID: <47138373.3010703@lwfinger.net>

Michael Buesch wrote:
> When rounding a relative timeout we need to use round_jiffies_relative(). 
> 
> Signed-off-by: Anton Blanchard <anton at samba.org>
> Signed-off-by: Michael Buesch <mb at bu3sch.de>

Acked-by: Larry Finger <Larry.Finger at lwfinger.net>

> ---
> 
> diff --git a/drivers/net/wireless/b43/main.c b/drivers/net/wireless/b43/main.c
> index c141a26..41049a4 100644
> --- a/drivers/net/wireless/b43/main.c
> +++ b/drivers/net/wireless/b43/main.c
> @@ -2392,7 +2392,7 @@ out_requeue:
>  	if (b43_debug(dev, B43_DBG_PWORK_FAST))
>  		delay = msecs_to_jiffies(50);
>  	else
> -		delay = round_jiffies(HZ * 15);
> +		delay = round_jiffies_relative(HZ * 15);
>  	queue_delayed_work(wl->hw->workqueue, &dev->periodic_work, delay);
>  out:
>  	mutex_unlock(&wl->mutex);
> diff --git a/drivers/net/wireless/b43legacy/main.c b/drivers/net/wireless/b43legacy/main.c
> index f074951..bd0bd9b 100644
> --- a/drivers/net/wireless/b43legacy/main.c
> +++ b/drivers/net/wireless/b43legacy/main.c
> @@ -2260,7 +2260,7 @@ out_requeue:
>  	if (b43legacy_debug(dev, B43legacy_DBG_PWORK_FAST))
>  		delay = msecs_to_jiffies(50);
>  	else
> -		delay = round_jiffies(HZ);
> +		delay = round_jiffies_relative(HZ);
>  	queue_delayed_work(dev->wl->hw->workqueue,
>  			   &dev->periodic_work, delay);
>  out:
> 
> 
> -------------------------------------------------------
> 



From mb at bu3sch.de  Mon Oct 15 17:23:21 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 15 Oct 2007 17:23:21 +0200
Subject: [patch #2] ssb: fix build failure
Message-ID: <200710151723.21423.mb@bu3sch.de>

From: Ingo Molnar <mingo at elte.hu>

fix build failure if PCMCIA=m but SSB=y:

drivers/built-in.o: In function `ssb_pcmcia_switch_coreidx':
: undefined reference to `pcmcia_access_configuration_register'

(fix symmetric bug for PCI too.)

Signed-off-by: Ingo Molnar <mingo at elte.hu>
Signed-off-by: Michael Buesch <mb at bu3sch.de>

---
 drivers/ssb/Kconfig |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: linux/drivers/ssb/Kconfig
===================================================================
--- linux.orig/drivers/ssb/Kconfig
+++ linux/drivers/ssb/Kconfig
@@ -22,7 +22,7 @@ config SSB
 
 config SSB_PCIHOST_POSSIBLE
 	bool
-	depends on SSB && PCI
+	depends on SSB && (PCI = y || PCI = SSB)
 	default y
 
 config SSB_PCIHOST
@@ -37,7 +37,7 @@ config SSB_PCIHOST
 
 config SSB_PCMCIAHOST_POSSIBLE
 	bool
-	depends on SSB && PCMCIA && EXPERIMENTAL
+	depends on SSB && (PCMCIA = y || PCMCIA = SSB) && EXPERIMENTAL
 	default y
 
 config SSB_PCMCIAHOST



-------------------------------------------------------

-- 
Greetings Michael.


From email at christianhoffmann.info  Mon Oct 15 21:30:24 2007
From: email at christianhoffmann.info (Christian Hoffmann)
Date: Mon, 15 Oct 2007 21:30:24 +0200
Subject: b43 with upstream-davem stacktrace
In-Reply-To: <1192439126.5684.13.camel@localhost.localdomain>
References: <200710131823.33420.email@christianhoffmann.info>
	<1192354978.4770.100.camel@johannes.berg>
	<1192439126.5684.13.camel@localhost.localdomain>
Message-ID: <200710152130.24950.email@christianhoffmann.info>

On Monday 15 October 2007 11:05:26 am Richard Purdie wrote:
> It appears to be having a problem in the strcmp in
> led_trigger_set_default() which is odd. Code above that checks if one of
> the options is NULL so all I can think it either the default_trigger
> string being passed in is invalid or there is a trigger with an invalid
> name registered with the system.

It's a SMP kernel, but running on a single CPU (single core AMD Turion).

Chris


From larry.finger at lwfinger.net  Tue Oct 16 15:39:56 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 16 Oct 2007 08:39:56 -0500
Subject: Fwd: [-mm Patch] drivers/net/wireless/b43legacy/main.c: initialize
	the correct return value
In-Reply-To: <200710151454.46047.mb@bu3sch.de>
References: <200710151454.46047.mb@bu3sch.de>
Message-ID: <4714BF2C.6060008@lwfinger.net>

Michael Buesch wrote:
> From: Adrian Bunk <bunk at kernel.org>
> 
> Initialize "err" in drivers/net/wireless/b43legacy/main.c::b43legacy_start()
> in case of returning an uninitialized value.
> 
> Signed-off-by: WANG Cong <xiyou.wangcong at gmail.com>
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> 
> ---
>  drivers/net/wireless/b43/main.c |    2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
> 
> Index: linux-2.6.23-mm1/drivers/net/wireless/b43legacy/main.c
> ===================================================================
> --- linux-2.6.23-mm1.orig/drivers/net/wireless/b43legacy/main.c
> +++ linux-2.6.23-mm1/drivers/net/wireless/b43legacy/main.c
> @@ -3306,7 +3306,7 @@ static int b43legacy_start(struct ieee80
>  	struct b43legacy_wl *wl = hw_to_b43legacy_wl(hw);
>  	struct b43legacy_wldev *dev = wl->current_dev;
>  	int did_init = 0;
> -	int err;
> +	int err = 0;
>  
>  	mutex_lock(&wl->mutex);
>  
> 
> 
> -------------------------------------------------------
> 



From linville at tuxdriver.com  Wed Oct 17 03:03:39 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Tue, 16 Oct 2007 21:03:39 -0400
Subject: [PATCH] ssb: Fix regression in 2.6.23-git3 due to change in
	calling add_uevent_var
In-Reply-To: <47119f37.hwmEVx/qSP6GAYhm%Larry.Finger@lwfinger.net>
References: <47119f37.hwmEVx/qSP6GAYhm%Larry.Finger@lwfinger.net>
Message-ID: <20071017010338.GA3441@tuxdriver.com>

On Sat, Oct 13, 2007 at 11:46:47PM -0500, Larry Finger wrote:
> In commit 7eff2e7a8b65c25920207324e56611150eb1cd9a, the calling sequence
> for add_uevent_var was changed, but the ssb driver was not modified, which
> leads to a "Unable to handle kernel paging request" oops. This patch fixes
> the problem.

Sorry, Al Viro got a patch merged before I got to yours!

Thanks anyway!

John
-- 
John W. Linville
linville at tuxdriver.com


From zajec5polish at gmail.com  Wed Oct 17 13:25:52 2007
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Wed, 17 Oct 2007 13:25:52 +0200
Subject: Status of support for some chips
Message-ID: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>

Hi,

I wonder if page http://bcm43xx.berlios.de/?go=devices is really up to
date? I think 4318 is supported quite nice in kernel 2.6.22.

Could someone update this list of supported chips?

-- 
Rafa? Mi?ecki

From larry.finger at lwfinger.net  Wed Oct 17 16:00:46 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 17 Oct 2007 09:00:46 -0500
Subject: Status of support for some chips
In-Reply-To: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>
Message-ID: <4716158E.7010501@lwfinger.net>

Rafa? Mi?ecki wrote:
> Hi,
> 
> I wonder if page http://bcm43xx.berlios.de/?go=devices is really up to
> date? I think 4318 is supported quite nice in kernel 2.6.22.
> 
> Could someone update this list of supported chips?
> 

This patch will update this page.

Larry

Index: bcm43xx_devices/bcm43xx_devices.htm
===================================================================
--- bcm43xx_devices.orig/bcm43xx_devices.htm
+++ bcm43xx_devices/bcm43xx_devices.htm
@@ -59,14 +59,19 @@ relevant lines from <code>lspci -vn</cod
 <tr>
 	<td>4309</td>
 	<td>PCI/Cardbus</td>
-	<td>Unstable (802.11a unsupported, work in progress)</td>
+	<td>802.11b/g supported for kernel 2.6.22 and later (802.11a unsupported, work in progress)</td>
 </tr>
 <tr>
-	<td>4311</td>
+	<td>4311 rev 1</td>
 	<td>PCI-E</td>
 	<td>Supported for kernel 2.6.20.6 and later</td>
 </tr>
 <tr>
+	<td>4311 rev 2</td>
+	<td>PCI-E</td>
+	<td>Unsupported</td>
+</tr>
+<tr>
 	<td>4312</td>
 	<td>PCI-E</td>
 	<td>802.11b/g supported for kernel 2.6.20 and later (802.11a unsupported, work in progress)</td>
@@ -74,13 +79,12 @@ relevant lines from <code>lspci -vn</cod
 <tr>
 	<td>4318</td>
 	<td>PCI/Cardbus</td>
-	<td>Unstable (transmission power issues, work in progress)</td>
+	<td>Supported for kernel 2.6.22 and later</td>
 </tr>
 <tr>
 	<td>4319</td>
 	<td>PCI/Cardbus</td>
-	<td>Unstable (transmission power issues, 802.11a unsupported,
-	work in progress)</td>
+	<td>802.11b/g supported for kernel 2.6.22 and later (802.11a unsupported, work in progress)</td>
 </tr>
 <tr>
 	<td>43XG</td>
@@ -420,4 +424,4 @@ relevant lines from <code>lspci -vn</cod


 </body>
-</html>
\ No newline at end of file
+</html>



From Larry.Finger at lwfinger.net  Wed Oct 17 16:19:11 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 17 Oct 2007 09:19:11 -0500
Subject: [PATCH] b43legacy: Fix namespace pollution and sparse warnings
Message-ID: <471619df.MJiGpryn7cdyHLRf%Larry.Finger@lwfinger.net>

From: Joe Perches <joe at perches.com>

A number of routines should be made static to avoid polluting the namespace.

There are additional sparse warnings in b43legacy. None of them result
in program errors, but are fixed for completeness.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

 drivers/net/wireless/b43legacy/debugfs.c |   14 +++++++-------
 drivers/net/wireless/b43legacy/pio.c     |    6 +++---
 2 files changed, 10 insertions(+), 10 deletions(-)

Index: wireless-2.6/drivers/net/wireless/b43legacy/debugfs.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/debugfs.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/debugfs.c
@@ -39,7 +39,7 @@
 
 
 /* The root directory. */
-struct dentry *rootdir;
+static struct dentry *rootdir;
 
 struct b43legacy_debugfs_fops {
 	ssize_t (*read)(struct b43legacy_wldev *dev, char *buf, size_t bufsize);
@@ -76,7 +76,7 @@ struct b43legacy_dfs_file * fops_to_dfs_
 
 
 /* wl->irq_lock is locked */
-ssize_t tsf_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
+static ssize_t tsf_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	u64 tsf;
@@ -90,7 +90,7 @@ ssize_t tsf_read_file(struct b43legacy_w
 }
 
 /* wl->irq_lock is locked */
-int tsf_write_file(struct b43legacy_wldev *dev, const char *buf, size_t count)
+static int tsf_write_file(struct b43legacy_wldev *dev, const char *buf, size_t count)
 {
 	u64 tsf;
 
@@ -102,7 +102,7 @@ int tsf_write_file(struct b43legacy_wlde
 }
 
 /* wl->irq_lock is locked */
-ssize_t ucode_regs_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
+static ssize_t ucode_regs_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	int i;
@@ -116,7 +116,7 @@ ssize_t ucode_regs_read_file(struct b43l
 }
 
 /* wl->irq_lock is locked */
-ssize_t shm_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
+static ssize_t shm_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	int i;
@@ -135,7 +135,7 @@ ssize_t shm_read_file(struct b43legacy_w
 	return count;
 }
 
-ssize_t txstat_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
+static ssize_t txstat_read_file(struct b43legacy_wldev *dev, char *buf, size_t bufsize)
 {
 	struct b43legacy_txstatus_log *log = &dev->dfsentry->txstatlog;
 	ssize_t count = 0;
@@ -183,7 +183,7 @@ out_unlock:
 }
 
 /* wl->irq_lock is locked */
-int restart_write_file(struct b43legacy_wldev *dev, const char *buf, size_t count)
+static int restart_write_file(struct b43legacy_wldev *dev, const char *buf, size_t count)
 {
 	int err = 0;
 
Index: wireless-2.6/drivers/net/wireless/b43legacy/pio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43legacy/pio.c
+++ wireless-2.6/drivers/net/wireless/b43legacy/pio.c
@@ -66,7 +66,7 @@ static u16 tx_get_next_word(const u8 *tx
 		source = packet;
 		i -= txhdr_size;
 	}
-	ret = le16_to_cpu(*((u16 *)(source + i)));
+	ret = le16_to_cpu(*((__le16 *)(source + i)));
 	*pos += 2;
 
 	return ret;
@@ -539,7 +539,7 @@ static void pio_rx_error(struct b43legac
 
 void b43legacy_pio_rx(struct b43legacy_pioqueue *queue)
 {
-	u16 preamble[21] = { 0 };
+	__le16 preamble[21] = { 0 };
 	struct b43legacy_rxhdr_fw3 *rxhdr;
 	u16 tmp;
 	u16 len;
@@ -609,7 +609,7 @@ data_ready:
 	skb_put(skb, len);
 	for (i = 0; i < len - 1; i += 2) {
 		tmp = b43legacy_pio_read(queue, B43legacy_PIO_RXDATA);
-		*((u16 *)(skb->data + i)) = cpu_to_le16(tmp);
+		*((__le16 *)(skb->data + i)) = cpu_to_le16(tmp);
 	}
 	if (len % 2) {
 		tmp = b43legacy_pio_read(queue, B43legacy_PIO_RXDATA);


From mb at bu3sch.de  Wed Oct 17 18:34:03 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 17 Oct 2007 18:34:03 +0200
Subject: [PATCH #3] b43: Fix sparse warnings.
Message-ID: <200710171834.03495.mb@bu3sch.de>

The remaining warning in phy.c will be fixed later.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is the third time I submit this.
Is something wrong with this patch or did you simply forget to apply it?

Index: wireless-2.6/drivers/net/wireless/b43/pio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/pio.c	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/pio.c	2007-10-17 18:19:45.000000000 +0200
@@ -60,7 +60,7 @@ static u16 tx_get_next_word(const u8 * t
 		source = packet;
 		i -= txhdr_size;
 	}
-	ret = le16_to_cpu(*((u16 *) (source + i)));
+	ret = le16_to_cpu(*((__le16 *)(source + i)));
 	*pos += 2;
 
 	return ret;
@@ -104,7 +104,7 @@ static u16 generate_cookie(struct b43_pi
 			   struct b43_pio_txpacket *packet)
 {
 	u16 cookie = 0x0000;
-	int packetindex;
+	u16 packetindex;
 
 	/* We use the upper 4 bits for the PIO
 	 * controller ID and the lower 12 bits
@@ -125,7 +125,7 @@ static u16 generate_cookie(struct b43_pi
 	default:
 		B43_WARN_ON(1);
 	}
-	packetindex = pio_txpacket_getindex(packet);
+	packetindex = packet->index;
 	B43_WARN_ON(packetindex & ~0x0FFF);
 	cookie |= (u16) packetindex;
 
@@ -286,6 +286,7 @@ static void setup_txqueues(struct b43_pi
 
 		packet->queue = queue;
 		INIT_LIST_HEAD(&packet->list);
+		packet->index = i;
 
 		list_add(&packet->list, &queue->txfree);
 	}
@@ -518,9 +519,10 @@ static void pio_rx_error(struct b43_pioq
 
 void b43_pio_rx(struct b43_pioqueue *queue)
 {
-	u16 preamble[21] = { 0 };
+	__le16 preamble[21] = { 0 };
 	struct b43_rxhdr_fw4 *rxhdr;
-	u16 tmp, len, macstat;
+	u16 tmp, len;
+	u32 macstat;
 	int i, preamble_readwords;
 	struct sk_buff *skb;
 
@@ -537,7 +539,7 @@ void b43_pio_rx(struct b43_pioqueue *que
 	}
 	b43dbg(queue->dev->wl, "PIO RX timed out\n");
 	return;
-      data_ready:
+data_ready:
 
 	len = b43_pio_read(queue, B43_PIO_RXDATA);
 	if (unlikely(len > 0x700)) {
@@ -558,7 +560,7 @@ void b43_pio_rx(struct b43_pioqueue *que
 		preamble[i + 1] = cpu_to_le16(tmp);
 	}
 	rxhdr = (struct b43_rxhdr_fw4 *)preamble;
-	macstat = le16_to_cpu(rxhdr->mac_status);
+	macstat = le32_to_cpu(rxhdr->mac_status);
 	if (macstat & B43_RX_MAC_FCSERR) {
 		pio_rx_error(queue,
 			     (queue->mmio_base == B43_MMIO_PIO1_BASE),
@@ -583,7 +585,7 @@ void b43_pio_rx(struct b43_pioqueue *que
 	skb_put(skb, len);
 	for (i = 0; i < len - 1; i += 2) {
 		tmp = b43_pio_read(queue, B43_PIO_RXDATA);
-		*((u16 *) (skb->data + i)) = cpu_to_le16(tmp);
+		*((__le16 *)(skb->data + i)) = cpu_to_le16(tmp);
 	}
 	if (len % 2) {
 		tmp = b43_pio_read(queue, B43_PIO_RXDATA);
Index: wireless-2.6/drivers/net/wireless/b43/xmit.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/xmit.c	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/xmit.c	2007-10-17 18:19:45.000000000 +0200
@@ -121,10 +121,12 @@ void b43_generate_plcp_hdr(struct b43_pl
 	__u8 *raw = plcp->raw;
 
 	if (b43_is_ofdm_rate(bitrate)) {
-		*data = b43_plcp_get_ratecode_ofdm(bitrate);
+		u32 d;
+
+		d = b43_plcp_get_ratecode_ofdm(bitrate);
 		B43_WARN_ON(octets & 0xF000);
-		*data |= (octets << 5);
-		*data = cpu_to_le32(*data);
+		d |= (octets << 5);
+		*data = cpu_to_le32(d);
 	} else {
 		u32 plen;
 
Index: wireless-2.6/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/main.c	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/main.c	2007-10-17 18:19:45.000000000 +0200
@@ -1045,7 +1045,7 @@ static void handle_irq_noise(struct b43_
 	B43_WARN_ON(!dev->noisecalc.calculation_running);
 	if (dev->noisecalc.channel_at_start != phy->channel)
 		goto drop_calculation;
-	*((u32 *) noise) = cpu_to_le32(b43_jssi_read(dev));
+	*((__le32 *)noise) = cpu_to_le32(b43_jssi_read(dev));
 	if (noise[0] == 0x7F || noise[1] == 0x7F ||
 	    noise[2] == 0x7F || noise[3] == 0x7F)
 		goto generate_new;
@@ -1575,8 +1575,7 @@ static int do_request_fw(struct b43_wlde
 			 const char *name,
 			 const struct firmware **fw)
 {
-	const size_t plen = sizeof(modparam_fwpostfix) + 32;
-	char path[plen];
+	char path[sizeof(modparam_fwpostfix) + 32];
 	struct b43_fw_header *hdr;
 	u32 size;
 	int err;
Index: wireless-2.6/drivers/net/wireless/b43/pcmcia.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/pcmcia.c	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/pcmcia.c	2007-10-17 18:19:45.000000000 +0200
@@ -21,6 +21,8 @@
 
 */
 
+#include "pcmcia.h"
+
 #include <linux/ssb/ssb.h>
 
 #include <pcmcia/cs_types.h>
@@ -30,6 +32,7 @@
 #include <pcmcia/ds.h>
 #include <pcmcia/cisreg.h>
 
+
 static /*const */ struct pcmcia_device_id b43_pcmcia_tbl[] = {
 	PCMCIA_DEVICE_MANF_CARD(0x2D0, 0x448),
 	PCMCIA_DEVICE_NULL,
Index: wireless-2.6/drivers/net/wireless/b43/pio.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/pio.h	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/pio.h	2007-10-17 18:19:45.000000000 +0200
@@ -39,10 +39,9 @@ struct b43_pio_txpacket {
 	struct sk_buff *skb;
 	struct ieee80211_tx_status txstat;
 	struct list_head list;
+	u16 index; /* Index in the tx_packets_cache */
 };
 
-#define pio_txpacket_getindex(packet) ((int)((packet) - (packet)->queue->tx_packets_cache))
-
 struct b43_pioqueue {
 	struct b43_wldev *dev;
 	u16 mmio_base;
Index: wireless-2.6/drivers/net/wireless/b43/debugfs.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/debugfs.c	2007-10-17 18:16:25.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/debugfs.c	2007-10-17 18:19:45.000000000 +0200
@@ -39,7 +39,7 @@
 
 
 /* The root directory. */
-struct dentry *rootdir;
+static struct dentry *rootdir;
 
 struct b43_debugfs_fops {
 	ssize_t (*read)(struct b43_wldev *dev, char *buf, size_t bufsize);
@@ -76,7 +76,8 @@ struct b43_dfs_file * fops_to_dfs_file(s
 
 
 /* wl->irq_lock is locked */
-ssize_t tsf_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t tsf_read_file(struct b43_wldev *dev,
+			     char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	u64 tsf;
@@ -90,7 +91,8 @@ ssize_t tsf_read_file(struct b43_wldev *
 }
 
 /* wl->irq_lock is locked */
-int tsf_write_file(struct b43_wldev *dev, const char *buf, size_t count)
+static int tsf_write_file(struct b43_wldev *dev,
+			  const char *buf, size_t count)
 {
 	u64 tsf;
 
@@ -102,7 +104,8 @@ int tsf_write_file(struct b43_wldev *dev
 }
 
 /* wl->irq_lock is locked */
-ssize_t ucode_regs_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t ucode_regs_read_file(struct b43_wldev *dev,
+				    char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	int i;
@@ -116,7 +119,8 @@ ssize_t ucode_regs_read_file(struct b43_
 }
 
 /* wl->irq_lock is locked */
-ssize_t shm_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t shm_read_file(struct b43_wldev *dev,
+			     char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	int i;
@@ -135,7 +139,8 @@ ssize_t shm_read_file(struct b43_wldev *
 	return count;
 }
 
-ssize_t txstat_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t txstat_read_file(struct b43_wldev *dev,
+				char *buf, size_t bufsize)
 {
 	struct b43_txstatus_log *log = &dev->dfsentry->txstatlog;
 	ssize_t count = 0;
@@ -182,7 +187,8 @@ out_unlock:
 	return count;
 }
 
-ssize_t txpower_g_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t txpower_g_read_file(struct b43_wldev *dev,
+				   char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 
@@ -214,7 +220,8 @@ out:
 	return count;
 }
 
-int txpower_g_write_file(struct b43_wldev *dev, const char *buf, size_t count)
+static int txpower_g_write_file(struct b43_wldev *dev,
+				const char *buf, size_t count)
 {
 	unsigned long phy_flags;
 
@@ -253,7 +260,8 @@ int txpower_g_write_file(struct b43_wlde
 }
 
 /* wl->irq_lock is locked */
-int restart_write_file(struct b43_wldev *dev, const char *buf, size_t count)
+static int restart_write_file(struct b43_wldev *dev,
+			      const char *buf, size_t count)
 {
 	int err = 0;
 
@@ -285,7 +293,8 @@ static ssize_t append_lo_table(ssize_t c
 	return count;
 }
 
-ssize_t loctls_read_file(struct b43_wldev *dev, char *buf, size_t bufsize)
+static ssize_t loctls_read_file(struct b43_wldev *dev,
+				char *buf, size_t bufsize)
 {
 	ssize_t count = 0;
 	struct b43_txpower_lo_control *lo;
@@ -374,6 +383,8 @@ static ssize_t b43_debugfs_read(struct f
 			err = -ENOMEM;
 			goto out_unlock;
 		}
+		/* Sparse warns about the following memset, because it has a big
+		 * size value. That warning is bogus, so I will ignore it. --mb */
 		memset(buf, 0, bufsize);
 		if (dfops->take_irqlock) {
 			spin_lock_irq(&dev->wl->irq_lock);


From mb at bu3sch.de  Wed Oct 17 20:09:02 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 17 Oct 2007 20:09:02 +0200
Subject: [PATCH] b43: Make b43_stop() static
Message-ID: <200710172009.03043.mb@bu3sch.de>

This fixes a sparse warning.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

Index: wireless-2.6/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/main.c	2007-10-17 20:02:21.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/main.c	2007-10-17 20:04:27.000000000 +0200
@@ -3561,7 +3561,7 @@ static int b43_start(struct ieee80211_hw
 	return err;
 }
 
-void b43_stop(struct ieee80211_hw *hw)
+static void b43_stop(struct ieee80211_hw *hw)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
	


From mb at bu3sch.de  Thu Oct 18 15:47:59 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 18 Oct 2007 15:47:59 +0200
Subject: b43 driver & Openwrt
In-Reply-To: <6bc534830710171248q7c883437h49b0dc61ab98bedd@mail.gmail.com>
References: <6bc534830710171248q7c883437h49b0dc61ab98bedd@mail.gmail.com>
Message-ID: <200710181548.00141.mb@bu3sch.de>

On Wednesday 17 October 2007 21:48:35 ????? ??????? wrote:
> Hi!
> 
> I've tried b43 driver on openwrt.
> Device - ASUS WL500-gP (bcm4318)
> 
> lspci -vv output:
> 
> 00:02.0 Network controller: Broadcom Corporation BCM4318 [AirForce One 54g]
> 802.11g Wireless LAN Controller (rev 02)
> Subsystem: ASUSTeK Computer Inc. A6U notebook embedded card
> Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr-
> Stepping- SERR- FastB2B-
> Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort-
> <MAbort- >SERR- <PERR-
> Latency: 64
> Interrupt: pin A routed to IRQ 6
> Region 0: Memory at 40002000 (32-bit, non-prefetchable) [size=8K]
> 
> with these patches
> https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070814/38e5a3de/attachment.ksh&
> https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070814/ca6c6ac2/attachment.kshb43
> doesn't work.
> at boot time there are errors:
> 
> PCI: Device 0000:00:02.0 not available because of resource collisions
> b43-pci-bridge: probe of 0000:00:02.0 failed with error -22


You cannot run the old non-SSB based b44 module together with b43.
You must run b43 and the new SSB based b44 module (that's called version 2).


> (full logs are here: https://dev.openwrt.org/ticket/2521)
> 
> When i try to load b43 module - nothing happens (even no logs). b43 module
> is loading, but no reaction.
>
> I tried to cancel this patch
> https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070814/38e5a3de/attachment.ksh
> And driver loads, and it's even working %)
> 
> PCI: Enabling device 0000:00:02.0 (0000 -> 0002)
> PCI: Fixing up device 0000:00:02.0
> PCI: Setting latency timer of device 0000:00:02.0 to 64
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)
> ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)
> ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)
> ssb: Sonics Silicon Backplane found on PCI device 0000:00:02.0
> b43-phy0: Broadcom 4318 WLAN found
> b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7
> b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
> b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> phy0: Selected rate control algorithm 'simple'
> b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
> b43-phy0 debug: Chip initialized
> b43-phy0 debug: 32-bit DMA initialized
> b43-phy0 debug: Wireless interface started
> b43-phy0 debug: Adding Interface type 1
> 
> Best regards.
> 



-- 
Greetings Michael.


From mb at bu3sch.de  Thu Oct 18 18:38:15 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 18 Oct 2007 18:38:15 +0200
Subject: b43 driver & Openwrt
In-Reply-To: <6bc534830710180923g1fe79d90l7b1818a767c474ce@mail.gmail.com>
References: <6bc534830710171248q7c883437h49b0dc61ab98bedd@mail.gmail.com>
	<200710181548.00141.mb@bu3sch.de>
	<6bc534830710180923g1fe79d90l7b1818a767c474ce@mail.gmail.com>
Message-ID: <200710181838.15709.mb@bu3sch.de>

(Please stay on-list. I won't debug bugs in private anymore.
 Doing this on list tends to result in fixes a _lot_ faster, as
 a lot more people are involved).

On Thursday 18 October 2007 18:23:01 ????? ??????? wrote:
> I've updated b44, but it didn't solve the problem.
> 
> PCI: fixing up bridge
> PCI: Setting latency timer of device 0000:00:00.0 to 64
> PCI: Fixing up device 0000:00:00.0
> PCI: Device 0000:00:02.0 not available because of resource collisions

You must still be loading something twice. Are you loading bcm43xx?

> b43-pci-bridge: probe of 0000:00:02.0 failed with error -22
> Time: MIPS clocksource has been installed.
> NET: Registered protocol family 2
> IP route cache hash table entries: 1024 (order: 0, 4096 bytes)
> TCP established hash table entries: 1024 (order: 1, 8192 bytes)
> TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
> TCP: Hash tables configured (established 1024 bind 1024)
> TCP reno registered
> squashfs: version 3.0 (2006/03/15) Phillip Lougher
> Registering mini_fo version $Id$
> JFFS2 version 2.2. (NAND) (SUMMARY) ?(c) 2001-2006 Red Hat, Inc.
> io scheduler noop registered
> io scheduler deadline registered (default)
> Serial: 8250/16550 driver $Revision: 1.90 $ 2 ports, IRQ sharing enabled
> serial8250: ttyS0 at MMIO 0x0 (irq = 3) is a 16550A
> serial8250: ttyS1 at MMIO 0x0 (irq = 3) is a 16550A
> b44.c:v2.0
> eth0: Broadcom 44xx/47xx 10/100BaseT Ethernet 00:1a:92:bc:d1:88
> eth1: Broadcom 44xx/47xx 10/100BaseT Ethernet 40:10:18:00:00:2d

-- 
Greetings Michael.


From harry.wert at gmail.com  Thu Oct 18 18:58:25 2007
From: harry.wert at gmail.com (Harry Wert)
Date: Thu, 18 Oct 2007 12:58:25 -0400
Subject: Discussion of BCM43xx wireless mini-pc card on an HP Pavillion
	dv9012 series Laptop with Gutsy
Message-ID: <1192726705.10138.8.camel@hp-laptop>

If this is addressed to the wrong Forum, please feel free to forward
same to any other Forum wherein it might be helpful. This commentary is
intended to be of help to others who may be facing similar Wireless
problems. I make no claim for originality.

My HP Pavilion dv9012 series laptop with internal BCM94311MCG wlan
mini-PCI card has worked flawlessly with VISTA, SuSE SLED10, Dapper, and
Fiesty. When I upgraded to Gutsy, downloaded the Restricted Firmware,
and went on-line it worked immediately but Download speeds ran from
20kbs to ~ 60kbs. This, with a DSL broadband line rated and tested for
7Mbs. I communicated with others via this and other Forums, and also did
many Google searches attempting to resolve this problem, but to no
avail. Finally, I was able to locate the cause and corrective action
necessary to restore full 7mbs speeds by means of a systematic debug
process which worked, and is 100% repeatable. My apologies in advance to
the BCM43xx development group who were both helpful, and had the
patience to stick with me, as the problem had nothing to do with the
Firmware.

To isolate the problem Vista was run on this dual-boot laptop, which
also contains Gutsy. The BCM94311MCG wlan mini-PCI performance was
identical to that of Gutsy. Conclusion: could be a defective BCM94311MCG
wlan mini-PCI.

Next I used a Thinkpad Laptop (Dual-boot) running Xp and Fiesty. Results
were identical, low-speed identical to that above, but with Totally
different hardware; ie, it does not use a BCM94311MCG wlan mini-PCI
card. Conclusion: The BCM94311MCG wlan mini-PCI card and the firmware
for same is not the problem.

Next step was to disconnect my internal Linksys router from my internal
Network, then connect directly to my DSL Modem via Ethernet cable to the
HP Laptop. Result was full DSL 7Mbs speed. Conclusion: problem must be
associated with the Linksys wireless "B" Broadband router. The Internal
Network could not be the problem as it was previously checked for up to
100Mbs transfer rates.

The Linksys router was next tested by bypassing the wireless part and
connected to the Laptop via Ethernet cable. Result: Full DSL 7Mbs
performance. Back to square One!

To finally isolate where the Linksys problem was, everything was
reconnected to it's initial state, rebooted and speed retested. It was
unchanged at 20kbs to ~ 60kbs data rate. Using a wired connection to the
Linksys router was still a full 7Mbs rate.  Conclusion: The Linksys
router in the wireless mode is clearly the problem.

Finally,  the Linksys router was given a Full reset. The procedure to
setup from scratch was followed to completion by re-entering all the
necessary information as necessary for operation with the DSL modem.
Result: Problem solved. Full wireless operation with my HP Pavilion
dv9012 and the BCM94311MCG wlan mini-PCI, now produces the identical
7Mbs data rate as the DSL Modem itself.

How the Linksys Router lost it's mind is unknown, as it is on an active
UPS system. 

Sorry for the long-winded update, but systematic thought processes are a
necessary attribute for a Physicist! After nearly two weeks of
intermittent investigation I felt compelled to tell someone!

Thanks to all...

Harry Wert
Physicist






From artem.v.antonov at gmail.com  Thu Oct 18 19:31:43 2007
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Thu, 18 Oct 2007 21:31:43 +0400
Subject: Fwd: b43 driver & Openwrt
In-Reply-To: <6bc534830710181023p2784e2ep55f9a64e39209973@mail.gmail.com>
References: <6bc534830710171248q7c883437h49b0dc61ab98bedd@mail.gmail.com>
	<200710181548.00141.mb@bu3sch.de>
	<6bc534830710180923g1fe79d90l7b1818a767c474ce@mail.gmail.com>
	<200710181838.15709.mb@bu3sch.de>
	<6bc534830710181023p2784e2ep55f9a64e39209973@mail.gmail.com>
Message-ID: <6bc534830710181031m5afc3753oe5501a6add7f96e8@mail.gmail.com>

No. There is no bcm43xx.
And with new b44 driver b43 doesn't work, if cancel this patch
https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070814/38e5a3de/attachment.ksh
.
There is segmentation fault on loading b43 module and I can't see logs, why
it happens - because the router restarts.

---------- Forwarded message ----------
> I've updated b44, but it didn't solve the problem.
>
> PCI: fixing up bridge
> PCI: Setting latency timer of device 0000:00:00.0 to 64
> PCI: Fixing up device 0000:00: 00.0
> PCI: Device 0000:00:02.0 not available because of resource collisions

You must still be loading something twice. Are you loading bcm43xx?

> b43-pci-bridge: probe of 0000:00:02.0 failed with error -22
> Time: MIPS clocksource has been installed.
> NET: Registered protocol family 2
> IP route cache hash table entries: 1024 (order: 0, 4096 bytes)
> TCP established hash table entries: 1024 (order: 1, 8192 bytes)
> TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
> TCP: Hash tables configured (established 1024 bind 1024)
> TCP reno registered
> squashfs: version 3.0 (2006/03/15) Phillip Lougher
> Registering mini_fo version $Id$
> JFFS2 version 2.2. (NAND) (SUMMARY) ?(c) 2001-2006 Red Hat, Inc.
> io scheduler noop registered
> io scheduler deadline registered (default)
> Serial: 8250/16550 driver $Revision: 1.90 $ 2 ports, IRQ sharing enabled
> serial8250: ttyS0 at MMIO 0x0 (irq = 3) is a 16550A
> serial8250: ttyS1 at MMIO 0x0 (irq = 3) is a 16550A
> b44.c:v2.0
> eth0: Broadcom 44xx/47xx 10/100BaseT Ethernet 00:1a:92:bc:d1:88
> eth1: Broadcom 44xx/47xx 10/100BaseT Ethernet 40:10:18:00:00:2d
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071018/dea9e80f/attachment.html>

From larry.finger at lwfinger.net  Thu Oct 18 19:41:31 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Oct 2007 12:41:31 -0500
Subject: Discussion of BCM43xx wireless mini-pc card on an HP Pavillion
	dv9012 series Laptop with Gutsy
In-Reply-To: <1192726705.10138.8.camel@hp-laptop>
References: <1192726705.10138.8.camel@hp-laptop>
Message-ID: <47179ACB.6090801@lwfinger.net>

Harry Wert wrote:
> If this is addressed to the wrong Forum, please feel free to forward
> same to any other Forum wherein it might be helpful. This commentary is
> intended to be of help to others who may be facing similar Wireless
> problems. I make no claim for originality.
> 
> My HP Pavilion dv9012 series laptop with internal BCM94311MCG wlan
> mini-PCI card has worked flawlessly with VISTA, SuSE SLED10, Dapper, and
> Fiesty. When I upgraded to Gutsy, downloaded the Restricted Firmware,
> and went on-line it worked immediately but Download speeds ran from
> 20kbs to ~ 60kbs. This, with a DSL broadband line rated and tested for
> 7Mbs. I communicated with others via this and other Forums, and also did
> many Google searches attempting to resolve this problem, but to no
> avail. Finally, I was able to locate the cause and corrective action
> necessary to restore full 7mbs speeds by means of a systematic debug
> process which worked, and is 100% repeatable. My apologies in advance to
> the BCM43xx development group who were both helpful, and had the
> patience to stick with me, as the problem had nothing to do with the
> Firmware.
> 
> To isolate the problem Vista was run on this dual-boot laptop, which
> also contains Gutsy. The BCM94311MCG wlan mini-PCI performance was
> identical to that of Gutsy. Conclusion: could be a defective BCM94311MCG
> wlan mini-PCI.
> 
> Next I used a Thinkpad Laptop (Dual-boot) running Xp and Fiesty. Results
> were identical, low-speed identical to that above, but with Totally
> different hardware; ie, it does not use a BCM94311MCG wlan mini-PCI
> card. Conclusion: The BCM94311MCG wlan mini-PCI card and the firmware
> for same is not the problem.
> 
> Next step was to disconnect my internal Linksys router from my internal
> Network, then connect directly to my DSL Modem via Ethernet cable to the
> HP Laptop. Result was full DSL 7Mbs speed. Conclusion: problem must be
> associated with the Linksys wireless "B" Broadband router. The Internal
> Network could not be the problem as it was previously checked for up to
> 100Mbs transfer rates.
> 
> The Linksys router was next tested by bypassing the wireless part and
> connected to the Laptop via Ethernet cable. Result: Full DSL 7Mbs
> performance. Back to square One!
> 
> To finally isolate where the Linksys problem was, everything was
> reconnected to it's initial state, rebooted and speed retested. It was
> unchanged at 20kbs to ~ 60kbs data rate. Using a wired connection to the
> Linksys router was still a full 7Mbs rate.  Conclusion: The Linksys
> router in the wireless mode is clearly the problem.
> 
> Finally,  the Linksys router was given a Full reset. The procedure to
> setup from scratch was followed to completion by re-entering all the
> necessary information as necessary for operation with the DSL modem.
> Result: Problem solved. Full wireless operation with my HP Pavilion
> dv9012 and the BCM94311MCG wlan mini-PCI, now produces the identical
> 7Mbs data rate as the DSL Modem itself.
> 
> How the Linksys Router lost it's mind is unknown, as it is on an active
> UPS system. 
> 
> Sorry for the long-winded update, but systematic thought processes are a
> necessary attribute for a Physicist! After nearly two weeks of
> intermittent investigation I felt compelled to tell someone!

You did a good job of analyzing the problem. As a retired physicist and a former reviewer for Phys.
Rev., I have to ask "What was the model and version of the Linksys wireless router?"

These consumer-grade access points sometimes lose their minds for no reason. Usually a reboot or
reset is all that is needed, but I have one Linksys BEW11S4 Ver. 4 that would not connect at all. It
started working when the firmware was reflashed. The strange part is that the "new" version was
identical to the "old" one.

Larry


From gavron at wetwork.net  Thu Oct 18 21:18:55 2007
From: gavron at wetwork.net (Ehud Gavron)
Date: Thu, 18 Oct 2007 12:18:55 -0700
Subject: Discussion of BCM43xx wireless mini-pc card on an HP Pavillion
	dv9012 series Laptop with Gutsy
In-Reply-To: <47179ACB.6090801@lwfinger.net>
References: <1192726705.10138.8.camel@hp-laptop>
	<47179ACB.6090801@lwfinger.net>
Message-ID: <4717B19F.9060309@wetwork.net>

As the son of a physicist and someone who appreciates GOOD DOCUMENTATION 
OF A PROBLEM AND SOLUTION I have to echo Larry's kudos.  This was a 
well-documented analytical approach to solving the problem.  Undoubtedly 
since the world is not perfect and we must deal with $40 APs we'll all 
see this at some point or another :)

Thanks!

Ehud

Larry Finger wrote:
> Harry Wert wrote:
>   
>> If this is addressed to the wrong Forum, please feel free to forward
>> same to any other Forum wherein it might be helpful. This commentary is
>> intended to be of help to others who may be facing similar Wireless
>> problems. I make no claim for originality.
>>
>> My HP Pavilion dv9012 series laptop with internal BCM94311MCG wlan
>> mini-PCI card has worked flawlessly with VISTA, SuSE SLED10, Dapper, and
>> Fiesty. When I upgraded to Gutsy, downloaded the Restricted Firmware,
>> and went on-line it worked immediately but Download speeds ran from
>> 20kbs to ~ 60kbs. This, with a DSL broadband line rated and tested for
>> 7Mbs. I communicated with others via this and other Forums, and also did
>> many Google searches attempting to resolve this problem, but to no
>> avail. Finally, I was able to locate the cause and corrective action
>> necessary to restore full 7mbs speeds by means of a systematic debug
>> process which worked, and is 100% repeatable. My apologies in advance to
>> the BCM43xx development group who were both helpful, and had the
>> patience to stick with me, as the problem had nothing to do with the
>> Firmware.
>>
>> To isolate the problem Vista was run on this dual-boot laptop, which
>> also contains Gutsy. The BCM94311MCG wlan mini-PCI performance was
>> identical to that of Gutsy. Conclusion: could be a defective BCM94311MCG
>> wlan mini-PCI.
>>
>> Next I used a Thinkpad Laptop (Dual-boot) running Xp and Fiesty. Results
>> were identical, low-speed identical to that above, but with Totally
>> different hardware; ie, it does not use a BCM94311MCG wlan mini-PCI
>> card. Conclusion: The BCM94311MCG wlan mini-PCI card and the firmware
>> for same is not the problem.
>>
>> Next step was to disconnect my internal Linksys router from my internal
>> Network, then connect directly to my DSL Modem via Ethernet cable to the
>> HP Laptop. Result was full DSL 7Mbs speed. Conclusion: problem must be
>> associated with the Linksys wireless "B" Broadband router. The Internal
>> Network could not be the problem as it was previously checked for up to
>> 100Mbs transfer rates.
>>
>> The Linksys router was next tested by bypassing the wireless part and
>> connected to the Laptop via Ethernet cable. Result: Full DSL 7Mbs
>> performance. Back to square One!
>>
>> To finally isolate where the Linksys problem was, everything was
>> reconnected to it's initial state, rebooted and speed retested. It was
>> unchanged at 20kbs to ~ 60kbs data rate. Using a wired connection to the
>> Linksys router was still a full 7Mbs rate.  Conclusion: The Linksys
>> router in the wireless mode is clearly the problem.
>>
>> Finally,  the Linksys router was given a Full reset. The procedure to
>> setup from scratch was followed to completion by re-entering all the
>> necessary information as necessary for operation with the DSL modem.
>> Result: Problem solved. Full wireless operation with my HP Pavilion
>> dv9012 and the BCM94311MCG wlan mini-PCI, now produces the identical
>> 7Mbs data rate as the DSL Modem itself.
>>
>> How the Linksys Router lost it's mind is unknown, as it is on an active
>> UPS system. 
>>
>> Sorry for the long-winded update, but systematic thought processes are a
>> necessary attribute for a Physicist! After nearly two weeks of
>> intermittent investigation I felt compelled to tell someone!
>>     
>
> You did a good job of analyzing the problem. As a retired physicist and a former reviewer for Phys.
> Rev., I have to ask "What was the model and version of the Linksys wireless router?"
>
> These consumer-grade access points sometimes lose their minds for no reason. Usually a reboot or
> reset is all that is needed, but I have one Linksys BEW11S4 Ver. 4 that would not connect at all. It
> started working when the firmware was reflashed. The strange part is that the "new" version was
> identical to the "old" one.
>
> Larry
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071018/e9401168/attachment.bin>

From johannes at sipsolutions.net  Thu Oct 18 21:27:06 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 18 Oct 2007 21:27:06 +0200
Subject: Discussion of BCM43xx wireless mini-pc card on an HP Pavillion
	dv9012 series Laptop with Gutsy
In-Reply-To: <47179ACB.6090801@lwfinger.net>
	(sfid-20071018_184218_035018_B4F6806F)
References: <1192726705.10138.8.camel@hp-laptop>
	<47179ACB.6090801@lwfinger.net> (sfid-20071018_184218_035018_B4F6806F)
Message-ID: <1192735626.15285.45.camel@johannes.berg>

On Thu, 2007-10-18 at 12:41 -0500, Larry Finger wrote:

[snipped long analysis]

> You did a good job of analyzing the problem. 

Yeah, good job. Thanks.

> As a retired physicist and a former reviewer for Phys.
> Rev., I have to ask "What was the model and version of the Linksys wireless router?"

Heh.

> These consumer-grade access points sometimes lose their minds for no reason. Usually a reboot or
> reset is all that is needed, but I have one Linksys BEW11S4 Ver. 4 that would not connect at all. It
> started working when the firmware was reflashed. The strange part is that the "new" version was
> identical to the "old" one.

FWIW, I've had it happen twice to me now that even routers running on
openwrt lost their mind, in my case their NVRAM settings. This is why
the "kamikaze" version of openwrt will now no longer use the NVRAM to
store settings but rather stores settings in config files.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071018/bd3ad1b3/attachment.pgp>

From linville at tuxdriver.com  Thu Oct 18 21:53:22 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Thu, 18 Oct 2007 15:53:22 -0400
Subject: [PATCH #3] b43: Fix sparse warnings.
In-Reply-To: <200710171834.03495.mb@bu3sch.de>
References: <200710171834.03495.mb@bu3sch.de>
Message-ID: <20071018195322.GD8510@tuxdriver.com>

On Wed, Oct 17, 2007 at 06:34:03PM +0200, Michael Buesch wrote:
> The remaining warning in phy.c will be fixed later.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> 
> ---
> 
> John, this is the third time I submit this.
> Is something wrong with this patch or did you simply forget to apply it?

Where are you looking?  It is in Linus' tree.

	http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=1a09404a2338163f181d170c7abdc2242b6c6f03

John
-- 
John W. Linville
linville at tuxdriver.com


From artem.v.antonov at gmail.com  Fri Oct 19 11:55:05 2007
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Fri, 19 Oct 2007 13:55:05 +0400
Subject: b43 driver & Openwrt
In-Reply-To: <6bc534830710181031m5afc3753oe5501a6add7f96e8@mail.gmail.com>
References: <6bc534830710171248q7c883437h49b0dc61ab98bedd@mail.gmail.com>
	<200710181548.00141.mb@bu3sch.de>
	<6bc534830710180923g1fe79d90l7b1818a767c474ce@mail.gmail.com>
	<200710181838.15709.mb@bu3sch.de>
	<6bc534830710181023p2784e2ep55f9a64e39209973@mail.gmail.com>
	<6bc534830710181031m5afc3753oe5501a6add7f96e8@mail.gmail.com>
Message-ID: <6bc534830710190255y1520841er5eb1651c1a4e5755@mail.gmail.com>

Making b43_pci_bridge as module and compiling it in kernel
solves this problem.
But there is still problem with b44 v2.0 - the router doesn't boot with
these changes.
With b44 v1.0 + ssb support
patch for it from openwrt everything seems working ok.

2007/10/18, Artem Antonov <artem.v.antonov at gmail.com>:
>
>
> No. There is no bcm43xx.
> And with new b44 driver b43 doesn't work, if cancel this patch https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070814/38e5a3de/attachment.ksh
> .
> There is segmentation fault on loading b43 module and I can't see logs,
> why it happens - because the router restarts.
>
> ---------- Forwarded message ----------
> > I've updated b44, but it didn't solve the problem.
> >
> > PCI: fixing up bridge
> > PCI: Setting latency timer of device 0000:00: 00.0 to 64
> > PCI: Fixing up device 0000:00: 00.0
> > PCI: Device 0000:00:02.0 not available because of resource collisions
>
> You must still be loading something twice. Are you loading bcm43xx?
>
> > b43-pci-bridge: probe of 0000:00: 02.0 failed with error -22
> > Time: MIPS clocksource has been installed.
> > NET: Registered protocol family 2
> > IP route cache hash table entries: 1024 (order: 0, 4096 bytes)
> > TCP established hash table entries: 1024 (order: 1, 8192 bytes)
> > TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
> > TCP: Hash tables configured (established 1024 bind 1024)
> > TCP reno registered
> > squashfs: version 3.0 (2006/03/15) Phillip Lougher
> > Registering mini_fo version $Id$
> > JFFS2 version 2.2. (NAND) (SUMMARY) ?(c) 2001-2006 Red Hat, Inc.
> > io scheduler noop registered
> > io scheduler deadline registered (default)
> > Serial: 8250/16550 driver $Revision: 1.90 $ 2 ports, IRQ sharing enabled
> > serial8250: ttyS0 at MMIO 0x0 (irq = 3) is a 16550A
> > serial8250: ttyS1 at MMIO 0x0 (irq = 3) is a 16550A
> > b44.c:v2.0
> > eth0: Broadcom 44xx/47xx 10/100BaseT Ethernet 00:1a:92:bc:d1:88
> > eth1: Broadcom 44xx/47xx 10/100BaseT Ethernet 40:10:18:00:00:2d
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071019/1817e797/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ssb.diff
Type: application/octet-stream
Size: 2737 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071019/1817e797/attachment.obj>

From mb at bu3sch.de  Fri Oct 19 15:47:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 19 Oct 2007 15:47:13 +0200
Subject: [PATCH #3] b43: Fix sparse warnings.
In-Reply-To: <20071018195322.GD8510@tuxdriver.com>
References: <200710171834.03495.mb@bu3sch.de>
	<20071018195322.GD8510@tuxdriver.com>
Message-ID: <200710191547.13533.mb@bu3sch.de>

On Thursday 18 October 2007 21:53:22 John W. Linville wrote:
> On Wed, Oct 17, 2007 at 06:34:03PM +0200, Michael Buesch wrote:
> > The remaining warning in phy.c will be fixed later.
> > 
> > Signed-off-by: Michael Buesch <mb at bu3sch.de>
> > 
> > ---
> > 
> > John, this is the third time I submit this.
> > Is something wrong with this patch or did you simply forget to apply it?
> 
> Where are you looking?  It is in Linus' tree.
> 
> 	http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=1a09404a2338163f181d170c7abdc2242b6c6f03
> 
> John

Uhm, it still applies to wireless-2.6#everything.

-- 
Greetings Michael.


From linville at tuxdriver.com  Fri Oct 19 16:22:05 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 19 Oct 2007 10:22:05 -0400
Subject: [PATCH #3] b43: Fix sparse warnings.
In-Reply-To: <200710191547.13533.mb@bu3sch.de>
References: <200710171834.03495.mb@bu3sch.de>
	<20071018195322.GD8510@tuxdriver.com>
	<200710191547.13533.mb@bu3sch.de>
Message-ID: <20071019142205.GA2920@tuxdriver.com>

On Fri, Oct 19, 2007 at 03:47:13PM +0200, Michael Buesch wrote:
> On Thursday 18 October 2007 21:53:22 John W. Linville wrote:
> > On Wed, Oct 17, 2007 at 06:34:03PM +0200, Michael Buesch wrote:
> > > The remaining warning in phy.c will be fixed later.
> > > 
> > > Signed-off-by: Michael Buesch <mb at bu3sch.de>
> > > 
> > > ---
> > > 
> > > John, this is the third time I submit this.
> > > Is something wrong with this patch or did you simply forget to apply it?
> > 
> > Where are you looking?  It is in Linus' tree.
> > 
> > 	http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=1a09404a2338163f181d170c7abdc2242b6c6f03
> > 
> > John
> 
> Uhm, it still applies to wireless-2.6#everything.

I imagine that it won't when that gets rebased, probably after
2.6.24-rc1. :-)

Seriously, either I must have neglected to add it to everything and
merged-upstream.  I'll look into it.  The important thing is that
Linus has it.

John
-- 
John W. Linville
linville at tuxdriver.com


From Larry.Finger at lwfinger.net  Fri Oct 19 19:41:21 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Oct 2007 12:41:21 -0500
Subject: 2.6.24 patches for b43legacy
Message-ID: <4718EC41.9060801@lwfinger.net>

John,

Are the following patches queued for Linus's tree?

"[PATCH V2] b43legacy: LED triggers support" - sent 10/12/07
"[PATCH] b43legacy: RF-kill support"	     - sent 10/10/07
"[PATCH] b43legacy: Use input-polldev for the rfkill switch" - sent 10/10/07
"[PATCH] b43legacy: Rewrite pwork locking" - sent 10/10/07
"[PATCH] b43legacy: Fix potential return of uninitialized variable" - sent 10/14/07
"[PATCH] b43legacy: Fix namespace pollution and sparse warnings" - sent 10/17/07

Thanks,

Larry



From linville at tuxdriver.com  Fri Oct 19 20:09:22 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 19 Oct 2007 14:09:22 -0400
Subject: 2.6.24 patches for b43legacy
In-Reply-To: <4718EC41.9060801@lwfinger.net>
References: <4718EC41.9060801@lwfinger.net>
Message-ID: <20071019180922.GE2920@tuxdriver.com>

On Fri, Oct 19, 2007 at 12:41:21PM -0500, Larry Finger wrote:

> Are the following patches queued for Linus's tree?
> 
> "[PATCH V2] b43legacy: LED triggers support" - sent 10/12/07
> "[PATCH] b43legacy: RF-kill support"	     - sent 10/10/07
> "[PATCH] b43legacy: Use input-polldev for the rfkill switch" - sent 10/10/07
> "[PATCH] b43legacy: Rewrite pwork locking" - sent 10/10/07
> "[PATCH] b43legacy: Fix potential return of uninitialized variable" - sent 10/14/07
> "[PATCH] b43legacy: Fix namespace pollution and sparse warnings" - sent 10/17/07

I have them all, but they did not make the cut-off for 2.6.24.
I sent the next-to-last one to Jeff last night as a "fix".  The rest
will be sent to Jeff after 2.6.24-rc1 is released, in anticipation of
inclusion into 2.6.25.

Thanks,

John
-- 
John W. Linville
linville at tuxdriver.com


From dangogh at gmail.com  Sat Oct 20 01:50:23 2007
From: dangogh at gmail.com (Dan Kirkwood)
Date: Fri, 19 Oct 2007 17:50:23 -0600
Subject: donation of a card?
Message-ID: <308c384b0710191650p1e750a9ep18549c8b5d527a88@mail.gmail.com>

I really appreciate the hard work on getting the broadcom cards to
work,  but I've run short of time trying to deal with mine:  I ended
up replacing it with an atheros-based card.  Any interest in taking
the old one?    It's a Dell TrueMobile 1300 (bcm4306 rev 02).  I'd be
happy to send it along if it's helpful to the project...  -dan


From zajec5polish at gmail.com  Sat Oct 20 11:55:25 2007
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Sat, 20 Oct 2007 11:55:25 +0200
Subject: Status of support for some chips
In-Reply-To: <4716158E.7010501@lwfinger.net>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>
	<4716158E.7010501@lwfinger.net>
Message-ID: <14b026160710200255r756064a2s84fb36c3545d9646@mail.gmail.com>

2007/10/17, Larry Finger <larry.finger at lwfinger.net>:
> Rafa? Mi?ecki wrote:
> > Hi,
> >
> > I wonder if page http://bcm43xx.berlios.de/?go=devices is really up to
> > date? I think 4318 is supported quite nice in kernel 2.6.22.
> >
> > Could someone update this list of supported chips?
> >
>
> This patch will update this page.

May we send this to sb with access to page on berlios? Does anyone
have email of such a person?

-- 
Rafa? Mi?ecki

From larry.finger at lwfinger.net  Sat Oct 20 15:27:28 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 20 Oct 2007 08:27:28 -0500
Subject: Status of support for some chips
In-Reply-To: <14b026160710200255r756064a2s84fb36c3545d9646@mail.gmail.com>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>	<4716158E.7010501@lwfinger.net>
	<14b026160710200255r756064a2s84fb36c3545d9646@mail.gmail.com>
Message-ID: <471A0240.1070507@lwfinger.net>

Rafa? Mi?ecki wrote:
> 2007/10/17, Larry Finger <larry.finger at lwfinger.net>:
>> Rafa? Mi?ecki wrote:
>>> Hi,
>>>
>>> I wonder if page http://bcm43xx.berlios.de/?go=devices is really up to
>>> date? I think 4318 is supported quite nice in kernel 2.6.22.
>>>
>>> Could someone update this list of supported chips?
>>>
>> This patch will update this page.
> 
> May we send this to sb with access to page on berlios? Does anyone
> have email of such a person?

I think Johannes Berg and Joe Jezak have write privilege there. There are probably others as well.

Larry


From larry.finger at lwfinger.net  Mon Oct 22 00:27:20 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 21 Oct 2007 17:27:20 -0500
Subject: Status of support for some chips
In-Reply-To: <b5f97810710210401n3f608969r73c43961194761a9@mail.gmail.com>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>	
	<4716158E.7010501@lwfinger.net>	
	<14b026160710200255r756064a2s84fb36c3545d9646@mail.gmail.com>	
	<471A0240.1070507@lwfinger.net>
	<b5f97810710210401n3f608969r73c43961194761a9@mail.gmail.com>
Message-ID: <471BD248.6020509@lwfinger.net>

Simon M. wrote:
> Hi,
> 
>> Rafa? Mi?ecki wrote:
>> I wonder if page http://bcm43xx.berlios.de/?go=devices is really up to
>> date? I think 4318 is supported quite nice in kernel 2.6.22.
> 
> Does this mean that the bcm4318 card is working with the full 45mbits
> speed now and that the poor range issues are solved now?
> I am also interested if WPA is fully functional (EAP and
> ca-certificate with wpa_supplicant)

I no longer have 2.6.22 running on the laptop where I can run my 4318; however, the current wireless
2.6 git tree, which uses b43 as the driver, gets a transmit rate of 10.6 Mbs and a receive rate of
16.6 Mbs, when the interface rate is set to 54 Mbs with iwconfig. These rates are measured with
iperf at a distance of 2 m between the laptop and the AP, and using WPA-PSK encryption.

All WPA encryption/decryption is done in software for bcm43xx, b43, and b43legacy drivers. If your
copy of wpa_supplicant and associated software can handle EAP and ca-certificate, then the driver
will work with that scheme.

Larry


From mb at bu3sch.de  Mon Oct 22 02:47:25 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Oct 2007 02:47:25 +0200
Subject: Status of support for some chips
In-Reply-To: <471BD248.6020509@lwfinger.net>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>
	<b5f97810710210401n3f608969r73c43961194761a9@mail.gmail.com>
	<471BD248.6020509@lwfinger.net>
Message-ID: <200710220247.25643.mb@bu3sch.de>

On Monday 22 October 2007 00:27:20 Larry Finger wrote:
> All WPA encryption/decryption is done in software for bcm43xx, b43, and b43legacy drivers.

b43 will do everything but tkip in hardware.


-- 
Greetings Michael.


From johannes at sipsolutions.net  Mon Oct 22 10:18:11 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 22 Oct 2007 10:18:11 +0200
Subject: Status of support for some chips
In-Reply-To: <471A0240.1070507@lwfinger.net>
References: <14b026160710170425x6a2c3778nf99fbf1505c4b6af@mail.gmail.com>
	<4716158E.7010501@lwfinger.net>
	<14b026160710200255r756064a2s84fb36c3545d9646@mail.gmail.com>
	<471A0240.1070507@lwfinger.net>
Message-ID: <1193041091.4167.9.camel@johannes.berg>

On Sat, 2007-10-20 at 08:27 -0500, Larry Finger wrote:

> > May we send this to sb with access to page on berlios? Does anyone
> > have email of such a person?
> 
> I think Johannes Berg and Joe Jezak have write privilege there. There are probably others as well.

Neither of us do, I'm afraid, but Stefano does IIRC.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071022/dae9379f/attachment.pgp>

From Larry.Finger at lwfinger.net  Tue Oct 23 05:02:51 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 22 Oct 2007 22:02:51 -0500
Subject: Resigning as maintainer
Message-ID: <471D645B.8000302@lwfinger.net>


Remove Larry Finger as maintainer of bcm43xx and b43legacy.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

Attached is a patch removing my name as maintainer of bcm43xx and b43legacy. For at least 3 months
this winter, I will not have a broadband connection and it will be impossible for me to update my
kernel source during that time.

I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
and b43legacy are already better than any SoftMAC driver will ever be.

I will attempt to find a replacement b43legacy maintainer, and will continue to port any b43 patches
to b43legacy until a replacement is found or until the end of November.

Thanks for helping me and putting up with me. It has been great fun.

Larry
---

Index: wireless-2.6/MAINTAINERS
===================================================================
--- wireless-2.6.orig/MAINTAINERS
+++ wireless-2.6/MAINTAINERS
@@ -822,20 +822,14 @@ W:	http://bcm43xx.berlios.de/
 S:	Maintained

 B43LEGACY WIRELESS DRIVER
-P:	Larry Finger
-M:	Larry.Finger at lwfinger.net
 L:	linux-wireless at vger.kernel.org
 W:	http://bcm43xx.berlios.de/
-S:	Maintained
+S:	Orphaned

 BCM43XX WIRELESS DRIVER (SOFTMAC BASED VERSION)
-P:	Larry Finger
-M:	Larry.Finger at lwfinger.net
-P:	Stefano Brivio
-M:	st3 at riseup.net
 L:	linux-wireless at vger.kernel.org
 W:	http://bcm43xx.berlios.de/
-S:	Maintained
+S:	Orphaned

 BEFS FILE SYSTEM
 P:	Sergey S. Kostyliov



From Larry.Finger at lwfinger.net  Tue Oct 23 06:03:53 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 22 Oct 2007 23:03:53 -0500
Subject: b43legacy maintainer needed
Message-ID: <471D72A9.9060208@lwfinger.net>

As you have seen in a previous E-mail, I have resigned as maintainer of bcm43xx and b43legacy. No
replacement will be needed for bcm43xx as it will not be in the kernel much longer.

The effort required to maintain b43legacy should be minimal. For the past several months, most of
what I have done is take b43 patches written by Michael Buesch and port them to b43legacy.

Besides the obvious programming experience, the maintainer should have a BCM4306/2 card. If you have
a laptop with a PCMCIA slot, I have an extra Linksys WPC54G with that chip that you could have.

If you are interested, please write to me.

Thanks,

Larry




From solca at guug.org  Tue Oct 23 06:15:58 2007
From: solca at guug.org (Otto Solares)
Date: Mon, 22 Oct 2007 22:15:58 -0600
Subject: Resigning as maintainer
In-Reply-To: <471D645B.8000302@lwfinger.net>
References: <471D645B.8000302@lwfinger.net>
Message-ID: <20071023041558.GA28394@guug.org>

I would like to thank your great effort on coding, testing and giving
support to other people.  In name of all who you help: Thank you!

-otto

PS. Hopefully you can reconsider...

On Mon, Oct 22, 2007 at 10:02:51PM -0500, Larry Finger wrote:
> 
> Remove Larry Finger as maintainer of bcm43xx and b43legacy.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> Attached is a patch removing my name as maintainer of bcm43xx and b43legacy. For at least 3 months
> this winter, I will not have a broadband connection and it will be impossible for me to update my
> kernel source during that time.
> 
> I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
> and b43legacy are already better than any SoftMAC driver will ever be.
> 
> I will attempt to find a replacement b43legacy maintainer, and will continue to port any b43 patches
> to b43legacy until a replacement is found or until the end of November.
> 
> Thanks for helping me and putting up with me. It has been great fun.
> 
> Larry
> ---
> 
> Index: wireless-2.6/MAINTAINERS
> ===================================================================
> --- wireless-2.6.orig/MAINTAINERS
> +++ wireless-2.6/MAINTAINERS
> @@ -822,20 +822,14 @@ W:	http://bcm43xx.berlios.de/
>  S:	Maintained
> 
>  B43LEGACY WIRELESS DRIVER
> -P:	Larry Finger
> -M:	Larry.Finger at lwfinger.net
>  L:	linux-wireless at vger.kernel.org
>  W:	http://bcm43xx.berlios.de/
> -S:	Maintained
> +S:	Orphaned
> 
>  BCM43XX WIRELESS DRIVER (SOFTMAC BASED VERSION)
> -P:	Larry Finger
> -M:	Larry.Finger at lwfinger.net
> -P:	Stefano Brivio
> -M:	st3 at riseup.net
>  L:	linux-wireless at vger.kernel.org
>  W:	http://bcm43xx.berlios.de/
> -S:	Maintained
> +S:	Orphaned
> 
>  BEFS FILE SYSTEM
>  P:	Sergey S. Kostyliov
> 
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev


From carenas at sajinet.com.pe  Tue Oct 23 07:50:48 2007
From: carenas at sajinet.com.pe (Carlo Marcelo Arenas Belon)
Date: Tue, 23 Oct 2007 00:50:48 -0500
Subject: Resigning as maintainer
In-Reply-To: <471D645B.8000302@lwfinger.net>
References: <471D645B.8000302@lwfinger.net>
Message-ID: <20071023055048.GA30472@tapir>

On Mon, Oct 22, 2007 at 10:02:51PM -0500, Larry Finger wrote:
> I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
> and b43legacy are already better than any SoftMAC driver will ever be.

b43 and b43legacy had never been in the main tree though (until the current
merge for 2.6.24), and considering that the current stable kernel (2.6.23) has
only bcm43xx I am afraid this might be too optimistic.

I'll be really surprised to find I am the only one that is still using bcm43xx
with a bcm4306 card in a 2.6.22 kernel.

Carlo


From larry.finger at lwfinger.net  Tue Oct 23 16:21:33 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Oct 2007 09:21:33 -0500
Subject: Resigning as maintainer
In-Reply-To: <20071023055048.GA30472@tapir>
References: <471D645B.8000302@lwfinger.net> <20071023055048.GA30472@tapir>
Message-ID: <471E036D.3050101@lwfinger.net>

Carlo Marcelo Arenas Belon wrote:
> On Mon, Oct 22, 2007 at 10:02:51PM -0500, Larry Finger wrote:
>> I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
>> and b43legacy are already better than any SoftMAC driver will ever be.
> 
> b43 and b43legacy had never been in the main tree though (until the current
> merge for 2.6.24), and considering that the current stable kernel (2.6.23) has
> only bcm43xx I am afraid this might be too optimistic.
> 
> I'll be really surprised to find I am the only one that is still using bcm43xx
> with a bcm4306 card in a 2.6.22 kernel.

Of course you are not the only one using bcm43xx; however, when you make the switch to b43 you will
be very happy with the improved stability, particularly in a crowded environment. SoftMAC is very
easily confused when there is a lot of traffic, which requires unloading/reloading the driver, or a
reboot. I could force this by doing an ssh login to my second machine and doing a git pull with both
computers on the same AP. With mac80211, this configuration works perfectly.

Larry


From danfis at danfis.cz  Tue Oct 23 22:12:01 2007
From: danfis at danfis.cz (Daniel Fiser)
Date: Tue, 23 Oct 2007 22:12:01 +0200
Subject: Installation of b43
In-Reply-To: <20071023200246.GA12986@lemmy.chello.upc.cz>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
Message-ID: <20071023201201.GA19550@lemmy.chello.upc.cz>

Hi everybody,
please, could someone instruct me, how to install b43 driver for my
broadcom bcm4318 device?  I have found at linuxwireless.org that my device
is supported by b43 driver and I was glad of it, because I needn't to use
ndiswrapper, but I haven't found how to install this driver. 
Please, could someone help me?

Secondly, I would like to offer my assistance on this project. I am
able to write C code or I can help any other way

Thanks,
  Dan 



From mb at bu3sch.de  Tue Oct 23 22:51:58 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 23 Oct 2007 22:51:58 +0200
Subject: Installation of b43
In-Reply-To: <20071023201201.GA19550@lemmy.chello.upc.cz>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
	<20071023201201.GA19550@lemmy.chello.upc.cz>
Message-ID: <200710232251.58702.mb@bu3sch.de>

On Tuesday 23 October 2007 22:12:01 Daniel Fiser wrote:
> Hi everybody,
> please, could someone instruct me, how to install b43 driver for my
> broadcom bcm4318 device?  I have found at linuxwireless.org that my device
> is supported by b43 driver and I was glad of it, because I needn't to use
> ndiswrapper, but I haven't found how to install this driver. 
> Please, could someone help me?

Get the wireless development kernel sources with
git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-2.6.git
The drivers will be includes there.

> Secondly, I would like to offer my assistance on this project. I am
> able to write C code or I can help any other way

We are searching for new b43legacy maintainer. So if you want to dig into
that code, please do so and maybe you'll become the new maintainer. It's
up to you. ;)

-- 
Greetings Michael.


From bcm43xx at jollyrotten.org  Wed Oct 24 17:14:49 2007
From: bcm43xx at jollyrotten.org (Anthony Durity)
Date: Wed, 24 Oct 2007 17:14:49 +0200
Subject: Installation of b43
In-Reply-To: <200710232251.58702.mb@bu3sch.de>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
	<20071023201201.GA19550@lemmy.chello.upc.cz>
	<200710232251.58702.mb@bu3sch.de>
Message-ID: <b1923f7f0710240814u2eb51f32q4b0d15768c1caa84@mail.gmail.com>

Hullo,

I would like to express my appreciation to Larry for all the hard work he
has put in. With regards to the new b43legacy maintainer position: would you
think that this is a full-time role or a part time role? If it is a
part-time role, how many hours a day would we be talking about? And are you
willing to mentor?

regards,
    Anthony

On 10/23/07, Michael Buesch <mb at bu3sch.de> wrote:
>
> On Tuesday 23 October 2007 22:12:01 Daniel Fiser wrote:
> > Hi everybody,
> > please, could someone instruct me, how to install b43 driver for my
> > broadcom bcm4318 device?  I have found at linuxwireless.org that my
> device
> > is supported by b43 driver and I was glad of it, because I needn't to
> use
> > ndiswrapper, but I haven't found how to install this driver.
> > Please, could someone help me?
>
> Get the wireless development kernel sources with
> git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-
> 2.6.git
> The drivers will be includes there.
>
> > Secondly, I would like to offer my assistance on this project. I am
> > able to write C code or I can help any other way
>
> We are searching for new b43legacy maintainer. So if you want to dig into
> that code, please do so and maybe you'll become the new maintainer. It's
> up to you. ;)
>
> --
> Greetings Michael.
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071024/5c97a63e/attachment.html>

From larry.finger at lwfinger.net  Wed Oct 24 17:50:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Oct 2007 10:50:25 -0500
Subject: Installation of b43
In-Reply-To: <b1923f7f0710240814u2eb51f32q4b0d15768c1caa84@mail.gmail.com>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>	<20071023201201.GA19550@lemmy.chello.upc.cz>	<200710232251.58702.mb@bu3sch.de>
	<b1923f7f0710240814u2eb51f32q4b0d15768c1caa84@mail.gmail.com>
Message-ID: <471F69C1.6060808@lwfinger.net>

Anthony Durity wrote:
> Hullo,
> 
> I would like to express my appreciation to Larry for all the hard work
> he has put in. With regards to the new b43legacy maintainer position:
> would you think that this is a full-time role or a part time role? If it
> is a part-time role, how many hours a day would we be talking about? And
> are you willing to mentor?

I can answer this question. During the creation of b43legacy, it took a lot of time (2-3 weeks
full-time) to marry the PHY and radio code of bcm43xx to the main parts of b43. Now most of the work
consists of taking the patches to b43 that are generated by Michael and porting them to b43legacy.
This often entails a bit more work than blanket substitutions of "b43legacy" for "b43", but these
changes do not happen very often. The remaining part of the work is to verify that changes to
mac80211 and other parts of the kernel have not broken b43legacy. The job is definitely a part-time
one. I think it should not take more than 3-4 hours per week.

Although I have resigned as maintainer, I am not leaving the project entirely. My situation is that
I will not have access to a broadband connection for 3-4 months, and will have to rely on dial-up
over a shared line. I will be able to do E-mail, but not kernel updates. I will certainly help you
in any way that I can.

Larry





From news at tecnicaict.com  Wed Oct 24 18:59:21 2007
From: news at tecnicaict.com (tICT)
Date: Wed, 24 Oct 2007 18:59:21 +0200
Subject: Resigning as maintainer
In-Reply-To: <mailman.71.1193133683.4031.bcm43xx-dev@lists.berlios.de>
References: <mailman.71.1193133683.4031.bcm43xx-dev@lists.berlios.de>
Message-ID: <471F79E9.4070807@tecnicaict.com>

bcm43xx-dev-request at lists.berlios.de wrote:
> Thanks for helping me and putting up with me. It has been great fun.
>
> Larry

Thanks for your great support Larry.
We hope you come back manteiner soon!


From mb at bu3sch.de  Wed Oct 24 22:46:27 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 24 Oct 2007 22:46:27 +0200
Subject: Installation of b43
In-Reply-To: <471F69C1.6060808@lwfinger.net>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
	<b1923f7f0710240814u2eb51f32q4b0d15768c1caa84@mail.gmail.com>
	<471F69C1.6060808@lwfinger.net>
Message-ID: <200710242246.27498.mb@bu3sch.de>

On Wednesday 24 October 2007 17:50:25 Larry Finger wrote:
> Although I have resigned as maintainer, I am not leaving the project entirely. My situation is that
> I will not have access to a broadband connection for 3-4 months, and will have to rely on dial-up
> over a shared line. I will be able to do E-mail, but not kernel updates. I will certainly help you
> in any way that I can.

Of course you'll get the required help from all of us.

Basically, becoming a b43legacy maintainer is easy. Just start hacking on it.
Start understanding the code. Maybe make suggestions/patches on what to do
better. Simply start working on it. If that works well, we'll put your name
into the MAINTAINERS file and you are the official maintainer.
That's how it worked for Larry.

-- 
Greetings Michael.


From danfis at danfis.cz  Wed Oct 24 23:26:25 2007
From: danfis at danfis.cz (Daniel Fiser)
Date: Wed, 24 Oct 2007 23:26:25 +0200
Subject: Installation of b43
In-Reply-To: <200710232251.58702.mb@bu3sch.de>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
	<20071023201201.GA19550@lemmy.chello.upc.cz>
	<200710232251.58702.mb@bu3sch.de>
Message-ID: <20071024212625.GA11223@lemmy.chello.upc.cz>

Tue, Oct 23, 2007 at 10:51:58PM CEST, mb at bu3sch.de napsal(a):
> On Tuesday 23 October 2007 22:12:01 Daniel Fiser wrote:
> > Hi everybody,
> > please, could someone instruct me, how to install b43 driver for my
> > broadcom bcm4318 device?  I have found at linuxwireless.org that my device
> > is supported by b43 driver and I was glad of it, because I needn't to use
> > ndiswrapper, but I haven't found how to install this driver. 
> > Please, could someone help me?
> 
> Get the wireless development kernel sources with
> git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-2.6.git
> The drivers will be includes there.
Thanks for response. But I haven't found there b43 driver, only bcm43xx. I
was looking into directory drivers/net/wireless, am I wrong?
According to bcm43xx.berlios.de, bcm43xx driver does not support my device,
but b43 driver do. It seems I must use other git repository, I don't know,
maybe I do something wrong, but can't find b43 there. 

> 
> > Secondly, I would like to offer my assistance on this project. I am
> > able to write C code or I can help any other way
> 
> We are searching for new b43legacy maintainer. So if you want to dig into
> that code, please do so and maybe you'll become the new maintainer. It's
> up to you. ;)
Ok, I am newbie in this kind of development, so maintaining anything isn't
for me...
Does exist any introduction to development of this driver, where
to start etc. and any todo list? But firstly I need to find the source
code and install it :).

Cheers,
   Dan



From larry.finger at lwfinger.net  Wed Oct 24 23:38:04 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Oct 2007 16:38:04 -0500
Subject: Installation of b43
In-Reply-To: <20071024212625.GA11223@lemmy.chello.upc.cz>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>	<20071023201201.GA19550@lemmy.chello.upc.cz>	<200710232251.58702.mb@bu3sch.de>
	<20071024212625.GA11223@lemmy.chello.upc.cz>
Message-ID: <471FBB3C.7050405@lwfinger.net>

Daniel Fiser wrote:
> Tue, Oct 23, 2007 at 10:51:58PM CEST, mb at bu3sch.de napsal(a):
>> On Tuesday 23 October 2007 22:12:01 Daniel Fiser wrote:
>>> Hi everybody,
>>> please, could someone instruct me, how to install b43 driver for my
>>> broadcom bcm4318 device?  I have found at linuxwireless.org that my device
>>> is supported by b43 driver and I was glad of it, because I needn't to use
>>> ndiswrapper, but I haven't found how to install this driver. 
>>> Please, could someone help me?
>> Get the wireless development kernel sources with
>> git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-2.6.git
>> The drivers will be includes there.
> Thanks for response. But I haven't found there b43 driver, only bcm43xx. I
> was looking into directory drivers/net/wireless, am I wrong?
> According to bcm43xx.berlios.de, bcm43xx driver does not support my device,
> but b43 driver do. It seems I must use other git repository, I don't know,
> maybe I do something wrong, but can't find b43 there. 
> 
>>> Secondly, I would like to offer my assistance on this project. I am
>>> able to write C code or I can help any other way
>> We are searching for new b43legacy maintainer. So if you want to dig into
>> that code, please do so and maybe you'll become the new maintainer. It's
>> up to you. ;)
> Ok, I am newbie in this kind of development, so maintaining anything isn't
> for me...
> Does exist any introduction to development of this driver, where
> to start etc. and any todo list? But firstly I need to find the source
> code and install it :).

It is there, just hidden. You need to issue the command

git checkout -b everything origin/everything

Branch "everything" has the b43 and b43legacy code.

Larry


From danfis at danfis.cz  Wed Oct 24 23:39:56 2007
From: danfis at danfis.cz (Daniel Fiser)
Date: Wed, 24 Oct 2007 23:39:56 +0200
Subject: Installation of b43
In-Reply-To: <20071024212625.GA11223@lemmy.chello.upc.cz>
References: <20071023200246.GA12986@lemmy.chello.upc.cz>
	<20071023201201.GA19550@lemmy.chello.upc.cz>
	<200710232251.58702.mb@bu3sch.de>
	<20071024212625.GA11223@lemmy.chello.upc.cz>
Message-ID: <20071024213956.GA12654@lemmy.chello.upc.cz>

Wed, Oct 24, 2007 at 11:26:25PM CEST, danfis at danfis.cz napsal(a):
> Tue, Oct 23, 2007 at 10:51:58PM CEST, mb at bu3sch.de napsal(a):
> > On Tuesday 23 October 2007 22:12:01 Daniel Fiser wrote:
> > > Hi everybody,
> > > please, could someone instruct me, how to install b43 driver for my
> > > broadcom bcm4318 device?  I have found at linuxwireless.org that my device
> > > is supported by b43 driver and I was glad of it, because I needn't to use
> > > ndiswrapper, but I haven't found how to install this driver. 
> > > Please, could someone help me?
> > 
> > Get the wireless development kernel sources with
> > git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-2.6.git
> > The drivers will be includes there.
> Thanks for response. But I haven't found there b43 driver, only bcm43xx. I
> was looking into directory drivers/net/wireless, am I wrong?
> According to bcm43xx.berlios.de, bcm43xx driver does not support my device,
> but b43 driver do. It seems I must use other git repository, I don't know,
> maybe I do something wrong, but can't find b43 there. 
Ok, I find it - 'git checkout origin/everything'.
Tomorow I will try to compile and install the driver.
Thanks for your help.

Cheers,
   Dan


From mactalla.obair at gmail.com  Thu Oct 25 04:22:19 2007
From: mactalla.obair at gmail.com (Andrew Fuller)
Date: Wed, 24 Oct 2007 19:22:19 -0700
Subject: Resigning as maintainer
In-Reply-To: <471D645B.8000302@lwfinger.net>
References: <471D645B.8000302@lwfinger.net>
Message-ID: <ae67fd3f0710241922w4f10a5eanebbf1be5f3f5726a@mail.gmail.com>

On 10/22/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>
> Remove Larry Finger as maintainer of bcm43xx and b43legacy.
>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
>
> John,
>
> Attached is a patch removing my name as maintainer of bcm43xx and b43legacy. For at least 3 months
> this winter, I will not have a broadband connection and it will be impossible for me to update my
> kernel source during that time.
>
> I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
> and b43legacy are already better than any SoftMAC driver will ever be.
>
> I will attempt to find a replacement b43legacy maintainer, and will continue to port any b43 patches
> to b43legacy until a replacement is found or until the end of November.
>
> Thanks for helping me and putting up with me. It has been great fun.
>
> Larry

I, too, would like to echo my appreciation for your work on the driver
and for helping resolve the 30bit DMA w/ >1GB ram bug in the past.

-Andrew


From mistamaila at gmail.com  Fri Oct 26 01:10:29 2007
From: mistamaila at gmail.com (John H.)
Date: Thu, 25 Oct 2007 18:10:29 -0500
Subject: Resigning as maintainer
In-Reply-To: <ae67fd3f0710241922w4f10a5eanebbf1be5f3f5726a@mail.gmail.com>
References: <471D645B.8000302@lwfinger.net>
	<ae67fd3f0710241922w4f10a5eanebbf1be5f3f5726a@mail.gmail.com>
Message-ID: <5b9417770710251610v3ba2a73bmc7ffb580917fa9f1@mail.gmail.com>

Larry, thanks again for your work.  b43 has been working great.

On 10/24/07, Andrew Fuller <mactalla.obair at gmail.com> wrote:
> On 10/22/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> >
> > Remove Larry Finger as maintainer of bcm43xx and b43legacy.
> >
> > Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> > ---
> >
> > John,
> >
> > Attached is a patch removing my name as maintainer of bcm43xx and b43legacy. For at least 3 months
> > this winter, I will not have a broadband connection and it will be impossible for me to update my
> > kernel source during that time.
> >
> > I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
> > and b43legacy are already better than any SoftMAC driver will ever be.
> >
> > I will attempt to find a replacement b43legacy maintainer, and will continue to port any b43 patches
> > to b43legacy until a replacement is found or until the end of November.
> >
> > Thanks for helping me and putting up with me. It has been great fun.
> >
> > Larry
>
> I, too, would like to echo my appreciation for your work on the driver
> and for helping resolve the 30bit DMA w/ >1GB ram bug in the past.
>
> -Andrew
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>


From mansour77 at yahoo.com  Fri Oct 26 03:09:02 2007
From: mansour77 at yahoo.com (Mansour)
Date: Thu, 25 Oct 2007 22:09:02 -0300
Subject: Resigning as maintainer
In-Reply-To: <471D645B.8000302@lwfinger.net>
References: <471D645B.8000302@lwfinger.net>
Message-ID: <47213E2E.5070102@yahoo.com>

Thank you Larry for your help and support. I really appreciate your 
efforts to support the bcm.

Mansour

Larry Finger wrote:
> Remove Larry Finger as maintainer of bcm43xx and b43legacy.
>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
>
> John,
>
> Attached is a patch removing my name as maintainer of bcm43xx and b43legacy. For at least 3 months
> this winter, I will not have a broadband connection and it will be impossible for me to update my
> kernel source during that time.
>
> I recommend that bcm43xx be removed from the mainline kernels as of 2.6.25. I am confident that b43
> and b43legacy are already better than any SoftMAC driver will ever be.
>
> I will attempt to find a replacement b43legacy maintainer, and will continue to port any b43 patches
> to b43legacy until a replacement is found or until the end of November.
>
> Thanks for helping me and putting up with me. It has been great fun.
>
> Larry
> ---
>
> Index: wireless-2.6/MAINTAINERS
> ===================================================================
> --- wireless-2.6.orig/MAINTAINERS
> +++ wireless-2.6/MAINTAINERS
> @@ -822,20 +822,14 @@ W:	http://bcm43xx.berlios.de/
>  S:	Maintained
>
>  B43LEGACY WIRELESS DRIVER
> -P:	Larry Finger
> -M:	Larry.Finger at lwfinger.net
>  L:	linux-wireless at vger.kernel.org
>  W:	http://bcm43xx.berlios.de/
> -S:	Maintained
> +S:	Orphaned
>
>  BCM43XX WIRELESS DRIVER (SOFTMAC BASED VERSION)
> -P:	Larry Finger
> -M:	Larry.Finger at lwfinger.net
> -P:	Stefano Brivio
> -M:	st3 at riseup.net
>  L:	linux-wireless at vger.kernel.org
>  W:	http://bcm43xx.berlios.de/
> -S:	Maintained
> +S:	Orphaned
>
>  BEFS FILE SYSTEM
>  P:	Sergey S. Kostyliov
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>   



From mb at bu3sch.de  Sat Oct 27 14:47:18 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Oct 2007 14:47:18 +0200
Subject: [PATCH] b43: Fix Kconfig for built-in
Message-ID: <200710271447.18946.mb@bu3sch.de>

This fixes the Kconfig for a built-in b43.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

Somebody please port this to b43legacy.
Let's see if somebody starts to do the job. :)

Index: wireless-2.6/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/Kconfig	2007-10-27 13:28:16.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/Kconfig	2007-10-27 14:29:28.000000000 +0200
@@ -61,16 +61,18 @@ config B43_PCMCIA
 
 	  If unsure, say N.
 
-# LED support
+# This config option automatically enables b43 LEDS support,
+# if it's possible.
 config B43_LEDS
 	bool
-	depends on B43 && MAC80211_LEDS
+	depends on B43 && MAC80211_LEDS && (LEDS_CLASS = y || LEDS_CLASS = B43)
 	default y
 
-# RFKILL support
+# This config option automatically enables b43 RFKILL support,
+# if it's possible.
 config B43_RFKILL
 	bool
-	depends on B43 && RFKILL && RFKILL_INPUT && INPUT_POLLDEV
+	depends on B43 && (RFKILL = y || RFKILL = B43) && RFKILL_INPUT && (INPUT_POLLDEV = y || INPUT_POLLDEV = B43)
 	default y
 
 config B43_DEBUG


From mb at bu3sch.de  Sat Oct 27 15:11:00 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Oct 2007 15:11:00 +0200
Subject: [PATCH] ssb: Fix initcall ordering
Message-ID: <200710271511.00404.mb@bu3sch.de>

ssb must init after PCI but before the ssb drivers.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Christian Casteyde <casteyde.christan at free.fr>
Fixes-bug: #9219

Index: wireless-2.6/drivers/ssb/main.c
===================================================================
--- wireless-2.6.orig/drivers/ssb/main.c	2007-10-27 14:54:40.000000000 +0200
+++ wireless-2.6/drivers/ssb/main.c	2007-10-27 14:57:15.000000000 +0200
@@ -1147,7 +1147,10 @@ static int __init ssb_modinit(void)
 
 	return err;
 }
-subsys_initcall(ssb_modinit);
+/* ssb must be initialized after PCI but before the ssb drivers.
+ * That means we must use some initcall between subsys_initcall
+ * and device_initcall. */
+fs_initcall(ssb_modinit);
 
 static void __exit ssb_modexit(void)
 {


From mb at bu3sch.de  Sat Oct 27 15:14:39 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Oct 2007 15:14:39 +0200
Subject: [PATCH] ssb: Fix initcall ordering
Message-ID: <200710271514.40056.mb@bu3sch.de>

ssb must init after PCI but before the ssb drivers.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Christian Casteyde <casteyde.christian at free.fr>
Fixes-bug: #9219

Index: wireless-2.6/drivers/ssb/main.c
===================================================================
--- wireless-2.6.orig/drivers/ssb/main.c	2007-10-27 14:54:40.000000000 +0200
+++ wireless-2.6/drivers/ssb/main.c	2007-10-27 14:57:15.000000000 +0200
@@ -1147,7 +1147,10 @@ static int __init ssb_modinit(void)
 
 	return err;
 }
-subsys_initcall(ssb_modinit);
+/* ssb must be initialized after PCI but before the ssb drivers.
+ * That means we must use some initcall between subsys_initcall
+ * and device_initcall. */
+fs_initcall(ssb_modinit);
 
 static void __exit ssb_modexit(void)
 {


From evanfoss at gmail.com  Sat Oct 27 23:56:39 2007
From: evanfoss at gmail.com (evan foss)
Date: Sat, 27 Oct 2007 17:56:39 -0400
Subject: possible bug in ssb/b43
Message-ID: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>

Hello all,
After using bcm43xx for a long time (courtesy of Larry) on my compaq
v3019us I though I would test the b43 so I go it from git last night.
I used the current v4 firmware and the b43 driver seemed to load fine
until it hit an error relating to ssb. I am using mac80211 not softmac
and I tried the b43legacy with mac80211 as well all to the same
effect. I tried the ssb initcall ordering patch that was just released
with b43 again to no effect. My machine is a laptop with the bcm4311
version 1 the cpu is an amd turion 64 and it is running smp. Is there
a 64 bit firmware I should be using? I configured the kernel exactly
the same as I have in the past only with the new mac80211, b43, and
rfkill switch supported as modules. Is this an SSB problem or an error
in b43 and can someone please help me? I turned verbose on but it
didn't help much. Below is a snippet of my dmesg output.

ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
ssb: Sonics Silicon Backplane found on PCI device 0000:01:00.0
b43-phy1: Broadcom 4311 WLAN found
b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 8
b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
phy1: Failed to select rate control algorithm
phy1: Failed to initialize rate control algorithm
b43: probe of ssb0:0 failed with error -2


From mb at bu3sch.de  Sun Oct 28 00:34:41 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 00:34:41 +0200
Subject: Change error message for failed rc module (was: possible bug in
	ssb/b43)
In-Reply-To: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
Message-ID: <200710280034.41942.mb@bu3sch.de>

On Saturday 27 October 2007 23:56:39 evan foss wrote:
<snip>
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
> ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
> ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
> ssb: Sonics Silicon Backplane found on PCI device 0000:01:00.0
> b43-phy1: Broadcom 4311 WLAN found
> b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 8
> b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> phy1: Failed to select rate control algorithm
> phy1: Failed to initialize rate control algorithm
> b43: probe of ssb0:0 failed with error -2

That's not a ssb or b43 bug.
Please compile and load rc80211_simple.

I think we should change this error message, as obviously people don't
understand that the issue is a failed module request for the rc module.
Maybe add another message like "Please install a mac80211 rate control module,
such as rc80211_simple" if the error code is -ENOENT (-2)
Another suggestion?

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Oct 28 01:44:29 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Oct 2007 18:44:29 -0500
Subject: Change error message for failed rc module
In-Reply-To: <200710280034.41942.mb@bu3sch.de>
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710280034.41942.mb@bu3sch.de>
Message-ID: <4723CD5D.1000109@lwfinger.net>

Michael Buesch wrote:
> On Saturday 27 October 2007 23:56:39 evan foss wrote:
> <snip>
>> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
>> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
>> ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
>> ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
>> ssb: Sonics Silicon Backplane found on PCI device 0000:01:00.0
>> b43-phy1: Broadcom 4311 WLAN found
>> b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 8
>> b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
>> phy1: Failed to select rate control algorithm
>> phy1: Failed to initialize rate control algorithm
>> b43: probe of ssb0:0 failed with error -2
> 
> That's not a ssb or b43 bug.
> Please compile and load rc80211_simple.
> 
> I think we should change this error message, as obviously people don't
> understand that the issue is a failed module request for the rc module.
> Maybe add another message like "Please install a mac80211 rate control module,
> such as rc80211_simple" if the error code is -ENOENT (-2)
> Another suggestion?

Your suggestion looks good to me.

Larry


From johannes at sipsolutions.net  Sun Oct 28 11:40:21 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 28 Oct 2007 11:40:21 +0100
Subject: Change error message for failed rc module (was: possible bug
	in ssb/b43)
In-Reply-To: <200710280034.41942.mb@bu3sch.de>
	(sfid-20071027_233701_549220_BD0E4B1B)
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710280034.41942.mb@bu3sch.de>
	(sfid-20071027_233701_549220_BD0E4B1B)
Message-ID: <1193568021.3966.15.camel@johannes.berg>


> Please compile and load rc80211_simple.

rc80211_simple is so little code, can't we just compile it into mac80211
module and make it configurable only for EMBEDDED?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071028/ad245427/attachment.pgp>

From johannes at sipsolutions.net  Sun Oct 28 11:50:27 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 28 Oct 2007 11:50:27 +0100
Subject: Change error message for failed rc module
In-Reply-To: <47246844.6020109@gmail.com>
	(sfid-20071028_104530_132972_8BA4B064)
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710280034.41942.mb@bu3sch.de>
	(sfid-20071027_233701_549220_BD0E4B1B)
	<1193568021.3966.15.camel@johannes.berg>
	<47246844.6020109@gmail.com> (sfid-20071028_104530_132972_8BA4B064)
Message-ID: <1193568627.3966.27.camel@johannes.berg>



> won't this conflict with drivers that want to use their own rate scaling 
> modules? (like iwl3945/4965)

The rate control algorithm should be per-hw struct. We still don't have
the "driver preference" patch applied because of some things, but in any
case it is possible to have an algorithm for each hw.

Besides, currently, afaict, if you first load rc80211_simple and then
iwlwifi, the latter doesn't really work well if at all due to simple
being used. That needs to be fixed anyway, the right solution is that
patch we were discussing a long time ago with driver preference for rate
control algorithm (though ISTR there were still some issues with it and
I don't remember whether the initial version was applied)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071028/2ffa7818/attachment.pgp>

From mb at bu3sch.de  Sun Oct 28 11:48:50 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 11:48:50 +0100
Subject: Change error message for failed rc module (was: possible bug in
	ssb/b43)
In-Reply-To: <1193568021.3966.15.camel@johannes.berg>
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710280034.41942.mb@bu3sch.de>
	<1193568021.3966.15.camel@johannes.berg>
Message-ID: <200710281148.50859.mb@bu3sch.de>

On Sunday 28 October 2007 11:40:21 Johannes Berg wrote:
> 
> > Please compile and load rc80211_simple.
> 
> rc80211_simple is so little code, can't we just compile it into mac80211
> module and make it configurable only for EMBEDDED?

Yep, great idea. Let's make this default.
I will do a patch.

-- 
Greetings Michael.


From ralf at ralf-saalmueller.de  Sun Oct 28 13:59:01 2007
From: ralf at ralf-saalmueller.de (Ralf Saalmueller)
Date: Sun, 28 Oct 2007 13:59:01 +0100
Subject: bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not available or
	load failed.
Message-ID: <20071028135901.227c9847@localhost>

Hello to the dev team and thank you very much for your work.

First I like to tell: I have the firmware installed:
/lib/firmware/b43# ls
a0g0bsinitvals4.fw   a0g1bsinitvals5.fw   b0g0bsinitvals5.fw
lp0initvals13.fw  ucode4.fw a0g0bsinitvals5.fw   a0g1initvals13.fw
b0g0initvals13.fw   pcm4.fw           ucode5.fw a0g0initvals4.fw
a0g1initvals5.fw     b0g0initvals4.fw    pcm5.fw a0g0initvals5.fw
b0g0bsinitvals13.fw  b0g0initvals5.fw    ucode11.fw
a0g1bsinitvals13.fw  b0g0bsinitvals4.fw   lp0bsinitvals13.fw  ucode13.fw

I have an Apple PowerBook G4:
  processor       : 0
  cpu             : 7447A, altivec supported
  clock           : 1666.666000MHz
  revision        : 0.5 (pvr 8003 0105)
  bogomips        : 33.15
  timebase        : 8320000
  platform        : PowerMac
  machine         : PowerBook5,8
  motherboard     : PowerBook5,8 MacRISC3 Power Macintosh
  detected as     : 287 (PowerBook G4 15")
  pmac flags      : 00000019
  L2 cache        : 512K unified
  pmac-generation : NewWorld

Running debian etch 4.0r1.

I have searched the internet and found nothing that handles the error
when the firmware is installed. I haven't found an entry in your
mailing list either. Sorry if I haven't found it.

Further more, I haven't found a how to configure the bcm43xx module.

The debian packet missed to get a firmware with the right md5 and I
haven't had any luck with the 008 version from berlios until I looked
into the source and found some urls. After that b43-fwcutter worked
without an error.

But the bcm43xx modules doesn't work, and I guess the firmware can't be
found. Where does it look for it?

Thank's for any help, Ralf


From larry.finger at lwfinger.net  Sun Oct 28 14:13:40 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Oct 2007 08:13:40 -0500
Subject: bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not available
	or	load failed.
In-Reply-To: <20071028135901.227c9847@localhost>
References: <20071028135901.227c9847@localhost>
Message-ID: <47248B04.9010208@lwfinger.net>

Ralf Saalmueller wrote:
> Hello to the dev team and thank you very much for your work.
> 
> First I like to tell: I have the firmware installed:
> /lib/firmware/b43# ls
> a0g0bsinitvals4.fw   a0g1bsinitvals5.fw   b0g0bsinitvals5.fw
> lp0initvals13.fw  ucode4.fw a0g0bsinitvals5.fw   a0g1initvals13.fw
> b0g0initvals13.fw   pcm4.fw           ucode5.fw a0g0initvals4.fw
> a0g1initvals5.fw     b0g0initvals4.fw    pcm5.fw a0g0initvals5.fw
> b0g0bsinitvals13.fw  b0g0initvals5.fw    ucode11.fw
> a0g1bsinitvals13.fw  b0g0bsinitvals4.fw   lp0bsinitvals13.fw  ucode13.fw
> 
> I have an Apple PowerBook G4:
>   processor       : 0
>   cpu             : 7447A, altivec supported
>   clock           : 1666.666000MHz
>   revision        : 0.5 (pvr 8003 0105)
>   bogomips        : 33.15
>   timebase        : 8320000
>   platform        : PowerMac
>   machine         : PowerBook5,8
>   motherboard     : PowerBook5,8 MacRISC3 Power Macintosh
>   detected as     : 287 (PowerBook G4 15")
>   pmac flags      : 00000019
>   L2 cache        : 512K unified
>   pmac-generation : NewWorld
> 
> Running debian etch 4.0r1.
> 
> I have searched the internet and found nothing that handles the error
> when the firmware is installed. I haven't found an entry in your
> mailing list either. Sorry if I haven't found it.
> 
> Further more, I haven't found a how to configure the bcm43xx module.
> 
> The debian packet missed to get a firmware with the right md5 and I
> haven't had any luck with the 008 version from berlios until I looked
> into the source and found some urls. After that b43-fwcutter worked
> without an error.
> 
> But the bcm43xx modules doesn't work, and I guess the firmware can't be
> found. Where does it look for it?

With bcm43xx, the firmware must be in /lib/firmware. For it, you need to use bcm43xx-fwcutter. In
addition, you need V3 firmware.

Larry


From mb at bu3sch.de  Sun Oct 28 14:14:30 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 14:14:30 +0100
Subject: bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not available
	or load failed.
In-Reply-To: <20071028135901.227c9847@localhost>
References: <20071028135901.227c9847@localhost>
Message-ID: <200710281414.30229.mb@bu3sch.de>

On Sunday 28 October 2007 13:59:01 Ralf Saalmueller wrote:
> Hello to the dev team and thank you very much for your work.
> 
> First I like to tell: I have the firmware installed:
> /lib/firmware/b43# ls

bcm43xx needs the old firmware files in /lib/firmware/bcm43xx_*.fw


-- 
Greetings Michael.


From johannes at sipsolutions.net  Sun Oct 28 14:17:44 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 28 Oct 2007 14:17:44 +0100
Subject: [PATCH] mac80211: make simple rate control algorithm built-in
In-Reply-To: <200710281148.50859.mb@bu3sch.de>
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710280034.41942.mb@bu3sch.de>
	<1193568021.3966.15.camel@johannes.berg>
	<200710281148.50859.mb@bu3sch.de>
Message-ID: <1193577464.5197.2.camel@johannes.berg>

Too frequently people do not have module autoloading enabled
or fail to install the rate control module correctly, hence
their hardware probing fails due to no rate control algorithm
being available. This makes the 'simple' algorithm built into
the mac80211 module unless EMBEDDED is enabled in which case
it can be disabled (eg. if the wanted driver requires another
rate control algorithm.)

Signed-off-by: Johannes Berg <johannes at sipsolutions.net>

---
 net/mac80211/Kconfig          |   12 ++++++++++++
 net/mac80211/Makefile         |    3 ++-
 net/mac80211/ieee80211.c      |   13 +++++++++++++
 net/mac80211/ieee80211_rate.c |   13 +++++++++++--
 net/mac80211/ieee80211_rate.h |    3 +++
 net/mac80211/rc80211_simple.c |   25 +------------------------
 6 files changed, 42 insertions(+), 27 deletions(-)

--- linux-2.6.orig/net/mac80211/Kconfig	2007-10-28 11:56:30.749321886 +0100
+++ linux-2.6/net/mac80211/Kconfig	2007-10-28 14:13:34.255049803 +0100
@@ -13,6 +13,18 @@ config MAC80211
 	This option enables the hardware independent IEEE 802.11
 	networking stack.
 
+config MAC80211_RCSIMPLE
+	bool "'simple' rate control algorithm"
+	default y
+	depends on MAC80211 && EMBEDDED
+	help
+	  This option allows you to turn off the 'simple' rate
+	  control algorithm in mac80211. If you do turn it off,
+	  you absolutely need another rate control algorithm.
+
+	  Say Y unless you know you will have another algorithm
+	  available.
+
 config MAC80211_LEDS
 	bool "Enable LED triggers"
 	depends on MAC80211 && LEDS_TRIGGERS
--- linux-2.6.orig/net/mac80211/Makefile	2007-10-28 11:55:23.509301107 +0100
+++ linux-2.6/net/mac80211/Makefile	2007-10-28 11:56:26.709301759 +0100
@@ -1,8 +1,9 @@
-obj-$(CONFIG_MAC80211) += mac80211.o rc80211_simple.o
+obj-$(CONFIG_MAC80211) += mac80211.o
 
 mac80211-objs-$(CONFIG_MAC80211_LEDS) += ieee80211_led.o
 mac80211-objs-$(CONFIG_MAC80211_DEBUGFS) += debugfs.o debugfs_sta.o debugfs_netdev.o debugfs_key.o
 mac80211-objs-$(CONFIG_NET_SCHED) += wme.o
+mac80211-objs-$(CONFIG_MAC80211_RCSIMPLE) += rc80211_simple.o
 
 mac80211-objs := \
 	ieee80211.o \
--- linux-2.6.orig/net/mac80211/ieee80211.c	2007-10-28 11:59:41.869300835 +0100
+++ linux-2.6/net/mac80211/ieee80211.c	2007-10-28 14:12:14.495041666 +0100
@@ -1435,8 +1435,17 @@ static int __init ieee80211_init(void)
 
 	BUILD_BUG_ON(sizeof(struct ieee80211_tx_packet_data) > sizeof(skb->cb));
 
+#ifdef CONFIG_MAC80211_RCSIMPLE
+	ret = ieee80211_rate_control_register(&mac80211_rcsimple);
+	if (ret)
+		return ret;
+#endif
+
 	ret = ieee80211_wme_register();
 	if (ret) {
+#ifdef CONFIG_MAC80211_RCSIMPLE
+		ieee80211_rate_control_unregister(&mac80211_rcsimple);
+#endif
 		printk(KERN_DEBUG "ieee80211_init: failed to "
 		       "initialize WME (err=%d)\n", ret);
 		return ret;
@@ -1450,6 +1459,10 @@ static int __init ieee80211_init(void)
 
 static void __exit ieee80211_exit(void)
 {
+#ifdef CONFIG_MAC80211_RCSIMPLE
+	ieee80211_rate_control_unregister(&mac80211_rcsimple);
+#endif
+
 	ieee80211_wme_unregister();
 	ieee80211_debugfs_netdev_exit();
 }
--- linux-2.6.orig/net/mac80211/ieee80211_rate.h	2007-10-28 12:01:32.659303603 +0100
+++ linux-2.6/net/mac80211/ieee80211_rate.h	2007-10-28 14:11:42.775035211 +0100
@@ -67,6 +67,9 @@ struct rate_control_ref {
 	struct kref kref;
 };
 
+/* default 'simple' algorithm */
+extern struct rate_control_ops mac80211_rcsimple;
+
 int ieee80211_rate_control_register(struct rate_control_ops *ops);
 void ieee80211_rate_control_unregister(struct rate_control_ops *ops);
 
--- linux-2.6.orig/net/mac80211/rc80211_simple.c	2007-10-28 12:03:52.769304415 +0100
+++ linux-2.6/net/mac80211/rc80211_simple.c	2007-10-28 14:11:53.705037761 +0100
@@ -7,7 +7,6 @@
  * published by the Free Software Foundation.
  */
 
-#include <linux/module.h>
 #include <linux/init.h>
 #include <linux/netdevice.h>
 #include <linux/types.h>
@@ -29,8 +28,6 @@
 #define RATE_CONTROL_INTERVAL (HZ / 20)
 #define RATE_CONTROL_MIN_TX 10
 
-MODULE_ALIAS("rc80211_default");
-
 static void rate_control_rate_inc(struct ieee80211_local *local,
 				  struct sta_info *sta)
 {
@@ -394,8 +391,7 @@ static void rate_control_simple_remove_s
 }
 #endif
 
-static struct rate_control_ops rate_control_simple = {
-	.module = THIS_MODULE,
+struct rate_control_ops mac80211_rcsimple = {
 	.name = "simple",
 	.tx_status = rate_control_simple_tx_status,
 	.get_rate = rate_control_simple_get_rate,
@@ -410,22 +406,3 @@ static struct rate_control_ops rate_cont
 	.remove_sta_debugfs = rate_control_simple_remove_sta_debugfs,
 #endif
 };
-
-
-static int __init rate_control_simple_init(void)
-{
-	return ieee80211_rate_control_register(&rate_control_simple);
-}
-
-
-static void __exit rate_control_simple_exit(void)
-{
-	ieee80211_rate_control_unregister(&rate_control_simple);
-}
-
-
-subsys_initcall(rate_control_simple_init);
-module_exit(rate_control_simple_exit);
-
-MODULE_DESCRIPTION("Simple rate control algorithm for ieee80211");
-MODULE_LICENSE("GPL");
--- linux-2.6.orig/net/mac80211/ieee80211_rate.c	2007-10-28 13:41:38.079305284 +0100
+++ linux-2.6/net/mac80211/ieee80211_rate.c	2007-10-28 14:07:51.665033203 +0100
@@ -25,6 +25,9 @@ int ieee80211_rate_control_register(stru
 {
 	struct rate_control_alg *alg;
 
+	if (!ops->name)
+		return -EINVAL;
+
 	alg = kzalloc(sizeof(*alg), GFP_KERNEL);
 	if (alg == NULL) {
 		return -ENOMEM;
@@ -61,9 +64,12 @@ ieee80211_try_rate_control_ops_get(const
 	struct rate_control_alg *alg;
 	struct rate_control_ops *ops = NULL;
 
+	if (!name)
+		return NULL;
+
 	mutex_lock(&rate_ctrl_mutex);
 	list_for_each_entry(alg, &rate_ctrl_algs, list) {
-		if (!name || !strcmp(alg->ops->name, name))
+		if (!strcmp(alg->ops->name, name))
 			if (try_module_get(alg->ops->module)) {
 				ops = alg->ops;
 				break;
@@ -80,9 +86,12 @@ ieee80211_rate_control_ops_get(const cha
 {
 	struct rate_control_ops *ops;
 
+	if (!name)
+		name = "simple";
+
 	ops = ieee80211_try_rate_control_ops_get(name);
 	if (!ops) {
-		request_module("rc80211_%s", name ? name : "default");
+		request_module("rc80211_%s", name);
 		ops = ieee80211_try_rate_control_ops_get(name);
 	}
 	return ops;




From mb at bu3sch.de  Sun Oct 28 14:21:43 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 14:21:43 +0100
Subject: [PATCH] mac80211: make simple rate control algorithm built-in
In-Reply-To: <1193577464.5197.2.camel@johannes.berg>
References: <4a55afb80710271456k6c3bbfeah879b67a91a3b8d41@mail.gmail.com>
	<200710281148.50859.mb@bu3sch.de>
	<1193577464.5197.2.camel@johannes.berg>
Message-ID: <200710281421.43574.mb@bu3sch.de>

On Sunday 28 October 2007 14:17:44 Johannes Berg wrote:
> Too frequently people do not have module autoloading enabled
> or fail to install the rate control module correctly, hence
> their hardware probing fails due to no rate control algorithm
> being available. This makes the 'simple' algorithm built into
> the mac80211 module unless EMBEDDED is enabled in which case
> it can be disabled (eg. if the wanted driver requires another
> rate control algorithm.)
> 
> Signed-off-by: Johannes Berg <johannes at sipsolutions.net>

Acked-by: Michael Buesch <mb at bu3sch.de>

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Oct 28 15:59:58 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 15:59:58 +0100
Subject: [PATCH] b43: Dereference of wl->current_dev must be protected by
	wl->mutex
Message-ID: <200710281559.59012.mb@bu3sch.de>

Put all access to wl->current_dev under protection of the mutex.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Larry Finger <larry.finger at lwfinger.net>

Index: wireless-2.6/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/main.c	2007-10-28 15:46:24.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/b43/main.c	2007-10-28 15:54:55.000000000 +0100
@@ -2813,18 +2813,25 @@ static int b43_dev_set_key(struct ieee80
 			   struct ieee80211_key_conf *key)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
-	struct b43_wldev *dev = wl->current_dev;
+	struct b43_wldev *dev;
 	unsigned long flags;
 	u8 algorithm;
 	u8 index;
-	int err = -EINVAL;
+	int err;
 	DECLARE_MAC_BUF(mac);
 
 	if (modparam_nohwcrypt)
 		return -ENOSPC; /* User disabled HW-crypto */
 
-	if (!dev)
-		return -ENODEV;
+	mutex_lock(&wl->mutex);
+	spin_lock_irqsave(&wl->irq_lock, flags);
+
+	dev = wl->current_dev;
+	err = -ENODEV;
+	if (!dev || b43_status(dev) < B43_STAT_INITIALIZED)
+		goto out_unlock;
+
+	err = -EINVAL;
 	switch (key->alg) {
 	case ALG_WEP:
 		if (key->keylen == 5)
@@ -2840,20 +2847,11 @@ static int b43_dev_set_key(struct ieee80
 		break;
 	default:
 		B43_WARN_ON(1);
-		goto out;
+		goto out_unlock;
 	}
-
 	index = (u8) (key->keyidx);
 	if (index > 3)
-		goto out;
-
-	mutex_lock(&wl->mutex);
-	spin_lock_irqsave(&wl->irq_lock, flags);
-
-	if (b43_status(dev) < B43_STAT_INITIALIZED) {
-		err = -ENODEV;
 		goto out_unlock;
-	}
 
 	switch (cmd) {
 	case SET_KEY:


From mb at bu3sch.de  Sun Oct 28 16:19:44 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 16:19:44 +0100
Subject: [PATCH] b43: Use the retry limit parameters from mac80211
Message-ID: <200710281619.45073.mb@bu3sch.de>

Use the limits provided by mac80211.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Larry Finger <Larry.Finger at lwfinger.net>


Index: wireless-2.6/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/main.c	2007-10-28 16:09:00.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/b43/main.c	2007-10-28 16:12:51.000000000 +0100
@@ -75,14 +75,6 @@ module_param_named(bad_frames_preempt, m
 MODULE_PARM_DESC(bad_frames_preempt,
 		 "enable(1) / disable(0) Bad Frames Preemption");
 
-static int modparam_short_retry = B43_DEFAULT_SHORT_RETRY_LIMIT;
-module_param_named(short_retry, modparam_short_retry, int, 0444);
-MODULE_PARM_DESC(short_retry, "Short-Retry-Limit (0 - 15)");
-
-static int modparam_long_retry = B43_DEFAULT_LONG_RETRY_LIMIT;
-module_param_named(long_retry, modparam_long_retry, int, 0444);
-MODULE_PARM_DESC(long_retry, "Long-Retry-Limit (0 - 15)");
-
 static char modparam_fwpostfix[16];
 module_param_string(fwpostfix, modparam_fwpostfix, 16, 0444);
 MODULE_PARM_DESC(fwpostfix, "Postfix for the .fw files to load.");
@@ -3261,6 +3253,22 @@ static void b43_imcfglo_timeouts_workaro
 #endif /* CONFIG_SSB_DRIVER_PCICORE */
 }
 
+/* Write the short and long frame retry limit values. */
+static void b43_set_retry_limits(struct b43_wldev *dev,
+				 unsigned int short_retry,
+				 unsigned int long_retry)
+{
+	/* The retry limit is a 4-bit counter. Enforce this to avoid overflowing
+	 * the chip-internal counter. */
+	short_retry = min(short_retry, (unsigned int)0xF);
+	long_retry = min(long_retry, (unsigned int)0xF);
+
+	b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_SRLIMIT,
+			short_retry);
+	b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_LRLIMIT,
+			long_retry);
+}
+
 /* Shutdown a wireless core */
 /* Locking: wl->mutex */
 static void b43_wireless_core_exit(struct b43_wldev *dev)
@@ -3349,15 +3357,8 @@ static int b43_wireless_core_init(struct
 	}
 	b43_hf_write(dev, hf);
 
-	/* Short/Long Retry Limit.
-	 * The retry-limit is a 4-bit counter. Enforce this to avoid overflowing
-	 * the chip-internal counter.
-	 */
-	tmp = limit_value(modparam_short_retry, 0, 0xF);
-	b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_SRLIMIT, tmp);
-	tmp = limit_value(modparam_long_retry, 0, 0xF);
-	b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_LRLIMIT, tmp);
-
+	b43_set_retry_limits(dev, B43_DEFAULT_SHORT_RETRY_LIMIT,
+			     B43_DEFAULT_LONG_RETRY_LIMIT);
 	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_SFFBLIM, 3);
 	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_LFFBLIM, 2);
 
@@ -3534,19 +3535,40 @@ static void b43_stop(struct ieee80211_hw
 	mutex_unlock(&wl->mutex);
 }
 
+static int b43_op_set_retry_limit(struct ieee80211_hw *hw,
+				  u32 short_retry_limit, u32 long_retry_limit)
+{
+	struct b43_wl *wl = hw_to_b43_wl(hw);
+	struct b43_wldev *dev;
+	int err = 0;
+
+	mutex_lock(&wl->mutex);
+	dev = wl->current_dev;
+	if (unlikely(!dev || (b43_status(dev) < B43_STAT_INITIALIZED))) {
+		err = -ENODEV;
+		goto out_unlock;
+	}
+	b43_set_retry_limits(dev, short_retry_limit, long_retry_limit);
+out_unlock:
+	mutex_unlock(&wl->mutex);
+
+	return err;
+}
+
 static const struct ieee80211_ops b43_hw_ops = {
-	.tx = b43_tx,
-	.conf_tx = b43_conf_tx,
-	.add_interface = b43_add_interface,
-	.remove_interface = b43_remove_interface,
-	.config = b43_dev_config,
-	.config_interface = b43_config_interface,
-	.configure_filter = b43_configure_filter,
-	.set_key = b43_dev_set_key,
-	.get_stats = b43_get_stats,
-	.get_tx_stats = b43_get_tx_stats,
-	.start = b43_start,
-	.stop = b43_stop,
+	.tx			= b43_tx,
+	.conf_tx		= b43_conf_tx,
+	.add_interface		= b43_add_interface,
+	.remove_interface	= b43_remove_interface,
+	.config			= b43_dev_config,
+	.config_interface	= b43_config_interface,
+	.configure_filter	= b43_configure_filter,
+	.set_key		= b43_dev_set_key,
+	.get_stats		= b43_get_stats,
+	.get_tx_stats		= b43_get_tx_stats,
+	.start			= b43_start,
+	.stop			= b43_stop,
+	.set_retry_limit	= b43_op_set_retry_limit,
 };
 
 /* Hard-reset the chip. Do not call this directly.
Index: wireless-2.6/drivers/net/wireless/b43/xmit.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/xmit.c	2007-10-28 16:08:36.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/b43/xmit.c	2007-10-28 16:11:27.000000000 +0100
@@ -294,6 +294,8 @@ static void generate_txhdr_fw4(struct b4
 		mac_ctl |= B43_TX4_MAC_STMSDU;
 	if (phy->type == B43_PHYTYPE_A)
 		mac_ctl |= B43_TX4_MAC_5GHZ;
+	if (txctl->flags & IEEE80211_TXCTL_LONG_RETRY_LIMIT)
+		mac_ctl |= B43_TX4_MAC_LONGFRAME;
 
 	/* Generate the RTS or CTS-to-self frame */
 	if ((txctl->flags & IEEE80211_TXCTL_USE_RTS_CTS) ||
@@ -342,7 +344,6 @@ static void generate_txhdr_fw4(struct b4
 			    b43_plcp_get_ratecode_cck(rts_rate);
 		if (rts_rate_fb_ofdm)
 			extra_ft |= B43_TX4_EFT_RTSFBOFDM;
-		mac_ctl |= B43_TX4_MAC_LONGFRAME;
 	}
 
 	/* Magic cookie */


From mb at bu3sch.de  Sun Oct 28 16:29:32 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 16:29:32 +0100
Subject: [PATCH] b43: consistent naming for ieee80211_ops
Message-ID: <200710281629.32319.mb@bu3sch.de>

Use a consistent naming scheme for the ops.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Larry Finger <Larry.Finger at lwfinger.net>

Index: wireless-2.6/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/main.c	2007-10-28 16:20:03.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/b43/main.c	2007-10-28 16:24:51.000000000 +0100
@@ -2486,8 +2486,9 @@ static int b43_rng_init(struct b43_wl *w
 	return err;
 }
 
-static int b43_tx(struct ieee80211_hw *hw,
-		  struct sk_buff *skb, struct ieee80211_tx_control *ctl)
+static int b43_op_tx(struct ieee80211_hw *hw,
+		     struct sk_buff *skb,
+		     struct ieee80211_tx_control *ctl)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -2505,21 +2506,21 @@ static int b43_tx(struct ieee80211_hw *h
 		spin_unlock_irqrestore(&wl->irq_lock, flags);
 	} else
 		err = b43_dma_tx(dev, skb, ctl);
-      out:
+out:
 	if (unlikely(err))
 		return NETDEV_TX_BUSY;
 	return NETDEV_TX_OK;
 }
 
-static int b43_conf_tx(struct ieee80211_hw *hw,
-		       int queue,
-		       const struct ieee80211_tx_queue_params *params)
+static int b43_op_conf_tx(struct ieee80211_hw *hw,
+			  int queue,
+			  const struct ieee80211_tx_queue_params *params)
 {
 	return 0;
 }
 
-static int b43_get_tx_stats(struct ieee80211_hw *hw,
-			    struct ieee80211_tx_queue_stats *stats)
+static int b43_op_get_tx_stats(struct ieee80211_hw *hw,
+			       struct ieee80211_tx_queue_stats *stats)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -2537,12 +2538,12 @@ static int b43_get_tx_stats(struct ieee8
 		err = 0;
 	}
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
-      out:
+out:
 	return err;
 }
 
-static int b43_get_stats(struct ieee80211_hw *hw,
-			 struct ieee80211_low_level_stats *stats)
+static int b43_op_get_stats(struct ieee80211_hw *hw,
+			    struct ieee80211_low_level_stats *stats)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	unsigned long flags;
@@ -2695,7 +2696,7 @@ static int b43_antenna_from_ieee80211(u8
 	}
 }
 
-static int b43_dev_config(struct ieee80211_hw *hw, struct ieee80211_conf *conf)
+static int b43_op_config(struct ieee80211_hw *hw, struct ieee80211_conf *conf)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev;
@@ -2800,7 +2801,7 @@ static int b43_dev_config(struct ieee802
 	return err;
 }
 
-static int b43_dev_set_key(struct ieee80211_hw *hw, enum set_key_cmd cmd,
+static int b43_op_set_key(struct ieee80211_hw *hw, enum set_key_cmd cmd,
 			   const u8 *local_addr, const u8 *addr,
 			   struct ieee80211_key_conf *key)
 {
@@ -2893,7 +2894,6 @@ BUG_ON(!key);
 out_unlock:
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
 	mutex_unlock(&wl->mutex);
-out:
 	if (!err) {
 		b43dbg(wl, "%s hardware based encryption for keyidx: %d, "
 		       "mac: %s\n",
@@ -2903,9 +2903,9 @@ out:
 	return err;
 }
 
-static void b43_configure_filter(struct ieee80211_hw *hw,
-				 unsigned int changed, unsigned int *fflags,
-				 int mc_count, struct dev_addr_list *mc_list)
+static void b43_op_configure_filter(struct ieee80211_hw *hw,
+				    unsigned int changed, unsigned int *fflags,
+				    int mc_count, struct dev_addr_list *mc_list)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -2940,8 +2940,9 @@ static void b43_configure_filter(struct 
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
 }
 
-static int b43_config_interface(struct ieee80211_hw *hw,
-				int if_id, struct ieee80211_if_conf *conf)
+static int b43_op_config_interface(struct ieee80211_hw *hw,
+				   int if_id,
+				   struct ieee80211_if_conf *conf)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -3427,8 +3428,8 @@ static int b43_wireless_core_init(struct
 	return err;
 }
 
-static int b43_add_interface(struct ieee80211_hw *hw,
-			     struct ieee80211_if_init_conf *conf)
+static int b43_op_add_interface(struct ieee80211_hw *hw,
+				struct ieee80211_if_init_conf *conf)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev;
@@ -3467,8 +3468,8 @@ static int b43_add_interface(struct ieee
 	return err;
 }
 
-static void b43_remove_interface(struct ieee80211_hw *hw,
-				 struct ieee80211_if_init_conf *conf)
+static void b43_op_remove_interface(struct ieee80211_hw *hw,
+				    struct ieee80211_if_init_conf *conf)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -3492,7 +3493,7 @@ static void b43_remove_interface(struct 
 	mutex_unlock(&wl->mutex);
 }
 
-static int b43_start(struct ieee80211_hw *hw)
+static int b43_op_start(struct ieee80211_hw *hw)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -3523,7 +3524,7 @@ static int b43_start(struct ieee80211_hw
 	return err;
 }
 
-static void b43_stop(struct ieee80211_hw *hw)
+static void b43_op_stop(struct ieee80211_hw *hw)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
@@ -3556,18 +3557,18 @@ out_unlock:
 }
 
 static const struct ieee80211_ops b43_hw_ops = {
-	.tx			= b43_tx,
-	.conf_tx		= b43_conf_tx,
-	.add_interface		= b43_add_interface,
-	.remove_interface	= b43_remove_interface,
-	.config			= b43_dev_config,
-	.config_interface	= b43_config_interface,
-	.configure_filter	= b43_configure_filter,
-	.set_key		= b43_dev_set_key,
-	.get_stats		= b43_get_stats,
-	.get_tx_stats		= b43_get_tx_stats,
-	.start			= b43_start,
-	.stop			= b43_stop,
+	.tx			= b43_op_tx,
+	.conf_tx		= b43_op_conf_tx,
+	.add_interface		= b43_op_add_interface,
+	.remove_interface	= b43_op_remove_interface,
+	.config			= b43_op_config,
+	.config_interface	= b43_op_config_interface,
+	.configure_filter	= b43_op_configure_filter,
+	.set_key		= b43_op_set_key,
+	.get_stats		= b43_op_get_stats,
+	.get_tx_stats		= b43_op_get_tx_stats,
+	.start			= b43_op_start,
+	.stop			= b43_op_stop,
 	.set_retry_limit	= b43_op_set_retry_limit,
 };
 


From mb at bu3sch.de  Sun Oct 28 17:27:10 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 17:27:10 +0100
Subject: [PATCH] b43: Fix rfkill callback deadlock
Message-ID: <200710281727.10446.mb@bu3sch.de>

wl->mutex might already be locked on initialization.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

Index: wireless-2.6/drivers/net/wireless/b43/rfkill.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/b43/rfkill.c	2007-10-27 13:28:16.000000000 +0200
+++ wireless-2.6/drivers/net/wireless/b43/rfkill.c	2007-10-28 17:13:55.000000000 +0100
@@ -61,15 +61,22 @@ static void b43_rfkill_poll(struct input
 		mutex_unlock(&wl->mutex);
 }
 
-/* Called when the RFKILL toggled in software.
- * This is called without locking. */
+/* Called when the RFKILL toggled in software. */
 static int b43_rfkill_soft_toggle(void *data, enum rfkill_state state)
 {
 	struct b43_wldev *dev = data;
 	struct b43_wl *wl = dev->wl;
 	int err = 0;
 
-	mutex_lock(&wl->mutex);
+	/* When RFKILL is registered, it will call back into this callback.
+	 * wl->mutex will already be locked when this happens.
+	 * So first trylock. On contention check if we are in initialization.
+	 * Silently return if that happens to avoid a deadlock. */
+	if (mutex_trylock(&wl->mutex) == 0) {
+		if (b43_status(dev) < B43_STAT_INITIALIZED)
+			return 0;
+		mutex_lock(&wl->mutex);
+	}
 	if (b43_status(dev) < B43_STAT_INITIALIZED)
 		goto out_unlock;
 
@@ -89,7 +96,6 @@ static int b43_rfkill_soft_toggle(void *
 			b43_radio_turn_off(dev, 0);
 		break;
 	}
-
 out_unlock:
 	mutex_unlock(&wl->mutex);
 


From mb at bu3sch.de  Sun Oct 28 21:08:51 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 21:08:51 +0100
Subject: [PATCH] b43legacy: Remove set_key callback
Message-ID: <200710282108.52078.mb@bu3sch.de>

We don't need the set_key callback, as we don't do hw crypto.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

Index: linux-2.6/drivers/net/wireless/b43legacy/main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/b43legacy/main.c
+++ linux-2.6/drivers/net/wireless/b43legacy/main.c
@@ -2603,32 +2603,6 @@ out_unlock_mutex:
 	return err;
 }
 
-static int b43legacy_dev_set_key(struct ieee80211_hw *hw,
-				 enum set_key_cmd cmd,
-				 const u8 *local_addr, const u8 *addr,
-				 struct ieee80211_key_conf *key)
-{
-	struct b43legacy_wl *wl = hw_to_b43legacy_wl(hw);
-	struct b43legacy_wldev *dev = wl->current_dev;
-	unsigned long flags;
-	int err = -EOPNOTSUPP;
-	DECLARE_MAC_BUF(mac);
-
-	if (!dev)
-		return -ENODEV;
-	mutex_lock(&wl->mutex);
-	spin_lock_irqsave(&wl->irq_lock, flags);
-
-	if (b43legacy_status(dev) < B43legacy_STAT_INITIALIZED) {
-		err = -ENODEV;
-	}
-	spin_unlock_irqrestore(&wl->irq_lock, flags);
-	mutex_unlock(&wl->mutex);
-	b43legacydbg(wl, "Using software based encryption for "
-		     "mac: %s\n", print_mac(mac, addr));
-	return err;
-}
-
 static void b43legacy_configure_filter(struct ieee80211_hw *hw,
 				       unsigned int changed,
 				       unsigned int *fflags,
@@ -3284,7 +3258,6 @@ static const struct ieee80211_ops b43leg
 	.remove_interface = b43legacy_remove_interface,
 	.config = b43legacy_dev_config,
 	.config_interface = b43legacy_config_interface,
-	.set_key = b43legacy_dev_set_key,
 	.configure_filter = b43legacy_configure_filter,
 	.get_stats = b43legacy_get_stats,
 	.get_tx_stats = b43legacy_get_tx_stats,

-- 
Greetings Michael.


From mgerdau at tiscali.de  Sun Oct 28 22:50:12 2007
From: mgerdau at tiscali.de (Michael Gerdau)
Date: Sun, 28 Oct 2007 23:50:12 +0200
Subject: What to do to add support for BCM4328 to the b43 module
Message-ID: <200710282250.25779.mgerdau@tiscali.de>

Hi,

I have a Dell XPS M1710 which sports a BCM4328. I have it working by means
of ndiswrapper but would have rather have it supported by the b43 module.

What could I do to help here ?
Note I never wrote a linux driver and am not sure I'm up to the task.
Neither have I any documentation w/r to that chip.

I'm happy to apply and try whatever patches are sent to me, both for
trying actual driver patches as well as stuff to help reverse engineering.

 I'm also willing (though not sure whether I sport the required skills)
to try to learn how to write the driver myself but I'm sure I'd need
some help to get me started.

Best,
Michael
-- 
 Vote against SPAM - see http://www.politik-digital.de/spam/
 Michael Gerdau       email: mgerdau at tiscali.de
 GPG-keys available on request or at public keyserver
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 194 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071028/b76010ad/attachment.pgp>

From mb at bu3sch.de  Sun Oct 28 23:05:18 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Oct 2007 23:05:18 +0100
Subject: What to do to add support for BCM4328 to the b43 module
In-Reply-To: <200710282250.25779.mgerdau@tiscali.de>
References: <200710282250.25779.mgerdau@tiscali.de>
Message-ID: <200710282305.18918.mb@bu3sch.de>

On Sunday 28 October 2007 22:50:12 Michael Gerdau wrote:
> Hi,
> 
> I have a Dell XPS M1710 which sports a BCM4328. I have it working by means
> of ndiswrapper but would have rather have it supported by the b43 module.
> 
> What could I do to help here ?
> Note I never wrote a linux driver and am not sure I'm up to the task.
> Neither have I any documentation w/r to that chip.
> 
> I'm happy to apply and try whatever patches are sent to me, both for
> trying actual driver patches as well as stuff to help reverse engineering.
> 
>  I'm also willing (though not sure whether I sport the required skills)
> to try to learn how to write the driver myself but I'm sure I'd need
> some help to get me started.

If you want to help, you should join the reverse engineering team.
Implementing the driver is not the problem. Creating the specifications
by reverse engineering is the bigger problem where people are needed.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Oct 28 23:15:21 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Oct 2007 17:15:21 -0500
Subject: What to do to add support for BCM4328 to the b43 module
In-Reply-To: <200710282250.25779.mgerdau@tiscali.de>
References: <200710282250.25779.mgerdau@tiscali.de>
Message-ID: <472509F9.8020509@lwfinger.net>

Michael Gerdau wrote:
> Hi,
> 
> I have a Dell XPS M1710 which sports a BCM4328. I have it working by means
> of ndiswrapper but would have rather have it supported by the b43 module.
> 
> What could I do to help here ?
> Note I never wrote a linux driver and am not sure I'm up to the task.
> Neither have I any documentation w/r to that chip.
> 
> I'm happy to apply and try whatever patches are sent to me, both for
> trying actual driver patches as well as stuff to help reverse engineering.
> 
>  I'm also willing (though not sure whether I sport the required skills)
> to try to learn how to write the driver myself but I'm sure I'd need
> some help to get me started.
> 

You need to supply the info output to the logs by ssb and b43 regarding the revision numbers of the
various cores, the PHY, and the radio. The output of 'dmesg | grep ssb' and 'dmesg | grep b43' will
be quite helpful.

Larry




From identd_ at hotmail.com  Sun Oct 28 23:37:10 2007
From: identd_ at hotmail.com (David Ellingsworth)
Date: Sun, 28 Oct 2007 18:37:10 -0400
Subject: [PATCH] b43: Fix rfkill callback deadlock
In-Reply-To: <200710281727.10446.mb@bu3sch.de>
References: <200710281727.10446.mb@bu3sch.de>
Message-ID: <BAY128-W103B5B56932F2A06079C3886900@phx.gbl>

> From: mb at bu3sch.de> To: linville at tuxdriver.com> Subject: [PATCH] b43: Fix rfkill callback deadlock> Date: Sun, 28 Oct 2007 17:27:10 +0100> CC: linux-wireless at vger.kernel.org; bcm43xx-dev at lists.berlios.de; Larry.Finger at lwfinger.net> > wl->mutex might already be locked on initialization.> > Signed-off-by: Michael Buesch <mb at bu3sch.de>> > Index: wireless-2.6/drivers/net/wireless/b43/rfkill.c> ===================================================================> --- wireless-2.6.orig/drivers/net/wireless/b43/rfkill.c 2007-10-27 13:28:16.000000000 +0200> +++ wireless-2.6/drivers/net/wireless/b43/rfkill.c 2007-10-28 17:13:55.000000000 +0100> @@ -61,15 +61,22 @@ static void b43_rfkill_poll(struct input> mutex_unlock(&wl->mutex);> }> > -/* Called when the RFKILL toggled in software.> - * This is called without locking. */> +/* Called when the RFKILL toggled in software. */> static int b43_rfkill_soft_toggle(void *data, enum rfkill_state state)> {> struct b43_wldev *dev = data;> struct b43_wl *wl = dev->wl;> int err = 0;> > - mutex_lock(&wl->mutex);> + /* When RFKILL is registered, it will call back into this callback.> + * wl->mutex will already be locked when this happens.> + * So first trylock. On contention check if we are in initialization.> + * Silently return if that happens to avoid a deadlock. */> + if (mutex_trylock(&wl->mutex) == 0) {> + if (b43_status(dev) < B43_STAT_INITIALIZED)> + return 0;> + mutex_lock(&wl->mutex);> + }> if (b43_status(dev) < B43_STAT_INITIALIZED)> goto out_unlock;
Why not replace the above lines up to and including "- mutex_loc(&wl->mutext);" with:
 
if(b43_status(dev) < B43_STAT_INITIALIZED)
    return 0;
 
mutex_lock(&wl->mutex)> > @@ -89,7 +96,6 @@ static int b43_rfkill_soft_toggle(void *> b43_radio_turn_off(dev, 0);> break;> }> -> out_unlock:> mutex_unlock(&wl->mutex);> > _______________________________________________> Bcm43xx-dev mailing list> Bcm43xx-dev at lists.berlios.de> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
_________________________________________________________________
Boo!?Scare away worms, viruses and so much more! Try Windows Live OneCare!
http://onecare.live.com/standard/en-us/purchase/trial.aspx?s_cid=wl_hotmailnews
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071028/e6963dd1/attachment.html>

From mb at bu3sch.de  Mon Oct 29 00:37:31 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 29 Oct 2007 00:37:31 +0100
Subject: [PATCH] b43: Fix rfkill callback deadlock
In-Reply-To: <BAY128-W103B5B56932F2A06079C3886900@phx.gbl>
References: <200710281727.10446.mb@bu3sch.de>
	<BAY128-W103B5B56932F2A06079C3886900@phx.gbl>
Message-ID: <200710290037.32164.mb@bu3sch.de>

On Sunday 28 October 2007 23:37:10 David Ellingsworth wrote:
> > From: mb at bu3sch.de> To: linville at tuxdriver.com> Subject: [PATCH] b43: Fix rfkill callback deadlock> Date: Sun, 28 Oct 2007 17:27:10 +0100> CC: linux-wireless at vger.kernel.org; bcm43xx-dev at lists.berlios.de; Larry.Finger at lwfinger.net> > wl->mutex might already be locked on initialization.> > Signed-off-by: Michael Buesch <mb at bu3sch.de>> > Index: wireless-2.6/drivers/net/wireless/b43/rfkill.c> ===================================================================> --- wireless-2.6.orig/drivers/net/wireless/b43/rfkill.c 2007-10-27 13:28:16.000000000 +0200> +++ wireless-2.6/drivers/net/wireless/b43/rfkill.c 2007-10-28 17:13:55.000000000 +0100> @@ -61,15 +61,22 @@ static void b43_rfkill_poll(struct input> mutex_unlock(&wl->mutex);> }> > -/* Called when the RFKILL toggled in software.> - * This is called without locking. */> +/* Called when the RFKILL toggled in software. */> static int b43_rfkill_soft_toggle(void *data, enum rfkill_state state)> {> struct b43_wldev *dev = data;> struct b43_wl *wl = dev->wl;> int err = 0;> > - mutex_lock(&wl->mutex);> + /* When RFKILL is registered, it will call back into this callback.> + * wl->mutex will already be locked when this happens.> + * So first trylock. On contention check if we are in initialization.> + * Silently return if that happens to avoid a deadlock. */> + if (mutex_trylock(&wl->mutex) == 0) {> + if (b43_status(dev) < B43_STAT_INITIALIZED)> + return 0;> + mutex_lock(&wl->mutex);> + }> if (b43_status(dev) < B43_STAT_INITIALIZED)> goto out_unlock;
> Why not replace the above lines up to and including "- mutex_loc(&wl->mutext);" with:
>  
> if(b43_status(dev) < B43_STAT_INITIALIZED)
>     return 0;
>  
> mutex_lock(&wl->mutex)> > @@ -89,7 +96,6 @@ static int b43_rfkill_soft_toggle(void *> b43_radio_turn_off(dev, 0);> break;> }> -> out_unlock:> mutex_unlock(&wl->mutex);> > _______________________________________________> Bcm43xx-dev mailing list> Bcm43xx-dev at lists.berlios.de> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> _________________________________________________________________
> Boo!?Scare away worms, viruses and so much more! Try Windows Live OneCare!
> http://onecare.live.com/standard/en-us/purchase/trial.aspx?s_cid=wl_hotmailnews

I'm sorry. Your mailer completely fucked up the context
so I'm not really able to see what you want to tell me.

-- 
Greetings Michael.

From identd_ at hotmail.com  Mon Oct 29 01:06:51 2007
From: identd_ at hotmail.com (David Ellingsworth)
Date: Sun, 28 Oct 2007 20:06:51 -0400
Subject: [PATCH] b43: Fix rfkill callback deadlock
Message-ID: <BAY128-W43EAEA5B4CCD7A448326E286910@phx.gbl>


Sorry, hopefully its readable this time.

> From: mb at bu3sch.de
> To: linville at tuxdriver.com
> Subject: [PATCH] b43: Fix rfkill callback deadlock
> Date: Sun, 28 Oct 2007 17:27:10 +0100
> CC: linux-wireless at vger.kernel.org; bcm43xx-dev at lists.berlios.de; Larry.Finger at lwfinger.net
>
> wl->mutex might already be locked on initialization.
>
> Signed-off-by: Michael Buesch 
>
> Index: wireless-2.6/drivers/net/wireless/b43/rfkill.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/b43/rfkill.c 2007-10-27 13:28:16.000000000 +0200
> +++ wireless-2.6/drivers/net/wireless/b43/rfkill.c 2007-10-28 17:13:55.000000000 +0100
> @@ -61,15 +61,22 @@ static void b43_rfkill_poll(struct input
> mutex_unlock(&wl->mutex);
> }
>
> -/* Called when the RFKILL toggled in software.
> - * This is called without locking. */
> +/* Called when the RFKILL toggled in software. */
> static int b43_rfkill_soft_toggle(void *data, enum rfkill_state state)
> {
> struct b43_wldev *dev = data;
> struct b43_wl *wl = dev->wl;
> int err = 0;
>
> - mutex_lock(&wl->mutex);
> + /* When RFKILL is registered, it will call back into this callback.
> + * wl->mutex will already be locked when this happens.
> + * So first trylock. On contention check if we are in initialization.
> + * Silently return if that happens to avoid a deadlock. */
> + if (mutex_trylock(&wl->mutex) == 0) {
> + if (b43_status(dev) < B43_STAT_INITIALIZED)
> + return 0;
> + mutex_lock(&wl->mutex);
> + }
> if (b43_status(dev) < B43_STAT_INITIALIZED)
> goto out_unlock;
Why not replace everything above up to and including the "- mutex_lock(&wl->mutex); with:

if(b43_status(dev) < B43_STAT_INITIALIZED)
    return 0;

mutex_lock(&wl->mutex);
>
> @@ -89,7 +96,6 @@ static int b43_rfkill_soft_toggle(void *
> b43_radio_turn_off(dev, 0);
> break;
> }
> -
> out_unlock:
> mutex_unlock(&wl->mutex);
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev

_________________________________________________________________
Peek-a-boo FREE Tricks & Treats for You!
http://www.reallivemoms.com?ocid=TXT_TAGHM&loc=us

From mb at bu3sch.de  Mon Oct 29 01:16:05 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 29 Oct 2007 01:16:05 +0100
Subject: [PATCH] b43: Fix rfkill callback deadlock
In-Reply-To: <BAY128-W43EAEA5B4CCD7A448326E286910@phx.gbl>
References: <BAY128-W43EAEA5B4CCD7A448326E286910@phx.gbl>
Message-ID: <200710290116.05945.mb@bu3sch.de>

On Monday 29 October 2007 01:06:51 David Ellingsworth wrote:
> > - mutex_lock(&wl->mutex);
> > + /* When RFKILL is registered, it will call back into this callback.
> > + * wl->mutex will already be locked when this happens.
> > + * So first trylock. On contention check if we are in initialization.
> > + * Silently return if that happens to avoid a deadlock. */
> > + if (mutex_trylock(&wl->mutex) == 0) {
> > + if (b43_status(dev) < B43_STAT_INITIALIZED)
> > + return 0;
> > + mutex_lock(&wl->mutex);
> > + }
> > if (b43_status(dev) < B43_STAT_INITIALIZED)
> > goto out_unlock;
> Why not replace everything above up to and including the "- mutex_lock(&wl->mutex); with:
> 
> if(b43_status(dev) < B43_STAT_INITIALIZED)
>     return 0;
> 
> mutex_lock(&wl->mutex);

because the status should be queried under lock, of course.


-- 
Greetings Michael.


From rdeaster at wbs.edu  Mon Oct 29 01:23:03 2007
From: rdeaster at wbs.edu (Robert Easter)
Date: Sun, 28 Oct 2007 19:23:03 -0500
Subject: Kubuntu on an Acer
In-Reply-To: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>
Message-ID: <472527E7.6040806@wbs.edu>

Here's one for the scrapbook, though hopefully not for the scrap yard-

New install of Kubuntu 7.10- has a gui install set up for the Broadcom 
drivers, etc.  Very nice, if it worked.  Any suggestions on how to find 
the glitch, or best ways to totally replace the dead code with some that 
works?  Details:


00:00.0 Host bridge: Intel Corporation Mobile 945GM/PM/GMS, 943/940GML 
and 945GT Express Memory Controller Hub (rev 03)
00:02.0 VGA compatible controller: Intel Corporation Mobile 945GM/GMS, 
943/940GML Express Integrated Graphics Controller (rev 03)
00:02.1 Display controller: Intel Corporation Mobile 945GM/GMS/GME, 
943/940GML Express Integrated Graphics Controller (rev 03)
00:1b.0 Audio device: Intel Corporation 82801G (ICH7 Family) High 
Definition Audio Controller (rev 02)
00:1c.0 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
Port 1 (rev 02)
00:1c.1 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
Port 2 (rev 02)
00:1c.2 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
Port 3 (rev 02)
00:1d.0 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
Controller #1 (rev 02)
00:1d.1 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
Controller #2 (rev 02)
00:1d.2 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
Controller #3 (rev 02)
00:1d.3 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
Controller #4 (rev 02)
00:1d.7 USB Controller: Intel Corporation 82801G (ICH7 Family) USB2 EHCI 
Controller (rev 02)
00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev e2)
00:1f.0 ISA bridge: Intel Corporation 82801GBM (ICH7-M) LPC Interface 
Bridge (rev 02)
00:1f.2 IDE interface: Intel Corporation 82801GBM/GHM (ICH7 Family) SATA 
IDE Controller (rev 02)
00:1f.3 SMBus: Intel Corporation 82801G (ICH7 Family) SMBus Controller 
(rev 02)
02:00.0 Ethernet controller: Marvell Technology Group Ltd. 88E8038 PCI-E 
Fast Ethernet Controller (rev 14)
0a:03.0 Network controller: Broadcom Corporation BCM4318 [AirForce One 
54g] 802.11g Wireless LAN Controller (rev 02)
0a:09.0 CardBus bridge: Texas Instruments PCIxx12 Cardbus Controller
0a:09.2 Mass storage controller: Texas Instruments 5-in-1 Multimedia 
Card Reader (SD/MMC/MS/MS PRO/xD)




From proski at gnu.org  Mon Oct 29 01:57:01 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sun, 28 Oct 2007 20:57:01 -0400
Subject: Kubuntu on an Acer
In-Reply-To: <472527E7.6040806@wbs.edu>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>
	<472527E7.6040806@wbs.edu>
Message-ID: <1193619421.30862.17.camel@dv>


On Sun, 2007-10-28 at 19:23 -0500, Robert Easter wrote:
> Here's one for the scrapbook, though hopefully not for the scrap yard-
> 
> New install of Kubuntu 7.10- has a gui install set up for the Broadcom 
> drivers, etc.  Very nice, if it worked.  Any suggestions on how to find 
> the glitch, or best ways to totally replace the dead code with some that 
> works?  Details:

Most likely you don't have the firmware.  Please try:

aptitude install bcm43xx-fwcutter

That should download and install the firmware upon install.  If you
cannot get that system online at all, you can get bcm43xx-fwcutter from
http://linuxwireless.org/en/users/Drivers/b43 and follow the
instructions how to extract the firmware.  Then transfer it to the
laptop.

If the problems persist, please check the kernel messages with "dmesg".
You may also want to find out which driver you are using by running:

lsmod |grep -E '(b43|bcm43)'

If you are using b43 or b43legacy, you'll need b43-fwcutter, which
creates slightly different firmware files.

-- 
Regards,
Pavel Roskin



From larry.finger at lwfinger.net  Mon Oct 29 02:04:29 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Oct 2007 20:04:29 -0500
Subject: Kubuntu on an Acer
In-Reply-To: <472527E7.6040806@wbs.edu>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>
	<472527E7.6040806@wbs.edu>
Message-ID: <4725319D.3050400@lwfinger.net>

Robert Easter wrote:
> Here's one for the scrapbook, though hopefully not for the scrap yard-
> 
> New install of Kubuntu 7.10- has a gui install set up for the Broadcom 
> drivers, etc.  Very nice, if it worked.  Any suggestions on how to find 
> the glitch, or best ways to totally replace the dead code with some that 
> works?  Details:
> 
> 
> 00:00.0 Host bridge: Intel Corporation Mobile 945GM/PM/GMS, 943/940GML 
> and 945GT Express Memory Controller Hub (rev 03)
> 00:02.0 VGA compatible controller: Intel Corporation Mobile 945GM/GMS, 
> 943/940GML Express Integrated Graphics Controller (rev 03)
> 00:02.1 Display controller: Intel Corporation Mobile 945GM/GMS/GME, 
> 943/940GML Express Integrated Graphics Controller (rev 03)
> 00:1b.0 Audio device: Intel Corporation 82801G (ICH7 Family) High 
> Definition Audio Controller (rev 02)
> 00:1c.0 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
> Port 1 (rev 02)
> 00:1c.1 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
> Port 2 (rev 02)
> 00:1c.2 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express 
> Port 3 (rev 02)
> 00:1d.0 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
> Controller #1 (rev 02)
> 00:1d.1 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
> Controller #2 (rev 02)
> 00:1d.2 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
> Controller #3 (rev 02)
> 00:1d.3 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI 
> Controller #4 (rev 02)
> 00:1d.7 USB Controller: Intel Corporation 82801G (ICH7 Family) USB2 EHCI 
> Controller (rev 02)
> 00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev e2)
> 00:1f.0 ISA bridge: Intel Corporation 82801GBM (ICH7-M) LPC Interface 
> Bridge (rev 02)
> 00:1f.2 IDE interface: Intel Corporation 82801GBM/GHM (ICH7 Family) SATA 
> IDE Controller (rev 02)
> 00:1f.3 SMBus: Intel Corporation 82801G (ICH7 Family) SMBus Controller 
> (rev 02)
> 02:00.0 Ethernet controller: Marvell Technology Group Ltd. 88E8038 PCI-E 
> Fast Ethernet Controller (rev 14)
> 0a:03.0 Network controller: Broadcom Corporation BCM4318 [AirForce One 
> 54g] 802.11g Wireless LAN Controller (rev 02)
> 0a:09.0 CardBus bridge: Texas Instruments PCIxx12 Cardbus Controller
> 0a:09.2 Mass storage controller: Texas Instruments 5-in-1 Multimedia 
> Card Reader (SD/MMC/MS/MS PRO/xD)

What glitch? You didn't give us any information.

I would guess (you force me to) that the firmware has not been installed. Go to
http://linuxwireless.org/en/users/Drivers/b43 and download V3 firmware and bcm43xx-fwcutter from the
links that are provided. Your 4318 should work. Mine does.

For copyright reasons, neither we nor any distro can distribute firmware.

Larry


From rdeaster at wbs.edu  Mon Oct 29 04:12:16 2007
From: rdeaster at wbs.edu (Robert Easter)
Date: Sun, 28 Oct 2007 22:12:16 -0500
Subject: Kubuntu on an Acer
In-Reply-To: <1193619421.30862.17.camel@dv>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>	
	<472527E7.6040806@wbs.edu> <1193619421.30862.17.camel@dv>
Message-ID: <47254F90.5070004@wbs.edu>

Maybe not as complex as I thought.  I had gone through several Ubuntu 
installs this week before settling with this one (Kubuntu 7.10 
Desktop).  On the gnome-flavored version the firmware supposedly  
installed but "saw" but never met the routers, then lost the signals 
altogether.  Anyway, with this one the cutter was  not installed but 
should be now.  Still can't find the wireless signal.  The dmesg output 
follows:

[    3.804000] PCI: Setting latency timer of device 0000:00:1d.3 to 64
[    3.804000] uhci_hcd 0000:00:1d.3: UHCI Host Controller
[    3.804000] uhci_hcd 0000:00:1d.3: new USB bus registered, assigned 
bus number 4
[    3.804000] uhci_hcd 0000:00:1d.3: irq 16, io base 0x00001880
[    3.804000] usb usb4: configuration #1 chosen from 1 choice
[    3.804000] hub 4-0:1.0: USB hub found
[    3.804000] hub 4-0:1.0: 2 ports detected
[    3.908000] ata_piix 0000:00:1f.2: version 2.11
[    3.908000] ata_piix 0000:00:1f.2: MAP [ P0 P2 IDE IDE ]
[    4.000000] Clocksource tsc unstable (delta = -108048632 ns)
[    4.064000] ACPI: PCI Interrupt 0000:00:1f.2[B] -> GSI 19 (level, 
low) -> IRQ 21
[    4.064000] PCI: Setting latency timer of device 0000:00:1f.2 to 64
[    4.064000] scsi0 : ata_piix
[    4.064000] scsi1 : ata_piix
[    4.064000] ata1: SATA max UDMA/133 cmd 0x000101f0 ctl 0x000103f6 
bmdma 0x000118b0 irq 14
[    4.064000] ata2: PATA max UDMA/100 cmd 0x00010170 ctl 0x00010376 
bmdma 0x000118b8 irq 15
[    4.260000] ata1.00: ATA-7: WDC WD800BEVS-22RST0, 04.01G04, max UDMA/133
[    4.260000] ata1.00: 156301488 sectors, multi 16: LBA48 NCQ (depth 0/32)
[    4.276000] ata1.00: configured for UDMA/133
[    4.596000] ata2.00: ATAPI: Optiarc CD-RW CRX880A, KX07, max UDMA/33
[    4.768000] ata2.00: configured for UDMA/33
[    4.768000] scsi 0:0:0:0: Direct-Access     ATA      WDC WD800BEVS-22 
04.0 PQ: 0 ANSI: 5
[    4.768000] scsi 1:0:0:0: CD-ROM            Optiarc  CD-RW CRX880A    
KX07 PQ: 0 ANSI: 5
[    4.768000] ACPI: PCI Interrupt 0000:00:1d.7[A] -> GSI 23 (level, 
low) -> IRQ 20
[    4.768000] PCI: Setting latency timer of device 0000:00:1d.7 to 64
[    4.768000] ehci_hcd 0000:00:1d.7: EHCI Host Controller
[    4.768000] ehci_hcd 0000:00:1d.7: new USB bus registered, assigned 
bus number 5
[    4.768000] ehci_hcd 0000:00:1d.7: debug port 1
[    4.768000] PCI: cache line size of 32 is not supported by device 
0000:00:1d.7
[    4.768000] ehci_hcd 0000:00:1d.7: irq 20, io mem 0xd0544000
[    4.772000] ehci_hcd 0000:00:1d.7: USB 2.0 started, EHCI 1.00, driver 
10 Dec 2004
[    4.772000] usb usb5: configuration #1 chosen from 1 choice
[    4.772000] hub 5-0:1.0: USB hub found
[    4.772000] hub 5-0:1.0: 8 ports detected
[    4.784000] sd 0:0:0:0: [sda] 156301488 512-byte hardware sectors 
(80026 MB)
[    4.784000] sd 0:0:0:0: [sda] Write Protect is off
[    4.784000] sd 0:0:0:0: [sda] Mode Sense: 00 3a 00 00
[    4.788000] sd 0:0:0:0: [sda] Write cache: enabled, read cache: 
enabled, doesn't support DPO or FUA
[    4.788000] sd 0:0:0:0: [sda] 156301488 512-byte hardware sectors 
(80026 MB)
[    4.788000] sd 0:0:0:0: [sda] Write Protect is off
[    4.788000] sd 0:0:0:0: [sda] Mode Sense: 00 3a 00 00
[    4.788000] sd 0:0:0:0: [sda] Write cache: enabled, read cache: 
enabled, doesn't support DPO or FUA
[    4.788000]  sda: sda1 sda2 sda3
[    4.868000] sd 0:0:0:0: [sda] Attached SCSI disk
[    4.872000] sd 0:0:0:0: Attached scsi generic sg0 type 0
[    4.872000] scsi 1:0:0:0: Attached scsi generic sg1 type 5
[    4.888000] sr0: scsi3-mmc drive: 24x/24x writer cd/rw xa/form2 cdda tray
[    4.888000] Uniform CD-ROM driver Revision: 3.20
[    4.888000] sr 1:0:0:0: Attached scsi CD-ROM sr0
[    5.128000] Attempting manual resume
[    5.128000] swsusp: Resume From Partition 8:3
[    5.128000] PM: Checking swsusp image.
[    5.128000] PM: Resume from disk failed.
[    5.180000] kjournald starting.  Commit interval 5 seconds
[    5.180000] EXT3-fs: mounted filesystem with ordered data mode.
[   11.588000] Linux agpgart interface v0.102 (c) Dave Jones
[   11.736000] pci_hotplug: PCI Hot Plug PCI Core version: 0.5
[   11.736000] shpchp: Standard Hot Plug PCI Controller Driver version: 0.4
[   11.776000] agpgart: Detected an Intel 945GM Chipset.
[   11.776000] agpgart: Detected 7932K stolen memory.
[   11.792000] agpgart: AGP aperture is 256M @ 0xc0000000
[   12.728000] PCI: Enabling device 0000:02:00.0 (0000 -> 0003)
[   12.728000] ACPI: PCI Interrupt 0000:02:00.0[A] -> GSI 16 (level, 
low) -> IRQ 16
[   12.728000] PCI: Setting latency timer of device 0000:02:00.0 to 64
[   12.728000] sky2 0000:02:00.0: v1.18 addr 0x34000000 irq 16 Yukon-FE 
(0xb7) rev 1
[   12.728000] sky2 eth0: addr 00:16:36:d6:f3:02
[   12.748000] intel_rng: FWH not detected
[   12.760000] ieee80211_crypt: registered algorithm 'NULL'
[   12.760000] ieee80211: 802.11 data/management/control stack, git-1.1.13
[   12.760000] ieee80211: Copyright (C) 2004-2005 Intel Corporation 
<jketreno at linux.intel.com>
[   12.796000] bcm43xx driver
[   12.796000] ACPI: PCI Interrupt 0000:0a:03.0[A] -> GSI 18 (level, 
low) -> IRQ 18
[   12.888000] ACPI: PCI Interrupt 0000:0a:09.2[A] -> GSI 20 (level, 
low) -> IRQ 19
[   12.928000] iTCO_vendor_support: vendor-support=0
[   12.928000] iTCO_wdt: Intel TCO WatchDog Timer Driver v1.01 (21-Jan-2007)
[   12.932000] Yenta: CardBus bridge found at 0000:0a:09.0 [1025:0110]
[   12.932000] Yenta: Using CSCINT to route CSC interrupts to PCI
[   12.932000] Yenta: Routing CardBus interrupts to PCI
[   12.932000] Yenta TI: socket 0000:0a:09.0, mfunc 0x01321b22, devctl 0x66
[   13.164000] Yenta: ISA IRQ mask 0x0cf8, PCI irq 19
[   13.164000] Socket status: 30000006
[   13.164000] Yenta: Raising subordinate bus# of parent bus (#0a) from 
#0b to #0e
[   13.164000] pcmcia: parent PCI bridge I/O window: 0x3000 - 0x3fff
[   13.164000] cs: IO port probe 0x3000-0x3fff: clean.
[   13.164000] pcmcia: parent PCI bridge Memory window: 0xd0100000 - 
0xd01fffff
[   13.164000] pcmcia: parent PCI bridge Memory window: 0x30000000 - 
0x33ffffff
[   13.304000] ACPI: PCI Interrupt 0000:00:1b.0[A] -> GSI 22 (level, 
low) -> IRQ 22
[   13.304000] PCI: Setting latency timer of device 0000:00:1b.0 to 64
[   13.664000] cs: IO port probe 0x100-0x3af: clean.
[   13.664000] cs: IO port probe 0x3e0-0x4ff: excluding 0x4d0-0x4d7
[   13.664000] cs: IO port probe 0x820-0x8ff: clean.
[   13.668000] cs: IO port probe 0xc00-0xcf7: clean.
[   13.668000] cs: IO port probe 0xa00-0xaff: clean.
[   13.704000] Synaptics Touchpad, model: 1, fw: 6.2, id: 0x1280b1, 
caps: 0xa04713/0x204000
[   13.760000] input: SynPS/2 Synaptics TouchPad as /class/input/input2
[   13.764000] iTCO_wdt: Found a ICH7-M TCO device (Version=2, 
TCOBASE=0x1060)
[   13.764000] iTCO_wdt: initialized. heartbeat=30 sec (nowayout=0)
[   14.000000] lp: driver loaded but no devices found
[   14.048000] Adding 1052248k swap on /dev/sda3.  Priority:-1 extents:1 
across:1052248k
[   14.556000] EXT3 FS on sda1, internal journal
[   15.184000] kjournald starting.  Commit interval 5 seconds
[   15.184000] EXT3 FS on sda2, internal journal
[   15.184000] EXT3-fs: mounted filesystem with ordered data mode.
[   15.932000] ACPI: Battery Slot [BAT1] (battery present)
[   16.216000] ACPI: ACPI Dock Station Driver
[   16.296000] input: Power Button (FF) as /class/input/input3
[   16.300000] ACPI: Power Button (FF) [PWRF]
[   16.340000] input: Lid Switch as /class/input/input4
[   16.344000] ACPI: Lid Switch [LID]
[   16.384000] input: Power Button (CM) as /class/input/input5
[   16.388000] ACPI: Power Button (CM) [PWRB]
[   16.432000] input: Sleep Button (CM) as /class/input/input6
[   16.436000] ACPI: Sleep Button (CM) [SLPB]
[   16.456000] ACPI: AC Adapter [ACAD] (on-line)
[   16.520000] ACPI: Video Device [GFX0] (multi-head: yes  rom: no  
post: no)
[   17.824000] sky2 eth0: enabling interface
[   18.000000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[   18.256000] ppdev: user-space parallel port driver
[   18.496000] audit(1193577841.308:3):  type=1503 
operation="inode_permission" requested_mask="a" denied_mask="a" 
name="/dev/tty" pid=4760 profile="/usr/sbin/cupsd"
[   18.700000] apm: BIOS not found.
[   19.528000] sky2 eth0: Link is up at 100 Mbps, full duplex, flow 
control both
[   20.040000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[   21.684000] [drm] Initialized drm 1.1.0 20060810
[   21.776000] ACPI: PCI Interrupt 0000:00:02.0[A] -> GSI 16 (level, 
low) -> IRQ 16
[   21.776000] [drm] Initialized i915 1.6.0 20060119 on minor 0
[   23.060000] Failure registering capabilities with primary security 
module.
[   23.512000] Bluetooth: Core ver 2.11
[   23.512000] NET: Registered protocol family 31
[   23.512000] Bluetooth: HCI device and connection manager initialized
[   23.512000] Bluetooth: HCI socket layer initialized
[   23.576000] Bluetooth: L2CAP ver 2.8
[   23.576000] Bluetooth: L2CAP socket layer initialized
[   23.660000] Bluetooth: RFCOMM socket layer initialized
[   23.660000] Bluetooth: RFCOMM TTY layer initialized
[   23.660000] Bluetooth: RFCOMM ver 1.8
[   27.984000] NET: Registered protocol family 17
[   29.956000] NET: Registered protocol family 10
[   29.956000] lo: Disabled Privacy Extensions
[   40.340000] eth0: no IPv6 routers present
[   45.852000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[   67.900000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[   89.948000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  111.996000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  134.044000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  156.092000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  278.180000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  400.224000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  522.272000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  644.320000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  766.368000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[  888.420000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1010.468000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1132.524000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1254.572000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1376.636000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1499.024000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1621.072000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1743.120000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1865.168000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 1987.216000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2109.264000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2231.312000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2353.356000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2475.404000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2597.452000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2719.500000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2841.548000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 2963.596000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3085.644000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3207.692000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3329.740000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3451.764000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3573.812000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3695.864000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3817.912000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 3939.964000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4062.020000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4184.068000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4306.112000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4428.160000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4550.208000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4672.252000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4794.300000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 4916.348000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5038.396000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5160.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5282.492000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5404.540000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5526.588000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5568.364000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5648.636000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5770.688000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 5892.736000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6014.784000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6136.828000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6258.876000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6380.924000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6502.988000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6625.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6747.084000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6869.132000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 6991.180000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7113.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7235.300000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7357.348000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7479.396000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7601.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7723.500000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7845.548000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 7967.596000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8089.644000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8211.692000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8333.740000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8455.788000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8577.836000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8699.884000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8821.932000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 8943.980000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9066.028000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9188.076000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9310.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9432.172000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9554.220000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9676.268000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9798.316000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[ 9920.364000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10042.408000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10164.460000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10286.508000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10408.556000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10530.604000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10652.652000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10774.700000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[10896.748000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11018.796000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11140.844000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11262.892000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11384.940000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11506.988000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11629.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11751.084000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11873.132000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[11995.180000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12117.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12239.260000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12361.308000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12483.356000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12605.404000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12727.452000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12849.500000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[12971.548000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13093.596000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13215.644000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13337.692000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13459.740000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13581.788000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13703.836000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13825.884000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[13947.932000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14069.980000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14192.028000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14314.076000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14436.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14558.172000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14680.220000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14802.268000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[14924.380000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15046.440000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15168.928000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15290.980000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15413.032000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15535.080000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15657.128000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15779.176000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[15901.220000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16023.268000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16145.316000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16267.364000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16389.412000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16511.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16633.940000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16755.988000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[16878.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17000.088000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17122.136000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17244.188000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17366.340000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17488.388000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17610.452000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17732.500000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17854.548000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[17976.596000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18098.644000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18220.696000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18342.748000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18464.800000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18586.848000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18708.900000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18830.992000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[18953.048000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19075.140000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19197.400000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19319.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19441.488000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19563.536000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19685.600000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19807.648000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[19929.696000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20051.748000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20173.796000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20295.844000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20417.868000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20539.916000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20661.964000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20784.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[20906.084000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21028.132000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21150.180000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21272.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21394.276000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21516.324000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21638.372000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21760.420000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[21882.472000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22004.520000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22126.592000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22248.640000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22370.688000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22492.744000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22614.796000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22736.844000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22858.892000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[22980.940000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23102.988000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23225.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23347.084000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23469.136000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23591.184000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23713.232000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23835.280000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[23957.328000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24079.376000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24201.836000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24323.888000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24445.940000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24567.968000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24690.024000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24812.072000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[24934.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25056.196000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25178.252000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25300.308000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25422.364000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25544.412000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25666.464000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25788.920000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[25910.972000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26033.020000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26155.072000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26277.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26399.168000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26521.216000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26643.272000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26765.328000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[26887.380000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27009.428000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27131.524000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27254.008000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27376.060000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27498.104000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27620.152000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27742.200000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27864.248000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[27986.296000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28108.344000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28230.392000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28352.440000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28474.488000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28596.536000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28718.584000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28840.632000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[28962.660000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29084.816000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29206.924000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29329.268000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29451.436000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29573.488000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29695.548000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29817.596000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[29939.684000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30061.764000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30183.884000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30305.972000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30428.020000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30550.068000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30672.116000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30794.164000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[30916.212000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31038.260000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31160.308000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31282.356000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31404.408000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31526.456000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31648.504000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31770.944000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[31892.992000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32015.040000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32137.088000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32259.136000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32381.184000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32503.232000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32625.280000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32747.328000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32869.376000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[32991.424000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33113.476000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33235.524000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33357.572000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33479.616000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33601.664000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33723.712000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33845.760000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[33967.980000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34090.132000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34212.352000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34334.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34456.500000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34578.544000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34700.592000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34822.636000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[34944.696000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35066.744000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35188.864000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35310.912000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35432.960000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35555.380000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35677.432000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35799.860000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35821.908000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35843.964000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[35966.012000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36088.056000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36210.104000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36332.168000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36454.216000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36576.264000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36698.312000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36820.360000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[36942.492000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37064.540000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37186.584000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37308.636000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37367.140000] atkbd.c: Unknown key pressed (translated set 2, code 0xf2 
on isa0060/serio0).
[37367.140000] atkbd.c: Use 'setkeycodes e072 <keycode>' to make it known.
[37367.240000] atkbd.c: Unknown key released (translated set 2, code 
0xf2 on isa0060/serio0).
[37367.240000] atkbd.c: Use 'setkeycodes e072 <keycode>' to make it known.
[37431.116000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37553.252000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37675.324000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37684.696000] atkbd.c: Unknown key pressed (translated set 2, code 0xf1 
on isa0060/serio0).
[37684.696000] atkbd.c: Use 'setkeycodes e071 <keycode>' to make it known.
[37684.804000] atkbd.c: Unknown key released (translated set 2, code 
0xf1 on isa0060/serio0).
[37684.804000] atkbd.c: Use 'setkeycodes e071 <keycode>' to make it known.
[37797.416000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[37919.468000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38041.516000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38163.564000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38285.616000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38408.148000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38530.200000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38652.244000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38774.296000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[38896.348000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39018.516000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39140.620000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39262.660000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39384.712000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39506.752000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39628.892000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39750.948000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39873.000000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[39995.052000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40117.096000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40239.164000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40361.216000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40483.264000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40605.324000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40727.368000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40849.420000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[40971.476000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41093.528000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41215.576000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41337.688000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41459.736000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41581.784000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41703.836000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41825.884000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[41947.932000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42069.984000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42192.036000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42314.088000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42436.140000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42558.292000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42680.344000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42802.396000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[42924.444000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43046.508000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43168.560000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43290.608000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43412.660000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43534.708000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43656.756000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43778.808000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[43900.856000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44022.904000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44144.956000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44267.008000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44389.056000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44511.108000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44633.152000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44755.204000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44877.260000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[44999.308000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45121.364000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45243.412000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45365.468000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45487.524000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45609.576000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45731.624000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45853.672000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[45975.724000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46097.776000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46219.832000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46342.004000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46464.316000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46586.536000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46708.608000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46830.788000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[46953.140000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47075.724000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47197.772000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47319.820000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47441.868000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47563.920000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47685.972000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47808.020000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[47930.068000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48052.120000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48174.168000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48296.212000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48418.268000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48540.552000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48662.660000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48784.776000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[48906.828000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49028.964000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49151.040000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49230.084000] atkbd.c: Unknown key pressed (translated set 2, code 0xf2 
on isa0060/serio0).
[49230.084000] atkbd.c: Use 'setkeycodes e072 <keycode>' to make it known.
[49230.188000] atkbd.c: Unknown key released (translated set 2, code 
0xf2 on isa0060/serio0).
[49230.188000] atkbd.c: Use 'setkeycodes e072 <keycode>' to make it known.
[49263.220000] atkbd.c: Unknown key pressed (translated set 2, code 0xf1 
on isa0060/serio0).
[49263.220000] atkbd.c: Use 'setkeycodes e071 <keycode>' to make it known.
[49263.320000] atkbd.c: Unknown key released (translated set 2, code 
0xf1 on isa0060/serio0).
[49263.320000] atkbd.c: Use 'setkeycodes e071 <keycode>' to make it known.
[49263.712000] psmouse.c: TouchPad at isa0060/serio4/input0 lost 
synchronization, throwing 3 bytes away.
[49273.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49395.176000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49417.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.
[49539.344000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
available or load failed.


Pavel Roskin wrote:
> On Sun, 2007-10-28 at 19:23 -0500, Robert Easter wrote:
>   
>> Here's one for the scrapbook, though hopefully not for the scrap yard-
>>
>> New install of Kubuntu 7.10- has a gui install set up for the Broadcom 
>> drivers, etc.  Very nice, if it worked.  Any suggestions on how to find 
>> the glitch, or best ways to totally replace the dead code with some that 
>> works?  Details:
>>     
>
> Most likely you don't have the firmware.  Please try:
>
> aptitude install bcm43xx-fwcutter
>
> That should download and install the firmware upon install.  If you
> cannot get that system online at all, you can get bcm43xx-fwcutter from
> http://linuxwireless.org/en/users/Drivers/b43 and follow the
> instructions how to extract the firmware.  Then transfer it to the
> laptop.
>
> If the problems persist, please check the kernel messages with "dmesg".
> You may also want to find out which driver you are using by running:
>
> lsmod |grep -E '(b43|bcm43)'
>
> If you are using b43 or b43legacy, you'll need b43-fwcutter, which
> creates slightly different firmware files.
>
>   



From larry.finger at lwfinger.net  Mon Oct 29 04:23:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Oct 2007 22:23:26 -0500
Subject: Kubuntu on an Acer
In-Reply-To: <47254F90.5070004@wbs.edu>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>		<472527E7.6040806@wbs.edu>
	<1193619421.30862.17.camel@dv> <47254F90.5070004@wbs.edu>
Message-ID: <4725522E.1030204@lwfinger.net>

Robert Easter wrote:
> Maybe not as complex as I thought.  I had gone through several Ubuntu 
> installs this week before settling with this one (Kubuntu 7.10 
> Desktop).  On the gnome-flavored version the firmware supposedly  
> installed but "saw" but never met the routers, then lost the signals 
> altogether.  Anyway, with this one the cutter was  not installed but 
> should be now.  Still can't find the wireless signal.  The dmesg output 
> follows:
-- big snip --

> [49273.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
> available or load failed.
> [49395.176000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
> available or load failed.
> [49417.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
> available or load failed.
> [49539.344000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not 
> available or load failed.

You do not have the firmware installed. What does 'ls /lib/firmware' show?

Larry


From mactalla.obair at gmail.com  Mon Oct 29 08:52:56 2007
From: mactalla.obair at gmail.com (Andrew Fuller)
Date: Mon, 29 Oct 2007 00:52:56 -0700
Subject: Kubuntu on an Acer
In-Reply-To: <4725522E.1030204@lwfinger.net>
References: <mailman.2491.1193616464.2213.bcm43xx-dev@lists.berlios.de>
	<472527E7.6040806@wbs.edu> <1193619421.30862.17.camel@dv>
	<47254F90.5070004@wbs.edu> <4725522E.1030204@lwfinger.net>
Message-ID: <ae67fd3f0710290052w2b6d3f0ft5b48a2af15c48058@mail.gmail.com>

On 10/28/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Robert Easter wrote:
> > Maybe not as complex as I thought.  I had gone through several Ubuntu
> > installs this week before settling with this one (Kubuntu 7.10
> > Desktop).  On the gnome-flavored version the firmware supposedly
> > installed but "saw" but never met the routers, then lost the signals
> > altogether.  Anyway, with this one the cutter was  not installed but
> > should be now.  Still can't find the wireless signal.  The dmesg output
> > follows:
> -- big snip --
>
> > [49273.124000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not
> > available or load failed.
> > [49395.176000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not
> > available or load failed.
> > [49417.228000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not
> > available or load failed.
> > [49539.344000] bcm43xx: Error: Microcode "bcm43xx_microcode5.fw" not
> > available or load failed.
>
> You do not have the firmware installed. What does 'ls /lib/firmware' show?

Robert, try running restricted-manager-kde.  It should list your
broadcom card and let you click a checkbox to enable it.  When you
enable it, it should prompt you to download the firmware.  Accept the
default source of the firmware and it should download it, cut it, and
place the files where they belong.

Hope that helps.

-Andrew


From identd_ at hotmail.com  Tue Oct 30 02:58:00 2007
From: identd_ at hotmail.com (David Ellingsworth)
Date: Mon, 29 Oct 2007 21:58:00 -0400
Subject: [PATCH] b43: Fix rfkill callback deadlock
Message-ID: <BAY128-W1964444D925BF962CC6A2E86920@phx.gbl>


Forgot to send to list

> From: identd_ at hotmail.com
> To: mb at bu3sch.de
> Subject: RE: [PATCH] b43: Fix rfkill callback deadlock
> Date: Mon, 29 Oct 2007 21:56:51 -0400
> 
> 
> > From: mb at bu3sch.de
> > To: bcm43xx-dev at lists.berlios.de; david at identd.dyndns.org
> > Subject: Re: [PATCH] b43: Fix rfkill callback deadlock
> > Date: Mon, 29 Oct 2007 01:16:05 +0100
> >
> > On Monday 29 October 2007 01:06:51 David Ellingsworth wrote:
> >>> - mutex_lock(&wl->mutex);
> >>> + /* When RFKILL is registered, it will call back into this callback.
> >>> + * wl->mutex will already be locked when this happens.
> >>> + * So first trylock. On contention check if we are in initialization.
> >>> + * Silently return if that happens to avoid a deadlock. */
> >>> + if (mutex_trylock(&wl->mutex) == 0) {
> >>> + if (b43_status(dev) < B43_STAT_INITIALIZED)
> >>> + return 0;
> >>> + mutex_lock(&wl->mutex);
> >>> + }
> >>> if (b43_status(dev) < B43_STAT_INITIALIZED)
> >>> goto out_unlock;
> >> Why not replace everything above up to and including the '- mutex_lock(&wl->mutex); with:
> >>
> >> if(b43_status(dev) < B43_STAT_INITIALIZED)
> >> return 0;
> >>
> >> mutex_lock(&wl->mutex);
> >
> > because the status should be queried under lock, of course.
> 
> If that is the case, then a proper fix would be to use two locks to protect access to the status. One for allowing read access when no one is writing, and another for allowing exclusive write access. In such a configuration you could allow multiple readers while having only one writer. The above fix is not proper since the lock obtained by another section of code could be released before or during the status check.
> 
> Regards,
> 
> David Ellingsworth
> _________________________________________________________________
> Peek-a-boo FREE Tricks & Treats for You!
> http://www.reallivemoms.com?ocid=TXT_TAGHM&loc=us

_________________________________________________________________
Windows Live Hotmail and Microsoft Office Outlook ? together at last. ?Get it now.
http://office.microsoft.com/en-us/outlook/HA102225181033.aspx?pid=CL100626971033
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071029/f843da81/attachment.html>

From mb at bu3sch.de  Tue Oct 30 11:06:53 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 30 Oct 2007 11:06:53 +0100
Subject: [PATCH] b43: Fix rfkill callback deadlock
In-Reply-To: <BAY128-W19032B985712B3F1CE8AD186920@phx.gbl>
References: <BAY128-W43EAEA5B4CCD7A448326E286910@phx.gbl>
	<200710290116.05945.mb@bu3sch.de>
	<BAY128-W19032B985712B3F1CE8AD186920@phx.gbl>
Message-ID: <200710301106.53841.mb@bu3sch.de>

On Tuesday 30 October 2007 02:56:51 David Ellingsworth wrote:
> If that is the case, then a proper fix would be to use two locks to protect access to the status. One for allowing read access when no one is writing, and another for allowing exclusive write access. In such a configuration you could allow multiple readers while having only one writer. The above fix is not proper since the lock obtained by another section of code could be released before or during the status check.

We don't care for that case, as the status is rechecked under lock later.
This really is not a problem.
We only care for the case where status!=INITIALIZED. Because then we mustn't aquire the lock
and return silently. And that's what we do.

-- 
Greetings Michael.


From RDEaster at wbs.edu  Tue Oct 30 16:08:52 2007
From: RDEaster at wbs.edu (Robert Easter)
Date: Tue, 30 Oct 2007 10:08:52 -0500
Subject: kubuntu on an acer
In-Reply-To: <mailman.64.1193742073.29487.bcm43xx-dev@lists.berlios.de>
References: <mailman.64.1193742073.29487.bcm43xx-dev@lists.berlios.de>
Message-ID: <47274904.9030400@wbs.edu>

Larry, et. al.,

I was that close!  After the various steps and procedures I had the bcm
driver kit "installed" and the knetwork manager said I was online.  No
applications were connecting so I rebooted, and had to re-inRe:
Bcm43xx-dev Digest, Vol 16, Issue 28 install the OS.  Back on the
computer now, driver kit installed according to the gui installers, but
not making the trip past the "IP configuration" stage (the "57%" on the
progress bar graph).  Any sage advice would be welcome, and saved out of
reach in case of another crash!

r.e.

bcm43xx-dev-request at lists.berlios.de wrote:
> Send Bcm43xx-dev mailing list submissions to
> 	bcm43xx-dev at lists.berlios.de
>
> To subscribe or unsubscribe via the World Wide Web, visit
> 	https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> or, via email, send a message with subject or body 'help' to
> 	bcm43xx-dev-request at lists.berlios.de
>
> You can reach the person managing the list at
> 	bcm43xx-dev-owner at lists.berlios.de
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of Bcm43xx-dev digest..."
>
>
> Today's Topics:
>
>    1. [PATCH] b43: Fix rfkill callback deadlock (David Ellingsworth)
>    2. Re: [PATCH] b43: Fix rfkill callback deadlock (Michael Buesch)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Mon, 29 Oct 2007 21:58:00 -0400
> From: David Ellingsworth <identd_ at hotmail.com>
> Subject: [PATCH] b43: Fix rfkill callback deadlock
> To: bcm43xx-dev <bcm43xx-dev at lists.berlios.de>
> Message-ID: <BAY128-W1964444D925BF962CC6A2E86920 at phx.gbl>
> Content-Type: text/plain; charset="windows-1252"
>
>
> Forgot to send to list
>
>   
>> From: identd_ at hotmail.com
>> To: mb at bu3sch.de
>> Subject: RE: [PATCH] b43: Fix rfkill callback deadlock
>> Date: Mon, 29 Oct 2007 21:56:51 -0400
>>
>>
>>     
>>> From: mb at bu3sch.de
>>> To: bcm43xx-dev at lists.berlios.de; david at identd.dyndns.org
>>> Subject: Re: [PATCH] b43: Fix rfkill callback deadlock
>>> Date: Mon, 29 Oct 2007 01:16:05 +0100
>>>
>>> On Monday 29 October 2007 01:06:51 David Ellingsworth wrote:
>>>       
>>>>> - mutex_lock(&wl->mutex);
>>>>> + /* When RFKILL is registered, it will call back into this callback.
>>>>> + * wl->mutex will already be locked when this happens.
>>>>> + * So first trylock. On contention check if we are in initialization.
>>>>> + * Silently return if that happens to avoid a deadlock. */
>>>>> + if (mutex_trylock(&wl->mutex) == 0) {
>>>>> + if (b43_status(dev) < B43_STAT_INITIALIZED)
>>>>> + return 0;
>>>>> + mutex_lock(&wl->mutex);
>>>>> + }
>>>>> if (b43_status(dev) < B43_STAT_INITIALIZED)
>>>>> goto out_unlock;
>>>>>           
>>>> Why not replace everything above up to and including the '- mutex_lock(&wl->mutex); with:
>>>>
>>>> if(b43_status(dev) < B43_STAT_INITIALIZED)
>>>> return 0;
>>>>
>>>> mutex_lock(&wl->mutex);
>>>>         
>>> because the status should be queried under lock, of course.
>>>       
>> If that is the case, then a proper fix would be to use two locks to protect access to the status. One for allowing read access when no one is writing, and another for allowing exclusive write access. In such a configuration you could allow multiple readers while having only one writer. The above fix is not proper since the lock obtained by another section of code could be released before or during the status check.
>>
>> Regards,
>>
>> David Ellingsworth
>> _________________________________________________________________
>> Peek-a-boo FREE Tricks & Treats for You!
>> http://www.reallivemoms.com?ocid=TXT_TAGHM&loc=us
>>     
>
> _________________________________________________________________
> Windows Live Hotmail and Microsoft Office Outlook ? together at last. ?Get it now.
> http://office.microsoft.com/en-us/outlook/HA102225181033.aspx?pid=CL100626971033
> -------------- next part --------------
> An HTML attachment was scrubbed...
> URL: https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071029/f843da81/attachment-0001.html 
>
> ------------------------------
>
> Message: 2
> Date: Tue, 30 Oct 2007 11:06:53 +0100
> From: Michael Buesch <mb at bu3sch.de>
> Subject: Re: [PATCH] b43: Fix rfkill callback deadlock
> To: david at identd.dyndns.org
> Cc: bcm43xx-dev at lists.berlios.de
> Message-ID: <200710301106.53841.mb at bu3sch.de>
> Content-Type: text/plain;  charset="iso-8859-1"
>
> On Tuesday 30 October 2007 02:56:51 David Ellingsworth wrote:
>   
>> If that is the case, then a proper fix would be to use two locks to protect access to the status. One for allowing read access when no one is writing, and another for allowing exclusive write access. In such a configuration you could allow multiple readers while having only one writer. The above fix is not proper since the lock obtained by another section of code could be released before or during the status check.
>>     
>
> We don't care for that case, as the status is rechecked under lock later.
> This really is not a problem.
> We only care for the case where status!=INITIALIZED. Because then we mustn't aquire the lock
> and return silently. And that's what we do.
>
>   



From larry.finger at lwfinger.net  Tue Oct 30 16:27:34 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 30 Oct 2007 10:27:34 -0500
Subject: kubuntu on an acer
In-Reply-To: <47274904.9030400@wbs.edu>
References: <mailman.64.1193742073.29487.bcm43xx-dev@lists.berlios.de>
	<47274904.9030400@wbs.edu>
Message-ID: <47274D66.7050509@lwfinger.net>

Robert Easter wrote:
> Larry, et. al.,
> 
> I was that close!  After the various steps and procedures I had the bcm
> driver kit "installed" and the knetwork manager said I was online.  No
> applications were connecting so I rebooted, and had to re-inRe:
> Bcm43xx-dev Digest, Vol 16, Issue 28 install the OS.  Back on the
> computer now, driver kit installed according to the gui installers, but
> not making the trip past the "IP configuration" stage (the "57%" on the
> progress bar graph).  Any sage advice would be welcome, and saved out of
> reach in case of another crash!

Does 'iwlist scan' show your AP? That is always the first step in checking for a connection. In
addition, you should post the results of 'dmesg | grep bcm'.

Larry


From s0238762 at sms.ed.ac.uk  Wed Oct 31 11:34:15 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Wed, 31 Oct 2007 10:34:15 +0000
Subject: b43leacy connection speed
In-Reply-To: <200710282108.52078.mb@bu3sch.de>
References: <200710282108.52078.mb@bu3sch.de>
Message-ID: <47285A27.9070303@sms.ed.ac.uk>

An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20071031/67c60473/attachment.html>

From larry.finger at lwfinger.net  Wed Oct 31 16:15:09 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Oct 2007 10:15:09 -0500
Subject: b43leacy connection speed
In-Reply-To: <47285A27.9070303@sms.ed.ac.uk>
References: <200710282108.52078.mb@bu3sch.de> <47285A27.9070303@sms.ed.ac.uk>
Message-ID: <47289BFD.5000704@lwfinger.net>

Ioannis Nousias wrote:
> Hello
> 
> I'm using b43legacy with a BCM4309 - 14e4:4324 (rev 02) card. Also the
> following might be useful for you to know:
> 
> $ cat /sys/bus/ssb/devices/*/uevent
> PHYSDEVBUS=ssb
> MODALIAS=ssb:v4243id0812rev04
> PHYSDEVBUS=ssb
> MODALIAS=ssb:v4243id0807rev01
> PHYSDEVBUS=ssb
> MODALIAS=ssb:v4243id0812rev04
> 
> and I'm using firmware 3.130.20.0
> 
> 
> the driver seems to be stable, but I only get 1Mbps bit rate
> wlan0     IEEE 802.11g  ESSID:"<my_essid>" 
>           Mode:Managed  Frequency:2.432 GHz  Access Point:
> <my_access_point_mac> 
>           Bit Rate=1 Mb/s   Tx-Power=27 dBm  
>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B  
>           Link Quality=83/100  Signal level=-47 dBm  Noise level=-68 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> 
> my question is, is this a known limitation for the current state of the
> driver or I do I need to do something to set higher bit-rates?
> 
> thanks
> Ioannis
> 
> 
> PS: a belated thank you to Larry for his fine work on this project and
> the excellent support he provides.

Thank you for the kind words.

The performance of the cards with a rev 4 802.11 core are not the best. My tests show receive rates
of ~5 Mbs and transmission rates up to ~6 Mbs. The maximum is with a bit rate of 11Mbs. You can set
that with an 'iwconfig wlan0 rate 11M' command. This command has to be issued as root.

Larry


