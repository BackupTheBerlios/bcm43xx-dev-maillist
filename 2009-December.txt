From zajec5polish at gmail.com  Tue Dec  1 19:54:33 2009
From: zajec5polish at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 1 Dec 2009 19:54:33 +0100
Subject: Notebooks compatibility with Broadcom cards
Message-ID: <14b026160912011054i167033bfrd069a6d039e643cf@mail.gmail.com>

I know there were some series of notebooks accepting only one kind of
wireless cards. Not sure what vendor was that... Dell or HP maybe?

Do you have any idea if I should be somehow careful when changing
wireless card in my Acer? It's really old Acer Aspire 5024 with 4318
as default. I'd like to exchange this to some 802.11n Broadcom
wireless card. I think it would be ASUS WL-270N as it seems to be the
easies to but in my country. However if you know any other choice
that's easy-available, I can change my decision.

Also is this possible my notebook is just too old to handle new
wireless 802.11n card? Maybe too old mini pcie, or something like
that?

-- 
Rafa?


From peter at stuge.se  Tue Dec  1 20:11:24 2009
From: peter at stuge.se (Peter Stuge)
Date: Tue, 1 Dec 2009 20:11:24 +0100
Subject: Notebooks compatibility with Broadcom cards
In-Reply-To: <14b026160912011054i167033bfrd069a6d039e643cf@mail.gmail.com>
References: <14b026160912011054i167033bfrd069a6d039e643cf@mail.gmail.com>
Message-ID: <20091201191124.19269.qmail@stuge.se>

Rafa? Mi?ecki wrote:
> I know there were some series of notebooks accepting only one kind of
> wireless cards. Not sure what vendor was that... Dell or HP maybe?

HP and IBM/Lenovo both have BIOS checks for particular PCI IDs and
only allow cards with certain IDs to be plugged in.


> Do you have any idea if I should be somehow careful when changing
> wireless card in my Acer?

Sorry, no idea.


> Also is this possible my notebook is just too old to handle new
> wireless 802.11n card? Maybe too old mini pcie, or something like
> that?

Check that the expansion socket is compatible. The 4318 is probably a
mini-PCI card and .11n cards are usually mini-PCIe which is very
different and not at all compatible. The card you buy must fit your
socket. I've bought an Atheros miniPCI .11n card off eBay for my X40:

http://cgi.ebay.co.uk/ws/eBayISAPI.dll?ViewItem&item=400078624952

But I haven't received it yet so I can't review. It's supposed to be
supported by ath9k. I expect that I have to fiddle with the EEPROM on
this card to get my ThinkPad to boot with it.

Also check the antenna situation. .11n often uses MIMO so it might
need an extra antenna to be installed in your laptop. Note how the
above card has three connectors, and comes shipped with one antenna.
Also note the MIMO arrangement so that it fits your needs. (In
simplified terms it can be optimized for receive or transmit.)


//Peter


From netrolller.3d at gmail.com  Tue Dec  1 21:06:16 2009
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Tue, 1 Dec 2009 21:06:16 +0100
Subject: Notebooks compatibility with Broadcom cards
In-Reply-To: <20091201191124.19269.qmail@stuge.se>
References: <14b026160912011054i167033bfrd069a6d039e643cf@mail.gmail.com> 
	<20091201191124.19269.qmail@stuge.se>
Message-ID: <69e28c910912011206x19a769d1yd5b1e97d353d4007@mail.gmail.com>

On Tue, Dec 1, 2009 at 8:11 PM, Peter Stuge <peter at stuge.se> wrote:
> Rafa? Mi?ecki wrote:
>> I know there were some series of notebooks accepting only one kind of
>> wireless cards. Not sure what vendor was that... Dell or HP maybe?
>
> HP and IBM/Lenovo both have BIOS checks for particular PCI IDs and
> only allow cards with certain IDs to be plugged in.
>
>
>> Do you have any idea if I should be somehow careful when changing
>> wireless card in my Acer?
>
> Sorry, no idea.

Not sure about the 5024, but the 5720G has freely-interchangeable
wireless cards. (However, it also comes with 2 full miniPCIE slots,
something not many Acers have.)

>
>
>> Also is this possible my notebook is just too old to handle new
>> wireless 802.11n card? Maybe too old mini pcie, or something like
>> that?
>
> Check that the expansion socket is compatible. The 4318 is probably a
> mini-PCI card and .11n cards are usually mini-PCIe which is very
> different and not at all compatible. The card you buy must fit your
> socket. I've bought an Atheros miniPCI .11n card off eBay for my X40:
>
> http://cgi.ebay.co.uk/ws/eBayISAPI.dll?ViewItem&item=400078624952
>
> But I haven't received it yet so I can't review. It's supposed to be
> supported by ath9k. I expect that I have to fiddle with the EEPROM on
> this card to get my ThinkPad to boot with it.
>
> Also check the antenna situation. .11n often uses MIMO so it might
> need an extra antenna to be installed in your laptop. Note how the
> above card has three connectors, and comes shipped with one antenna.
> Also note the MIMO arrangement so that it fits your needs. (In
> simplified terms it can be optimized for receive or transmit.)
>
>
> //Peter
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5polish at gmail.com  Tue Dec  1 21:58:01 2009
From: zajec5polish at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 1 Dec 2009 21:58:01 +0100
Subject: Notebooks compatibility with Broadcom cards
In-Reply-To: <20091201191124.19269.qmail@stuge.se>
References: <14b026160912011054i167033bfrd069a6d039e643cf@mail.gmail.com>
	<20091201191124.19269.qmail@stuge.se>
Message-ID: <14b026160912011258t66ee26ds22467d4fd305e9f7@mail.gmail.com>

2009/12/1 Peter Stuge <peter at stuge.se>:
> Rafa? Mi?ecki wrote:
>> I know there were some series of notebooks accepting only one kind of
>> wireless cards. Not sure what vendor was that... Dell or HP maybe?
>
> HP and IBM/Lenovo both have BIOS checks for particular PCI IDs and
> only allow cards with certain IDs to be plugged in.

Thanks.


>> Also is this possible my notebook is just too old to handle new
>> wireless 802.11n card? Maybe too old mini pcie, or something like
>> that?
>
> Check that the expansion socket is compatible. The 4318 is probably a
> mini-PCI card and .11n cards are usually mini-PCIe which is very
> different and not at all compatible. The card you buy must fit your
> socket. I've bought an Atheros miniPCI .11n card off eBay for my X40:

Ohh, I've forgotten they were using miniPCI these days... Yeah, this
Acer is miniPCI indeed. AFAICS there are only few 802.11n miniPCI
cards like TL-WN861N, WMIA-199N, Mikrotik R52N - all Atheros based.
Too bad :(

Anyway thanks for focusing me on that. As I told I didn't even think
this notebook may by miniPCI.


> Also check the antenna situation. .11n often uses MIMO so it might
> need an extra antenna to be installed in your laptop. Note how the
> above card has three connectors, and comes shipped with one antenna.
> Also note the MIMO arrangement so that it fits your needs. (In
> simplified terms it can be optimized for receive or transmit.)

This thing I used to call notebook is actually
home-standing-something-without-panel-only-VGA-monitor. So external
antennas are fine in this case ;)

-- 
Rafa?


From mcgrof at gmail.com  Fri Dec  4 00:44:26 2009
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Thu, 3 Dec 2009 15:44:26 -0800
Subject: Broadcom Android bcm4329 open driver
Message-ID: <43e72e890912031544j7cb8bffav1c1c7d016e740175@mail.gmail.com>

In case you haven't seen this yet, Broadcom has an open (!) driver on
the Android git tree with support for SDIO/SPI for  bcm4329.

http://tinyurl.com/broadcom-android-bcm4329

The commit log entry dated 2009-10-29 states:

Linux WLAN driver for BCM4329 - Low-Power 802.11n with Bluetooth(R)
2.1+ EDR and FM (Tx and Rx)

  Luis


From zajec5polish at gmail.com  Fri Dec  4 09:10:10 2009
From: zajec5polish at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 4 Dec 2009 09:10:10 +0100
Subject: Broadcom Android bcm4329 open driver
In-Reply-To: <43e72e890912031544j7cb8bffav1c1c7d016e740175@mail.gmail.com>
References: <43e72e890912031544j7cb8bffav1c1c7d016e740175@mail.gmail.com>
Message-ID: <14b026160912040010k5dda243bra0abd9be4e275918@mail.gmail.com>

2009/12/4 Luis R. Rodriguez <mcgrof at gmail.com>:
> In case you haven't seen this yet, Broadcom has an open (!) driver on
> the Android git tree with support for SDIO/SPI for ?bcm4329.
>
> http://tinyurl.com/broadcom-android-bcm4329
>
> The commit log entry dated 2009-10-29 states:
>
> Linux WLAN driver for BCM4329 - Low-Power 802.11n with Bluetooth(R)
> 2.1+ EDR and FM (Tx and Rx)

This driver was already noticed in January:
http://lists.berlios.de/pipermail/bcm43xx-dev/2009-January/thread.html#5066
See Thomas's response for details about driver:
http://lists.berlios.de/pipermail/bcm43xx-dev/2009-January/005072.html

So that device controlled by SDIO has it's own CPU which cares of
wireless. As you noticed there is also SPI but is this used anywhere
except Android devices? Driver seems to check PCI buses just to find
SPI.

-- 
Rafa?


From guitarman256 at hotmail.com  Fri Dec  4 12:01:56 2009
From: guitarman256 at hotmail.com (guitarman256 at hotmail.com)
Date: Fri, 4 Dec 2009 03:01:56 -0800
Subject: Vacation reply
In-Reply-To: <mailman.38.1259924509.31914.bcm43xx-dev@lists.berlios.de>
Message-ID: <COL0-MC3-F3185C0F6959C7458E55F6280930@phx.gbl>

An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091204/e0688b7c/attachment.html>

From Larry.Finger at lwfinger.net  Wed Dec  9 20:25:56 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 09 Dec 2009 13:25:56 -0600
Subject: [PATCH] b43: Remove reset after fatal DMA error
Message-ID: <4b1ff9c4.iIvEkDMkYFL2BtFk%Larry.Finger@lwfinger.net>

As shown in Kernel Bugzilla #14761, doing a controller restart after a
fatal DMA error does not accomplish anything other than consume the CPU
on an affected system. Accordingly, substitute a meaningful message for
the restart.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
Cc: Stable <stable at vger.kernel.org>        [2.6.32]
---

John,

If possible, this patch should be applied to 2.6.33. I made the message
be two parts as the second will be replaced once the patch to change PIO
from a compile-time to a run-time option is completed and tested.
It is working here, but needs further testing. I expected the performance
to be degraded, but it seems to be too much here.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -1784,7 +1784,10 @@ static void b43_do_interrupt_thread(stru
 			       dma_reason[0], dma_reason[1],
 			       dma_reason[2], dma_reason[3],
 			       dma_reason[4], dma_reason[5]);
-			b43_controller_restart(dev, "DMA error");
+			b43err(dev->wl, "This device does not support DMA "
+			       "on your system. Please use PIO instead.\n");
+			b43err(dev->wl, "CONFIG_B43_FORCE_PIO must be set in "
+			       "your kernel configuration.\n");
 			return;
 		}
 		if (merged_dma_reason & B43_DMAIRQ_NONFATALMASK) {


From guitarman256 at hotmail.com  Thu Dec 10 12:01:21 2009
From: guitarman256 at hotmail.com (guitarman256 at hotmail.com)
Date: Thu, 10 Dec 2009 03:01:21 -0800
Subject: Vacation reply
In-Reply-To: <mailman.44.1260442875.19536.bcm43xx-dev@lists.berlios.de>
Message-ID: <BAY0-MC3-F4690F3D46100D0E282768E808D0@phx.gbl>

An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091210/c49a58ea/attachment.html>

From Larry.Finger at lwfinger.net  Thu Dec 10 17:27:57 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 10 Dec 2009 10:27:57 -0600
Subject: [RFC/RFT] b43: Allow PIO mode to be selected at module load
Message-ID: <4b21218d.wt8w3J8GbcDHhv31%Larry.Finger@lwfinger.net>

If a user encounters the "Fatal DMA Problem" with a BCM43XX device, and
still wishes to use b43 as the driver, their only option is to rebuild
the kernel with CONFIG_B43_FORCE_PIO. This patch removes this option and
allows PIO mode to be selected with a load-time option for the module.

Once the DMA problem with the BCM4312 devices is solved, this patch will
likely be reverted.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---


Index: wireless-testing/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
+++ wireless-testing/drivers/net/wireless/b43/Kconfig
@@ -79,10 +79,11 @@ config B43_SDIO
 	  If unsure, say N.
 
 # Data transfers to the device via PIO
-# This is only needed on PCMCIA and SDIO devices. All others can do DMA properly.
+# Technically, this is only needed on PCMCIA and SDIO devices; but some LP PHYs
+# cannot do DMA properly.
 config B43_PIO
 	bool
-	depends on B43 && (B43_SDIO || B43_PCMCIA || B43_FORCE_PIO)
+	depends on B43
 	select SSB_BLOCKIO
 	default y
 
@@ -137,12 +138,4 @@ config B43_DEBUG
 	  for production use.
 	  Only say Y, if you are debugging a problem in the b43 driver sourcecode.
 
-config B43_FORCE_PIO
-	bool "Force usage of PIO instead of DMA"
-	depends on B43 && B43_DEBUG
-	---help---
-	  This will disable DMA and always enable PIO instead.
 
-	  Say N!
-	  This is only for debugging the PIO engine code. You do
-	  _NOT_ want to enable this.
Index: wireless-testing/drivers/net/wireless/b43/Makefile
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Makefile
+++ wireless-testing/drivers/net/wireless/b43/Makefile
@@ -12,7 +12,7 @@ b43-y				+= xmit.o
 b43-y				+= lo.o
 b43-y				+= wa.o
 b43-y				+= dma.o
-b43-$(CONFIG_B43_PIO)		+= pio.o
+b43-y				+= pio.o
 b43-y				+= rfkill.o
 b43-$(CONFIG_B43_LEDS)		+= leds.o
 b43-$(CONFIG_B43_PCMCIA)	+= pcmcia.o
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h
+++ wireless-testing/drivers/net/wireless/b43/b43.h
@@ -821,11 +821,9 @@ struct b43_wl {
 	/* The device LEDs. */
 	struct b43_leds leds;
 
-#ifdef CONFIG_B43_PIO
 	/* Kmalloc'ed scratch space for PIO TX/RX. Protected by wl->mutex. */
 	u8 pio_scratchspace[110] __attribute__((__aligned__(8)));
 	u8 pio_tailspace[4] __attribute__((__aligned__(8)));
-#endif /* CONFIG_B43_PIO */
 };
 
 static inline struct b43_wl *hw_to_b43_wl(struct ieee80211_hw *hw)
@@ -876,20 +874,9 @@ static inline void b43_write32(struct b4
 
 static inline bool b43_using_pio_transfers(struct b43_wldev *dev)
 {
-#ifdef CONFIG_B43_PIO
 	return dev->__using_pio_transfers;
-#else
-	return 0;
-#endif
 }
 
-#ifdef CONFIG_B43_FORCE_PIO
-# define B43_FORCE_PIO	1
-#else
-# define B43_FORCE_PIO	0
-#endif
-
-
 /* Message printing */
 void b43info(struct b43_wl *wl, const char *fmt, ...)
     __attribute__ ((format(printf, 2, 3)));
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -102,6 +102,9 @@ int b43_modparam_verbose = B43_VERBOSITY
 module_param_named(verbose, b43_modparam_verbose, int, 0644);
 MODULE_PARM_DESC(verbose, "Log message verbosity: 0=error, 1=warn, 2=info(default), 3=debug");
 
+static int modparam_pio;
+module_param_named(pio, modparam_pio, int, 0444);
+MODULE_PARM_DESC(pio, "enable(1) / disable(0) PIO mode");
 
 static const struct ssb_device_id b43_ssb_tbl[] = {
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 5),
@@ -1786,8 +1789,8 @@ static void b43_do_interrupt_thread(stru
 			       dma_reason[4], dma_reason[5]);
 			b43err(dev->wl, "This device does not support DMA "
 			       "on your system. Please use PIO instead.\n");
-			b43err(dev->wl, "CONFIG_B43_FORCE_PIO must be set in "
-			       "your kernel configuration.\n");
+			b43err(dev->wl, "Unload the b43 module and reload "
+			       "with 'pio=1'\n");
 			return;
 		}
 		if (merged_dma_reason & B43_DMAIRQ_NONFATALMASK) {
@@ -4353,11 +4356,9 @@ static int b43_wireless_core_init(struct
 
 	if ((dev->dev->bus->bustype == SSB_BUSTYPE_PCMCIA) ||
 	    (dev->dev->bus->bustype == SSB_BUSTYPE_SDIO) ||
-	    B43_FORCE_PIO) {
-		dev->__using_pio_transfers = 1;
+	    dev->__using_pio_transfers) {
 		err = b43_pio_init(dev);
 	} else {
-		dev->__using_pio_transfers = 0;
 		err = b43_dma_init(dev);
 	}
 	if (err)
@@ -4827,6 +4828,8 @@ static int b43_one_core_attach(struct ss
 	wldev->wl = wl;
 	b43_set_status(wldev, B43_STAT_UNINIT);
 	wldev->bad_frames_preempt = modparam_bad_frames_preempt;
+	if (modparam_pio)
+		wldev->__using_pio_transfers = 1;
 	INIT_LIST_HEAD(&wldev->list);
 
 	err = b43_wireless_core_attach(wldev);


From mb at bu3sch.de  Thu Dec 10 17:59:52 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 10 Dec 2009 17:59:52 +0100
Subject: [RFC/RFT] b43: Allow PIO mode to be selected at module load
In-Reply-To: <4b21218d.wt8w3J8GbcDHhv31%Larry.Finger@lwfinger.net>
References: <4b21218d.wt8w3J8GbcDHhv31%Larry.Finger@lwfinger.net>
Message-ID: <200912101759.54881.mb@bu3sch.de>

On Thursday 10 December 2009 17:27:57 Larry Finger wrote:
> If a user encounters the "Fatal DMA Problem" with a BCM43XX device, and
> still wishes to use b43 as the driver, their only option is to rebuild
> the kernel with CONFIG_B43_FORCE_PIO. This patch removes this option and
> allows PIO mode to be selected with a load-time option for the module.
> 
> Once the DMA problem with the BCM4312 devices is solved, this patch will
> likely be reverted.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> 
> Index: wireless-testing/drivers/net/wireless/b43/Kconfig
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
> +++ wireless-testing/drivers/net/wireless/b43/Kconfig
> @@ -79,10 +79,11 @@ config B43_SDIO
>  	  If unsure, say N.
>  
>  # Data transfers to the device via PIO
> -# This is only needed on PCMCIA and SDIO devices. All others can do DMA properly.
> +# Technically, this is only needed on PCMCIA and SDIO devices; but some LP PHYs
> +# cannot do DMA properly.
>  config B43_PIO
>  	bool
> -	depends on B43 && (B43_SDIO || B43_PCMCIA || B43_FORCE_PIO)
> +	depends on B43
>  	select SSB_BLOCKIO
>  	default y

Just remove the kconfig entry, too. ;)
Add the select SSB_BLOCKIO to CONFIG_B43

> @@ -137,12 +138,4 @@ config B43_DEBUG
>  	  for production use.
>  	  Only say Y, if you are debugging a problem in the b43 driver sourcecode.
>  
> -config B43_FORCE_PIO
> -	bool "Force usage of PIO instead of DMA"
> -	depends on B43 && B43_DEBUG
> -	---help---
> -	  This will disable DMA and always enable PIO instead.
>  
> -	  Say N!
> -	  This is only for debugging the PIO engine code. You do
> -	  _NOT_ want to enable this.
> Index: wireless-testing/drivers/net/wireless/b43/Makefile
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/Makefile
> +++ wireless-testing/drivers/net/wireless/b43/Makefile
> @@ -12,7 +12,7 @@ b43-y				+= xmit.o
>  b43-y				+= lo.o
>  b43-y				+= wa.o
>  b43-y				+= dma.o
> -b43-$(CONFIG_B43_PIO)		+= pio.o
> +b43-y				+= pio.o
>  b43-y				+= rfkill.o
>  b43-$(CONFIG_B43_LEDS)		+= leds.o
>  b43-$(CONFIG_B43_PCMCIA)	+= pcmcia.o
> Index: wireless-testing/drivers/net/wireless/b43/b43.h
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/b43.h
> +++ wireless-testing/drivers/net/wireless/b43/b43.h
> @@ -821,11 +821,9 @@ struct b43_wl {
>  	/* The device LEDs. */
>  	struct b43_leds leds;
>  
> -#ifdef CONFIG_B43_PIO
>  	/* Kmalloc'ed scratch space for PIO TX/RX. Protected by wl->mutex. */
>  	u8 pio_scratchspace[110] __attribute__((__aligned__(8)));
>  	u8 pio_tailspace[4] __attribute__((__aligned__(8)));
> -#endif /* CONFIG_B43_PIO */
>  };
>  
>  static inline struct b43_wl *hw_to_b43_wl(struct ieee80211_hw *hw)
> @@ -876,20 +874,9 @@ static inline void b43_write32(struct b4
>  
>  static inline bool b43_using_pio_transfers(struct b43_wldev *dev)
>  {
> -#ifdef CONFIG_B43_PIO
>  	return dev->__using_pio_transfers;
> -#else
> -	return 0;
> -#endif
>  }
>  
> -#ifdef CONFIG_B43_FORCE_PIO
> -# define B43_FORCE_PIO	1
> -#else
> -# define B43_FORCE_PIO	0
> -#endif
> -
> -
>  /* Message printing */
>  void b43info(struct b43_wl *wl, const char *fmt, ...)
>      __attribute__ ((format(printf, 2, 3)));
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c
> +++ wireless-testing/drivers/net/wireless/b43/main.c
> @@ -102,6 +102,9 @@ int b43_modparam_verbose = B43_VERBOSITY
>  module_param_named(verbose, b43_modparam_verbose, int, 0644);
>  MODULE_PARM_DESC(verbose, "Log message verbosity: 0=error, 1=warn, 2=info(default), 3=debug");
>  
> +static int modparam_pio;
> +module_param_named(pio, modparam_pio, int, 0444);
> +MODULE_PARM_DESC(pio, "enable(1) / disable(0) PIO mode");
>  
>  static const struct ssb_device_id b43_ssb_tbl[] = {
>  	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 5),
> @@ -1786,8 +1789,8 @@ static void b43_do_interrupt_thread(stru
>  			       dma_reason[4], dma_reason[5]);
>  			b43err(dev->wl, "This device does not support DMA "
>  			       "on your system. Please use PIO instead.\n");
> -			b43err(dev->wl, "CONFIG_B43_FORCE_PIO must be set in "
> -			       "your kernel configuration.\n");
> +			b43err(dev->wl, "Unload the b43 module and reload "
> +			       "with 'pio=1'\n");
>  			return;
>  		}
>  		if (merged_dma_reason & B43_DMAIRQ_NONFATALMASK) {
> @@ -4353,11 +4356,9 @@ static int b43_wireless_core_init(struct
>  
>  	if ((dev->dev->bus->bustype == SSB_BUSTYPE_PCMCIA) ||
>  	    (dev->dev->bus->bustype == SSB_BUSTYPE_SDIO) ||
> -	    B43_FORCE_PIO) {
> -		dev->__using_pio_transfers = 1;
> +	    dev->__using_pio_transfers) {

No, check for modparam_pio here instead of __using_pio_transfers.

>  		err = b43_pio_init(dev);
>  	} else {
> -		dev->__using_pio_transfers = 0;

and don't remove that here.

>  		err = b43_dma_init(dev);
>  	}
>  	if (err)
> @@ -4827,6 +4828,8 @@ static int b43_one_core_attach(struct ss
>  	wldev->wl = wl;
>  	b43_set_status(wldev, B43_STAT_UNINIT);
>  	wldev->bad_frames_preempt = modparam_bad_frames_preempt;
> +	if (modparam_pio)
> +		wldev->__using_pio_transfers = 1;

And remove this hunk.

>  	INIT_LIST_HEAD(&wldev->list);
>  
>  	err = b43_wireless_core_attach(wldev);



-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Fri Dec 11 00:35:01 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 10 Dec 2009 17:35:01 -0600
Subject: [PATCH] b43: Allow PIO mode to be selected at module load
Message-ID: <4b2185a5.QaOUdYVRfLIFSF6B%Larry.Finger@lwfinger.net>

If userencounter the "Fatal DMA Problem" with a BCM43XX device, and
still wish to use b43 as the driver, their only option is to rebuild
the kernel with CONFIG_B43_FORCE_PIO. This patch removes this option and
allows PIO mode to be selected with a load-time parameter for the module.
Note that the configuration variable CONFIG_B43_PIO is also removed.

Once the DMA problem with the BCM4312 devices is solved, this patch will
likely be reverted.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This version implements the changes suggested by Michael Buesch.

I don't know where this change should go. It is likely too large
and invasive to be applied to 2.6.33; however, it should be
applied to 2.6.32. Hmm? I guess that is why you get the "big money".
:)

Larry
---


Index: wireless-testing/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
+++ wireless-testing/drivers/net/wireless/b43/Kconfig
@@ -3,6 +3,7 @@ config B43
 	depends on SSB_POSSIBLE && MAC80211 && HAS_DMA
 	select SSB
 	select FW_LOADER
+	select SSB_BLOCKIO
 	---help---
 	  b43 is a driver for the Broadcom 43xx series wireless devices.
 
@@ -78,14 +79,6 @@ config B43_SDIO
 
 	  If unsure, say N.
 
-# Data transfers to the device via PIO
-# This is only needed on PCMCIA and SDIO devices. All others can do DMA properly.
-config B43_PIO
-	bool
-	depends on B43 && (B43_SDIO || B43_PCMCIA || B43_FORCE_PIO)
-	select SSB_BLOCKIO
-	default y
-
 config B43_NPHY
 	bool "Pre IEEE 802.11n support (BROKEN)"
 	depends on B43 && EXPERIMENTAL && BROKEN
@@ -137,12 +130,4 @@ config B43_DEBUG
 	  for production use.
 	  Only say Y, if you are debugging a problem in the b43 driver sourcecode.
 
-config B43_FORCE_PIO
-	bool "Force usage of PIO instead of DMA"
-	depends on B43 && B43_DEBUG
-	---help---
-	  This will disable DMA and always enable PIO instead.
-
-	  Say N!
-	  This is only for debugging the PIO engine code. You do
-	  _NOT_ want to enable this.
+
Index: wireless-testing/drivers/net/wireless/b43/Makefile
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Makefile
+++ wireless-testing/drivers/net/wireless/b43/Makefile
@@ -12,7 +12,7 @@ b43-y				+= xmit.o
 b43-y				+= lo.o
 b43-y				+= wa.o
 b43-y				+= dma.o
-b43-$(CONFIG_B43_PIO)		+= pio.o
+b43-y				+= pio.o
 b43-y				+= rfkill.o
 b43-$(CONFIG_B43_LEDS)		+= leds.o
 b43-$(CONFIG_B43_PCMCIA)	+= pcmcia.o
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h
+++ wireless-testing/drivers/net/wireless/b43/b43.h
@@ -821,11 +821,9 @@ struct b43_wl {
 	/* The device LEDs. */
 	struct b43_leds leds;
 
-#ifdef CONFIG_B43_PIO
 	/* Kmalloc'ed scratch space for PIO TX/RX. Protected by wl->mutex. */
 	u8 pio_scratchspace[110] __attribute__((__aligned__(8)));
 	u8 pio_tailspace[4] __attribute__((__aligned__(8)));
-#endif /* CONFIG_B43_PIO */
 };
 
 static inline struct b43_wl *hw_to_b43_wl(struct ieee80211_hw *hw)
@@ -876,20 +874,9 @@ static inline void b43_write32(struct b4
 
 static inline bool b43_using_pio_transfers(struct b43_wldev *dev)
 {
-#ifdef CONFIG_B43_PIO
 	return dev->__using_pio_transfers;
-#else
-	return 0;
-#endif
 }
 
-#ifdef CONFIG_B43_FORCE_PIO
-# define B43_FORCE_PIO	1
-#else
-# define B43_FORCE_PIO	0
-#endif
-
-
 /* Message printing */
 void b43info(struct b43_wl *wl, const char *fmt, ...)
     __attribute__ ((format(printf, 2, 3)));
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -102,6 +102,9 @@ int b43_modparam_verbose = B43_VERBOSITY
 module_param_named(verbose, b43_modparam_verbose, int, 0644);
 MODULE_PARM_DESC(verbose, "Log message verbosity: 0=error, 1=warn, 2=info(default), 3=debug");
 
+static int modparam_pio;
+module_param_named(pio, modparam_pio, int, 0444);
+MODULE_PARM_DESC(pio, "enable(1) / disable(0) PIO mode");
 
 static const struct ssb_device_id b43_ssb_tbl[] = {
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 5),
@@ -1786,8 +1789,8 @@ static void b43_do_interrupt_thread(stru
 			       dma_reason[4], dma_reason[5]);
 			b43err(dev->wl, "This device does not support DMA "
 			       "on your system. Please use PIO instead.\n");
-			b43err(dev->wl, "CONFIG_B43_FORCE_PIO must be set in "
-			       "your kernel configuration.\n");
+			b43err(dev->wl, "Unload the b43 module and reload "
+			       "with 'pio=1'\n");
 			return;
 		}
 		if (merged_dma_reason & B43_DMAIRQ_NONFATALMASK) {
@@ -4353,7 +4356,7 @@ static int b43_wireless_core_init(struct
 
 	if ((dev->dev->bus->bustype == SSB_BUSTYPE_PCMCIA) ||
 	    (dev->dev->bus->bustype == SSB_BUSTYPE_SDIO) ||
-	    B43_FORCE_PIO) {
+	    modparam_pio) {
 		dev->__using_pio_transfers = 1;
 		err = b43_pio_init(dev);
 	} else {
Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c
+++ wireless-testing/drivers/net/wireless/b43/dma.c
@@ -1760,7 +1760,6 @@ void b43_dma_tx_resume(struct b43_wldev
 	b43_power_saving_ctl_bits(dev, 0);
 }
 
-#ifdef CONFIG_B43_PIO
 static void direct_fifo_rx(struct b43_wldev *dev, enum b43_dmatype type,
 			   u16 mmio_base, bool enable)
 {
@@ -1794,4 +1793,3 @@ void b43_dma_direct_fifo_rx(struct b43_w
 	mmio_base = b43_dmacontroller_base(type, engine_index);
 	direct_fifo_rx(dev, type, mmio_base, enable);
 }
-#endif /* CONFIG_B43_PIO */
Index: wireless-testing/drivers/net/wireless/b43/pio.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/pio.h
+++ wireless-testing/drivers/net/wireless/b43/pio.h
@@ -55,8 +55,6 @@
 #define B43_PIO_MAX_NR_TXPACKETS	32
 
 
-#ifdef CONFIG_B43_PIO
-
 struct b43_pio_txpacket {
 	/* Pointer to the TX queue we belong to. */
 	struct b43_pio_txqueue *queue;
@@ -169,42 +167,4 @@ void b43_pio_rx(struct b43_pio_rxqueue *
 void b43_pio_tx_suspend(struct b43_wldev *dev);
 void b43_pio_tx_resume(struct b43_wldev *dev);
 
-
-#else /* CONFIG_B43_PIO */
-
-
-static inline int b43_pio_init(struct b43_wldev *dev)
-{
-	return 0;
-}
-static inline void b43_pio_free(struct b43_wldev *dev)
-{
-}
-static inline void b43_pio_stop(struct b43_wldev *dev)
-{
-}
-static inline int b43_pio_tx(struct b43_wldev *dev,
-			     struct sk_buff *skb)
-{
-	return 0;
-}
-static inline void b43_pio_handle_txstatus(struct b43_wldev *dev,
-					   const struct b43_txstatus *status)
-{
-}
-static inline void b43_pio_get_tx_stats(struct b43_wldev *dev,
-					struct ieee80211_tx_queue_stats *stats)
-{
-}
-static inline void b43_pio_rx(struct b43_pio_rxqueue *q)
-{
-}
-static inline void b43_pio_tx_suspend(struct b43_wldev *dev)
-{
-}
-static inline void b43_pio_tx_resume(struct b43_wldev *dev)
-{
-}
-
-#endif /* CONFIG_B43_PIO */
 #endif /* B43_PIO_H_ */


From mb at bu3sch.de  Sun Dec 13 18:46:20 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 13 Dec 2009 18:46:20 +0100
Subject: [PATCH] b43: add config option to force QoS off
In-Reply-To: <1260722731-4348-1-git-send-email-albert_herranz@yahoo.es>
References: <1260722731-4348-1-git-send-email-albert_herranz@yahoo.es>
Message-ID: <200912131846.23302.mb@bu3sch.de>

On Sunday 13 December 2009 17:45:31 Albert Herranz wrote:
> The b43 driver includes a capability mechanism that open source firmwares
> (like OpenFWWF) can use to inform the driver about supported
> characteristics.
> The OpenFWWF firmware doesn't support yet QoS and reflects that via
> its capabilities word.
> QoS is enabled by default when b43 starts (unless modparam_qos is set to 0).
> If the capabilities word of the firmware loaded informs that QoS is not
> supported then QoS is disabled.
> 
> Unfortunately, due to an unidentified bug, this automatic disabling of
> QoS doesn't work properly. It works, though, if QoS is disabled from the very
> beginning.

Well, something in mac80211 was changed that breaks this.
mac80211 currently seems to assume that the number of queues does not change
after ieee80211_register, which was not the case previously. This breaks
the QoS disable, because b43 modifies the nr of queues variable in the
ieee80211_hw structure.

> This patch adds a config option to allow disabling QoS from the beginning.
> This is the only way to workaround the described problem when building the
> b43 driver in-kernel, as in that case modparam_qos can't be changed.
> 
> Signed-off-by: Albert Herranz <albert_herranz at yahoo.es>

Why are we currently adding all kind of workaround patches instead of fixing the bugs?
This bug's been there for months, so I don't see a reason to push out a workaround now.

-- 
Greetings, Michael.


From johannes at sipsolutions.net  Mon Dec 14 09:36:36 2009
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 14 Dec 2009 09:36:36 +0100
Subject: [PATCH] b43: add config option to force QoS off
In-Reply-To: <4B252FCA.3060508@yahoo.es>
References: <1260722731-4348-1-git-send-email-albert_herranz@yahoo.es>
	<200912131846.23302.mb@bu3sch.de>  <4B252FCA.3060508@yahoo.es>
Message-ID: <1260779796.2442.343.camel@johannes.local>

On Sun, 2009-12-13 at 19:17 +0100, Albert Herranz wrote:

> > Well, something in mac80211 was changed that breaks this.
> > mac80211 currently seems to assume that the number of queues does not change
> > after ieee80211_register, which was not the case previously. This breaks
> > the QoS disable, because b43 modifies the nr of queues variable in the
> > ieee80211_hw structure.
> > 
> >> This patch adds a config option to allow disabling QoS from the beginning.
> >> This is the only way to workaround the described problem when building the
> >> b43 driver in-kernel, as in that case modparam_qos can't be changed.
> >>
> >> Signed-off-by: Albert Herranz <albert_herranz at yahoo.es>
> > 
> > Why are we currently adding all kind of workaround patches instead of fixing the bugs?
> > This bug's been there for months, so I don't see a reason to push out a workaround now.
> > 
> 
> I'm fine not pushing this workaround upstream. I can carry the workaround locally.
> 
> Is someone (apart from you) aware of this bug and looking at mac80211 to fix it?

I don't even consider it a bug in mac80211. Once you register your
capabilities, they're fair game. If you need to register them based on
firmware capabilities, load the firmware before you register, like I did
with my [RFC] patch to ar9170 (which I'll be sending soon since the
required patch is going into mainline).

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091214/727746f5/attachment.pgp>

From zajec5polish at gmail.com  Mon Dec 14 22:43:50 2009
From: zajec5polish at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 14 Dec 2009 22:43:50 +0100
Subject: [PATCH] b43: add config option to force QoS off
In-Reply-To: <1260779796.2442.343.camel@johannes.local>
References: <1260722731-4348-1-git-send-email-albert_herranz@yahoo.es>
	<200912131846.23302.mb@bu3sch.de> <4B252FCA.3060508@yahoo.es>
	<1260779796.2442.343.camel@johannes.local>
Message-ID: <14b026160912141343u305868a4od3eac3e04b8fb024@mail.gmail.com>

2009/12/14 Johannes Berg <johannes at sipsolutions.net>:
> On Sun, 2009-12-13 at 19:17 +0100, Albert Herranz wrote:
>
>> > Well, something in mac80211 was changed that breaks this.
>> > mac80211 currently seems to assume that the number of queues does not change
>> > after ieee80211_register, which was not the case previously. This breaks
>> > the QoS disable, because b43 modifies the nr of queues variable in the
>> > ieee80211_hw structure.
>> >
>> >> This patch adds a config option to allow disabling QoS from the beginning.
>> >> This is the only way to workaround the described problem when building the
>> >> b43 driver in-kernel, as in that case modparam_qos can't be changed.
>> >>
>> >> Signed-off-by: Albert Herranz <albert_herranz at yahoo.es>
>> >
>> > Why are we currently adding all kind of workaround patches instead of fixing the bugs?
>> > This bug's been there for months, so I don't see a reason to push out a workaround now.
>> >
>>
>> I'm fine not pushing this workaround upstream. I can carry the workaround locally.
>>
>> Is someone (apart from you) aware of this bug and looking at mac80211 to fix it?
>
> I don't even consider it a bug in mac80211. Once you register your
> capabilities, they're fair game. If you need to register them based on
> firmware capabilities, load the firmware before you register, like I did
> with my [RFC] patch to ar9170 (which I'll be sending soon since the
> required patch is going into mainline).

I believe we ieee80211_register_hw in b43 once but it may happen we
reload firmware while having device still registered. Should we really
ieee80211_unregister_hw and ieee80211_register_hw on every time we
reload firmware (as we may load one with other capabilities)?

-- 
Rafa?


From johannes at sipsolutions.net  Tue Dec 15 09:37:00 2009
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 15 Dec 2009 09:37:00 +0100
Subject: [PATCH] b43: add config option to force QoS off
In-Reply-To: <14b026160912141343u305868a4od3eac3e04b8fb024@mail.gmail.com>
References: <1260722731-4348-1-git-send-email-albert_herranz@yahoo.es>
	<200912131846.23302.mb@bu3sch.de> <4B252FCA.3060508@yahoo.es>
	<1260779796.2442.343.camel@johannes.local>
	<14b026160912141343u305868a4od3eac3e04b8fb024@mail.gmail.com>
Message-ID: <1260866220.1463.1.camel@johannes.local>

On Mon, 2009-12-14 at 22:43 +0100, Rafa? Mi?ecki wrote:

> I believe we ieee80211_register_hw in b43 once but it may happen we
> reload firmware while having device still registered. Should we really
> ieee80211_unregister_hw and ieee80211_register_hw on every time we
> reload firmware (as we may load one with other capabilities)?

Afaict the driver never reloads the firmware from userspace, it just
reprograms it onto the device, so your question is moot. However, it
does register _before_ loading it, the new async work allows it to do it
the other way around.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091215/e4234ede/attachment.pgp>

From esigra at gmail.com  Fri Dec 18 11:53:38 2009
From: esigra at gmail.com (Erik)
Date: Fri, 18 Dec 2009 11:53:38 +0100
Subject: ssb: ERROR: PLL init unknown for device 4322
Message-ID: <4B2B5F32.9050208@gmail.com>

I just bought a new laptop and installed Gentoo on it:
# dmesg|grep -i error
[    4.113200] ssb: ERROR: PLL init unknown for device 4322
[    4.113201] ssb: ERROR: PMU resource config unknown for device 4322
[    4.702250] b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 8, Type 4,
Revision 4)
[    4.702308] b43: probe of ssb0:0 failed with error -95
# lspci|grep 43
0e:00.0 Network controller: Broadcom Corporation BCM4322 802.11a/b/g/n
Wireless LAN Controller (rev 01)

Is there anything that I can try or any information that I can provide
to make it work?


From netrolller.3d at gmail.com  Fri Dec 18 17:19:55 2009
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 18 Dec 2009 17:19:55 +0100
Subject: ssb: ERROR: PLL init unknown for device 4322
In-Reply-To: <4B2B5F32.9050208@gmail.com>
References: <4B2B5F32.9050208@gmail.com>
Message-ID: <69e28c910912180819sf316508t45b4a1e1938cf803@mail.gmail.com>

On Fri, Dec 18, 2009 at 11:53 AM, Erik <esigra at gmail.com> wrote:
> I just bought a new laptop and installed Gentoo on it:
> # dmesg|grep -i error
> [ ? ?4.113200] ssb: ERROR: PLL init unknown for device 4322
> [ ? ?4.113201] ssb: ERROR: PMU resource config unknown for device 4322
> [ ? ?4.702250] b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 8, Type 4,
> Revision 4)
> [ ? ?4.702308] b43: probe of ssb0:0 failed with error -95
> # lspci|grep 43
> 0e:00.0 Network controller: Broadcom Corporation BCM4322 802.11a/b/g/n
> Wireless LAN Controller (rev 01)
>
> Is there anything that I can try or any information that I can provide
> to make it work?

BCM4322 is an N-PHY device, which is not yet supported; it will
probably be the next thing I will implement, once Larry completes the
reverse engineering for this PHY.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Dec 18 18:07:38 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 18 Dec 2009 11:07:38 -0600
Subject: ssb: ERROR: PLL init unknown for device 4322
In-Reply-To: <69e28c910912180819sf316508t45b4a1e1938cf803@mail.gmail.com>
References: <4B2B5F32.9050208@gmail.com>
	<69e28c910912180819sf316508t45b4a1e1938cf803@mail.gmail.com>
Message-ID: <4B2BB6DA.3000907@lwfinger.net>

On 12/18/2009 10:19 AM, G?bor Stefanik wrote:
>>
>> Is there anything that I can try or any information that I can provide
>> to make it work?
> 
> BCM4322 is an N-PHY device, which is not yet supported; it will
> probably be the next thing I will implement, once Larry completes the
> reverse engineering for this PHY.

Besides the type 4 N PHY, I also have to do the RE for the type 6 PHY,
which is known as an SSLPN PHY (single-stream low-power N PHY). :)

To make your 4322 work now, you need to implement the Broadcom hybrid
STA wl driver. You can build that from files obtained from Broadcom,
or many distros have a pre-made package.

Larry


From Larry.Finger at lwfinger.net  Sat Dec 19 07:26:10 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 00:26:10 -0600
Subject: PCI config register 0x40
Message-ID: <4B2C7202.3070108@lwfinger.net>

Michael,

As you may recall, I dumped writes to the PCI config space for both
b43 and the wl driver. I found that wl wrote to address 0x40. In
looking around other drivers, I found the following fragment in ipw2100:

        /* We disable the RETRY_TIMEOUT register (0x41) to keep
         * PCI Tx retries from interfering with C3 CPU state */
        pci_read_config_dword(pci_dev, 0x40, &val);
        if ((val & 0x0000ff00) != 0)
                pci_write_config_dword(pci_dev, 0x40, val &
				       0xffff00ff);

There is a similar fragment in the resume routine.

This change is probably not responsible for the DMA errors in the
4315, but there still could be some affect. Do you want to prepare a
patch for ssb, or should I do it?

Larry


From mb at bu3sch.de  Sat Dec 19 11:11:54 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 19 Dec 2009 11:11:54 +0100
Subject: PCI config register 0x40
In-Reply-To: <4B2C7202.3070108@lwfinger.net>
References: <4B2C7202.3070108@lwfinger.net>
Message-ID: <200912191111.56047.mb@bu3sch.de>

On Saturday 19 December 2009 07:26:10 Larry Finger wrote:
> Michael,
> 
> As you may recall, I dumped writes to the PCI config space for both
> b43 and the wl driver. I found that wl wrote to address 0x40. In
> looking around other drivers, I found the following fragment in ipw2100:
> 
>         /* We disable the RETRY_TIMEOUT register (0x41) to keep
>          * PCI Tx retries from interfering with C3 CPU state */
>         pci_read_config_dword(pci_dev, 0x40, &val);
>         if ((val & 0x0000ff00) != 0)
>                 pci_write_config_dword(pci_dev, 0x40, val &
> 				       0xffff00ff);

Well, if 0x40 is used as "RETRY_TIMEOUT" in ipw, that doesn't
mean it's the same in b43. Is the 0x40 register standardized in any way?

And if you do a patch, don't put it into ssb. Put it into b43.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Sat Dec 19 16:00:49 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 09:00:49 -0600
Subject: PCI config register 0x40
In-Reply-To: <200912191111.56047.mb@bu3sch.de>
References: <4B2C7202.3070108@lwfinger.net> <200912191111.56047.mb@bu3sch.de>
Message-ID: <4B2CEAA1.2050104@lwfinger.net>

On 12/19/2009 04:11 AM, Michael Buesch wrote:
> 
> Well, if 0x40 is used as "RETRY_TIMEOUT" in ipw, that doesn't
> mean it's the same in b43. Is the 0x40 register standardized in any way?

According to the Wikipedia article on PCI configuration space
registers, only up to 0x3F is standardized. There is, however, an
interesting article in
http://lkml.indiana.edu/hypermail/linux/kernel/0906.3/03376.html. In
the ath9k driver, similar code was removed in a clean-up, but had to
be restored as some cards got PCI fatal interrupts. I also found a
similar fragment in the C source part of the Broadcom hybrid driver.

> And if you do a patch, don't put it into ssb. Put it into b43.

I will put it in b43 as you request.

Larry


From Larry.Finger at lwfinger.net  Sat Dec 19 17:11:30 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 10:11:30 -0600
Subject: PCI config register 0x40
In-Reply-To: <200912191111.56047.mb@bu3sch.de>
References: <4B2C7202.3070108@lwfinger.net> <200912191111.56047.mb@bu3sch.de>
Message-ID: <4B2CFB32.6000408@lwfinger.net>

On 12/19/2009 04:11 AM, Michael Buesch wrote:
> 
> And if you do a patch, don't put it into ssb. Put it into b43.

One further question about putting the patch into b43. Apparently,
register 0x40 is not preserved across a suspend/resume to disk. In all
the drivers that use this code, 0x40 is modified in the .probe and
.resume routines. As b43 does the resume indirectly through mac80211,
an alternate location is needed. It looks to me that placing the code
in b43_wireless_core_init() would satisfy both needs. Is that correct?

Larry





From Larry.Finger at lwfinger.net  Sat Dec 19 17:43:29 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 10:43:29 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <20091124163536.78276489@boulder.homenet>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
Message-ID: <4B2D02B1.80006@lwfinger.net>

Hi,

If possible, please test this patch starting from a cold boot. It is a
variation of something we tried earlier, but enough different to try it.

Thanks,

Larry

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: b43_no_interfere_C3
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091219/9fdad9e0/attachment.ksh>

From mb at bu3sch.de  Sat Dec 19 19:21:20 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 19 Dec 2009 19:21:20 +0100
Subject: PCI config register 0x40
In-Reply-To: <4B2CFB32.6000408@lwfinger.net>
References: <4B2C7202.3070108@lwfinger.net> <200912191111.56047.mb@bu3sch.de>
	<4B2CFB32.6000408@lwfinger.net>
Message-ID: <200912191921.22331.mb@bu3sch.de>

On Saturday 19 December 2009 17:11:30 Larry Finger wrote:
> On 12/19/2009 04:11 AM, Michael Buesch wrote:
> > 
> > And if you do a patch, don't put it into ssb. Put it into b43.
> 
> One further question about putting the patch into b43. Apparently,
> register 0x40 is not preserved across a suspend/resume to disk. In all
> the drivers that use this code, 0x40 is modified in the .probe and
> .resume routines. As b43 does the resume indirectly through mac80211,
> an alternate location is needed. It looks to me that placing the code
> in b43_wireless_core_init() would satisfy both needs. Is that correct?

Yes. Also don't forget to test bus->bustype==SSB_BUSTYPE_PCI before
accessing bus->host_pci.


-- 
Greetings, Michael.


From chris at cvine.freeserve.co.uk  Sat Dec 19 20:55:24 2009
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sat, 19 Dec 2009 19:55:24 +0000
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <4B2D02B1.80006@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com> <200911131216.43704.mb@bu3sch.de>
	<4AFD83CA.2050508@lwfinger.net> <200911131836.26857.mb@bu3sch.de>
	<4AFD9E20.3060501@gmail.com> <4AFDD1C9.4050402@lwfinger.net>
	<4AFDF68C.4040804@polymtl.ca> <4AFE1E5F.9040009@lwfinger.net>
	<4AFEFC2C.5030704@polymtl.ca> <4B068ED9.5070107@lwfinger.net>
	<4B0B59EC.2000809@polymtl.ca>
	<20091124095436.7a4176a1@boulder.homenet>
	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B2D02B1.80006@lwfinger.net>
Message-ID: <20091219195524.4ffafdc0@laptop.homenet>

On Sat, 19 Dec 2009 10:43:29 -0600
Larry Finger <Larry.Finger at lwfinger.net> wrote:
> Hi,
> 
> If possible, please test this patch starting from a cold boot. It is a
> variation of something we tried earlier, but enough different to try
> it.
> 
> Thanks,
> 
> Larry

I applied this to 2.6.32.2 and it didn't help with the DMA errors I am
afraid.

Chris


From b3nton at gmail.com  Sun Dec 20 00:11:01 2009
From: b3nton at gmail.com (Andrew Benton)
Date: Sat, 19 Dec 2009 23:11:01 +0000
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <20091219195524.4ffafdc0@laptop.homenet>
References: <4AFA09C8.4060602@gmail.com>	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>	<20091124163536.78276489@boulder.homenet>	<4B2D02B1.80006@lwfinger.net>
	<20091219195524.4ffafdc0@laptop.homenet>
Message-ID: <4B2D5D85.4040900@gmail.com>

On 19/12/09 19:55, Chris Vine wrote:
> On Sat, 19 Dec 2009 10:43:29 -0600
> Larry Finger<Larry.Finger at lwfinger.net>  wrote:
>> Hi,
>>
>> If possible, please test this patch starting from a cold boot. It is a
>> variation of something we tried earlier, but enough different to try
>> it.
>>
>> Thanks,
>>
>> Larry
>
> I applied this to 2.6.32.2 and it didn't help with the DMA errors I am
> afraid.
>
> Chris
>

Same here, the patch didn't prevent the DMA errors, however, I did 
notice that it only reported the error once, it didn't keep trying to 
reload the firmware.

Andy


From Larry.Finger at lwfinger.net  Sun Dec 20 04:44:10 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 21:44:10 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <4B2D5D85.4040900@gmail.com>
References: <4AFA09C8.4060602@gmail.com>	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>	<20091124163536.78276489@boulder.homenet>	<4B2D02B1.80006@lwfinger.net>	<20091219195524.4ffafdc0@laptop.homenet>
	<4B2D5D85.4040900@gmail.com>
Message-ID: <4B2D9D8A.4030008@lwfinger.net>

On 12/19/2009 05:11 PM, Andrew Benton wrote:
> On 19/12/09 19:55, Chris Vine wrote:
>>
>> I applied this to 2.6.32.2 and it didn't help with the DMA errors I am
>> afraid.
>>
>> Chris
>>
> 
> Same here, the patch didn't prevent the DMA errors, however, I did 
> notice that it only reported the error once, it didn't keep trying to 
> reload the firmware.

The change that bails out after one fatal DMA error is a separate one.
As there is no chance of recovering, we decided not to spam the logs.

Thanks for testing. I had little expectation, but this one may be
needed in conjunction with something else. Back to the grindstone.

Larry


From william.bourque at polymtl.ca  Sun Dec 20 05:15:38 2009
From: william.bourque at polymtl.ca (William Bourque)
Date: Sat, 19 Dec 2009 23:15:38 -0500
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <4B2D02B1.80006@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B2D02B1.80006@lwfinger.net>
Message-ID: <4B2DA4EA.8060306@polymtl.ca>



Larry Finger wrote:
> Hi,
> 
> If possible, please test this patch starting from a cold boot. It is a
> variation of something we tried earlier, but enough different to try it.
> 
> Thanks,
> 
> Larry
> 

A little late but I just tested and I have the same bug.
However, unlike Andrew, the error keep repeating as before...

- William


From Larry.Finger at lwfinger.net  Sun Dec 20 05:47:55 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 22:47:55 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - another test
In-Reply-To: <4B2DA4EA.8060306@polymtl.ca>
References: <4AFA09C8.4060602@gmail.com>	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>	<20091124163536.78276489@boulder.homenet>	<4B2D02B1.80006@lwfinger.net>
	<4B2DA4EA.8060306@polymtl.ca>
Message-ID: <4B2DAC7B.3090201@lwfinger.net>

On 12/19/2009 10:15 PM, William Bourque wrote:
> 
> 
> Larry Finger wrote:
>> Hi,
>>
>> If possible, please test this patch starting from a cold boot. It is a
>> variation of something we tried earlier, but enough different to try it.
>>
>> Thanks,
>>
>> Larry
>>
> 
> A little late but I just tested and I have the same bug.
> However, unlike Andrew, the error keep repeating as before...

He is using wireless-testing or a recent mainline kernel. That is
where the change I described is installed.

Larry


From Larry.Finger at lwfinger.net  Sun Dec 20 06:01:05 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 19 Dec 2009 23:01:05 -0600
Subject: [PATCH] b43: Clear PCI configuration reg. 0x41 to avoid
	interference with C3 processor state
Message-ID: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>

In exploring the cause of DMA errors for BCM4312 devices on Atom
processors, other drivers that work write to PCI configuration
register 0x40. The code fragment below was found in the open-code
portion of the Broadcom hybrid wl driver. It is also used in the
ipw2100 and ath9k drivers. In the latter case, it had been removed
and later restored to prevent fatal interrupt errors.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

I think this is 2.6.34 material. By itself, it does not affect the
DMA errors in BCM4312 devices. If it is found to help in the resolution
of that long-standing problem, I will request a change in the status.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -4292,6 +4292,15 @@ static int b43_wireless_core_init(struct
 	setup_struct_wldev_for_init(dev);
 	phy->ops->prepare_structs(dev);
 
+	/* We disable the RETRY_TIMEOUT register (0x41) to keep
+	 * PCI Tx retries from interfering with C3 CPU state
+	 */
+	if (bus->bustype == SSB_BUSTYPE_PCI) {
+		pci_read_config_dword(bus->host_pci, 0x40, &tmp);
+		pci_write_config_dword(bus->host_pci, 0x40, tmp &
+				       ~(0x0000ff00));
+	}
+
 	/* Enable IRQ routing to this device. */
 	ssb_pcicore_dev_irqvecs_enable(&bus->pcicore, dev->dev);
 
Index: wireless-testing/drivers/ssb/pcihost_wrapper.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pcihost_wrapper.c
+++ wireless-testing/drivers/ssb/pcihost_wrapper.c
@@ -35,6 +35,7 @@ static int ssb_pcihost_resume(struct pci
 {
 	struct ssb_bus *ssb = pci_get_drvdata(dev);
 	int err;
+	u32 val;
 
 	pci_set_power_state(dev, 0);
 	err = pci_enable_device(dev);


From mcgrof at gmail.com  Sun Dec 20 07:51:17 2009
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Sat, 19 Dec 2009 22:51:17 -0800
Subject: [PATCH] b43: Clear PCI configuration reg. 0x41 to avoid 
	interference with C3 processor state
In-Reply-To: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>
References: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>
Message-ID: <43e72e890912192251r4de4a3c3idb5e4c3723ef87aa@mail.gmail.com>

On Sat, Dec 19, 2009 at 9:01 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> In exploring the cause of DMA errors for BCM4312 devices on Atom
> processors, other drivers that work write to PCI configuration
> register 0x40. The code fragment below was found in the open-code
> portion of the Broadcom hybrid wl driver. It is also used in the
> ipw2100 and ath9k drivers. In the latter case, it had been removed
> and later restored to prevent fatal interrupt errors.

I should note 0x40 starts with vendor specific PCI config space so you
cannot guarantee different PCI devices use 0x41 will be used the same
for different devices. The documentation for the ath9k PCI-E devices
used that entry for something completely different but what I did not
do is try to very and ensure PCI devices do not use it it for the
same. I am told though that although this is PCI vendor space some
devices may still use similar private PCI config spaces on different
devices which just follows a practice. At this point we now have not
only b43, ipw and ath9k follow this but also prism54 and I think p54
uses this. I'll note I *highly* doubt this is used for the same thing
on all these devices and was just code copied from other Linux
drivers. In the case of Atheros Linux drivers I know it was copied
form Intel drivers, which is why I started questioning it all.

Anyway, if it helps, that's great :) but it cannot be concluded its
all for the same thing unless you have proper documentation as this is
in PCI vendor space which *can* vary depending on device and vendor.

  Luis


From mcgrof at gmail.com  Sun Dec 20 22:53:42 2009
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Sun, 20 Dec 2009 13:53:42 -0800
Subject: [PATCH] b43: Clear PCI configuration reg. 0x41 to avoid 
	interference with C3 processor state
In-Reply-To: <43e72e890912192251r4de4a3c3idb5e4c3723ef87aa@mail.gmail.com>
References: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net> 
	<43e72e890912192251r4de4a3c3idb5e4c3723ef87aa@mail.gmail.com>
Message-ID: <43e72e890912201353t491b7d97of1520e7995c0ef5b@mail.gmail.com>

On Sat, Dec 19, 2009 at 10:51 PM, Luis R. Rodriguez <mcgrof at gmail.com> wrote:
> On Sat, Dec 19, 2009 at 9:01 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>> In exploring the cause of DMA errors for BCM4312 devices on Atom
>> processors, other drivers that work write to PCI configuration
>> register 0x40. The code fragment below was found in the open-code
>> portion of the Broadcom hybrid wl driver. It is also used in the
>> ipw2100 and ath9k drivers. In the latter case, it had been removed
>> and later restored to prevent fatal interrupt errors.
>
> I should note 0x40 starts with vendor specific PCI config space so you
> cannot guarantee different PCI devices use 0x41 will be used the same
> for different devices. The documentation for the ath9k PCI-E devices
> used that entry for something completely different but what I did not
> do is try to very and ensure PCI devices do not use it it for the
> same. I am told though that although this is PCI vendor space some
> devices may still use similar private PCI config spaces on different
> devices which just follows a practice. At this point we now have not
> only b43, ipw and ath9k follow this but also prism54 and I think p54
> uses this. I'll note I *highly* doubt this is used for the same thing
> on all these devices and was just code copied from other Linux
> drivers. In the case of Atheros Linux drivers I know it was copied
> form Intel drivers, which is why I started questioning it all.
>
> Anyway, if it helps, that's great :) but it cannot be concluded its
> all for the same thing unless you have proper documentation as this is
> in PCI vendor space which *can* vary depending on device and vendor.

Larry, does this actually fix something or is this code purely speculative?

  Luis


From Larry.Finger at lwfinger.net  Sun Dec 20 23:23:48 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 20 Dec 2009 16:23:48 -0600
Subject: [PATCH] b43: Clear PCI configuration reg. 0x41 to avoid
	interference with C3 processor state
In-Reply-To: <43e72e890912201353t491b7d97of1520e7995c0ef5b@mail.gmail.com>
References: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>
	<43e72e890912192251r4de4a3c3idb5e4c3723ef87aa@mail.gmail.com>
	<43e72e890912201353t491b7d97of1520e7995c0ef5b@mail.gmail.com>
Message-ID: <4B2EA3F4.8040108@lwfinger.net>

On 12/20/2009 03:53 PM, Luis R. Rodriguez wrote:
>> I should note 0x40 starts with vendor specific PCI config space so you
>> cannot guarantee different PCI devices use 0x41 will be used the same
>> for different devices. The documentation for the ath9k PCI-E devices
>> used that entry for something completely different but what I did not
>> do is try to very and ensure PCI devices do not use it it for the
>> same. I am told though that although this is PCI vendor space some
>> devices may still use similar private PCI config spaces on different
>> devices which just follows a practice. At this point we now have not
>> only b43, ipw and ath9k follow this but also prism54 and I think p54
>> uses this. I'll note I *highly* doubt this is used for the same thing
>> on all these devices and was just code copied from other Linux
>> drivers. In the case of Atheros Linux drivers I know it was copied
>> form Intel drivers, which is why I started questioning it all.
>>
>> Anyway, if it helps, that's great :) but it cannot be concluded its
>> all for the same thing unless you have proper documentation as this is
>> in PCI vendor space which *can* vary depending on device and vendor.
> 
> Larry, does this actually fix something or is this code purely speculative?

I got on this idea because I logged all PCI configuration read/write
values and discovered that the Broadcom wl driver did a read/write on
this location. A later examination of the open-source part of that
driver showed that they copied it from ipw2100. If anyone knows the
layout of the private area of the configuration space, they should;
however, they may be just propagating the code as you say.

This change does not fix the DMA error problem with Atom processors in
Netbooks. We have had one report of DMA errors in a Core Duo system -
AFAIK, the only non-Atom processor with the problem. That user has not
tested this patch.

Larry


From Larry.Finger at lwfinger.net  Sun Dec 20 23:25:30 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 20 Dec 2009 16:25:30 -0600
Subject: [PATCH] b43: Clear PCI configuration reg. 0x41 to
	avoid	interference with C3 processor state
In-Reply-To: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>
References: <4b2daf91.VB5IdAW/+fSDNPPV%Larry.Finger@lwfinger.net>
Message-ID: <4B2EA45A.3060507@lwfinger.net>

On 12/19/2009 11:01 PM, Larry Finger wrote:
> In exploring the cause of DMA errors for BCM4312 devices on Atom
> processors, other drivers that work write to PCI configuration
> register 0x40. The code fragment below was found in the open-code
> portion of the Broadcom hybrid wl driver. It is also used in the
> ipw2100 and ath9k drivers. In the latter case, it had been removed
> and later restored to prevent fatal interrupt errors.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> I think this is 2.6.34 material. By itself, it does not affect the
> DMA errors in BCM4312 devices. If it is found to help in the resolution
> of that long-standing problem, I will request a change in the status.
> 
> Larry
> ---

John,

Please consider this patch retracted. If I actually find that it helps
some system, I'll resubmit it then.

Larry



From Larry.Finger at lwfinger.net  Mon Dec 21 22:31:10 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 21 Dec 2009 15:31:10 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <20091124163536.78276489@boulder.homenet>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
Message-ID: <4B2FE91E.9060103@lwfinger.net>

Hi,

I placed a number of test prints in my system trying to find where a
DMA data error might occur. In doing so, I found that 3 slots in the
DMA header cache cross a page boundary. Such a situation is allowed on
my system, but it might be forbidden on Atom processors. Please try
this really ugly hack to see if it makes any difference.

Thanks,

Larry


-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: b43_further_alignment
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091221/03ba58ca/attachment.ksh>

From mb at bu3sch.de  Mon Dec 21 22:47:02 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 21 Dec 2009 22:47:02 +0100
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FE91E.9060103@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com>
	<20091124163536.78276489@boulder.homenet>
	<4B2FE91E.9060103@lwfinger.net>
Message-ID: <200912212247.04249.mb@bu3sch.de>

On Monday 21 December 2009 22:31:10 Larry Finger wrote:
> Hi,
> 
> I placed a number of test prints in my system trying to find where a
> DMA data error might occur. In doing so, I found that 3 slots in the
> DMA header cache cross a page boundary. Such a situation is allowed on
> my system, but it might be forbidden on Atom processors. Please try
> this really ugly hack to see if it makes any difference.

First thing is that the DMA buffers are allowed to cross any boundary (and
the header is just a buffer). The boundary requirements only apply to the
memory holding the descriptors.

Second thing is: How does the patch prevent a boundary crossing?

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Mon Dec 21 23:02:39 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 21 Dec 2009 16:02:39 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <200912212247.04249.mb@bu3sch.de>
References: <4AFA09C8.4060602@gmail.com>
	<20091124163536.78276489@boulder.homenet>
	<4B2FE91E.9060103@lwfinger.net> <200912212247.04249.mb@bu3sch.de>
Message-ID: <4B2FF07F.1000702@lwfinger.net>

On 12/21/2009 03:47 PM, Michael Buesch wrote:
> On Monday 21 December 2009 22:31:10 Larry Finger wrote:
>> Hi,
>>
>> I placed a number of test prints in my system trying to find where a
>> DMA data error might occur. In doing so, I found that 3 slots in the
>> DMA header cache cross a page boundary. Such a situation is allowed on
>> my system, but it might be forbidden on Atom processors. Please try
>> this really ugly hack to see if it makes any difference.
> 
> First thing is that the DMA buffers are allowed to cross any boundary (and
> the header is just a buffer). The boundary requirements only apply to the
> memory holding the descriptors.

That is what we will test for the Atom. I know it doesn't matter for
my CPU, but ...

> Second thing is: How does the patch prevent a boundary crossing?

The number of slots is reduced to the point that the header cache fits
in one page, just as the RX header cache does. As I said, this is
really ugly. If this fixes the problem, then a more elegant fix will
be needed.

Larry


From mb at bu3sch.de  Mon Dec 21 23:11:54 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 21 Dec 2009 23:11:54 +0100
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FF07F.1000702@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com> <200912212247.04249.mb@bu3sch.de>
	<4B2FF07F.1000702@lwfinger.net>
Message-ID: <200912212311.56628.mb@bu3sch.de>

On Monday 21 December 2009 23:02:39 Larry Finger wrote:
> On 12/21/2009 03:47 PM, Michael Buesch wrote:
> > On Monday 21 December 2009 22:31:10 Larry Finger wrote:
> >> Hi,
> >>
> >> I placed a number of test prints in my system trying to find where a
> >> DMA data error might occur. In doing so, I found that 3 slots in the
> >> DMA header cache cross a page boundary. Such a situation is allowed on
> >> my system, but it might be forbidden on Atom processors. Please try
> >> this really ugly hack to see if it makes any difference.
> > 
> > First thing is that the DMA buffers are allowed to cross any boundary (and
> > the header is just a buffer). The boundary requirements only apply to the
> > memory holding the descriptors.
> 
> That is what we will test for the Atom. I know it doesn't matter for
> my CPU, but ...

I'm pretty sure the broadcom DMA engine is not _that_ braindead.
(It is pretty weird, but not _that_ weird).
It would effectively mean that we'd have to bouncebuffer _every_ TX packet.

> > Second thing is: How does the patch prevent a boundary crossing?
> 
> The number of slots is reduced to the point that the header cache fits
> in one page, just as the RX header cache does. As I said, this is
> really ugly. If this fixes the problem, then a more elegant fix will
> be needed.

But the allocation is not required to be aligned to the page start.
The first header might start at offset 4000 of a page, so you cross
the page border after the first few headers.

-- 
Greetings, Michael.


From william.bourque at polymtl.ca  Mon Dec 21 23:18:01 2009
From: william.bourque at polymtl.ca (William Bourque)
Date: Mon, 21 Dec 2009 17:18:01 -0500
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FE91E.9060103@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B2FE91E.9060103@lwfinger.net>
Message-ID: <4B2FF419.8030104@polymtl.ca>



Larry Finger wrote:
> Hi,
> 
> I placed a number of test prints in my system trying to find where a
> DMA data error might occur. In doing so, I found that 3 slots in the
> DMA header cache cross a page boundary. Such a situation is allowed on
> my system, but it might be forbidden on Atom processors. Please try
> this really ugly hack to see if it makes any difference.

I confirm that the DMA error is still present with this patch.

- William

> 
> Thanks,
> 
> Larry
> 


From Larry.Finger at lwfinger.net  Mon Dec 21 23:20:06 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 21 Dec 2009 16:20:06 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <200912212311.56628.mb@bu3sch.de>
References: <4AFA09C8.4060602@gmail.com> <200912212247.04249.mb@bu3sch.de>
	<4B2FF07F.1000702@lwfinger.net> <200912212311.56628.mb@bu3sch.de>
Message-ID: <4B2FF496.6000803@lwfinger.net>

On 12/21/2009 04:11 PM, Michael Buesch wrote:
> On Monday 21 December 2009 23:02:39 Larry Finger wrote:
>> On 12/21/2009 03:47 PM, Michael Buesch wrote:
>>> On Monday 21 December 2009 22:31:10 Larry Finger wrote:
>>>> Hi,
>>>>
>>>> I placed a number of test prints in my system trying to find where a
>>>> DMA data error might occur. In doing so, I found that 3 slots in the
>>>> DMA header cache cross a page boundary. Such a situation is allowed on
>>>> my system, but it might be forbidden on Atom processors. Please try
>>>> this really ugly hack to see if it makes any difference.
>>>
>>> First thing is that the DMA buffers are allowed to cross any boundary (and
>>> the header is just a buffer). The boundary requirements only apply to the
>>> memory holding the descriptors.
>>
>> That is what we will test for the Atom. I know it doesn't matter for
>> my CPU, but ...
> 
> I'm pretty sure the broadcom DMA engine is not _that_ braindead.
> (It is pretty weird, but not _that_ weird).
> It would effectively mean that we'd have to bouncebuffer _every_ TX packet.

I'm not that worried about the Broadcom implementation as I am about
the support chips on the Netbooks.

>>> Second thing is: How does the patch prevent a boundary crossing?
>>
>> The number of slots is reduced to the point that the header cache fits
>> in one page, just as the RX header cache does. As I said, this is
>> really ugly. If this fixes the problem, then a more elegant fix will
>> be needed.
> 
> But the allocation is not required to be aligned to the page start.
> The first header might start at offset 4000 of a page, so you cross
> the page border after the first few headers.

Here, it was slot 74 that crossed the page boundary. At 110 bytes per
every 2 slots, that works out to 4070 bytes for 0 - 73. From that, I
infer that the cache starts on a page boundary.

Larry


From Larry.Finger at lwfinger.net  Mon Dec 21 23:24:52 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 21 Dec 2009 16:24:52 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FF419.8030104@polymtl.ca>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B2FE91E.9060103@lwfinger.net> <4B2FF419.8030104@polymtl.ca>
Message-ID: <4B2FF5B4.1060503@lwfinger.net>

On 12/21/2009 04:18 PM, William Bourque wrote:
> 
> 
> Larry Finger wrote:
>> Hi,
>>
>> I placed a number of test prints in my system trying to find where a
>> DMA data error might occur. In doing so, I found that 3 slots in the
>> DMA header cache cross a page boundary. Such a situation is allowed on
>> my system, but it might be forbidden on Atom processors. Please try
>> this really ugly hack to see if it makes any difference.
> 
> I confirm that the DMA error is still present with this patch.

Thanks for testing. The results are as Michael expected, and as I feared.

Larry




From mb at bu3sch.de  Mon Dec 21 23:25:10 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 21 Dec 2009 23:25:10 +0100
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FF496.6000803@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com> <200912212311.56628.mb@bu3sch.de>
	<4B2FF496.6000803@lwfinger.net>
Message-ID: <200912212325.12486.mb@bu3sch.de>

On Monday 21 December 2009 23:20:06 Larry Finger wrote:
> Here, it was slot 74 that crossed the page boundary. At 110 bytes per
> every 2 slots, that works out to 4070 bytes for 0 - 73. From that, I
> infer that the cache starts on a page boundary.

Yeah well. For you.

-- 
Greetings, Michael.


From chris at cvine.freeserve.co.uk  Mon Dec 21 23:31:23 2009
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Mon, 21 Dec 2009 22:31:23 +0000
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 2
In-Reply-To: <4B2FF419.8030104@polymtl.ca>
References: <4AFA09C8.4060602@gmail.com> <200911131216.43704.mb@bu3sch.de>
	<4AFD83CA.2050508@lwfinger.net> <200911131836.26857.mb@bu3sch.de>
	<4AFD9E20.3060501@gmail.com> <4AFDD1C9.4050402@lwfinger.net>
	<4AFDF68C.4040804@polymtl.ca> <4AFE1E5F.9040009@lwfinger.net>
	<4AFEFC2C.5030704@polymtl.ca> <4B068ED9.5070107@lwfinger.net>
	<4B0B59EC.2000809@polymtl.ca>
	<20091124095436.7a4176a1@boulder.homenet>
	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B2FE91E.9060103@lwfinger.net> <4B2FF419.8030104@polymtl.ca>
Message-ID: <20091221223123.1343ca2a@laptop.homenet>

On Mon, 21 Dec 2009 17:18:01 -0500
William Bourque <william.bourque at polymtl.ca> wrote:
> Larry Finger wrote:
> > Hi,
> > 
> > I placed a number of test prints in my system trying to find where a
> > DMA data error might occur. In doing so, I found that 3 slots in the
> > DMA header cache cross a page boundary. Such a situation is allowed
> > on my system, but it might be forbidden on Atom processors. Please
> > try this really ugly hack to see if it makes any difference.
> 
> I confirm that the DMA error is still present with this patch.

Ditto.

Chris


From zajec5 at gmail.com  Tue Dec 22 02:40:45 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 22 Dec 2009 02:40:45 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
Message-ID: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>

It's just compilation-tested as I don't own N-PHY device yet (should receive
one for Christmas). Not sure if we even support SSB used for N-PHY cards.


From Larry.Finger at lwfinger.net  Tue Dec 22 04:08:59 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 21 Dec 2009 21:08:59 -0600
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
Message-ID: <4B30384B.6040102@lwfinger.net>

On 12/21/2009 07:40 PM, Rafa? Mi?ecki wrote:
> It's just compilation-tested as I don't own N-PHY device yet (should
> receive one for Christmas). Not sure if we even support SSB used for
> N-PHY cards.

I think N PHY cards are supported by SSB. There may be some things to
be extracted from the SPROM, but otherwise it should be OK.

To get N PHY stuff to compile, you need the following patch:



Index: wireless-testing/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
+++ wireless-testing/drivers/net/wireless/b43/Kconfig
@@ -81,7 +81,7 @@ config B43_SDIO

 config B43_NPHY
 	bool "Pre IEEE 802.11n support (BROKEN)"
-	depends on B43 && EXPERIMENTAL && BROKEN
+	depends on B43 && EXPERIMENTAL
 	---help---
 	  Support for the IEEE 802.11n draft.


Larry



From zajec5 at gmail.com  Tue Dec 22 07:47:58 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 22 Dec 2009 07:47:58 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <4B30384B.6040102@lwfinger.net>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
	<4B30384B.6040102@lwfinger.net>
Message-ID: <b170af450912212247q2a01f07ft22b03af2ff207016@mail.gmail.com>

W dniu 22 grudnia 2009 04:08 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 12/21/2009 07:40 PM, Rafa? Mi?ecki wrote:
>> It's just compilation-tested as I don't own N-PHY device yet (should
>> receive one for Christmas). Not sure if we even support SSB used for
>> N-PHY cards.
>
> I think N PHY cards are supported by SSB. There may be some things to
> be extracted from the SPROM, but otherwise it should be OK.

Good to known. I'll test that when I receive my gift :) My doubts came from
https://lists.berlios.de/pipermail/bcm43xx-dev/2009-December/006541.html


> To get N PHY stuff to compile, you need the following patch:
>
>
>
> Index: wireless-testing/drivers/net/wireless/b43/Kconfig
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
> +++ wireless-testing/drivers/net/wireless/b43/Kconfig
> @@ -81,7 +81,7 @@ config B43_SDIO
>
> ?config B43_NPHY
> ? ? ? ?bool "Pre IEEE 802.11n support (BROKEN)"
> - ? ? ? depends on B43 && EXPERIMENTAL && BROKEN
> + ? ? ? depends on B43 && EXPERIMENTAL
> ? ? ? ?---help---
> ? ? ? ? ?Support for the IEEE 802.11n draft.

Sure, I've applied this locally as first thing. If I didn't I couldn't
compile-test my patch :)

-- 
Rafa?


From zajec5 at gmail.com  Wed Dec 23 11:34:39 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 23 Dec 2009 11:34:39 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
Message-ID: <b170af450912230234q34920ab1u9dfedc9d18d65201@mail.gmail.com>

W dniu 22 grudnia 2009 02:40 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> It's just compilation-tested as I don't own N-PHY device yet (should receive
> one for Christmas). Not sure if we even support SSB used for N-PHY cards.

Is posting on this ML enough to get patch in testing and mainline
later? If it just needs some time, *I am completely fine with it*.

I ask because maybe I'm waiting for something that won't happen due to
my (some) mistake. Should I do anything else to get this patch
reviewed & up?

-- 
Rafa?


From mb at bu3sch.de  Wed Dec 23 12:02:25 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 23 Dec 2009 12:02:25 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <b170af450912230234q34920ab1u9dfedc9d18d65201@mail.gmail.com>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
	<b170af450912230234q34920ab1u9dfedc9d18d65201@mail.gmail.com>
Message-ID: <200912231202.26923.mb@bu3sch.de>

On Wednesday 23 December 2009 11:34:39 Rafa? Mi?ecki wrote:
> W dniu 22 grudnia 2009 02:40 u?ytkownik Rafa? Mi?ecki
> <zajec5 at gmail.com> napisa?:
> > It's just compilation-tested as I don't own N-PHY device yet (should receive
> > one for Christmas). Not sure if we even support SSB used for N-PHY cards.
> 
> Is posting on this ML enough to get patch in testing and mainline
> later? If it just needs some time, *I am completely fine with it*.
> 
> I ask because maybe I'm waiting for something that won't happen due to
> my (some) mistake. Should I do anything else to get this patch
> reviewed & up?

Send it to John Linville and the linux wireless list. Also CCing this list is a good idea.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Wed Dec 23 13:01:58 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 23 Dec 2009 13:01:58 +0100
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table init, 
	check PHY rev
Message-ID: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>

It's just compilation-tested as I don't own N-PHY device yet (should receive
one for Christmas). Of course I enabled N-PHY in Kconfig.

I already sent this to bcm43xx-dev but didn't get any review. Michael told
me to send it to you John and to linux-wireless. Is there anyone how could
review/ack my patch?


From zajec5 at gmail.com  Wed Dec 23 16:10:35 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 23 Dec 2009 16:10:35 +0100
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table init, 
	check PHY rev
In-Reply-To: <20091223145211.GB2811@tuxdriver.com>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
	<20091223145211.GB2811@tuxdriver.com>
Message-ID: <b170af450912230710t77cc614j25f058b64c4ce51@mail.gmail.com>

W dniu 23 grudnia 2009 15:52 u?ytkownik John W. Linville
<linville at tuxdriver.com> napisa?:
> On Wed, Dec 23, 2009 at 01:01:58PM +0100, Rafa? Mi?ecki wrote:
>> It's just compilation-tested as I don't own N-PHY device yet (should receive
>> one for Christmas). Of course I enabled N-PHY in Kconfig.
>>
>> I already sent this to bcm43xx-dev but didn't get any review. Michael told
>> me to send it to you John and to linux-wireless. Is there anyone how could
>> review/ack my patch?
>>
>>
>> From 6800722c2fda0e302d7c759a5f2a993503b6581a Mon Sep 17 00:00:00 2001
>> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
>> Date: Tue, 22 Dec 2009 02:27:21 +0100
>> Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
>> MIME-Version: 1.0
>> Content-Type: text/plain; charset=UTF-8
>> Content-Transfer-Encoding: 8bit
>>
>> Move table init to tables_nphy.c, detect newer PHY which use different init
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> drivers/net/wireless/b43/phy_n.c ? ? ? | ? 43 ++++------------------------
>> drivers/net/wireless/b43/tables_nphy.c | ? 48
>> ++++++++++++++++++++++++++++++++
>> drivers/net/wireless/b43/tables_nphy.h | ? ?4 ++-
>> 3 files changed, 58 insertions(+), 37 deletions(-)
>
> Well, the patch is fairly clearly whitespace-damaged. ?Perhaps that
> is a product of how you forwarded it to linux-wireless?

I created a new mail, no forwarding. I guess this is GMail issue,
afraid I'll have to install some native mail client.


> Other than that, it looks like you are mostly just moving code around.
> That's fine, but there doesn't seem to be a lot of point in it
> unless the rev 3+ stuff is coming soon? ?It probably doesn't harm
> much either way...

I believe I've moved code to it's correct place. That is what file
name /says/ (tables_nphy.c) and what is done for LP-PHY. I don't know
yet what revision will be my device. But at least for training I want
to implement b43_nphy_rev3plus_table_init(...) (next one patch maybe).

If you decide to agree to commit this patch and you want to me resend
this with correct white spaces, please ping me about. For future mails
I'll use some native mailer.

-- 
Rafa?


From linville at tuxdriver.com  Wed Dec 23 16:10:53 2009
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 23 Dec 2009 10:10:53 -0500
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <200912231202.26923.mb@bu3sch.de>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
	<b170af450912230234q34920ab1u9dfedc9d18d65201@mail.gmail.com>
	<200912231202.26923.mb@bu3sch.de>
Message-ID: <20091223151053.GD2811@tuxdriver.com>

On Wed, Dec 23, 2009 at 12:02:25PM +0100, Michael Buesch wrote:
> On Wednesday 23 December 2009 11:34:39 Rafa? Mi?ecki wrote:
> > W dniu 22 grudnia 2009 02:40 u?ytkownik Rafa? Mi?ecki
> > <zajec5 at gmail.com> napisa?:
> > > It's just compilation-tested as I don't own N-PHY device yet (should receive
> > > one for Christmas). Not sure if we even support SSB used for N-PHY cards.
> > 
> > Is posting on this ML enough to get patch in testing and mainline
> > later? If it just needs some time, *I am completely fine with it*.
> > 
> > I ask because maybe I'm waiting for something that won't happen due to
> > my (some) mistake. Should I do anything else to get this patch
> > reviewed & up?
> 
> Send it to John Linville and the linux wireless list. Also CCing this list is a good idea.

Was there a non-whitespace-damaged version of the patch posted?

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From linville at tuxdriver.com  Wed Dec 23 16:12:30 2009
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 23 Dec 2009 10:12:30 -0500
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table
	init, check PHY rev
In-Reply-To: <b170af450912230710t77cc614j25f058b64c4ce51@mail.gmail.com>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
	<20091223145211.GB2811@tuxdriver.com>
	<b170af450912230710t77cc614j25f058b64c4ce51@mail.gmail.com>
Message-ID: <20091223151230.GE2811@tuxdriver.com>

On Wed, Dec 23, 2009 at 04:10:35PM +0100, Rafa? Mi?ecki wrote:
> W dniu 23 grudnia 2009 15:52 u?ytkownik John W. Linville

> If you decide to agree to commit this patch and you want to me resend
> this with correct white spaces, please ping me about. For future mails
> I'll use some native mailer.

I'm fine with the patch -- at least it demonstrates that something
else is needed for rev 3+.

-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From zajec5 at gmail.com  Wed Dec 23 16:24:03 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 23 Dec 2009 16:24:03 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
In-Reply-To: <20091223151053.GD2811@tuxdriver.com>
References: <b170af450912211740j68baa610sb5abb4620007ed60@mail.gmail.com>
	<b170af450912230234q34920ab1u9dfedc9d18d65201@mail.gmail.com>
	<200912231202.26923.mb@bu3sch.de>
	<20091223151053.GD2811@tuxdriver.com>
Message-ID: <b170af450912230724m51371371r15943274554dff66@mail.gmail.com>

2009/12/23 John W. Linville <linville at tuxdriver.com>:
> Was there a non-whitespace-damaged version of the patch posted?

Both posted patches were inline-attached using GMail webui. So if one
is damaged, it means both are. Sorry for that, as said, I'll install
mailer.

-- 
Rafa?


From linville at tuxdriver.com  Wed Dec 23 15:52:11 2009
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 23 Dec 2009 09:52:11 -0500
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table
	init, check PHY rev
In-Reply-To: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
Message-ID: <20091223145211.GB2811@tuxdriver.com>

On Wed, Dec 23, 2009 at 01:01:58PM +0100, Rafa? Mi?ecki wrote:
> It's just compilation-tested as I don't own N-PHY device yet (should receive
> one for Christmas). Of course I enabled N-PHY in Kconfig.
> 
> I already sent this to bcm43xx-dev but didn't get any review. Michael told
> me to send it to you John and to linux-wireless. Is there anyone how could
> review/ack my patch?
> 
> 
> From 6800722c2fda0e302d7c759a5f2a993503b6581a Mon Sep 17 00:00:00 2001
> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
> Date: Tue, 22 Dec 2009 02:27:21 +0100
> Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
> MIME-Version: 1.0
> Content-Type: text/plain; charset=UTF-8
> Content-Transfer-Encoding: 8bit
> 
> Move table init to tables_nphy.c, detect newer PHY which use different init
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> drivers/net/wireless/b43/phy_n.c       |   43 ++++------------------------
> drivers/net/wireless/b43/tables_nphy.c |   48
> ++++++++++++++++++++++++++++++++
> drivers/net/wireless/b43/tables_nphy.h |    4 ++-
> 3 files changed, 58 insertions(+), 37 deletions(-)

Well, the patch is fairly clearly whitespace-damaged.  Perhaps that
is a product of how you forwarded it to linux-wireless?

Other than that, it looks like you are mostly just moving code around.
That's fine, but there doesn't seem to be a lot of point in it
unless the rev 3+ stuff is coming soon?  It probably doesn't harm
much either way...

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From Larry.Finger at lwfinger.net  Wed Dec 23 19:19:19 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 23 Dec 2009 12:19:19 -0600
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table init, 
	check PHY rev
In-Reply-To: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
Message-ID: <4B325F27.4020506@lwfinger.net>

On 12/23/2009 06:01 AM, Rafa? Mi?ecki wrote:
> It's just compilation-tested as I don't own N-PHY device yet (should
> receive one for Christmas). Of course I enabled N-PHY in Kconfig.
> 
> I already sent this to bcm43xx-dev but didn't get any review. Michael
> told me to send it to you John and to linux-wireless. Is there anyone
> how could review/ack my patch?
> 
> 
> From 6800722c2fda0e302d7c759a5f2a993503b6581a Mon Sep 17 00:00:00 2001
> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com
> <mailto:zajec5 at gmail.com>>
> Date: Tue, 22 Dec 2009 02:27:21 +0100
> Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev
> MIME-Version: 1.0
> Content-Type: text/plain; charset=UTF-8
> Content-Transfer-Encoding: 8bit
> 
> Move table init to tables_nphy.c, detect newer PHY which use different init
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com <mailto:zajec5 at gmail.com>>
> ---
> drivers/net/wireless/b43/phy_n.c       |   43 ++++------------------------
> drivers/net/wireless/b43/tables_nphy.c |   48
> ++++++++++++++++++++++++++++++++
> drivers/net/wireless/b43/tables_nphy.h |    4 ++-
> 3 files changed, 58 insertions(+), 37 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_n.c
> b/drivers/net/wireless/b43/phy_n.c
> index 992318a..23cef71 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -197,44 +197,15 @@ void b43_nphy_radio_turn_off(struct b43_wldev *dev)
>     ~B43_NPHY_RFCTL_CMD_EN);
> }
> 
> -#define ntab_upload(dev, offset, data) do { \
> - unsigned int i; \
> - for (i = 0; i < (offset##_SIZE); i++) \
> - b43_ntab_write(dev, (offset) + i, (data)[i]); \
> - } while (0)
> -
> -/* Upload the N-PHY tables. */
> +/* Upload the N-PHY tables.
> + * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
> + */
> static void b43_nphy_tables_init(struct b43_wldev *dev)
> {
> - /* Static tables */
> - ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
> - ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
> - ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
> - ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
> - ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
> - ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
> - ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
> - ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
> - ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
> - ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
> - ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
> - ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
> - ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
> - ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
> -
> - /* Volatile tables */
> - ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
> - ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
> - ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
> - ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
> - ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
> - ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
> - ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
> - ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
> - ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
> - ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
> - ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
> - ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
> + if (dev->phy.rev < 3)
> + b43_nphy_rev0_1_2_table_init(dev);
> + else
> + b43_nphy_rev3plus_table_init(dev);
> }
> 
> static void b43_nphy_workarounds(struct b43_wldev *dev)
> diff --git a/drivers/net/wireless/b43/tables_nphy.c
> b/drivers/net/wireless/b43/tables_nphy.c
> index 4e23363..d709555 100644
> --- a/drivers/net/wireless/b43/tables_nphy.c
> +++ b/drivers/net/wireless/b43/tables_nphy.c
> @@ -2474,3 +2474,51 @@ void b43_ntab_write(struct b43_wldev *dev, u32
> offset, u32 value)
> /* Some compiletime assertions... */
> assert_ntab_array_sizes();
> }
> +
> +#define ntab_upload(dev, offset, data) do { \
> + unsigned int i; \
> + for (i = 0; i < (offset##_SIZE); i++) \
> + b43_ntab_write(dev, (offset) + i, (data)[i]); \
> + } while (0)
> +
> +void b43_nphy_rev0_1_2_table_init(struct b43_wldev *dev)
> +{
> + /* Static tables */
> + ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
> + ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
> + ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
> + ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
> + ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
> + ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
> + ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
> + ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
> + ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
> + ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
> + ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
> + ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
> + ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
> + ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
> +
> + /* Volatile tables */
> + ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
> + ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
> + ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
> + ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
> + ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
> + ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
> + ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
> + ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
> + ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
> + ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
> + ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
> + ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
> +}
> +
> +void b43_nphy_rev3plus_table_init(struct b43_wldev *dev)
> +{
> + /* Static tables */
> + //TODO
> +
> + /* Volatile tables */
> + //TODO
> +}
> diff --git a/drivers/net/wireless/b43/tables_nphy.h
> b/drivers/net/wireless/b43/tables_nphy.h
> index 4d498b0..f5c0c2d 100644
> --- a/drivers/net/wireless/b43/tables_nphy.h
> +++ b/drivers/net/wireless/b43/tables_nphy.h
> @@ -128,6 +128,9 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8
> channel);
> 
> void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
> 
> +void b43_nphy_rev0_1_2_table_init(struct b43_wldev *dev);
> +void b43_nphy_rev3plus_table_init(struct b43_wldev *dev);
> +
> extern const u8 b43_ntab_adjustpower0[];
> extern const u8 b43_ntab_adjustpower1[];
> extern const u16 b43_ntab_bdi[];
> @@ -155,5 +158,4 @@ extern const u32 b43_ntab_tdi40a1[];
> extern const u32 b43_ntab_tdtrn[];
> extern const u32 b43_ntab_tmap[];
> 
> -
> #endif /* B43_TABLES_NPHY_H_ */

ACK for the relocation of the tables.

Larry


From mb at bu3sch.de  Wed Dec 23 19:26:14 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 23 Dec 2009 19:26:14 +0100
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table init,
	check PHY rev
In-Reply-To: <4B325F27.4020506@lwfinger.net>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
	<4B325F27.4020506@lwfinger.net>
Message-ID: <200912231926.17206.mb@bu3sch.de>

On Wednesday 23 December 2009 19:19:19 Larry Finger wrote:
> ACK for the relocation of the tables.

Well, the _tables_ aren't actually relocated with that patch. The tables
are already in the tables_nphy.c file. You just relocate the functions that upload
the tables.
So if you want to relocate the upload-functions, the question arises whether
the tables should be made static.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Wed Dec 23 19:40:59 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 23 Dec 2009 19:40:59 +0100
Subject: [PATCH][resend with linux-wireless] b43: N-PHY: clean table init, 
	check PHY rev
In-Reply-To: <200912231926.17206.mb@bu3sch.de>
References: <b170af450912230401l7a27b981o42cdbc96e5a16b57@mail.gmail.com>
	<4B325F27.4020506@lwfinger.net> <200912231926.17206.mb@bu3sch.de>
Message-ID: <b170af450912231040h4b18614dw26a4f2f403e7048b@mail.gmail.com>

2009/12/23 Michael Buesch <mb at bu3sch.de>:
> On Wednesday 23 December 2009 19:19:19 Larry Finger wrote:
>> ACK for the relocation of the tables.
>
> Well, the _tables_ aren't actually relocated with that patch. The tables
> are already in the tables_nphy.c file. You just relocate the functions that upload
> the tables.

Yeah, I believe we all meant "table init relocation" :)


> So if you want to relocate the upload-functions, the question arises whether
> the tables should be made static.

Good catch, thanks. Didn't think about that. I'll post new version.


Thank you guys for help, talk :)

-- 
Rafa?


From yhager at yhager.com  Sat Dec 26 20:01:29 2009
From: yhager at yhager.com (yhager at yhager.com)
Date: Sat, 26 Dec 2009 21:01:29 +0200
Subject: BCM4312 disconnects on 2.6.32
Message-ID: <20091226190129.GA20638@garlic>

Hi,

First, some adminstrativa..

$ uname -srvmip
Linux 2.6.29 #4 Fri Aug 28 13:17:05 IDT 2009 i686 VIA C7-M Processor 1600MHz CentaurHauls

$ lspci -vnn |grep 14e4
02:00.0 Network controller [0280]: Broadcom Corporation BCM4312 802.11a/b/g [14e4:4312] (rev 02)
07:03.0 Ethernet controller [0200]: Broadcom Corporation NetXtreme BCM5788 Gigabit Ethernet [14e4:169c] (rev 03)

$ dmesg|grep b43-phy | head -1
[    7.461364] b43-phy0: Broadcom 4311 WLAN found

This same machine works fine when I use the 2.6.29 kernel, but when I
use 2.6.32, I get "Carrier lost" disconnection after a couple of minutes
(exact times vary between 30 seconds to about 2-3 minutes).

Before filling everyone's inbox with large kernel logs, here's a snippet
from dmesg:
# dmesg | egrep  "b43|wlan|AP"
[    0.000000] ACPI: APIC 6feb0390 00060 (v02 HP     APIC2203 20080820 MSFT 00000097)
[    0.000000]   #5 [0000008000 - 000000f000]          BOOTMAP ==> [0000008000 - 000000f000]
[    0.121705] ACPI: Power Resource [APMF] (off)
[    4.608781] b43-pci-bridge 0000:02:00.0: PCI INT A -> Link[LNKH] -> GSI 10 (level, low) -> IRQ 10
[    4.608809] b43-pci-bridge 0000:02:00.0: setting latency timer to 64
[    4.807626] b43-phy0: Broadcom 4311 WLAN found (core revision 13)
[    4.900090] b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 9
[    4.900120] b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
[    4.960151] b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
[    4.966071] Registered led device: b43-phy0::tx
[    4.966125] Registered led device: b43-phy0::rx
[    4.966179] Registered led device: b43-phy0::radio
[    5.048461] fuse init (API version 7.13)
[   34.990139] b43 ssb0:0: firmware: requesting b43/ucode13.fw
[   35.080855] b43 ssb0:0: firmware: requesting b43/b0g0initvals13.fw
[   35.250092] b43-phy0: Loading firmware version 478.104 (2008-07-01 00:50:23)
[   35.360376] b43-phy0 debug: Chip initialized
[   35.360441] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for device
[   35.360452] b43-phy0: DMA mask fallback from 64-bit to 32-bit
[   35.360809] b43-phy0 debug: 64-bit DMA initialized
[   35.360893] b43-phy0 debug: QoS enabled
[   35.400721] b43-phy0 debug: Wireless interface started
[   35.400741] b43-phy0 debug: Adding Interface type 2
[   45.267169] b43-phy0 debug: Removing Interface type 2
[   45.267283] b43-phy0 debug: Wireless interface stopped
[   45.267295] b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64, Failed frames 0/0 = 0.0%, Average tries 0.00
[   45.267421] b43-phy0 debug: DMA-64 tx_ring_AC_BK: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
[   45.280097] b43-phy0 debug: DMA-64 tx_ring_AC_BE: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
[   45.300151] b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
[   45.320064] b43-phy0 debug: DMA-64 tx_ring_AC_VO: Used slots 2/256, Failed frames 0/22 = 0.0%, Average tries 1.00
[   45.340060] b43-phy0 debug: DMA-64 tx_ring_mcast: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
[   45.620280] b43-phy0: Loading firmware version 478.104 (2008-07-01 00:50:23)
[   45.730312] b43-phy0 debug: Chip initialized
[   45.730374] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for device
[   45.730383] b43-phy0: DMA mask fallback from 64-bit to 32-bit
[   45.730623] b43-phy0 debug: 64-bit DMA initialized
[   45.730703] b43-phy0 debug: QoS enabled
[   45.770718] b43-phy0 debug: Wireless interface started
[   45.770732] b43-phy0 debug: Adding Interface type 2
[   45.858474] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
[   45.860542] wlan0: direct probe responded
[   45.860551] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
[   45.862212] wlan0: authenticated
[   45.862250] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
[   45.864940] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
[   45.864948] wlan0: associated
[   45.866668] wlan0: deauthenticating from 00:22:3f:18:89:5e by local choice (reason=3)
[   45.866797] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
[   45.869397] wlan0: direct probe responded
[   45.869406] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
[   45.871106] wlan0: authenticated
[   45.871141] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
[   45.873524] wlan0: RX ReassocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
[   45.873532] wlan0: associated
[   45.874266] wlan0: deauthenticating from 00:22:3f:18:89:5e by local choice (reason=3)
[   45.874364] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
[   45.876965] wlan0: direct probe responded
[   45.876975] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
[   45.878663] wlan0: authenticated
[   45.878697] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
[   45.881069] wlan0: RX ReassocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
[   45.881077] wlan0: associated
[   93.540091] No probe response from AP 00:22:3f:18:89:5e after 500ms, disconnecting.

Any ideas?

PS - I have also tried 2.6.32.2, with same results.

-- 
Yuval Hager
[T] +972-77-341-4155
[@] yuval at avramzon.net


From netrolller.3d at gmail.com  Sat Dec 26 22:06:55 2009
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 26 Dec 2009 22:06:55 +0100
Subject: BCM4312 disconnects on 2.6.32
In-Reply-To: <20091226190129.GA20638@garlic>
References: <20091226190129.GA20638@garlic>
Message-ID: <69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>

Update your pci.ids file - what you have is a BCM4311/02 ABG.

Also, could you check a few more kernels in-between .29 and .32?

On Sat, Dec 26, 2009 at 8:01 PM,  <yhager at yhager.com> wrote:
> Hi,
>
> First, some adminstrativa..
>
> $ uname -srvmip
> Linux 2.6.29 #4 Fri Aug 28 13:17:05 IDT 2009 i686 VIA C7-M Processor 1600MHz CentaurHauls
>
> $ lspci -vnn |grep 14e4
> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312 802.11a/b/g [14e4:4312] (rev 02)
> 07:03.0 Ethernet controller [0200]: Broadcom Corporation NetXtreme BCM5788 Gigabit Ethernet [14e4:169c] (rev 03)
>
> $ dmesg|grep b43-phy | head -1
> [ ? ?7.461364] b43-phy0: Broadcom 4311 WLAN found
>
> This same machine works fine when I use the 2.6.29 kernel, but when I
> use 2.6.32, I get "Carrier lost" disconnection after a couple of minutes
> (exact times vary between 30 seconds to about 2-3 minutes).
>
> Before filling everyone's inbox with large kernel logs, here's a snippet
> from dmesg:
> # dmesg | egrep ?"b43|wlan|AP"
> [ ? ?0.000000] ACPI: APIC 6feb0390 00060 (v02 HP ? ? APIC2203 20080820 MSFT 00000097)
> [ ? ?0.000000] ? #5 [0000008000 - 000000f000] ? ? ? ? ?BOOTMAP ==> [0000008000 - 000000f000]
> [ ? ?0.121705] ACPI: Power Resource [APMF] (off)
> [ ? ?4.608781] b43-pci-bridge 0000:02:00.0: PCI INT A -> Link[LNKH] -> GSI 10 (level, low) -> IRQ 10
> [ ? ?4.608809] b43-pci-bridge 0000:02:00.0: setting latency timer to 64
> [ ? ?4.807626] b43-phy0: Broadcom 4311 WLAN found (core revision 13)
> [ ? ?4.900090] b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 9
> [ ? ?4.900120] b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> [ ? ?4.960151] b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> [ ? ?4.966071] Registered led device: b43-phy0::tx
> [ ? ?4.966125] Registered led device: b43-phy0::rx
> [ ? ?4.966179] Registered led device: b43-phy0::radio
> [ ? ?5.048461] fuse init (API version 7.13)
> [ ? 34.990139] b43 ssb0:0: firmware: requesting b43/ucode13.fw
> [ ? 35.080855] b43 ssb0:0: firmware: requesting b43/b0g0initvals13.fw
> [ ? 35.250092] b43-phy0: Loading firmware version 478.104 (2008-07-01 00:50:23)
> [ ? 35.360376] b43-phy0 debug: Chip initialized
> [ ? 35.360441] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for device
> [ ? 35.360452] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> [ ? 35.360809] b43-phy0 debug: 64-bit DMA initialized
> [ ? 35.360893] b43-phy0 debug: QoS enabled
> [ ? 35.400721] b43-phy0 debug: Wireless interface started
> [ ? 35.400741] b43-phy0 debug: Adding Interface type 2
> [ ? 45.267169] b43-phy0 debug: Removing Interface type 2
> [ ? 45.267283] b43-phy0 debug: Wireless interface stopped
> [ ? 45.267295] b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64, Failed frames 0/0 = 0.0%, Average tries 0.00
> [ ? 45.267421] b43-phy0 debug: DMA-64 tx_ring_AC_BK: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
> [ ? 45.280097] b43-phy0 debug: DMA-64 tx_ring_AC_BE: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
> [ ? 45.300151] b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
> [ ? 45.320064] b43-phy0 debug: DMA-64 tx_ring_AC_VO: Used slots 2/256, Failed frames 0/22 = 0.0%, Average tries 1.00
> [ ? 45.340060] b43-phy0 debug: DMA-64 tx_ring_mcast: Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00
> [ ? 45.620280] b43-phy0: Loading firmware version 478.104 (2008-07-01 00:50:23)
> [ ? 45.730312] b43-phy0 debug: Chip initialized
> [ ? 45.730374] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for device
> [ ? 45.730383] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> [ ? 45.730623] b43-phy0 debug: 64-bit DMA initialized
> [ ? 45.730703] b43-phy0 debug: QoS enabled
> [ ? 45.770718] b43-phy0 debug: Wireless interface started
> [ ? 45.770732] b43-phy0 debug: Adding Interface type 2
> [ ? 45.858474] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.860542] wlan0: direct probe responded
> [ ? 45.860551] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.862212] wlan0: authenticated
> [ ? 45.862250] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.864940] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
> [ ? 45.864948] wlan0: associated
> [ ? 45.866668] wlan0: deauthenticating from 00:22:3f:18:89:5e by local choice (reason=3)
> [ ? 45.866797] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.869397] wlan0: direct probe responded
> [ ? 45.869406] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.871106] wlan0: authenticated
> [ ? 45.871141] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.873524] wlan0: RX ReassocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
> [ ? 45.873532] wlan0: associated
> [ ? 45.874266] wlan0: deauthenticating from 00:22:3f:18:89:5e by local choice (reason=3)
> [ ? 45.874364] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.876965] wlan0: direct probe responded
> [ ? 45.876975] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.878663] wlan0: authenticated
> [ ? 45.878697] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> [ ? 45.881069] wlan0: RX ReassocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
> [ ? 45.881077] wlan0: associated
> [ ? 93.540091] No probe response from AP 00:22:3f:18:89:5e after 500ms, disconnecting.
>
> Any ideas?
>
> PS - I have also tried 2.6.32.2, with same results.
>
> --
> Yuval Hager
> [T] +972-77-341-4155
> [@] yuval at avramzon.net
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From yhager at yhager.com  Sun Dec 27 07:13:20 2009
From: yhager at yhager.com (Yuval Hager)
Date: Sun, 27 Dec 2009 08:13:20 +0200
Subject: BCM4312 disconnects on 2.6.32
In-Reply-To: <69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
Message-ID: <200912270813.21687.yhager@yhager.com>

On Saturday 26 December 2009, G?bor Stefanik wrote:
> Update your pci.ids file - what you have is a BCM4311/02 ABG.

How do I update it? (what I have is from 2009.08)

> 
> Also, could you check a few more kernels in-between .29 and .32?
> 

Yes, I will run some checks and report back here. It might take a few days 
though.

--y

> On Sat, Dec 26, 2009 at 8:01 PM,  <yhager at yhager.com> wrote:
> > Hi,
> >
> > First, some adminstrativa..
> >
> > $ uname -srvmip
> > Linux 2.6.29 #4 Fri Aug 28 13:17:05 IDT 2009 i686 VIA C7-M Processor
> > 1600MHz CentaurHauls
> >
> > $ lspci -vnn |grep 14e4
> > 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> > 802.11a/b/g [14e4:4312] (rev 02) 07:03.0 Ethernet controller [0200]:
> > Broadcom Corporation NetXtreme BCM5788 Gigabit Ethernet [14e4:169c]
> > (rev 03)
> >
> > $ dmesg|grep b43-phy | head -1
> > [    7.461364] b43-phy0: Broadcom 4311 WLAN found
> >
> > This same machine works fine when I use the 2.6.29 kernel, but when I
> > use 2.6.32, I get "Carrier lost" disconnection after a couple of
> > minutes (exact times vary between 30 seconds to about 2-3 minutes).
> >
> > Before filling everyone's inbox with large kernel logs, here's a
> > snippet from dmesg:
> > # dmesg | egrep  "b43|wlan|AP"
> > [    0.000000] ACPI: APIC 6feb0390 00060 (v02 HP     APIC2203 20080820
> > MSFT 00000097) [    0.000000]   #5 [0000008000 - 000000f000]        
> >  BOOTMAP ==> [0000008000 - 000000f000] [    0.121705] ACPI: Power
> > Resource [APMF] (off)
> > [    4.608781] b43-pci-bridge 0000:02:00.0: PCI INT A -> Link[LNKH] ->
> > GSI 10 (level, low) -> IRQ 10 [    4.608809] b43-pci-bridge
> > 0000:02:00.0: setting latency timer to 64 [    4.807626] b43-phy0:
> > Broadcom 4311 WLAN found (core revision 13) [    4.900090] b43-phy0
> > debug: Found PHY: Analog 4, Type 2, Revision 9 [    4.900120] b43-phy0
> > debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2 [  
> >  4.960151] b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in
> > kernel config [    4.966071] Registered led device: b43-phy0::tx
> > [    4.966125] Registered led device: b43-phy0::rx
> > [    4.966179] Registered led device: b43-phy0::radio
> > [    5.048461] fuse init (API version 7.13)
> > [   34.990139] b43 ssb0:0: firmware: requesting b43/ucode13.fw
> > [   35.080855] b43 ssb0:0: firmware: requesting b43/b0g0initvals13.fw
> > [   35.250092] b43-phy0: Loading firmware version 478.104 (2008-07-01
> > 00:50:23) [   35.360376] b43-phy0 debug: Chip initialized
> > [   35.360441] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for
> > device [   35.360452] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> > [   35.360809] b43-phy0 debug: 64-bit DMA initialized
> > [   35.360893] b43-phy0 debug: QoS enabled
> > [   35.400721] b43-phy0 debug: Wireless interface started
> > [   35.400741] b43-phy0 debug: Adding Interface type 2
> > [   45.267169] b43-phy0 debug: Removing Interface type 2
> > [   45.267283] b43-phy0 debug: Wireless interface stopped
> > [   45.267295] b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64, Failed
> > frames 0/0 = 0.0%, Average tries 0.00 [   45.267421] b43-phy0 debug:
> > DMA-64 tx_ring_AC_BK: Used slots 0/256, Failed frames 0/0 = 0.0%,
> > Average tries 0.00 [   45.280097] b43-phy0 debug: DMA-64 tx_ring_AC_BE:
> > Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00 [  
> > 45.300151] b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/256,
> > Failed frames 0/0 = 0.0%, Average tries 0.00 [   45.320064] b43-phy0
> > debug: DMA-64 tx_ring_AC_VO: Used slots 2/256, Failed frames 0/22 =
> > 0.0%, Average tries 1.00 [   45.340060] b43-phy0 debug: DMA-64
> > tx_ring_mcast: Used slots 0/256, Failed frames 0/0 = 0.0%, Average
> > tries 0.00 [   45.620280] b43-phy0: Loading firmware version 478.104
> > (2008-07-01 00:50:23) [   45.730312] b43-phy0 debug: Chip initialized
> > [   45.730374] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for
> > device [   45.730383] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> > [   45.730623] b43-phy0 debug: 64-bit DMA initialized
> > [   45.730703] b43-phy0 debug: QoS enabled
> > [   45.770718] b43-phy0 debug: Wireless interface started
> > [   45.770732] b43-phy0 debug: Adding Interface type 2
> > [   45.858474] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> > [   45.860542] wlan0: direct probe responded
> > [   45.860551] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.862212] wlan0: authenticated
> > [   45.862250] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.864940] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401
> > status=0 aid=2) [   45.864948] wlan0: associated
> > [   45.866668] wlan0: deauthenticating from 00:22:3f:18:89:5e by local
> > choice (reason=3) [   45.866797] wlan0: direct probe to AP
> > 00:22:3f:18:89:5e (try 1) [   45.869397] wlan0: direct probe responded
> > [   45.869406] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.871106] wlan0: authenticated
> > [   45.871141] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.873524] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > (capab=0x401 status=0 aid=2) [   45.873532] wlan0: associated
> > [   45.874266] wlan0: deauthenticating from 00:22:3f:18:89:5e by local
> > choice (reason=3) [   45.874364] wlan0: direct probe to AP
> > 00:22:3f:18:89:5e (try 1) [   45.876965] wlan0: direct probe responded
> > [   45.876975] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.878663] wlan0: authenticated
> > [   45.878697] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.881069] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > (capab=0x401 status=0 aid=2) [   45.881077] wlan0: associated
> > [   93.540091] No probe response from AP 00:22:3f:18:89:5e after 500ms,
> > disconnecting.
> >
> > Any ideas?
> >
> > PS - I have also tried 2.6.32.2, with same results.
> >
> > --
> > Yuval Hager
> > [T] +972-77-341-4155
> > [@] yuval at avramzon.net
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 


-- 
Yuval Hager
Tel: +972-77-341-4255
yhager on all networks/IM
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091227/b88ed190/attachment.pgp>

From zajec5 at gmail.com  Sun Dec 27 08:40:33 2009
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 27 Dec 2009 08:40:33 +0100
Subject: BCM4312 disconnects on 2.6.32
In-Reply-To: <200912270813.21687.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
	<200912270813.21687.yhager@yhager.com>
Message-ID: <b170af450912262340k2ad6a32ap83e77ede7b93ce44@mail.gmail.com>

2009/12/27 Yuval Hager <yhager at yhager.com>:
> On Saturday 26 December 2009, G?bor Stefanik wrote:
>> Update your pci.ids file - what you have is a BCM4311/02 ABG.
>
> How do I update it? (what I have is from 2009.08)

Try following command as root:
update-pciids

-- 
Rafa?


From yhager at yhager.com  Sun Dec 27 15:26:26 2009
From: yhager at yhager.com (Yuval Hager)
Date: Sun, 27 Dec 2009 16:26:26 +0200
Subject: BCM4312 disconnects on 2.6.32
In-Reply-To: <69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
Message-ID: <200912271626.27144.yhager@yhager.com>

On Saturday 26 December 2009, G?bor Stefanik wrote:
> Update your pci.ids file - what you have is a BCM4311/02 ABG.
> 

I ran update-pciids successfully, now dmesg says:
b43-phy0: Broadcom 4311 WLAN found (core revision 13)

and lspci:
02:00.0 Network controller [0280]: Broadcom Corporation BCM4312 802.11a/b/g 
[14e4:4312] (rev 02)

> Also, could you check a few more kernels in-between .29 and .32?
> 

I have checked the following kernels, and found they all work correctly:
2.6.29
2.6.29.6
2.6.30.4
2.6.31.9

Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned in the 
original post. Before checking 2.6.32, I have removed /lib/firmware/b43 
completely and installed the firmware based on the detailed instructions on 
the web site. I also enabled CONFIG_B43_PHY_LP=y for 2.6.32.

all kernels checked are vanilla kernels, from kernel.org.

--y

> On Sat, Dec 26, 2009 at 8:01 PM,  <yhager at yhager.com> wrote:
> > Hi,
> >
> > First, some adminstrativa..
> >
> > $ uname -srvmip
> > Linux 2.6.29 #4 Fri Aug 28 13:17:05 IDT 2009 i686 VIA C7-M Processor
> > 1600MHz CentaurHauls
> >
> > $ lspci -vnn |grep 14e4
> > 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> > 802.11a/b/g [14e4:4312] (rev 02) 07:03.0 Ethernet controller [0200]:
> > Broadcom Corporation NetXtreme BCM5788 Gigabit Ethernet [14e4:169c]
> > (rev 03)
> >
> > $ dmesg|grep b43-phy | head -1
> > [    7.461364] b43-phy0: Broadcom 4311 WLAN found
> >
> > This same machine works fine when I use the 2.6.29 kernel, but when I
> > use 2.6.32, I get "Carrier lost" disconnection after a couple of
> > minutes (exact times vary between 30 seconds to about 2-3 minutes).
> >
> > Before filling everyone's inbox with large kernel logs, here's a
> > snippet from dmesg:
> > # dmesg | egrep  "b43|wlan|AP"
> > [    0.000000] ACPI: APIC 6feb0390 00060 (v02 HP     APIC2203 20080820
> > MSFT 00000097) [    0.000000]   #5 [0000008000 - 000000f000]        
> >  BOOTMAP ==> [0000008000 - 000000f000] [    0.121705] ACPI: Power
> > Resource [APMF] (off)
> > [    4.608781] b43-pci-bridge 0000:02:00.0: PCI INT A -> Link[LNKH] ->
> > GSI 10 (level, low) -> IRQ 10 [    4.608809] b43-pci-bridge
> > 0000:02:00.0: setting latency timer to 64 [    4.807626] b43-phy0:
> > Broadcom 4311 WLAN found (core revision 13) [    4.900090] b43-phy0
> > debug: Found PHY: Analog 4, Type 2, Revision 9 [    4.900120] b43-phy0
> > debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2 [  
> >  4.960151] b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in
> > kernel config [    4.966071] Registered led device: b43-phy0::tx
> > [    4.966125] Registered led device: b43-phy0::rx
> > [    4.966179] Registered led device: b43-phy0::radio
> > [    5.048461] fuse init (API version 7.13)
> > [   34.990139] b43 ssb0:0: firmware: requesting b43/ucode13.fw
> > [   35.080855] b43 ssb0:0: firmware: requesting b43/b0g0initvals13.fw
> > [   35.250092] b43-phy0: Loading firmware version 478.104 (2008-07-01
> > 00:50:23) [   35.360376] b43-phy0 debug: Chip initialized
> > [   35.360441] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for
> > device [   35.360452] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> > [   35.360809] b43-phy0 debug: 64-bit DMA initialized
> > [   35.360893] b43-phy0 debug: QoS enabled
> > [   35.400721] b43-phy0 debug: Wireless interface started
> > [   35.400741] b43-phy0 debug: Adding Interface type 2
> > [   45.267169] b43-phy0 debug: Removing Interface type 2
> > [   45.267283] b43-phy0 debug: Wireless interface stopped
> > [   45.267295] b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64, Failed
> > frames 0/0 = 0.0%, Average tries 0.00 [   45.267421] b43-phy0 debug:
> > DMA-64 tx_ring_AC_BK: Used slots 0/256, Failed frames 0/0 = 0.0%,
> > Average tries 0.00 [   45.280097] b43-phy0 debug: DMA-64 tx_ring_AC_BE:
> > Used slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00 [  
> > 45.300151] b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/256,
> > Failed frames 0/0 = 0.0%, Average tries 0.00 [   45.320064] b43-phy0
> > debug: DMA-64 tx_ring_AC_VO: Used slots 2/256, Failed frames 0/22 =
> > 0.0%, Average tries 1.00 [   45.340060] b43-phy0 debug: DMA-64
> > tx_ring_mcast: Used slots 0/256, Failed frames 0/0 = 0.0%, Average
> > tries 0.00 [   45.620280] b43-phy0: Loading firmware version 478.104
> > (2008-07-01 00:50:23) [   45.730312] b43-phy0 debug: Chip initialized
> > [   45.730374] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for
> > device [   45.730383] b43-phy0: DMA mask fallback from 64-bit to 32-bit
> > [   45.730623] b43-phy0 debug: 64-bit DMA initialized
> > [   45.730703] b43-phy0 debug: QoS enabled
> > [   45.770718] b43-phy0 debug: Wireless interface started
> > [   45.770732] b43-phy0 debug: Adding Interface type 2
> > [   45.858474] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> > [   45.860542] wlan0: direct probe responded
> > [   45.860551] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.862212] wlan0: authenticated
> > [   45.862250] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.864940] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401
> > status=0 aid=2) [   45.864948] wlan0: associated
> > [   45.866668] wlan0: deauthenticating from 00:22:3f:18:89:5e by local
> > choice (reason=3) [   45.866797] wlan0: direct probe to AP
> > 00:22:3f:18:89:5e (try 1) [   45.869397] wlan0: direct probe responded
> > [   45.869406] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.871106] wlan0: authenticated
> > [   45.871141] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.873524] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > (capab=0x401 status=0 aid=2) [   45.873532] wlan0: associated
> > [   45.874266] wlan0: deauthenticating from 00:22:3f:18:89:5e by local
> > choice (reason=3) [   45.874364] wlan0: direct probe to AP
> > 00:22:3f:18:89:5e (try 1) [   45.876965] wlan0: direct probe responded
> > [   45.876975] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.878663] wlan0: authenticated
> > [   45.878697] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > [   45.881069] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > (capab=0x401 status=0 aid=2) [   45.881077] wlan0: associated
> > [   93.540091] No probe response from AP 00:22:3f:18:89:5e after 500ms,
> > disconnecting.
> >
> > Any ideas?
> >
> > PS - I have also tried 2.6.32.2, with same results.
> >
> > --
> > Yuval Hager
> > [@] yuval at avramzon.net
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091227/8a98eb65/attachment.pgp>

From Larry.Finger at lwfinger.net  Mon Dec 28 05:49:14 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 27 Dec 2009 22:49:14 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <20091124163536.78276489@boulder.homenet>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
Message-ID: <4B3838CA.5090509@lwfinger.net>

Hi,

In the latest Broadcom driver, I found code that sets the timeout field of the
SSB configuration for some BCM4311 and all BCM4312 devices. Please test this
patch following a cold boot.

Thanks,

Larry



-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ssb_4312_to
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20091227/726ebc09/attachment.ksh>

From b3nton at gmail.com  Mon Dec 28 16:52:47 2009
From: b3nton at gmail.com (Andrew Benton)
Date: Mon, 28 Dec 2009 15:52:47 +0000
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <4B3838CA.5090509@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com>
	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>
	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>
	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>
	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>
	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>
	<20091124163536.78276489@boulder.homenet>
	<4B3838CA.5090509@lwfinger.net>
Message-ID: <4B38D44F.8040105@gmail.com>

On 28/12/09 04:49, Larry Finger wrote:
> Hi,
>
> In the latest Broadcom driver, I found code that sets the timeout field of the
> SSB configuration for some BCM4311 and all BCM4312 devices. Please test this
> patch following a cold boot.
>

Sadly it does not work. Tested with the mainline kernel. The DMA errors 
persist.

Andy


From Larry.Finger at lwfinger.net  Mon Dec 28 17:47:32 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 28 Dec 2009 10:47:32 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <4B38D44F.8040105@gmail.com>
References: <4AFA09C8.4060602@gmail.com>	<200911131216.43704.mb@bu3sch.de>	<4AFD83CA.2050508@lwfinger.net>	<200911131836.26857.mb@bu3sch.de>	<4AFD9E20.3060501@gmail.com>	<4AFDD1C9.4050402@lwfinger.net>	<4AFDF68C.4040804@polymtl.ca>	<4AFE1E5F.9040009@lwfinger.net>	<4AFEFC2C.5030704@polymtl.ca>	<4B068ED9.5070107@lwfinger.net>	<4B0B59EC.2000809@polymtl.ca>	<20091124095436.7a4176a1@boulder.homenet>	<4B0C00B5.1000407@polymtl.ca>	<20091124163536.78276489@boulder.homenet>	<4B3838CA.5090509@lwfinger.net>
	<4B38D44F.8040105@gmail.com>
Message-ID: <4B38E124.5030706@lwfinger.net>

On 12/28/2009 09:52 AM, Andrew Benton wrote:
> 
> Sadly it does not work. Tested with the mainline kernel. The DMA errors 
> persist.

Shucks!!! I was hoping for a late Christmas present. Unfortunately, more coal in
my stocking.

As usual, thanks for testing.

Larry


From mb at bu3sch.de  Mon Dec 28 19:33:39 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 28 Dec 2009 19:33:39 +0100
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <4B3838CA.5090509@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com>
	<20091124163536.78276489@boulder.homenet>
	<4B3838CA.5090509@lwfinger.net>
Message-ID: <200912281933.42338.mb@bu3sch.de>

On Monday 28 December 2009 05:49:14 Larry Finger wrote:
>+			tmp &= ~(SSB_IMCFGLO_SERTO | SSB_IMCFGLO_REQTO_SHIFT);

This does not make any sense.
Did you mean:
+			tmp &= ~(SSB_IMCFGLO_SERTO | SSB_IMCFGLO_REQTO);


>+			tmp |= 3;

So you set SER-timeout to 3 and REQ-timeout to 0. Is that what we want?
REQ=zero smells fishy to me, but if the broadcom code also does this, I'm OK with it.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Mon Dec 28 20:09:05 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 28 Dec 2009 13:09:05 -0600
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <200912281933.42338.mb@bu3sch.de>
References: <4AFA09C8.4060602@gmail.com>	<20091124163536.78276489@boulder.homenet>	<4B3838CA.5090509@lwfinger.net>
	<200912281933.42338.mb@bu3sch.de>
Message-ID: <4B390251.6020009@lwfinger.net>

On 12/28/2009 12:33 PM, Michael Buesch wrote:
> On Monday 28 December 2009 05:49:14 Larry Finger wrote:
>> +			tmp &= ~(SSB_IMCFGLO_SERTO | SSB_IMCFGLO_REQTO_SHIFT);
> 
> This does not make any sense.
> Did you mean:
> +			tmp &= ~(SSB_IMCFGLO_SERTO | SSB_IMCFGLO_REQTO);
> 
> 
>> +			tmp |= 3;
> 
> So you set SER-timeout to 3 and REQ-timeout to 0. Is that what we want?
> REQ=zero smells fishy to me, but if the broadcom code also does this, I'm OK with it.

I did get that wrong. The Broadcom code does the equivalent of

tmp = tmp & ~0x77 | 3

which is what my code ended up doing by accident, but REQ is set to zero.

Are these values discussed anywhere in the open? I have not found anything
regarding the SSB configuration.

Larry


From mb at bu3sch.de  Mon Dec 28 20:19:39 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 28 Dec 2009 20:19:39 +0100
Subject: Fatal DMA error problem with netbook and BCM4312 - Test 3
In-Reply-To: <4B390251.6020009@lwfinger.net>
References: <4AFA09C8.4060602@gmail.com> <200912281933.42338.mb@bu3sch.de>
	<4B390251.6020009@lwfinger.net>
Message-ID: <200912282019.40999.mb@bu3sch.de>

On Monday 28 December 2009 20:09:05 Larry Finger wrote:
> I did get that wrong. The Broadcom code does the equivalent of
> 
> tmp = tmp & ~0x77 | 3

Ok, so you need my version of the masking.

> which is what my code ended up doing by accident, but REQ is set to zero.

Yeah, OK to me. It's a workaround after all...

> Are these values discussed anywhere in the open? I have not found anything
> regarding the SSB configuration.

Well, there's no real docs on these, but I'm pretty sure they are related
to the posting of messages on the SSB bus. These values are timeouts for
the communication on the bus. So yeah, I think in _theory_ it can cause
DMA (and other) trouble.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Mon Dec 28 20:21:42 2009
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 28 Dec 2009 13:21:42 -0600
Subject: Problem with b43_get_and_map_ringmem()
Message-ID: <4B390546.7000709@lwfinger.net>

Michael,

There is something a little funky with this routine. If the call to
__b43_get_and_map_ringmem() fails because the memory allocated is not within the
DMA region supported by the card, there is no way for execution to reach the
section that takes action to fix the problem. As you have probably seen, this is
likely the underlying cause of the regression reported in Bugzilla No. 14844.
Testing by the OP has not been done, but it fixed the same problem here.

Fixing this will likely be a two-step process. For 2.6.33, I am proposing the
following simple patch, which is essentially what is being tested:

Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c
+++ wireless-testing/drivers/net/wireless/b43/dma.c
@@ -439,9 +439,14 @@ static void * b43_get_and_map_ringmem(st
 				      dma_addr_t *dmaaddr, size_t size)
 {
 	void *base;
+	gfp_t flags = GFP_KERNEL;

+	if (unlikely(ring->type == B43_DMA_30BIT))
+		flags |= GFP_DMA;
+	else if (unlikely(ring->type == B43_DMA_32BIT))
+		flags |= GFP_DMA32;
 	base = __b43_get_and_map_ringmem(ring, dmaaddr, size,
-					 GFP_KERNEL);
+					 flags);
 	if (!base) {
 		b43err(ring->dev->wl, "Failed to allocate or map pages "
 		       "for DMA ringmemory\n");

Comments?

For 2.6.34, a more complete rework is probably needed.

Larry



From mb at bu3sch.de  Mon Dec 28 20:32:14 2009
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 28 Dec 2009 20:32:14 +0100
Subject: Problem with b43_get_and_map_ringmem()
In-Reply-To: <4B390546.7000709@lwfinger.net>
References: <4B390546.7000709@lwfinger.net>
Message-ID: <200912282032.15906.mb@bu3sch.de>

As I have said several times. I am not interested in fixing this. Just revert the patch.

-- 
Greetings, Michael.


