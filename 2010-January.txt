From zajec5 at gmail.com  Sat Jan  2 17:33:53 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 02 Jan 2010 17:33:53 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V2)
Message-ID: <op.u5wyyryj9lhzdc@linux-g0th.site>

 From 2ba3a7f93ac358a49f36433f49b6d3cf2f930d5c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Sat, 2 Jan 2010 17:06:12 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V2)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Move table init to tables_nphy.c, detect newer PHY which use different init.
We don't init newer PHYs yet but this at least shows what more is needed.

V2: Make some functions and tables static

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   43 ++-----------
  drivers/net/wireless/b43/tables_nphy.c |  100 +++++++++++++++++++++++--------
  drivers/net/wireless/b43/tables_nphy.h |   55 +++++++++--------
  3 files changed, 110 insertions(+), 88 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 992318a..a662ced 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -197,44 +197,15 @@ void b43_nphy_radio_turn_off(struct b43_wldev *dev)
  		     ~B43_NPHY_RFCTL_CMD_EN);
  }

-#define ntab_upload(dev, offset, data) do { \
-		unsigned int i;						\
-		for (i = 0; i < (offset##_SIZE); i++)			\
-			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
-	} while (0)
-
-/* Upload the N-PHY tables. */
+/* Upload the N-PHY tables.
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
+ */
  static void b43_nphy_tables_init(struct b43_wldev *dev)
  {
-	/* Static tables */
-	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
-	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
-	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
-	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
-	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
-	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
-	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
-	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
-	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
-	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
-	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
-	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
-	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
-	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
-
-	/* Volatile tables */
-	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
-	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
-	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
-	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
-	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
-	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
-	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
-	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
-	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
-	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
-	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
-	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+	if (dev->phy.rev < 3)
+		b43_nphy_rev0_1_2_tables_init(dev);
+	else
+		b43_nphy_rev3plus_tables_init(dev);
  }

  static void b43_nphy_workarounds(struct b43_wldev *dev)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 4e23363..d0b91b5 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -1336,7 +1336,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel)
  }


-const u8 b43_ntab_adjustpower0[] = {
+static const u8 b43_ntab_adjustpower0[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1355,7 +1355,7 @@ const u8 b43_ntab_adjustpower0[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u8 b43_ntab_adjustpower1[] = {
+static const u8 b43_ntab_adjustpower1[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1374,11 +1374,11 @@ const u8 b43_ntab_adjustpower1[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u16 b43_ntab_bdi[] = {
+static const u16 b43_ntab_bdi[] = {
  	0x0070, 0x0126, 0x012C, 0x0246, 0x048D, 0x04D2,
  };

-const u32 b43_ntab_channelest[] = {
+static const u32 b43_ntab_channelest[] = {
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
@@ -1405,7 +1405,7 @@ const u32 b43_ntab_channelest[] = {
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
  };

-const u8 b43_ntab_estimatepowerlt0[] = {
+static const u8 b43_ntab_estimatepowerlt0[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1416,7 +1416,7 @@ const u8 b43_ntab_estimatepowerlt0[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_estimatepowerlt1[] = {
+static const u8 b43_ntab_estimatepowerlt1[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1427,14 +1427,14 @@ const u8 b43_ntab_estimatepowerlt1[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_framelookup[] = {
+static const u8 b43_ntab_framelookup[] = {
  	0x02, 0x04, 0x14, 0x14, 0x03, 0x05, 0x16, 0x16,
  	0x0A, 0x0C, 0x1C, 0x1C, 0x0B, 0x0D, 0x1E, 0x1E,
  	0x06, 0x08, 0x18, 0x18, 0x07, 0x09, 0x1A, 0x1A,
  	0x0E, 0x10, 0x20, 0x28, 0x0F, 0x11, 0x22, 0x2A,
  };

-const u32 b43_ntab_framestruct[] = {
+static const u32 b43_ntab_framestruct[] = {
  	0x08004A04, 0x00100000, 0x01000A05, 0x00100020,
  	0x09804506, 0x00100030, 0x09804507, 0x00100030,
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
@@ -1645,7 +1645,7 @@ const u32 b43_ntab_framestruct[] = {
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_gainctl0[] = {
+static const u32 b43_ntab_gainctl0[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1680,7 +1680,7 @@ const u32 b43_ntab_gainctl0[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_gainctl1[] = {
+static const u32 b43_ntab_gainctl1[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1715,12 +1715,12 @@ const u32 b43_ntab_gainctl1[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_intlevel[] = {
+static const u32 b43_ntab_intlevel[] = {
  	0x00802070, 0x0671188D, 0x0A60192C, 0x0A300E46,
  	0x00C1188D, 0x080024D2, 0x00000070,
  };

-const u32 b43_ntab_iqlt0[] = {
+static const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1755,7 +1755,7 @@ const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u32 b43_ntab_iqlt1[] = {
+static const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1790,7 +1790,7 @@ const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u16 b43_ntab_loftlt0[] = {
+static const u16 b43_ntab_loftlt0[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1815,7 +1815,7 @@ const u16 b43_ntab_loftlt0[] = {
  	0x0002, 0x0103,
  };

-const u16 b43_ntab_loftlt1[] = {
+static const u16 b43_ntab_loftlt1[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1840,7 +1840,7 @@ const u16 b43_ntab_loftlt1[] = {
  	0x0002, 0x0103,
  };

-const u8 b43_ntab_mcs[] = {
+static const u8 b43_ntab_mcs[] = {
  	0x00, 0x08, 0x0A, 0x10, 0x12, 0x19, 0x1A, 0x1C,
  	0x40, 0x48, 0x4A, 0x50, 0x52, 0x59, 0x5A, 0x5C,
  	0x80, 0x88, 0x8A, 0x90, 0x92, 0x99, 0x9A, 0x9C,
@@ -1859,7 +1859,7 @@ const u8 b43_ntab_mcs[] = {
  	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  };

-const u32 b43_ntab_noisevar10[] = {
+static const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1926,7 +1926,7 @@ const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u32 b43_ntab_noisevar11[] = {
+static const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1993,7 +1993,7 @@ const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u16 b43_ntab_pilot[] = {
+static const u16 b43_ntab_pilot[] = {
  	0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08,
  	0xFF08, 0xFF08, 0x80D5, 0x80D5, 0x80D5, 0x80D5,
  	0x80D5, 0x80D5, 0x80D5, 0x80D5, 0xFF0A, 0xFF82,
@@ -2011,12 +2011,12 @@ const u16 b43_ntab_pilot[] = {
  	0xF0A0, 0xF028, 0xFFFF, 0xFFFF,
  };

-const u32 b43_ntab_pilotlt[] = {
+static const u32 b43_ntab_pilotlt[] = {
  	0x76540123, 0x62407351, 0x76543201, 0x76540213,
  	0x76540123, 0x76430521,
  };

-const u32 b43_ntab_tdi20a0[] = {
+static const u32 b43_ntab_tdi20a0[] = {
  	0x00091226, 0x000A1429, 0x000B56AD, 0x000C58B0,
  	0x000D5AB3, 0x000E9CB6, 0x000F9EBA, 0x0000C13D,
  	0x00020301, 0x00030504, 0x00040708, 0x0005090B,
@@ -2033,7 +2033,7 @@ const u32 b43_ntab_tdi20a0[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi20a1[] = {
+static const u32 b43_ntab_tdi20a1[] = {
  	0x00014B26, 0x00028D29, 0x000393AD, 0x00049630,
  	0x0005D833, 0x0006DA36, 0x00099C3A, 0x000A9E3D,
  	0x000BC081, 0x000CC284, 0x000DC488, 0x000F068B,
@@ -2050,7 +2050,7 @@ const u32 b43_ntab_tdi20a1[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a0[] = {
+static const u32 b43_ntab_tdi40a0[] = {
  	0x0011A346, 0x00136CCF, 0x0014F5D9, 0x001641E2,
  	0x0017CB6B, 0x00195475, 0x001B2383, 0x001CAD0C,
  	0x001E7616, 0x0000821F, 0x00020BA8, 0x0003D4B2,
@@ -2081,7 +2081,7 @@ const u32 b43_ntab_tdi40a0[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a1[] = {
+static const u32 b43_ntab_tdi40a1[] = {
  	0x001EDB36, 0x000129CA, 0x0002B353, 0x00047CDD,
  	0x0005C8E6, 0x000791EF, 0x00091BF9, 0x000AAA07,
  	0x000C3391, 0x000DFD1A, 0x00120923, 0x0013D22D,
@@ -2112,7 +2112,7 @@ const u32 b43_ntab_tdi40a1[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdtrn[] = {
+static const u32 b43_ntab_tdtrn[] = {
  	0x061C061C, 0x0050EE68, 0xF592FE36, 0xFE5212F6,
  	0x00000C38, 0xFE5212F6, 0xF592FE36, 0x0050EE68,
  	0x061C061C, 0xEE680050, 0xFE36F592, 0x12F6FE52,
@@ -2291,7 +2291,7 @@ const u32 b43_ntab_tdtrn[] = {
  	0xFA58FC00, 0x0B64FC7E, 0x0800F7B6, 0x00F006BE,
  };

-const u32 b43_ntab_tmap[] = {
+static const u32 b43_ntab_tmap[] = {
  	0x8A88AA80, 0x8AAAAA8A, 0x8A8A8AA8, 0x00000888,
  	0x88000000, 0x8A8A88AA, 0x8AA88888, 0x8888A8A8,
  	0xF1111110, 0x11111111, 0x11F11111, 0x00000111,
@@ -2474,3 +2474,51 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  	/* Some compiletime assertions... */
  	assert_ntab_array_sizes();
  }
+
+#define ntab_upload(dev, offset, data) do { \
+		unsigned int i;						\
+		for (i = 0; i < (offset##_SIZE); i++)			\
+			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
+	} while (0)
+
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
+	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
+	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
+	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
+	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
+	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
+	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
+	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
+	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
+	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
+	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
+	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
+	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
+	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
+
+	/* Volatile tables */
+	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
+	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
+	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
+	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
+	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
+	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
+	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
+	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
+	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
+	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
+	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
+	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+}
+
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	/* TODO */
+
+	/* Volatile tables */
+	/* TODO */
+}
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 4d498b0..2240345 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -128,32 +128,35 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);

  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);

-extern const u8 b43_ntab_adjustpower0[];
-extern const u8 b43_ntab_adjustpower1[];
-extern const u16 b43_ntab_bdi[];
-extern const u32 b43_ntab_channelest[];
-extern const u8 b43_ntab_estimatepowerlt0[];
-extern const u8 b43_ntab_estimatepowerlt1[];
-extern const u8 b43_ntab_framelookup[];
-extern const u32 b43_ntab_framestruct[];
-extern const u32 b43_ntab_gainctl0[];
-extern const u32 b43_ntab_gainctl1[];
-extern const u32 b43_ntab_intlevel[];
-extern const u32 b43_ntab_iqlt0[];
-extern const u32 b43_ntab_iqlt1[];
-extern const u16 b43_ntab_loftlt0[];
-extern const u16 b43_ntab_loftlt1[];
-extern const u8 b43_ntab_mcs[];
-extern const u32 b43_ntab_noisevar10[];
-extern const u32 b43_ntab_noisevar11[];
-extern const u16 b43_ntab_pilot[];
-extern const u32 b43_ntab_pilotlt[];
-extern const u32 b43_ntab_tdi20a0[];
-extern const u32 b43_ntab_tdi20a1[];
-extern const u32 b43_ntab_tdi40a0[];
-extern const u32 b43_ntab_tdi40a1[];
-extern const u32 b43_ntab_tdtrn[];
-extern const u32 b43_ntab_tmap[];
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);
+
+static const u8 b43_ntab_adjustpower0[];
+static const u8 b43_ntab_adjustpower1[];
+static const u16 b43_ntab_bdi[];
+static const u32 b43_ntab_channelest[];
+static const u8 b43_ntab_estimatepowerlt0[];
+static const u8 b43_ntab_estimatepowerlt1[];
+static const u8 b43_ntab_framelookup[];
+static const u32 b43_ntab_framestruct[];
+static const u32 b43_ntab_gainctl0[];
+static const u32 b43_ntab_gainctl1[];
+static const u32 b43_ntab_intlevel[];
+static const u32 b43_ntab_iqlt0[];
+static const u32 b43_ntab_iqlt1[];
+static const u16 b43_ntab_loftlt0[];
+static const u16 b43_ntab_loftlt1[];
+static const u8 b43_ntab_mcs[];
+static const u32 b43_ntab_noisevar10[];
+static const u32 b43_ntab_noisevar11[];
+static const u16 b43_ntab_pilot[];
+static const u32 b43_ntab_pilotlt[];
+static const u32 b43_ntab_tdi20a0[];
+static const u32 b43_ntab_tdi20a1[];
+static const u32 b43_ntab_tdi40a0[];
+static const u32 b43_ntab_tdi40a1[];
+static const u32 b43_ntab_tdtrn[];
+static const u32 b43_ntab_tmap[];


  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2

-- 
Rafa?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-b43-N-PHY-clean-table-init-check-PHY-rev-V2.patch
Type: application/octet-stream
Size: 16146 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100102/514fe6fa/attachment.obj>

From guitarman256 at hotmail.com  Sat Jan  2 17:33:00 2010
From: guitarman256 at hotmail.com (guitarman256 at hotmail.com)
Date: Sat, 2 Jan 2010 08:33:00 -0800
Subject: Vacation reply
In-Reply-To: <mailman.2267.1262449960.19088.bcm43xx-dev@lists.berlios.de>
Message-ID: <SNT0-MC3-F13BDBDD9E53B3C27D494C380760@phx.gbl>

An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100102/040d3fae/attachment.html>

From mb at bu3sch.de  Sat Jan  2 18:43:55 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 2 Jan 2010 18:43:55 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V2)
In-Reply-To: <op.u5wyyryj9lhzdc@linux-g0th.site>
References: <op.u5wyyryj9lhzdc@linux-g0th.site>
Message-ID: <201001021843.57583.mb@bu3sch.de>

On Saturday 02 January 2010 17:33:53 Rafa? Mi?ecki wrote:
> --- a/drivers/net/wireless/b43/tables_nphy.h
> +++ b/drivers/net/wireless/b43/tables_nphy.h

> -extern const u8 b43_ntab_adjustpower0[];
> +static const u8 b43_ntab_adjustpower0[];

Are you serious? o.O
Come on... You can do better ;)

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sat Jan  2 18:45:19 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 2 Jan 2010 18:45:19 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V2)
In-Reply-To: <201001021843.57583.mb@bu3sch.de>
References: <op.u5wyyryj9lhzdc@linux-g0th.site>
	<201001021843.57583.mb@bu3sch.de>
Message-ID: <b170af451001020945n561ac718p78517a5fb7576f87@mail.gmail.com>

W dniu 2 stycznia 2010 18:43 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Saturday 02 January 2010 17:33:53 Rafa? Mi?ecki wrote:
>> --- a/drivers/net/wireless/b43/tables_nphy.h
>> +++ b/drivers/net/wireless/b43/tables_nphy.h
>
>> -extern const u8 b43_ntab_adjustpower0[];
>> +static const u8 b43_ntab_adjustpower0[];
>
> Are you serious? o.O
> Come on... You can do better ;)

Yeah, I guess so :)

-- 
Rafa?


From zajec5 at gmail.com  Sat Jan  2 18:58:36 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 02 Jan 2010 18:58:36 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V3)
Message-ID: <op.u5w2vyof9lhzdc@linux-g0th.site>

Hopefully with Michaels's mysterious suggestion applied :)

 From 3d54059593785a820789c5af99ca1373eaf6b2c7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Sat, 2 Jan 2010 18:50:25 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V3)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Move table init to tables_nphy.c, detect newer PHY which use different init.
We don't init newer PHYs yet but this at least shows what more is needed.

V2: Make some functions and tables static
V3: Just drop static table declarations from header

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   43 ++-----------
  drivers/net/wireless/b43/tables_nphy.c |  100 +++++++++++++++++++++++--------
  drivers/net/wireless/b43/tables_nphy.h |   29 +---------
  3 files changed, 83 insertions(+), 89 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 992318a..a662ced 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -197,44 +197,15 @@ void b43_nphy_radio_turn_off(struct b43_wldev *dev)
  		     ~B43_NPHY_RFCTL_CMD_EN);
  }

-#define ntab_upload(dev, offset, data) do { \
-		unsigned int i;						\
-		for (i = 0; i < (offset##_SIZE); i++)			\
-			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
-	} while (0)
-
-/* Upload the N-PHY tables. */
+/* Upload the N-PHY tables.
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
+ */
  static void b43_nphy_tables_init(struct b43_wldev *dev)
  {
-	/* Static tables */
-	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
-	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
-	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
-	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
-	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
-	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
-	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
-	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
-	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
-	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
-	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
-	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
-	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
-	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
-
-	/* Volatile tables */
-	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
-	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
-	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
-	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
-	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
-	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
-	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
-	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
-	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
-	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
-	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
-	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+	if (dev->phy.rev < 3)
+		b43_nphy_rev0_1_2_tables_init(dev);
+	else
+		b43_nphy_rev3plus_tables_init(dev);
  }

  static void b43_nphy_workarounds(struct b43_wldev *dev)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 4e23363..d0b91b5 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -1336,7 +1336,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel)
  }


-const u8 b43_ntab_adjustpower0[] = {
+static const u8 b43_ntab_adjustpower0[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1355,7 +1355,7 @@ const u8 b43_ntab_adjustpower0[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u8 b43_ntab_adjustpower1[] = {
+static const u8 b43_ntab_adjustpower1[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1374,11 +1374,11 @@ const u8 b43_ntab_adjustpower1[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u16 b43_ntab_bdi[] = {
+static const u16 b43_ntab_bdi[] = {
  	0x0070, 0x0126, 0x012C, 0x0246, 0x048D, 0x04D2,
  };

-const u32 b43_ntab_channelest[] = {
+static const u32 b43_ntab_channelest[] = {
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
@@ -1405,7 +1405,7 @@ const u32 b43_ntab_channelest[] = {
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
  };

-const u8 b43_ntab_estimatepowerlt0[] = {
+static const u8 b43_ntab_estimatepowerlt0[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1416,7 +1416,7 @@ const u8 b43_ntab_estimatepowerlt0[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_estimatepowerlt1[] = {
+static const u8 b43_ntab_estimatepowerlt1[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1427,14 +1427,14 @@ const u8 b43_ntab_estimatepowerlt1[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_framelookup[] = {
+static const u8 b43_ntab_framelookup[] = {
  	0x02, 0x04, 0x14, 0x14, 0x03, 0x05, 0x16, 0x16,
  	0x0A, 0x0C, 0x1C, 0x1C, 0x0B, 0x0D, 0x1E, 0x1E,
  	0x06, 0x08, 0x18, 0x18, 0x07, 0x09, 0x1A, 0x1A,
  	0x0E, 0x10, 0x20, 0x28, 0x0F, 0x11, 0x22, 0x2A,
  };

-const u32 b43_ntab_framestruct[] = {
+static const u32 b43_ntab_framestruct[] = {
  	0x08004A04, 0x00100000, 0x01000A05, 0x00100020,
  	0x09804506, 0x00100030, 0x09804507, 0x00100030,
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
@@ -1645,7 +1645,7 @@ const u32 b43_ntab_framestruct[] = {
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_gainctl0[] = {
+static const u32 b43_ntab_gainctl0[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1680,7 +1680,7 @@ const u32 b43_ntab_gainctl0[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_gainctl1[] = {
+static const u32 b43_ntab_gainctl1[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1715,12 +1715,12 @@ const u32 b43_ntab_gainctl1[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_intlevel[] = {
+static const u32 b43_ntab_intlevel[] = {
  	0x00802070, 0x0671188D, 0x0A60192C, 0x0A300E46,
  	0x00C1188D, 0x080024D2, 0x00000070,
  };

-const u32 b43_ntab_iqlt0[] = {
+static const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1755,7 +1755,7 @@ const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u32 b43_ntab_iqlt1[] = {
+static const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1790,7 +1790,7 @@ const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u16 b43_ntab_loftlt0[] = {
+static const u16 b43_ntab_loftlt0[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1815,7 +1815,7 @@ const u16 b43_ntab_loftlt0[] = {
  	0x0002, 0x0103,
  };

-const u16 b43_ntab_loftlt1[] = {
+static const u16 b43_ntab_loftlt1[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1840,7 +1840,7 @@ const u16 b43_ntab_loftlt1[] = {
  	0x0002, 0x0103,
  };

-const u8 b43_ntab_mcs[] = {
+static const u8 b43_ntab_mcs[] = {
  	0x00, 0x08, 0x0A, 0x10, 0x12, 0x19, 0x1A, 0x1C,
  	0x40, 0x48, 0x4A, 0x50, 0x52, 0x59, 0x5A, 0x5C,
  	0x80, 0x88, 0x8A, 0x90, 0x92, 0x99, 0x9A, 0x9C,
@@ -1859,7 +1859,7 @@ const u8 b43_ntab_mcs[] = {
  	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  };

-const u32 b43_ntab_noisevar10[] = {
+static const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1926,7 +1926,7 @@ const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u32 b43_ntab_noisevar11[] = {
+static const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1993,7 +1993,7 @@ const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u16 b43_ntab_pilot[] = {
+static const u16 b43_ntab_pilot[] = {
  	0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08,
  	0xFF08, 0xFF08, 0x80D5, 0x80D5, 0x80D5, 0x80D5,
  	0x80D5, 0x80D5, 0x80D5, 0x80D5, 0xFF0A, 0xFF82,
@@ -2011,12 +2011,12 @@ const u16 b43_ntab_pilot[] = {
  	0xF0A0, 0xF028, 0xFFFF, 0xFFFF,
  };

-const u32 b43_ntab_pilotlt[] = {
+static const u32 b43_ntab_pilotlt[] = {
  	0x76540123, 0x62407351, 0x76543201, 0x76540213,
  	0x76540123, 0x76430521,
  };

-const u32 b43_ntab_tdi20a0[] = {
+static const u32 b43_ntab_tdi20a0[] = {
  	0x00091226, 0x000A1429, 0x000B56AD, 0x000C58B0,
  	0x000D5AB3, 0x000E9CB6, 0x000F9EBA, 0x0000C13D,
  	0x00020301, 0x00030504, 0x00040708, 0x0005090B,
@@ -2033,7 +2033,7 @@ const u32 b43_ntab_tdi20a0[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi20a1[] = {
+static const u32 b43_ntab_tdi20a1[] = {
  	0x00014B26, 0x00028D29, 0x000393AD, 0x00049630,
  	0x0005D833, 0x0006DA36, 0x00099C3A, 0x000A9E3D,
  	0x000BC081, 0x000CC284, 0x000DC488, 0x000F068B,
@@ -2050,7 +2050,7 @@ const u32 b43_ntab_tdi20a1[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a0[] = {
+static const u32 b43_ntab_tdi40a0[] = {
  	0x0011A346, 0x00136CCF, 0x0014F5D9, 0x001641E2,
  	0x0017CB6B, 0x00195475, 0x001B2383, 0x001CAD0C,
  	0x001E7616, 0x0000821F, 0x00020BA8, 0x0003D4B2,
@@ -2081,7 +2081,7 @@ const u32 b43_ntab_tdi40a0[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a1[] = {
+static const u32 b43_ntab_tdi40a1[] = {
  	0x001EDB36, 0x000129CA, 0x0002B353, 0x00047CDD,
  	0x0005C8E6, 0x000791EF, 0x00091BF9, 0x000AAA07,
  	0x000C3391, 0x000DFD1A, 0x00120923, 0x0013D22D,
@@ -2112,7 +2112,7 @@ const u32 b43_ntab_tdi40a1[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdtrn[] = {
+static const u32 b43_ntab_tdtrn[] = {
  	0x061C061C, 0x0050EE68, 0xF592FE36, 0xFE5212F6,
  	0x00000C38, 0xFE5212F6, 0xF592FE36, 0x0050EE68,
  	0x061C061C, 0xEE680050, 0xFE36F592, 0x12F6FE52,
@@ -2291,7 +2291,7 @@ const u32 b43_ntab_tdtrn[] = {
  	0xFA58FC00, 0x0B64FC7E, 0x0800F7B6, 0x00F006BE,
  };

-const u32 b43_ntab_tmap[] = {
+static const u32 b43_ntab_tmap[] = {
  	0x8A88AA80, 0x8AAAAA8A, 0x8A8A8AA8, 0x00000888,
  	0x88000000, 0x8A8A88AA, 0x8AA88888, 0x8888A8A8,
  	0xF1111110, 0x11111111, 0x11F11111, 0x00000111,
@@ -2474,3 +2474,51 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  	/* Some compiletime assertions... */
  	assert_ntab_array_sizes();
  }
+
+#define ntab_upload(dev, offset, data) do { \
+		unsigned int i;						\
+		for (i = 0; i < (offset##_SIZE); i++)			\
+			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
+	} while (0)
+
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
+	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
+	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
+	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
+	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
+	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
+	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
+	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
+	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
+	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
+	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
+	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
+	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
+	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
+
+	/* Volatile tables */
+	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
+	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
+	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
+	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
+	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
+	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
+	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
+	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
+	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
+	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
+	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
+	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+}
+
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	/* TODO */
+
+	/* Volatile tables */
+	/* TODO */
+}
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 4d498b0..1f0a602 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -128,32 +128,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);

  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);

-extern const u8 b43_ntab_adjustpower0[];
-extern const u8 b43_ntab_adjustpower1[];
-extern const u16 b43_ntab_bdi[];
-extern const u32 b43_ntab_channelest[];
-extern const u8 b43_ntab_estimatepowerlt0[];
-extern const u8 b43_ntab_estimatepowerlt1[];
-extern const u8 b43_ntab_framelookup[];
-extern const u32 b43_ntab_framestruct[];
-extern const u32 b43_ntab_gainctl0[];
-extern const u32 b43_ntab_gainctl1[];
-extern const u32 b43_ntab_intlevel[];
-extern const u32 b43_ntab_iqlt0[];
-extern const u32 b43_ntab_iqlt1[];
-extern const u16 b43_ntab_loftlt0[];
-extern const u16 b43_ntab_loftlt1[];
-extern const u8 b43_ntab_mcs[];
-extern const u32 b43_ntab_noisevar10[];
-extern const u32 b43_ntab_noisevar11[];
-extern const u16 b43_ntab_pilot[];
-extern const u32 b43_ntab_pilotlt[];
-extern const u32 b43_ntab_tdi20a0[];
-extern const u32 b43_ntab_tdi20a1[];
-extern const u32 b43_ntab_tdi40a0[];
-extern const u32 b43_ntab_tdi40a1[];
-extern const u32 b43_ntab_tdtrn[];
-extern const u32 b43_ntab_tmap[];
-
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-b43-N-PHY-clean-table-init-check-PHY-rev-V3.patch
Type: application/octet-stream
Size: 15176 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100102/c56d4c92/attachment.obj>

From zajec5 at gmail.com  Sat Jan  2 23:41:01 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 02 Jan 2010 23:41:01 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
Message-ID: <op.u5xfync79lhzdc@linux-g0th.site>

It's my first patch that tries to do something. Could you review this, please? Did I write it correctly? Did I use correct registers names (like B43_NPHY_TXF_*)?

Also I need some help with:
//TODO: Set bit 0x40 in the Chip Control register (0x28)
could someone let me know how can I write to chip control register? Is following correct?
tmp = b43_read16(dev, 0x28);
b43_write16(dev, 0x28, tmp | 0x40);

I see there are read/write for PHY, radio and "just b43" (like above). Did I use correct one?


diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index a662ced..d503cb7 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -390,18 +390,38 @@ static void b43_nphy_rssi_cal(struct b43_wldev *dev, u8 type)

  int b43_phy_initn(struct b43_wldev *dev)
  {
+	struct ssb_bus *bus = dev->dev->bus;
  	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = phy->n;
  	u16 tmp;
+	u16 clip[2];
+
+	nphy->do_cal = 0;
+	if ((dev->phy.rev >= 3) &&
+	   (bus->sprom.boardflags_lo & B43_BFL_EXTLNA) &&
+	   (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)) {
+		//TODO: Set bit 0x40 in the Chip Control register (0x28)
+	}
+	nphy->deaf_count = 0;

-	//TODO: Spectral management
  	b43_nphy_tables_init(dev);

  	/* Clear all overrides */
-	b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+	if (dev->phy.rev >= 3) {
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, 0);
+		b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, 0);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, 0);
+	}
+	else {
+		b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+	}
  	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, 0);
  	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, 0);
-	b43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);
-	b43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);
+	if (dev->phy.rev < 6) {
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);
+	}
  	b43_phy_mask(dev, B43_NPHY_RFSEQMODE,
  		     ~(B43_NPHY_RFSEQMODE_CAOVER |
  		       B43_NPHY_RFSEQMODE_TROVER));
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 1749aef..58fdd4c 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -920,6 +920,9 @@
  struct b43_wldev;

  struct b43_phy_n {
+	u8 do_cal;
+	u8 deaf_count;
+
  	//TODO lots of missing stuff
  };
-------------- next part --------------
A non-text attachment was scrubbed...
Name: N-PHY-RFC.patch
Type: application/octet-stream
Size: 1881 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100102/3acede95/attachment.obj>

From zajec5 at gmail.com  Sat Jan  2 23:50:25 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 2 Jan 2010 23:50:25 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <op.u5xfync79lhzdc@linux-g0th.site>
References: <op.u5xfync79lhzdc@linux-g0th.site>
Message-ID: <b170af451001021450m69ce4a93v6cc0da2df61057f0@mail.gmail.com>

W dniu 2 stycznia 2010 23:41 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> ?struct b43_phy_n {
> + ? ? ? u8 do_cal;
> + ? ? ? u8 deaf_count;

How can I know if u8 is alright for that variables? Is that just about
guessing, or can I read it somewhere?

-- 
Rafa?


From enhaisa at gmail.com  Sun Jan  3 03:11:34 2010
From: enhaisa at gmail.com (Daniel Kuehn)
Date: Sun, 3 Jan 2010 03:11:34 +0100
Subject: The newest Macbook 13.3" wireless
Message-ID: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>

Hi,

I am the (un)lucky owner of a Macbook of late 2009 model, which has a
Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43 or
broadcom-sta support it, I just get invalid parameters or the interface
disappears.

Is there anyway I could help you guys with getting this wlan card to work? I
could test experimental drivers or try to bash it to work or such, it would
just be awesome if I could get it to work.

The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N card as
I have understod it, but there exist no info that either confirm or discard
the PCI ID as a WLAN card. I havent been able to get any info of which card
this is supposed to be from broadcoms sortiment, I cannot find any of the
cards listen on broadcoms homepage to match with this card.

Mvh
Daniel Kuehn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100103/2a72f9e4/attachment.html>

From Larry.Finger at lwfinger.net  Sun Jan  3 03:41:22 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 02 Jan 2010 20:41:22 -0600
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
Message-ID: <4B4003D2.6060200@lwfinger.net>

On 01/02/2010 08:11 PM, Daniel Kuehn wrote:
> Hi,
> 
> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43
> or broadcom-sta support it, I just get invalid parameters or the
> interface disappears.
> 
> Is there anyway I could help you guys with getting this wlan card to
> work? I could test experimental drivers or try to bash it to work or
> such, it would just be awesome if I could get it to work.
> 
> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N
> card as I have understod it, but there exist no info that either confirm
> or discard the PCI ID as a WLAN card. I havent been able to get any info
> of which card this is supposed to be from broadcoms sortiment, I cannot
> find any of the cards listen on broadcoms homepage to match with this card.

The Broadcom 5.10.56.46 that is the basis for my current reverse engineering
effort supports that card. To the best of my knowledge, it is an 802.11n
dual-band card. The coding effort to support N PHYs has just started. Of course,
it could be an SSLPN PHY and the RE for them is not yet started. In any case,
who knows when any code will be ready. Watch this mailing list for patches.

Larry


From netrolller.3d at gmail.com  Sun Jan  3 04:35:04 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 3 Jan 2010 04:35:04 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <4B4003D2.6060200@lwfinger.net>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com> 
	<4B4003D2.6060200@lwfinger.net>
Message-ID: <69e28c911001021935u564b7051j36aa741bff4ac9c6@mail.gmail.com>

On Sun, Jan 3, 2010 at 3:41 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 01/02/2010 08:11 PM, Daniel Kuehn wrote:
>> Hi,
>>
>> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
>> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43
>> or broadcom-sta support it, I just get invalid parameters or the
>> interface disappears.
>>
>> Is there anyway I could help you guys with getting this wlan card to
>> work? I could test experimental drivers or try to bash it to work or
>> such, it would just be awesome if I could get it to work.
>>
>> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N
>> card as I have understod it, but there exist no info that either confirm
>> or discard the PCI ID as a WLAN card. I havent been able to get any info
>> of which card this is supposed to be from broadcoms sortiment, I cannot
>> find any of the cards listen on broadcoms homepage to match with this card.
>
> The Broadcom 5.10.56.46 that is the basis for my current reverse engineering
> effort supports that card. To the best of my knowledge, it is an 802.11n
> dual-band card. The coding effort to support N PHYs has just started. Of course,
> it could be an SSLPN PHY and the RE for them is not yet started. In any case,
> who knows when any code will be ready. Watch this mailing list for patches.
>
> Larry
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

It is a BCM43224, N-PHY+Bluetooth. It is not an SSLPN- or QN-PHY.

(BTW, these PHY names are somehow just keep getting longer and
longer... I believe in 2020, we will see the first
ALLURBASERBELONG2US-PHY... though maybe
PSEUDOPNEUMONOULTRAMICROSCOPICSILICOVOLCANOCONIOSIS-PHY is a better
guess.)

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Sun Jan  3 22:30:27 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 3 Jan 2010 22:30:27 +0100
Subject: b43: acking patches
Message-ID: <b170af451001031330i514d3d8frcd3b29f697e42872@mail.gmail.com>

Michael, you gave me some reviews of patches I was very glad to see. I
posted some (hopefully) corrected versions but didn't get your
response.

Can we expect you ACKing patches as well?

I post this question publicly as I may be not the only one person who
would like to know this.

-- 
Rafa?


From zajec5 at gmail.com  Sun Jan  3 22:34:38 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 3 Jan 2010 22:34:38 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <op.u5xfync79lhzdc@linux-g0th.site>
References: <op.u5xfync79lhzdc@linux-g0th.site>
Message-ID: <b170af451001031334g6c25e693kf5f67ddba9b4b86e@mail.gmail.com>

W dniu 2 stycznia 2010 23:41 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> It's my first patch that tries to do something. Could you review this,
> please? Did I write it correctly? Did I use correct registers names (like
> B43_NPHY_TXF_*)?
>
> Also I need some help with:
> //TODO: Set bit 0x40 in the Chip Control register (0x28)
> could someone let me know how can I write to chip control register? Is
> following correct?
> tmp = b43_read16(dev, 0x28);
> b43_write16(dev, 0x28, tmp | 0x40);
>
> I see there are read/write for PHY, radio and "just b43" (like above). Did I
> use correct one?

Chip Common is generally used/programmed in driver_chipcommon.c &&
friends. Probably I'll need to hack that part to perform "Set bit 0x40
in the Chip Control register (0x28)".


> ?struct b43_phy_n {
> + ? ? ? u8 do_cal;

This seems to be local variable for N-PHY init.


> + ? ? ? u8 deaf_count;

It's some kind of counter... Maybe I'll use something "bigger" like
u32 just in case.


If you have any other comments, please post.

-- 
Rafa?


From mb at bu3sch.de  Sun Jan  3 23:07:55 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 3 Jan 2010 23:07:55 +0100
Subject: b43: acking patches
In-Reply-To: <b170af451001031330i514d3d8frcd3b29f697e42872@mail.gmail.com>
References: <b170af451001031330i514d3d8frcd3b29f697e42872@mail.gmail.com>
Message-ID: <201001032307.57327.mb@bu3sch.de>

On Sunday 03 January 2010 22:30:27 Rafa? Mi?ecki wrote:
> Michael, you gave me some reviews of patches I was very glad to see. I
> posted some (hopefully) corrected versions but didn't get your
> response.
> 
> Can we expect you ACKing patches as well?
> 
> I post this question publicly as I may be not the only one person who
> would like to know this.

Well, no response means I'm OK with it (or that I don't care).
In the past I used to ack all patches, but we changed that and I only
reply if I see problems with patches.
I usually respond within less than a day, if there's something I disagree with.

-- 
Greetings, Michael.


From mb at bu3sch.de  Mon Jan  4 00:15:54 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 4 Jan 2010 00:15:54 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <b170af451001031334g6c25e693kf5f67ddba9b4b86e@mail.gmail.com>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<b170af451001031334g6c25e693kf5f67ddba9b4b86e@mail.gmail.com>
Message-ID: <201001040015.56442.mb@bu3sch.de>

On Sunday 03 January 2010 22:34:38 Rafa? Mi?ecki wrote:
> > Also I need some help with:
> > //TODO: Set bit 0x40 in the Chip Control register (0x28)
> > could someone let me know how can I write to chip control register? Is
> > following correct?
> > tmp = b43_read16(dev, 0x28);
> > b43_write16(dev, 0x28, tmp | 0x40);
> >
> > I see there are read/write for PHY, radio and "just b43" (like above). Did I
> > use correct one?
> 
> Chip Common is generally used/programmed in driver_chipcommon.c &&
> friends. Probably I'll need to hack that part to perform "Set bit 0x40
> in the Chip Control register (0x28)".

Well, what does the specification say about this "Chip Control register"?
Is it on the PHY, MAC core or another SSB core like the ChipCommon?

-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan  4 01:10:32 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 01:10:32 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <201001040015.56442.mb@bu3sch.de>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<b170af451001031334g6c25e693kf5f67ddba9b4b86e@mail.gmail.com>
	<201001040015.56442.mb@bu3sch.de>
Message-ID: <b170af451001031610m12740b3aj8a3e99253fbacd88@mail.gmail.com>

W dniu 4 stycznia 2010 00:15 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Sunday 03 January 2010 22:34:38 Rafa? Mi?ecki wrote:
>> > Also I need some help with:
>> > //TODO: Set bit 0x40 in the Chip Control register (0x28)
>> > could someone let me know how can I write to chip control register? Is
>> > following correct?
>> > tmp = b43_read16(dev, 0x28);
>> > b43_write16(dev, 0x28, tmp | 0x40);
>> >
>> > I see there are read/write for PHY, radio and "just b43" (like above). Did I
>> > use correct one?
>>
>> Chip Common is generally used/programmed in driver_chipcommon.c &&
>> friends. Probably I'll need to hack that part to perform "Set bit 0x40
>> in the Chip Control register (0x28)".
>
> Well, what does the specification say about this "Chip Control register"?
> Is it on the PHY, MAC core or another SSB core like the ChipCommon?

Please, see table on:
http://bcm-v4.sipsolutions.net/ChipCommon

It contains:
Offset: 0x28
Size: 4
Name: Chip Control
Usage: Revision >= 11 Only

So I probably will need to use something like:
tmp = chipco_read32(cc, SSB_CHIPCO_CHIPCTL);
tmp |= 0x40;
chipco_write32(cc, SSB_CHIPCO_CHIPCTL, tmp);

-- 
Rafa?


From c.snell at minesite.com.au  Mon Jan  4 09:30:14 2010
From: c.snell at minesite.com.au (Chris Snell)
Date: Mon, 04 Jan 2010 19:30:14 +1100
Subject: Multiple SSID using b43 with OpenWRT
Message-ID: <4B41A716.8070409@minesite.com.au>

Is it possible to get a brief update on the status of multiple SSID 
support from b43?
I am using b43 on a broadcom based board with OpenWRT and hostapd fails 
to start correctly for the second SSID. I am trying to determine if it 
is hostapd or b43 or the OpenWRT scripts that need to be modified.

iwconfig shows that both wlan0 and wlan1 have been created.

When the first instance of hostapd starts, it successfully creates the 
SSID for wlan0 and the mon.wlan0 interface is created.
However, when the second instance of hostapd tries to start an error is 
received.

Many thanks for any assistance that can be provided. The output from 
attempting to start hostapd on wlan1 is listed below.


root at OpenWrt:/# hostapd -dd -P /var/run/wifi-wlan0.pid  -B 
/var/run/hostapd-wlan1.conf
Configuration file: /var/run/hostapd-wlan1.conf
nl80211: Add own interface ifindex 5
nl80211: Add own interface ifindex 9
nl80211: Add own interface ifindex 11
ioctl[SIOCSIFFLAGS]: Operation not supported
nl80211 driver initialization failed.
wlan1: Unable to setup interface.
Flushing old station entries
Deauthenticate all stations
rmdir[ctrl_interface]: No such file or directory
ELOOP: remaining socket: sock=4 eloop_data=0x472ca8 user_data=0x472710 
handler=0x4242b0
ELOOP: remaining socket: sock=6 eloop_data=0x472ca8 user_data=(nil) 
handler=0x426448



From mb at bu3sch.de  Mon Jan  4 11:03:23 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 4 Jan 2010 11:03:23 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <b170af451001031610m12740b3aj8a3e99253fbacd88@mail.gmail.com>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<201001040015.56442.mb@bu3sch.de>
	<b170af451001031610m12740b3aj8a3e99253fbacd88@mail.gmail.com>
Message-ID: <201001041103.25531.mb@bu3sch.de>

On Monday 04 January 2010 01:10:32 Rafa? Mi?ecki wrote:
> Please, see table on:
> http://bcm-v4.sipsolutions.net/ChipCommon

No I mean where does the specs say to _write_ to that register?

-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan  4 11:23:36 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 11:23:36 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <201001041103.25531.mb@bu3sch.de>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<201001040015.56442.mb@bu3sch.de>
	<b170af451001031610m12740b3aj8a3e99253fbacd88@mail.gmail.com>
	<201001041103.25531.mb@bu3sch.de>
Message-ID: <b170af451001040223j641124e3uc770f12d380e18da@mail.gmail.com>

W dniu 4 stycznia 2010 11:03 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Monday 04 January 2010 01:10:32 Rafa? Mi?ecki wrote:
>> Please, see table on:
>> http://bcm-v4.sipsolutions.net/ChipCommon
>
> No I mean where does the specs say to _write_ to that register?

Whoops, sorry. You can find this in:
http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
3. If PHY revision >= 3, bit 0x00001000 is set in the board flags, and
this is a 2 GHz band
    a. Set bit 0x40 in the Chip Control register (0x28)

-- 
Rafa?


From mb at bu3sch.de  Mon Jan  4 16:42:03 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 4 Jan 2010 16:42:03 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <b170af451001040223j641124e3uc770f12d380e18da@mail.gmail.com>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<201001041103.25531.mb@bu3sch.de>
	<b170af451001040223j641124e3uc770f12d380e18da@mail.gmail.com>
Message-ID: <201001041642.05791.mb@bu3sch.de>

On Monday 04 January 2010 11:23:36 Rafa? Mi?ecki wrote:
> W dniu 4 stycznia 2010 11:03 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> > On Monday 04 January 2010 01:10:32 Rafa? Mi?ecki wrote:
> >> Please, see table on:
> >> http://bcm-v4.sipsolutions.net/ChipCommon
> >
> > No I mean where does the specs say to _write_ to that register?
> 
> Whoops, sorry. You can find this in:
> http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
> 3. If PHY revision >= 3, bit 0x00001000 is set in the board flags, and
> this is a 2 GHz band
>     a. Set bit 0x40 in the Chip Control register (0x28)


Ok, it's not entirely clear to me whether this is the CHIPCTL register in
the chipcommon core. But if it is, just do something like this:

chipco_set32(&dev->dev->bus->chipco, SSB_CHIPCO_CHIPCTL, 0x40);

I think it's probably not necessary to introduce a function in driver_chipcommon.c
for this oneliner.

-- 
Greetings, Michael.


From jhhaynes at earthlink.net  Mon Jan  4 17:31:24 2010
From: jhhaynes at earthlink.net (Jim Haynes)
Date: Mon, 4 Jan 2010 10:31:24 -0600 (CST)
Subject: b43 on Dell i1545 laptop
Message-ID: <alpine.LFD.2.00.1001041025280.2021@localhost>

I've just joined the list, and most of the stuff is way over my head.
Is there a list for b43 users?

I just got a Dell i1545 laptop and put Fedora 12 on it.  The current
kernel is 2.6.31.9-174.fc12.x86_64

lspci says [14e4:4315] (rev 01)  and the b43 web page says support is
"in progress"  but I don't see a date for that status.

I installed the firmware in /lib/firmware/b43 like the web page says

dmesg reports
b43-phy0: Broadcom 4312 WLAN found (core revision 15)
b43-phy0: ERROR: FOUND UNSUPPORTED PHY  (Analog 6, Type 5, Revision 1)
b43: probe of ssb0:0 failed with error -95

Is there anything you need me to test for and report?  Or anything I can
do to get this working?  Or should I just wait? (I have no pressing need
for it to work just now)

Jim


jhhaynes at earthlink dot net



From zajec5 at gmail.com  Mon Jan  4 18:14:00 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 18:14:00 +0100
Subject: b43 on Dell i1545 laptop
In-Reply-To: <alpine.LFD.2.00.1001041025280.2021@localhost>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>
Message-ID: <b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>

2010/1/4 Jim Haynes <jhhaynes at earthlink.net>:
> I've just joined the list, and most of the stuff is way over my head.
> Is there a list for b43 users?
>
> I just got a Dell i1545 laptop and put Fedora 12 on it. ?The current
> kernel is 2.6.31.9-174.fc12.x86_64
>
> lspci says [14e4:4315] (rev 01) ?and the b43 web page says support is
> "in progress" ?but I don't see a date for that status.
>
> I installed the firmware in /lib/firmware/b43 like the web page says
>
> dmesg reports
> b43-phy0: Broadcom 4312 WLAN found (core revision 15)
> b43-phy0: ERROR: FOUND UNSUPPORTED PHY ?(Analog 6, Type 5, Revision 1)
> b43: probe of ssb0:0 failed with error -95
>
> Is there anything you need me to test for and report? ?Or anything I can
> do to get this working? ?Or should I just wait? (I have no pressing need
> for it to work just now)

That is LP PHY based wireless card and LP has basic support in 2.6.32
kernel. You have .31 so it's unsupported PHY for you.

After upgrading to 2.6.32 you should hopefully get stable but still
low performance support for your card.

-- 
Rafa?


From zajec5 at gmail.com  Mon Jan  4 18:16:03 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 18:16:03 +0100
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <201001041642.05791.mb@bu3sch.de>
References: <op.u5xfync79lhzdc@linux-g0th.site>
	<201001041103.25531.mb@bu3sch.de>
	<b170af451001040223j641124e3uc770f12d380e18da@mail.gmail.com>
	<201001041642.05791.mb@bu3sch.de>
Message-ID: <b170af451001040916x36e21d88h6af5211ca39a4083@mail.gmail.com>

W dniu 4 stycznia 2010 16:42 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Monday 04 January 2010 11:23:36 Rafa? Mi?ecki wrote:
>> W dniu 4 stycznia 2010 11:03 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
>> > On Monday 04 January 2010 01:10:32 Rafa? Mi?ecki wrote:
>> >> Please, see table on:
>> >> http://bcm-v4.sipsolutions.net/ChipCommon
>> >
>> > No I mean where does the specs say to _write_ to that register?
>>
>> Whoops, sorry. You can find this in:
>> http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
>> 3. If PHY revision >= 3, bit 0x00001000 is set in the board flags, and
>> this is a 2 GHz band
>> ? ? a. Set bit 0x40 in the Chip Control register (0x28)
>
>
> Ok, it's not entirely clear to me whether this is the CHIPCTL register in
> the chipcommon core. But if it is, just do something like this:
>
> chipco_set32(&dev->dev->bus->chipco, SSB_CHIPCO_CHIPCTL, 0x40);
>
> I think it's probably not necessary to introduce a function in driver_chipcommon.c
> for this oneliner.

Thank you for your help, I appreciate it.

Larry: could you just confirm my understanding of docs? Did you mean
chipcommon core in that N-PHY init step?

-- 
Rafa?


From Larry.Finger at lwfinger.net  Mon Jan  4 19:18:05 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 04 Jan 2010 12:18:05 -0600
Subject: b43 on Dell i1545 laptop
In-Reply-To: <b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>
	<b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
Message-ID: <4B4230DD.2070003@lwfinger.net>

On 01/04/2010 11:14 AM, Rafa? Mi?ecki wrote:
> 2010/1/4 Jim Haynes <jhhaynes at earthlink.net>:
>> I've just joined the list, and most of the stuff is way over my head.
>> Is there a list for b43 users?

As you have noticed, this is a list for developers. The user-type questions are
generally handled in distro forums.

>> I just got a Dell i1545 laptop and put Fedora 12 on it.  The current
>> kernel is 2.6.31.9-174.fc12.x86_64
>>
>> lspci says [14e4:4315] (rev 01)  and the b43 web page says support is
>> "in progress"  but I don't see a date for that status.

As Rafa? told you, that driver is in kernel 2.6.32.

>> I installed the firmware in /lib/firmware/b43 like the web page says
>>
>> dmesg reports
>> b43-phy0: Broadcom 4312 WLAN found (core revision 15)
>> b43-phy0: ERROR: FOUND UNSUPPORTED PHY  (Analog 6, Type 5, Revision 1)
>> b43: probe of ssb0:0 failed with error -95
>>
>> Is there anything you need me to test for and report?  Or anything I can
>> do to get this working?  Or should I just wait? (I have no pressing need
>> for it to work just now)
> 
> That is LP PHY based wireless card and LP has basic support in 2.6.32
> kernel. You have .31 so it's unsupported PHY for you.
> 
> After upgrading to 2.6.32 you should hopefully get stable but still
> low performance support for your card.

As an alternative to switching to kernel 2.6.32, you could implement the
compat-wireless package. As for performance, the 4315/b43 combination receives
at a rate of about 20 Mb/s and sends at 12 Mb/s. This is not full 802.11g rate,
but quite respectable. The connection is very stable.

Larry




From Larry.Finger at lwfinger.net  Mon Jan  4 19:23:56 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 04 Jan 2010 12:23:56 -0600
Subject: [RFC][RFH] Small fixes to N-PHY init
In-Reply-To: <b170af451001040916x36e21d88h6af5211ca39a4083@mail.gmail.com>
References: <op.u5xfync79lhzdc@linux-g0th.site>	<201001041103.25531.mb@bu3sch.de>	<b170af451001040223j641124e3uc770f12d380e18da@mail.gmail.com>	<201001041642.05791.mb@bu3sch.de>
	<b170af451001040916x36e21d88h6af5211ca39a4083@mail.gmail.com>
Message-ID: <4B42323C.2030503@lwfinger.net>

On 01/04/2010 11:16 AM, Rafa? Mi?ecki wrote:
> 
> Larry: could you just confirm my understanding of docs? Did you mean
> chipcommon core in that N-PHY init step?
> 

Yes, the reference is to a register in the chipcommon core.

Larry


From zajec5 at gmail.com  Mon Jan  4 21:26:27 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 04 Jan 2010 21:26:27 +0100
Subject: [PATCH] b43: N-PHY: update part of init code to current specs
Message-ID: <op.u50y2cd29lhzdc@linux-g0th.site>

This makes part of init code follow updated specs.

Michael said many times he prefers smaller patches posted more frequently. So there this go.

However if you think it's too small, just let me know please.


 From 7892ad10e3e15abc960e9a05c8c372a97b1f6b67 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Mon, 4 Jan 2010 21:20:14 +0100
Subject: [PATCH] b43: N-PHY: update part of init code to current specs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   72 +++++++++++++++++++++++++++++++-------
  drivers/net/wireless/b43/phy_n.h |   12 ++++++
  2 files changed, 71 insertions(+), 13 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 992318a..015da44 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -417,37 +417,70 @@ static void b43_nphy_rssi_cal(struct b43_wldev *dev, u8 type)
  	//TODO
  }

+/* Init N-PHY
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
+ */
  int b43_phy_initn(struct b43_wldev *dev)
  {
+	struct ssb_bus *bus = dev->dev->bus;
  	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = phy->n;
  	u16 tmp;
+	enum ieee80211_band tmp2;
+
+	u16 clip[2];
+	bool do_cal = false;

-	//TODO: Spectral management
+	if ((dev->phy.rev >= 3) &&
+	   (bus->sprom.boardflags_lo & B43_BFL_EXTLNA) &&
+	   (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)) {
+		chipco_set32(&dev->dev->bus->chipco, SSB_CHIPCO_CHIPCTL, 0x40);
+	}
+	nphy->deaf_count = 0;
  	b43_nphy_tables_init(dev);
+	nphy->crsminpwr_adjusted = false;
+	nphy->noisevars_adjusted = false;

  	/* Clear all overrides */
-	b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+	if (dev->phy.rev >= 3) {
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, 0);
+		b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, 0);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, 0);
+	} else {
+		b43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);
+	}
  	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, 0);
  	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, 0);
-	b43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);
-	b43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);
+	if (dev->phy.rev < 6) {
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);
+	}
  	b43_phy_mask(dev, B43_NPHY_RFSEQMODE,
  		     ~(B43_NPHY_RFSEQMODE_CAOVER |
  		       B43_NPHY_RFSEQMODE_TROVER));
+	if (dev->phy.rev >= 3)
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, 0);
  	b43_phy_write(dev, B43_NPHY_AFECTL_OVER, 0);

-	tmp = (phy->rev < 2) ? 64 : 59;
-	b43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,
-			~B43_NPHY_BPHY_CTL3_SCALE,
-			tmp << B43_NPHY_BPHY_CTL3_SCALE_SHIFT);
-
+	if (dev->phy.rev <= 2) {
+		tmp = (dev->phy.rev == 2) ? 0x3B : 0x40;
+		b43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,
+				~B43_NPHY_BPHY_CTL3_SCALE,
+				tmp << B43_NPHY_BPHY_CTL3_SCALE_SHIFT);
+	}
  	b43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_20M, 0x20);
  	b43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_40M, 0x20);

-	b43_phy_write(dev, B43_NPHY_TXREALFD, 184);
-	b43_phy_write(dev, B43_NPHY_MIMO_CRSTXEXT, 200);
-	b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 80);
-	b43_phy_write(dev, B43_NPHY_C2_BCLIPBKOFF, 511);
+	if (bus->sprom.boardflags2_lo & 0x100 ||
+	    (bus->boardinfo.vendor == PCI_VENDOR_ID_APPLE &&
+	     bus->boardinfo.type == 0x8B))
+		b43_phy_write(dev, B43_NPHY_TXREALFD, 0xA0);
+	else
+		b43_phy_write(dev, B43_NPHY_TXREALFD, 0xB8);
+	b43_phy_write(dev, B43_NPHY_MIMO_CRSTXEXT, 0xC8);
+	b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x50);
+	b43_phy_write(dev, B43_NPHY_TXRIFS_FRDEL, 0x30);

  	//TODO MIMO-Config
  	//TODO Update TX/RX chain
@@ -456,6 +489,19 @@ int b43_phy_initn(struct b43_wldev *dev)
  		b43_phy_write(dev, B43_NPHY_DUP40_GFBL, 0xAA8);
  		b43_phy_write(dev, B43_NPHY_DUP40_BL, 0x9A4);
  	}
+
+	tmp2 = b43_current_band(dev->wl);
+	if ((nphy->ipa2g_on && tmp2 == IEEE80211_BAND_2GHZ) ||
+	    (nphy->ipa5g_on && tmp2 == IEEE80211_BAND_5GHZ)) {
+		b43_phy_set(dev, B43_NPHY_PAPD_EN0, 0x1);
+		//FIXME b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ0, 0x007F, nphy->papd_epsilon_offset[0] << 7);
+		b43_phy_set(dev, B43_NPHY_PAPD_EN1, 0x1);
+		//FIXME b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F, nphy->papd_epsilon_offset[1] << 7);
+		//TODO N PHY IPA Set TX Dig Filters
+	} else if (phy->rev >= 5) {
+		//TODO N PHY Ext PA Set TX Dig Filters
+	}
+
  	b43_nphy_workarounds(dev);
  	b43_nphy_reset_cca(dev);

diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 1749aef..8f174b7 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -231,6 +231,7 @@
  #define B43_NPHY_C2_TXIQ_COMP_OFF		B43_PHY_N(0x088) /* Core 2 TX I/Q comp offset */
  #define B43_NPHY_C1_TXCTL			B43_PHY_N(0x08B) /* Core 1 TX control */
  #define B43_NPHY_C2_TXCTL			B43_PHY_N(0x08C) /* Core 2 TX control */
+#define B43_NPHY_AFECTL_OVER1			B43_PHY_N(0x08F) /* AFE control override 1 */
  #define B43_NPHY_SCRAM_SIGCTL			B43_PHY_N(0x090) /* Scram signal control */
  #define  B43_NPHY_SCRAM_SIGCTL_INITST		0x007F /* Initial state value */
  #define  B43_NPHY_SCRAM_SIGCTL_INITST_SHIFT	0
@@ -705,6 +706,10 @@
  #define B43_NPHY_TXPCTL_INIT			B43_PHY_N(0x222) /* TX power controll init */
  #define  B43_NPHY_TXPCTL_INIT_PIDXI1		0x00FF /* Power index init 1 */
  #define  B43_NPHY_TXPCTL_INIT_PIDXI1_SHIFT	0
+#define B43_NPHY_PAPD_EN0			B43_PHY_N(0x297) /* PAPD Enable0 TBD */
+#define B43_NPHY_EPS_TABLE_ADJ0			B43_PHY_N(0x298) /* EPS Table Adj0 TBD */
+#define B43_NPHY_PAPD_EN1			B43_PHY_N(0x29B) /* PAPD Enable1 TBD */
+#define B43_NPHY_EPS_TABLE_ADJ1			B43_PHY_N(0x29C) /* EPS Table Adj1 TBD */



@@ -920,6 +925,13 @@
  struct b43_wldev;

  struct b43_phy_n {
+	u32 deaf_count;
+	bool crsminpwr_adjusted;
+	bool noisevars_adjusted;
+
+	bool ipa2g_on;
+	bool ipa5g_on;
+
  	//TODO lots of missing stuff
  };

-- 
1.6.4.2


From zajec5 at gmail.com  Mon Jan  4 21:34:07 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 04 Jan 2010 21:34:07 +0100
Subject: [PATCH] b43: N-PHY: update part of init code to current specs
In-Reply-To: <op.u50y2cd29lhzdc@linux-g0th.site>
References: <op.u50y2cd29lhzdc@linux-g0th.site>
Message-ID: <op.u50ze5ax9lhzdc@linux-g0th.site>

Dnia 04-01-2010 o 21:26:27 Rafa? Mi?ecki <zajec5 at gmail.com> napisa?(a):
> This makes part of init code follow updated specs.
>
> Michael said many times he prefers smaller patches posted more frequently. So there this go.
>
> However if you think it's too small, just let me know please.

I inline-posted patch but didn't attach it, sorry. Sending patch this time.

-- 
Rafa?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-b43-N-PHY-update-part-of-init-code-to-current-specs.patch
Type: application/octet-stream
Size: 5801 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100104/fbc7901d/attachment.obj>

From zajec5 at gmail.com  Mon Jan  4 21:36:19 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 21:36:19 +0100
Subject: N-PHY init: current code vs. specs
Message-ID: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>

I try to update
int b43_phy_initn(struct b43_wldev *dev)
to match current specs.

Currently it contains many operations/calls that I can not find in
http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N

First I've just posted patch that removed "//TODO: Spectral
management". I don't see anything about "spectral management" in
specs.

Next there is a lot of code after "b43_nphy_workarounds(dev);" call
that I can not recognize. Let's just take some lines for example:
b43_nphy_reset_cca(dev);
ssb_write32(dev->dev, SSB_TMSLOW, ...);
b43_nphy_force_rf_sequence(...);
b43_phy_read(dev, B43_NPHY_CLASSCTL); /* dummy read */

I don't see connection between that code and specs.

Michael: I guess you're author of this code (phy_n.c came from nphy.c,
not sure how to check log for not-existing file). Could you help me
and explain this, please?

-- 
Rafa?


From Larry.Finger at lwfinger.net  Mon Jan  4 21:55:11 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 04 Jan 2010 14:55:11 -0600
Subject: N-PHY init: current code vs. specs
In-Reply-To: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
Message-ID: <4B4255AF.7070408@lwfinger.net>

On 01/04/2010 02:36 PM, Rafa? Mi?ecki wrote:
> I try to update
> int b43_phy_initn(struct b43_wldev *dev)
> to match current specs.
> 
> Currently it contains many operations/calls that I can not find in
> http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
> 
> First I've just posted patch that removed "//TODO: Spectral
> management". I don't see anything about "spectral management" in
> specs.
> 
> Next there is a lot of code after "b43_nphy_workarounds(dev);" call
> that I can not recognize. Let's just take some lines for example:
> b43_nphy_reset_cca(dev);
> ssb_write32(dev->dev, SSB_TMSLOW, ...);
> b43_nphy_force_rf_sequence(...);
> b43_phy_read(dev, B43_NPHY_CLASSCTL); /* dummy read */
> 
> I don't see connection between that code and specs.
> 
> Michael: I guess you're author of this code (phy_n.c came from nphy.c,
> not sure how to check log for not-existing file). Could you help me
> and explain this, please?

I can answer this question. The original N PHY specs and the code generated from
them were for a driver that is now 2 versions old. The main changes are due to
later revisions of the N PHY, but there also seem to be some refactoring. To
keep it straight, I am evolving the current specs to match the latest driver
that we have available. Whenever you see code like the above that does not match
the specs, you should probably rip it out. If you have any questions, please ask
me if a given spec page is current.

I have been trying to get initn and all the routines that it calls up to date,
but this RE process is so mind-numbing that I can only work on it for so long.

Larry


From zajec5 at gmail.com  Mon Jan  4 22:03:13 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 22:03:13 +0100
Subject: N-PHY init: current code vs. specs
In-Reply-To: <4B4255AF.7070408@lwfinger.net>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
	<4B4255AF.7070408@lwfinger.net>
Message-ID: <b170af451001041303g5fd194e6je4822a8d2c88e0e3@mail.gmail.com>

W dniu 4 stycznia 2010 21:55 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/04/2010 02:36 PM, Rafa? Mi?ecki wrote:
>> I try to update
>> int b43_phy_initn(struct b43_wldev *dev)
>> to match current specs.
>>
>> Currently it contains many operations/calls that I can not find in
>> http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
>>
>> First I've just posted patch that removed "//TODO: Spectral
>> management". I don't see anything about "spectral management" in
>> specs.
>>
>> Next there is a lot of code after "b43_nphy_workarounds(dev);" call
>> that I can not recognize. Let's just take some lines for example:
>> b43_nphy_reset_cca(dev);
>> ssb_write32(dev->dev, SSB_TMSLOW, ...);
>> b43_nphy_force_rf_sequence(...);
>> b43_phy_read(dev, B43_NPHY_CLASSCTL); /* dummy read */
>>
>> I don't see connection between that code and specs.
>>
>> Michael: I guess you're author of this code (phy_n.c came from nphy.c,
>> not sure how to check log for not-existing file). Could you help me
>> and explain this, please?
>
> I can answer this question. The original N PHY specs and the code generated from
> them were for a driver that is now 2 versions old. The main changes are due to
> later revisions of the N PHY, but there also seem to be some refactoring. To
> keep it straight, I am evolving the current specs to match the latest driver
> that we have available. Whenever you see code like the above that does not match
> the specs, you should probably rip it out. If you have any questions, please ask
> me if a given spec page is current.
>
> I have been trying to get initn and all the routines that it calls up to date,
> but this RE process is so mind-numbing that I can only work on it for so long.

I'm afraid it starts to sound boring... but thanks... again ;)

-- 
Rafa?


From zajec5 at gmail.com  Mon Jan  4 22:23:38 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 22:23:38 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
Message-ID: <b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>

2010/1/3 Daniel Kuehn <enhaisa at gmail.com>:
> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43 or
> broadcom-sta support it, I just get invalid parameters or the interface
> disappears.
>
> Is there anyway I could help you guys with getting this wlan card to work? I
> could test experimental drivers or try to bash it to work or such, it would
> just be awesome if I could get it to work.
>
> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N card as
> I have understod it, but there exist no info that either confirm or discard
> the PCI ID as a WLAN card. I havent been able to get any info of which card
> this is supposed to be from broadcoms sortiment, I cannot find any of the
> cards listen on broadcoms homepage to match with this card.

Could you check what chipset is it? I think you should see something like:
b43-phy0: Broadcom 43** WLAN found
where 43** is number I ask for.

G?bor: do you have still access to this 14e4:4353 device? If Daniel
won't able to check chipset, could you do this? I don't think that
BCM43224 you noted is correct. Could you double check that?

I just would like to fill table on
http://wireless.kernel.org/en/users/Drivers/b43 with this device.

-- 
Rafa?


From oncaphillis at snafu.de  Mon Jan  4 22:51:40 2010
From: oncaphillis at snafu.de (Oncaphillis)
Date: Mon, 04 Jan 2010 22:51:40 +0100
Subject: b43 kills my kernel
In-Reply-To: <200911191230.48913.mb@bu3sch.de>
References: <4AFD7C49.3000408@snafu.de> <200911191209.49872.mb@bu3sch.de>
	<4B05291E.9010800@snafu.de> <200911191230.48913.mb@bu3sch.de>
Message-ID: <4B4262EC.5060007@snafu.de>

On 11/19/2009 12:30 PM, Michael Buesch wrote:
> On Thursday 19 November 2009 12:16:46 Oncaphillis wrote:
>> On 11/19/2009 12:09 PM, Michael Buesch wrote:
>>> On Thursday 19 November 2009 12:07:30 Oncaphillis wrote:
>>>
>>>> So I'm at a loss here, but if someone comes up with a bright
>>>> idea to test or needs more informations I'm willing to test
>>>> the resulting code on my machine.
>>>>
>>> Erm, no. Can you please answer the questions that you didn't answer, yet?
>>> Especially the request for the original vendor driver.
>>>
>>>
>> oh sorry. I did that, but the mail only went to larry -- stupid me -- the
>> device didn't come with a CD/DVD and I killed Windows XP right away.
>
> Ok, very nice. -.-
>
> There are two major problems with not having an sprom:
>
> - We don't have the calibration data for the radio amplifiers.
>    That could possibly be solved by providing a sane default set of data
>    for a device type.
> - We don't have a MAC address for the card. This one is _very_ hard to
>    solve properly. Several solutions come to mind, which are not
>    really clean solutions:
>    1) We generate a random MAC. This would change on every reboot and break udev.
>       The problem with this is obvious.
>    2) We generate the MAC by hashing some device-specific PCI config space values.
>       I don't know if there are any device specific serial numbers or something
>       similiar in PCI config space (or somewhere else).
>       So the problem with this is that I don't know _what_ to hash.
>    3) We use the firmware loader to get an sprom image and have a userspace script
>       take care of the generation of the image.
>       The problem is the major inconvenience.
>

Hi,

Did any of the patches for a device without a sprom make it
into the 2.6.33-rc2 ?

Thank you.

O.


From zajec5 at gmail.com  Mon Jan  4 23:34:19 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 23:34:19 +0100
Subject: N-PHY init: current code vs. specs
In-Reply-To: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
Message-ID: <b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>

W dniu 4 stycznia 2010 21:36 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> Next there is a lot of code after "b43_nphy_workarounds(dev);" call
> that I can not recognize. Let's just take some lines for example:
> b43_nphy_reset_cca(dev);

Actually specs still tell about resetting CCA, but that is done (in
specs) without call to separated function (just part of init code):
29. Read PHY Register 0x01 and save in val
30. Write val | 0x4000 to PHY Register 0x1
31. Write val & 0xBFFF to PHY Register 0x1

Should I strictly follow specs (put CCA reset directly in init code)
or should I keep b43_nphy_reset_cca function and just modify if to
match current specs?

-- 
Rafa?


From Larry.Finger at lwfinger.net  Mon Jan  4 23:43:04 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 04 Jan 2010 16:43:04 -0600
Subject: N-PHY init: current code vs. specs
In-Reply-To: <b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
	<b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
Message-ID: <4B426EF8.4070603@lwfinger.net>

On 01/04/2010 04:34 PM, Rafa? Mi?ecki wrote:
> W dniu 4 stycznia 2010 21:36 u?ytkownik Rafa? Mi?ecki
> <zajec5 at gmail.com> napisa?:
>> Next there is a lot of code after "b43_nphy_workarounds(dev);" call
>> that I can not recognize. Let's just take some lines for example:
>> b43_nphy_reset_cca(dev);
> 
> Actually specs still tell about resetting CCA, but that is done (in
> specs) without call to separated function (just part of init code):
> 29. Read PHY Register 0x01 and save in val
> 30. Write val | 0x4000 to PHY Register 0x1
> 31. Write val & 0xBFFF to PHY Register 0x1
> 
> Should I strictly follow specs (put CCA reset directly in init code)
> or should I keep b43_nphy_reset_cca function and just modify if to
> match current specs?

As long as all the register read/writes are the same, it doesn't really matter.
You get to do what you want. If you deviate from the specs, just throw in a
comment so that someone else knows what you did and why if looks different.

Larry


From netrolller.3d at gmail.com  Mon Jan  4 23:45:29 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Mon, 4 Jan 2010 23:45:29 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com> 
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
Message-ID: <69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>

2010/1/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
> 2010/1/3 Daniel Kuehn <enhaisa at gmail.com>:
>> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
>> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43 or
>> broadcom-sta support it, I just get invalid parameters or the interface
>> disappears.
>>
>> Is there anyway I could help you guys with getting this wlan card to work? I
>> could test experimental drivers or try to bash it to work or such, it would
>> just be awesome if I could get it to work.
>>
>> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N card as
>> I have understod it, but there exist no info that either confirm or discard
>> the PCI ID as a WLAN card. I havent been able to get any info of which card
>> this is supposed to be from broadcoms sortiment, I cannot find any of the
>> cards listen on broadcoms homepage to match with this card.
>
> Could you check what chipset is it? I think you should see something like:
> b43-phy0: Broadcom 43** WLAN found
> where 43** is number I ask for.
>
> G?bor: do you have still access to this 14e4:4353 device? If Daniel
> won't able to check chipset, could you do this? I don't think that
> BCM43224 you noted is correct. Could you double check that?
>
> I just would like to fill table on
> http://wireless.kernel.org/en/users/Drivers/b43 with this device.
>

The wireless card in the late-2009 MacBook is a BCM943224PCIEBT (as
stated on the exterior shell of the actual MacBook), which is a custom
(but Broadcom-made) BCM43224 (basically a dual-band BCM4322 plus a
BCM2070 for Bluetooth). A picture of the card can be seen at
http://images.weiphone.com/attachments/Day_091021/68_294416_286a2478633560a.jpg
- note that this is an official Apple replacement part, and may look
slightly different from a generic Broadcom version. Pictures of the
Broadcom reference version will be available on FCC's site after
February 20, when the temporary confidentality grant expires.

The description for BCM943224HMB (the same card in a different form
factor) can be viewed at
http://www.broadcom.com/products/Wireless-LAN/802.11-Wireless-LAN-Solutions/BCM943224HMB
(note Broadcom's odd usage of the word "SoC", which is used in the
sense "single-chip transceiver" - the 43224 is not a SOC in the true
sense of the word).

I do not currently have either type of BCM43224 at hand, but the
information found on the web looks convincing.

> --
> Rafa?
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Mon Jan  4 23:49:51 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 23:49:51 +0100
Subject: N-PHY init: current code vs. specs
In-Reply-To: <4B426EF8.4070603@lwfinger.net>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
	<b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
	<4B426EF8.4070603@lwfinger.net>
Message-ID: <b170af451001041449r36b38851xbadc3519bf492e63@mail.gmail.com>

W dniu 4 stycznia 2010 23:43 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/04/2010 04:34 PM, Rafa? Mi?ecki wrote:
>> W dniu 4 stycznia 2010 21:36 u?ytkownik Rafa? Mi?ecki
>> <zajec5 at gmail.com> napisa?:
>>> Next there is a lot of code after "b43_nphy_workarounds(dev);" call
>>> that I can not recognize. Let's just take some lines for example:
>>> b43_nphy_reset_cca(dev);
>>
>> Actually specs still tell about resetting CCA, but that is done (in
>> specs) without call to separated function (just part of init code):
>> 29. Read PHY Register 0x01 and save in val
>> 30. Write val | 0x4000 to PHY Register 0x1
>> 31. Write val & 0xBFFF to PHY Register 0x1
>>
>> Should I strictly follow specs (put CCA reset directly in init code)
>> or should I keep b43_nphy_reset_cca function and just modify if to
>> match current specs?
>
> As long as all the register read/writes are the same, it doesn't really matter.
> You get to do what you want. If you deviate from the specs, just throw in a
> comment so that someone else knows what you did and why if looks different.

OK :) I'm new in low level programming so I wanted to ask first.
Connecting that with implementation of RE specs makes me even more
careful :)

-- 
Rafa?


From zajec5 at gmail.com  Mon Jan  4 23:53:21 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 4 Jan 2010 23:53:21 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
Message-ID: <b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>

W dniu 4 stycznia 2010 23:45 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/1/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> 2010/1/3 Daniel Kuehn <enhaisa at gmail.com>:
>>> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
>>> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43 or
>>> broadcom-sta support it, I just get invalid parameters or the interface
>>> disappears.
>>>
>>> Is there anyway I could help you guys with getting this wlan card to work? I
>>> could test experimental drivers or try to bash it to work or such, it would
>>> just be awesome if I could get it to work.
>>>
>>> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N card as
>>> I have understod it, but there exist no info that either confirm or discard
>>> the PCI ID as a WLAN card. I havent been able to get any info of which card
>>> this is supposed to be from broadcoms sortiment, I cannot find any of the
>>> cards listen on broadcoms homepage to match with this card.
>>
>> Could you check what chipset is it? I think you should see something like:
>> b43-phy0: Broadcom 43** WLAN found
>> where 43** is number I ask for.
>>
>> G?bor: do you have still access to this 14e4:4353 device? If Daniel
>> won't able to check chipset, could you do this? I don't think that
>> BCM43224 you noted is correct. Could you double check that?
>>
>> I just would like to fill table on
>> http://wireless.kernel.org/en/users/Drivers/b43 with this device.
>>
>
> The wireless card in the late-2009 MacBook is a BCM943224PCIEBT (as
> stated on the exterior shell of the actual MacBook), which is a custom
> (but Broadcom-made) BCM43224 (basically a dual-band BCM4322 plus a
> BCM2070 for Bluetooth). A picture of the card can be seen at
> http://images.weiphone.com/attachments/Day_091021/68_294416_286a2478633560a.jpg
> - note that this is an official Apple replacement part, and may look
> slightly different from a generic Broadcom version. Pictures of the
> Broadcom reference version will be available on FCC's site after
> February 20, when the temporary confidentality grant expires.
>
> The description for BCM943224HMB (the same card in a different form
> factor) can be viewed at
> http://www.broadcom.com/products/Wireless-LAN/802.11-Wireless-LAN-Solutions/BCM943224HMB
> (note Broadcom's odd usage of the word "SoC", which is used in the
> sense "single-chip transceiver" - the 43224 is not a SOC in the true
> sense of the word).
>
> I do not currently have either type of BCM43224 at hand, but the
> information found on the web looks convincing.

Uh, so they really used 43[0-9]{3} instead of 43[0-9]{2}. Didn't
expect that, that's why I asked for double check. Thanks for
explaining.

-- 
Rafa?


From zajec5 at gmail.com  Tue Jan  5 12:58:55 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 5 Jan 2010 12:58:55 +0100
Subject: Fwd: The newest Macbook 13.3" wireless
In-Reply-To: <4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
Message-ID: <b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>

Daniel: please post to ML and do not top post.

---------- Wiadomo?? przekazana dalej ----------
Od: Daniel Kuehn <enhaisa at gmail.com>
Data: 5 stycznia 2010 12:46
Temat: Re: The newest Macbook 13.3" wireless
Do: Rafa? Mi?ecki <zajec5 at gmail.com>


@Rafal
Well, I could try and check what chip it gets detected as with b43,
but I do not even get a interface when using b43 drivers. With the
broadcom-sta drivers I get the eth1 interface but any calls to it like
'iwlist eth1 scanning' or 'ifconfig eth1 essid whatever' returns an
ioctl error saying invalid parameter.

I could not get the compat-wireless package to compile either due to a
ralink driver throwing errors (And I could not choose the b43 driver
with the driver-select script :S) so the only b43 drivers I have
access to are the ones in .31-r6 and .32-r1 kernels, and neither one
of them even gives me an interface to work with.

Mvh
Daniel Kuehn









2010/1/4 Rafa? Mi?ecki <zajec5 at gmail.com>
>
> W dniu 4 stycznia 2010 23:45 u?ytkownik G?bor Stefanik
> <netrolller.3d at gmail.com> napisa?:
> > 2010/1/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
> >> 2010/1/3 Daniel Kuehn <enhaisa at gmail.com>:
> >>> I am the (un)lucky owner of a Macbook of late 2009 model, which has a
> >>> Broadcom combo card (BT + WLAN sharing 3 antennas) but neither the b43 or
> >>> broadcom-sta support it, I just get invalid parameters or the interface
> >>> disappears.
> >>>
> >>> Is there anyway I could help you guys with getting this wlan card to work? I
> >>> could test experimental drivers or try to bash it to work or such, it would
> >>> just be awesome if I could get it to work.
> >>>
> >>> The chip PCI ID is 14e4:4353 if that helps you any, its a wireless N card as
> >>> I have understod it, but there exist no info that either confirm or discard
> >>> the PCI ID as a WLAN card. I havent been able to get any info of which card
> >>> this is supposed to be from broadcoms sortiment, I cannot find any of the
> >>> cards listen on broadcoms homepage to match with this card.
> >>
> >> Could you check what chipset is it? I think you should see something like:
> >> b43-phy0: Broadcom 43** WLAN found
> >> where 43** is number I ask for.
> >>
> >> G?bor: do you have still access to this 14e4:4353 device? If Daniel
> >> won't able to check chipset, could you do this? I don't think that
> >> BCM43224 you noted is correct. Could you double check that?
> >>
> >> I just would like to fill table on
> >> http://wireless.kernel.org/en/users/Drivers/b43 with this device.
> >>
> >
> > The wireless card in the late-2009 MacBook is a BCM943224PCIEBT (as
> > stated on the exterior shell of the actual MacBook), which is a custom
> > (but Broadcom-made) BCM43224 (basically a dual-band BCM4322 plus a
> > BCM2070 for Bluetooth). A picture of the card can be seen at
> > http://images.weiphone.com/attachments/Day_091021/68_294416_286a2478633560a.jpg
> > - note that this is an official Apple replacement part, and may look
> > slightly different from a generic Broadcom version. Pictures of the
> > Broadcom reference version will be available on FCC's site after
> > February 20, when the temporary confidentality grant expires.
> >
> > The description for BCM943224HMB (the same card in a different form
> > factor) can be viewed at
> > http://www.broadcom.com/products/Wireless-LAN/802.11-Wireless-LAN-Solutions/BCM943224HMB
> > (note Broadcom's odd usage of the word "SoC", which is used in the
> > sense "single-chip transceiver" - the 43224 is not a SOC in the true
> > sense of the word).
> >
> > I do not currently have either type of BCM43224 at hand, but the
> > information found on the web looks convincing.
>
> Uh, so they really used 43[0-9]{3} instead of 43[0-9]{2}. Didn't
> expect that, that's why I asked for double check. Thanks for
> explaining.
>
> --
> Rafa?


From zajec5 at gmail.com  Tue Jan  5 13:02:32 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 5 Jan 2010 13:02:32 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
Message-ID: <b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>

W dniu 5 stycznia 2010 12:58 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> Daniel: please post to ML and do not top post.
>
> ---------- Wiadomo?? przekazana dalej ----------
> Od: Daniel Kuehn <enhaisa at gmail.com>
> Data: 5 stycznia 2010 12:46
> Temat: Re: The newest Macbook 13.3" wireless
> Do: Rafa? Mi?ecki <zajec5 at gmail.com>
>
>
> @Rafal
> Well, I could try and check what chip it gets detected as with b43,
> but I do not even get a interface when using b43 drivers. With the
> broadcom-sta drivers I get the eth1 interface but any calls to it like
> 'iwlist eth1 scanning' or 'ifconfig eth1 essid whatever' returns an
> ioctl error saying invalid parameter.

G?bor already provided nice info, so that's no longer needed, but thanks :)

Don't know about broadcom-sta.


> I could not get the compat-wireless package to compile either due to a
> ralink driver throwing errors (And I could not choose the b43 driver
> with the driver-select script :S) so the only b43 drivers I have
> access to are the ones in .31-r6 and .32-r1 kernels, and neither one
> of them even gives me an interface to work with.

As this is N-PHY, there is no support for it in b43. I started writing
some code but don't except anything in months.


-- 
Rafa?


From enhaisa at gmail.com  Tue Jan  5 13:12:55 2010
From: enhaisa at gmail.com (Daniel Kuehn)
Date: Tue, 5 Jan 2010 13:12:55 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
	<b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
Message-ID: <4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>

I am sorry, I am very new to this system with mailing lists, could you
explain what a top post is (maybe in a private mail so we dont clutter the
ML)

Okay, well then I know that work has been started, that is good. I assumed
that this card was kinda brand spanking new and knew that I would have to
wait some time before it would be supported in b43, there is no worry I can
wait.
Just give me a howler if you need a tester to test something ;)

Mvh
Daniel Kuehn



2010/1/5 Rafa? Mi?ecki <zajec5 at gmail.com>

> W dniu 5 stycznia 2010 12:58 u?ytkownik Rafa? Mi?ecki
> <zajec5 at gmail.com> napisa?:
> > Daniel: please post to ML and do not top post.
> >
> > ---------- Wiadomo?? przekazana dalej ----------
> > Od: Daniel Kuehn <enhaisa at gmail.com>
> > Data: 5 stycznia 2010 12:46
> > Temat: Re: The newest Macbook 13.3" wireless
> > Do: Rafa? Mi?ecki <zajec5 at gmail.com>
> >
> >
> > @Rafal
> > Well, I could try and check what chip it gets detected as with b43,
> > but I do not even get a interface when using b43 drivers. With the
> > broadcom-sta drivers I get the eth1 interface but any calls to it like
> > 'iwlist eth1 scanning' or 'ifconfig eth1 essid whatever' returns an
> > ioctl error saying invalid parameter.
>
> G?bor already provided nice info, so that's no longer needed, but thanks :)
>
> Don't know about broadcom-sta.
>
>
> > I could not get the compat-wireless package to compile either due to a
> > ralink driver throwing errors (And I could not choose the b43 driver
> > with the driver-select script :S) so the only b43 drivers I have
> > access to are the ones in .31-r6 and .32-r1 kernels, and neither one
> > of them even gives me an interface to work with.
>
> As this is N-PHY, there is no support for it in b43. I started writing
> some code but don't except anything in months.
>
>
> --
> Rafa?
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100105/bc20f5af/attachment.html>

From zajec5 at gmail.com  Tue Jan  5 13:25:45 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 5 Jan 2010 13:25:45 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
	<b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
	<4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>
Message-ID: <b170af451001050425w5835e722gab98fee7ea7b123d@mail.gmail.com>

2010/1/5 Daniel Kuehn <enhaisa at gmail.com>:
> I am sorry, I am very new to this system with mailing lists, could you
> explain what a top post is (maybe in a private mail so we dont clutter the
> ML)
>
> Okay, well then I know that work has been started, that is good. I assumed
> that this card was kinda brand spanking new and knew that I would have to
> wait some time before it would be supported in b43, there is no worry I can
> wait.
> Just give me a howler if you need a tester to test something ;)

You already replied to ML (not me privately), that's fine :)

Now just this:

A: Because it messes up the order in which people normally read text.
Q: Why is top-posting such a bad thing?
A: Top-posting.
Q: What is the most annoying thing in e-mail?

Just reply under (below) quoted text (as I did in this mail).

If you want some more info, check
http://en.wikipedia.org/wiki/Posting_style#Bottom-posting
but what I wrote generally explains all :)

-- 
Rafa?


From enhaisa at gmail.com  Tue Jan  5 13:28:33 2010
From: enhaisa at gmail.com (Daniel Kuehn)
Date: Tue, 5 Jan 2010 13:28:33 +0100
Subject: The newest Macbook 13.3" wireless
In-Reply-To: <b170af451001050425w5835e722gab98fee7ea7b123d@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
	<b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
	<4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>
	<b170af451001050425w5835e722gab98fee7ea7b123d@mail.gmail.com>
Message-ID: <4247d9861001050428t72b96b2fwb4f2bc16297746b5@mail.gmail.com>

2010/1/5 Rafa? Mi?ecki <zajec5 at gmail.com>

> 2010/1/5 Daniel Kuehn <enhaisa at gmail.com>:
> > I am sorry, I am very new to this system with mailing lists, could you
> > explain what a top post is (maybe in a private mail so we dont clutter
> the
> > ML)
> >
> > Okay, well then I know that work has been started, that is good. I
> assumed
> > that this card was kinda brand spanking new and knew that I would have to
> > wait some time before it would be supported in b43, there is no worry I
> can
> > wait.
> > Just give me a howler if you need a tester to test something ;)
>
> You already replied to ML (not me privately), that's fine :)
>
> Now just this:
>
> A: Because it messes up the order in which people normally read text.
> Q: Why is top-posting such a bad thing?
> A: Top-posting.
> Q: What is the most annoying thing in e-mail?
>
> Just reply under (below) quoted text (as I did in this mail).
>
> If you want some more info, check
> http://en.wikipedia.org/wiki/Posting_style#Bottom-posting
> but what I wrote generally explains all :)
>
> --
> Rafa?
>

I see, I am used to the opposite way in a normal email conversation on gmail
:P Will have to re think when posting to MLs then ^^

Mvh
Daniel Kuehn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100105/d933457c/attachment.html>

From mb at bu3sch.de  Tue Jan  5 18:18:08 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 5 Jan 2010 18:18:08 +0100
Subject: b43 kills my kernel
In-Reply-To: <4B4262EC.5060007@snafu.de>
References: <4AFD7C49.3000408@snafu.de> <200911191230.48913.mb@bu3sch.de>
	<4B4262EC.5060007@snafu.de>
Message-ID: <201001051818.10867.mb@bu3sch.de>

On Monday 04 January 2010 22:51:40 Oncaphillis wrote:
> Did any of the patches for a device without a sprom make it
> into the 2.6.33-rc2 ?

No we decided that the patches were not acceptable and need a rewrite towards
firmware loading mechanism.
Nobody's currently doing that, though.

-- 
Greetings, Michael.


From mb at bu3sch.de  Tue Jan  5 18:21:44 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 5 Jan 2010 18:21:44 +0100
Subject: N-PHY init: current code vs. specs
In-Reply-To: <b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>
	<b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
Message-ID: <201001051821.46852.mb@bu3sch.de>

On Monday 04 January 2010 23:34:19 Rafa? Mi?ecki wrote:
> W dniu 4 stycznia 2010 21:36 u?ytkownik Rafa? Mi?ecki
> <zajec5 at gmail.com> napisa?:
> > Next there is a lot of code after "b43_nphy_workarounds(dev);" call
> > that I can not recognize. Let's just take some lines for example:
> > b43_nphy_reset_cca(dev);
> 
> Actually specs still tell about resetting CCA, but that is done (in
> specs) without call to separated function (just part of init code):
> 29. Read PHY Register 0x01 and save in val
> 30. Write val | 0x4000 to PHY Register 0x1
> 31. Write val & 0xBFFF to PHY Register 0x1
> 
> Should I strictly follow specs (put CCA reset directly in init code)
> or should I keep b43_nphy_reset_cca function and just modify if to
> match current specs?
> 

Well, just do the thing that makes most sense.
In general we all agree that we should _not_ implement crap, just because
broadcom does so, if we can do better. So, in this case, if we can do a
subfunction call and that function does make sense, we should do so for the
sake of readability (I didn't look into detail, though.).
Same goes for algorithms and stuff. If we realize that we can do better, do _not_
implement Broadcrap and instead implement a better version.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Tue Jan  5 20:27:00 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 05 Jan 2010 13:27:00 -0600
Subject: b43 kills my kernel
In-Reply-To: <201001051818.10867.mb@bu3sch.de>
References: <4AFD7C49.3000408@snafu.de>
	<200911191230.48913.mb@bu3sch.de>	<4B4262EC.5060007@snafu.de>
	<201001051818.10867.mb@bu3sch.de>
Message-ID: <4B439284.1060504@lwfinger.net>

On 01/05/2010 11:18 AM, Michael Buesch wrote:
> On Monday 04 January 2010 22:51:40 Oncaphillis wrote:
>> Did any of the patches for a device without a sprom make it
>> into the 2.6.33-rc2 ?
> 
> No we decided that the patches were not acceptable and need a rewrite towards
> firmware loading mechanism.
> Nobody's currently doing that, though.

Since the previous round of tests, the reverse-engineering group has been
working on a new release of the Broadcom driver. So far, I have not looked into
how it handles firmware when there is no SPROM, but that task is on my list of
things to do.

Larry


From Larry.Finger at lwfinger.net  Tue Jan  5 20:37:20 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 05 Jan 2010 13:37:20 -0600
Subject: N-PHY init: current code vs. specs
In-Reply-To: <201001051821.46852.mb@bu3sch.de>
References: <b170af451001041236t13bcc581vb842ac436ea66826@mail.gmail.com>	<b170af451001041434y6fc3fe93p256aebb0bb97f05b@mail.gmail.com>
	<201001051821.46852.mb@bu3sch.de>
Message-ID: <4B4394F0.60105@lwfinger.net>

On 01/05/2010 11:21 AM, Michael Buesch wrote:
> 
> Well, just do the thing that makes most sense.
> In general we all agree that we should _not_ implement crap, just because
> broadcom does so, if we can do better. So, in this case, if we can do a
> subfunction call and that function does make sense, we should do so for the
> sake of readability (I didn't look into detail, though.).
> Same goes for algorithms and stuff. If we realize that we can do better, do _not_
> implement Broadcrap and instead implement a better version.

I agree with Michael that we do not need to follow Broadcrap (nice phrase);
however, as we usually have no idea of what is going on inside the chip, we do
need to read/write exactly the same registers as they do without skipping any or
touching any others.

For the record, the specs will usually follow the Broadcrap way. I did come upon
one exception recently. After quite a bit of decision making that did not touch
any registers nor change any global variables, they suddenly tested for 2.4 GHz
mode and exited if found. I moved that test to the beginning of the routine.

Larry





From zajec5 at gmail.com  Tue Jan  5 20:38:10 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 5 Jan 2010 20:38:10 +0100
Subject: [PATCH] b43: N-PHY: update part of init code to current specs
In-Reply-To: <87iqbgvigc.fsf@purkki.valot.fi>
References: <op.u50y2cd29lhzdc@linux-g0th.site>
	<87iqbgvigc.fsf@purkki.valot.fi>
Message-ID: <b170af451001051138q1e837557r4f7b1ea36d9600b2@mail.gmail.com>

W dniu 5 stycznia 2010 13:34 u?ytkownik Kalle Valo <kalle.valo at iki.fi> napisa?:
> Rafa? Mi?ecki <zajec5 at gmail.com> writes:
>
>> Michael said many times he prefers smaller patches posted more
>> frequently. So there this go.
>>
>> However if you think it's too small, just let me know please.
>
> I always post very small patches and I have never been flamed about
> that. And reviewing is so much easier with small logical patches. So
> don't worry about your patches being too small.

Thanks for opinion, I'll keep posting that way :)

-- 
Rafa?


From zajec5 at gmail.com  Tue Jan  5 20:58:33 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 05 Jan 2010 20:58:33 +0100
Subject: [PATCH 1/2] b43: N-PHY: update TODOs in init part
Message-ID: <op.u52sfuw79lhzdc@linux-g0th.site>

Replace TODOs based on old specs with more current ones.



 From 328cf91018178723574031585b447bb849ccddba Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Tue, 5 Jan 2010 20:35:48 +0100
Subject: [PATCH 1/2] b43: N-PHY: update TODOs in init part
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |   71 ++++++++++++++++++++++++-------------
  drivers/net/wireless/b43/phy_n.h |   12 ++++++
  2 files changed, 58 insertions(+), 25 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 015da44..6479d6e 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -425,8 +425,10 @@ int b43_phy_initn(struct b43_wldev *dev)
  	struct ssb_bus *bus = dev->dev->bus;
  	struct b43_phy *phy = &dev->phy;
  	struct b43_phy_n *nphy = phy->n;
+	u8 tx_pwr_state;
  	u16 tmp;
  	enum ieee80211_band tmp2;
+	bool do_rssi_cal;

  	u16 clip[2];
  	bool do_cal = false;
@@ -503,35 +505,54 @@ int b43_phy_initn(struct b43_wldev *dev)
  	}

  	b43_nphy_workarounds(dev);
-	b43_nphy_reset_cca(dev);

-	ssb_write32(dev->dev, SSB_TMSLOW,
-		    ssb_read32(dev->dev, SSB_TMSLOW) | B43_TMSLOW_MACPHYCLKEN);
+	//TODO N PHY BMAC Clock FGC with argument 1
+	b43_nphy_reset_cca(dev);
+	//TODO N PHY BMAC Clock FGC with argument 0
+	//TODO N PHY MAC PHY Clock Set with argument 1
+	//TODO Disable PA Override
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
+	//TODO Turn on PA override
+	//TODO N PHY Classifier with arguments 0 and 0
+	//TODO N PHY Det Clip with 0 and the clip array as arguments
+	tx_pwr_state = nphy->txpwrctrl;
+	//TODO N PHY TX power control with argument 0 (turning off power control)
+	//TODO Fix the TX Power Settings
+	//TODO N PHY TX Power Control Idle TSSI
+	//TODO N PHY TX Power Control Setup
+
+	if (phy->rev >= 3) {
+		//TODO
+	} else {
+		//TODO Write an N PHY table with ID 26, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table
+		//TODO Write an N PHY table with ID 27, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table
+	}
+
+	if (nphy->phyrxchain != 3)
+		//TODO N PHY RX Core Set State with phyrxchain as argument
+	if (nphy->mphase_cal_phase_id > 0)
+		//TODO PHY Periodic Calibration Multi-Phase Restart
+
+	do_rssi_cal = false;
+	if (phy->rev >= 3) {
+		//TODO
+	} else {
+		//TODO
+	}
+
+	if (!((nphy->measure_hold & 0x6) != 0)) {
+		//TODO
+	}

-	b43_phy_read(dev, B43_NPHY_CLASSCTL); /* dummy read */
-	//TODO read core1/2 clip1 thres regs
-
-	if (1 /* FIXME Band is 2.4GHz */)
-		b43_nphy_bphy_init(dev);
-	//TODO disable TX power control
-	//TODO Fix the TX power settings
-	//TODO Init periodic calibration with reason 3
-	b43_nphy_rssi_cal(dev, 2);
-	b43_nphy_rssi_cal(dev, 0);
-	b43_nphy_rssi_cal(dev, 1);
-	//TODO get TX gain
-	//TODO init superswitch
-	//TODO calibrate LO
-	//TODO idle TSSI TX pctl
-	//TODO TX power control power setup
-	//TODO table writes
-	//TODO TX power control coefficients
-	//TODO enable TX power control
-	//TODO control antenna selection
-	//TODO init radar detection
-	//TODO reset channel if changed
+	//TODO N PHY TX Power Control Coef Setup
+	//TODO N PHY TX Power Control Enable with argument tx_pwr_state
+	b43_phy_write(dev, B43_NPHY_TXMACIF_HOLDOFF, 0x0015);
+	b43_phy_write(dev, B43_NPHY_TXMACDELAY, 0x0320);
+	if (phy->rev >= 3 && phy->rev <= 6)
+		b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x0014);
+	//TODO N PHY TX LP FBW
+	//TODO N PHY Spur Workaround

  	b43err(dev->wl, "IEEE 802.11n devices are not supported, yet.\n");
  	return 0;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 8f174b7..e5e402a 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -925,7 +925,19 @@
  struct b43_wldev;

  struct b43_phy_n {
+	u8 txpwrctrl;
+	u8 measure_hold;
+	u8 phyrxchain;
+	u8 mphase_cal_phase_id;
  	u32 deaf_count;
+	bool mute;
+
+	u8 iqcal_chanspec_2G;
+	u8 rssical_chanspec_2G;
+
+	u8 iqcal_chanspec_5G;
+	u8 rssical_chanspec_5G;
+
  	bool crsminpwr_adjusted;
  	bool noisevars_adjusted;

-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-b43-N-PHY-update-TODOs-in-init-part.patch
Type: application/octet-stream
Size: 4253 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100105/ad0a6c65/attachment.obj>

From zajec5 at gmail.com  Tue Jan  5 20:59:06 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 05 Jan 2010 20:59:06 +0100
Subject: [PATCH 2/2] b43: N-PHY: update reset_cca operation and add rssi_cal
	calls
Message-ID: <op.u52sgse59lhzdc@linux-g0th.site>

Update b43_nphy_reset_cca to match current specs and add rssi_cal calls to init code.



 From 71c10442cd0b1b277f483a81db7f2e8f579b3d59 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Tue, 5 Jan 2010 20:52:43 +0100
Subject: [PATCH 2/2] b43: N-PHY: update reset_cca operation and add rssi_cal calls
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   49 +++++++++++++++++++++++++++----------
  1 files changed, 36 insertions(+), 13 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6479d6e..ceb429a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -343,16 +343,9 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)

  static void b43_nphy_reset_cca(struct b43_wldev *dev)
  {
-	u16 bbcfg;
-
-	ssb_write32(dev->dev, SSB_TMSLOW,
-		    ssb_read32(dev->dev, SSB_TMSLOW) | SSB_TMSLOW_FGC);
-	bbcfg = b43_phy_read(dev, B43_NPHY_BBCFG);
-	b43_phy_set(dev, B43_NPHY_BBCFG, B43_NPHY_BBCFG_RSTCCA);
-	b43_phy_write(dev, B43_NPHY_BBCFG,
-		      bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
-	ssb_write32(dev->dev, SSB_TMSLOW,
-		    ssb_read32(dev->dev, SSB_TMSLOW) & ~SSB_TMSLOW_FGC);
+	u16 bbcfg = b43_phy_read(dev, B43_NPHY_BBCFG);
+	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg | B43_NPHY_BBCFG_RSTCCA);
+	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
  }

  enum b43_nphy_rf_sequence {
@@ -411,8 +404,30 @@ static void b43_nphy_bphy_init(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_PHY_N_BMODE(0x38), 0x668);
  }

+static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
+{
+	//TODO
+}
+
+static void b43_nphy_rev3_rssi_cal(struct b43_wldev *dev)
+{
+	//TODO
+}
+
  /* RSSI Calibration */
-static void b43_nphy_rssi_cal(struct b43_wldev *dev, u8 type)
+static void b43_nphy_rssi_cal(struct b43_wldev *dev)
+{
+	if (dev->phy.rev >= 3) {
+		b43_nphy_rev3_rssi_cal(dev);
+	} else {
+		b43_nphy_rev2_rssi_cal(dev, 2);
+		b43_nphy_rev2_rssi_cal(dev, 0);
+		b43_nphy_rev2_rssi_cal(dev, 1);
+	}
+}
+
+/* Restore RSSI Calibration */
+static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
  {
  	//TODO
  }
@@ -536,9 +551,17 @@ int b43_phy_initn(struct b43_wldev *dev)

  	do_rssi_cal = false;
  	if (phy->rev >= 3) {
-		//TODO
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
+			do_rssi_cal = (nphy->rssical_chanspec_2G == 0);
+		else
+			do_rssi_cal = (nphy->rssical_chanspec_5G == 0);
+
+		if (do_rssi_cal)
+			b43_nphy_rssi_cal(dev);
+		else
+			b43_nphy_restore_rssi_cal(dev);
  	} else {
-		//TODO
+		b43_nphy_rssi_cal(dev);
  	}

  	if (!((nphy->measure_hold & 0x6) != 0)) {
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0002-b43-N-PHY-update-reset_cca-operation-and-add-rssi_ca.patch
Type: application/octet-stream
Size: 2692 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100105/a4779a6d/attachment.obj>

From oncaphillis at snafu.de  Tue Jan  5 22:01:53 2010
From: oncaphillis at snafu.de (Oncaphillis)
Date: Tue, 05 Jan 2010 22:01:53 +0100
Subject: b43 kills my kernel
In-Reply-To: <4B439284.1060504@lwfinger.net>
References: <4AFD7C49.3000408@snafu.de>
	<200911191230.48913.mb@bu3sch.de>	<4B4262EC.5060007@snafu.de>
	<201001051818.10867.mb@bu3sch.de> <4B439284.1060504@lwfinger.net>
Message-ID: <4B43A8C1.10701@snafu.de>

On 01/05/2010 08:27 PM, Larry Finger wrote:
> On 01/05/2010 11:18 AM, Michael Buesch wrote:
>    
>> On Monday 04 January 2010 22:51:40 Oncaphillis wrote:
>>      
>>> Did any of the patches for a device without a sprom make it
>>> into the 2.6.33-rc2 ?
>>>        
>> No we decided that the patches were not acceptable and need a rewrite towards
>> firmware loading mechanism.
>> Nobody's currently doing that, though.
>>      
> Since the previous round of tests, the reverse-engineering group has been
> working on a new release of the Broadcom driver. So far, I have not looked into
> how it handles firmware when there is no SPROM, but that task is on my list of
> things to do.
>
> Larry
>    
  Great to hear that. Thank you very much. I'll be happy to test it.

  and Happy new year



From netrolller.3d at gmail.com  Wed Jan  6 00:48:57 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 00:48:57 +0100
Subject: b43: must set qos=0 on to connect
In-Reply-To: <4B43C496.4040609@gmail.com>
References: <4B43C496.4040609@gmail.com>
Message-ID: <69e28c911001051548ke40422ao49cb3ad2a141a33a@mail.gmail.com>

On Wed, Jan 6, 2010 at 12:00 AM, John Daiker <daikerjohn at gmail.com> wrote:
> I have a BCM4312 rev 01 (14e4:4315) card in my HP Mini netbook. ?I am having
> troubles connecting to any WEP secured AP.
>
> I know the trick about having to load with pio=1 for the device to stay
> happy (and forget about using DMA), so no issues there, I hope.
>
> With qos=1 (by default, IIRC), I am unable to establish a connection with
> said WEP connection, and notice many 'PHY transmission error' messages in my
> dmesg output.
>
> With qos=1, I can successfully connect to my WEP connection without issue,
> and without any error messages or warnings.
>
> I have a BCM4318 rev 02 (14e4:4318) in a desktop that works with
> enabled/disabled qos not matter what. ?Also, a RT2500-based card works fine
> on the connection as well.
>
> Both card are using the 478.104 firmware.
>
> Please advise what steps I should take to further debug this issue.
>
> Thanks,
> John Daiker
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>

Hi!

Is this the new 4312 (BCM94312HMGB AKA 575920-001), with integrated
Bluetooth? I haven't seen this issue on my machines with a regular
4312, so it is probably related to the DMA error, or maybe it is
specific to the new 4312. If you can, please check whether the actual
model number printed on the card is the new one.

Thanks,
G?bor

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Wed Jan  6 01:34:03 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 01:34:03 +0100
Subject: b43: must set qos=0 on to connect
In-Reply-To: <4B43D513.3030300@gmail.com>
References: <4B43C496.4040609@gmail.com>
	<69e28c911001051548ke40422ao49cb3ad2a141a33a@mail.gmail.com> 
	<4B43D513.3030300@gmail.com>
Message-ID: <69e28c911001051634m464b3c48r941e202ec533920f@mail.gmail.com>

2010/1/6 John Daiker <daikerjohn at gmail.com>:
> On 01/05/2010 03:48 PM, G?bor Stefanik wrote:
>>
>> On Wed, Jan 6, 2010 at 12:00 AM, John Daiker<daikerjohn at gmail.com> ?wrote:
>>>
>>> I have a BCM4312 rev 01 (14e4:4315) card in my HP Mini netbook. ?I am
>>> having
>>> troubles connecting to any WEP secured AP.
>>>
>>> I know the trick about having to load with pio=1 for the device to stay
>>> happy (and forget about using DMA), so no issues there, I hope.
>>>
>>> With qos=1 (by default, IIRC), I am unable to establish a connection with
>>> said WEP connection, and notice many 'PHY transmission error' messages in
>>> my
>>> dmesg output.
>>>
>>> With qos=1, I can successfully connect to my WEP connection without
>>> issue,
>>> and without any error messages or warnings.
>>>
>>> I have a BCM4318 rev 02 (14e4:4318) in a desktop that works with
>>> enabled/disabled qos not matter what. ?Also, a RT2500-based card works
>>> fine
>>> on the connection as well.
>>>
>>> Both card are using the 478.104 firmware.
>>>
>>> Please advise what steps I should take to further debug this issue.
>>>
>>> Thanks,
>>> John Daiker
>>> --
>>> To unsubscribe from this list: send the line "unsubscribe linux-wireless"
>>> in
>>> the body of a message to majordomo at vger.kernel.org
>>> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>>>
>>
>> Hi!
>>
>> Is this the new 4312 (BCM94312HMGB AKA 575920-001), with integrated
>> Bluetooth? I haven't seen this issue on my machines with a regular
>> 4312, so it is probably related to the DMA error, or maybe it is
>> specific to the new 4312. If you can, please check whether the actual
>> model number printed on the card is the new one.
>>
>> Thanks,
>> G?bor
>>
>
> G?bor,
>
> I just pulled the card, and it's not the chip you mention. ?It's a
> "BCM94312HMG" ?(Notice that it doesn't have the "B" at the end. ?I would
> assume that indicates the Bluetooth integration.)
>
> I've taken few photos of the front and back of the card. ?Let me know if you
> want to see them... I can post 'em on my website or flickr for your viewing
> pleasure.
>
> Thanks,
> John Daiker
>

Weird... I also have a 94312HMG, and it doesn't show this error (at
least not in DMA mode).

Maybe this is a PIO-specific issue... I'll try to test that.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From jhhaynes at earthlink.net  Wed Jan  6 04:55:49 2010
From: jhhaynes at earthlink.net (Jim Haynes)
Date: Tue, 5 Jan 2010 21:55:49 -0600 (CST)
Subject: b43 on Dell i1545 laptop
In-Reply-To: <b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>
	<b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
Message-ID: <alpine.LFD.2.00.1001052142380.8390@localhost>

I'm not sure if this is a b43 problem or a Fedora problem.

After the advice given previously, I grabbed a nightly Fedora 13 spin
that has a 2.6.32.2-15.fc13.x86_64 kernel and ran from the live DVD.

going through dmesg it eventually gets to

b43-phy0: Broadcom 4312 WLAN found (core revision 15)
b43-phy0 debug: Found PHY: Analog 6, Type 5, Revision 1
b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2062, Revision 2
cfg80211: World regulatory domains updated
     and then a list of frequencies
...
some Registered led device: messages
...
Broadcom 43xx driver loaded [Features: PMLS, Firmware-ID: FW13]
...
b43 ssb0:0: firmware: requestiong b43/ucode15.fw
b43 ssb0:0: firmware: requesting b43-open/ucode15.fw
b43-phy0 ERROR: Firmware file "b43/ucode15.fw" not found
b43-phy0 ERROR: Firmware file "b43-open/ucode15.fw" not found
b43-phy0 ERROR: You must go to 
http://wireless.kernel.org/en/users/Drivers/b43#d
evicefirmware and download the correct firmware for this driver version. 
Please
carefully read all instructions on this website.


Now what's in /lib/firmware/b43 on the live CD is ucode5.fw

When I get the firmware from the web site I get ucode5.fw, ucode13.fw,
ucode11.fw  but no ucode15.fw    (and other stuff with number 5, and 13)

Now I guess if I did have the firmware it wants, ucode15.fw, I don't know
how to work that in to the live CD - maybe I'd have to install it on the
hard drive, or maybe I have to get the Fedora people to add it to the
build.



jhhaynes at earthlink dot net



From Larry.Finger at lwfinger.net  Wed Jan  6 05:28:16 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 05 Jan 2010 22:28:16 -0600
Subject: b43 on Dell i1545 laptop
In-Reply-To: <alpine.LFD.2.00.1001052142380.8390@localhost>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>	<b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
	<alpine.LFD.2.00.1001052142380.8390@localhost>
Message-ID: <4B441160.50302@lwfinger.net>

On 01/05/2010 09:55 PM, Jim Haynes wrote:
> I'm not sure if this is a b43 problem or a Fedora problem.

It is a problem with Broadcom.

> When I get the firmware from the web site I get ucode5.fw, ucode13.fw,
> ucode11.fw  but no ucode15.fw    (and other stuff with number 5, and 13)

I have revised the wiki. You will not get the xxx15.fw files.

> 
> Now I guess if I did have the firmware it wants, ucode15.fw, I don't know
> how to work that in to the live CD - maybe I'd have to install it on the
> hard drive, or maybe I have to get the Fedora people to add it to the
> build.

The Fedora people do not have the right to distribute Broadcom firmware, which
is why it is not on the live CD. What you need to do is run the procedure from
the wiki and then copy the files in /lib/firmware/b43/ to some removable device.
After you boot the CD, then copy those files to the firmware directory in the
ramfs. Once that is done, unload and reload (with modprobe) the b43 driver. You
will now be able to access the network. If you install from the CD, you will
need to copy those files to the hard drive.

Larry


From zajec5 at gmail.com  Wed Jan  6 16:07:05 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 16:07:05 +0100
Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V3)
In-Reply-To: <op.u5w2vyof9lhzdc@linux-g0th.site>
References: <op.u5w2vyof9lhzdc@linux-g0th.site>
Message-ID: <b170af451001060707j3db4d8b6tec92f9c737ba40df@mail.gmail.com>

W dniu 2 stycznia 2010 18:58 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> Hopefully with Michaels's mysterious suggestion applied :)
>
> From 3d54059593785a820789c5af99ca1373eaf6b2c7 Mon Sep 17 00:00:00 2001
> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
> Date: Sat, 2 Jan 2010 18:50:25 +0100
> Subject: [PATCH] b43: N-PHY: clean table init, check PHY rev (V3)
> MIME-Version: 1.0
> Content-Type: text/plain; charset=UTF-8
> Content-Transfer-Encoding: 8bit
>
> Move table init to tables_nphy.c, detect newer PHY which use different init.
> We don't init newer PHYs yet but this at least shows what more is needed.
>
> V2: Make some functions and tables static
> V3: Just drop static table declarations from header

John, I've sent some N-PHY patches which were *not* generated on top
of this one. So all of them have lines offset issue when applying on
top of this.

Please ignore this patch, apply all the rest of my N-PHY patches. I'll
resend this one in some patchset later (with corrected line offset
hunk).

-- 
Rafa?


From zajec5 at gmail.com  Wed Jan  6 16:40:32 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:40:32 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search and
	it's calls
Message-ID: <op.u54a5ufy9lhzdc@linux-g0th.site>

b43: N-PHY: implement b43_nphy_stay_carrier_search and it's calls


 From ec599007464bb8220c605af500b724797d54aba8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Wed, 6 Jan 2010 15:20:20 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search and it's calls
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   57 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    3 ++
  2 files changed, 60 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index ceb429a..40d7b73 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -348,6 +348,63 @@ static void b43_nphy_reset_cca(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
  }

+static void b43_nphy_write_clip_detection(struct b43_wldev *dev, u16 *vals)
+{
+	b43_phy_write(dev, B43_NPHY_C1_CLIP1THRES, vals[0]);
+	b43_phy_write(dev, B43_NPHY_C2_CLIP1THRES, vals[1]);
+}
+
+static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *vals)
+{
+	vals[0] = b43_phy_read(dev, B43_NPHY_C1_CLIP1THRES);
+	vals[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
+}
+
+static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
+{
+	u16 tmp;
+	bool suspended = false;
+
+	if (dev->dev->id.revision == 16 && dev->mac_suspended == 0) {
+		b43_mac_suspend(dev);
+		suspended = true;
+	}
+
+	tmp = b43_phy_read(dev, B43_NPHY_CLASSCTL);
+	tmp &= (B43_NPHY_CLASSCTL_CCKEN | B43_NPHY_CLASSCTL_OFDMEN |
+		B43_NPHY_CLASSCTL_WAITEDEN);
+	tmp &= ~mask;
+	tmp |= (val & mask);
+	b43_phy_maskset(dev, B43_NPHY_CLASSCTL, 0xFFF8, tmp);
+
+	if (suspended)
+		b43_mac_enable(dev);
+
+	return tmp;
+}
+
+static void b43_nphy_stay_carrier_search(struct b43_wldev *dev, bool enable)
+{
+	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = phy->n;
+
+	if (enable) {
+		u16 clip[] = { 0xFFFF, 0xFFFF };
+		if (nphy->deaf_count++ == 0) {
+			nphy->classifier_state = b43_nphy_classifier(dev, 0, 0);
+			b43_nphy_classifier(dev, 0x7, 0);
+			b43_nphy_read_clip_detection(dev, nphy->clip_state);
+			b43_nphy_write_clip_detection(dev, clip);
+		}
+		b43_nphy_reset_cca(dev);
+	} else {
+		if (--nphy->deaf_count != 0) {
+			b43_nphy_classifier(dev, 0x7, nphy->classifier_state);
+			b43_nphy_write_clip_detection(dev, nphy->clip_state);
+		}
+	}
+}
+
  enum b43_nphy_rf_sequence {
  	B43_RFSEQ_RX2TX,
  	B43_RFSEQ_TX2RX,
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e5e402a..6ab07fc 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -932,6 +932,9 @@ struct b43_phy_n {
  	u32 deaf_count;
  	bool mute;

+	u16 classifier_state;
+	u16 clip_state[2];
+
  	u8 iqcal_chanspec_2G;
  	u8 rssical_chanspec_2G;

-- 
1.6.4.2


From zajec5 at gmail.com  Wed Jan  6 16:40:47 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:40:47 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
Message-ID: <op.u54a59c89lhzdc@linux-g0th.site>

b43: N-PHY: b43_nphy_get_tx_gains


 From 5c96b3de80f7d044c42808e8123ae3f50916d6fc Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Wed, 6 Jan 2010 15:25:14 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   75 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 76 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 40d7b73..249caf0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -30,6 +30,8 @@
  #include "tables_nphy.h"


+struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
+
  void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
  {//TODO
  }
@@ -405,6 +407,79 @@ static void b43_nphy_stay_carrier_search(struct b43_wldev *dev, bool enable)
  	}
  }

+static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 curr_gain[2];
+	struct nphy_txgains target;
+	u32 *table = NULL;
+
+	if (nphy->txpwrctrl == 0) {
+		int i;
+
+		if (nphy->hang_avoid)
+			b43_nphy_stay_carrier_search(dev, true);
+		//TODO: Read an N PHY Table with ID 7, length 2, offset 0x110, width 16, and curr_gain
+		if (nphy->hang_avoid)
+			b43_nphy_stay_carrier_search(dev, false);
+
+		for (i = 0; i < 2; ++i) {
+			if (dev->phy.rev >= 3) {
+				target.ipa[i] = curr_gain[i] & 0x000F;
+				target.pad[i] = (curr_gain[i] & 0x00F0) >> 4;
+				target.pga[i] = (curr_gain[i] & 0x0F00) >> 8;
+				target.txgm[i] = (curr_gain[i] & 0x7000) >> 12;
+			} else {
+				target.ipa[i] = curr_gain[i] & 0x0003;
+				target.pad[i] = (curr_gain[i] & 0x000C) >> 2;
+				target.pga[i] = (curr_gain[i] & 0x0070) >> 4;
+				target.txgm[i] = (curr_gain[i] & 0x0380) >> 7;
+			}
+		}
+	} else {
+		int i;
+		u16 index[2];
+	
+		for (i = 0; i < 2; ++i) {
+			if (dev->phy.rev >= 3) {
+				enum ieee80211_band band =
+					b43_current_band(dev->wl);
+
+				if ((nphy->ipa2g_on && band == IEEE80211_BAND_2GHZ) ||
+				    (nphy->ipa5g_on && band == IEEE80211_BAND_5GHZ)) {
+					table = NULL; //FIXME: = output of N PHY Get IPA GainTbl
+				} else {
+					if (band == IEEE80211_BAND_5GHZ) {
+						if (dev->phy.rev == 3)
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (5 GHz)
+						else if (dev->phy.rev == 4)
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 4 (5 GHz)
+						else
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 5 (5 GHz)
+					} else {
+						table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (2.4 GHz)
+					}
+				}
+
+				target.ipa[i] = (table[index[i]] >> 16) & 0xF;
+				target.pad[i] = (table[index[i]] >> 20) & 0xF;
+				target.pga[i] = (table[index[i]] >> 24) & 0xF;
+				target.txgm[i] = (table[index[i]] >> 28) & 0xF;
+			} else {
+				table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev <= 2
+
+				target.ipa[i] = (table[index[i]] >> 16) & 0x3;
+				target.pad[i] = (table[index[i]] >> 18) & 0x3;
+				target.pga[i] = (table[index[i]] >> 20) & 0x7;
+				target.txgm[i] = (table[index[i]] >> 23) & 0x7;
+			}
+		}
+	}
+
+	return target;
+}
+
  enum b43_nphy_rf_sequence {
  	B43_RFSEQ_RX2TX,
  	B43_RFSEQ_TX2RX,
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 6ab07fc..e63c371 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -930,6 +930,7 @@ struct b43_phy_n {
  	u8 phyrxchain;
  	u8 mphase_cal_phase_id;
  	u32 deaf_count;
+	bool hang_avoid;
  	bool mute;

  	u16 classifier_state;
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0002-b43-N-PHY-b43_nphy_get_tx_gains.patch
Type: application/octet-stream
Size: 3825 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100106/dbc12d57/attachment.obj>

From zajec5 at gmail.com  Wed Jan  6 16:41:32 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:41:32 +0100
Subject: [PATCH 3/5] b43: N-PHY: clean table init, check PHY rev (V3)
Message-ID: <op.u54a7izg9lhzdc@linux-g0th.site>

b43: N-PHY: clean table init, check PHY rev (V3)

This is resend with lines offset hunk "fixed".


 From cb7e670134c28e3bf44d8537d953e2e8d3ec4b30 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Sat, 2 Jan 2010 18:50:25 +0100
Subject: [PATCH 3/5] b43: N-PHY: clean table init, check PHY rev (V3)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Move table init to tables_nphy.c, detect newer PHY which use different init.
We don't init newer PHYs yet but this at least shows what more is needed.

V2: Make some functions and tables static
V3: Just drop static table declarations from header

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   43 ++-----------
  drivers/net/wireless/b43/tables_nphy.c |  100 +++++++++++++++++++++++--------
  drivers/net/wireless/b43/tables_nphy.h |   29 +---------
  3 files changed, 83 insertions(+), 89 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 249caf0..5341ba5 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -199,44 +199,15 @@ void b43_nphy_radio_turn_off(struct b43_wldev *dev)
  		     ~B43_NPHY_RFCTL_CMD_EN);
  }

-#define ntab_upload(dev, offset, data) do { \
-		unsigned int i;						\
-		for (i = 0; i < (offset##_SIZE); i++)			\
-			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
-	} while (0)
-
-/* Upload the N-PHY tables. */
+/* Upload the N-PHY tables.
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
+ */
  static void b43_nphy_tables_init(struct b43_wldev *dev)
  {
-	/* Static tables */
-	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
-	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
-	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
-	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
-	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
-	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
-	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
-	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
-	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
-	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
-	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
-	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
-	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
-	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
-
-	/* Volatile tables */
-	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
-	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
-	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
-	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
-	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
-	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
-	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
-	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
-	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
-	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
-	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
-	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+	if (dev->phy.rev < 3)
+		b43_nphy_rev0_1_2_tables_init(dev);
+	else
+		b43_nphy_rev3plus_tables_init(dev);
  }

  static void b43_nphy_workarounds(struct b43_wldev *dev)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 4e23363..d0b91b5 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -1336,7 +1336,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel)
  }


-const u8 b43_ntab_adjustpower0[] = {
+static const u8 b43_ntab_adjustpower0[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1355,7 +1355,7 @@ const u8 b43_ntab_adjustpower0[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u8 b43_ntab_adjustpower1[] = {
+static const u8 b43_ntab_adjustpower1[] = {
  	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
  	0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
  	0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
@@ -1374,11 +1374,11 @@ const u8 b43_ntab_adjustpower1[] = {
  	0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F,
  };

-const u16 b43_ntab_bdi[] = {
+static const u16 b43_ntab_bdi[] = {
  	0x0070, 0x0126, 0x012C, 0x0246, 0x048D, 0x04D2,
  };

-const u32 b43_ntab_channelest[] = {
+static const u32 b43_ntab_channelest[] = {
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x44444444, 0x44444444, 0x44444444, 0x44444444,
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
@@ -1405,7 +1405,7 @@ const u32 b43_ntab_channelest[] = {
  	0x10101010, 0x10101010, 0x10101010, 0x10101010,
  };

-const u8 b43_ntab_estimatepowerlt0[] = {
+static const u8 b43_ntab_estimatepowerlt0[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1416,7 +1416,7 @@ const u8 b43_ntab_estimatepowerlt0[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_estimatepowerlt1[] = {
+static const u8 b43_ntab_estimatepowerlt1[] = {
  	0x50, 0x4F, 0x4E, 0x4D, 0x4C, 0x4B, 0x4A, 0x49,
  	0x48, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x41,
  	0x40, 0x3F, 0x3E, 0x3D, 0x3C, 0x3B, 0x3A, 0x39,
@@ -1427,14 +1427,14 @@ const u8 b43_ntab_estimatepowerlt1[] = {
  	0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11,
  };

-const u8 b43_ntab_framelookup[] = {
+static const u8 b43_ntab_framelookup[] = {
  	0x02, 0x04, 0x14, 0x14, 0x03, 0x05, 0x16, 0x16,
  	0x0A, 0x0C, 0x1C, 0x1C, 0x0B, 0x0D, 0x1E, 0x1E,
  	0x06, 0x08, 0x18, 0x18, 0x07, 0x09, 0x1A, 0x1A,
  	0x0E, 0x10, 0x20, 0x28, 0x0F, 0x11, 0x22, 0x2A,
  };

-const u32 b43_ntab_framestruct[] = {
+static const u32 b43_ntab_framestruct[] = {
  	0x08004A04, 0x00100000, 0x01000A05, 0x00100020,
  	0x09804506, 0x00100030, 0x09804507, 0x00100030,
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
@@ -1645,7 +1645,7 @@ const u32 b43_ntab_framestruct[] = {
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_gainctl0[] = {
+static const u32 b43_ntab_gainctl0[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1680,7 +1680,7 @@ const u32 b43_ntab_gainctl0[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_gainctl1[] = {
+static const u32 b43_ntab_gainctl1[] = {
  	0x007F003F, 0x007E013F, 0x007D023E, 0x007C033E,
  	0x007B043D, 0x007A053D, 0x0079063C, 0x0078073C,
  	0x0077083B, 0x0076093B, 0x00750A3A, 0x00740B3A,
@@ -1715,12 +1715,12 @@ const u32 b43_ntab_gainctl1[] = {
  	0x00030C01, 0x00020D01, 0x00010E00, 0x00000F00,
  };

-const u32 b43_ntab_intlevel[] = {
+static const u32 b43_ntab_intlevel[] = {
  	0x00802070, 0x0671188D, 0x0A60192C, 0x0A300E46,
  	0x00C1188D, 0x080024D2, 0x00000070,
  };

-const u32 b43_ntab_iqlt0[] = {
+static const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1755,7 +1755,7 @@ const u32 b43_ntab_iqlt0[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u32 b43_ntab_iqlt1[] = {
+static const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
@@ -1790,7 +1790,7 @@ const u32 b43_ntab_iqlt1[] = {
  	0x0000007F, 0x0000007F, 0x0000007F, 0x0000007F,
  };

-const u16 b43_ntab_loftlt0[] = {
+static const u16 b43_ntab_loftlt0[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1815,7 +1815,7 @@ const u16 b43_ntab_loftlt0[] = {
  	0x0002, 0x0103,
  };

-const u16 b43_ntab_loftlt1[] = {
+static const u16 b43_ntab_loftlt1[] = {
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
  	0x0002, 0x0103, 0x0000, 0x0101, 0x0002, 0x0103,
  	0x0000, 0x0101, 0x0002, 0x0103, 0x0000, 0x0101,
@@ -1840,7 +1840,7 @@ const u16 b43_ntab_loftlt1[] = {
  	0x0002, 0x0103,
  };

-const u8 b43_ntab_mcs[] = {
+static const u8 b43_ntab_mcs[] = {
  	0x00, 0x08, 0x0A, 0x10, 0x12, 0x19, 0x1A, 0x1C,
  	0x40, 0x48, 0x4A, 0x50, 0x52, 0x59, 0x5A, 0x5C,
  	0x80, 0x88, 0x8A, 0x90, 0x92, 0x99, 0x9A, 0x9C,
@@ -1859,7 +1859,7 @@ const u8 b43_ntab_mcs[] = {
  	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  };

-const u32 b43_ntab_noisevar10[] = {
+static const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1926,7 +1926,7 @@ const u32 b43_ntab_noisevar10[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u32 b43_ntab_noisevar11[] = {
+static const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
@@ -1993,7 +1993,7 @@ const u32 b43_ntab_noisevar11[] = {
  	0x020C020C, 0x0000014D, 0x020C020C, 0x0000014D,
  };

-const u16 b43_ntab_pilot[] = {
+static const u16 b43_ntab_pilot[] = {
  	0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08, 0xFF08,
  	0xFF08, 0xFF08, 0x80D5, 0x80D5, 0x80D5, 0x80D5,
  	0x80D5, 0x80D5, 0x80D5, 0x80D5, 0xFF0A, 0xFF82,
@@ -2011,12 +2011,12 @@ const u16 b43_ntab_pilot[] = {
  	0xF0A0, 0xF028, 0xFFFF, 0xFFFF,
  };

-const u32 b43_ntab_pilotlt[] = {
+static const u32 b43_ntab_pilotlt[] = {
  	0x76540123, 0x62407351, 0x76543201, 0x76540213,
  	0x76540123, 0x76430521,
  };

-const u32 b43_ntab_tdi20a0[] = {
+static const u32 b43_ntab_tdi20a0[] = {
  	0x00091226, 0x000A1429, 0x000B56AD, 0x000C58B0,
  	0x000D5AB3, 0x000E9CB6, 0x000F9EBA, 0x0000C13D,
  	0x00020301, 0x00030504, 0x00040708, 0x0005090B,
@@ -2033,7 +2033,7 @@ const u32 b43_ntab_tdi20a0[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi20a1[] = {
+static const u32 b43_ntab_tdi20a1[] = {
  	0x00014B26, 0x00028D29, 0x000393AD, 0x00049630,
  	0x0005D833, 0x0006DA36, 0x00099C3A, 0x000A9E3D,
  	0x000BC081, 0x000CC284, 0x000DC488, 0x000F068B,
@@ -2050,7 +2050,7 @@ const u32 b43_ntab_tdi20a1[] = {
  	0x00000000, 0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a0[] = {
+static const u32 b43_ntab_tdi40a0[] = {
  	0x0011A346, 0x00136CCF, 0x0014F5D9, 0x001641E2,
  	0x0017CB6B, 0x00195475, 0x001B2383, 0x001CAD0C,
  	0x001E7616, 0x0000821F, 0x00020BA8, 0x0003D4B2,
@@ -2081,7 +2081,7 @@ const u32 b43_ntab_tdi40a0[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdi40a1[] = {
+static const u32 b43_ntab_tdi40a1[] = {
  	0x001EDB36, 0x000129CA, 0x0002B353, 0x00047CDD,
  	0x0005C8E6, 0x000791EF, 0x00091BF9, 0x000AAA07,
  	0x000C3391, 0x000DFD1A, 0x00120923, 0x0013D22D,
@@ -2112,7 +2112,7 @@ const u32 b43_ntab_tdi40a1[] = {
  	0x00000000, 0x00000000,
  };

-const u32 b43_ntab_tdtrn[] = {
+static const u32 b43_ntab_tdtrn[] = {
  	0x061C061C, 0x0050EE68, 0xF592FE36, 0xFE5212F6,
  	0x00000C38, 0xFE5212F6, 0xF592FE36, 0x0050EE68,
  	0x061C061C, 0xEE680050, 0xFE36F592, 0x12F6FE52,
@@ -2291,7 +2291,7 @@ const u32 b43_ntab_tdtrn[] = {
  	0xFA58FC00, 0x0B64FC7E, 0x0800F7B6, 0x00F006BE,
  };

-const u32 b43_ntab_tmap[] = {
+static const u32 b43_ntab_tmap[] = {
  	0x8A88AA80, 0x8AAAAA8A, 0x8A8A8AA8, 0x00000888,
  	0x88000000, 0x8A8A88AA, 0x8AA88888, 0x8888A8A8,
  	0xF1111110, 0x11111111, 0x11F11111, 0x00000111,
@@ -2474,3 +2474,51 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  	/* Some compiletime assertions... */
  	assert_ntab_array_sizes();
  }
+
+#define ntab_upload(dev, offset, data) do { \
+		unsigned int i;						\
+		for (i = 0; i < (offset##_SIZE); i++)			\
+			b43_ntab_write(dev, (offset) + i, (data)[i]);	\
+	} while (0)
+
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	ntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);
+	ntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);
+	ntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);
+	ntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);
+	ntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);
+	ntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);
+	ntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);
+	ntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);
+	ntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);
+	ntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);
+	ntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);
+	ntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);
+	ntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);
+	ntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);
+
+	/* Volatile tables */
+	ntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);
+	ntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);
+	ntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);
+	ntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);
+	ntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);
+	ntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);
+	ntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);
+	ntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);
+	ntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);
+	ntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);
+	ntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);
+	ntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);
+}
+
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev)
+{
+	/* Static tables */
+	/* TODO */
+
+	/* Volatile tables */
+	/* TODO */
+}
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 4d498b0..1f0a602 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -128,32 +128,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);

  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);

-extern const u8 b43_ntab_adjustpower0[];
-extern const u8 b43_ntab_adjustpower1[];
-extern const u16 b43_ntab_bdi[];
-extern const u32 b43_ntab_channelest[];
-extern const u8 b43_ntab_estimatepowerlt0[];
-extern const u8 b43_ntab_estimatepowerlt1[];
-extern const u8 b43_ntab_framelookup[];
-extern const u32 b43_ntab_framestruct[];
-extern const u32 b43_ntab_gainctl0[];
-extern const u32 b43_ntab_gainctl1[];
-extern const u32 b43_ntab_intlevel[];
-extern const u32 b43_ntab_iqlt0[];
-extern const u32 b43_ntab_iqlt1[];
-extern const u16 b43_ntab_loftlt0[];
-extern const u16 b43_ntab_loftlt1[];
-extern const u8 b43_ntab_mcs[];
-extern const u32 b43_ntab_noisevar10[];
-extern const u32 b43_ntab_noisevar11[];
-extern const u16 b43_ntab_pilot[];
-extern const u32 b43_ntab_pilotlt[];
-extern const u32 b43_ntab_tdi20a0[];
-extern const u32 b43_ntab_tdi20a1[];
-extern const u32 b43_ntab_tdi40a0[];
-extern const u32 b43_ntab_tdi40a1[];
-extern const u32 b43_ntab_tdtrn[];
-extern const u32 b43_ntab_tmap[];
-
+void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
+void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0003-b43-N-PHY-clean-table-init-check-PHY-rev-V3.patch
Type: application/octet-stream
Size: 15178 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100106/38916f11/attachment.obj>

From zajec5 at gmail.com  Wed Jan  6 16:41:56 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:41:56 +0100
Subject: [PATCH 4/5] b43: N-PHY: add TX Gain tables
Message-ID: <op.u54a76ic9lhzdc@linux-g0th.site>

b43: N-PHY: add TX Gain tables


 From 98cb0f7b40df6605690f9e09f5102380844880ab Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Wed, 6 Jan 2010 16:23:15 +0100
Subject: [PATCH 4/5] b43: N-PHY: add TX Gain tables
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   12 +-
  drivers/net/wireless/b43/tables_nphy.c |  175 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    6 +
  3 files changed, 187 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 5341ba5..2b99d86 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -384,7 +384,7 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)

  	u16 curr_gain[2];
  	struct nphy_txgains target;
-	u32 *table = NULL;
+	const u32 *table = NULL;

  	if (nphy->txpwrctrl == 0) {
  		int i;
@@ -423,13 +423,13 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  				} else {
  					if (band == IEEE80211_BAND_5GHZ) {
  						if (dev->phy.rev == 3)
-							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (5 GHz)
+							table = b43_ntab_tx_gain_rev3_5ghz;
  						else if (dev->phy.rev == 4)
-							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 4 (5 GHz)
+							table = b43_ntab_tx_gain_rev4_5ghz;
  						else
-							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 5 (5 GHz)
+							table = b43_ntab_tx_gain_rev5plus_5ghz;
  					} else {
-						table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (2.4 GHz)
+						table = b43_ntab_tx_gain_rev3plus_2ghz;
  					}
  				}

@@ -438,7 +438,7 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  				target.pga[i] = (table[index[i]] >> 24) & 0xF;
  				target.txgm[i] = (table[index[i]] >> 28) & 0xF;
  			} else {
-				table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev <= 2
+				table = b43_ntab_tx_gain_rev0_1_2;

  				target.ipa[i] = (table[index[i]] >> 16) & 0x3;
  				target.pad[i] = (table[index[i]] >> 18) & 0x3;
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index d0b91b5..9fa527d 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2406,6 +2406,181 @@ static const u32 b43_ntab_tmap[] = {
  	0x00000000, 0x00000000, 0x00000000, 0x00000000,
  };

+const u32 b43_ntab_tx_gain_rev0_1_2[] = {
+	0x03cc2b44, 0x03cc2b42, 0x03cc2a44, 0x03cc2a42,
+	0x03cc2944, 0x03c82b44, 0x03c82b42, 0x03c82a44,
+	0x03c82a42, 0x03c82944, 0x03c82942, 0x03c82844,
+	0x03c82842, 0x03c42b44, 0x03c42b42, 0x03c42a44,
+	0x03c42a42, 0x03c42944, 0x03c42942, 0x03c42844,
+	0x03c42842, 0x03c42744, 0x03c42742, 0x03c42644,
+	0x03c42642, 0x03c42544, 0x03c42542, 0x03c42444,
+	0x03c42442, 0x03c02b44, 0x03c02b42, 0x03c02a44,
+	0x03c02a42, 0x03c02944, 0x03c02942, 0x03c02844,
+	0x03c02842, 0x03c02744, 0x03c02742, 0x03b02b44,
+	0x03b02b42, 0x03b02a44, 0x03b02a42, 0x03b02944,
+	0x03b02942, 0x03b02844, 0x03b02842, 0x03b02744,
+	0x03b02742, 0x03b02644, 0x03b02642, 0x03b02544,
+	0x03b02542, 0x03a02b44, 0x03a02b42, 0x03a02a44,
+	0x03a02a42, 0x03a02944, 0x03a02942, 0x03a02844,
+	0x03a02842, 0x03a02744, 0x03a02742, 0x03902b44,
+	0x03902b42, 0x03902a44, 0x03902a42, 0x03902944,
+	0x03902942, 0x03902844, 0x03902842, 0x03902744,
+	0x03902742, 0x03902644, 0x03902642, 0x03902544,
+	0x03902542, 0x03802b44, 0x03802b42, 0x03802a44,
+	0x03802a42, 0x03802944, 0x03802942, 0x03802844,
+	0x03802842, 0x03802744, 0x03802742, 0x03802644,
+	0x03802642, 0x03802544, 0x03802542, 0x03802444,
+	0x03802442, 0x03802344, 0x03802342, 0x03802244,
+	0x03802242, 0x03802144, 0x03802142, 0x03802044,
+	0x03802042, 0x03801f44, 0x03801f42, 0x03801e44,
+	0x03801e42, 0x03801d44, 0x03801d42, 0x03801c44,
+	0x03801c42, 0x03801b44, 0x03801b42, 0x03801a44,
+	0x03801a42, 0x03801944, 0x03801942, 0x03801844,
+	0x03801842, 0x03801744, 0x03801742, 0x03801644,
+	0x03801642, 0x03801544, 0x03801542, 0x03801444,
+	0x03801442, 0x03801344, 0x03801342, 0x00002b00,
+};
+
+const u32 b43_ntab_tx_gain_rev3plus_2ghz[] = {
+	0x1f410044, 0x1f410042, 0x1f410040, 0x1f41003e,
+	0x1f41003c, 0x1f41003b, 0x1f410039, 0x1f410037,
+	0x1e410044, 0x1e410042, 0x1e410040, 0x1e41003e,
+	0x1e41003c, 0x1e41003b, 0x1e410039, 0x1e410037,
+	0x1d410044, 0x1d410042, 0x1d410040, 0x1d41003e,
+	0x1d41003c, 0x1d41003b, 0x1d410039, 0x1d410037,
+	0x1c410044, 0x1c410042, 0x1c410040, 0x1c41003e,
+	0x1c41003c, 0x1c41003b, 0x1c410039, 0x1c410037,
+	0x1b410044, 0x1b410042, 0x1b410040, 0x1b41003e,
+	0x1b41003c, 0x1b41003b, 0x1b410039, 0x1b410037,
+	0x1a410044, 0x1a410042, 0x1a410040, 0x1a41003e,
+	0x1a41003c, 0x1a41003b, 0x1a410039, 0x1a410037,
+	0x19410044, 0x19410042, 0x19410040, 0x1941003e,
+	0x1941003c, 0x1941003b, 0x19410039, 0x19410037,
+	0x18410044, 0x18410042, 0x18410040, 0x1841003e,
+	0x1841003c, 0x1841003b, 0x18410039, 0x18410037,
+	0x17410044, 0x17410042, 0x17410040, 0x1741003e,
+	0x1741003c, 0x1741003b, 0x17410039, 0x17410037,
+	0x16410044, 0x16410042, 0x16410040, 0x1641003e,
+	0x1641003c, 0x1641003b, 0x16410039, 0x16410037,
+	0x15410044, 0x15410042, 0x15410040, 0x1541003e,
+	0x1541003c, 0x1541003b, 0x15410039, 0x15410037,
+	0x14410044, 0x14410042, 0x14410040, 0x1441003e,
+	0x1441003c, 0x1441003b, 0x14410039, 0x14410037,
+	0x13410044, 0x13410042, 0x13410040, 0x1341003e,
+	0x1341003c, 0x1341003b, 0x13410039, 0x13410037,
+	0x12410044, 0x12410042, 0x12410040, 0x1241003e,
+	0x1241003c, 0x1241003b, 0x12410039, 0x12410037,
+	0x11410044, 0x11410042, 0x11410040, 0x1141003e,
+	0x1141003c, 0x1141003b, 0x11410039, 0x11410037,
+	0x10410044, 0x10410042, 0x10410040, 0x1041003e,
+	0x1041003c, 0x1041003b, 0x10410039, 0x10410037,
+};
+
+const u32 b43_ntab_tx_gain_rev3_5ghz[] = {
+	0xcff70044, 0xcff70042, 0xcff70040, 0xcff7003e,
+	0xcff7003c, 0xcff7003b, 0xcff70039, 0xcff70037,
+	0xcef70044, 0xcef70042, 0xcef70040, 0xcef7003e,
+	0xcef7003c, 0xcef7003b, 0xcef70039, 0xcef70037,
+	0xcdf70044, 0xcdf70042, 0xcdf70040, 0xcdf7003e,
+	0xcdf7003c, 0xcdf7003b, 0xcdf70039, 0xcdf70037,
+	0xccf70044, 0xccf70042, 0xccf70040, 0xccf7003e,
+	0xccf7003c, 0xccf7003b, 0xccf70039, 0xccf70037,
+	0xcbf70044, 0xcbf70042, 0xcbf70040, 0xcbf7003e,
+	0xcbf7003c, 0xcbf7003b, 0xcbf70039, 0xcbf70037,
+	0xcaf70044, 0xcaf70042, 0xcaf70040, 0xcaf7003e,
+	0xcaf7003c, 0xcaf7003b, 0xcaf70039, 0xcaf70037,
+	0xc9f70044, 0xc9f70042, 0xc9f70040, 0xc9f7003e,
+	0xc9f7003c, 0xc9f7003b, 0xc9f70039, 0xc9f70037,
+	0xc8f70044, 0xc8f70042, 0xc8f70040, 0xc8f7003e,
+	0xc8f7003c, 0xc8f7003b, 0xc8f70039, 0xc8f70037,
+	0xc7f70044, 0xc7f70042, 0xc7f70040, 0xc7f7003e,
+	0xc7f7003c, 0xc7f7003b, 0xc7f70039, 0xc7f70037,
+	0xc6f70044, 0xc6f70042, 0xc6f70040, 0xc6f7003e,
+	0xc6f7003c, 0xc6f7003b, 0xc6f70039, 0xc6f70037,
+	0xc5f70044, 0xc5f70042, 0xc5f70040, 0xc5f7003e,
+	0xc5f7003c, 0xc5f7003b, 0xc5f70039, 0xc5f70037,
+	0xc4f70044, 0xc4f70042, 0xc4f70040, 0xc4f7003e,
+	0xc4f7003c, 0xc4f7003b, 0xc4f70039, 0xc4f70037,
+	0xc3f70044, 0xc3f70042, 0xc3f70040, 0xc3f7003e,
+	0xc3f7003c, 0xc3f7003b, 0xc3f70039, 0xc3f70037,
+	0xc2f70044, 0xc2f70042, 0xc2f70040, 0xc2f7003e,
+	0xc2f7003c, 0xc2f7003b, 0xc2f70039, 0xc2f70037,
+	0xc1f70044, 0xc1f70042, 0xc1f70040, 0xc1f7003e,
+	0xc1f7003c, 0xc1f7003b, 0xc1f70039, 0xc1f70037,
+	0xc0f70044, 0xc0f70042, 0xc0f70040, 0xc0f7003e,
+	0xc0f7003c, 0xc0f7003b, 0xc0f70039, 0xc0f70037,
+};
+
+const u32 b43_ntab_tx_gain_rev4_5ghz[] = {
+	0x2ff20044, 0x2ff20042, 0x2ff20040, 0x2ff2003e,
+	0x2ff2003c, 0x2ff2003b, 0x2ff20039, 0x2ff20037,
+	0x2ef20044, 0x2ef20042, 0x2ef20040, 0x2ef2003e,
+	0x2ef2003c, 0x2ef2003b, 0x2ef20039, 0x2ef20037,
+	0x2df20044, 0x2df20042, 0x2df20040, 0x2df2003e,
+	0x2df2003c, 0x2df2003b, 0x2df20039, 0x2df20037,
+	0x2cf20044, 0x2cf20042, 0x2cf20040, 0x2cf2003e,
+	0x2cf2003c, 0x2cf2003b, 0x2cf20039, 0x2cf20037,
+	0x2bf20044, 0x2bf20042, 0x2bf20040, 0x2bf2003e,
+	0x2bf2003c, 0x2bf2003b, 0x2bf20039, 0x2bf20037,
+	0x2af20044, 0x2af20042, 0x2af20040, 0x2af2003e,
+	0x2af2003c, 0x2af2003b, 0x2af20039, 0x2af20037,
+	0x29f20044, 0x29f20042, 0x29f20040, 0x29f2003e,
+	0x29f2003c, 0x29f2003b, 0x29f20039, 0x29f20037,
+	0x28f20044, 0x28f20042, 0x28f20040, 0x28f2003e,
+	0x28f2003c, 0x28f2003b, 0x28f20039, 0x28f20037,
+	0x27f20044, 0x27f20042, 0x27f20040, 0x27f2003e,
+	0x27f2003c, 0x27f2003b, 0x27f20039, 0x27f20037,
+	0x26f20044, 0x26f20042, 0x26f20040, 0x26f2003e,
+	0x26f2003c, 0x26f2003b, 0x26f20039, 0x26f20037,
+	0x25f20044, 0x25f20042, 0x25f20040, 0x25f2003e,
+	0x25f2003c, 0x25f2003b, 0x25f20039, 0x25f20037,
+	0x24f20044, 0x24f20042, 0x24f20040, 0x24f2003e,
+	0x24f2003c, 0x24f2003b, 0x24f20039, 0x24f20038,
+	0x23f20041, 0x23f20040, 0x23f2003f, 0x23f2003e,
+	0x23f2003c, 0x23f2003b, 0x23f20039, 0x23f20037,
+	0x22f20044, 0x22f20042, 0x22f20040, 0x22f2003e,
+	0x22f2003c, 0x22f2003b, 0x22f20039, 0x22f20037,
+	0x21f20044, 0x21f20042, 0x21f20040, 0x21f2003e,
+	0x21f2003c, 0x21f2003b, 0x21f20039, 0x21f20037,
+	0x20d20043, 0x20d20041, 0x20d2003e, 0x20d2003c,
+	0x20d2003a, 0x20d20038, 0x20d20036, 0x20d20034,
+};
+
+const u32 b43_ntab_tx_gain_rev5plus_5ghz[] = {
+	0x0f62004a, 0x0f620048, 0x0f620046, 0x0f620044,
+	0x0f620042, 0x0f620040, 0x0f62003e, 0x0f62003c,
+	0x0e620044, 0x0e620042, 0x0e620040, 0x0e62003e,
+	0x0e62003c, 0x0e62003d, 0x0e62003b, 0x0e62003a,
+	0x0d620043, 0x0d620041, 0x0d620040, 0x0d62003e,
+	0x0d62003d, 0x0d62003c, 0x0d62003b, 0x0d62003a,
+	0x0c620041, 0x0c620040, 0x0c62003f, 0x0c62003e,
+	0x0c62003c, 0x0c62003b, 0x0c620039, 0x0c620037,
+	0x0b620046, 0x0b620044, 0x0b620042, 0x0b620040,
+	0x0b62003e, 0x0b62003c, 0x0b62003b, 0x0b62003a,
+	0x0a620041, 0x0a620040, 0x0a62003e, 0x0a62003c,
+	0x0a62003b, 0x0a62003a, 0x0a620039, 0x0a620038,
+	0x0962003e, 0x0962003d, 0x0962003c, 0x0962003b,
+	0x09620039, 0x09620037, 0x09620035, 0x09620033,
+	0x08620044, 0x08620042, 0x08620040, 0x0862003e,
+	0x0862003c, 0x0862003b, 0x0862003a, 0x08620039,
+	0x07620043, 0x07620042, 0x07620040, 0x0762003f,
+	0x0762003d, 0x0762003b, 0x0762003a, 0x07620039,
+	0x0662003e, 0x0662003d, 0x0662003c, 0x0662003b,
+	0x06620039, 0x06620037, 0x06620035, 0x06620033,
+	0x05620046, 0x05620044, 0x05620042, 0x05620040,
+	0x0562003e, 0x0562003c, 0x0562003b, 0x05620039,
+	0x04620044, 0x04620042, 0x04620040, 0x0462003e,
+	0x0462003c, 0x0462003b, 0x04620039, 0x04620038,
+	0x0362003c, 0x0362003b, 0x0362003a, 0x03620039,
+	0x03620038, 0x03620037, 0x03620035, 0x03620033,
+	0x0262004c, 0x0262004a, 0x02620048, 0x02620047,
+	0x02620046, 0x02620044, 0x02620043, 0x02620042,
+	0x0162004a, 0x01620048, 0x01620046, 0x01620044,
+	0x01620043, 0x01620042, 0x01620041, 0x01620040,
+	0x00620042, 0x00620040, 0x0062003e, 0x0062003c,
+	0x0062003b, 0x00620039, 0x00620037, 0x00620035,
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 1f0a602..423c884 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -131,4 +131,10 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
  void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
  void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);

+extern const u32 b43_ntab_tx_gain_rev0_1_2[];
+extern const u32 b43_ntab_tx_gain_rev3plus_2ghz[];
+extern const u32 b43_ntab_tx_gain_rev3_5ghz[];
+extern const u32 b43_ntab_tx_gain_rev4_5ghz[];
+extern const u32 b43_ntab_tx_gain_rev5plus_5ghz[];
+
  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0004-b43-N-PHY-add-TX-Gain-tables.patch
Type: application/octet-stream
Size: 11615 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100106/fc4a0219/attachment.obj>

From zajec5 at gmail.com  Wed Jan  6 16:45:20 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:45:20 +0100
Subject: [PATCH 5/5] b43: N-PHY: minor init code work
Message-ID: <op.u54bduin9lhzdc@linux-g0th.site>

b43: N-PHY: minor init code work


 From b17c3a6da3eff05d49c97c87d13740c0915a21aa Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
Date: Wed, 6 Jan 2010 16:36:56 +0100
Subject: [PATCH 5/5] b43: N-PHY: minor init code work
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   32 +++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    3 +++
  2 files changed, 34 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2b99d86..4e3565a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -668,7 +668,37 @@ int b43_phy_initn(struct b43_wldev *dev)
  	}

  	if (!((nphy->measure_hold & 0x6) != 0)) {
-		//TODO
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
+			do_cal = (nphy->iqcal_chanspec_2G == 0);
+		else
+			do_cal = (nphy->iqcal_chanspec_5G == 0);
+
+		if (nphy->mute)
+			do_cal = false;
+
+		if (do_cal) {
+			struct nphy_txgains target =
+				b43_nphy_get_tx_gains(dev);
+
+			if (nphy->antsel_type == 2)
+				;//TODO N PHY Superswitch Init with argument 1
+			if (nphy->perical != 2) {
+				b43_nphy_rssi_cal(dev);
+				if (phy->rev >= 3) {
+					//FIXME: nphy->cal_orig_pwr_idx[0] = nphy->txpwrindex[0].index_internal;
+					//FIXME: nphy->cal_orig_pwr_idx[1] = nphy->txpwrindex[1].index_internal;
+					//TODO N PHY Pre Calibrate TX Gain
+					target = b43_nphy_get_tx_gains(dev);
+				}
+				/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0
+					If the output of N PHY Cal RX Iqlo with target, 2 0 as arguments is 0
+						Call N PHY Save Cal */
+			} else if (nphy->mphase_cal_phase_id == 0) {
+				//TODO N PHY Periodic Calibration with argument 3
+			}
+		} else {
+			//TODO N PHY Restore Calibration
+		}
  	}

  	//TODO N PHY TX Power Control Coef Setup
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e63c371..f90e905 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -926,9 +926,12 @@ struct b43_wldev;

  struct b43_phy_n {
  	u8 txpwrctrl;
+	u8 cal_orig_pwr_idx[2];
  	u8 measure_hold;
  	u8 phyrxchain;
+	u8 perical;
  	u8 mphase_cal_phase_id;
+	u8 antsel_type;
  	u32 deaf_count;
  	bool hang_avoid;
  	bool mute;
-- 
1.6.4.2
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0005-b43-N-PHY-minor-init-code-work.patch
Type: application/octet-stream
Size: 2410 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100106/b250224f/attachment.obj>

From zajec5 at gmail.com  Wed Jan  6 16:46:19 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 16:46:19 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search
	and it's calls
In-Reply-To: <op.u54a5ufy9lhzdc@linux-g0th.site>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
Message-ID: <op.u54bfhwo9lhzdc@linux-g0th.site>

Dnia 06-01-2010 o 16:40:32 Rafa? Mi?ecki <zajec5 at gmail.com> napisa?(a):

> b43: N-PHY: implement b43_nphy_stay_carrier_search and it's calls

Attaching patch (only inline-posted before).

-- 
Rafa?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-b43-N-PHY-implement-b43_nphy_stay_carrier_search-and.patch
Type: application/octet-stream
Size: 2929 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100106/cd0493bc/attachment.obj>

From mb at bu3sch.de  Wed Jan  6 16:50:50 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 6 Jan 2010 16:50:50 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search
	and it's calls
In-Reply-To: <op.u54a5ufy9lhzdc@linux-g0th.site>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
Message-ID: <201001061650.52062.mb@bu3sch.de>

On Wednesday 06 January 2010 16:40:32 Rafa? Mi?ecki wrote:
> b43: N-PHY: implement b43_nphy_stay_carrier_search and it's calls

Hm, The phrase "stay carrier earch" doesn't make a lot of sense to me.
Is "stray carrier search" or something like that meant?
Not that I care much, but I'm just wondering if this is just a typo.

> +static void b43_nphy_write_clip_detection(struct b43_wldev *dev, u16 *vals)

We know that these values are the clip thresholds, so use a better variable name, please.

> +{
> +	b43_phy_write(dev, B43_NPHY_C1_CLIP1THRES, vals[0]);
> +	b43_phy_write(dev, B43_NPHY_C2_CLIP1THRES, vals[1]);
> +}
> +
> +static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *vals)
> +{
> +	vals[0] = b43_phy_read(dev, B43_NPHY_C1_CLIP1THRES);
> +	vals[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
> +}
> +
> +static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
> +{
> +	u16 tmp;
> +	bool suspended = false;
> +
> +	if (dev->dev->id.revision == 16 && dev->mac_suspended == 0) {

Do not check for mac_suspended==0 here. b43_mac_suspended does this internally.

> +		b43_mac_suspend(dev);
> +		suspended = true;
> +	}
> +
> +	tmp = b43_phy_read(dev, B43_NPHY_CLASSCTL);
> +	tmp &= (B43_NPHY_CLASSCTL_CCKEN | B43_NPHY_CLASSCTL_OFDMEN |
> +		B43_NPHY_CLASSCTL_WAITEDEN);
> +	tmp &= ~mask;
> +	tmp |= (val & mask);
> +	b43_phy_maskset(dev, B43_NPHY_CLASSCTL, 0xFFF8, tmp);
> +
> +	if (suspended)
> +		b43_mac_enable(dev);
> +
> +	return tmp;
> +}
> +
> +static void b43_nphy_stay_carrier_search(struct b43_wldev *dev, bool enable)
> +{
> +	struct b43_phy *phy = &dev->phy;
> +	struct b43_phy_n *nphy = phy->n;
> +
> +	if (enable) {
> +		u16 clip[] = { 0xFFFF, 0xFFFF };
> +		if (nphy->deaf_count++ == 0) {
> +			nphy->classifier_state = b43_nphy_classifier(dev, 0, 0);
> +			b43_nphy_classifier(dev, 0x7, 0);
> +			b43_nphy_read_clip_detection(dev, nphy->clip_state);
> +			b43_nphy_write_clip_detection(dev, clip);
> +		}
> +		b43_nphy_reset_cca(dev);
> +	} else {
> +		if (--nphy->deaf_count != 0) {

If this test logic correct? The following would make more sense to me:

		if (--nphy->deaf_count == 0) {

> +			b43_nphy_classifier(dev, 0x7, nphy->classifier_state);
> +			b43_nphy_write_clip_detection(dev, nphy->clip_state);
> +		}
> +	}
> +}
> +
>   enum b43_nphy_rf_sequence {
>   	B43_RFSEQ_RX2TX,
>   	B43_RFSEQ_TX2RX,
> diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
> index e5e402a..6ab07fc 100644
> --- a/drivers/net/wireless/b43/phy_n.h
> +++ b/drivers/net/wireless/b43/phy_n.h
> @@ -932,6 +932,9 @@ struct b43_phy_n {
>   	u32 deaf_count;
>   	bool mute;
> 
> +	u16 classifier_state;
> +	u16 clip_state[2];
> +
>   	u8 iqcal_chanspec_2G;
>   	u8 rssical_chanspec_2G;
> 



-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Wed Jan  6 17:36:32 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 06 Jan 2010 10:36:32 -0600
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search
	and it's calls
In-Reply-To: <201001061650.52062.mb@bu3sch.de>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
Message-ID: <4B44BC10.1050308@lwfinger.net>

On 01/06/2010 09:50 AM, Michael Buesch wrote:
> On Wednesday 06 January 2010 16:40:32 Rafa? Mi?ecki wrote:
>> b43: N-PHY: implement b43_nphy_stay_carrier_search and it's calls
> 
> Hm, The phrase "stay carrier earch" doesn't make a lot of sense to me.
> Is "stray carrier search" or something like that meant?
> Not that I care much, but I'm just wondering if this is just a typo.

"stay in carrier search"

> 
>> +static void b43_nphy_write_clip_detection(struct b43_wldev *dev, u16 *vals)
> 
> We know that these values are the clip thresholds, so use a better variable name, please.
> 
>> +{
>> +	b43_phy_write(dev, B43_NPHY_C1_CLIP1THRES, vals[0]);
>> +	b43_phy_write(dev, B43_NPHY_C2_CLIP1THRES, vals[1]);
>> +}
>> +
>> +static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *vals)
>> +{
>> +	vals[0] = b43_phy_read(dev, B43_NPHY_C1_CLIP1THRES);
>> +	vals[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
>> +}
>> +
>> +static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
>> +{
>> +	u16 tmp;
>> +	bool suspended = false;
>> +
>> +	if (dev->dev->id.revision == 16 && dev->mac_suspended == 0) {
> 
> Do not check for mac_suspended==0 here. b43_mac_suspended does this internally.
> 
>> +		b43_mac_suspend(dev);
>> +		suspended = true;
>> +	}
>> +
>> +	tmp = b43_phy_read(dev, B43_NPHY_CLASSCTL);
>> +	tmp &= (B43_NPHY_CLASSCTL_CCKEN | B43_NPHY_CLASSCTL_OFDMEN |
>> +		B43_NPHY_CLASSCTL_WAITEDEN);
>> +	tmp &= ~mask;
>> +	tmp |= (val & mask);
>> +	b43_phy_maskset(dev, B43_NPHY_CLASSCTL, 0xFFF8, tmp);
>> +
>> +	if (suspended)
>> +		b43_mac_enable(dev);
>> +
>> +	return tmp;
>> +}
>> +
>> +static void b43_nphy_stay_carrier_search(struct b43_wldev *dev, bool enable)
>> +{
>> +	struct b43_phy *phy = &dev->phy;
>> +	struct b43_phy_n *nphy = phy->n;
>> +
>> +	if (enable) {
>> +		u16 clip[] = { 0xFFFF, 0xFFFF };
>> +		if (nphy->deaf_count++ == 0) {
>> +			nphy->classifier_state = b43_nphy_classifier(dev, 0, 0);
>> +			b43_nphy_classifier(dev, 0x7, 0);
>> +			b43_nphy_read_clip_detection(dev, nphy->clip_state);
>> +			b43_nphy_write_clip_detection(dev, clip);
>> +		}
>> +		b43_nphy_reset_cca(dev);
>> +	} else {
>> +		if (--nphy->deaf_count != 0) {
> 
> If this test logic correct? The following would make more sense to me:
> 
> 		if (--nphy->deaf_count == 0) {

It should be == 0. Specs match Broadcom code.


Larry



From mcgrof at gmail.com  Wed Jan  6 18:26:08 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Wed, 6 Jan 2010 09:26:08 -0800
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <op.u54a59c89lhzdc@linux-g0th.site>
References: <op.u54a59c89lhzdc@linux-g0th.site>
Message-ID: <43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>

2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
> b43: N-PHY: b43_nphy_get_tx_gains
>
>
> From 5c96b3de80f7d044c42808e8123ae3f50916d6fc Mon Sep 17 00:00:00 2001
> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
> Date: Wed, 6 Jan 2010 15:25:14 +0100
> Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
> MIME-Version: 1.0
> Content-Type: text/plain; charset=UTF-8
> Content-Transfer-Encoding: 8bit

Dude what is up with this e-mail data on your patches in the commit log?

  Luis


From mb at bu3sch.de  Wed Jan  6 19:22:56 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 6 Jan 2010 19:22:56 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
	<b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
Message-ID: <201001061922.58203.mb@bu3sch.de>

On Wednesday 06 January 2010 19:18:39 Rafa? Mi?ecki wrote:
> > Dude what is up with this e-mail data on your patches in the commit log?
> 
> That is way of encoding non-ASCII chars in mail header. You can find
> info about this in RFC. That is "=?UTF-8?B?" prefix and base 64
> encoded text.
> 
> That was generated with git (git format-patch -5) and it understood by
> git (git am ...).

Well, however, there is no reason to include this in the mail body (and thus
the GIT commit message).
As you said, these are mail _headers_.
Additionally, attaching the patch as mail attachment is _not_ required. We just
put the patch into the body.

You may read Documentation/SubmittingPatches and format your future
patches according to that.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Wed Jan  6 19:18:39 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 19:18:39 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
Message-ID: <b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>

W dniu 6 stycznia 2010 18:26 u?ytkownik Luis R. Rodriguez
<mcgrof at gmail.com> napisa?:
> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> b43: N-PHY: b43_nphy_get_tx_gains
>>
>>
>> From 5c96b3de80f7d044c42808e8123ae3f50916d6fc Mon Sep 17 00:00:00 2001
>> From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5 at gmail.com>
>> Date: Wed, 6 Jan 2010 15:25:14 +0100
>> Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
>> MIME-Version: 1.0
>> Content-Type: text/plain; charset=UTF-8
>> Content-Transfer-Encoding: 8bit
>
> Dude what is up with this e-mail data on your patches in the commit log?

That is way of encoding non-ASCII chars in mail header. You can find
info about this in RFC. That is "=?UTF-8?B?" prefix and base 64
encoded text.

That was generated with git (git format-patch -5) and it understood by
git (git am ...).

-- 
Rafa?


From zajec5 at gmail.com  Wed Jan  6 20:29:36 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 20:29:36 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <201001061922.58203.mb@bu3sch.de>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
	<b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
	<201001061922.58203.mb@bu3sch.de>
Message-ID: <b170af451001061129n59357edehc1f2328fb10846f6@mail.gmail.com>

W dniu 6 stycznia 2010 19:22 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Wednesday 06 January 2010 19:18:39 Rafa? Mi?ecki wrote:
>> > Dude what is up with this e-mail data on your patches in the commit log?
>>
>> That is way of encoding non-ASCII chars in mail header. You can find
>> info about this in RFC. That is "=?UTF-8?B?" prefix and base 64
>> encoded text.
>>
>> That was generated with git (git format-patch -5) and it understood by
>> git (git am ...).
>
> Well, however, there is no reason to include this in the mail body (and thus
> the GIT commit message).
> As you said, these are mail _headers_.
> Additionally, attaching the patch as mail attachment is _not_ required. We just
> put the patch into the body.

OK, will try to follow that. I checked few patches submitted by other
ppl so probably get the correct way this time.


> You may read Documentation/SubmittingPatches and format your future
> patches according to that.

Well, that's really poor joke :| Manually creating .orig files, using
"diff -up" and so dropping local commits "strategy"...? Er, I don't
think I'll use this one.

-- 
Rafa?


From mb at bu3sch.de  Wed Jan  6 20:36:53 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 6 Jan 2010 20:36:53 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <b170af451001061129n59357edehc1f2328fb10846f6@mail.gmail.com>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<201001061922.58203.mb@bu3sch.de>
	<b170af451001061129n59357edehc1f2328fb10846f6@mail.gmail.com>
Message-ID: <201001062036.55758.mb@bu3sch.de>

On Wednesday 06 January 2010 20:29:36 Rafa? Mi?ecki wrote:
> > You may read Documentation/SubmittingPatches and format your future
> > patches according to that.
> 
> Well, that's really poor joke :| Manually creating .orig files, using
> "diff -up" and so dropping local commits "strategy"...? Er, I don't
> think I'll use this one.

Nobody said you need to fix your internal workflow. Why would anybody care
_how_ you generate your patches?
You could manually type them into your cellphone with T9. If that it results
in a properly formated patch in the end, nobody would complain.

So yes, reading other people's patches probably is a good idea to start with.

In general only put stuff into the mail that you want to show up in the commit
message. (If you want to have additional stuff that doesn't show up in the commit
message, you can use the "---" delimiter. But that's documented elsewhere so
I don't have to explain that here...)

-- 
Greetings, Michael


From zajec5 at gmail.com  Wed Jan  6 20:41:52 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 20:41:52 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <201001062036.55758.mb@bu3sch.de>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<201001061922.58203.mb@bu3sch.de>
	<b170af451001061129n59357edehc1f2328fb10846f6@mail.gmail.com>
	<201001062036.55758.mb@bu3sch.de>
Message-ID: <b170af451001061141l171682aft1130489bd8b7edf5@mail.gmail.com>

W dniu 6 stycznia 2010 20:36 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Wednesday 06 January 2010 20:29:36 Rafa? Mi?ecki wrote:
>> > You may read Documentation/SubmittingPatches and format your future
>> > patches according to that.
>>
>> Well, that's really poor joke :| Manually creating .orig files, using
>> "diff -up" and so dropping local commits "strategy"...? Er, I don't
>> think I'll use this one.
>
> Nobody said you need to fix your internal workflow. Why would anybody care
> _how_ you generate your patches?
> You could manually type them into your cellphone with T9. If that it results
> in a properly formated patch in the end, nobody would complain.

Good one! ;)


> So yes, reading other people's patches probably is a good idea to start with.
>
> In general only put stuff into the mail that you want to show up in the commit
> message. (If you want to have additional stuff that doesn't show up in the commit
> message, you can use the "---" delimiter. But that's documented elsewhere so
> I don't have to explain that here...)

I started composing that mail before got real idea of patches. I was
still thinking I need some magic headers "diff" tool generates. Hope I
totally understand this now and won't cause more problems to you guys
:)

-- 
Rafa?


From mb at bu3sch.de  Wed Jan  6 20:51:19 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 6 Jan 2010 20:51:19 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <b170af451001061141l171682aft1130489bd8b7edf5@mail.gmail.com>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<201001062036.55758.mb@bu3sch.de>
	<b170af451001061141l171682aft1130489bd8b7edf5@mail.gmail.com>
Message-ID: <201001062051.20847.mb@bu3sch.de>

On Wednesday 06 January 2010 20:41:52 Rafa? Mi?ecki wrote:
> I started composing that mail before got real idea of patches. I was
> still thinking I need some magic headers "diff" tool generates. Hope I
> totally understand this now and won't cause more problems to you guys
> :)

There are no problems. It's just a little bit easier for maintainers to merge
properly formatted patches. Importing a properly formatted patch into git is just
a matter of a command or two.

So that said, I think it's awesome that you started to work on the N code.
I hope we get something usable, soon. Lots of people will love you and women
will want to marry you. ;)
Your patches _are_ actually in a pretty good shape. The remaining submission issues
are minor and easy to fix.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Wed Jan  6 21:11:08 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 21:11:08 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_carrier_search 
	and it's calls
In-Reply-To: <201001061650.52062.mb@bu3sch.de>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
Message-ID: <b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>

2010/1/6 Michael Buesch <mb at bu3sch.de>:
> On Wednesday 06 January 2010 16:40:32 Rafa? Mi?ecki wrote:
>> +static void b43_nphy_stay_carrier_search(struct b43_wldev *dev, bool enable)
>> +{
>> + ? ? struct b43_phy *phy = &dev->phy;
>> + ? ? struct b43_phy_n *nphy = phy->n;
>> +
>> + ? ? if (enable) {
>> + ? ? ? ? ? ? u16 clip[] = { 0xFFFF, 0xFFFF };
>> + ? ? ? ? ? ? if (nphy->deaf_count++ == 0) {
>> + ? ? ? ? ? ? ? ? ? ? nphy->classifier_state = b43_nphy_classifier(dev, 0, 0);
>> + ? ? ? ? ? ? ? ? ? ? b43_nphy_classifier(dev, 0x7, 0);
>> + ? ? ? ? ? ? ? ? ? ? b43_nphy_read_clip_detection(dev, nphy->clip_state);
>> + ? ? ? ? ? ? ? ? ? ? b43_nphy_write_clip_detection(dev, clip);
>> + ? ? ? ? ? ? }
>> + ? ? ? ? ? ? b43_nphy_reset_cca(dev);
>> + ? ? } else {
>> + ? ? ? ? ? ? if (--nphy->deaf_count != 0) {
>
> If this test logic correct? The following would make more sense to me:

Huuh, thanks for catching that! I believe you saved me from long
debugging in future.

-- 
Rafa?


From zajec5 at gmail.com  Wed Jan  6 21:15:06 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 21:15:06 +0100
Subject: [PATCH 2/5] b43: N-PHY: b43_nphy_get_tx_gains
In-Reply-To: <201001062051.20847.mb@bu3sch.de>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<201001062036.55758.mb@bu3sch.de>
	<b170af451001061141l171682aft1130489bd8b7edf5@mail.gmail.com>
	<201001062051.20847.mb@bu3sch.de>
Message-ID: <b170af451001061215l7a875889obd9d03de1039a49d@mail.gmail.com>

W dniu 6 stycznia 2010 20:51 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Wednesday 06 January 2010 20:41:52 Rafa? Mi?ecki wrote:
>> I started composing that mail before got real idea of patches. I was
>> still thinking I need some magic headers "diff" tool generates. Hope I
>> totally understand this now and won't cause more problems to you guys
>> :)
>
> There are no problems. It's just a little bit easier for maintainers to merge
> properly formatted patches. Importing a properly formatted patch into git is just
> a matter of a command or two.
>
> So that said, I think it's awesome that you started to work on the N code.
> I hope we get something usable, soon. Lots of people will love you and women
> will want to marry you. ;)
> Your patches _are_ actually in a pretty good shape. The remaining submission issues
> are minor and easy to fix.

Hey, thanks a lot, glad to hear that :)

It's great opportunity to involve myself in kernel development. I
could never write full working driver myself and in this case I have
most part of driver written and great specs available :)

-- 
Rafa?


From zajec5 at gmail.com  Wed Jan  6 21:54:38 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 21:54:38 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search and
	it's calls (V2)
In-Reply-To: <b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>
Message-ID: <op.u54ppc2h9lhzdc@linux-g0th.site>

V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
     rename function. Thanks Michael!

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   58 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    3 ++
  2 files changed, 61 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index ceb429a..5252c0f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -348,6 +348,64 @@ static void b43_nphy_reset_cca(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */
+static void b43_nphy_write_clip_detection(struct b43_wldev *dev, u16 *clip_st)
+{
+	b43_phy_write(dev, B43_NPHY_C1_CLIP1THRES, clip_st[0]);
+	b43_phy_write(dev, B43_NPHY_C2_CLIP1THRES, clip_st[1]);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */
+static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *clip_st)
+{
+	clip_st[0] = b43_phy_read(dev, B43_NPHY_C1_CLIP1THRES);
+	clip_st[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/classifier */
+static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
+{
+	u16 tmp;
+
+	if (dev->dev->id.revision == 16)
+		b43_mac_suspend(dev);
+
+	tmp = b43_phy_read(dev, B43_NPHY_CLASSCTL);
+	tmp &= (B43_NPHY_CLASSCTL_CCKEN | B43_NPHY_CLASSCTL_OFDMEN |
+		B43_NPHY_CLASSCTL_WAITEDEN);
+	tmp &= ~mask;
+	tmp |= (val & mask);
+	b43_phy_maskset(dev, B43_NPHY_CLASSCTL, 0xFFF8, tmp);
+
+	if (dev->dev->id.revision == 16)
+		b43_mac_enable(dev);
+
+	return tmp;
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/carriersearch */
+static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
+{
+	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = phy->n;
+
+	if (enable) {
+		u16 clip[] = { 0xFFFF, 0xFFFF };
+		if (nphy->deaf_count++ == 0) {
+			nphy->classifier_state = b43_nphy_classifier(dev, 0, 0);
+			b43_nphy_classifier(dev, 0x7, 0);
+			b43_nphy_read_clip_detection(dev, nphy->clip_state);
+			b43_nphy_write_clip_detection(dev, clip);
+		}
+		b43_nphy_reset_cca(dev);
+	} else {
+		if (--nphy->deaf_count == 0) {
+			b43_nphy_classifier(dev, 0x7, nphy->classifier_state);
+			b43_nphy_write_clip_detection(dev, nphy->clip_state);
+		}
+	}
+}
+
  enum b43_nphy_rf_sequence {
  	B43_RFSEQ_RX2TX,
  	B43_RFSEQ_TX2RX,
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e5e402a..6ab07fc 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -932,6 +932,9 @@ struct b43_phy_n {
  	u32 deaf_count;
  	bool mute;

+	u16 classifier_state;
+	u16 clip_state[2];
+
  	u8 iqcal_chanspec_2G;
  	u8 rssical_chanspec_2G;

-- 
1.6.4.2



From zajec5 at gmail.com  Wed Jan  6 21:57:12 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 21:57:12 +0100
Subject: [PATCH 2/5] b43: N-PHY: add b43_nphy_get_tx_gains (V2)
In-Reply-To: <b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
	<b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
Message-ID: <op.u54ptmwm9lhzdc@linux-g0th.site>

V2: adjust to renamed function, fill index array

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   81 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 82 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 5252c0f..3663386 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -30,6 +30,8 @@
  #include "tables_nphy.h"


+struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
+
  void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
  {//TODO
  }
@@ -406,6 +408,85 @@ static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
  	}
  }

+static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 curr_gain[2];
+	struct nphy_txgains target;
+	u32 *table = NULL;
+
+	if (nphy->txpwrctrl == 0) {
+		int i;
+
+		if (nphy->hang_avoid)
+			b43_nphy_stay_in_carrier_search(dev, true);
+		//TODO: Read an N PHY Table with ID 7, length 2, offset 0x110, width 16, and curr_gain
+		if (nphy->hang_avoid)
+			b43_nphy_stay_in_carrier_search(dev, false);
+
+		for (i = 0; i < 2; ++i) {
+			if (dev->phy.rev >= 3) {
+				target.ipa[i] = curr_gain[i] & 0x000F;
+				target.pad[i] = (curr_gain[i] & 0x00F0) >> 4;
+				target.pga[i] = (curr_gain[i] & 0x0F00) >> 8;
+				target.txgm[i] = (curr_gain[i] & 0x7000) >> 12;
+			} else {
+				target.ipa[i] = curr_gain[i] & 0x0003;
+				target.pad[i] = (curr_gain[i] & 0x000C) >> 2;
+				target.pga[i] = (curr_gain[i] & 0x0070) >> 4;
+				target.txgm[i] = (curr_gain[i] & 0x0380) >> 7;
+			}
+		}
+	} else {
+		int i;
+		u16 index[2];
+		index[0] = (b43_phy_read(dev, B43_NPHY_C1_TXPCTL_STAT) &
+			B43_NPHY_TXPCTL_STAT_BIDX) >>
+			B43_NPHY_TXPCTL_STAT_BIDX_SHIFT;
+		index[1] = (b43_phy_read(dev, B43_NPHY_C2_TXPCTL_STAT) &
+			B43_NPHY_TXPCTL_STAT_BIDX) >>
+			B43_NPHY_TXPCTL_STAT_BIDX_SHIFT;
+
+		for (i = 0; i < 2; ++i) {
+			if (dev->phy.rev >= 3) {
+				enum ieee80211_band band =
+					b43_current_band(dev->wl);
+
+				if ((nphy->ipa2g_on && band == IEEE80211_BAND_2GHZ) ||
+				    (nphy->ipa5g_on && band == IEEE80211_BAND_5GHZ)) {
+					table = NULL; //FIXME: = output of N PHY Get IPA GainTbl
+				} else {
+					if (band == IEEE80211_BAND_5GHZ) {
+						if (dev->phy.rev == 3)
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (5 GHz)
+						else if (dev->phy.rev == 4)
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 4 (5 GHz)
+						else
+							table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev 5 (5 GHz)
+					} else {
+						table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev >= 3 (2.4 GHz)
+					}
+				}
+
+				target.ipa[i] = (table[index[i]] >> 16) & 0xF;
+				target.pad[i] = (table[index[i]] >> 20) & 0xF;
+				target.pga[i] = (table[index[i]] >> 24) & 0xF;
+				target.txgm[i] = (table[index[i]] >> 28) & 0xF;
+			} else {
+				table = NULL; //FIXME: N PHY TX Power Control - TX Gain Table Rev <= 2
+
+				target.ipa[i] = (table[index[i]] >> 16) & 0x3;
+				target.pad[i] = (table[index[i]] >> 18) & 0x3;
+				target.pga[i] = (table[index[i]] >> 20) & 0x7;
+				target.txgm[i] = (table[index[i]] >> 23) & 0x7;
+			}
+		}
+	}
+
+	return target;
+}
+
  enum b43_nphy_rf_sequence {
  	B43_RFSEQ_RX2TX,
  	B43_RFSEQ_TX2RX,
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 6ab07fc..e63c371 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -930,6 +930,7 @@ struct b43_phy_n {
  	u8 phyrxchain;
  	u8 mphase_cal_phase_id;
  	u32 deaf_count;
+	bool hang_avoid;
  	bool mute;

  	u16 classifier_state;
-- 
1.6.4.2



From zajec5 at gmail.com  Wed Jan  6 22:09:56 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 06 Jan 2010 22:09:56 +0100
Subject: LP-PHY: Some fixes, notices
Message-ID: <op.u54qeuie9lhzdc@linux-g0th.site>

I've decided to made LP-PHY init code review for compatibility with specs and found some issues.

We lack some code for higher PHY revisions (up from 2/3) and for some specific boards. Also I've found little mistake in specs which Larry just corrected.

G?bor: could you care for this parts of LP-PHY code?

So far I've only checked
lpphy_read_band_sprom(dev);
and
lpphy_baseband_init(dev);

I check for all conditions and operations (registers, masks, values). So far didn't notice anything more serious than what's exposed by patch, so good work G?bor :)




diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index 1e318d8..43a9fcc 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -198,6 +198,17 @@ static void lpphy_table_init(struct b43_wldev *dev)

  	lpphy_init_tx_gain_table(dev);

+	if (dev->phy.rev >=2) {
+		int i;
+		for (i = 0; i < 128; ++i) {
+			/* TODO
+			Set the table offset to 576 + the loop index
+			Set the table data pointer to a u32 containing 127 - loop index
+			Write the table
+			*/
+		}
+	}
+
  	if (dev->phy.rev < 2)
  		lpphy_adjust_gain_table(dev, freq);
  }
diff --git a/drivers/net/wireless/b43/tables_lpphy.c b/drivers/net/wireless/b43/tables_lpphy.c
index 61027ee..cb233e6 100644
--- a/drivers/net/wireless/b43/tables_lpphy.c
+++ b/drivers/net/wireless/b43/tables_lpphy.c
@@ -2312,34 +2312,42 @@ void lpphy_rev2plus_table_init(struct b43_wldev *dev)
  	for (i = 0; i < 704; i++)
  		b43_lptab_write(dev, B43_LPTAB32(7, i), 0);

-	b43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),
-		ARRAY_SIZE(lpphy_min_sig_sq_table), lpphy_min_sig_sq_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),
-		ARRAY_SIZE(lpphy_rev2plus_noise_scale_table), lpphy_rev2plus_noise_scale_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(11, 0),
-		ARRAY_SIZE(lpphy_rev2plus_filter_control_table), lpphy_rev2plus_filter_control_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(12, 0),
-		ARRAY_SIZE(lpphy_rev2plus_ps_control_table), lpphy_rev2plus_ps_control_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
-		ARRAY_SIZE(lpphy_gain_idx_table), lpphy_gain_idx_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),
-		ARRAY_SIZE(lpphy_aux_gain_idx_table), lpphy_aux_gain_idx_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),
-		ARRAY_SIZE(lpphy_sw_control_table), lpphy_sw_control_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB8(16, 0),
-		ARRAY_SIZE(lpphy_hf_table), lpphy_hf_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),
-		ARRAY_SIZE(lpphy_gain_value_table), lpphy_gain_value_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),
-		ARRAY_SIZE(lpphy_gain_table), lpphy_gain_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),
-		ARRAY_SIZE(lpphy_pll_fraction_table), lpphy_pll_fraction_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),
-		ARRAY_SIZE(lpphy_iqlo_cal_table), lpphy_iqlo_cal_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),
-		ARRAY_SIZE(lpphy_papd_eps_table), lpphy_papd_eps_table);
-	b43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),
-		ARRAY_SIZE(lpphy_papd_mult_table), lpphy_papd_mult_table);
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	} else {
+		b43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),
+			ARRAY_SIZE(lpphy_min_sig_sq_table), lpphy_min_sig_sq_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),
+			ARRAY_SIZE(lpphy_rev2plus_noise_scale_table), lpphy_rev2plus_noise_scale_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(11, 0),
+			ARRAY_SIZE(lpphy_rev2plus_filter_control_table), lpphy_rev2plus_filter_control_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(12, 0),
+			ARRAY_SIZE(lpphy_rev2plus_ps_control_table), lpphy_rev2plus_ps_control_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
+			ARRAY_SIZE(lpphy_gain_idx_table), lpphy_gain_idx_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),
+			ARRAY_SIZE(lpphy_aux_gain_idx_table), lpphy_aux_gain_idx_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),
+			ARRAY_SIZE(lpphy_sw_control_table), lpphy_sw_control_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB8(16, 0),
+			ARRAY_SIZE(lpphy_hf_table), lpphy_hf_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),
+			ARRAY_SIZE(lpphy_gain_value_table), lpphy_gain_value_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),
+			ARRAY_SIZE(lpphy_gain_table), lpphy_gain_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),
+			ARRAY_SIZE(lpphy_pll_fraction_table), lpphy_pll_fraction_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),
+			ARRAY_SIZE(lpphy_iqlo_cal_table), lpphy_iqlo_cal_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),
+			ARRAY_SIZE(lpphy_papd_eps_table), lpphy_papd_eps_table);
+		b43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),
+			ARRAY_SIZE(lpphy_papd_mult_table), lpphy_papd_mult_table);
+	}
+
+	if (bus->boardinfo.type == 0x04AA && bus->boardinfo.rev <= 0x10) {
+		/* TODO */
+	}

  	if ((bus->chip_id == 0x4325) && (bus->chip_rev == 0)) {
  		b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
@@ -2421,7 +2429,7 @@ void lpphy_init_tx_gain_table(struct b43_wldev *dev)
  	switch (dev->phy.rev) {
  	case 0:
  		if ((bus->sprom.boardflags_hi & B43_BFH_NOPA) ||
-		    (bus->sprom.boardflags_lo & B43_BFL_HGPA))
+		    (bus->sprom.boardflags_hi & B43_BFH_RSSIINV))
  			lpphy_write_gain_table_bulk(dev, 0, 128,
  					lpphy_rev0_nopa_tx_gain_table);
  		else if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
@@ -2433,7 +2441,7 @@ void lpphy_init_tx_gain_table(struct b43_wldev *dev)
  		break;
  	case 1:
  		if ((bus->sprom.boardflags_hi & B43_BFH_NOPA) ||
-		    (bus->sprom.boardflags_lo & B43_BFL_HGPA))
+		    (bus->sprom.boardflags_hi & B43_BFH_RSSIINV))
  			lpphy_write_gain_table_bulk(dev, 0, 128,
  					lpphy_rev1_nopa_tx_gain_table);
  		else if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)


From Larry.Finger at lwfinger.net  Wed Jan  6 22:23:34 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 06 Jan 2010 15:23:34 -0600
Subject: [PATCH 2/5] b43: N-PHY: add b43_nphy_get_tx_gains (V2)
In-Reply-To: <op.u54ptmwm9lhzdc@linux-g0th.site>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
	<b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
	<op.u54ptmwm9lhzdc@linux-g0th.site>
Message-ID: <4B44FF56.6080204@lwfinger.net>

On 01/06/2010 02:57 PM, Rafa? Mi?ecki wrote:
> V2: adjust to renamed function, fill index array
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
>  drivers/net/wireless/b43/phy_n.c |   81

Just a little nitpick to save John some work, and to keep the patches straight.

When you submit a second (or later) version of a patch, indicate the version in
the mail header as in [PATCH 2/5 V2] b43:.... The upstream software strips all
of that out and the commit header will be clean.

In addition, it is useful to state what is different below the --- marker. The
software also strips that part of the patch - the permanent commit message
should be devoid of the details of the review message. It is like making
sausage! Better that the details are hidden.

Larry



From zajec5 at gmail.com  Wed Jan  6 22:29:08 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 22:29:08 +0100
Subject: [PATCH 2/5] b43: N-PHY: add b43_nphy_get_tx_gains (V2)
In-Reply-To: <4B44FF56.6080204@lwfinger.net>
References: <op.u54a59c89lhzdc@linux-g0th.site>
	<43e72e891001060926s320bf403ya2edf2601ced5125@mail.gmail.com>
	<b170af451001061018x6ff2404ajbdbb3cb96ceaf7f2@mail.gmail.com>
	<op.u54ptmwm9lhzdc@linux-g0th.site> <4B44FF56.6080204@lwfinger.net>
Message-ID: <b170af451001061329g7695fb57w859fd0a40729c2ef@mail.gmail.com>

W dniu 6 stycznia 2010 22:23 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/06/2010 02:57 PM, Rafa? Mi?ecki wrote:
>> V2: adjust to renamed function, fill index array
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_n.c | ? 81
>
> Just a little nitpick to save John some work, and to keep the patches straight.
>
> When you submit a second (or later) version of a patch, indicate the version in
> the mail header as in [PATCH 2/5 V2] b43:.... The upstream software strips all
> of that out and the commit header will be clean.
>
> In addition, it is useful to state what is different below the --- marker. The
> software also strips that part of the patch - the permanent commit message
> should be devoid of the details of the review message. It is like making
> sausage! Better that the details are hidden.

Uh, so once again I've made some mistake in my submitting. Sorry John,
thanks Larry.

I can excuse myself only with fact that it's something I've learn from
drm guys. Of course I'll change my ways. Ex.:


commit 3dfc63922f8edfa8774bf1ba882225c5f91b2220
Author: Alex Deucher <alexdeucher at gmail.com>
Date:   Tue Dec 22 10:06:49 2009 -0500

    drm/radeon/kms: add cvt mode if we only have lvds w/h and no edid (v4)

    This fixes LVDS on some mac laptops without a panel edid.

    v2 - Set proper mode type flags
    v3 - Note that this is not neceesarily the exact panel mode,
    but an approximation based on the cvt formula.  For these
    systems we should ideally read the mode info out of the
    registers or add a mode table, but this works and is much
    simpler.
    v4 - Update comments and debug message.

    Signed-off-by: Alex Deucher <alexdeucher at gmail.com>
    Signed-off-by: Dave Airlie <airlied at redhat.com>


-- 
Rafa?


From netrolller.3d at gmail.com  Wed Jan  6 22:30:14 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 22:30:14 +0100
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <op.u54qeuie9lhzdc@linux-g0th.site>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
Message-ID: <69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>

On Wed, Jan 6, 2010 at 10:09 PM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
> I've decided to made LP-PHY init code review for compatibility with specs
> and found some issues.
>
> We lack some code for higher PHY revisions (up from 2/3) and for some
> specific boards. Also I've found little mistake in specs which Larry just
> corrected.
>
> G?bor: could you care for this parts of LP-PHY code?
>
> So far I've only checked
> lpphy_read_band_sprom(dev);
> and
> lpphy_baseband_init(dev);
>
> I check for all conditions and operations (registers, masks, values). So far
> didn't notice anything more serious than what's exposed by patch, so good
> work G?bor :)
>
>
>
>
> diff --git a/drivers/net/wireless/b43/phy_lp.c
> b/drivers/net/wireless/b43/phy_lp.c
> index 1e318d8..43a9fcc 100644
> --- a/drivers/net/wireless/b43/phy_lp.c
> +++ b/drivers/net/wireless/b43/phy_lp.c
> @@ -198,6 +198,17 @@ static void lpphy_table_init(struct b43_wldev *dev)
>
> ? ? ? ?lpphy_init_tx_gain_table(dev);
>
> + ? ? ? if (dev->phy.rev >=2) {
> + ? ? ? ? ? ? ? int i;
> + ? ? ? ? ? ? ? for (i = 0; i < 128; ++i) {

Two style comments:
1. Declare i at the beginning of the function.
2. The preferred style in b43 is i++.

> + ? ? ? ? ? ? ? ? ? ? ? /* TODO
> + ? ? ? ? ? ? ? ? ? ? ? Set the table offset to 576 + the loop index
> + ? ? ? ? ? ? ? ? ? ? ? Set the table data pointer to a u32 containing 127 -
> loop index
> + ? ? ? ? ? ? ? ? ? ? ? Write the table
> + ? ? ? ? ? ? ? ? ? ? ? */

This can be implemented like this:
b43_lptab_write(dev, B43_LPTAB32(?, 576 + i), 127 - i);

Larry, what is the correct value for the "?" (i.e. the table index)?
Please update the specs, this is missing.

> + ? ? ? ? ? ? ? }
> + ? ? ? }
> +
> ? ? ? ?if (dev->phy.rev < 2)
> ? ? ? ? ? ? ? ?lpphy_adjust_gain_table(dev, freq);
> ?}
> diff --git a/drivers/net/wireless/b43/tables_lpphy.c
> b/drivers/net/wireless/b43/tables_lpphy.c
> index 61027ee..cb233e6 100644
> --- a/drivers/net/wireless/b43/tables_lpphy.c
> +++ b/drivers/net/wireless/b43/tables_lpphy.c
> @@ -2312,34 +2312,42 @@ void lpphy_rev2plus_table_init(struct b43_wldev
> *dev)
> ? ? ? ?for (i = 0; i < 704; i++)
> ? ? ? ? ? ? ? ?b43_lptab_write(dev, B43_LPTAB32(7, i), 0);
>
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_min_sig_sq_table), lpphy_min_sig_sq_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_noise_scale_table),
> lpphy_rev2plus_noise_scale_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(11, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_filter_control_table),
> lpphy_rev2plus_filter_control_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(12, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_ps_control_table),
> lpphy_rev2plus_ps_control_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_idx_table), lpphy_gain_idx_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_aux_gain_idx_table),
> lpphy_aux_gain_idx_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_sw_control_table), lpphy_sw_control_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(16, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_hf_table), lpphy_hf_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_value_table), lpphy_gain_value_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_table), lpphy_gain_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_pll_fraction_table),
> lpphy_pll_fraction_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_iqlo_cal_table), lpphy_iqlo_cal_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_papd_eps_table), lpphy_papd_eps_table);
> - ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),
> - ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_papd_mult_table), lpphy_papd_mult_table);
> + ? ? ? if (dev->phy.rev >= 3) {
> + ? ? ? ? ? ? ? /* TODO */
> + ? ? ? } else {
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_min_sig_sq_table),
> lpphy_min_sig_sq_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_noise_scale_table),
> lpphy_rev2plus_noise_scale_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(11, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_filter_control_table),
> lpphy_rev2plus_filter_control_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(12, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_rev2plus_ps_control_table),
> lpphy_rev2plus_ps_control_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_idx_table),
> lpphy_gain_idx_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_aux_gain_idx_table),
> lpphy_aux_gain_idx_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_sw_control_table),
> lpphy_sw_control_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(16, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_hf_table), lpphy_hf_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_value_table),
> lpphy_gain_value_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_gain_table), lpphy_gain_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_pll_fraction_table),
> lpphy_pll_fraction_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_iqlo_cal_table),
> lpphy_iqlo_cal_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_papd_eps_table),
> lpphy_papd_eps_table);
> + ? ? ? ? ? ? ? b43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),
> + ? ? ? ? ? ? ? ? ? ? ? ARRAY_SIZE(lpphy_papd_mult_table),
> lpphy_papd_mult_table);
> + ? ? ? }
> +
> + ? ? ? if (bus->boardinfo.type == 0x04AA && bus->boardinfo.rev <= 0x10) {
> + ? ? ? ? ? ? ? /* TODO */
> + ? ? ? }
>
> ? ? ? ?if ((bus->chip_id == 0x4325) && (bus->chip_rev == 0)) {
> ? ? ? ? ? ? ? ?b43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),
> @@ -2421,7 +2429,7 @@ void lpphy_init_tx_gain_table(struct b43_wldev *dev)
> ? ? ? ?switch (dev->phy.rev) {
> ? ? ? ?case 0:
> ? ? ? ? ? ? ? ?if ((bus->sprom.boardflags_hi & B43_BFH_NOPA) ||
> - ? ? ? ? ? ? ? ? ? (bus->sprom.boardflags_lo & B43_BFL_HGPA))
> + ? ? ? ? ? ? ? ? ? (bus->sprom.boardflags_hi & B43_BFH_RSSIINV))
> ? ? ? ? ? ? ? ? ? ? ? ?lpphy_write_gain_table_bulk(dev, 0, 128,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?lpphy_rev0_nopa_tx_gain_table);
> ? ? ? ? ? ? ? ?else if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
> @@ -2433,7 +2441,7 @@ void lpphy_init_tx_gain_table(struct b43_wldev *dev)
> ? ? ? ? ? ? ? ?break;
> ? ? ? ?case 1:
> ? ? ? ? ? ? ? ?if ((bus->sprom.boardflags_hi & B43_BFH_NOPA) ||
> - ? ? ? ? ? ? ? ? ? (bus->sprom.boardflags_lo & B43_BFL_HGPA))
> + ? ? ? ? ? ? ? ? ? (bus->sprom.boardflags_hi & B43_BFH_RSSIINV))
> ? ? ? ? ? ? ? ? ? ? ? ?lpphy_write_gain_table_bulk(dev, 0, 128,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?lpphy_rev1_nopa_tx_gain_table);
> ? ? ? ? ? ? ? ?else if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Wed Jan  6 23:35:13 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 23:35:13 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <op.u54ppc2h9lhzdc@linux-g0th.site>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de> 
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com> 
	<op.u54ppc2h9lhzdc@linux-g0th.site>
Message-ID: <69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>

2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
> ? ?rename function. Thanks Michael!
>
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> ?drivers/net/wireless/b43/phy_n.c | ? 58
> ++++++++++++++++++++++++++++++++++++++
> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
> ?2 files changed, 61 insertions(+), 0 deletions(-)
>
> <snip>

Typo in title (it's vs. its)

>
> --
> 1.6.4.2
>
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Wed Jan  6 23:36:42 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 23:36:42 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de> 
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com> 
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
Message-ID: <69e28c911001061436i7862beb4v720d033915d1543f@mail.gmail.com>

2010/1/6 G?bor Stefanik <netrolller.3d at gmail.com>:
> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>> ? ?rename function. Thanks Michael!
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_n.c | ? 58
>> ++++++++++++++++++++++++++++++++++++++
>> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
>> ?2 files changed, 61 insertions(+), 0 deletions(-)
>>
>> <snip>
>
> Typo in title (it's vs. its)

Note that you don't need to resubmit for this, I posted this so the
committer (John AFAIK) will notice and fix it before committing.

--G?bor

>
>>
>> --
>> 1.6.4.2
>>
>> --
>> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
>> the body of a message to majordomo at vger.kernel.org
>> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>>
>
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Wed Jan  6 23:45:06 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 23:45:06 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
Message-ID: <b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com>

W dniu 6 stycznia 2010 23:35 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>> ? ?rename function. Thanks Michael!
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_n.c | ? 58
>> ++++++++++++++++++++++++++++++++++++++
>> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
>> ?2 files changed, 61 insertions(+), 0 deletions(-)
>>
>> <snip>
>
> Typo in title (it's vs. its)

My gramma is far from perfect, thanks.

-- 
Rafa?


From netrolller.3d at gmail.com  Wed Jan  6 23:49:21 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 23:49:21 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de> 
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com> 
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com> 
	<b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com>
Message-ID: <69e28c911001061449v3f58ce1vc4bfefcdbaf81fa2@mail.gmail.com>

2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 6 stycznia 2010 23:35 u?ytkownik G?bor Stefanik
> <netrolller.3d at gmail.com> napisa?:
>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>>> ? ?rename function. Thanks Michael!
>>>
>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>> ---
>>> ?drivers/net/wireless/b43/phy_n.c | ? 58
>>> ++++++++++++++++++++++++++++++++++++++
>>> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
>>> ?2 files changed, 61 insertions(+), 0 deletions(-)
>>>
>>> <snip>
>>
>> Typo in title (it's vs. its)
>
> My gramma is far from perfect, thanks.

I've yet to see a perfect grandmother... :-)

>
> --
> Rafa?
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Wed Jan  6 23:55:40 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 06 Jan 2010 16:55:40 -0600
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
	<69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>
Message-ID: <4B4514EC.2010701@lwfinger.net>

On 01/06/2010 03:30 PM, G?bor Stefanik wrote:
> On Wed, Jan 6, 2010 at 10:09 PM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
>> I've decided to made LP-PHY init code review for compatibility with specs
>> and found some issues.
>>
>> We lack some code for higher PHY revisions (up from 2/3) and for some
>> specific boards. Also I've found little mistake in specs which Larry just
>> corrected.
>>
>> G?bor: could you care for this parts of LP-PHY code?
>>
>> So far I've only checked
>> lpphy_read_band_sprom(dev);
>> and
>> lpphy_baseband_init(dev);
>>
>> I check for all conditions and operations (registers, masks, values). So far
>> didn't notice anything more serious than what's exposed by patch, so good
>> work G?bor :)
>>
>>
>>
>>
>> diff --git a/drivers/net/wireless/b43/phy_lp.c
>> b/drivers/net/wireless/b43/phy_lp.c
>> index 1e318d8..43a9fcc 100644
>> --- a/drivers/net/wireless/b43/phy_lp.c
>> +++ b/drivers/net/wireless/b43/phy_lp.c
>> @@ -198,6 +198,17 @@ static void lpphy_table_init(struct b43_wldev *dev)
>>
>>        lpphy_init_tx_gain_table(dev);
>>
>> +       if (dev->phy.rev >=2) {
>> +               int i;
>> +               for (i = 0; i < 128; ++i) {
> 
> Two style comments:
> 1. Declare i at the beginning of the function.
> 2. The preferred style in b43 is i++.
> 
>> +                       /* TODO
>> +                       Set the table offset to 576 + the loop index
>> +                       Set the table data pointer to a u32 containing 127 -
>> loop index
>> +                       Write the table
>> +                       */
> 
> This can be implemented like this:
> b43_lptab_write(dev, B43_LPTAB32(?, 576 + i), 127 - i);
> 
> Larry, what is the correct value for the "?" (i.e. the table index)?
> Please update the specs, this is missing.

Now fixed. If the PHY Revision is >= 2, the table ID is 7, otherwise it is 0xA.
For the table in question, it should be 7.

Larry



From zajec5 at gmail.com  Wed Jan  6 23:55:53 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 6 Jan 2010 23:55:53 +0100
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <op.u54qeuie9lhzdc@linux-g0th.site>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
Message-ID: <b170af451001061455k1820af00h5adf044cf74df3a4@mail.gmail.com>

2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
> I've decided to made LP-PHY init code review for compatibility with specs
> and found some issues.
>
> We lack some code for higher PHY revisions (up from 2/3) and for some
> specific boards. Also I've found little mistake in specs which Larry just
> corrected.
>
> G?bor: could you care for this parts of LP-PHY code?
>
> So far I've only checked
> lpphy_read_band_sprom(dev);
> and
> lpphy_baseband_init(dev);
>
> I check for all conditions and operations (registers, masks, values). So far
> didn't notice anything more serious than what's exposed by patch, so good
> work G?bor :)

There was actually one part I wasn't able to understand yesterday (it
was late) and it still looks weird for me today... Could you verify my
doubts, please?

Specs:
http://bcm-v4.sipsolutions.net/802.11/PHY/LP/ReadBandSrom

Instead of "tmp2" we use "ofdmpo" (that's totally fine). However we do
following read: "ofdmpo = bus->sprom.ofdm2gpo;" before "2 -> k"
condition visible in specs.

So we use sprom.ofdm2gpo for both conditions and we do not care for "opo".

That is fine for rev. 8 as both: ofdm2gpo and opo are 0x142:
http://bcm-v4.sipsolutions.net/SPROM

However if we would meet LP-PHY on SSB with lower SPROM we wouldn't
have ofdm2gpo and we should really use "opo" then.

Am I right? Should we add "opo" reading for SPROM? Or maybe it's
impossible to find LP-PHY on SSB with lower SPROM and we can keep
using this work around?

-- 
Rafa?


From netrolller.3d at gmail.com  Wed Jan  6 23:58:19 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Wed, 6 Jan 2010 23:58:19 +0100
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <b170af451001061455k1820af00h5adf044cf74df3a4@mail.gmail.com>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
	<b170af451001061455k1820af00h5adf044cf74df3a4@mail.gmail.com>
Message-ID: <69e28c911001061458v70e35f2g1a9b810629168617@mail.gmail.com>

On Wed, Jan 6, 2010 at 11:55 PM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> I've decided to made LP-PHY init code review for compatibility with specs
>> and found some issues.
>>
>> We lack some code for higher PHY revisions (up from 2/3) and for some
>> specific boards. Also I've found little mistake in specs which Larry just
>> corrected.
>>
>> G?bor: could you care for this parts of LP-PHY code?
>>
>> So far I've only checked
>> lpphy_read_band_sprom(dev);
>> and
>> lpphy_baseband_init(dev);
>>
>> I check for all conditions and operations (registers, masks, values). So far
>> didn't notice anything more serious than what's exposed by patch, so good
>> work G?bor :)
>
> There was actually one part I wasn't able to understand yesterday (it
> was late) and it still looks weird for me today... Could you verify my
> doubts, please?
>
> Specs:
> http://bcm-v4.sipsolutions.net/802.11/PHY/LP/ReadBandSrom
>
> Instead of "tmp2" we use "ofdmpo" (that's totally fine). However we do
> following read: "ofdmpo = bus->sprom.ofdm2gpo;" before "2 -> k"
> condition visible in specs.
>
> So we use sprom.ofdm2gpo for both conditions and we do not care for "opo".
>
> That is fine for rev. 8 as both: ofdm2gpo and opo are 0x142:
> http://bcm-v4.sipsolutions.net/SPROM
>
> However if we would meet LP-PHY on SSB with lower SPROM we wouldn't
> have ofdm2gpo and we should really use "opo" then.
>
> Am I right? Should we add "opo" reading for SPROM? Or maybe it's
> impossible to find LP-PHY on SSB with lower SPROM and we can keep
> using this work around?

It has been determined that the presence of "opo" in the LP-PHY part
of the code is Broadcrap resulting from the automated processes
Broadcom uses for generating their driver. There is no LP-PHY with
SPROM <v8.

>
> --
> Rafa?
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Wed Jan  6 23:59:22 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 06 Jan 2010 16:59:22 -0600
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <69e28c911001061449v3f58ce1vc4bfefcdbaf81fa2@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
	<b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com>
	<69e28c911001061449v3f58ce1vc4bfefcdbaf81fa2@mail.gmail.com>
Message-ID: <4B4515CA.7050902@lwfinger.net>

On 01/06/2010 04:49 PM, G?bor Stefanik wrote:
> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> W dniu 6 stycznia 2010 23:35 u?ytkownik G?bor Stefanik
>> <netrolller.3d at gmail.com> napisa?:
>>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>>>>    rename function. Thanks Michael!
>>>>
>>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>>> ---
>>>>  drivers/net/wireless/b43/phy_n.c |   58
>>>> ++++++++++++++++++++++++++++++++++++++
>>>>  drivers/net/wireless/b43/phy_n.h |    3 ++
>>>>  2 files changed, 61 insertions(+), 0 deletions(-)
>>>>
>>>> <snip>
>>>
>>> Typo in title (it's vs. its)
>>
>> My gramma is far from perfect, thanks.
> 
> I've yet to see a perfect grandmother... :-)

My wife thinks she is perfect!

Larry


From zajec5 at gmail.com  Thu Jan  7 00:12:37 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 7 Jan 2010 00:12:37 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <4B4515CA.7050902@lwfinger.net>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de>
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com>
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com>
	<b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com>
	<69e28c911001061449v3f58ce1vc4bfefcdbaf81fa2@mail.gmail.com>
	<4B4515CA.7050902@lwfinger.net>
Message-ID: <b170af451001061512h6668a9cbyd275799c5cb37aa5@mail.gmail.com>

W dniu 6 stycznia 2010 23:59 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/06/2010 04:49 PM, G?bor Stefanik wrote:
>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> W dniu 6 stycznia 2010 23:35 u?ytkownik G?bor Stefanik
>>> <netrolller.3d at gmail.com> napisa?:
>>>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>>>>> ? ?rename function. Thanks Michael!
>>>>>
>>>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>>>> ---
>>>>> ?drivers/net/wireless/b43/phy_n.c | ? 58
>>>>> ++++++++++++++++++++++++++++++++++++++
>>>>> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
>>>>> ?2 files changed, 61 insertions(+), 0 deletions(-)
>>>>>
>>>>> <snip>
>>>>
>>>> Typo in title (it's vs. its)
>>>
>>> My gramma is far from perfect, thanks.
>>
>> I've yet to see a perfect grandmother... :-)
>
> My wife thinks she is perfect!

What a one latter can change ;)

-- 
Rafa?


From jhhaynes at earthlink.net  Thu Jan  7 00:17:39 2010
From: jhhaynes at earthlink.net (Jim Haynes)
Date: Wed, 6 Jan 2010 17:17:39 -0600 (CST)
Subject: b43 on Dell i1545 laptop
In-Reply-To: <4B441160.50302@lwfinger.net>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>
	<b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
	<alpine.LFD.2.00.1001052142380.8390@localhost>
	<4B441160.50302@lwfinger.net>
Message-ID: <alpine.LFD.2.00.1001061709470.2274@localhost>

On Tue, 5 Jan 2010, Larry Finger wrote:

> I have revised the wiki. You will not get the xxx15.fw files.

Thanks, now I have the xxx15.fw files

> the wiki and then copy the files in /lib/firmware/b43/ to some removable device.
> After you boot the CD, then copy those files to the firmware directory in the
> ramfs. Once that is done, unload and reload (with modprobe) the b43 driver. You
> will now be able to access the network. If you install from the CD, you will
> need to copy those files to the hard drive.

OK, I copied all the *15.fw files to /lib/firmware/b43
then did modprobe -r b43
          modprobe b43

Then I tried ifconfig wlan0 up      -    is that what I should have tried?

It responded with SIOCSIFFLAGS: Operation not possible due to RF-kill




From zajec5 at gmail.com  Thu Jan  7 00:22:11 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 7 Jan 2010 00:22:11 +0100
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
	<69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>
Message-ID: <b170af451001061522i16e2f568g33124d5957d9c4a7@mail.gmail.com>

W dniu 6 stycznia 2010 22:30 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> On Wed, Jan 6, 2010 at 10:09 PM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
>> diff --git a/drivers/net/wireless/b43/phy_lp.c
>> b/drivers/net/wireless/b43/phy_lp.c
>> index 1e318d8..43a9fcc 100644
>> --- a/drivers/net/wireless/b43/phy_lp.c
>> +++ b/drivers/net/wireless/b43/phy_lp.c
>> @@ -198,6 +198,17 @@ static void lpphy_table_init(struct b43_wldev *dev)
>>
>> ? ? ? ?lpphy_init_tx_gain_table(dev);
>>
>> + ? ? ? if (dev->phy.rev >=2) {
>> + ? ? ? ? ? ? ? int i;
>> + ? ? ? ? ? ? ? for (i = 0; i < 128; ++i) {
>
> Two style comments:
> 1. Declare i at the beginning of the function.
> 2. The preferred style in b43 is i++.

1. May I ask, why? I don't know much about kernel programming, so
that's not obvious for me. I declared this at beginning of rev2+
block, because it's used only here. I didn't want to waste memory of
(rev < 2) users (yeah, it's just 1 int but let's imagine 1 int in 100
drivers...)
2. I read in many places ++i is faster than i++, but it wasn't about
kernel programming actually. Thanks for tip.

-- 
Rafa?


From Larry.Finger at lwfinger.net  Thu Jan  7 00:25:50 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 06 Jan 2010 17:25:50 -0600
Subject: b43 on Dell i1545 laptop
In-Reply-To: <alpine.LFD.2.00.1001061709470.2274@localhost>
References: <alpine.LFD.2.00.1001041025280.2021@localhost>
	<b170af451001040914n7d05f579u6da68b9a8b869d94@mail.gmail.com>
	<alpine.LFD.2.00.1001052142380.8390@localhost>
	<4B441160.50302@lwfinger.net>
	<alpine.LFD.2.00.1001061709470.2274@localhost>
Message-ID: <4B451BFE.6070606@lwfinger.net>

On 01/06/2010 05:17 PM, Jim Haynes wrote:
> On Tue, 5 Jan 2010, Larry Finger wrote:
> 
>> I have revised the wiki. You will not get the xxx15.fw files.
> 
> Thanks, now I have the xxx15.fw files
> 
>> the wiki and then copy the files in /lib/firmware/b43/ to some
>> removable device.
>> After you boot the CD, then copy those files to the firmware directory
>> in the
>> ramfs. Once that is done, unload and reload (with modprobe) the b43
>> driver. You
>> will now be able to access the network. If you install from the CD,
>> you will
>> need to copy those files to the hard drive.
> 
> OK, I copied all the *15.fw files to /lib/firmware/b43
> then did modprobe -r b43
>          modprobe b43
> 
> Then I tried ifconfig wlan0 up      -    is that what I should have tried?
> 
> It responded with SIOCSIFFLAGS: Operation not possible due to RF-kill

That is the correct step as long as you are not using NetworkManager. Now you
need to flip your radio enable switch. If it is off, the radio is killed, i.e.
RF-kill.

Larry


From netrolller.3d at gmail.com  Thu Jan  7 00:32:33 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Thu, 7 Jan 2010 00:32:33 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement b43_nphy_stay_in_carrier_search
	and it's calls (V2)
In-Reply-To: <b170af451001061512h6668a9cbyd275799c5cb37aa5@mail.gmail.com>
References: <op.u54a5ufy9lhzdc@linux-g0th.site>
	<201001061650.52062.mb@bu3sch.de> 
	<b170af451001061211y51b3ca6do11fb24fbb1193c51@mail.gmail.com> 
	<op.u54ppc2h9lhzdc@linux-g0th.site>
	<69e28c911001061435v4b840588p3ead478672ba311@mail.gmail.com> 
	<b170af451001061445k56872cd1hbae81a59e421da73@mail.gmail.com> 
	<69e28c911001061449v3f58ce1vc4bfefcdbaf81fa2@mail.gmail.com> 
	<4B4515CA.7050902@lwfinger.net>
	<b170af451001061512h6668a9cbyd275799c5cb37aa5@mail.gmail.com>
Message-ID: <69e28c911001061532t674c3b55q97a1b9dc4af23622@mail.gmail.com>

On Thu, Jan 7, 2010 at 12:12 AM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
> W dniu 6 stycznia 2010 23:59 u?ytkownik Larry Finger
> <Larry.Finger at lwfinger.net> napisa?:
>> On 01/06/2010 04:49 PM, G?bor Stefanik wrote:
>>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>> W dniu 6 stycznia 2010 23:35 u?ytkownik G?bor Stefanik
>>>> <netrolller.3d at gmail.com> napisa?:
>>>>> 2010/1/6 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>>>> V2: fix typo in deaf_count counting, improve b43_mac_[sr] calls,
>>>>>> ? ?rename function. Thanks Michael!
>>>>>>
>>>>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>>>>> ---
>>>>>> ?drivers/net/wireless/b43/phy_n.c | ? 58
>>>>>> ++++++++++++++++++++++++++++++++++++++
>>>>>> ?drivers/net/wireless/b43/phy_n.h | ? ?3 ++
>>>>>> ?2 files changed, 61 insertions(+), 0 deletions(-)
>>>>>>
>>>>>> <snip>
>>>>>
>>>>> Typo in title (it's vs. its)
>>>>
>>>> My gramma is far from perfect, thanks.
>>>
>>> I've yet to see a perfect grandmother... :-)
>>
>> My wife thinks she is perfect!
>
> What a one latter can change ;)
>
> --
> Rafa?
>

The the impotence of proofreading

Has this ever happened to you?

You work very very horde on a paper for English clash
And you still get a very glow raid on it (like a D or even a D=)
and all because you are the liverwurst spoiler in the whale wide word.
Yes, proofreading your peppers is a matter of the the utmost impotence.

Now, this is a problem that affects manly, manly students, all over the world.
I myself was such a bed spiller once upon a term
that my English torturer in my sophomoric year,
Mrs. Myth, she said that I would never get into a good colleague.
And that's all I wanted, that's all any kid wants at that age,
just to get into a good colleague!
And not just anal community colleague either,
because I am not the kind of guy who would be happy at just anal
community colleague.
I need to be challenged. Challenged, menstrually.
I needed a place that can offer me intellectual simulation.
So I know this probably makes me sound like a stereo,
but I really felt that I could get into an ivory legal colleague.
So if I did not improvement
then gone would be my dream of going to Harvard, Jail, or Prison
(you know, in Prison, New Jersey).

So I got myself a spell checker
and figured I was on Sleazy Street.

But there are several missed aches
that a spell chukker can't can't catch catch.
For instant, if you accidentally leave out word,
your spell checker won't put it in you.
And God for billing purposes only
you should have serial problems with Tori Spelling
your spell Chekhov might replace a word
with one you had absolutely no detention of using.
Because, I mean, what do you want it to douche? You know...
No, it only does what you tell it to douche.
You're the one who's sitting in front of the computer scream,
with your hand on the mouth going clit, clit, clit.
It just goes to show you how embargo
one careless little clit of the mouth can be.

Which reminds me of this one time during my Junior Mint.
The teacher took the paper that I have written on A Sale of Two Titties.
No, I'm cereal, I'm cereal.
She read it out loud in front of all of my assmates.
It was quite possibly one of the most humidifying experiences I've ever had,
being laughed at, like that, pubicly.

So do yourself a flavor and follow these two Pisces of advice:
One: There is no prostitute for careful editing of your own work. No
prostitute, whatsoever.
And three: When it comes to proofreading,
the red penis your friend.

Spank you!

(Credits go to Taylor Mali for this one.)

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From peter at stuge.se  Thu Jan  7 04:42:26 2010
From: peter at stuge.se (Peter Stuge)
Date: Thu, 7 Jan 2010 04:42:26 +0100
Subject: Efficient emails [was: The newest Macbook 13.3" wireless]
In-Reply-To: <4247d9861001050428t72b96b2fwb4f2bc16297746b5@mail.gmail.com>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<b170af451001041323g2c2f29c0haa8333b8f82db37d@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
	<b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
	<4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>
	<b170af451001050425w5835e722gab98fee7ea7b123d@mail.gmail.com>
	<4247d9861001050428t72b96b2fwb4f2bc16297746b5@mail.gmail.com>
Message-ID: <20100107034226.678.qmail@stuge.se>

Hi Daniel,

Daniel Kuehn wrote:
> > Just reply under (below) quoted text (as I did in this mail).
> 
> I see, I am used to the opposite way in a normal email conversation
> on gmail :P Will have to re think when posting to MLs then ^^

Thanks for keeping a good attitude! :)

Although Gmail has a huge number of users, there are thousands of
other email programs and frequently when using mailing lists you are
likely to be communicating with people who are using different email
workflows.


Besides bottom-posting I think it helps a great deal to make email
discussions more readable to drastically trim the amount of quoted
text from previous messages in the conversation (AKA thread) _and_
to break up the quoted text and interleave replies with relevant
quotes. (Always reply below quote though.)

As I see it, the only reason to include any previous text at all is
to provide context for the parts that are being replied to.

An email could easily cover several related things at once, and in a
reply it can be difficult to know what new points related to what
parts of the original message. Interleaving reply text with minimal
quoting helps make this a great deal clearer IMO.

New readers in the thread can benefit greatly from quoted context,
but on the other hand they can never get the full story at once
unless every email includes every previous email. (But that's not a
good idea.)

Old readers are likely to remember much of the context from previous
messages. This means that anything but the absolute bare minimum of
context provided to them is redundant, a waste of time, a waste of
screen real estate (need to scroll past stuff they already know) and
(maybe less important) a waste of bandwidth. Risk is higher that
readers will not bother at all if they need to work more to find out
if your message is useful.

So - please make sure to remove as much as possible from the
message(s) that you are replying to. Sometimes quotes need to be long
to be useful, but most of the time I find that it's easy to remove
95% of previous messages when I reply. Yes - it's more work, but it
saves a lot of time for everyone who is reading your message.


Thanks!

//Peter


From mb at bu3sch.de  Thu Jan  7 11:30:54 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 7 Jan 2010 11:30:54 +0100
Subject: LP-PHY: Some fixes, notices
In-Reply-To: <b170af451001061522i16e2f568g33124d5957d9c4a7@mail.gmail.com>
References: <op.u54qeuie9lhzdc@linux-g0th.site>
	<69e28c911001061330u54bf3af4ie3a605bae89a17fe@mail.gmail.com>
	<b170af451001061522i16e2f568g33124d5957d9c4a7@mail.gmail.com>
Message-ID: <201001071130.56846.mb@bu3sch.de>

On Thursday 07 January 2010 00:22:11 Rafa? Mi?ecki wrote:
> W dniu 6 stycznia 2010 22:30 u?ytkownik G?bor Stefanik
> <netrolller.3d at gmail.com> napisa?:
> > On Wed, Jan 6, 2010 at 10:09 PM, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
> >> diff --git a/drivers/net/wireless/b43/phy_lp.c
> >> b/drivers/net/wireless/b43/phy_lp.c
> >> index 1e318d8..43a9fcc 100644
> >> --- a/drivers/net/wireless/b43/phy_lp.c
> >> +++ b/drivers/net/wireless/b43/phy_lp.c
> >> @@ -198,6 +198,17 @@ static void lpphy_table_init(struct b43_wldev *dev)
> >>
> >> ? ? ? ?lpphy_init_tx_gain_table(dev);
> >>
> >> + ? ? ? if (dev->phy.rev >=2) {
> >> + ? ? ? ? ? ? ? int i;
> >> + ? ? ? ? ? ? ? for (i = 0; i < 128; ++i) {
> >
> > Two style comments:
> > 1. Declare i at the beginning of the function.
> > 2. The preferred style in b43 is i++.
> 
> 1. May I ask, why? I don't know much about kernel programming, so
> that's not obvious for me. I declared this at beginning of rev2+
> block, because it's used only here. I didn't want to waste memory of
> (rev < 2) users (yeah, it's just 1 int but let's imagine 1 int in 100
> drivers...)

It does not waste memory, because the compiler will either:
	a) sink it into the branch
or
	b) allocate the stack space in any case on the beginning of
	the func, because it's only one operation for allocating all stack space.
So the compiler simply won't care and do the right thing anyway.
Declaring variables inside of branches is hardly used in the kernel.
And besides that, variables on the stack don't really waste anything. The stack is
permanently allocated and the compiler is smart enough to manage it properly.
The only thing we need to take care of w.r.t. the stack is to now overflow it. But
that's only an issue if we allocate large arrays on the stack. It's hardly possible
to overflow it with ordinary variables.

> 2. I read in many places ++i is faster than i++, but it wasn't about
> kernel programming actually. Thanks for tip.

There are some places in C++ (iterators) where ++i _can_ be faster. In C, however,
there is no speed difference. So we prefer i++, unless the semantics of ++i are required.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Thu Jan  7 14:09:27 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 07 Jan 2010 14:09:27 +0100
Subject: [PATCH] b43: LP-PHY: note and explain specs inconsistency
Message-ID: <op.u55yt0dz9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_lp.c |    7 +++++++
  1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index 1e318d8..eae15a1 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -79,6 +79,7 @@ static void b43_lpphy_op_free(struct b43_wldev *dev)
  	dev->phy.lp = NULL;
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/LP/ReadBandSrom */
  static void lpphy_read_band_sprom(struct b43_wldev *dev)
  {
  	struct b43_phy_lp *lpphy = dev->phy.lp;
@@ -100,6 +101,12 @@ static void lpphy_read_band_sprom(struct b43_wldev *dev)
  		maxpwr = bus->sprom.maxpwr_bg;
  		lpphy->max_tx_pwr_med_band = maxpwr;
  		cckpo = bus->sprom.cck2gpo;
+		/*
+		 * We don't read SPROM's opo as specs say. On rev8 SPROMs
+		 * opo == ofdm2gpo and we don't know any SSB with LP-PHY
+		 * and SPROM rev below 8.
+		 */
+		B43_WARN_ON(bus->sprom.revision < 8);
  		ofdmpo = bus->sprom.ofdm2gpo;
  		if (cckpo) {
  			for (i = 0; i < 4; i++) {
-- 
1.6.4.2



From enhaisa at gmail.com  Thu Jan  7 15:20:12 2010
From: enhaisa at gmail.com (Daniel Kuehn)
Date: Thu, 7 Jan 2010 15:20:12 +0100
Subject: Efficient emails [was: The newest Macbook 13.3" wireless]
In-Reply-To: <20100107034226.678.qmail@stuge.se>
References: <4247d9861001021811k7f98e933jeb54910cb03adb13@mail.gmail.com>
	<69e28c911001041445j1f2143d8h1648fd73a4fb213c@mail.gmail.com>
	<b170af451001041453p4f4da750we69c3dbb5e01a2cb@mail.gmail.com>
	<4247d9861001050346w745ecb17i22432cad178e9ac7@mail.gmail.com>
	<b170af451001050358r24863ed0wb49bb8477219b078@mail.gmail.com>
	<b170af451001050402g4060e65t4b5df0837d430c6d@mail.gmail.com>
	<4247d9861001050412u2d43bfe5i6d49e8b9108b01cc@mail.gmail.com>
	<b170af451001050425w5835e722gab98fee7ea7b123d@mail.gmail.com>
	<4247d9861001050428t72b96b2fwb4f2bc16297746b5@mail.gmail.com>
	<20100107034226.678.qmail@stuge.se>
Message-ID: <4247d9861001070620h1a5797acgb7f852cbaaea0905@mail.gmail.com>

On Thu, Jan 7, 2010 at 4:42 AM, Peter Stuge <peter at stuge.se> wrote:

> Hi Daniel,
>
> Daniel Kuehn wrote:
> > > Just reply under (below) quoted text (as I did in this mail).
> >
> > I see, I am used to the opposite way in a normal email conversation
> > on gmail :P Will have to re think when posting to MLs then ^^
>
> Thanks for keeping a good attitude! :)
>

Well, I am new to MLs, so I have to abide to the social rules that control
them ;)
Then it is just unneccessary to not learn and apply from pointers I get from
you guys that are more
experienced than me ^^


> Besides bottom-posting I think it helps a great deal to make email
> discussions more readable to drastically trim the amount of quoted
> text from previous messages in the conversation (AKA thread) _and_
> to break up the quoted text and interleave replies with relevant
> quotes. (Always reply below quote though.)
>

I agree with you there. I remember reading several posts from other mailing
list where they had every reply in the qoute before, it was quite annoying.
I will try my best to not redo that mistake ^^

// Daniel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100107/f90e4021/attachment.html>

From zajec5 at gmail.com  Fri Jan  8 09:30:27 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 8 Jan 2010 09:30:27 +0100
Subject: PHY: where to put forcing gater clocks function
Message-ID: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>

I need to implement
http://bcm-v4.sipsolutions.net/802.11/PHY/ClkFgc

Where I can put my
void b43_phy_clock_fgc(struct b43_wldev *dev, bool clock) { ... }
? Is end of phy_common.c file OK for this?

-- 
Rafa?


From mb at bu3sch.de  Fri Jan  8 11:17:22 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 8 Jan 2010 11:17:22 +0100
Subject: PHY: where to put forcing gater clocks function
In-Reply-To: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>
References: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>
Message-ID: <201001081117.24077.mb@bu3sch.de>

On Friday 08 January 2010 09:30:27 Rafa? Mi?ecki wrote:
> I need to implement
> http://bcm-v4.sipsolutions.net/802.11/PHY/ClkFgc
> 
> Where I can put my
> void b43_phy_clock_fgc(struct b43_wldev *dev, bool clock) { ... }
> ? Is end of phy_common.c file OK for this?

yes. Note that the 0x20000 bit has defines in ssb_regs.h. So you should use them.
Also use ssb_read/write to access that register. It's essentially the same
as b43_read/write, but this way it's obvious to humans that we are accessing a backplane register.
Also maybe don't call the parameter "clock" but "force". Would make more sense to me...

-- 
Greetings, Michael.


From zajec5 at gmail.com  Fri Jan  8 13:46:57 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 8 Jan 2010 13:46:57 +0100
Subject: PHY: where to put forcing gater clocks function
In-Reply-To: <201001081117.24077.mb@bu3sch.de>
References: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>
	<201001081117.24077.mb@bu3sch.de>
Message-ID: <b170af451001080446o2c59ebd8r734a4fdc71d1b1e8@mail.gmail.com>

W dniu 8 stycznia 2010 11:17 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Friday 08 January 2010 09:30:27 Rafa? Mi?ecki wrote:
>> I need to implement
>> http://bcm-v4.sipsolutions.net/802.11/PHY/ClkFgc
>>
>> Where I can put my
>> void b43_phy_clock_fgc(struct b43_wldev *dev, bool clock) { ... }
>> ? Is end of phy_common.c file OK for this?
>
> yes. Note that the 0x20000 bit has defines in ssb_regs.h. So you should use them.
> Also use ssb_read/write to access that register. It's essentially the same
> as b43_read/write, but this way it's obvious to humans that we are accessing a backplane register.
> Also maybe don't call the parameter "clock" but "force". Would make more sense to me...

Thanks Michael. I use CONSTANTS wherever I can and I did in my
implementation. Of course I used ssb_* as well :) And even after
posting patch I renamed "clock" to "force" :D

-- 
Rafa?


From zajec5 at gmail.com  Fri Jan  8 20:12:52 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 8 Jan 2010 20:12:52 +0100
Subject: PHY: where to put forcing gater clocks function
In-Reply-To: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>
References: <b170af451001080030g31719708r857678573b382e01@mail.gmail.com>
Message-ID: <b170af451001081112k4ea112a1pccb359e547e9b3df@mail.gmail.com>

W dniu 8 stycznia 2010 09:30 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> I need to implement
> http://bcm-v4.sipsolutions.net/802.11/PHY/ClkFgc
>
> Where I can put my
> void b43_phy_clock_fgc(struct b43_wldev *dev, bool clock) { ... }
> ? Is end of phy_common.c file OK for this?

Larry changed docs and now this is:
http://bcm-v4.sipsolutions.net/802.11/PHY/N/BmacPhyClkFgc
so it finally seems to be N-only function with some mysterious check
for PHY to be N...

I guess I'll just put this in phy_n.c and eventually in future we will
move it somewhere else if this will be needed.

-- 
Rafa?


From zajec5 at gmail.com  Sat Jan  9 14:00:51 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 09 Jan 2010 14:00:51 +0100
Subject: [PATCH 1/4] b43: N-PHY: correct CCA resets
Message-ID: <op.u59nroc09lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   35 +++++++++++++++++++++++++++++++----
  1 files changed, 31 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c4c39de..5cd4b1a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -314,11 +314,34 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x20);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/BmacPhyClkFgc */
+void b43_nphy_bmac_clock_fgc(struct b43_wldev *dev, bool force)
+{
+	u32 tmslow;
+
+	if (dev->phy.type != B43_PHYTYPE_N)
+		return;
+
+	tmslow = ssb_read32(dev->dev, SSB_TMSLOW);
+	if (force)
+		tmslow |= SSB_TMSLOW_FGC;
+	else
+		tmslow &= ~SSB_TMSLOW_FGC;
+	ssb_write32(dev->dev, SSB_TMSLOW, tmslow);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CCA */
  static void b43_nphy_reset_cca(struct b43_wldev *dev)
  {
-	u16 bbcfg = b43_phy_read(dev, B43_NPHY_BBCFG);
+	u16 bbcfg;
+
+	b43_nphy_bmac_clock_fgc(dev, 1);
+	bbcfg = b43_phy_read(dev, B43_NPHY_BBCFG);
  	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg | B43_NPHY_BBCFG_RSTCCA);
+	udelay(1);
  	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
+	b43_nphy_bmac_clock_fgc(dev, 0);
+	//TODO: N PHY Force RF Seq with argument 2
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */
@@ -631,9 +654,13 @@ int b43_phy_initn(struct b43_wldev *dev)

  	b43_nphy_workarounds(dev);

-	//TODO N PHY BMAC Clock FGC with argument 1
-	b43_nphy_reset_cca(dev);
-	//TODO N PHY BMAC Clock FGC with argument 0
+	/* Reset CCA, in init code it differs from standard way a little */
+	b43_nphy_bmac_clock_fgc(dev, 1);
+	tmp = b43_phy_read(dev, B43_NPHY_BBCFG);
+	b43_phy_write(dev, B43_NPHY_BBCFG, tmp | B43_NPHY_BBCFG_RSTCCA);
+	b43_phy_write(dev, B43_NPHY_BBCFG, tmp & ~B43_NPHY_BBCFG_RSTCCA);
+	b43_nphy_bmac_clock_fgc(dev, 0);
+
  	//TODO N PHY MAC PHY Clock Set with argument 1
  	//TODO Disable PA Override
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan  9 14:01:06 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 09 Jan 2010 14:01:06 +0100
Subject: [PATCH 2/4] b43: N-PHY: add b43_nphy_pa_override
Message-ID: <op.u59nr4cg9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   40 ++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    3 ++
  2 files changed, 41 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 5cd4b1a..739973e 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -330,6 +330,40 @@ void b43_nphy_bmac_clock_fgc(struct b43_wldev *dev, bool force)
  	ssb_write32(dev->dev, SSB_TMSLOW, tmslow);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PA%20override */
+static void b43_nphy_pa_override(struct b43_wldev *dev, bool enable)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	enum ieee80211_band band;
+	u16 tmp;
+
+	if (!enable) {
+		nphy->rfctrl_intc1_save = b43_phy_read(dev,
+						       B43_NPHY_RFCTL_INTC1);
+		nphy->rfctrl_intc2_save = b43_phy_read(dev,
+						       B43_NPHY_RFCTL_INTC2);
+		band = b43_current_band(dev->wl);
+		if (dev->phy.rev >= 3) {
+			if (band == IEEE80211_BAND_5GHZ)
+				tmp = 0x600;
+			else
+				tmp = 0x480;
+		} else {
+			if (band == IEEE80211_BAND_5GHZ)
+				tmp = 0x180;
+			else
+				tmp = 0x120;
+		}
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);
+	} else {
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1,
+				nphy->rfctrl_intc1_save);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2,
+				nphy->rfctrl_intc2_save);
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CCA */
  static void b43_nphy_reset_cca(struct b43_wldev *dev)
  {
@@ -662,10 +696,12 @@ int b43_phy_initn(struct b43_wldev *dev)
  	b43_nphy_bmac_clock_fgc(dev, 0);

  	//TODO N PHY MAC PHY Clock Set with argument 1
-	//TODO Disable PA Override
+
+	b43_nphy_pa_override(dev, false);
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
-	//TODO Turn on PA override
+	b43_nphy_pa_override(dev, true);
+
  	//TODO N PHY Classifier with arguments 0 and 0
  	//TODO N PHY Det Clip with 0 and the clip array as arguments
  	tx_pwr_state = nphy->txpwrctrl;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index f90e905..6bb9476 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -936,6 +936,9 @@ struct b43_phy_n {
  	bool hang_avoid;
  	bool mute;

+	u16 rfctrl_intc1_save;
+	u16 rfctrl_intc2_save;
+
  	u16 classifier_state;
  	u16 clip_state[2];

-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan  9 14:01:21 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 09 Jan 2010 14:01:21 +0100
Subject: [PATCH 3/4] b43: N-PHY: add b43_nphy_get_ipa_gain_table and its tables
Message-ID: <op.u59nsjib9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   20 +++++-
  drivers/net/wireless/b43/tables_nphy.c |  140 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    5 +
  3 files changed, 164 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 739973e..6452cb3 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -413,6 +413,24 @@ static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
  	return tmp;
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetIpaGainTbl */
+static const u32 * b43_nphy_get_ipa_gain_table(struct b43_wldev *dev)
+{
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+		if (dev->phy.rev >= 6) {
+			/* TODO If the chip is 47162
+				return txpwrctrl_tx_gain_ipa_rev5 */
+			return txpwrctrl_tx_gain_ipa_rev6;
+		} else if (dev->phy.rev >= 5) {
+			return txpwrctrl_tx_gain_ipa_rev5;
+		} else {
+			return txpwrctrl_tx_gain_ipa;
+		}
+	} else {
+		return txpwrctrl_tx_gain_ipa_5g;
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/carriersearch */
  static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
  {
@@ -483,7 +501,7 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)

  				if ((nphy->ipa2g_on && band == IEEE80211_BAND_2GHZ) ||
  				    (nphy->ipa5g_on && band == IEEE80211_BAND_5GHZ)) {
-					table = NULL; //FIXME: = output of N PHY Get IPA GainTbl
+					table = b43_nphy_get_ipa_gain_table(dev);
  				} else {
  					if (band == IEEE80211_BAND_5GHZ) {
  						if (dev->phy.rev == 3)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 9fa527d..3779f1d 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2581,6 +2581,146 @@ const u32 b43_ntab_tx_gain_rev5plus_5ghz[] = {
  	0x0062003b, 0x00620039, 0x00620037, 0x00620035,
  };

+const u32 txpwrctrl_tx_gain_ipa[] = {
+	0x5ff7002d, 0x5ff7002b, 0x5ff7002a, 0x5ff70029,
+	0x5ff70028, 0x5ff70027, 0x5ff70026, 0x5ff70025,
+	0x5ef7002d, 0x5ef7002b, 0x5ef7002a, 0x5ef70029,
+	0x5ef70028, 0x5ef70027, 0x5ef70026, 0x5ef70025,
+	0x5df7002d, 0x5df7002b, 0x5df7002a, 0x5df70029,
+	0x5df70028, 0x5df70027, 0x5df70026, 0x5df70025,
+	0x5cf7002d, 0x5cf7002b, 0x5cf7002a, 0x5cf70029,
+	0x5cf70028, 0x5cf70027, 0x5cf70026, 0x5cf70025,
+	0x5bf7002d, 0x5bf7002b, 0x5bf7002a, 0x5bf70029,
+	0x5bf70028, 0x5bf70027, 0x5bf70026, 0x5bf70025,
+	0x5af7002d, 0x5af7002b, 0x5af7002a, 0x5af70029,
+	0x5af70028, 0x5af70027, 0x5af70026, 0x5af70025,
+	0x59f7002d, 0x59f7002b, 0x59f7002a, 0x59f70029,
+	0x59f70028, 0x59f70027, 0x59f70026, 0x59f70025,
+	0x58f7002d, 0x58f7002b, 0x58f7002a, 0x58f70029,
+	0x58f70028, 0x58f70027, 0x58f70026, 0x58f70025,
+	0x57f7002d, 0x57f7002b, 0x57f7002a, 0x57f70029,
+	0x57f70028, 0x57f70027, 0x57f70026, 0x57f70025,
+	0x56f7002d, 0x56f7002b, 0x56f7002a, 0x56f70029,
+	0x56f70028, 0x56f70027, 0x56f70026, 0x56f70025,
+	0x55f7002d, 0x55f7002b, 0x55f7002a, 0x55f70029,
+	0x55f70028, 0x55f70027, 0x55f70026, 0x55f70025,
+	0x54f7002d, 0x54f7002b, 0x54f7002a, 0x54f70029,
+	0x54f70028, 0x54f70027, 0x54f70026, 0x54f70025,
+	0x53f7002d, 0x53f7002b, 0x53f7002a, 0x53f70029,
+	0x53f70028, 0x53f70027, 0x53f70026, 0x53f70025,
+	0x52f7002d, 0x52f7002b, 0x52f7002a, 0x52f70029,
+	0x52f70028, 0x52f70027, 0x52f70026, 0x52f70025,
+	0x51f7002d, 0x51f7002b, 0x51f7002a, 0x51f70029,
+	0x51f70028, 0x51f70027, 0x51f70026, 0x51f70025,
+	0x50f7002d, 0x50f7002b, 0x50f7002a, 0x50f70029,
+	0x50f70028, 0x50f70027, 0x50f70026, 0x50f70025,
+};
+
+const u32 txpwrctrl_tx_gain_ipa_rev5[] = {
+	0x1ff7002d, 0x1ff7002b, 0x1ff7002a, 0x1ff70029,
+	0x1ff70028, 0x1ff70027, 0x1ff70026, 0x1ff70025,
+	0x1ef7002d, 0x1ef7002b, 0x1ef7002a, 0x1ef70029,
+	0x1ef70028, 0x1ef70027, 0x1ef70026, 0x1ef70025,
+	0x1df7002d, 0x1df7002b, 0x1df7002a, 0x1df70029,
+	0x1df70028, 0x1df70027, 0x1df70026, 0x1df70025,
+	0x1cf7002d, 0x1cf7002b, 0x1cf7002a, 0x1cf70029,
+	0x1cf70028, 0x1cf70027, 0x1cf70026, 0x1cf70025,
+	0x1bf7002d, 0x1bf7002b, 0x1bf7002a, 0x1bf70029,
+	0x1bf70028, 0x1bf70027, 0x1bf70026, 0x1bf70025,
+	0x1af7002d, 0x1af7002b, 0x1af7002a, 0x1af70029,
+	0x1af70028, 0x1af70027, 0x1af70026, 0x1af70025,
+	0x19f7002d, 0x19f7002b, 0x19f7002a, 0x19f70029,
+	0x19f70028, 0x19f70027, 0x19f70026, 0x19f70025,
+	0x18f7002d, 0x18f7002b, 0x18f7002a, 0x18f70029,
+	0x18f70028, 0x18f70027, 0x18f70026, 0x18f70025,
+	0x17f7002d, 0x17f7002b, 0x17f7002a, 0x17f70029,
+	0x17f70028, 0x17f70027, 0x17f70026, 0x17f70025,
+	0x16f7002d, 0x16f7002b, 0x16f7002a, 0x16f70029,
+	0x16f70028, 0x16f70027, 0x16f70026, 0x16f70025,
+	0x15f7002d, 0x15f7002b, 0x15f7002a, 0x15f70029,
+	0x15f70028, 0x15f70027, 0x15f70026, 0x15f70025,
+	0x14f7002d, 0x14f7002b, 0x14f7002a, 0x14f70029,
+	0x14f70028, 0x14f70027, 0x14f70026, 0x14f70025,
+	0x13f7002d, 0x13f7002b, 0x13f7002a, 0x13f70029,
+	0x13f70028, 0x13f70027, 0x13f70026, 0x13f70025,
+	0x12f7002d, 0x12f7002b, 0x12f7002a, 0x12f70029,
+	0x12f70028, 0x12f70027, 0x12f70026, 0x12f70025,
+	0x11f7002d, 0x11f7002b, 0x11f7002a, 0x11f70029,
+	0x11f70028, 0x11f70027, 0x11f70026, 0x11f70025,
+	0x10f7002d, 0x10f7002b, 0x10f7002a, 0x10f70029,
+	0x10f70028, 0x10f70027, 0x10f70026, 0x10f70025,
+};
+
+const u32 txpwrctrl_tx_gain_ipa_rev6[] = {
+	0x0ff7002d, 0x0ff7002b, 0x0ff7002a, 0x0ff70029,
+	0x0ff70028, 0x0ff70027, 0x0ff70026, 0x0ff70025,
+	0x0ef7002d, 0x0ef7002b, 0x0ef7002a, 0x0ef70029,
+	0x0ef70028, 0x0ef70027, 0x0ef70026, 0x0ef70025,
+	0x0df7002d, 0x0df7002b, 0x0df7002a, 0x0df70029,
+	0x0df70028, 0x0df70027, 0x0df70026, 0x0df70025,
+	0x0cf7002d, 0x0cf7002b, 0x0cf7002a, 0x0cf70029,
+	0x0cf70028, 0x0cf70027, 0x0cf70026, 0x0cf70025,
+	0x0bf7002d, 0x0bf7002b, 0x0bf7002a, 0x0bf70029,
+	0x0bf70028, 0x0bf70027, 0x0bf70026, 0x0bf70025,
+	0x0af7002d, 0x0af7002b, 0x0af7002a, 0x0af70029,
+	0x0af70028, 0x0af70027, 0x0af70026, 0x0af70025,
+	0x09f7002d, 0x09f7002b, 0x09f7002a, 0x09f70029,
+	0x09f70028, 0x09f70027, 0x09f70026, 0x09f70025,
+	0x08f7002d, 0x08f7002b, 0x08f7002a, 0x08f70029,
+	0x08f70028, 0x08f70027, 0x08f70026, 0x08f70025,
+	0x07f7002d, 0x07f7002b, 0x07f7002a, 0x07f70029,
+	0x07f70028, 0x07f70027, 0x07f70026, 0x07f70025,
+	0x06f7002d, 0x06f7002b, 0x06f7002a, 0x06f70029,
+	0x06f70028, 0x06f70027, 0x06f70026, 0x06f70025,
+	0x05f7002d, 0x05f7002b, 0x05f7002a, 0x05f70029,
+	0x05f70028, 0x05f70027, 0x05f70026, 0x05f70025,
+	0x04f7002d, 0x04f7002b, 0x04f7002a, 0x04f70029,
+	0x04f70028, 0x04f70027, 0x04f70026, 0x04f70025,
+	0x03f7002d, 0x03f7002b, 0x03f7002a, 0x03f70029,
+	0x03f70028, 0x03f70027, 0x03f70026, 0x03f70025,
+	0x02f7002d, 0x02f7002b, 0x02f7002a, 0x02f70029,
+	0x02f70028, 0x02f70027, 0x02f70026, 0x02f70025,
+	0x01f7002d, 0x01f7002b, 0x01f7002a, 0x01f70029,
+	0x01f70028, 0x01f70027, 0x01f70026, 0x01f70025,
+	0x00f7002d, 0x00f7002b, 0x00f7002a, 0x00f70029,
+	0x00f70028, 0x00f70027, 0x00f70026, 0x00f70025,
+};
+
+const u32 txpwrctrl_tx_gain_ipa_5g[] = {
+	0x7ff70035, 0x7ff70033, 0x7ff70032, 0x7ff70031,
+	0x7ff7002f, 0x7ff7002e, 0x7ff7002d, 0x7ff7002b,
+	0x7ff7002a, 0x7ff70029, 0x7ff70028, 0x7ff70027,
+	0x7ff70026, 0x7ff70024, 0x7ff70023, 0x7ff70022,
+	0x7ef70028, 0x7ef70027, 0x7ef70026, 0x7ef70025,
+	0x7ef70024, 0x7ef70023, 0x7df70028, 0x7df70027,
+	0x7df70026, 0x7df70025, 0x7df70024, 0x7df70023,
+	0x7df70022, 0x7cf70029, 0x7cf70028, 0x7cf70027,
+	0x7cf70026, 0x7cf70025, 0x7cf70023, 0x7cf70022,
+	0x7bf70029, 0x7bf70028, 0x7bf70026, 0x7bf70025,
+	0x7bf70024, 0x7bf70023, 0x7bf70022, 0x7bf70021,
+	0x7af70029, 0x7af70028, 0x7af70027, 0x7af70026,
+	0x7af70025, 0x7af70024, 0x7af70023, 0x7af70022,
+	0x79f70029, 0x79f70028, 0x79f70027, 0x79f70026,
+	0x79f70025, 0x79f70024, 0x79f70023, 0x79f70022,
+	0x78f70029, 0x78f70028, 0x78f70027, 0x78f70026,
+	0x78f70025, 0x78f70024, 0x78f70023, 0x78f70022,
+	0x77f70029, 0x77f70028, 0x77f70027, 0x77f70026,
+	0x77f70025, 0x77f70024, 0x77f70023, 0x77f70022,
+	0x76f70029, 0x76f70028, 0x76f70027, 0x76f70026,
+	0x76f70024, 0x76f70023, 0x76f70022, 0x76f70021,
+	0x75f70029, 0x75f70028, 0x75f70027, 0x75f70026,
+	0x75f70025, 0x75f70024, 0x75f70023, 0x74f70029,
+	0x74f70028, 0x74f70026, 0x74f70025, 0x74f70024,
+	0x74f70023, 0x74f70022, 0x73f70029, 0x73f70027,
+	0x73f70026, 0x73f70025, 0x73f70024, 0x73f70023,
+	0x73f70022, 0x72f70028, 0x72f70027, 0x72f70026,
+	0x72f70025, 0x72f70024, 0x72f70023, 0x72f70022,
+	0x71f70028, 0x71f70027, 0x71f70026, 0x71f70025,
+	0x71f70024, 0x71f70023, 0x70f70028, 0x70f70027,
+	0x70f70026, 0x70f70024, 0x70f70023, 0x70f70022,
+	0x70f70021, 0x70f70020, 0x70f70020, 0x70f7001f,
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 423c884..62b1745 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -137,4 +137,9 @@ extern const u32 b43_ntab_tx_gain_rev3_5ghz[];
  extern const u32 b43_ntab_tx_gain_rev4_5ghz[];
  extern const u32 b43_ntab_tx_gain_rev5plus_5ghz[];

+extern const u32 txpwrctrl_tx_gain_ipa[];
+extern const u32 txpwrctrl_tx_gain_ipa_rev5[];
+extern const u32 txpwrctrl_tx_gain_ipa_rev6[];
+extern const u32 txpwrctrl_tx_gain_ipa_5g[];
+
  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan  9 14:01:37 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 09 Jan 2010 14:01:37 +0100
Subject: [PATCH 4/4] b43: N-PHY: some comments, function definion fix, missing
	calls
Message-ID: <op.u59nszh39lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   19 ++++++++++++++-----
  1 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6452cb3..c2c2602 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -315,7 +315,7 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/BmacPhyClkFgc */
-void b43_nphy_bmac_clock_fgc(struct b43_wldev *dev, bool force)
+static void b43_nphy_bmac_clock_fgc(struct b43_wldev *dev, bool force)
  {
  	u32 tmslow;

@@ -454,6 +454,7 @@ static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
  static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  {
  	struct b43_phy_n *nphy = dev->phy.n;
@@ -589,17 +590,22 @@ static void b43_nphy_bphy_init(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_PHY_N_BMODE(0x38), 0x668);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
  	//TODO
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */
  static void b43_nphy_rev3_rssi_cal(struct b43_wldev *dev)
  {
  	//TODO
  }

-/* RSSI Calibration */
+/*
+ * RSSI Calibration
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal
+ */
  static void b43_nphy_rssi_cal(struct b43_wldev *dev)
  {
  	if (dev->phy.rev >= 3) {
@@ -611,7 +617,10 @@ static void b43_nphy_rssi_cal(struct b43_wldev *dev)
  	}
  }

-/* Restore RSSI Calibration */
+/*
+ * Restore RSSI Calibration
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreRssiCal
+ */
  static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
  {
  	//TODO
@@ -720,8 +729,8 @@ int b43_phy_initn(struct b43_wldev *dev)
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
  	b43_nphy_pa_override(dev, true);

-	//TODO N PHY Classifier with arguments 0 and 0
-	//TODO N PHY Det Clip with 0 and the clip array as arguments
+	b43_nphy_classifier(dev, 0, 0);
+	b43_nphy_read_clip_detection(dev, clip);
  	tx_pwr_state = nphy->txpwrctrl;
  	//TODO N PHY TX power control with argument 0 (turning off power control)
  	//TODO Fix the TX Power Settings
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:13:07 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:13:07 +0100
Subject: [PATCH 1/6] b43: N-PHY: add RSSI functions: scale offset, select (rev
	< 3), restore cal
Message-ID: <op.u6b7z2yo9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |  157 +++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |   10 +++
  2 files changed, 166 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c2c2602..a44fca1 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -590,6 +590,127 @@ static void b43_nphy_bphy_init(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_PHY_N_BMODE(0x38), 0x668);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ScaleOffsetRssi */
+static void b43_nphy_scale_offset_rssi(struct b43_wldev *dev, u16 scale,
+				       s8 offset, u8 core, u8 rail, u8 type)
+{
+	u16 tmp;
+	bool core1or5 = (core == 1) || (core == 5);
+	bool core2or5 = (core == 2) || (core == 5);
+
+	offset = clamp_val(offset, -32, 31);
+	tmp = ((scale & 0x3F) << 8) | (offset & 0x3F);
+
+	if (core1or5 && (rail == 0) && (type == 2))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Z, tmp);
+	if (core1or5 && (rail == 1) && (type == 2))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z, tmp);
+	if (core2or5 && (rail == 0) && (type == 2))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Z, tmp);
+	if (core2or5 && (rail == 1) && (type == 2))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z, tmp);
+	if (core1or5 && (rail == 0) && (type == 0))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_X, tmp);
+	if (core1or5 && (rail == 1) && (type == 0))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_X, tmp);
+	if (core2or5 && (rail == 0) && (type == 0))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_X, tmp);
+	if (core2or5 && (rail == 1) && (type == 0))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_X, tmp);
+	if (core1or5 && (rail == 0) && (type == 1))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Y, tmp);
+	if (core1or5 && (rail == 1) && (type == 1))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y, tmp);
+	if (core2or5 && (rail == 0) && (type == 1))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Y, tmp);
+	if (core2or5 && (rail == 1) && (type == 1))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, tmp);
+	if (core1or5 && (rail == 0) && (type == 6))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_TBD, tmp);
+	if (core1or5 && (rail == 1) && (type == 6))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_TBD, tmp);
+	if (core2or5 && (rail == 0) && (type == 6))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_TBD, tmp);
+	if (core2or5 && (rail == 1) && (type == 6))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_TBD, tmp);
+	if (core1or5 && (rail == 0) && (type == 3))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_PWRDET, tmp);
+	if (core1or5 && (rail == 1) && (type == 3))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_PWRDET, tmp);
+	if (core2or5 && (rail == 0) && (type == 3))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_PWRDET, tmp);
+	if (core2or5 && (rail == 1) && (type == 3))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_PWRDET, tmp);
+	if (core1or5 && (type == 4))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0I_TSSI, tmp);
+	if (core2or5 && (type == 4))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1I_TSSI, tmp);
+	if (core1or5 && (type == 5))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_TSSI, tmp);
+	if (core2or5 && (type == 5))
+		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_TSSI, tmp);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */
+static void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
+{
+	u16 val;
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	} else {
+		if (type < 3)
+			val = 0;
+		else if (type == 6)
+			val = 1;
+		else if (type == 3)
+			val = 2;
+		else
+			val = 3;
+
+		val = (val << 12) | (val << 14);
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, val);
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, val);
+
+		if (type < 3) {
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO1, 0xFFCF,
+					(type + 1) << 4);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO2, 0xFFCF,
+					(type + 1) << 4);
+		}
+
+		/* TODO use some definitions */
+		if (code == 0) {
+			b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF, 0);
+			if (type < 3) {
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
+						0xFEC7, 0);
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+						0xEFDC, 0);
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
+						0xFFFE, 0);
+				udelay(20);
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+						0xFFFE, 0);
+			}
+		} else {
+			b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF,
+					0x3000);
+			if (type < 3) {
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
+						0xFEC7, 0x0180);
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+						0xEFDC, (code << 1 | 0x1021));
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
+						0xFFFE, 0x0001);
+				udelay(20);
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+						0xFFFE, 0);
+			}
+		}
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
@@ -623,7 +744,41 @@ static void b43_nphy_rssi_cal(struct b43_wldev *dev)
   */
  static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
  {
-	//TODO
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 *rssical_radio_regs = NULL;
+	u16 *rssical_phy_regs = NULL;
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+		if (!nphy->rssical_chanspec_2G)
+			return;
+		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;
+		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;
+	} else {
+		if (!nphy->rssical_chanspec_5G)
+			return;
+		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;
+		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;
+	}
+
+	/* TODO use some definitions */
+	b43_radio_maskset(dev, 0x602B, 0xE3, rssical_radio_regs[0]);
+	b43_radio_maskset(dev, 0x702B, 0xE3, rssical_radio_regs[1]);
+
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Z, rssical_phy_regs[0]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z, rssical_phy_regs[1]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Z, rssical_phy_regs[2]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z, rssical_phy_regs[3]);
+
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_X, rssical_phy_regs[4]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_X, rssical_phy_regs[5]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_X, rssical_phy_regs[6]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_X, rssical_phy_regs[7]);
+
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Y, rssical_phy_regs[8]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y, rssical_phy_regs[9]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Y, rssical_phy_regs[10]);
+	b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, rssical_phy_regs[11]);
  }

  /* Init N-PHY
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 6bb9476..ca1fd11 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -924,6 +924,14 @@

  struct b43_wldev;

+struct b43_phy_n_rssical_cache {
+	u16 rssical_radio_regs_2G[2];
+	u16 rssical_phy_regs_2G[12];
+
+	u16 rssical_radio_regs_5G[2];
+	u16 rssical_phy_regs_5G[12];
+};
+
  struct b43_phy_n {
  	u8 txpwrctrl;
  	u8 cal_orig_pwr_idx[2];
@@ -948,6 +956,8 @@ struct b43_phy_n {
  	u8 iqcal_chanspec_5G;
  	u8 rssical_chanspec_5G;

+	struct b43_phy_n_rssical_cache rssical_cache;
+
  	bool crsminpwr_adjusted;
  	bool noisevars_adjusted;

-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:13:20 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:13:20 +0100
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
Message-ID: <op.u6b70ig59lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   96 ++++++++++++++++++++++++++++++++++++++
  1 files changed, 96 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index a44fca1..d7e408b 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -711,6 +711,102 @@ static void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRssi2055Vcm */
+static void b43_nphy_set_rssi_2055_vcm(struct b43_wldev *dev, u8 type, u8 *buf)
+{
+	int i;
+	for (i = 0; i < 2; i++) {
+		if (type == 2) {
+			if (i == 0) {
+				b43_radio_maskset(dev, B2055_C1_B0NB_RSSIVCM,
+						  0xFC, buf[0]);
+				b43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,
+						  0xFC, buf[1]);
+			} else {
+				b43_radio_maskset(dev, B2055_C2_B0NB_RSSIVCM,
+						  0xFC, buf[2 * i]);
+				b43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,
+						  0xFC, buf[2 * i + 1]);
+			}
+		} else {
+			if (i == 0)
+				b43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,
+						  0xF3, buf[0] << 2);
+			else
+				b43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,
+						  0xF3, buf[2 * i + 1] << 2);
+		}
+	}
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PollRssi */
+static int b43_nphy_poll_rssi(struct b43_wldev *dev, u8 type, s32 *buf,
+				u8 nsamp)
+{
+	int i;
+	int out;
+	u16 save_regs_phy[9];
+	u16 s[2];
+
+	if (dev->phy.rev >= 3) {
+		save_regs_phy[0] = b43_phy_read(dev,
+						B43_NPHY_RFCTL_LUT_TRSW_UP1);
+		save_regs_phy[1] = b43_phy_read(dev,
+						B43_NPHY_RFCTL_LUT_TRSW_UP2);
+		save_regs_phy[2] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
+		save_regs_phy[3] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
+		save_regs_phy[4] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
+		save_regs_phy[5] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		save_regs_phy[6] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S0);
+		save_regs_phy[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B32S1);
+	}
+
+	b43_nphy_rssi_select(dev, 5, type);
+
+	if (dev->phy.rev < 2) {
+		save_regs_phy[8] = b43_phy_read(dev, B43_NPHY_GPIO_SEL);
+		b43_phy_write(dev, B43_NPHY_GPIO_SEL, 5);
+	}
+
+	for (i = 0; i < 4; i++)
+		buf[i] = 0;
+
+	for (i = 0; i < nsamp; i++) {
+		if (dev->phy.rev < 2) {
+			s[0] = b43_phy_read(dev, B43_NPHY_GPIO_LOOUT);
+			s[1] = b43_phy_read(dev, B43_NPHY_GPIO_HIOUT);
+		} else {
+			s[0] = b43_phy_read(dev, B43_NPHY_RSSI1);
+			s[1] = b43_phy_read(dev, B43_NPHY_RSSI2);
+		}
+
+		buf[0] += (s8)(((s[0] & 0x3F) << 2) >> 2);
+		buf[1] += (s8)((((s[0] >> 8) & 0x3F) << 2) >> 2);
+		buf[2] += (s8)(((s[1] & 0x3F) << 2) >> 2);
+		buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2);
+	}
+	out = (buf[0] & 0xFF) << 24 | (buf[1] & 0xFF) << 16 |
+		(buf[2] & 0xFF) << 8 | (buf[3] & 0xFF);
+
+	if (dev->phy.rev < 2)
+		b43_phy_write(dev, B43_NPHY_GPIO_SEL, save_regs_phy[8]);
+
+	if (dev->phy.rev >= 3) {
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1,
+				save_regs_phy[0]);
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2,
+				save_regs_phy[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[2]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[3]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, save_regs_phy[4]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[5]);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, save_regs_phy[6]);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, save_regs_phy[7]);
+	}
+
+	return out;
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:13:34 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:13:34 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
Message-ID: <op.u6b70wtk9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |  159 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 158 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d7e408b..b39b817 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -810,7 +810,164 @@ static int b43_nphy_poll_rssi(struct b43_wldev *dev, u8 type, s32 *buf,
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
-	//TODO
+	int i, j;
+	u8 state[4];
+	u8 code, val;
+	u16 class, override;
+	u8 regs_save_radio[2];
+	u16 regs_save_phy[2];
+	s8 offset[4];
+
+	u16 clip_state[2];
+	u16 clip_off[2] = { 0xFFFF, 0xFFFF };
+	s32 results_min[4];
+	u8 vcm_final[4];
+	s32 results[4][4];
+	s32 miniq[4][2];
+	memset(results_min, 0, sizeof(s32) * 4);
+	memset(vcm_final, 0, sizeof(u8) * 4);
+	memset(results, 0, sizeof(s32) * 4 * 4);
+	memset(miniq, 0, sizeof(s32) * 4 * 2);
+
+	if (type == 2) {
+		code = 0;
+		val = 6;
+	} else if (type < 2) {
+		code = 25;
+		val = 4;
+	} else {
+		B43_WARN_ON(1);
+		return;
+	}
+
+	class = b43_nphy_classifier(dev, 0, 0);
+	b43_nphy_classifier(dev, 7, 4);
+	b43_nphy_read_clip_detection(dev, clip_state);
+	b43_nphy_write_clip_detection(dev, clip_off);
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
+		override = 0x140;
+	else
+		override = 0x110;
+
+	regs_save_phy[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+	regs_save_radio[0] = b43_radio_read16(dev, B2055_C1_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, override);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, val);
+
+	regs_save_phy[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+	regs_save_radio[1] = b43_radio_read16(dev, B2055_C2_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, override);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, val);
+
+	state[0] = b43_radio_read16(dev, B2055_C1_PD_RSSIMISC) & 0x07;
+	state[1] = b43_radio_read16(dev, B2055_C2_PD_RSSIMISC) & 0x07;
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, 0);
+	b43_radio_maskset(dev, B2055_C2_PD_RSSIMISC, 0xF8, 0);
+	state[2] = b43_radio_read16(dev, B2055_C1_SP_RSSI) & 0x07;
+	state[3] = b43_radio_read16(dev, B2055_C2_SP_RSSI) & 0x07;
+
+	b43_nphy_rssi_select(dev, 5, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 0, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 1, type);
+
+	for (i = 0; i < 4; i++) {
+		u8 tmp[4];
+		for (j = 0; j < 4; j++)
+			tmp[j] = i;
+		if (type != 1)
+			b43_nphy_set_rssi_2055_vcm(dev, type, tmp);
+		b43_nphy_poll_rssi(dev, type, results[i], 8);
+		if (type < 2)
+			for (j = 0; j < 2; j++)
+				miniq[i][j] = min(results[i][2 * j],
+						results[i][2 * j + 1]);
+	}
+
+	for (i = 0; i < 4; i++) {
+		s32 mind = 40;
+		u8 minvcm = 0;
+		s32 minpoll = 249;
+		s32 curr;
+		for (j = 0; j < 4; j++) {
+			if (type == 2)
+				curr = abs(results[j][i]);
+			else
+				curr = abs(miniq[j][i / 2] - code * 8);
+
+			if (curr < mind) {
+				mind = curr;
+				minvcm = j;
+			}
+
+			if (results[j][i] < minpoll)
+				minpoll = results[j][i];
+		}
+		results_min[i] = minpoll;
+		vcm_final[i] = minvcm;
+	}
+
+	if (type != 1)
+		b43_nphy_set_rssi_2055_vcm(dev, type, vcm_final);
+
+	for (i = 0; i < 4; i++) {
+		offset[i] = (code * 8) - results[vcm_final[i]][i];
+
+		if (offset[i] < 0)
+			offset[i] = -((abs(offset[i]) + 4) / 8);
+		else
+			offset[i] = (offset[i] + 4) / 8;
+
+		if (results_min[i] == 248)
+			offset[i] = code - 32;
+
+		if (i % 2 == 0)
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 1, 0,
+							type);
+		else
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 2, 1,
+							type);
+	}
+
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[0]);
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[1]);
+
+	switch (state[2]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 1, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 1, 0);
+		break;
+	case 2:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	}
+
+	switch (state[3]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 2, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 2, 0);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 2, 1);
+		break;
+	}
+
+	b43_nphy_rssi_select(dev, 0, type);
+
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs_save_phy[0]);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, regs_save_radio[0]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs_save_phy[1]);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, regs_save_radio[1]);
+
+	b43_nphy_classifier(dev, 7, class);
+	b43_nphy_write_clip_detection(dev, clip_state);
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:13:45 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:13:45 +0100
Subject: [PATCH 4/6] b43: N-PHY: add b43_nphy_rx_iq_coeffs and
	b43_nphy_tx_lp_fbw
Message-ID: <op.u6b707kg9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |   41 +++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    7 ++++++
  2 files changed, 47 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index b39b817..22e7432 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -454,6 +454,45 @@ static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqCoeffs */
+static void b43_nphy_rx_iq_coeffs(struct b43_wldev *dev, bool write,
+					struct b43_phy_n_iq_comp *pcomp)
+{
+	if (write) {
+		b43_phy_write(dev, B43_NPHY_C1_RXIQ_COMPA0, pcomp->a0);
+		b43_phy_write(dev, B43_NPHY_C1_RXIQ_COMPB0, pcomp->b0);
+		b43_phy_write(dev, B43_NPHY_C2_RXIQ_COMPA1, pcomp->a1);
+		b43_phy_write(dev, B43_NPHY_C2_RXIQ_COMPB1, pcomp->b1);
+	} else {
+		pcomp->a0 = b43_phy_read(dev, B43_NPHY_C1_RXIQ_COMPA0);
+		pcomp->b0 = b43_phy_read(dev, B43_NPHY_C1_RXIQ_COMPB0);
+		pcomp->a1 = b43_phy_read(dev, B43_NPHY_C2_RXIQ_COMPA1);
+		pcomp->b1 = b43_phy_read(dev, B43_NPHY_C2_RXIQ_COMPB1);
+	}
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */
+static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u16 tmp;
+	enum ieee80211_band band = b43_current_band(dev->wl);
+	bool ipa = (nphy->ipa2g_on && band == IEEE80211_BAND_2GHZ) ||
+			(nphy->ipa5g_on && band == IEEE80211_BAND_5GHZ);
+
+	if (dev->phy.rev >= 3) {
+		if (ipa) {
+			tmp = 4;
+			b43_phy_write(dev, B43_NPHY_TXF_40CO_B32S2,
+			      (((((tmp << 3) | tmp) << 3) | tmp) << 3) | tmp);
+		}
+
+		tmp = 1;
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S2,
+			      (((((tmp << 3) | tmp) << 3) | tmp) << 3) | tmp);
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
  static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  {
@@ -1212,7 +1251,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_TXMACDELAY, 0x0320);
  	if (phy->rev >= 3 && phy->rev <= 6)
  		b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x0014);
-	//TODO N PHY TX LP FBW
+	b43_nphy_tx_lp_fbw(dev);
  	//TODO N PHY Spur Workaround

  	b43err(dev->wl, "IEEE 802.11n devices are not supported, yet.\n");
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index ca1fd11..e2479c5 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -924,6 +924,13 @@

  struct b43_wldev;

+struct b43_phy_n_iq_comp {
+	s16 a0;
+	s16 b0;
+	s16 a1;
+	s16 b1;
+};
+
  struct b43_phy_n_rssical_cache {
  	u16 rssical_radio_regs_2G[2];
  	u16 rssical_phy_regs_2G[12];
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:13:54 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:13:54 +0100
Subject: [PATCH 5/6] b43: N-PHY: add calibration restore
Message-ID: <op.u6b71gdb9lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |   70 +++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |   11 ++++++
  2 files changed, 80 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 22e7432..577c626 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1073,6 +1073,74 @@ static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, rssical_phy_regs[11]);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */
+static void b43_nphy_restore_cal(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 coef[4];
+	u16 *loft = NULL;
+	u16 *table = NULL;
+
+	int i;
+	u16 *txcal_radio_regs = NULL;
+	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+		if (nphy->iqcal_chanspec_2G == 0)
+			return;
+		table = nphy->cal_cache.txcal_coeffs_2G;
+		loft = &nphy->cal_cache.txcal_coeffs_2G[5];
+	} else {
+		if (nphy->iqcal_chanspec_5G == 0)
+			return;
+		table = nphy->cal_cache.txcal_coeffs_5G;
+		loft = &nphy->cal_cache.txcal_coeffs_5G[5];
+	}
+
+	//TODO: Write an N PHY table with ID 15, length 4, offset 80, width 16, and data from table
+
+	for (i = 0; i < 4; i++) {
+		if (dev->phy.rev >= 3)
+			table[i] = coef[i];
+		else
+			coef[i] = 0;
+	}
+
+	//TODO: Write an N PHY table with ID 15, length 4, offset 88, width 16, and data from coef
+	//TODO: Write an N PHY table with ID 15, length 2, offset 85, width 16 and data from loft
+	//TODO: Write an N PHY table with ID 15, length 2, offset 93, width 16 and data from loft
+
+	if (dev->phy.rev < 2)
+		;//TODO: Call N PHY TX IQ Workaround
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;
+		rxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_2G;
+	} else {
+		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_5G;
+		rxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_5G;
+	}
+
+	/* TODO use some definitions */
+	if (dev->phy.rev >= 3) {
+		b43_radio_write(dev, 0x2021, txcal_radio_regs[0]);
+		b43_radio_write(dev, 0x2022, txcal_radio_regs[1]);
+		b43_radio_write(dev, 0x3021, txcal_radio_regs[2]);
+		b43_radio_write(dev, 0x3022, txcal_radio_regs[3]);
+		b43_radio_write(dev, 0x2023, txcal_radio_regs[4]);
+		b43_radio_write(dev, 0x2024, txcal_radio_regs[5]);
+		b43_radio_write(dev, 0x3023, txcal_radio_regs[6]);
+		b43_radio_write(dev, 0x3024, txcal_radio_regs[7]);
+	} else {
+		b43_radio_write(dev, 0x8B, txcal_radio_regs[0]);
+		b43_radio_write(dev, 0xBA, txcal_radio_regs[1]);
+		b43_radio_write(dev, 0x8D, txcal_radio_regs[2]);
+		b43_radio_write(dev, 0xBC, txcal_radio_regs[3]);
+	}
+	b43_nphy_rx_iq_coeffs(dev, true, rxcal_coeffs);
+}
+
  /* Init N-PHY
   * http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N
   */
@@ -1241,7 +1309,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  				//TODO N PHY Periodic Calibration with argument 3
  			}
  		} else {
-			//TODO N PHY Restore Calibration
+			b43_nphy_restore_cal(dev);
  		}
  	}

diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e2479c5..b23987c 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -939,6 +939,16 @@ struct b43_phy_n_rssical_cache {
  	u16 rssical_phy_regs_5G[12];
  };

+struct b43_phy_n_cal_cache {
+	u16 txcal_radio_regs_2G[8];
+	u16 txcal_coeffs_2G[8];
+	struct b43_phy_n_iq_comp rxcal_coeffs_2G;
+
+	u16 txcal_radio_regs_5G[8];
+	u16 txcal_coeffs_5G[8];
+	struct b43_phy_n_iq_comp rxcal_coeffs_5G;
+};
+
  struct b43_phy_n {
  	u8 txpwrctrl;
  	u8 cal_orig_pwr_idx[2];
@@ -964,6 +974,7 @@ struct b43_phy_n {
  	u8 rssical_chanspec_5G;

  	struct b43_phy_n_rssical_cache rssical_cache;
+	struct b43_phy_n_cal_cache cal_cache;

  	bool crsminpwr_adjusted;
  	bool noisevars_adjusted;
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:14:05 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:14:05 +0100
Subject: [PATCH 6/6] b43: N-PHY: little fixes in init code
Message-ID: <op.u6b71res9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |   16 ++++++++++------
  drivers/net/wireless/b43/phy_n.h |   15 +++++++++++++++
  2 files changed, 25 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 577c626..962a675 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1220,9 +1220,11 @@ int b43_phy_initn(struct b43_wldev *dev)
  	if ((nphy->ipa2g_on && tmp2 == IEEE80211_BAND_2GHZ) ||
  	    (nphy->ipa5g_on && tmp2 == IEEE80211_BAND_5GHZ)) {
  		b43_phy_set(dev, B43_NPHY_PAPD_EN0, 0x1);
-		//FIXME b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ0, 0x007F, nphy->papd_epsilon_offset[0] << 7);
+		b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ0, 0x007F,
+				nphy->papd_epsilon_offset[0] << 7);
  		b43_phy_set(dev, B43_NPHY_PAPD_EN1, 0x1);
-		//FIXME b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F, nphy->papd_epsilon_offset[1] << 7);
+		b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F,
+				nphy->papd_epsilon_offset[1] << 7);
  		//TODO N PHY IPA Set TX Dig Filters
  	} else if (phy->rev >= 5) {
  		//TODO N PHY Ext PA Set TX Dig Filters
@@ -1260,9 +1262,9 @@ int b43_phy_initn(struct b43_wldev *dev)
  	}

  	if (nphy->phyrxchain != 3)
-		//TODO N PHY RX Core Set State with phyrxchain as argument
+		;//TODO N PHY RX Core Set State with phyrxchain as argument
  	if (nphy->mphase_cal_phase_id > 0)
-		//TODO PHY Periodic Calibration Multi-Phase Restart
+		;//TODO PHY Periodic Calibration Multi-Phase Restart

  	do_rssi_cal = false;
  	if (phy->rev >= 3) {
@@ -1297,8 +1299,10 @@ int b43_phy_initn(struct b43_wldev *dev)
  			if (nphy->perical != 2) {
  				b43_nphy_rssi_cal(dev);
  				if (phy->rev >= 3) {
-					//FIXME: nphy->cal_orig_pwr_idx[0] = nphy->txpwrindex[0].index_internal;
-					//FIXME: nphy->cal_orig_pwr_idx[1] = nphy->txpwrindex[1].index_internal;
+					nphy->cal_orig_pwr_idx[0] =
+					    nphy->txpwrindex[0].index_internal;
+					nphy->cal_orig_pwr_idx[1] =
+					    nphy->txpwrindex[1].index_internal;
  					//TODO N PHY Pre Calibrate TX Gain
  					target = b43_nphy_get_tx_gains(dev);
  				}
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index b23987c..491ff88 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -949,14 +949,29 @@ struct b43_phy_n_cal_cache {
  	struct b43_phy_n_iq_comp rxcal_coeffs_5G;
  };

+struct b43_phy_n_txpwrindex {
+	s8 index;
+	s8 index_internal;
+	s8 index_internal_save;
+	u16 AfectrlOverride;
+	u16 AfeCtrlDacGain;
+	u16 rad_gain;
+	u8 bbmult;
+	u16 iqcomp_a;
+	u16 iqcomp_b;
+	u16 locomp;
+};
+
  struct b43_phy_n {
  	u8 txpwrctrl;
  	u8 cal_orig_pwr_idx[2];
+	struct b43_phy_n_txpwrindex txpwrindex[2];
  	u8 measure_hold;
  	u8 phyrxchain;
  	u8 perical;
  	u8 mphase_cal_phase_id;
  	u8 antsel_type;
+	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
  	bool hang_avoid;
  	bool mute;
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 10 23:19:47 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 10 Jan 2010 23:19:47 +0100
Subject: b43 patches sets
Message-ID: <b170af451001101419x3907983dn5bd41b41998f00b5@mail.gmail.com>

In case you've lost in my patches submission, I've generated following
(bigger) sets:

http://estudent.put.poznan.pl/rafal.milecki/b43-1/
http://estudent.put.poznan.pl/rafal.milecki/b43-2/

-- 
Rafa?


From mb at bu3sch.de  Sun Jan 10 23:32:21 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 10 Jan 2010 23:32:21 +0100
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
In-Reply-To: <op.u6b70ig59lhzdc@linux-g0th.site>
References: <op.u6b70ig59lhzdc@linux-g0th.site>
Message-ID: <201001102332.22954.mb@bu3sch.de>

On Sunday 10 January 2010 23:13:20 Rafa? Mi?ecki wrote:
> +		buf[0] += (s8)(((s[0] & 0x3F) << 2) >> 2);
> +		buf[1] += (s8)((((s[0] >> 8) & 0x3F) << 2) >> 2);
> +		buf[2] += (s8)(((s[1] & 0x3F) << 2) >> 2);
> +		buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2);

I suggest buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2)
;)
No, seriously, why shift left and then shift right? Is this a translation error?
I _guess_ it's some mistranslation of the sign extension going on.
Or alternatively a compiler going insane on sign extension.

The question is: Do we want these integers to be signextended or not?

What we currently do is this:
buf[3] += (s8)((s[1] >> 8) & 0x3F);

which will always result in a positive 8bit integer, as far as I can see.
Which smells fishy.

-- 
Greetings, Michael.


From mb at bu3sch.de  Sun Jan 10 23:38:26 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 10 Jan 2010 23:38:26 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <op.u6b70wtk9lhzdc@linux-g0th.site>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
Message-ID: <201001102338.28721.mb@bu3sch.de>

On Sunday 10 January 2010 23:13:34 Rafa? Mi?ecki wrote:
> +	s32 results_min[4];
> +	u8 vcm_final[4];
> +	s32 results[4][4];
> +	s32 miniq[4][2];
> +	memset(results_min, 0, sizeof(s32) * 4);
> +	memset(vcm_final, 0, sizeof(u8) * 4);
> +	memset(results, 0, sizeof(s32) * 4 * 4);
> +	memset(miniq, 0, sizeof(s32) * 4 * 2);

Just initialize the variables to zero instead of doing a memset:

+	s32 results_min[4] = { 0, };
+	u8 vcm_final[4] = { 0, };
+	s32 results[4][4] = { 0, };
+	s32 miniq[4][2] = { 0, };

> +	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, 0);
> +	b43_radio_maskset(dev, B2055_C2_PD_RSSIMISC, 0xF8, 0);

If you don't set anything, you can use
b43_radio_mask();

-- 
Greetings, Michael.


From E.A.B.Piel at tudelft.nl  Sun Jan 10 23:51:36 2010
From: E.A.B.Piel at tudelft.nl (=?UTF-8?B?w4lyaWMgUGllbA==?=)
Date: Sun, 10 Jan 2010 23:51:36 +0100
Subject: Impossible to associate with WPA with a LP-PHY
Message-ID: <4B4A59F8.40803@tudelft.nl>

Hello,

I've got a bcm43 with LP-PHY (14e4:4315, rev 01). The b43 driver seems
to work fine (since 2.6.32), excepted when WPA is used. When there is no
encryption, or just WEP, there is no problem. However, when I try to
connect to a AP with WPA (which works from Windows, and also with the wl
driver), it fails to associate. wpa_cli shows me this messages repeatedly:
<2>Trying to associate with 00:18:84:15:d3:3e (SSID='MyPlace9' freq=2412
MHz)
<2>Authentication with 00:18:84:15:d3:3e timed out.

There doesn't seem to be any interesting error message in dmesg.
I've just tried with Linus'git head, and it's the same result. The
firmware loaded is noted as 478.104 in dmesg.

What can I do to try to debug this?
Thanks,
Eric


From Larry.Finger at lwfinger.net  Mon Jan 11 00:56:33 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 10 Jan 2010 17:56:33 -0600
Subject: Impossible to associate with WPA with a LP-PHY
In-Reply-To: <4B4A59F8.40803@tudelft.nl>
References: <4B4A59F8.40803@tudelft.nl>
Message-ID: <4B4A6931.6050107@lwfinger.net>

On 01/10/2010 04:51 PM, ?ric Piel wrote:
> Hello,
> 
> I've got a bcm43 with LP-PHY (14e4:4315, rev 01). The b43 driver seems
> to work fine (since 2.6.32), excepted when WPA is used. When there is no
> encryption, or just WEP, there is no problem. However, when I try to
> connect to a AP with WPA (which works from Windows, and also with the wl
> driver), it fails to associate. wpa_cli shows me this messages repeatedly:
> <2>Trying to associate with 00:18:84:15:d3:3e (SSID='MyPlace9' freq=2412
> MHz)
> <2>Authentication with 00:18:84:15:d3:3e timed out.
> 
> There doesn't seem to be any interesting error message in dmesg.
> I've just tried with Linus'git head, and it's the same result. The
> firmware loaded is noted as 478.104 in dmesg.
> 
> What can I do to try to debug this?

The problem is not general. I use b43 with a 4315 device with WPA or WPA2
without difficulty.

Are you using NetworkManager? If so, look at /var/log/NetworkManager. If not,
then you need to start wpa_supplicant separately with the -ddd option.

Larry


From Larry.Finger at lwfinger.net  Mon Jan 11 01:27:48 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 10 Jan 2010 18:27:48 -0600
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
In-Reply-To: <201001102332.22954.mb@bu3sch.de>
References: <op.u6b70ig59lhzdc@linux-g0th.site>
	<201001102332.22954.mb@bu3sch.de>
Message-ID: <4B4A7084.8010309@lwfinger.net>

On 01/10/2010 04:32 PM, Michael Buesch wrote:
> On Sunday 10 January 2010 23:13:20 Rafa? Mi?ecki wrote:
>> +		buf[0] += (s8)(((s[0] & 0x3F) << 2) >> 2);
>> +		buf[1] += (s8)((((s[0] >> 8) & 0x3F) << 2) >> 2);
>> +		buf[2] += (s8)(((s[1] & 0x3F) << 2) >> 2);
>> +		buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2);
> 
> I suggest buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2)
> ;)
> No, seriously, why shift left and then shift right? Is this a translation error?
> I _guess_ it's some mistranslation of the sign extension going on.
> Or alternatively a compiler going insane on sign extension.
> 
> The question is: Do we want these integers to be signextended or not?
> 
> What we currently do is this:
> buf[3] += (s8)((s[1] >> 8) & 0x3F);
> 
> which will always result in a positive 8bit integer, as far as I can see.
> Which smells fishy.

We do want sign extension of the signed 6-bit quantities into an 8-bit word. The
translation is correct. Do you know of a better way to extend the signs?

Larry


From mb at bu3sch.de  Mon Jan 11 01:53:08 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jan 2010 01:53:08 +0100
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
In-Reply-To: <4B4A7084.8010309@lwfinger.net>
References: <op.u6b70ig59lhzdc@linux-g0th.site>
	<201001102332.22954.mb@bu3sch.de> <4B4A7084.8010309@lwfinger.net>
Message-ID: <201001110153.09503.mb@bu3sch.de>

On Monday 11 January 2010 01:27:48 Larry Finger wrote:
> On 01/10/2010 04:32 PM, Michael Buesch wrote:
> > On Sunday 10 January 2010 23:13:20 Rafa? Mi?ecki wrote:
> >> +		buf[0] += (s8)(((s[0] & 0x3F) << 2) >> 2);
> >> +		buf[1] += (s8)((((s[0] >> 8) & 0x3F) << 2) >> 2);
> >> +		buf[2] += (s8)(((s[1] & 0x3F) << 2) >> 2);
> >> +		buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2);
> > 
> > I suggest buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2)
> > ;)
> > No, seriously, why shift left and then shift right? Is this a translation error?
> > I _guess_ it's some mistranslation of the sign extension going on.
> > Or alternatively a compiler going insane on sign extension.
> > 
> > The question is: Do we want these integers to be signextended or not?
> > 
> > What we currently do is this:
> > buf[3] += (s8)((s[1] >> 8) & 0x3F);
> > 
> > which will always result in a positive 8bit integer, as far as I can see.
> > Which smells fishy.
> 
> We do want sign extension of the signed 6-bit quantities into an 8-bit word. The
> translation is correct. Do you know of a better way to extend the signs?

Well, I think you got the parenthesis and cast wrong then.
I think what we want is the following:

+		buf[3] += (s8)(((s[1] >> 8) & 0x3F) << 2) >> 2;

The code is different and the specs, too.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Mon Jan 11 03:38:53 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 10 Jan 2010 20:38:53 -0600
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
In-Reply-To: <201001102332.22954.mb@bu3sch.de>
References: <op.u6b70ig59lhzdc@linux-g0th.site>
	<201001102332.22954.mb@bu3sch.de>
Message-ID: <4B4A8F3D.6010200@lwfinger.net>

On 01/10/2010 04:32 PM, Michael Buesch wrote:
> On Sunday 10 January 2010 23:13:20 Rafa? Mi?ecki wrote:
>> +		buf[0] += (s8)(((s[0] & 0x3F) << 2) >> 2);
>> +		buf[1] += (s8)((((s[0] >> 8) & 0x3F) << 2) >> 2);
>> +		buf[2] += (s8)(((s[1] & 0x3F) << 2) >> 2);
>> +		buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2);
> 
> I suggest buf[3] += (s8)((((s[1] >> 8) & 0x3F) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2) << 2) >> 2)
> ;)
> No, seriously, why shift left and then shift right? Is this a translation error?
> I _guess_ it's some mistranslation of the sign extension going on.
> Or alternatively a compiler going insane on sign extension.
> 
> The question is: Do we want these integers to be signextended or not?
> 
> What we currently do is this:
> buf[3] += (s8)((s[1] >> 8) & 0x3F);
> 
> which will always result in a positive 8bit integer, as far as I can see.
> Which smells fishy.

Yes, my fault. The specs are now corrected so that these statements are

((s8)((s[1] >> 8) & 0x3F) << 2) >> 2

I think that is right.

Larry


From mb at bu3sch.de  Mon Jan 11 11:08:19 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jan 2010 11:08:19 +0100
Subject: [PATCH 2/6] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
In-Reply-To: <4B4A8F3D.6010200@lwfinger.net>
References: <op.u6b70ig59lhzdc@linux-g0th.site>
	<201001102332.22954.mb@bu3sch.de> <4B4A8F3D.6010200@lwfinger.net>
Message-ID: <201001111108.21701.mb@bu3sch.de>

On Monday 11 January 2010 03:38:53 Larry Finger wrote:
> Yes, my fault. The specs are now corrected so that these statements are
> 
> ((s8)((s[1] >> 8) & 0x3F) << 2) >> 2
> 
> I think that is right.

No it is not.

You need to do this:
(s8)(((s[1] >> 8) & 0x3F) << 2) >> 2

Alternatively add another pair of parenthesis to make it clearer:

((s8)(((s[1] >> 8) & 0x3F) << 2)) >> 2

This basically shifts left unsigned and then shifts right _arithmetically_.
In your example, the compiler will optimize both shifts away (it may actually
also optimize the shifts in my case, but the sign extension will persist.

Just try it and you'll see:

mb at homer:~$ cat t.c
#include <stdio.h>
#include <stdint.h>

int main()
{
        int8_t s0;
        int8_t s1;
        uint8_t u;

        u = 0x3D;

        s0 = ((int8_t)(u & 0x3F) << 2) >> 2;
        s1 = ((int8_t)((u & 0x3F) << 2)) >> 2;

        printf("%d %d\n", s0, s1);
}
mb at homer:~$ gcc -o t t.c
mb at homer:~$ ./t
61 -3


-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan 11 22:13:31 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 11 Jan 2010 22:13:31 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <201001102338.28721.mb@bu3sch.de>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001102338.28721.mb@bu3sch.de>
Message-ID: <b170af451001111313r6bc6905fg722fcd42d7f2681a@mail.gmail.com>

2010/1/10 Michael Buesch <mb at bu3sch.de>:
> On Sunday 10 January 2010 23:13:34 Rafa? Mi?ecki wrote:
>> + ? ? s32 results_min[4];
>> + ? ? u8 vcm_final[4];
>> + ? ? s32 results[4][4];
>> + ? ? s32 miniq[4][2];
>> + ? ? memset(results_min, 0, sizeof(s32) * 4);
>> + ? ? memset(vcm_final, 0, sizeof(u8) * 4);
>> + ? ? memset(results, 0, sizeof(s32) * 4 * 4);
>> + ? ? memset(miniq, 0, sizeof(s32) * 4 * 2);
>
> Just initialize the variables to zero instead of doing a memset:
>
> + ? ? ? s32 results_min[4] = { 0, };
> + ? ? ? u8 vcm_final[4] = { 0, };
> + ? ? ? s32 results[4][4] = { 0, };
> + ? ? ? s32 miniq[4][2] = { 0, };

Nice trick, thanks :) Just for two-dimensional arrays I'll have to hack it to:
s32 results[4][4] = { { 0, }, { 0, }, { 0, }, { 0, } };
I believe.


>> + ? ? b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, 0);
>> + ? ? b43_radio_maskset(dev, B2055_C2_PD_RSSIMISC, 0xF8, 0);
>
> If you don't set anything, you can use
> b43_radio_mask();

Sure I can ;) Thanks.

-- 
Rafa?


From zajec5 at gmail.com  Mon Jan 11 22:18:13 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 11 Jan 2010 22:18:13 +0100
Subject: [PATCH 2/6 V2] b43: N-PHY: add RSSI functions: poll and set 2055 vcm
Message-ID: <op.u6dz4mz09lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   96 ++++++++++++++++++++++++++++++++++++++
  1 files changed, 96 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index a44fca1..214cf54 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -711,6 +711,102 @@ static void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRssi2055Vcm */
+static void b43_nphy_set_rssi_2055_vcm(struct b43_wldev *dev, u8 type, u8 *buf)
+{
+	int i;
+	for (i = 0; i < 2; i++) {
+		if (type == 2) {
+			if (i == 0) {
+				b43_radio_maskset(dev, B2055_C1_B0NB_RSSIVCM,
+						  0xFC, buf[0]);
+				b43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,
+						  0xFC, buf[1]);
+			} else {
+				b43_radio_maskset(dev, B2055_C2_B0NB_RSSIVCM,
+						  0xFC, buf[2 * i]);
+				b43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,
+						  0xFC, buf[2 * i + 1]);
+			}
+		} else {
+			if (i == 0)
+				b43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,
+						  0xF3, buf[0] << 2);
+			else
+				b43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,
+						  0xF3, buf[2 * i + 1] << 2);
+		}
+	}
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PollRssi */
+static int b43_nphy_poll_rssi(struct b43_wldev *dev, u8 type, s32 *buf,
+				u8 nsamp)
+{
+	int i;
+	int out;
+	u16 save_regs_phy[9];
+	u16 s[2];
+
+	if (dev->phy.rev >= 3) {
+		save_regs_phy[0] = b43_phy_read(dev,
+						B43_NPHY_RFCTL_LUT_TRSW_UP1);
+		save_regs_phy[1] = b43_phy_read(dev,
+						B43_NPHY_RFCTL_LUT_TRSW_UP2);
+		save_regs_phy[2] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
+		save_regs_phy[3] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
+		save_regs_phy[4] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
+		save_regs_phy[5] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		save_regs_phy[6] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S0);
+		save_regs_phy[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B32S1);
+	}
+
+	b43_nphy_rssi_select(dev, 5, type);
+
+	if (dev->phy.rev < 2) {
+		save_regs_phy[8] = b43_phy_read(dev, B43_NPHY_GPIO_SEL);
+		b43_phy_write(dev, B43_NPHY_GPIO_SEL, 5);
+	}
+
+	for (i = 0; i < 4; i++)
+		buf[i] = 0;
+
+	for (i = 0; i < nsamp; i++) {
+		if (dev->phy.rev < 2) {
+			s[0] = b43_phy_read(dev, B43_NPHY_GPIO_LOOUT);
+			s[1] = b43_phy_read(dev, B43_NPHY_GPIO_HIOUT);
+		} else {
+			s[0] = b43_phy_read(dev, B43_NPHY_RSSI1);
+			s[1] = b43_phy_read(dev, B43_NPHY_RSSI2);
+		}
+
+		buf[0] += ((s8)((s[0] & 0x3F) << 2)) >> 2;
+		buf[1] += ((s8)(((s[0] >> 8) & 0x3F) << 2)) >> 2;
+		buf[2] += ((s8)((s[1] & 0x3F) << 2)) >> 2;
+		buf[3] += ((s8)(((s[1] >> 8) & 0x3F) << 2)) >> 2;
+	}
+	out = (buf[0] & 0xFF) << 24 | (buf[1] & 0xFF) << 16 |
+		(buf[2] & 0xFF) << 8 | (buf[3] & 0xFF);
+
+	if (dev->phy.rev < 2)
+		b43_phy_write(dev, B43_NPHY_GPIO_SEL, save_regs_phy[8]);
+
+	if (dev->phy.rev >= 3) {
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1,
+				save_regs_phy[0]);
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2,
+				save_regs_phy[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[2]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[3]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, save_regs_phy[4]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[5]);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, save_regs_phy[6]);
+		b43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, save_regs_phy[7]);
+	}
+
+	return out;
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 11 22:18:31 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 11 Jan 2010 22:18:31 +0100
Subject: [PATCH 3/6 V2] b43: N-PHY: add RSSI calculation for PHY rev < 3
Message-ID: <op.u6dz45nl9lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |  155 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 154 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 214cf54..a0e6d81 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -810,7 +810,160 @@ static int b43_nphy_poll_rssi(struct b43_wldev *dev, u8 type, s32 *buf,
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
-	//TODO
+	int i, j;
+	u8 state[4];
+	u8 code, val;
+	u16 class, override;
+	u8 regs_save_radio[2];
+	u16 regs_save_phy[2];
+	s8 offset[4];
+
+	u16 clip_state[2];
+	u16 clip_off[2] = { 0xFFFF, 0xFFFF };
+	s32 results_min[4] = { 0, };
+	u8 vcm_final[4] = { 0, };
+	s32 results[4][4] = { { 0, }, { 0, }, { 0, }, { 0, } };
+	s32 miniq[4][2] = { { 0, }, { 0, }, { 0, }, { 0, } };
+
+	if (type == 2) {
+		code = 0;
+		val = 6;
+	} else if (type < 2) {
+		code = 25;
+		val = 4;
+	} else {
+		B43_WARN_ON(1);
+		return;
+	}
+
+	class = b43_nphy_classifier(dev, 0, 0);
+	b43_nphy_classifier(dev, 7, 4);
+	b43_nphy_read_clip_detection(dev, clip_state);
+	b43_nphy_write_clip_detection(dev, clip_off);
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
+		override = 0x140;
+	else
+		override = 0x110;
+
+	regs_save_phy[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+	regs_save_radio[0] = b43_radio_read16(dev, B2055_C1_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, override);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, val);
+
+	regs_save_phy[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+	regs_save_radio[1] = b43_radio_read16(dev, B2055_C2_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, override);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, val);
+
+	state[0] = b43_radio_read16(dev, B2055_C1_PD_RSSIMISC) & 0x07;
+	state[1] = b43_radio_read16(dev, B2055_C2_PD_RSSIMISC) & 0x07;
+	b43_radio_mask(dev, B2055_C1_PD_RSSIMISC, 0xF8);
+	b43_radio_mask(dev, B2055_C2_PD_RSSIMISC, 0xF8);
+	state[2] = b43_radio_read16(dev, B2055_C1_SP_RSSI) & 0x07;
+	state[3] = b43_radio_read16(dev, B2055_C2_SP_RSSI) & 0x07;
+
+	b43_nphy_rssi_select(dev, 5, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 0, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 1, type);
+
+	for (i = 0; i < 4; i++) {
+		u8 tmp[4];
+		for (j = 0; j < 4; j++)
+			tmp[j] = i;
+		if (type != 1)
+			b43_nphy_set_rssi_2055_vcm(dev, type, tmp);
+		b43_nphy_poll_rssi(dev, type, results[i], 8);
+		if (type < 2)
+			for (j = 0; j < 2; j++)
+				miniq[i][j] = min(results[i][2 * j],
+						results[i][2 * j + 1]);
+	}
+
+	for (i = 0; i < 4; i++) {
+		s32 mind = 40;
+		u8 minvcm = 0;
+		s32 minpoll = 249;
+		s32 curr;
+		for (j = 0; j < 4; j++) {
+			if (type == 2)
+				curr = abs(results[j][i]);
+			else
+				curr = abs(miniq[j][i / 2] - code * 8);
+
+			if (curr < mind) {
+				mind = curr;
+				minvcm = j;
+			}
+
+			if (results[j][i] < minpoll)
+				minpoll = results[j][i];
+		}
+		results_min[i] = minpoll;
+		vcm_final[i] = minvcm;
+	}
+
+	if (type != 1)
+		b43_nphy_set_rssi_2055_vcm(dev, type, vcm_final);
+
+	for (i = 0; i < 4; i++) {
+		offset[i] = (code * 8) - results[vcm_final[i]][i];
+
+		if (offset[i] < 0)
+			offset[i] = -((abs(offset[i]) + 4) / 8);
+		else
+			offset[i] = (offset[i] + 4) / 8;
+
+		if (results_min[i] == 248)
+			offset[i] = code - 32;
+
+		if (i % 2 == 0)
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 1, 0,
+							type);
+		else
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 2, 1,
+							type);
+	}
+
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[0]);
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[1]);
+
+	switch (state[2]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 1, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 1, 0);
+		break;
+	case 2:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	}
+
+	switch (state[3]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 2, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 2, 0);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 2, 1);
+		break;
+	}
+
+	b43_nphy_rssi_select(dev, 0, type);
+
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs_save_phy[0]);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, regs_save_radio[0]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs_save_phy[1]);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, regs_save_radio[1]);
+
+	b43_nphy_classifier(dev, 7, class);
+	b43_nphy_write_clip_detection(dev, clip_state);
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */
-- 
1.6.4.2



From mb at bu3sch.de  Mon Jan 11 23:13:25 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jan 2010 23:13:25 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <b170af451001111313r6bc6905fg722fcd42d7f2681a@mail.gmail.com>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001102338.28721.mb@bu3sch.de>
	<b170af451001111313r6bc6905fg722fcd42d7f2681a@mail.gmail.com>
Message-ID: <201001112313.26197.mb@bu3sch.de>

On Monday 11 January 2010 22:13:31 Rafa? Mi?ecki wrote:
> 2010/1/10 Michael Buesch <mb at bu3sch.de>:
> > On Sunday 10 January 2010 23:13:34 Rafa? Mi?ecki wrote:
> >> + ? ? s32 results_min[4];
> >> + ? ? u8 vcm_final[4];
> >> + ? ? s32 results[4][4];
> >> + ? ? s32 miniq[4][2];
> >> + ? ? memset(results_min, 0, sizeof(s32) * 4);
> >> + ? ? memset(vcm_final, 0, sizeof(u8) * 4);
> >> + ? ? memset(results, 0, sizeof(s32) * 4 * 4);
> >> + ? ? memset(miniq, 0, sizeof(s32) * 4 * 2);
> >
> > Just initialize the variables to zero instead of doing a memset:
> >
> > + ? ? ? s32 results_min[4] = { 0, };
> > + ? ? ? u8 vcm_final[4] = { 0, };
> > + ? ? ? s32 results[4][4] = { 0, };
> > + ? ? ? s32 miniq[4][2] = { 0, };
> 
> Nice trick, thanks :) Just for two-dimensional arrays I'll have to hack it to:
> s32 results[4][4] = { { 0, }, { 0, }, { 0, }, { 0, } };
> I believe.

No I don't think so.
It's C standard that uninitialized elements on automatic variables are initialized
to zero, _if_ at least one element is initialized to something.
So if you init one element to 0, all others will be 0, too.
I think that should also work for multidimensional arrays. So my example
s32 results[4][4] = { 0, };
should do the right thing. Am I wrong?

Here's a test-program:


mb at maggie:~$ cat t.c
#include <stdio.h>
#include <stdint.h>

int main(void)
{
        int i, j;
        int32_t results[4][4]
#ifdef INIT_IT
= { 0, };
#else
;
#endif

        for (i = 0; i < 4; i++)
                for (j = 0; j < 4; j++)
                        printf("%d\n", results[i][j]);

}
mb at maggie:~$ gcc -o t t.c
mb at maggie:~$ ./t
0
0
0
1
-1077483840
0
0
0
-1077483824
268436224
268536212
0
-1077483776
268436888
268353524
0
mb at maggie:~$ gcc -D INIT_IT -o t t.c
mb at maggie:~$ ./t
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0

-- 
Greetings, Michael.


From johannes at sipsolutions.net  Mon Jan 11 23:19:52 2010
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 11 Jan 2010 23:19:52 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <201001112313.26197.mb@bu3sch.de>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001102338.28721.mb@bu3sch.de>
	<b170af451001111313r6bc6905fg722fcd42d7f2681a@mail.gmail.com>
	<201001112313.26197.mb@bu3sch.de>
Message-ID: <1263248392.29743.13.camel@johannes.local>

On Mon, 2010-01-11 at 23:13 +0100, Michael Buesch wrote:

> No I don't think so.
> It's C standard that uninitialized elements on automatic variables are
> initialized
> to zero, _if_ at least one element is initialized to something.
> So if you init one element to 0, all others will be 0, too.

AFAIK, you don't even have to init anything, since otherwise not
mentioned fields will be set to 0. Hence, just = {} is sufficient for
arrays and will hopefully compile to the same code as an explicit
memset().

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100111/11821427/attachment.pgp>

From mb at bu3sch.de  Mon Jan 11 23:23:58 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jan 2010 23:23:58 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <1263248392.29743.13.camel@johannes.local>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001112313.26197.mb@bu3sch.de>
	<1263248392.29743.13.camel@johannes.local>
Message-ID: <201001112323.58399.mb@bu3sch.de>

On Monday 11 January 2010 23:19:52 Johannes Berg wrote:
> On Mon, 2010-01-11 at 23:13 +0100, Michael Buesch wrote:
> 
> > No I don't think so.
> > It's C standard that uninitialized elements on automatic variables are
> > initialized
> > to zero, _if_ at least one element is initialized to something.
> > So if you init one element to 0, all others will be 0, too.
> 
> AFAIK, you don't even have to init anything, since otherwise not
> mentioned fields will be set to 0. Hence, just = {} is sufficient for
> arrays and will hopefully compile to the same code as an explicit
> memset().

Oh, nice. You are right, indeed. I didn't know that.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan 11 23:27:18 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 11 Jan 2010 23:27:18 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <201001112313.26197.mb@bu3sch.de>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001102338.28721.mb@bu3sch.de>
	<b170af451001111313r6bc6905fg722fcd42d7f2681a@mail.gmail.com>
	<201001112313.26197.mb@bu3sch.de>
Message-ID: <b170af451001111427u25861f2bla4062a7b0aea19ec@mail.gmail.com>

W dniu 11 stycznia 2010 23:13 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Monday 11 January 2010 22:13:31 Rafa? Mi?ecki wrote:
>> 2010/1/10 Michael Buesch <mb at bu3sch.de>:
>> > On Sunday 10 January 2010 23:13:34 Rafa? Mi?ecki wrote:
>> >> + ? ? s32 results_min[4];
>> >> + ? ? u8 vcm_final[4];
>> >> + ? ? s32 results[4][4];
>> >> + ? ? s32 miniq[4][2];
>> >> + ? ? memset(results_min, 0, sizeof(s32) * 4);
>> >> + ? ? memset(vcm_final, 0, sizeof(u8) * 4);
>> >> + ? ? memset(results, 0, sizeof(s32) * 4 * 4);
>> >> + ? ? memset(miniq, 0, sizeof(s32) * 4 * 2);
>> >
>> > Just initialize the variables to zero instead of doing a memset:
>> >
>> > + ? ? ? s32 results_min[4] = { 0, };
>> > + ? ? ? u8 vcm_final[4] = { 0, };
>> > + ? ? ? s32 results[4][4] = { 0, };
>> > + ? ? ? s32 miniq[4][2] = { 0, };
>>
>> Nice trick, thanks :) Just for two-dimensional arrays I'll have to hack it to:
>> s32 results[4][4] = { { 0, }, { 0, }, { 0, }, { 0, } };
>> I believe.
>
> No I don't think so.
> It's C standard that uninitialized elements on automatic variables are initialized
> to zero, _if_ at least one element is initialized to something.
> So if you init one element to 0, all others will be 0, too.
> I think that should also work for multidimensional arrays. So my example
> s32 results[4][4] = { 0, };
> should do the right thing. Am I wrong?

Whoops, I should have explained what I mean. I am not sure what CFLAGS
"make" picks for compiled but I get:

  CC [M]  drivers/net/wireless/b43/phy_n.o
drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_rssi_cal?:
drivers/net/wireless/b43/phy_n.c:887: warning: missing braces around initializer
drivers/net/wireless/b43/phy_n.c:887: warning: (near initialization
for ?results[0]?)

for s32 results[4][4] = { 0, };

-- 
Rafa?


From mb at bu3sch.de  Mon Jan 11 23:42:07 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jan 2010 23:42:07 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <b170af451001111427u25861f2bla4062a7b0aea19ec@mail.gmail.com>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001112313.26197.mb@bu3sch.de>
	<b170af451001111427u25861f2bla4062a7b0aea19ec@mail.gmail.com>
Message-ID: <201001112342.08099.mb@bu3sch.de>

On Monday 11 January 2010 23:27:18 Rafa? Mi?ecki wrote:
> Whoops, I should have explained what I mean. I am not sure what CFLAGS
> "make" picks for compiled but I get:
> 
>   CC [M]  drivers/net/wireless/b43/phy_n.o
> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_rssi_cal?:
> drivers/net/wireless/b43/phy_n.c:887: warning: missing braces around initializer
> drivers/net/wireless/b43/phy_n.c:887: warning: (near initialization
> for ?results[0]?)
> 
> for s32 results[4][4] = { 0, };
> 

But does this work?
s32 results[4][4] = { };

-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan 11 23:43:00 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 11 Jan 2010 23:43:00 +0100
Subject: [PATCH 3/6] b43: N-PHY: add RSSI calculation for PHY rev < 3
In-Reply-To: <201001112342.08099.mb@bu3sch.de>
References: <op.u6b70wtk9lhzdc@linux-g0th.site>
	<201001112313.26197.mb@bu3sch.de>
	<b170af451001111427u25861f2bla4062a7b0aea19ec@mail.gmail.com>
	<201001112342.08099.mb@bu3sch.de>
Message-ID: <b170af451001111443g2c504ea4v63e54d9ad6e0b418@mail.gmail.com>

W dniu 11 stycznia 2010 23:42 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Monday 11 January 2010 23:27:18 Rafa? Mi?ecki wrote:
>> Whoops, I should have explained what I mean. I am not sure what CFLAGS
>> "make" picks for compiled but I get:
>>
>> ? CC [M] ?drivers/net/wireless/b43/phy_n.o
>> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_rssi_cal?:
>> drivers/net/wireless/b43/phy_n.c:887: warning: missing braces around initializer
>> drivers/net/wireless/b43/phy_n.c:887: warning: (near initialization
>> for ?results[0]?)
>>
>> for s32 results[4][4] = { 0, };
>>
>
> But does this work?
> s32 results[4][4] = { };

Yes, this compiles fine, and I believe it works fine :)

-- 
Rafa?


From zajec5 at gmail.com  Tue Jan 12 00:23:50 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 12 Jan 2010 00:23:50 +0100
Subject: [PATCH 3/6 V3] b43: N-PHY: add RSSI calculation for PHY rev < 3
Message-ID: <op.u6d5x0fk9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com
---
  drivers/net/wireless/b43/phy_n.c |  155 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 154 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 214cf54..fbee776 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -810,7 +810,160 @@ static int b43_nphy_poll_rssi(struct b43_wldev *dev, u8 type, s32 *buf,
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
  static void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, u8 type)
  {
-	//TODO
+	int i, j;
+	u8 state[4];
+	u8 code, val;
+	u16 class, override;
+	u8 regs_save_radio[2];
+	u16 regs_save_phy[2];
+	s8 offset[4];
+
+	u16 clip_state[2];
+	u16 clip_off[2] = { 0xFFFF, 0xFFFF };
+	s32 results_min[4] = { };
+	u8 vcm_final[4] = { };
+	s32 results[4][4] = { };
+	s32 miniq[4][2] = { };
+
+	if (type == 2) {
+		code = 0;
+		val = 6;
+	} else if (type < 2) {
+		code = 25;
+		val = 4;
+	} else {
+		B43_WARN_ON(1);
+		return;
+	}
+
+	class = b43_nphy_classifier(dev, 0, 0);
+	b43_nphy_classifier(dev, 7, 4);
+	b43_nphy_read_clip_detection(dev, clip_state);
+	b43_nphy_write_clip_detection(dev, clip_off);
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
+		override = 0x140;
+	else
+		override = 0x110;
+
+	regs_save_phy[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+	regs_save_radio[0] = b43_radio_read16(dev, B2055_C1_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, override);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, val);
+
+	regs_save_phy[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+	regs_save_radio[1] = b43_radio_read16(dev, B2055_C2_PD_RXTX);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, override);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, val);
+
+	state[0] = b43_radio_read16(dev, B2055_C1_PD_RSSIMISC) & 0x07;
+	state[1] = b43_radio_read16(dev, B2055_C2_PD_RSSIMISC) & 0x07;
+	b43_radio_mask(dev, B2055_C1_PD_RSSIMISC, 0xF8);
+	b43_radio_mask(dev, B2055_C2_PD_RSSIMISC, 0xF8);
+	state[2] = b43_radio_read16(dev, B2055_C1_SP_RSSI) & 0x07;
+	state[3] = b43_radio_read16(dev, B2055_C2_SP_RSSI) & 0x07;
+
+	b43_nphy_rssi_select(dev, 5, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 0, type);
+	b43_nphy_scale_offset_rssi(dev, 0, 0, 5, 1, type);
+
+	for (i = 0; i < 4; i++) {
+		u8 tmp[4];
+		for (j = 0; j < 4; j++)
+			tmp[j] = i;
+		if (type != 1)
+			b43_nphy_set_rssi_2055_vcm(dev, type, tmp);
+		b43_nphy_poll_rssi(dev, type, results[i], 8);
+		if (type < 2)
+			for (j = 0; j < 2; j++)
+				miniq[i][j] = min(results[i][2 * j],
+						results[i][2 * j + 1]);
+	}
+
+	for (i = 0; i < 4; i++) {
+		s32 mind = 40;
+		u8 minvcm = 0;
+		s32 minpoll = 249;
+		s32 curr;
+		for (j = 0; j < 4; j++) {
+			if (type == 2)
+				curr = abs(results[j][i]);
+			else
+				curr = abs(miniq[j][i / 2] - code * 8);
+
+			if (curr < mind) {
+				mind = curr;
+				minvcm = j;
+			}
+
+			if (results[j][i] < minpoll)
+				minpoll = results[j][i];
+		}
+		results_min[i] = minpoll;
+		vcm_final[i] = minvcm;
+	}
+
+	if (type != 1)
+		b43_nphy_set_rssi_2055_vcm(dev, type, vcm_final);
+
+	for (i = 0; i < 4; i++) {
+		offset[i] = (code * 8) - results[vcm_final[i]][i];
+
+		if (offset[i] < 0)
+			offset[i] = -((abs(offset[i]) + 4) / 8);
+		else
+			offset[i] = (offset[i] + 4) / 8;
+
+		if (results_min[i] == 248)
+			offset[i] = code - 32;
+
+		if (i % 2 == 0)
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 1, 0,
+							type);
+		else
+			b43_nphy_scale_offset_rssi(dev, 0, offset[i], 2, 1,
+							type);
+	}
+
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[0]);
+	b43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[1]);
+
+	switch (state[2]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 1, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 1, 0);
+		break;
+	case 2:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 1, 1);
+		break;
+	}
+
+	switch (state[3]) {
+	case 1:
+		b43_nphy_rssi_select(dev, 2, 2);
+		break;
+	case 4:
+		b43_nphy_rssi_select(dev, 2, 0);
+		break;
+	default:
+		b43_nphy_rssi_select(dev, 2, 1);
+		break;
+	}
+
+	b43_nphy_rssi_select(dev, 0, type);
+
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs_save_phy[0]);
+	b43_radio_write16(dev, B2055_C1_PD_RXTX, regs_save_radio[0]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs_save_phy[1]);
+	b43_radio_write16(dev, B2055_C2_PD_RXTX, regs_save_radio[1]);
+
+	b43_nphy_classifier(dev, 7, class);
+	b43_nphy_write_clip_detection(dev, clip_state);
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */
-- 
1.6.4.2



From E.A.B.Piel at tudelft.nl  Tue Jan 12 10:32:21 2010
From: E.A.B.Piel at tudelft.nl (=?ISO-8859-1?Q?=C9ric_Piel?=)
Date: Tue, 12 Jan 2010 10:32:21 +0100
Subject: Impossible to associate with WPA with a LP-PHY
In-Reply-To: <4B4A6931.6050107@lwfinger.net>
References: <4B4A59F8.40803@tudelft.nl> <4B4A6931.6050107@lwfinger.net>
Message-ID: <4B4C41A5.3010802@tudelft.nl>

Op 11-01-10 00:56, Larry Finger schreef:
> On 01/10/2010 04:51 PM, ?ric Piel wrote:
>> Hello,
>>
>> I've got a bcm43 with LP-PHY (14e4:4315, rev 01). The b43 driver seems
>> to work fine (since 2.6.32), excepted when WPA is used. When there is no
>> encryption, or just WEP, there is no problem. However, when I try to
>> connect to a AP with WPA (which works from Windows, and also with the wl
>> driver), it fails to associate. wpa_cli shows me this messages repeatedly:
>> <2>Trying to associate with 00:18:84:15:d3:3e (SSID='MyPlace9' freq=2412
>> MHz)
>> <2>Authentication with 00:18:84:15:d3:3e timed out.
>>
>> There doesn't seem to be any interesting error message in dmesg.
>> I've just tried with Linus'git head, and it's the same result. The
>> firmware loaded is noted as 478.104 in dmesg.
>>
>> What can I do to try to debug this?
> 
> The problem is not general. I use b43 with a 4315 device with WPA or WPA2
> without difficulty.
> 
> Are you using NetworkManager? If so, look at /var/log/NetworkManager. If not,
> then you need to start wpa_supplicant separately with the -ddd option.
I'm using Mandriva's network manager (which is basically just a frontend
to wpa_supplicant). However, now that I try just with wpa_supplicant, it
works fine!

I'll investigate a bit further, it's probably a bug in the frontend.
Thanks a lot,
Eric


From Larry.Finger at lwfinger.net  Tue Jan 12 18:14:23 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 12 Jan 2010 11:14:23 -0600
Subject: Impossible to associate with WPA with a LP-PHY
In-Reply-To: <4B4C41A5.3010802@tudelft.nl>
References: <4B4A59F8.40803@tudelft.nl> <4B4A6931.6050107@lwfinger.net>
	<4B4C41A5.3010802@tudelft.nl>
Message-ID: <4B4CADEF.4080707@lwfinger.net>

On 01/12/2010 03:32 AM, ?ric Piel wrote:
> Op 11-01-10 00:56, Larry Finger schreef:
>> On 01/10/2010 04:51 PM, ?ric Piel wrote:
>>> Hello,
>>>
>>> I've got a bcm43 with LP-PHY (14e4:4315, rev 01). The b43 driver seems
>>> to work fine (since 2.6.32), excepted when WPA is used. When there is no
>>> encryption, or just WEP, there is no problem. However, when I try to
>>> connect to a AP with WPA (which works from Windows, and also with the wl
>>> driver), it fails to associate. wpa_cli shows me this messages repeatedly:
>>> <2>Trying to associate with 00:18:84:15:d3:3e (SSID='MyPlace9' freq=2412
>>> MHz)
>>> <2>Authentication with 00:18:84:15:d3:3e timed out.
>>>
>>> There doesn't seem to be any interesting error message in dmesg.
>>> I've just tried with Linus'git head, and it's the same result. The
>>> firmware loaded is noted as 478.104 in dmesg.
>>>
>>> What can I do to try to debug this?
>>
>> The problem is not general. I use b43 with a 4315 device with WPA or WPA2
>> without difficulty.
>>
>> Are you using NetworkManager? If so, look at /var/log/NetworkManager. If not,
>> then you need to start wpa_supplicant separately with the -ddd option.
> I'm using Mandriva's network manager (which is basically just a frontend
> to wpa_supplicant). However, now that I try just with wpa_supplicant, it
> works fine!
> 
> I'll investigate a bit further, it's probably a bug in the frontend.

I don't use Mandriva, but the version of NetworkManager distributed with
openSUSE has had problems in the past.


From Larry.Finger at lwfinger.net  Tue Jan 12 19:58:17 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 12 Jan 2010 12:58:17 -0600
Subject: [PATCH] b43legacy: Declare all possible ucodeX.fw files
Message-ID: <4b4cc649.M2HTdPttXuQ/ZPlQ%Larry.Finger@lwfinger.net>

From: Tim Gardner <tim.gardner at canonical.com>

Enhance module information with the names of the firmware files
that could be used by this driver. This helps tools like Jockey to
correctly detect and/or install the firmware files relevant to
this driver.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This is 2.6.34 material.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-testing/drivers/net/wireless/b43legacy/main.c
@@ -61,6 +61,8 @@ MODULE_AUTHOR("Michael Buesch");
 MODULE_LICENSE("GPL");
 
 MODULE_FIRMWARE(B43legacy_SUPPORTED_FIRMWARE_ID);
+MODULE_FIRMWARE("b43legacy/ucode2.fw");
+MODULE_FIRMWARE("b43legacy/ucode4.fw");
 
 #if defined(CONFIG_B43LEGACY_DMA) && defined(CONFIG_B43LEGACY_PIO)
 static int modparam_pio;


From zajec5 at gmail.com  Tue Jan 12 20:38:07 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 12 Jan 2010 20:38:07 +0100
Subject: [PATCH 1/3] b43: N-PHY: add b43_nphy_rx_iq_est and
	b43_nphy_tx_iq_workaround
Message-ID: <op.u6fp5shd9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   59 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 58 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c244ddf..7b2468d 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -31,6 +31,8 @@


  struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
+struct nphy_iq_est { s32 iq0_prod; u32 i0_pwr; u32 q0_pwr; s32 iq1_prod;
+			u32 i1_pwr; u32 q1_pwr; };

  void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
  {//TODO
@@ -471,6 +473,61 @@ static void b43_nphy_rx_iq_coeffs(struct b43_wldev *dev, bool write,
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */
+static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
+				u16 samps, u8 time, bool wait)
+{
+	int i;
+	u16 tmp;
+
+	b43_phy_write(dev, B43_NPHY_IQEST_SAMCNT, samps);
+	b43_phy_maskset(dev, B43_NPHY_IQEST_WT, ~B43_NPHY_IQEST_WT_VAL, time);
+	if (wait)
+		b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
+	else
+		b43_phy_mask(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
+
+	b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_START);
+
+	for (i = 1000; i; i--) {
+		tmp = b43_phy_read(dev, B43_NPHY_IQEST_CMD);
+		if (!(tmp & B43_NPHY_IQEST_CMD_START)) {
+			est->i0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO0);
+			est->q0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO0);
+			est->iq0_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO0);
+
+			est->i1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO1);
+			est->q1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO1);
+			est->iq1_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO1);
+			return;
+		}
+		udelay(10);
+	}
+	memset(est, 0, sizeof(*est));
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
+static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
+{
+	u16 array[4];
+	int i;
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x3C50);
+	for (i = 0; i < 4; i++)
+		array[i] = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+
+	b43_shm_write16(dev, B43_SHM_SHARED, 0x0700, array[0]);
+	b43_shm_write16(dev, B43_SHM_SHARED, 0x0702, array[1]);
+	b43_shm_write16(dev, B43_SHM_SHARED, 0x0704, array[2]);
+	b43_shm_write16(dev, B43_SHM_SHARED, 0x0706, array[3]);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */
  static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
  {
@@ -1108,7 +1165,7 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  	//TODO: Write an N PHY table with ID 15, length 2, offset 93, width 16 and data from loft

  	if (dev->phy.rev < 2)
-		;//TODO: Call N PHY TX IQ Workaround
+		b43_nphy_tx_iq_workaround(dev);

  	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
  		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Jan 12 20:38:20 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 12 Jan 2010 20:38:20 +0100
Subject: [PATCH 2/3] b43: N-PHY: add b43_nphy_iq_cal_gain_params
Message-ID: <op.u6fp56sg9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   40 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.c |   25 ++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    1 +
  3 files changed, 66 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 7b2468d..ea1af25 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -31,6 +31,8 @@


  struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
+struct nphy_iqcal_params { u16 txgm; u16 pga; u16 pad; u16 ipa; u16 cal_gain;
+				u16 ncorr[5]; };
  struct nphy_iq_est { s32 iq0_prod; u32 i0_pwr; u32 q0_pwr; s32 iq1_prod;
  			u32 i1_pwr; u32 q1_pwr; };

@@ -512,6 +514,44 @@ static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
  	memset(est, 0, sizeof(*est));
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */
+static void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,
+					struct nphy_txgains target,
+					struct nphy_iqcal_params *params)
+{
+	int i, j, indx;
+	u16 gain;
+
+	if (dev->phy.rev >= 3) {
+		params->txgm = target.txgm[core];
+		params->pga = target.pga[core];
+		params->pad = target.pad[core];
+		params->ipa = target.ipa[core];
+		params->cal_gain = (params->txgm << 12) | (params->pga << 8) |
+					(params->pad << 4) | (params->ipa);
+		for (j = 0; j < 5; j++)
+			params->ncorr[j] = 0x79;
+	} else {
+		gain = (target.pad[core]) | (target.pga[core] << 4) |
+			(target.txgm[core] << 8);
+
+		indx = (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) ?
+			1 : 0;
+		for (i = 0; i < 9; i++)
+			if (tbl_iqcal_gainparams[indx][i][0] == gain)
+				break;
+		i = min(i, 8);
+
+		params->txgm = tbl_iqcal_gainparams[indx][i][1];
+		params->pga = tbl_iqcal_gainparams[indx][i][2];
+		params->pad = tbl_iqcal_gainparams[indx][i][3];
+		params->cal_gain = (params->txgm << 7) | (params->pga << 4) |
+					(params->pad << 2);
+		for (j = 0; j < 4; j++)
+			params->ncorr[j] = tbl_iqcal_gainparams[indx][i][4 + j];
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
  static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  {
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 3779f1d..de8a609 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2721,6 +2721,31 @@ const u32 txpwrctrl_tx_gain_ipa_5g[] = {
  	0x70f70021, 0x70f70020, 0x70f70020, 0x70f7001f,
  };

+const u16 tbl_iqcal_gainparams[2][9][8] = {
+	{
+		{ 0x000, 0, 0, 2, 0x69, 0x69, 0x69, 0x69 },
+		{ 0x700, 7, 0, 0, 0x69, 0x69, 0x69, 0x69 },
+		{ 0x710, 7, 1, 0, 0x68, 0x68, 0x68, 0x68 },
+		{ 0x720, 7, 2, 0, 0x67, 0x67, 0x67, 0x67 },
+		{ 0x730, 7, 3, 0, 0x66, 0x66, 0x66, 0x66 },
+		{ 0x740, 7, 4, 0, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x741, 7, 4, 1, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x742, 7, 4, 2, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x743, 7, 4, 3, 0x65, 0x65, 0x65, 0x65 }
+	},
+	{
+		{ 0x000, 7, 0, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x700, 7, 0, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x710, 7, 1, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x720, 7, 2, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x730, 7, 3, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x740, 7, 4, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x741, 7, 4, 1, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x742, 7, 4, 2, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x743, 7, 4, 3, 0x78, 0x78, 0x78, 0x78 }
+	}
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 62b1745..86c394c 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -141,5 +141,6 @@ extern const u32 txpwrctrl_tx_gain_ipa[];
  extern const u32 txpwrctrl_tx_gain_ipa_rev5[];
  extern const u32 txpwrctrl_tx_gain_ipa_rev6[];
  extern const u32 txpwrctrl_tx_gain_ipa_5g[];
+extern const u16 tbl_iqcal_gainparams[2][9][8];

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Jan 12 20:38:56 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 12 Jan 2010 20:38:56 +0100
Subject: [PATCH 3/3] b43: N-PHY: add RX IQ calculation for rev < 3
Message-ID: <op.u6fp66hl9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---

Uh, bigger one. This patch causes false warning:
drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_cal_rx_iq?:
drivers/net/wireless/b43/phy_n.c:627: warning: large integer implicitly truncated to unsigned type

That's for:
b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS, ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));

It's inside loop i=0,1. I tried casting i on (u8) but this didn't help. Can we leave this? Or can sb share some trick to avoid this warning?

---
  drivers/net/wireless/b43/phy_n.c |  194 +++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 194 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index ea1af25..82c53b9 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -568,6 +568,198 @@ static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  	b43_shm_write16(dev, B43_SHM_SHARED, 0x0706, array[3]);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
+static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i, j, index;
+	u8 rfctl[2];
+	u8 afectl_core;
+	u16 tmp[6];
+	u16 cur_hpf1, cur_hpf2, cur_lna;
+	u32 real, imag;
+	enum ieee80211_band band;
+
+	u8 use;
+	u16 cur_hpf;
+	u16 lna[3] = { 3, 3, 1 };
+	u16 hpf1[3] = { 7, 2, 0 };
+	u16 hpf2[3] = { 2, 0, 0 };
+	u32 power[3];
+	u16 gain_save[2];
+	u16 cal_gain[2];
+	struct nphy_iqcal_params cal_params[2];
+	struct nphy_iq_est est;
+	int ret = 0;
+	bool playtone = true;
+	int desired = 13;
+
+	b43_nphy_stay_in_carrier_search(dev, 1);
+
+	if (dev->phy.rev < 2)
+		;//TODO: Call N PHY Reapply TX Cal Coeffs
+	//TODO: Read an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data gain_save
+	for (i = 0; i < 2; i++) {
+		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
+		cal_gain[i] = cal_params[i].cal_gain;
+	}
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data from cal_gain
+
+	for (i = 0; i < 2; i++) {
+		if (i == 0) {
+			rfctl[0] = B43_NPHY_RFCTL_INTC1;
+			rfctl[1] = B43_NPHY_RFCTL_INTC2;
+			afectl_core = B43_NPHY_AFECTL_C1;
+		} else {
+			rfctl[0] = B43_NPHY_RFCTL_INTC2;
+			rfctl[1] = B43_NPHY_RFCTL_INTC1;
+			afectl_core = B43_NPHY_AFECTL_C2;
+		}
+
+		tmp[1] = b43_phy_read(dev, B43_NPHY_RFSEQCA);
+		tmp[2] = b43_phy_read(dev, afectl_core);
+		tmp[3] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		tmp[4] = b43_phy_read(dev, rfctl[0]);
+		tmp[5] = b43_phy_read(dev, rfctl[1]);
+
+		b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS,
+				((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
+		b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,
+				(1 - i));
+		b43_phy_set(dev, afectl_core, 0x0006);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0006);
+
+		band = b43_current_band(dev->wl);
+
+		if (nphy->rxcalparams & 0xFF000000) {
+			if (band == IEEE80211_BAND_5GHZ)
+				b43_phy_write(dev, rfctl[0], 0x140);
+			else
+				b43_phy_write(dev, rfctl[0], 0x110);
+		} else {
+			if (band == IEEE80211_BAND_5GHZ)
+				b43_phy_write(dev, rfctl[0], 0x180);
+			else
+				b43_phy_write(dev, rfctl[0], 0x120);
+		}
+
+		if (band == IEEE80211_BAND_5GHZ)
+			b43_phy_write(dev, rfctl[1], 0x148);
+		else
+			b43_phy_write(dev, rfctl[1], 0x114);
+
+		if (nphy->rxcalparams & 0x10000) {
+			b43_radio_maskset(dev, B2055_C1_GENSPARE2, 0xFC,
+					(i + 1));
+			b43_radio_maskset(dev, B2055_C2_GENSPARE2, 0xFC,
+					(2 - i));
+		}
+
+		for (j = 0; i < 4; j++) {
+			if (j < 3) {
+				cur_lna = lna[j];
+				cur_hpf1 = hpf1[j];
+				cur_hpf2 = hpf2[j];
+			} else {
+				if (power[1] > 10000) {
+					use = 1;
+					cur_hpf = cur_hpf1;
+					index = 2;
+				} else {
+					if (power[0] > 10000) {
+						use = 1;
+						cur_hpf = cur_hpf1;
+						index = 1;
+					} else {
+						index = 0;
+						use = 2;
+						cur_hpf = cur_hpf2;
+					}
+				}
+				cur_lna = lna[index];
+				cur_hpf1 = hpf1[index];
+				cur_hpf2 = hpf2[index];
+				cur_hpf += desired - hweight32(power[index]);
+				cur_hpf = clamp_val(cur_hpf, 0, 10);
+				if (use == 1)
+					cur_hpf1 = cur_hpf;
+				else
+					cur_hpf2 = cur_hpf;
+			}
+
+			tmp[0] = ((cur_hpf2 << 8) | (cur_hpf1 << 4) |
+					(cur_lna << 2));
+			//TODO: Call N PHY RF Ctrl Override with 0x400, tmp[0], 3, 0 as arguments
+			//TODO: Call N PHY Force RF Seq with 2 as argument
+			//TODO: Call N PHT Stop Playback
+
+			if (playtone) {
+				//TODO: Call N PHY TX Tone with 4000, (nphy_rxcalparams & 0xffff), 0, 0 as arguments and save result as ret
+				playtone = false;
+			} else {
+				//TODO: Call N PHY Run Samples with 160, 0xFFFF, 0, 0, 0 as arguments
+			}
+
+			if (ret == 0) {
+				if (j < 3) {
+					b43_nphy_rx_iq_est(dev, &est, 1024, 32,
+									false);
+					if (i == 0) {
+						real = est.i0_pwr;
+						imag = est.q0_pwr;
+					} else {
+						real = est.i1_pwr;
+						imag = est.q1_pwr;
+					}
+					power[i] = ((real + imag) / 1024) + 1;
+				} else {
+					//TODO: Call N PHY Calc RX IQ Comp with (1 << i) as argument
+				}
+				//TODO: Call N PHY Stop Playback
+			}
+
+			if (ret != 0)
+				break;
+		}
+
+		b43_radio_mask(dev, B2055_C1_GENSPARE2, 0xFC);
+		b43_radio_mask(dev, B2055_C2_GENSPARE2, 0xFC);
+		b43_phy_write(dev, rfctl[1], tmp[5]);
+		b43_phy_write(dev, rfctl[0], tmp[4]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp[3]);
+		b43_phy_write(dev, afectl_core, tmp[2]);
+		b43_phy_write(dev, B43_NPHY_RFSEQCA, tmp[1]);
+
+		if (ret != 0)
+			break;
+	}
+
+	//TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments
+	//TODO: Call N PHY Force RF Seq with 2 as argument
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data from gain_save
+
+	b43_nphy_stay_in_carrier_search(dev, 0);
+
+	return ret;
+}
+
+static int b43_nphy_rev3_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	return -1;
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIq */
+static int b43_nphy_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	if (dev->phy.rev >= 3)
+		return b43_nphy_rev3_cal_rx_iq(dev, target, type, debug);
+	else
+		return b43_nphy_rev2_cal_rx_iq(dev, target, type, debug);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */
  static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
  {
@@ -1400,7 +1592,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  					target = b43_nphy_get_tx_gains(dev);
  				}
  				/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0
-					If the output of N PHY Cal RX Iqlo with target, 2 0 as arguments is 0
+					if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
  						Call N PHY Save Cal */
  			} else if (nphy->mphase_cal_phase_id == 0) {
  				//TODO N PHY Periodic Calibration with argument 3
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 491ff88..ab54b0f 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -973,6 +973,7 @@ struct b43_phy_n {
  	u8 antsel_type;
  	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
+	u32 rxcalparams;
  	bool hang_avoid;
  	bool mute;

-- 
1.6.4.2



From mb at bu3sch.de  Tue Jan 12 23:10:21 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 12 Jan 2010 23:10:21 +0100
Subject: [PATCH 1/3] b43: N-PHY: add b43_nphy_rx_iq_est and
	b43_nphy_tx_iq_workaround
In-Reply-To: <op.u6fp5shd9lhzdc@linux-g0th.site>
References: <op.u6fp5shd9lhzdc@linux-g0th.site>
Message-ID: <201001122310.21654.mb@bu3sch.de>

On Tuesday 12 January 2010 20:38:07 Rafa? Mi?ecki wrote:
>   struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
> +struct nphy_iq_est { s32 iq0_prod; u32 i0_pwr; u32 q0_pwr; s32 iq1_prod;
> +			u32 i1_pwr; u32 q1_pwr; };

So it seems I didn't notice this earlier, but this violates kernel coding style.
Please do a separate patch that converts all structs from
struct foo { a; b; c; };
to
struct foo {
	a;
	b;
	c;
};

> +	if (wait)
> +		b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
> +	else
> +		b43_phy_mask(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);

Looks wrong to me.
Do you want this?

+	if (wait)
+		b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
+	else
+		b43_phy_mask(dev, B43_NPHY_IQEST_CMD, ~B43_NPHY_IQEST_CMD_MODE);

> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
> +static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
> +{
> +	u16 array[4];
> +	int i;
> +
> +	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x3C50);
> +	for (i = 0; i < 4; i++)
> +		array[i] = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
> +
> +	b43_shm_write16(dev, B43_SHM_SHARED, 0x0700, array[0]);
> +	b43_shm_write16(dev, B43_SHM_SHARED, 0x0702, array[1]);
> +	b43_shm_write16(dev, B43_SHM_SHARED, 0x0704, array[2]);
> +	b43_shm_write16(dev, B43_SHM_SHARED, 0x0706, array[3]);

Do we have some names for the SHM locations?
If not, just do some defines.
#define B43_SHM_SH_NPHY_TXIQW0	0x0700
#define B43_SHM_SH_NPHY_TXIQW1	0x0702
...
in b43.h (next to the other SHM_SH defines)

-- 
Greetings, Michael.


From mb at bu3sch.de  Tue Jan 12 23:19:23 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 12 Jan 2010 23:19:23 +0100
Subject: [PATCH 3/3] b43: N-PHY: add RX IQ calculation for rev < 3
In-Reply-To: <op.u6fp66hl9lhzdc@linux-g0th.site>
References: <op.u6fp66hl9lhzdc@linux-g0th.site>
Message-ID: <201001122319.23626.mb@bu3sch.de>

On Tuesday 12 January 2010 20:38:56 Rafa? Mi?ecki wrote:
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> 
> Uh, bigger one. This patch causes false warning:
> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_cal_rx_iq?:
> drivers/net/wireless/b43/phy_n.c:627: warning: large integer implicitly truncated to unsigned type
> 
> That's for:

I think the warning is caused by

		b43_phy_maskset(dev, B43_NPHY_RFSEQCA,
	THIS>>>>>   ~B43_NPHY_RFSEQCA_RXDIS,
		((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));

Well, I think the warning is pretty much bogus, but I think it can be worked around
by doing
	(u16)~B43_NPHY_RFSEQCA_RXDIS


-- 
Greetings, Michael.


From zajec5 at gmail.com  Tue Jan 12 23:51:06 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 12 Jan 2010 23:51:06 +0100
Subject: [PATCH 1/3] b43: N-PHY: add b43_nphy_rx_iq_est and 
	b43_nphy_tx_iq_workaround
In-Reply-To: <201001122310.21654.mb@bu3sch.de>
References: <op.u6fp5shd9lhzdc@linux-g0th.site>
	<201001122310.21654.mb@bu3sch.de>
Message-ID: <b170af451001121451p73941b5ema0fb9be8685335ae@mail.gmail.com>

2010/1/12 Michael Buesch <mb at bu3sch.de>:
> On Tuesday 12 January 2010 20:38:07 Rafa? Mi?ecki wrote:
>> ? struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
>> +struct nphy_iq_est { s32 iq0_prod; u32 i0_pwr; u32 q0_pwr; s32 iq1_prod;
>> + ? ? ? ? ? ? ? ? ? ? u32 i1_pwr; u32 q1_pwr; };
>
> So it seems I didn't notice this earlier, but this violates kernel coding style.
> Please do a separate patch that converts all structs from
> struct foo { a; b; c; };
> to
> struct foo {
> ? ? ? ?a;
> ? ? ? ?b;
> ? ? ? ?c;
> };

OK, will do.


>> + ? ? if (wait)
>> + ? ? ? ? ? ? b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
>> + ? ? else
>> + ? ? ? ? ? ? b43_phy_mask(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
>
> Looks wrong to me.
> Do you want this?
>
> + ? ? ? if (wait)
> + ? ? ? ? ? ? ? b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
> + ? ? ? else
> + ? ? ? ? ? ? ? b43_phy_mask(dev, B43_NPHY_IQEST_CMD, ~B43_NPHY_IQEST_CMD_MODE);

Obviously. Copy&paste... I can changed function name. Thanks for catching :)


>> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
>> +static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
>> +{
>> + ? ? u16 array[4];
>> + ? ? int i;
>> +
>> + ? ? b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x3C50);
>> + ? ? for (i = 0; i < 4; i++)
>> + ? ? ? ? ? ? array[i] = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
>> +
>> + ? ? b43_shm_write16(dev, B43_SHM_SHARED, 0x0700, array[0]);
>> + ? ? b43_shm_write16(dev, B43_SHM_SHARED, 0x0702, array[1]);
>> + ? ? b43_shm_write16(dev, B43_SHM_SHARED, 0x0704, array[2]);
>> + ? ? b43_shm_write16(dev, B43_SHM_SHARED, 0x0706, array[3]);
>
> Do we have some names for the SHM locations?
> If not, just do some defines.
> #define B43_SHM_SH_NPHY_TXIQW0 ?0x0700
> #define B43_SHM_SH_NPHY_TXIQW1 ?0x0702
> ...
> in b43.h (next to the other SHM_SH defines)

Larry, do you have any other/better names?


-- 
Rafa?


From Larry.Finger at lwfinger.net  Wed Jan 13 14:31:37 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 13 Jan 2010 07:31:37 -0600
Subject: [PATCH 3/3] b43: N-PHY: add RX IQ calculation for rev < 3
In-Reply-To: <op.u6fp66hl9lhzdc@linux-g0th.site>
References: <op.u6fp66hl9lhzdc@linux-g0th.site>
Message-ID: <4B4DCB39.7030801@lwfinger.net>

On 01/12/2010 01:38 PM, Rafa? Mi?ecki wrote:
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> 
> Uh, bigger one. This patch causes false warning:
> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_cal_rx_iq?:
> drivers/net/wireless/b43/phy_n.c:627: warning: large integer implicitly truncated to unsigned type
> 
> That's for:
> b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS, ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
> 
> It's inside loop i=0,1. I tried casting i on (u8) but this didn't help. Can we leave this? Or can sb share some trick to avoid this warning?

It is ~B43_NPHY_RFSEQCA_RXDIS, not i, that causes the warning. Change the
statement to

b43_phy_maskset(dev, B43_NPHY_RFSEQCA, (u16)(~B43_NPHY_RFSEQCA_RXDIS),
               ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));

Larry




From zajec5 at gmail.com  Wed Jan 13 14:38:22 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 13 Jan 2010 14:38:22 +0100
Subject: [PATCH 3/3] b43: N-PHY: add RX IQ calculation for rev < 3
In-Reply-To: <4B4DCB39.7030801@lwfinger.net>
References: <op.u6fp66hl9lhzdc@linux-g0th.site> <4B4DCB39.7030801@lwfinger.net>
Message-ID: <b170af451001130538q79d431a6vd0eed9628356a40b@mail.gmail.com>

W dniu 13 stycznia 2010 14:31 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/12/2010 01:38 PM, Rafa? Mi?ecki wrote:
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>>
>> Uh, bigger one. This patch causes false warning:
>> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_cal_rx_iq?:
>> drivers/net/wireless/b43/phy_n.c:627: warning: large integer implicitly truncated to unsigned type
>>
>> That's for:
>> b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS, ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
>>
>> It's inside loop i=0,1. I tried casting i on (u8) but this didn't help. Can we leave this? Or can sb share some trick to avoid this warning?
>
> It is ~B43_NPHY_RFSEQCA_RXDIS, not i, that causes the warning. Change the
> statement to
>
> b43_phy_maskset(dev, B43_NPHY_RFSEQCA, (u16)(~B43_NPHY_RFSEQCA_RXDIS),
> ? ? ? ? ? ? ? ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));

Yeah, Michael already pointed that :)

-- 
Rafa?


From Larry.Finger at lwfinger.net  Wed Jan 13 15:26:16 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 13 Jan 2010 08:26:16 -0600
Subject: [PATCH 3/3] b43: N-PHY: add RX IQ calculation for rev < 3
In-Reply-To: <b170af451001130538q79d431a6vd0eed9628356a40b@mail.gmail.com>
References: <op.u6fp66hl9lhzdc@linux-g0th.site> <4B4DCB39.7030801@lwfinger.net>
	<b170af451001130538q79d431a6vd0eed9628356a40b@mail.gmail.com>
Message-ID: <4B4DD808.5080506@lwfinger.net>

On 01/13/2010 07:38 AM, Rafa? Mi?ecki wrote:
> W dniu 13 stycznia 2010 14:31 u?ytkownik Larry Finger
> <Larry.Finger at lwfinger.net> napisa?:
>> On 01/12/2010 01:38 PM, Rafa? Mi?ecki wrote:
>>>
>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>> ---
>>>
>>> Uh, bigger one. This patch causes false warning:
>>> drivers/net/wireless/b43/phy_n.c: In function ?b43_nphy_rev2_cal_rx_iq?:
>>> drivers/net/wireless/b43/phy_n.c:627: warning: large integer implicitly truncated to unsigned type
>>>
>>> That's for:
>>> b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS, ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
>>>
>>> It's inside loop i=0,1. I tried casting i on (u8) but this didn't help. Can we leave this? Or can sb share some trick to avoid this warning?
>>
>> It is ~B43_NPHY_RFSEQCA_RXDIS, not i, that causes the warning. Change the
>> statement to
>>
>> b43_phy_maskset(dev, B43_NPHY_RFSEQCA, (u16)(~B43_NPHY_RFSEQCA_RXDIS),
>>               ((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
> 
> Yeah, Michael already pointed that :)

For some reason, I lost my feed from linux-wireless. I found Michael's message
in the archives.

If I have not responded to any of your private messages, please send them again.
I'm not sure if the mail stoppage is general. There is no traffic from other
lists as well.

Larry


From zajec5 at gmail.com  Thu Jan 14 00:39:54 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 00:39:54 +0100
Subject: [PATCH 1/3] b43: N-PHY: add b43_nphy_rx_iq_est and 
	b43_nphy_tx_iq_workaround
In-Reply-To: <b170af451001121451p73941b5ema0fb9be8685335ae@mail.gmail.com>
References: <op.u6fp5shd9lhzdc@linux-g0th.site>
	<201001122310.21654.mb@bu3sch.de>
	<b170af451001121451p73941b5ema0fb9be8685335ae@mail.gmail.com>
Message-ID: <b170af451001131539p3974307fv8aad39a4ec71de9a@mail.gmail.com>

W dniu 12 stycznia 2010 23:51 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> 2010/1/12 Michael Buesch <mb at bu3sch.de>:
>> On Tuesday 12 January 2010 20:38:07 Rafa? Mi?ecki wrote:
>>> ? struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
>>> +struct nphy_iq_est { s32 iq0_prod; u32 i0_pwr; u32 q0_pwr; s32 iq1_prod;
>>> + ? ? ? ? ? ? ? ? ? ? u32 i1_pwr; u32 q1_pwr; };
>>
>> So it seems I didn't notice this earlier, but this violates kernel coding style.
>> Please do a separate patch that converts all structs from
>> struct foo { a; b; c; };
>> to
>> struct foo {
>> ? ? ? ?a;
>> ? ? ? ?b;
>> ? ? ? ?c;
>> };
>
> OK, will do.

I'll use separated patch to correct old wrong-styled definitions. No
reason to use wrong style when adding new struct with this patch.

-- 
Rafa?


From zajec5 at gmail.com  Thu Jan 14 00:54:13 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 00:54:13 +0100
Subject: [PATCH 1/3 v2] b43: N-PHY: add b43_nphy_rx_iq_est and
	b43_nphy_tx_iq_workaround
Message-ID: <op.u6hwok0u9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---

V2: Use definitions for SHM, fix mask and struct defitnion style.

---
  drivers/net/wireless/b43/b43.h   |    5 +++
  drivers/net/wireless/b43/phy_n.c |   66 +++++++++++++++++++++++++++++++++++++-
  2 files changed, 70 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/b43.h b/drivers/net/wireless/b43/b43.h
index 6607162..d5c67a6 100644
--- a/drivers/net/wireless/b43/b43.h
+++ b/drivers/net/wireless/b43/b43.h
@@ -255,6 +255,11 @@ enum {
  #define B43_SHM_SH_MAXBFRAMES		0x0080	/* Maximum number of frames in a burst */
  #define B43_SHM_SH_SPUWKUP		0x0094	/* pre-wakeup for synth PU in us */
  #define B43_SHM_SH_PRETBTT		0x0096	/* pre-TBTT in us */
+/* SHM_SHARED tx iq workarounds */
+#define B43_SHM_SH_NPHY_TXIQW0		0x0700
+#define B43_SHM_SH_NPHY_TXIQW1		0x0702
+#define B43_SHM_SH_NPHY_TXIQW2		0x0704
+#define B43_SHM_SH_NPHY_TXIQW3		0x0706

  /* SHM_SCRATCH offsets */
  #define B43_SHM_SC_MINCONT		0x0003	/* Minimum contention window */
diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c244ddf..db10a9f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -32,6 +32,15 @@

  struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };

+struct nphy_iq_est {
+	s32 iq0_prod;
+	u32 i0_pwr;
+	u32 q0_pwr;
+	s32 iq1_prod;
+	u32 i1_pwr;
+	u32 q1_pwr;
+};
+
  void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
  {//TODO
  }
@@ -471,6 +480,61 @@ static void b43_nphy_rx_iq_coeffs(struct b43_wldev *dev, bool write,
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */
+static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
+				u16 samps, u8 time, bool wait)
+{
+	int i;
+	u16 tmp;
+
+	b43_phy_write(dev, B43_NPHY_IQEST_SAMCNT, samps);
+	b43_phy_maskset(dev, B43_NPHY_IQEST_WT, ~B43_NPHY_IQEST_WT_VAL, time);
+	if (wait)
+		b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);
+	else
+		b43_phy_mask(dev, B43_NPHY_IQEST_CMD, ~B43_NPHY_IQEST_CMD_MODE);
+
+	b43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_START);
+
+	for (i = 1000; i; i--) {
+		tmp = b43_phy_read(dev, B43_NPHY_IQEST_CMD);
+		if (!(tmp & B43_NPHY_IQEST_CMD_START)) {
+			est->i0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO0);
+			est->q0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO0);
+			est->iq0_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI0) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO0);
+
+			est->i1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO1);
+			est->q1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO1);
+			est->iq1_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI1) << 16) |
+					b43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO1);
+			return;
+		}
+		udelay(10);
+	}
+	memset(est, 0, sizeof(*est));
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
+static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
+{
+	u16 array[4];
+	int i;
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x3C50);
+	for (i = 0; i < 4; i++)
+		array[i] = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+
+	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW0, array[0]);
+	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW1, array[1]);
+	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW2, array[2]);
+	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW3, array[3]);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */
  static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
  {
@@ -1108,7 +1172,7 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  	//TODO: Write an N PHY table with ID 15, length 2, offset 93, width 16 and data from loft

  	if (dev->phy.rev < 2)
-		;//TODO: Call N PHY TX IQ Workaround
+		b43_nphy_tx_iq_workaround(dev);

  	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
  		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 00:54:20 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 00:54:20 +0100
Subject: [PATCH 2/3 v2] b43: N-PHY: add b43_nphy_iq_cal_gain_params
Message-ID: <op.u6hwouhx9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---

V2: Update to apply after changes in 1/3

---
  drivers/net/wireless/b43/phy_n.c       |   47 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.c |   25 +++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    1 +
  3 files changed, 73 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index db10a9f..101ef39 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -32,6 +32,15 @@

  struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };

+struct nphy_iqcal_params {
+	u16 txgm;
+	u16 pga;
+	u16 pad;
+	u16 ipa;
+	u16 cal_gain;
+	u16 ncorr[5];
+};
+
  struct nphy_iq_est {
  	s32 iq0_prod;
  	u32 i0_pwr;
@@ -519,6 +528,44 @@ static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
  	memset(est, 0, sizeof(*est));
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */
+static void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,
+					struct nphy_txgains target,
+					struct nphy_iqcal_params *params)
+{
+	int i, j, indx;
+	u16 gain;
+
+	if (dev->phy.rev >= 3) {
+		params->txgm = target.txgm[core];
+		params->pga = target.pga[core];
+		params->pad = target.pad[core];
+		params->ipa = target.ipa[core];
+		params->cal_gain = (params->txgm << 12) | (params->pga << 8) |
+					(params->pad << 4) | (params->ipa);
+		for (j = 0; j < 5; j++)
+			params->ncorr[j] = 0x79;
+	} else {
+		gain = (target.pad[core]) | (target.pga[core] << 4) |
+			(target.txgm[core] << 8);
+
+		indx = (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) ?
+			1 : 0;
+		for (i = 0; i < 9; i++)
+			if (tbl_iqcal_gainparams[indx][i][0] == gain)
+				break;
+		i = min(i, 8);
+
+		params->txgm = tbl_iqcal_gainparams[indx][i][1];
+		params->pga = tbl_iqcal_gainparams[indx][i][2];
+		params->pad = tbl_iqcal_gainparams[indx][i][3];
+		params->cal_gain = (params->txgm << 7) | (params->pga << 4) |
+					(params->pad << 2);
+		for (j = 0; j < 4; j++)
+			params->ncorr[j] = tbl_iqcal_gainparams[indx][i][4 + j];
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
  static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  {
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 3779f1d..de8a609 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2721,6 +2721,31 @@ const u32 txpwrctrl_tx_gain_ipa_5g[] = {
  	0x70f70021, 0x70f70020, 0x70f70020, 0x70f7001f,
  };

+const u16 tbl_iqcal_gainparams[2][9][8] = {
+	{
+		{ 0x000, 0, 0, 2, 0x69, 0x69, 0x69, 0x69 },
+		{ 0x700, 7, 0, 0, 0x69, 0x69, 0x69, 0x69 },
+		{ 0x710, 7, 1, 0, 0x68, 0x68, 0x68, 0x68 },
+		{ 0x720, 7, 2, 0, 0x67, 0x67, 0x67, 0x67 },
+		{ 0x730, 7, 3, 0, 0x66, 0x66, 0x66, 0x66 },
+		{ 0x740, 7, 4, 0, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x741, 7, 4, 1, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x742, 7, 4, 2, 0x65, 0x65, 0x65, 0x65 },
+		{ 0x743, 7, 4, 3, 0x65, 0x65, 0x65, 0x65 }
+	},
+	{
+		{ 0x000, 7, 0, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x700, 7, 0, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x710, 7, 1, 0, 0x79, 0x79, 0x79, 0x79 },
+		{ 0x720, 7, 2, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x730, 7, 3, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x740, 7, 4, 0, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x741, 7, 4, 1, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x742, 7, 4, 2, 0x78, 0x78, 0x78, 0x78 },
+		{ 0x743, 7, 4, 3, 0x78, 0x78, 0x78, 0x78 }
+	}
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 62b1745..86c394c 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -141,5 +141,6 @@ extern const u32 txpwrctrl_tx_gain_ipa[];
  extern const u32 txpwrctrl_tx_gain_ipa_rev5[];
  extern const u32 txpwrctrl_tx_gain_ipa_rev6[];
  extern const u32 txpwrctrl_tx_gain_ipa_5g[];
+extern const u16 tbl_iqcal_gainparams[2][9][8];

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 00:54:31 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 00:54:31 +0100
Subject: [PATCH 3/3 v2] b43: N-PHY: add RX IQ calculation for rev < 3
Message-ID: <op.u6hwo5mt9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---

V2: get rid of warning by casting

---
  drivers/net/wireless/b43/phy_n.c |  195 +++++++++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 195 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 101ef39..d0a0ce9 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -582,6 +582,199 @@ static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW3, array[3]);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
+static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i, j, index;
+	u8 rfctl[2];
+	u8 afectl_core;
+	u16 tmp[6];
+	u16 cur_hpf1, cur_hpf2, cur_lna;
+	u32 real, imag;
+	enum ieee80211_band band;
+
+	u8 use;
+	u16 cur_hpf;
+	u16 lna[3] = { 3, 3, 1 };
+	u16 hpf1[3] = { 7, 2, 0 };
+	u16 hpf2[3] = { 2, 0, 0 };
+	u32 power[3];
+	u16 gain_save[2];
+	u16 cal_gain[2];
+	struct nphy_iqcal_params cal_params[2];
+	struct nphy_iq_est est;
+	int ret = 0;
+	bool playtone = true;
+	int desired = 13;
+
+	b43_nphy_stay_in_carrier_search(dev, 1);
+
+	if (dev->phy.rev < 2)
+		;//TODO: Call N PHY Reapply TX Cal Coeffs
+	//TODO: Read an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data gain_save
+	for (i = 0; i < 2; i++) {
+		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
+		cal_gain[i] = cal_params[i].cal_gain;
+	}
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data from cal_gain
+
+	for (i = 0; i < 2; i++) {
+		if (i == 0) {
+			rfctl[0] = B43_NPHY_RFCTL_INTC1;
+			rfctl[1] = B43_NPHY_RFCTL_INTC2;
+			afectl_core = B43_NPHY_AFECTL_C1;
+		} else {
+			rfctl[0] = B43_NPHY_RFCTL_INTC2;
+			rfctl[1] = B43_NPHY_RFCTL_INTC1;
+			afectl_core = B43_NPHY_AFECTL_C2;
+		}
+
+		tmp[1] = b43_phy_read(dev, B43_NPHY_RFSEQCA);
+		tmp[2] = b43_phy_read(dev, afectl_core);
+		tmp[3] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		tmp[4] = b43_phy_read(dev, rfctl[0]);
+		tmp[5] = b43_phy_read(dev, rfctl[1]);
+
+		b43_phy_maskset(dev, B43_NPHY_RFSEQCA,
+				(u16)~B43_NPHY_RFSEQCA_RXDIS,
+				((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
+		b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,
+				(1 - i));
+		b43_phy_set(dev, afectl_core, 0x0006);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0006);
+
+		band = b43_current_band(dev->wl);
+
+		if (nphy->rxcalparams & 0xFF000000) {
+			if (band == IEEE80211_BAND_5GHZ)
+				b43_phy_write(dev, rfctl[0], 0x140);
+			else
+				b43_phy_write(dev, rfctl[0], 0x110);
+		} else {
+			if (band == IEEE80211_BAND_5GHZ)
+				b43_phy_write(dev, rfctl[0], 0x180);
+			else
+				b43_phy_write(dev, rfctl[0], 0x120);
+		}
+
+		if (band == IEEE80211_BAND_5GHZ)
+			b43_phy_write(dev, rfctl[1], 0x148);
+		else
+			b43_phy_write(dev, rfctl[1], 0x114);
+
+		if (nphy->rxcalparams & 0x10000) {
+			b43_radio_maskset(dev, B2055_C1_GENSPARE2, 0xFC,
+					(i + 1));
+			b43_radio_maskset(dev, B2055_C2_GENSPARE2, 0xFC,
+					(2 - i));
+		}
+
+		for (j = 0; i < 4; j++) {
+			if (j < 3) {
+				cur_lna = lna[j];
+				cur_hpf1 = hpf1[j];
+				cur_hpf2 = hpf2[j];
+			} else {
+				if (power[1] > 10000) {
+					use = 1;
+					cur_hpf = cur_hpf1;
+					index = 2;
+				} else {
+					if (power[0] > 10000) {
+						use = 1;
+						cur_hpf = cur_hpf1;
+						index = 1;
+					} else {
+						index = 0;
+						use = 2;
+						cur_hpf = cur_hpf2;
+					}
+				}
+				cur_lna = lna[index];
+				cur_hpf1 = hpf1[index];
+				cur_hpf2 = hpf2[index];
+				cur_hpf += desired - hweight32(power[index]);
+				cur_hpf = clamp_val(cur_hpf, 0, 10);
+				if (use == 1)
+					cur_hpf1 = cur_hpf;
+				else
+					cur_hpf2 = cur_hpf;
+			}
+
+			tmp[0] = ((cur_hpf2 << 8) | (cur_hpf1 << 4) |
+					(cur_lna << 2));
+			//TODO: Call N PHY RF Ctrl Override with 0x400, tmp[0], 3, 0 as arguments
+			//TODO: Call N PHY Force RF Seq with 2 as argument
+			//TODO: Call N PHT Stop Playback
+
+			if (playtone) {
+				//TODO: Call N PHY TX Tone with 4000, (nphy_rxcalparams & 0xffff), 0, 0 as arguments and save result as ret
+				playtone = false;
+			} else {
+				//TODO: Call N PHY Run Samples with 160, 0xFFFF, 0, 0, 0 as arguments
+			}
+
+			if (ret == 0) {
+				if (j < 3) {
+					b43_nphy_rx_iq_est(dev, &est, 1024, 32,
+									false);
+					if (i == 0) {
+						real = est.i0_pwr;
+						imag = est.q0_pwr;
+					} else {
+						real = est.i1_pwr;
+						imag = est.q1_pwr;
+					}
+					power[i] = ((real + imag) / 1024) + 1;
+				} else {
+					//TODO: Call N PHY Calc RX IQ Comp with (1 << i) as argument
+				}
+				//TODO: Call N PHY Stop Playback
+			}
+
+			if (ret != 0)
+				break;
+		}
+
+		b43_radio_mask(dev, B2055_C1_GENSPARE2, 0xFC);
+		b43_radio_mask(dev, B2055_C2_GENSPARE2, 0xFC);
+		b43_phy_write(dev, rfctl[1], tmp[5]);
+		b43_phy_write(dev, rfctl[0], tmp[4]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp[3]);
+		b43_phy_write(dev, afectl_core, tmp[2]);
+		b43_phy_write(dev, B43_NPHY_RFSEQCA, tmp[1]);
+
+		if (ret != 0)
+			break;
+	}
+
+	//TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments
+	//TODO: Call N PHY Force RF Seq with 2 as argument
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data from gain_save
+
+	b43_nphy_stay_in_carrier_search(dev, 0);
+
+	return ret;
+}
+
+static int b43_nphy_rev3_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	return -1;
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIq */
+static int b43_nphy_cal_rx_iq(struct b43_wldev *dev,
+			struct nphy_txgains target, u8 type, bool debug)
+{
+	if (dev->phy.rev >= 3)
+		return b43_nphy_rev3_cal_rx_iq(dev, target, type, debug);
+	else
+		return b43_nphy_rev2_cal_rx_iq(dev, target, type, debug);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */
  static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
  {
@@ -1414,7 +1607,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  					target = b43_nphy_get_tx_gains(dev);
  				}
  				/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0
-					If the output of N PHY Cal RX Iqlo with target, 2 0 as arguments is 0
+					if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
  						Call N PHY Save Cal */
  			} else if (nphy->mphase_cal_phase_id == 0) {
  				//TODO N PHY Periodic Calibration with argument 3
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 491ff88..ab54b0f 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -973,6 +973,7 @@ struct b43_phy_n {
  	u8 antsel_type;
  	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
+	u32 rxcalparams;
  	bool hang_avoid;
  	bool mute;

-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 13:21:27 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 13:21:27 +0100
Subject: [PATCH 1/2] b43: make finding the most significant bit common function
Message-ID: <op.u6iu91z39lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_common.c |   14 ++++++++++++++
  drivers/net/wireless/b43/phy_common.h |    1 +
  drivers/net/wireless/b43/phy_lp.c     |   17 ++---------------
  3 files changed, 17 insertions(+), 15 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
index 75b26e1..1389ab2 100644
--- a/drivers/net/wireless/b43/phy_common.c
+++ b/drivers/net/wireless/b43/phy_common.c
@@ -421,3 +421,17 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on)
  {
  	b43_write16(dev, B43_MMIO_PHY0, on ? 0 : 0xF4);
  }
+
+/* Find the position of the most significant bit */
+u8 phy_nbits(s32 val)
+{
+	u32 tmp = abs(val);
+	u8 nbits = 0;
+
+	while (tmp != 0) {
+		nbits++;
+		tmp >>= 1;
+	}
+
+	return nbits;
+}
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index 9edd4e8..332ba4c 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -418,5 +418,6 @@ int b43_phy_shm_tssi_read(struct b43_wldev *dev, u16 shm_offset);
   */
  void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on);

+u8 phy_nbits(s32 val);

  #endif /* LINUX_B43_PHY_COMMON_H_ */
diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index c4e9c5c..7ad9215 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -1593,19 +1593,6 @@ static const struct lpphy_rx_iq_comp lpphy_rev2plus_iq_comp = {
  	.c0 = 0,
  };

-static u8 lpphy_nbits(s32 val)
-{
-	u32 tmp = abs(val);
-	u8 nbits = 0;
-
-	while (tmp != 0) {
-		nbits++;
-		tmp >>= 1;
-	}
-
-	return nbits;
-}
-
  static int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)
  {
  	struct lpphy_iq_est iq_est;
@@ -1632,8 +1619,8 @@ static int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)
  		goto out;
  	}

-	prod_msb = lpphy_nbits(prod);
-	q_msb = lpphy_nbits(qpwr);
+	prod_msb = phy_nbits(prod);
+	q_msb = phy_nbits(qpwr);
  	tmp1 = prod_msb - 20;

  	if (tmp1 >= 0) {
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 13:21:35 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 13:21:35 +0100
Subject: [PATCH 2/2] b43: N-PHY: follow kernel coding style for struct
	declaration
Message-ID: <op.u6iu99ct9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_common.c |   14 ++++++++++++++
  drivers/net/wireless/b43/phy_common.h |    1 +
  drivers/net/wireless/b43/phy_lp.c     |   17 ++---------------
  3 files changed, 17 insertions(+), 15 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
index 75b26e1..1389ab2 100644
--- a/drivers/net/wireless/b43/phy_common.c
+++ b/drivers/net/wireless/b43/phy_common.c
@@ -421,3 +421,17 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on)
  {
  	b43_write16(dev, B43_MMIO_PHY0, on ? 0 : 0xF4);
  }
+
+/* Find the position of the most significant bit */
+u8 phy_nbits(s32 val)
+{
+	u32 tmp = abs(val);
+	u8 nbits = 0;
+
+	while (tmp != 0) {
+		nbits++;
+		tmp >>= 1;
+	}
+
+	return nbits;
+}
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index 9edd4e8..332ba4c 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -418,5 +418,6 @@ int b43_phy_shm_tssi_read(struct b43_wldev *dev, u16 shm_offset);
   */
  void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on);

+u8 phy_nbits(s32 val);

  #endif /* LINUX_B43_PHY_COMMON_H_ */
diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index c4e9c5c..7ad9215 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -1593,19 +1593,6 @@ static const struct lpphy_rx_iq_comp lpphy_rev2plus_iq_comp = {
  	.c0 = 0,
  };

-static u8 lpphy_nbits(s32 val)
-{
-	u32 tmp = abs(val);
-	u8 nbits = 0;
-
-	while (tmp != 0) {
-		nbits++;
-		tmp >>= 1;
-	}
-
-	return nbits;
-}
-
  static int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)
  {
  	struct lpphy_iq_est iq_est;
@@ -1632,8 +1619,8 @@ static int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)
  		goto out;
  	}

-	prod_msb = lpphy_nbits(prod);
-	q_msb = lpphy_nbits(qpwr);
+	prod_msb = phy_nbits(prod);
+	q_msb = phy_nbits(qpwr);
  	tmp1 = prod_msb - 20;

  	if (tmp1 >= 0) {
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 16:46:42 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 16:46:42 +0100
Subject: [PATCH 2/2 resend] b43: N-PHY: follow kernel coding style for struct
	declaration
Message-ID: <op.u6i4r4ge9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---

Whoops, wrong patch attached previously

---
  drivers/net/wireless/b43/phy_n.c |    7 ++++++-
  1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d0a0ce9..fbdabfe 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -30,7 +30,12 @@
  #include "tables_nphy.h"


-struct nphy_txgains { u16 txgm[2]; u16 pga[2]; u16 pad[2]; u16 ipa[2]; };
+struct nphy_txgains {
+	u16 txgm[2];
+	u16 pga[2];
+	u16 pad[2];
+	u16 ipa[2];
+};

  struct nphy_iqcal_params {
  	u16 txgm;
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 16:47:06 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 16:47:06 +0100
Subject: [PATCH 2/2] b43: N-PHY: follow kernel coding style for struct 
	declaration
In-Reply-To: <20100114153944.GA3700@dhcp-lab-161.englab.brq.redhat.com>
References: <op.u6iu99ct9lhzdc@linux-g0th.site>
	<20100114153944.GA3700@dhcp-lab-161.englab.brq.redhat.com>
Message-ID: <b170af451001140747q2f7a4f3j4e8645b3f49f79eb@mail.gmail.com>

W dniu 14 stycznia 2010 16:39 u?ytkownik Stanislaw Gruszka
<sgruszka at redhat.com> napisa?:
> Hi
>
> On Thu, Jan 14, 2010 at 01:21:35PM +0100, Rafa? Mi?ecki wrote:
>>
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_common.c | ? 14 ++++++++++++++
>> ?drivers/net/wireless/b43/phy_common.h | ? ?1 +
>> ?drivers/net/wireless/b43/phy_lp.c ? ? | ? 17 ++---------------
>> ?3 files changed, 17 insertions(+), 15 deletions(-)
>
> Your second patch is the same as first one.

Whoops, thanks :)

-- 
Rafa?


From zajec5 at gmail.com  Thu Jan 14 23:42:44 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:42:44 +0100
Subject: [PATCH 1/6] b43: N-PHY: add b43_nphy_calc_rx_iq_comp
Message-ID: <op.u6jn1ijm9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |  101 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 100 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index fbdabfe..75eb0e6 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -533,6 +533,105 @@ static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
  	memset(est, 0, sizeof(*est));
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalcRxIqComp */
+static void b43_nphy_calc_rx_iq_comp(struct b43_wldev *dev, u8 mask)
+{
+	int i;
+	s32 iq;
+	u32 ii;
+	u32 qq;
+	int iq_nbits, qq_nbits;
+	int arsh, brsh;
+	u16 tmp, a, b;
+
+	struct nphy_iq_est est;
+	struct b43_phy_n_iq_comp old;
+	struct b43_phy_n_iq_comp new = { };
+	bool error = false;
+
+	if (mask == 0)
+		return;
+
+	b43_nphy_rx_iq_coeffs(dev, false, &old);
+	b43_nphy_rx_iq_coeffs(dev, true, &new);
+	b43_nphy_rx_iq_est(dev, &est, 0x4000, 32, false);
+	new = old;
+
+	for (i = 0; i < 2; i++) {
+		if (i == 0 && (mask & 1)) {
+			iq = est.iq0_prod;
+			ii = est.i0_pwr;
+			qq = est.q0_pwr;
+		} else if (i == 1 && (mask & 2)) {
+			iq = est.iq1_prod;
+			ii = est.i1_pwr;
+			qq = est.q1_pwr;
+		} else {
+			B43_WARN_ON(1);
+			continue;
+		}
+
+		if (ii + qq < 2) {
+			error = true;
+			break;
+		}
+
+		iq_nbits = phy_nbits(iq);
+		qq_nbits = phy_nbits(qq);
+
+		arsh = iq_nbits - 20;
+		if (arsh >= 0) {
+			a = -((iq << (30 - iq_nbits)) + (ii >> (1 + arsh)));
+			tmp = ii >> arsh;
+		} else {
+			a = -((iq << (30 - iq_nbits)) + (ii << (-1 - arsh)));
+			tmp = ii << -arsh;
+		}
+		if (tmp == 0) {
+			error = true;
+			break;
+		}
+		a /= tmp;
+
+		brsh = qq_nbits - 11;
+		if (brsh >= 0) {
+			b = (qq << (31 - qq_nbits));
+			tmp = ii >> brsh;
+		} else {
+			b = (qq << (31 - qq_nbits));
+			tmp = ii << -brsh;
+		}
+		if (tmp == 0) {
+			error = true;
+			break;
+		}
+		b = int_sqrt(b / tmp - a * a) - (1 << 10);
+
+		if (i == 0 && (mask & 0x1)) {
+			if (dev->phy.rev >= 3) {
+				new.a0 = a & 0x3FF;
+				new.b0 = b & 0x3FF;
+			} else {
+				new.a0 = b & 0x3FF;
+				new.b0 = a & 0x3FF;
+			}
+		} else if (i == 1 && (mask & 0x2)) {
+			if (dev->phy.rev >= 3) {
+				new.a1 = a & 0x3FF;
+				new.b1 = b & 0x3FF;
+			} else {
+				new.a1 = b & 0x3FF;
+				new.b1 = a & 0x3FF;
+			}
+		}
+	}
+
+	if (error)
+		new = old;
+
+	b43_nphy_rx_iq_coeffs(dev, true, &new);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */
  static void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,
  					struct nphy_txgains target,
@@ -734,7 +833,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  					}
  					power[i] = ((real + imag) / 1024) + 1;
  				} else {
-					//TODO: Call N PHY Calc RX IQ Comp with (1 << i) as argument
+					b43_nphy_calc_rx_iq_comp(dev, 1 << i);
  				}
  				//TODO: Call N PHY Stop Playback
  			}
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:42:55 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:42:55 +0100
Subject: [PATCH 2/6] b43: N-PHY: add TX cal radio setup for rev < 3
Message-ID: <op.u6jn1tvl9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   43 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 44 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 75eb0e6..77be96d 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -901,6 +901,49 @@ static void b43_nphy_tx_lp_fbw(struct b43_wldev *dev)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalRadioSetup */
+static void b43_nphy_tx_cal_radio_setup(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u16 *save = nphy->tx_rx_cal_radio_saveregs;
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	} else {
+		save[0] = b43_radio_read16(dev, B2055_C1_TX_RF_IQCAL1);
+		b43_radio_write16(dev, B2055_C1_TX_RF_IQCAL1, 0x29);
+
+		save[1] = b43_radio_read16(dev, B2055_C1_TX_RF_IQCAL2);
+		b43_radio_write16(dev, B2055_C1_TX_RF_IQCAL2, 0x54);
+
+		save[2] = b43_radio_read16(dev, B2055_C2_TX_RF_IQCAL1);
+		b43_radio_write16(dev, B2055_C2_TX_RF_IQCAL1, 0x29);
+
+		save[3] = b43_radio_read16(dev, B2055_C2_TX_RF_IQCAL2);
+		b43_radio_write16(dev, B2055_C2_TX_RF_IQCAL2, 0x54);
+
+		save[3] = b43_radio_read16(dev, B2055_C1_PWRDET_RXTX);
+		save[4] = b43_radio_read16(dev, B2055_C2_PWRDET_RXTX);
+
+		if (!(b43_phy_read(dev, B43_NPHY_BANDCTL) &
+		    B43_NPHY_BANDCTL_5GHZ)) {
+			b43_radio_write16(dev, B2055_C1_PWRDET_RXTX, 0x04);
+			b43_radio_write16(dev, B2055_C2_PWRDET_RXTX, 0x04);
+		} else {
+			b43_radio_write16(dev, B2055_C1_PWRDET_RXTX, 0x20);
+			b43_radio_write16(dev, B2055_C2_PWRDET_RXTX, 0x20);
+		}
+
+		if (dev->phy.rev < 2) {
+			b43_radio_set(dev, B2055_C1_TX_BB_MXGM, 0x20);
+			b43_radio_set(dev, B2055_C2_TX_BB_MXGM, 0x20);
+		} else {
+			b43_radio_mask(dev, B2055_C1_TX_BB_MXGM, ~0x20);
+			b43_radio_mask(dev, B2055_C2_TX_BB_MXGM, ~0x20);
+		}
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
  static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  {
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index ab54b0f..d435720 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -971,6 +971,7 @@ struct b43_phy_n {
  	u8 perical;
  	u8 mphase_cal_phase_id;
  	u8 antsel_type;
+	u16 tx_rx_cal_radio_saveregs[22];
  	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
  	u32 rxcalparams;
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:43:04 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:43:04 +0100
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
Message-ID: <op.u6jn12l09lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   23 +++++++++++++++++
  drivers/net/wireless/b43/phy_n.h       |    1 +
  drivers/net/wireless/b43/tables_nphy.c |   42 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    6 ++++
  4 files changed, 72 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 77be96d..67717c1 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -686,6 +686,29 @@ static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW3, array[3]);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/UpdateTxCalLadder */
+static void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i;
+	u16 scale, entry;
+
+	u16 tmp = nphy->txcal_bbmult;
+	if (core == 0)
+		tmp >>= 8;
+	tmp &= 0xff;
+
+	for (i = 0; i < 18; i++) {
+		scale = (ladder_lo[i].percent * tmp) / 100;
+		entry = ((scale & 0xFF) << 8) | ladder_lo[i].g_env;
+		//TODO: Write an N PHY Table with ID 15, length 1, offset i, width 16, and data entry
+
+		scale = (ladder_iq[i].percent * tmp) / 100;
+		entry = ((scale & 0xFF) << 8) | ladder_iq[i].g_env;
+		//TODO: Write an N PHY Table with ID 15, length 1, offset i + 32, width 16, and data entry
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
  static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  			struct nphy_txgains target, u8 type, bool debug)
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index d435720..a5f3a94 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -972,6 +972,7 @@ struct b43_phy_n {
  	u8 mphase_cal_phase_id;
  	u8 antsel_type;
  	u16 tx_rx_cal_radio_saveregs[22];
+	u16 txcal_bbmult;
  	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
  	u32 rxcalparams;
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index de8a609..4816b70 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2746,6 +2746,48 @@ const u16 tbl_iqcal_gainparams[2][9][8] = {
  	}
  };

+const struct nphy_txiqcal_ladder ladder_lo[] = {
+	{ 3, 0 },
+	{ 4, 0 },
+	{ 6, 0 },
+	{ 9, 0 },
+	{ 13, 0 },
+	{ 18, 0 },
+	{ 25, 0 },
+	{ 25, 1 },
+	{ 25, 2 },
+	{ 25, 3 },
+	{ 25, 4 },
+	{ 25, 5 },
+	{ 25, 6 },
+	{ 25, 7 },
+	{ 35, 7 },
+	{ 50, 7 },
+	{ 71, 7 },
+	{ 100, 7 }
+};
+
+const struct nphy_txiqcal_ladder ladder_iq[] = {
+	{ 3, 0 },
+	{ 4, 0 },
+	{ 6, 0 },
+	{ 9, 0 },
+	{ 13, 0 },
+	{ 18, 0 },
+	{ 25, 0 },
+	{ 35, 0 },
+	{ 50, 0 },
+	{ 71, 0 },
+	{ 100, 0 },
+	{ 100, 1 },
+	{ 100, 2 },
+	{ 100, 3 },
+	{ 100, 4 },
+	{ 100, 5 },
+	{ 100, 6 },
+	{ 100, 7 }
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 86c394c..b5e0e4b 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -43,6 +43,10 @@ struct b43_nphy_channeltab_entry {
  	u16 unk2;
  };

+struct nphy_txiqcal_ladder {
+	u8 percent;
+	u8 g_env;
+};

  struct b43_wldev;

@@ -142,5 +146,7 @@ extern const u32 txpwrctrl_tx_gain_ipa_rev5[];
  extern const u32 txpwrctrl_tx_gain_ipa_rev6[];
  extern const u32 txpwrctrl_tx_gain_ipa_5g[];
  extern const u16 tbl_iqcal_gainparams[2][9][8];
+extern const struct nphy_txiqcal_ladder ladder_lo[];
+extern const struct nphy_txiqcal_ladder ladder_iq[];

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:43:14 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:43:14 +0100
Subject: [PATCH 4/6] b43: N-PHY: TX power control coeff setup
Message-ID: <op.u6jn2cb19lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/b43.h         |    3 +
  drivers/net/wireless/b43/phy_n.c       |   68 +++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/tables_nphy.c |   35 ++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    1 +
  4 files changed, 106 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/b43.h b/drivers/net/wireless/b43/b43.h
index d5c67a6..964ddd4 100644
--- a/drivers/net/wireless/b43/b43.h
+++ b/drivers/net/wireless/b43/b43.h
@@ -260,6 +260,9 @@ enum {
  #define B43_SHM_SH_NPHY_TXIQW1		0x0702
  #define B43_SHM_SH_NPHY_TXIQW2		0x0704
  #define B43_SHM_SH_NPHY_TXIQW3		0x0706
+/* SHM_SHARED tx pwr ctrl */
+#define B43_SHM_SH_NPHY_TXPWR_INDX0	0x0708
+#define B43_SHM_SH_NPHY_TXPWR_INDX1	0x070E

  /* SHM_SCRATCH offsets */
  #define B43_SHM_SC_MINCONT		0x0003	/* Minimum contention window */
diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 67717c1..d5a2dc8 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -709,6 +709,72 @@ static void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */
+static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i, j;
+	u32 tmp;
+	u32 cur_real, cur_imag, real_part, imag_part;
+
+	u16 buffer[7];
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, true);
+
+	//TODO: Read an N PHY Table with ID 15, length 7, offset 80, width 16, and data pointer buffer
+	
+	for (i = 0; i < 2; i++) {
+		tmp = ((buffer[i * 2] & 0x3FF) << 10) |
+			(buffer[i * 2 + 1] & 0x3FF);
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR,
+				(((i + 26) << 10) | 320));
+		for (j = 0; j < 128; j++) {
+			b43_phy_write(dev, B43_NPHY_TABLE_DATAHI,
+					((tmp >> 16) & 0xFFFF));
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(tmp & 0xFFFF));
+		}
+	}
+
+	for (i = 0; i < 2; i++) {
+		tmp = buffer[5 + i];
+		real_part = (tmp >> 8) & 0xFF;
+		imag_part = (tmp & 0xFF);
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR,
+				(((i + 26) << 10) | 448));
+
+		if (dev->phy.rev >= 3) {
+			cur_real = real_part;
+			cur_imag = imag_part;
+			tmp = ((cur_real & 0xFF) << 8) | (cur_imag & 0xFF);
+		}
+
+		for (j = 0; j < 128; j++) {
+			if (dev->phy.rev < 3) {
+				cur_real = (real_part * loscale[j] + 128) >> 8;
+				cur_imag = (imag_part * loscale[j] + 128) >> 8;
+				tmp = ((cur_real & 0xFF) << 8) |
+					(cur_imag & 0xFF);
+			}
+			b43_phy_write(dev, B43_NPHY_TABLE_DATAHI,
+					((tmp >> 16) & 0xFFFF));
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(tmp & 0xFFFF));
+		}
+	}
+
+	if (dev->phy.rev >= 3) {
+		b43_shm_write16(dev, B43_SHM_SHARED,
+				B43_SHM_SH_NPHY_TXPWR_INDX0, 0xFFFF);
+		b43_shm_write16(dev, B43_SHM_SHARED,
+				B43_SHM_SH_NPHY_TXPWR_INDX1, 0xFFFF);
+	}
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, false);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
  static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  			struct nphy_txgains target, u8 type, bool debug)
@@ -1787,7 +1853,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  		}
  	}

-	//TODO N PHY TX Power Control Coef Setup
+	b43_nphy_tx_pwr_ctrl_coef_setup(dev);
  	//TODO N PHY TX Power Control Enable with argument tx_pwr_state
  	b43_phy_write(dev, B43_NPHY_TXMACIF_HOLDOFF, 0x0015);
  	b43_phy_write(dev, B43_NPHY_TXMACDELAY, 0x0320);
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 4816b70..d9291cf 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2788,6 +2788,41 @@ const struct nphy_txiqcal_ladder ladder_iq[] = {
  	{ 100, 7 }
  };

+const u16 loscale[] = {
+	256, 256, 271, 271,
+	287, 256, 256, 271,
+	271, 287, 287, 304,
+	304, 256, 256, 271,
+	271, 287, 287, 304,
+	304, 322, 322, 341,
+	341, 362, 362, 383,
+	383, 256, 256, 271,
+	271, 287, 287, 304,
+	304, 322, 322, 256,
+	256, 271, 271, 287,
+	287, 304, 304, 322,
+	322, 341, 341, 362,
+	362, 256, 256, 271,
+	271, 287, 287, 304,
+	304, 322, 322, 256,
+	256, 271, 271, 287,
+	287, 304, 304, 322,
+	322, 341, 341, 362,
+	362, 256, 256, 271,
+	271, 287, 287, 304,
+	304, 322, 322, 341,
+	341, 362, 362, 383,
+	383, 406, 406, 430,
+	430, 455, 455, 482,
+	482, 511, 511, 541,
+	541, 573, 573, 607,
+	607, 643, 643, 681,
+	681, 722, 722, 764,
+	764, 810, 810, 858,
+	858, 908, 908, 962,
+	962, 1019, 1019, 256
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index b5e0e4b..4a3d666 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -148,5 +148,6 @@ extern const u32 txpwrctrl_tx_gain_ipa_5g[];
  extern const u16 tbl_iqcal_gainparams[2][9][8];
  extern const struct nphy_txiqcal_ladder ladder_lo[];
  extern const struct nphy_txiqcal_ladder ladder_iq[];
+extern const u16 loscale[];

  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:43:21 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:43:21 +0100
Subject: [PATCH 5/6] b43: N-PHY: correct condition blocks in init
Message-ID: <op.u6jn2jfp9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   16 +++++++++-------
  1 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d5a2dc8..356b89f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1842,17 +1842,19 @@ int b43_phy_initn(struct b43_wldev *dev)
  					//TODO N PHY Pre Calibrate TX Gain
  					target = b43_nphy_get_tx_gains(dev);
  				}
-				/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0
-					if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
-						Call N PHY Save Cal */
-			} else if (nphy->mphase_cal_phase_id == 0) {
-				//TODO N PHY Periodic Calibration with argument 3
  			}
-		} else {
-			b43_nphy_restore_cal(dev);
  		}
  	}

+	/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0 {
+		if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
+			Call N PHY Save Cal
+		else if (nphy->mphase_cal_phase_id == 0)
+			//TODO: N PHY Periodic Calibration with argument 3
+	} else {
+		b43_nphy_restore_cal(dev);
+	} */
+
  	b43_nphy_tx_pwr_ctrl_coef_setup(dev);
  	//TODO N PHY TX Power Control Enable with argument tx_pwr_state
  	b43_phy_write(dev, B43_NPHY_TXMACIF_HOLDOFF, 0x0015);
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:43:27 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:43:27 +0100
Subject: [PATCH 6/6] b43: N-PHY: add huge cal TX IQ LO
Message-ID: <op.u6jn2p0e9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |  214 +++++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h       |    9 ++
  drivers/net/wireless/b43/tables_nphy.c |   60 +++++++++
  drivers/net/wireless/b43/tables_nphy.h |   24 ++++
  4 files changed, 301 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 356b89f..d7eeed0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1033,6 +1033,207 @@ static void b43_nphy_tx_cal_radio_setup(struct b43_wldev *dev)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalTxIqlo */
+static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
+				struct nphy_txgains target,
+				bool full, bool mphase)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i;
+	int error = 0;
+	int freq;
+	bool avoid = false;
+	u8 length;
+	u16 tmp, core, type, count, max, numb, last, cmd;
+	const u16 *table;
+	bool phy6or5x;
+
+	u16 buffer[11];
+	u16 diq_start = 0;
+	u16 save[2];
+	u16 gain[2];
+	struct nphy_iqcal_params params[2];
+	bool updated[2] = { };
+
+	b43_nphy_stay_in_carrier_search(dev, true);
+
+	if (dev->phy.rev >= 4) {
+		avoid = nphy->hang_avoid;
+		nphy->hang_avoid = 0;
+	}
+
+	//TODO: Read an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data pointer save
+
+	for (i = 0; i < 2; i++) {
+		b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
+		gain[i] = params[i].cal_gain;
+	}
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data pointer gain
+
+	b43_nphy_tx_cal_radio_setup(dev);
+	//TODO: Call N PHY TX Cal PHY Setup
+
+	phy6or5x = dev->phy.rev >= 6 ||
+		(dev->phy.rev == 5 && nphy->ipa2g_on &&
+		b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ);
+	if (phy6or5x) {
+		/* TODO */
+	}
+
+	b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);
+
+	if (1 /*FIXME: the band width is 20 MHz*/)
+		freq = 2500;
+	else
+		freq = 5000;
+
+	if (nphy->mphase_cal_phase_id > 2)
+		;//TODO: Call N PHY Run Samples with (band width * 8), 0xFFFF, 0, 1, 0 as arguments
+	else
+		;//TODO: Call N PHY TX Tone with freq, 250, 1, 0 as arguments and save result as error
+
+	if (error == 0) {
+		if (nphy->mphase_cal_phase_id > 2) {
+			table = nphy->mphase_txcal_bestcoeffs;
+			length = 11;
+			if (dev->phy.rev < 3)
+				length -= 2;
+		} else {
+			if (!full && nphy->txiqlocal_coeffsvalid) {
+				table = nphy->txiqlocal_bestc;
+				length = 11;
+				if (dev->phy.rev < 3)
+					length -= 2;
+			} else {
+				full = true;
+				if (dev->phy.rev >= 3) {
+					table = tbl_tx_iqlo_cal_startcoefs_nphyrev3;
+					length = B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3;
+				} else {
+					table = tbl_tx_iqlo_cal_startcoefs;
+					length = B43_NTAB_TX_IQLO_CAL_STARTCOEFS;
+				}
+			}
+		}
+
+		//TODO: Write an N PHY Table with ID 15, length from above, offset 64, width 16, and the data pointer from above
+
+		if (full) {
+			if (dev->phy.rev >= 3)
+				max = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3;
+			else
+				max = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL;
+		} else {
+			if (dev->phy.rev >= 3)
+				max = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3;
+			else
+				max = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL;
+		}
+
+		if (mphase) {
+			count = nphy->mphase_txcal_cmdidx;
+			numb = min(max,
+				(u16)(count + nphy->mphase_txcal_numcmds));
+		} else {
+			count = 0;
+			numb = max;
+		}
+
+		for (; count < numb; count++) {
+			if (full) {
+				if (dev->phy.rev >= 3)
+					cmd = tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[count];
+				else
+					cmd = tbl_tx_iqlo_cal_cmds_fullcal[count];
+			} else {
+				if (dev->phy.rev >= 3)
+					cmd = tbl_tx_iqlo_cal_cmds_recal_nphyrev3[count];
+				else
+					cmd = tbl_tx_iqlo_cal_cmds_recal[count];
+			}
+
+			core = (cmd & 0x3000) >> 12;
+			type = (cmd & 0x0F00) >> 8;
+
+			if (phy6or5x && updated[core] == 0) {
+				b43_nphy_update_tx_cal_ladder(dev, core);
+				updated[core] = 1;
+			}
+
+			tmp = (params[core].ncorr[type] << 8) | 0x66;
+			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);
+
+			if (type == 1 || type == 3 || type == 4) {
+				//TODO: Read an N PHY Table with ID 15, length 1, offset 69 + core, width 16, and data pointer buffer
+				diq_start = buffer[0];
+				buffer[0] = 0;
+				//TODO: Write an N PHY Table with ID 15, length 1, offset 69 + core, width 16, and data of 0
+			}
+
+			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);
+			for (i = 0; i < 2000; i++) {
+				tmp = b43_phy_read(dev, B43_NPHY_IQLOCAL_CMD);
+				if (tmp & 0xC000)
+					break;
+				udelay(10);
+			}
+
+			//TODO: Read an N PHY Table with ID 15, length table_length, offset 96, width 16, and data pointer buffer
+			//TODO: Write an N PHY Table with ID 15, length table_length, offset 64, width 16, and data pointer buffer
+
+			if (type == 1 || type == 3 || type == 4)
+				buffer[0] = diq_start;
+		}
+
+		if (mphase)
+			nphy->mphase_txcal_cmdidx = (numb >= max) ? 0 : numb;
+
+		last = (dev->phy.rev < 3) ? 6 : 7;
+
+		if (!mphase || nphy->mphase_cal_phase_id == last) {
+			//TODO: Write an N PHY Table with ID 15, length 4, offset 96, width 16, and data pointer buffer
+			//TODO: Read an N PHY Table with ID 15, length 4, offset 80, width 16, and data pointer buffer
+			if (dev->phy.rev < 3) {
+				buffer[0] = 0;
+				buffer[1] = 0;
+				buffer[2] = 0;
+				buffer[3] = 0;
+			}
+			//TODO: Write an N PHY Table with ID 15, length 4, offset 88, width 16, and data pointer buffer
+			//TODO: Read an N PHY Table with ID 15, length 2, offset 101, width 16, and data pointer buffer
+			//TODO: Write an N PHY Table with ID 15, length 2, offset 85, width 16, and data pointer buffer
+			//TODO: Write an N PHY Table with ID 15, length 2, offset 93, width 16, and data pointer buffer
+			length = 11;
+			if (dev->phy.rev < 3)
+				length -= 2;
+			//TODO: Read an N PHY Table with ID 15, length length, offset 96, width 16, and data pointer nphy->txiqlocal_bestc
+			nphy->txiqlocal_coeffsvalid = true;
+			//TODO: Set nphy->txiqlocal_chanspec to the current channel
+		} else {
+			length = 11;
+			if (dev->phy.rev < 3)
+				length -= 2;
+			//TODO: Read an N PHY Table with ID 5, length length, offset 96, width 16, and data pointer nphy->mphase_txcal_bestcoeffs
+		}
+
+		//TODO: Call N PHY Stop Playback
+		b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);
+	}
+
+	//TODO: Call N PHY TX Cal PHY Cleanup
+	//TODO: Write an N PHY Table with ID 7, length 2, offset 0x110, width 16, and data from save
+
+	if (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id == last))
+		b43_nphy_tx_iq_workaround(dev);
+
+	if (dev->phy.rev >= 4)
+		nphy->hang_avoid = avoid;
+
+	b43_nphy_stay_in_carrier_search(dev, false);
+
+	return error;
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
  static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  {
@@ -1685,7 +1886,9 @@ int b43_phy_initn(struct b43_wldev *dev)
  	struct ssb_bus *bus = dev->dev->bus;
  	struct b43_phy *phy = &dev->phy;
  	struct b43_phy_n *nphy = phy->n;
+
  	u8 tx_pwr_state;
+	struct nphy_txgains target;
  	u16 tmp;
  	enum ieee80211_band tmp2;
  	bool do_rssi_cal;
@@ -1827,8 +2030,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  			do_cal = false;

  		if (do_cal) {
-			struct nphy_txgains target =
-				b43_nphy_get_tx_gains(dev);
+			target = b43_nphy_get_tx_gains(dev);

  			if (nphy->antsel_type == 2)
  				;//TODO N PHY Superswitch Init with argument 1
@@ -1846,14 +2048,14 @@ int b43_phy_initn(struct b43_wldev *dev)
  		}
  	}

-	/* TODO: If the output of N PHY Cal TX Iqlo with target, 1 0 as arguments is 0 {
+	if (!b43_nphy_cal_tx_iq_lo(dev, target, true, false)) {
  		if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
-			Call N PHY Save Cal
+			;//TODO: Call N PHY Save Cal
  		else if (nphy->mphase_cal_phase_id == 0)
-			//TODO: N PHY Periodic Calibration with argument 3
+			;//TODO: N PHY Periodic Calibration with argument 3
  	} else {
  		b43_nphy_restore_cal(dev);
-	} */
+	}

  	b43_nphy_tx_pwr_ctrl_coef_setup(dev);
  	//TODO N PHY TX Power Control Enable with argument tx_pwr_state
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index a5f3a94..121050b 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -969,10 +969,19 @@ struct b43_phy_n {
  	u8 measure_hold;
  	u8 phyrxchain;
  	u8 perical;
+
  	u8 mphase_cal_phase_id;
+	u16 mphase_txcal_cmdidx;
+	u16 mphase_txcal_numcmds;
+	u16 mphase_txcal_bestcoeffs[11];
+
  	u8 antsel_type;
+
  	u16 tx_rx_cal_radio_saveregs[22];
  	u16 txcal_bbmult;
+	u16 txiqlocal_bestc[11];
+	bool txiqlocal_coeffsvalid;
+
  	u16 papd_epsilon_offset[2];
  	u32 deaf_count;
  	u32 rxcalparams;
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index d9291cf..7dff853 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2823,6 +2823,66 @@ const u16 loscale[] = {
  	962, 1019, 1019, 256
  };

+const u16 tbl_tx_iqlo_cal_loft_ladder_40[] = {
+	0x0200, 0x0300, 0x0400, 0x0700,
+	0x0900, 0x0c00, 0x1200, 0x1201,
+	0x1202, 0x1203, 0x1204, 0x1205,
+	0x1206, 0x1207, 0x1907, 0x2307,
+	0x3207, 0x4707
+};
+
+const u16 tbl_tx_iqlo_cal_loft_ladder_20[] = {
+	0x0300, 0x0500, 0x0700, 0x0900,
+	0x0d00, 0x1100, 0x1900, 0x1901,
+	0x1902, 0x1903, 0x1904, 0x1905,
+	0x1906, 0x1907, 0x2407, 0x3207,
+	0x4607, 0x6407
+};
+
+const u16 tbl_tx_iqlo_cal_iqimb_ladder_40[] = {
+	0x0100, 0x0200, 0x0400, 0x0700,
+	0x0900, 0x0c00, 0x1200, 0x1900,
+	0x2300, 0x3200, 0x4700, 0x4701,
+	0x4702, 0x4703, 0x4704, 0x4705,
+	0x4706, 0x4707
+};
+
+const u16 tbl_tx_iqlo_cal_iqimb_ladder_20[] = {
+	0x0200, 0x0300, 0x0600, 0x0900,
+	0x0d00, 0x1100, 0x1900, 0x2400,
+	0x3200, 0x4600, 0x6400, 0x6401,
+	0x6402, 0x6403, 0x6404, 0x6405,
+	0x6406, 0x6407
+};
+
+const u16 tbl_tx_iqlo_cal_startcoefs_nphyrev3[B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3] = { };
+
+const u16 tbl_tx_iqlo_cal_startcoefs[B43_NTAB_TX_IQLO_CAL_STARTCOEFS] = { };
+
+const u16 tbl_tx_iqlo_cal_cmds_recal_nphyrev3[] = {
+	0x8423, 0x8323, 0x8073, 0x8256,
+	0x8045, 0x8223, 0x9423, 0x9323,
+	0x9073, 0x9256, 0x9045, 0x9223
+};
+
+const u16 tbl_tx_iqlo_cal_cmds_recal[] = {
+	0x8101, 0x8253, 0x8053, 0x8234,
+	0x8034, 0x9101, 0x9253, 0x9053,
+	0x9234, 0x9034
+};
+
+const u16 tbl_tx_iqlo_cal_cmds_fullcal[] = {
+	0x8123, 0x8264, 0x8086, 0x8245,
+	0x8056, 0x9123, 0x9264, 0x9086,
+	0x9245, 0x9056
+};
+
+const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[] = {
+	0x8434, 0x8334, 0x8084, 0x8267,
+	0x8056, 0x8234, 0x9434, 0x9334,
+	0x9084, 0x9267, 0x9056, 0x9234
+};
+
  static inline void assert_ntab_array_sizes(void)
  {
  #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 4a3d666..e359d9b 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -130,6 +130,19 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_C1_LOFEEDTH		B43_NTAB16(0x1B, 0x1C0) /* Local Oscillator Feed Through Lookup Table Core 1 */
  #define B43_NTAB_C1_LOFEEDTH_SIZE	128

+#define B43_NTAB_TX_IQLO_CAL_LOFT_LADDER_40_SIZE	18
+#define B43_NTAB_TX_IQLO_CAL_LOFT_LADDER_20_SIZE	18
+#define B43_NTAB_TX_IQLO_CAL_IQIMB_LADDER_40_SIZE	18
+#define B43_NTAB_TX_IQLO_CAL_IQIMB_LADDER_20_SIZE	18
+#define B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3		11
+#define B43_NTAB_TX_IQLO_CAL_STARTCOEFS			9
+#define B43_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3		12
+#define B43_NTAB_TX_IQLO_CAL_CMDS_RECAL			10
+#define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL		10
+#define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12
+
+
+
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);

  void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
@@ -150,4 +163,15 @@ extern const struct nphy_txiqcal_ladder ladder_lo[];
  extern const struct nphy_txiqcal_ladder ladder_iq[];
  extern const u16 loscale[];

+extern const u16 tbl_tx_iqlo_cal_loft_ladder_40[];
+extern const u16 tbl_tx_iqlo_cal_loft_ladder_20[];
+extern const u16 tbl_tx_iqlo_cal_iqimb_ladder_40[];
+extern const u16 tbl_tx_iqlo_cal_iqimb_ladder_20[];
+extern const u16 tbl_tx_iqlo_cal_startcoefs_nphyrev3[];
+extern const u16 tbl_tx_iqlo_cal_startcoefs[];
+extern const u16 tbl_tx_iqlo_cal_cmds_recal_nphyrev3[];
+extern const u16 tbl_tx_iqlo_cal_cmds_recal[];
+extern const u16 tbl_tx_iqlo_cal_cmds_fullcal[];
+extern const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[];
+
  #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Jan 14 23:55:21 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 14 Jan 2010 23:55:21 +0100
Subject: b43 patches sets
In-Reply-To: <b170af451001101419x3907983dn5bd41b41998f00b5@mail.gmail.com>
References: <b170af451001101419x3907983dn5bd41b41998f00b5@mail.gmail.com>
Message-ID: <b170af451001141455i7b54cf50i59683c39202ffe1b@mail.gmail.com>

W dniu 10 stycznia 2010 23:19 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> In case you've lost in my patches submission, I've generated following
> (bigger) sets:
>
> http://estudent.put.poznan.pl/rafal.milecki/b43-1/
> http://estudent.put.poznan.pl/rafal.milecki/b43-2/

Well, I added following:

http://estudent.put.poznan.pl/rafal.milecki/b43-3/
http://estudent.put.poznan.pl/rafal.milecki/b43-4/

and I hope that all dirs contain updated patches. It's easy to get
lost with such amount.

John let me ping you also there (tried IRC). Could you try to grab all
my patches to wireless-testing? It slowly gets messy.

-- 
Rafa?


From mb at bu3sch.de  Fri Jan 15 00:06:07 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 15 Jan 2010 00:06:07 +0100
Subject: [PATCH 1/2] b43: make finding the most significant bit common
	function
In-Reply-To: <op.u6iu91z39lhzdc@linux-g0th.site>
References: <op.u6iu91z39lhzdc@linux-g0th.site>
Message-ID: <201001150006.08621.mb@bu3sch.de>

On Thursday 14 January 2010 13:21:27 Rafa? Mi?ecki wrote:
> 
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
>   drivers/net/wireless/b43/phy_common.c |   14 ++++++++++++++
>   drivers/net/wireless/b43/phy_common.h |    1 +
>   drivers/net/wireless/b43/phy_lp.c     |   17 ++---------------
>   3 files changed, 17 insertions(+), 15 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
> index 75b26e1..1389ab2 100644
> --- a/drivers/net/wireless/b43/phy_common.c
> +++ b/drivers/net/wireless/b43/phy_common.c
> @@ -421,3 +421,17 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on)
>   {
>   	b43_write16(dev, B43_MMIO_PHY0, on ? 0 : 0xF4);
>   }
> +
> +/* Find the position of the most significant bit */
> +u8 phy_nbits(s32 val)
> +{
> +	u32 tmp = abs(val);
> +	u8 nbits = 0;
> +
> +	while (tmp != 0) {
> +		nbits++;
> +		tmp >>= 1;
> +	}
> +
> +	return nbits;
> +}

We already have fls() in bitops.h
I think the following call would be equivalent:

x = fls(abs(val));

So we don't need our own implementation in phy_common.c.
Just use the standard funcs.

-- 
Greetings, Michael.


From mcgrof at gmail.com  Fri Jan 15 00:08:55 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Thu, 14 Jan 2010 15:08:55 -0800
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <op.u6jn12l09lhzdc@linux-g0th.site>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
Message-ID: <43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com>

2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:

It'd be nice if your patches had a good description of what this is, I
see most of these patches are one-liners with no description at all.

  Luis


From zajec5 at gmail.com  Fri Jan 15 00:13:15 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 00:13:15 +0100
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
	<43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com>
Message-ID: <b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com>

W dniu 15 stycznia 2010 00:08 u?ytkownik Luis R. Rodriguez
<mcgrof at gmail.com> napisa?:
> It'd be nice if your patches had a good description of what this is, I
> see most of these patches are one-liners with no description at all.

That's right, because I just implement function by function using
specs. I guess that's how implementing driver from RE specs look like.

Maybe I could use descriptions instead of function names so we would get
calculate TX IQ LO
instead of
b43_nphy_cal_tx_iq_lo
but not sure if that makes much more sense.

Do you have some better suggestion? I'm open for comments, changes :)

-- 
Rafa?


From mcgrof at gmail.com  Fri Jan 15 00:44:23 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Thu, 14 Jan 2010 15:44:23 -0800
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
	<43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com> 
	<b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com>
Message-ID: <43e72e891001141544n75de8362ke1756882ed1c2391@mail.gmail.com>

2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 15 stycznia 2010 00:08 u?ytkownik Luis R. Rodriguez
> <mcgrof at gmail.com> napisa?:
>> It'd be nice if your patches had a good description of what this is, I
>> see most of these patches are one-liners with no description at all.
>
> That's right, because I just implement function by function using
> specs. I guess that's how implementing driver from RE specs look like.
>
> Maybe I could use descriptions instead of function names so we would get
> calculate TX IQ LO
> instead of
> b43_nphy_cal_tx_iq_lo
> but not sure if that makes much more sense.
>
> Do you have some better suggestion? I'm open for comments, changes :)

I'm talking about the text on the commit log after the "Subject", the
subject in this case being:

"b43: N-PHY: add update TX cal ladder"

Doesn't the spec talk or even speculate to some degree what this thing is?

  Luis


From zajec5 at gmail.com  Fri Jan 15 00:52:54 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 00:52:54 +0100
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <43e72e891001141544n75de8362ke1756882ed1c2391@mail.gmail.com>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
	<43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com>
	<b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com>
	<43e72e891001141544n75de8362ke1756882ed1c2391@mail.gmail.com>
Message-ID: <b170af451001141552k227a8125nf4926adbfd6d3c8f@mail.gmail.com>

W dniu 15 stycznia 2010 00:44 u?ytkownik Luis R. Rodriguez
<mcgrof at gmail.com> napisa?:
> 2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> W dniu 15 stycznia 2010 00:08 u?ytkownik Luis R. Rodriguez
>> <mcgrof at gmail.com> napisa?:
>>> It'd be nice if your patches had a good description of what this is, I
>>> see most of these patches are one-liners with no description at all.
>>
>> That's right, because I just implement function by function using
>> specs. I guess that's how implementing driver from RE specs look like.
>>
>> Maybe I could use descriptions instead of function names so we would get
>> calculate TX IQ LO
>> instead of
>> b43_nphy_cal_tx_iq_lo
>> but not sure if that makes much more sense.
>>
>> Do you have some better suggestion? I'm open for comments, changes :)
>
> I'm talking about the text on the commit log after the "Subject", the
> subject in this case being:
>
> "b43: N-PHY: add update TX cal ladder"
>
> Doesn't the spec talk or even speculate to some degree what this thing is?

Well, AFAIK all we know about function is:
http://bcm-v4.sipsolutions.net/802.11/PHY/N/UpdateTxCalLadder

It updates something on wireless card writing table 15. It's hard to
understand what it really does, especially if you don't yet have
contexts calling this function.

P.S.
Also John's comment:
<linville> "calculate TX IQ LO" -- I like that better

So definitely I will avoid putting just function names. However as I
said, I don't think I will be able to be more descriptive :/

-- 
Rafa?


From mcgrof at gmail.com  Fri Jan 15 00:59:14 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Thu, 14 Jan 2010 15:59:14 -0800
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <b170af451001141552k227a8125nf4926adbfd6d3c8f@mail.gmail.com>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
	<43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com> 
	<b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com> 
	<43e72e891001141544n75de8362ke1756882ed1c2391@mail.gmail.com> 
	<b170af451001141552k227a8125nf4926adbfd6d3c8f@mail.gmail.com>
Message-ID: <43e72e891001141559n43ce0eecm2894da7fd1409408@mail.gmail.com>

2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 15 stycznia 2010 00:44 u?ytkownik Luis R. Rodriguez
> <mcgrof at gmail.com> napisa?:
>> 2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> W dniu 15 stycznia 2010 00:08 u?ytkownik Luis R. Rodriguez
>>> <mcgrof at gmail.com> napisa?:
>>>> It'd be nice if your patches had a good description of what this is, I
>>>> see most of these patches are one-liners with no description at all.
>>>
>>> That's right, because I just implement function by function using
>>> specs. I guess that's how implementing driver from RE specs look like.
>>>
>>> Maybe I could use descriptions instead of function names so we would get
>>> calculate TX IQ LO
>>> instead of
>>> b43_nphy_cal_tx_iq_lo
>>> but not sure if that makes much more sense.
>>>
>>> Do you have some better suggestion? I'm open for comments, changes :)
>>
>> I'm talking about the text on the commit log after the "Subject", the
>> subject in this case being:
>>
>> "b43: N-PHY: add update TX cal ladder"
>>
>> Doesn't the spec talk or even speculate to some degree what this thing is?
>
> Well, AFAIK all we know about function is:
> http://bcm-v4.sipsolutions.net/802.11/PHY/N/UpdateTxCalLadder
>
> It updates something on wireless card writing table 15. It's hard to
> understand what it really does, especially if you don't yet have
> contexts calling this function.
>
> P.S.
> Also John's comment:
> <linville> "calculate TX IQ LO" -- I like that better
>
> So definitely I will avoid putting just function names. However as I
> said, I don't think I will be able to be more descriptive :/

Heh well I had to try :)

  Luis


From Larry.Finger at lwfinger.net  Fri Jan 15 01:14:05 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 14 Jan 2010 18:14:05 -0600
Subject: [PATCH 3/6] b43: N-PHY: add update TX cal ladder
In-Reply-To: <43e72e891001141559n43ce0eecm2894da7fd1409408@mail.gmail.com>
References: <op.u6jn12l09lhzdc@linux-g0th.site>
	<43e72e891001141508ndec9aeak46412482b2486054@mail.gmail.com>
	<b170af451001141513p6452cf52q6d97477a38e83f34@mail.gmail.com>
	<43e72e891001141544n75de8362ke1756882ed1c2391@mail.gmail.com>
	<b170af451001141552k227a8125nf4926adbfd6d3c8f@mail.gmail.com>
	<43e72e891001141559n43ce0eecm2894da7fd1409408@mail.gmail.com>
Message-ID: <4B4FB34D.7020003@lwfinger.net>

On 01/14/2010 05:59 PM, Luis R. Rodriguez wrote:
> 2010/1/14 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>
>> So definitely I will avoid putting just function names. However as I
>> said, I don't think I will be able to be more descriptive :/
> 
> Heh well I had to try :)

Unfortunately, there are no comments in MIPS binary code. Without them, there is
very little more than the function names available.

Larry


From zajec5 at gmail.com  Fri Jan 15 02:25:59 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 02:25:59 +0100
Subject: [RFR][PATCH] b43: N-PHY: TX cal PHY code for setup and cleanup
Message-ID: <op.u6jvllf79lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
John: as we decided, I'll prepare patch bomb with everything posted so far. So this one is posted
for review rather than real including to wireless-testing/kernel.
---
  drivers/net/wireless/b43/phy_n.c |   81 ++++++++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/phy_n.h |    2 +
  2 files changed, 83 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d7eeed0..bdf1355 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -632,6 +632,87 @@ static void b43_nphy_calc_rx_iq_comp(struct b43_wldev *dev, u8 mask)
  	b43_nphy_rx_iq_coeffs(dev, true, &new);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhyCleanup */
+static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev, u8 core)
+{
+	u16 *regs = &dev->nphy.tx_rx_cal_phy_saveregs;
+
+	b43_phy_write(dev, B43_NPHY_RFSEQCA, regs[0]);
+	if (core == 0) {
+		b43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
+	} else {
+		b43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
+	}
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[3]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[4]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO1, regs[5]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO2, regs[6]);
+	b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, regs[7]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_OVER, regs[8]);
+	b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
+	b43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhySetup */
+static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev, u8 core)
+{
+	u16 *regs = &dev->nphy.tx_rx_cal_phy_saveregs;
+
+	regs[0] = b43_phy_read(dev, B43_NPHY_RFSEQCA);
+	if (core == 0) {
+		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
+		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
+	} else {
+		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
+		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+	}
+	regs[3] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+	regs[4] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+	regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO1);
+	regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO2);
+	regs[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S1);
+	regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_OVER);
+	regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);
+	regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);
+
+	b43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);
+	b43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);
+
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXDIS,
+			((1 - core) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,
+			((1 - core) << B43_NPHY_RFSEQCA_TXEN_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXEN,
+			(core << B43_NPHY_RFSEQCA_RXEN_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXDIS,
+			(core << B43_NPHY_RFSEQCA_TXDIS_SHIFT));
+
+	if (core == 0) {
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x0007);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0007);
+	} else {
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x0007);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0007);
+	}
+
+	/* TODO: Call N PHY RF Ctrl Intc Override with 2, 0, 3 as arguments */
+	/* TODO: Call N PHY RF Intc Override with 8, 0, 3, 0 as arguments */
+	/* TODO: Call N PHY RF Seq with 0 as argument */
+
+	if (core == 0) {
+		rxval = 1;
+		txval = 8;
+	} else {
+		rxval = 4;
+		txval = 2;
+	}
+
+	/* TODO: Call N PHY RF Ctrl Intc Override with 1, rxval, (core + 1) as arguments */
+	/* TODO: Call N PHY RF Ctrl Intc Override with 1, txval, (2 - core) as arguments */
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */
  static void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,
  					struct nphy_txgains target,
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 121050b..9ef5aaf 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -977,7 +977,9 @@ struct b43_phy_n {

  	u8 antsel_type;

+	u16 tx_rx_cal_phy_saveregs[11];
  	u16 tx_rx_cal_radio_saveregs[22];
+
  	u16 txcal_bbmult;
  	u16 txiqlocal_bestc[11];
  	bool txiqlocal_coeffsvalid;
-- 
1.6.4.2



From vmiklos at frugalware.org  Fri Jan 15 02:12:58 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 02:12:58 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
Message-ID: <20100115011258.GS29803@genesis.frugalware.org>

Hi,

I tried asking on #bcm-users, then found the wiki where it's suggested
to report to this list, so I'm doing so. Sorry for the noise on IRC.

A description of the problem at hand:

My card works fine when I use it with WPA, however when I try to use it
without any encryption (actually the provider uses MAC-based filtering,
but that's not important), then after the "iwconfig eth0 essid <essid>",
"iwconfig" shows the MAC of the AP, and after about 5 secs "iwconfig"
says it's "Not-Associated". If I run iwconfig eth0 essid again, then
it's usable again for ~5 secs and so on. When the AP goes unassociated,
I see this in dmesg:

No probe response from AP 00:12:17:d3:87:f5 after 500ms, disconnecting.

When it happens:

It happens only in case not using encryption. An other laptop with
ipw2200 driver works fine, so I guess this will be a b43 or firmware
problem. The same card works under Windows XP as well, so I guess it's
not a hardware problem.

How to reproduce:

Run "iwconfig eth0 essid <essid>", wait ~5 secs and run "iwconfig"
again. Result: it's unassociated. Expected: to show the MAC of the AP,
etc.

$ uname -a
Linux s12 2.6.32-fw2 #1 SMP PREEMPT Sat Dec 19 13:56:14 CET 2009 x86_64
GNU/Linux

$ sudo lspci -vvn|grep 43 -A7
00:00.4 0600: 1106:4353
        Subsystem: 17aa:3889
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=medium >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 0, Cache Line Size: 32 bytes

00:00.5 0800: 1106:5353 (prog-if 20 [IO(X)-APIC])
        Subsystem: 17aa:388a
--
02:00.0 0280: 14e4:4315 (rev 01)
        Subsystem: 14e4:04b5
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 0, Cache Line Size: 32 bytes
        Interrupt: pin A routed to IRQ 28
        Region 0: Memory at f5200000 (64-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 3
--
        Kernel driver in use: b43-pci-bridge
        Kernel modules: ssb

dmesg: http://frugalware.org/~vmiklos/files/dmesg-s12

Wlan configuration, authentication/encryption type:

b43 from vanilla kernel, no encryption. Firmware is installed as
described at http://linuxwireless.org/en/users/Drivers/b43#fw-b43-lp

kernel is a distro-packaged vanilla 2.6.32.1.

Any ideas?

Thanks!
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/f996bc39/attachment.pgp>

From peter at stuge.se  Fri Jan 15 02:46:19 2010
From: peter at stuge.se (Peter Stuge)
Date: Fri, 15 Jan 2010 02:46:19 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115011258.GS29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
Message-ID: <20100115014619.31031.qmail@stuge.se>

Interesting!

Miklos Vajna wrote:
> Hi,
> 
> I tried asking on #bcm-users, then found the wiki where it's suggested
> to report to this list, so I'm doing so. Sorry for the noise on IRC.
> 
> A description of the problem at hand:
> 
> My card works fine when I use it with WPA, however when I try to use it
> without any encryption

Do you have wpa_supplicant running also when not using encryption?


> (actually the provider uses MAC-based filtering, but that's not
> important), then after the "iwconfig eth0 essid <essid>",
> "iwconfig" shows the MAC of the AP, and after about 5 secs "iwconfig"
> says it's "Not-Associated". If I run iwconfig eth0 essid again, then
> it's usable again for ~5 secs and so on. When the AP goes unassociated,
> I see this in dmesg:
> 
> No probe response from AP 00:12:17:d3:87:f5 after 500ms, disconnecting.

I also get this issue, but with ath9k.

I have made some noise on the ath9k list about it, and currently have
a reboot pending to try the latest wireless-testing, which has gotten
some more fixes.


> When it happens:
> 
> It happens only in case not using encryption. An other laptop with
> ipw2200 driver works fine, so I guess this will be a b43 or firmware
> problem. The same card works under Windows XP as well, so I guess
> it's not a hardware problem.

I upgraded from ipw2200 to ath9k in my laptop and the old card never
had trouble. Both ath9k and b43 use mac80211 but ipw2200 does not.
With mac80211 you're apparently supposed to always have wpa_supplicant
running - even if not using encryption. The supplicant is responsible
for reconnecting if the interface is disconnected for any reason.

I'm not satisfied with this as the final answer yet. I find it
suspicious that my card disconnects in the first place.

I am normally in a moderately silent RF environment, with not many
APs. With power management enabled (iwconfig eth1 power on) I
experience this issue within minutes. With PM disabled, it happens
only every couple of days. This is on wireless-testing as of Dec 14.
In a very tough RF environment such as a hacker conference the
problem is much more pronounced and disconnects happen many times per
day also with PM off.


> Any ideas?

Does iwconfig power off make a difference for you?


//Peter
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/40f925a5/attachment.pgp>

From netrolller.3d at gmail.com  Fri Jan 15 03:36:54 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 15 Jan 2010 03:36:54 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115011258.GS29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
Message-ID: <69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>

On Fri, Jan 15, 2010 at 2:12 AM, Miklos Vajna <vmiklos at frugalware.org> wrote:
> Hi,
>
> I tried asking on #bcm-users, then found the wiki where it's suggested
> to report to this list, so I'm doing so. Sorry for the noise on IRC.
>
> A description of the problem at hand:
>
> My card works fine when I use it with WPA, however when I try to use it
> without any encryption (actually the provider uses MAC-based filtering,
> but that's not important), then after the "iwconfig eth0 essid <essid>",
> "iwconfig" shows the MAC of the AP, and after about 5 secs "iwconfig"
> says it's "Not-Associated". If I run iwconfig eth0 essid again, then
> it's usable again for ~5 secs and so on. When the AP goes unassociated,
> I see this in dmesg:
>
> No probe response from AP 00:12:17:d3:87:f5 after 500ms, disconnecting.
>
> When it happens:
>
> It happens only in case not using encryption. An other laptop with
> ipw2200 driver works fine, so I guess this will be a b43 or firmware
> problem. The same card works under Windows XP as well, so I guess it's
> not a hardware problem.
>
> How to reproduce:
>
> Run "iwconfig eth0 essid <essid>", wait ~5 secs and run "iwconfig"
> again. Result: it's unassociated. Expected: to show the MAC of the AP,
> etc.
>
> $ uname -a
> Linux s12 2.6.32-fw2 #1 SMP PREEMPT Sat Dec 19 13:56:14 CET 2009 x86_64
> GNU/Linux
>
> $ sudo lspci -vvn|grep 43 -A7
> 00:00.4 0600: 1106:4353
> ? ? ? ?Subsystem: 17aa:3889
> ? ? ? ?Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-
> ? ? ? ?Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=medium >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
> ? ? ? ?Latency: 0, Cache Line Size: 32 bytes
>
> 00:00.5 0800: 1106:5353 (prog-if 20 [IO(X)-APIC])
> ? ? ? ?Subsystem: 17aa:388a
> --
> 02:00.0 0280: 14e4:4315 (rev 01)
> ? ? ? ?Subsystem: 14e4:04b5
> ? ? ? ?Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx-
> ? ? ? ?Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
> ? ? ? ?Latency: 0, Cache Line Size: 32 bytes
> ? ? ? ?Interrupt: pin A routed to IRQ 28
> ? ? ? ?Region 0: Memory at f5200000 (64-bit, non-prefetchable) [size=16K]
> ? ? ? ?Capabilities: [40] Power Management version 3
> --
> ? ? ? ?Kernel driver in use: b43-pci-bridge
> ? ? ? ?Kernel modules: ssb
>
> dmesg: http://frugalware.org/~vmiklos/files/dmesg-s12
>
> Wlan configuration, authentication/encryption type:
>
> b43 from vanilla kernel, no encryption. Firmware is installed as
> described at http://linuxwireless.org/en/users/Drivers/b43#fw-b43-lp
>
> kernel is a distro-packaged vanilla 2.6.32.1.
>
> Any ideas?
>
> Thanks!
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>

14E4:4315 is an LP-PHY (specifically, for most people,, it is "the"
LP-PHY), for which 2.6.32 contains no calibration support, so
performance/range problems can be expected. 2.6.33 should have
improvements (part of calibration done), and 2.6.34 will (if I have
time to do it) have full calibration support.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From vmiklos at frugalware.org  Fri Jan 15 03:47:58 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 03:47:58 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>
Message-ID: <20100115024758.GV29803@genesis.frugalware.org>

On Fri, Jan 15, 2010 at 03:36:54AM +0100, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
> 14E4:4315 is an LP-PHY (specifically, for most people,, it is "the"
> LP-PHY), for which 2.6.32 contains no calibration support, so
> performance/range problems can be expected. 2.6.33 should have
> improvements (part of calibration done), and 2.6.34 will (if I have
> time to do it) have full calibration support.

What does calibration support mean?

By "performance problem" I mean that after "iwconfig eth0 essid" it's
working for ~5sec, and then it's down till the next "iwconfig eth0
essid", so it's basically unusable. :/


By 2.6.33, you mean that I should give 2.6.33-rc4 a try?

Thanks!
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/d9c3c8b4/attachment.pgp>

From vmiklos at frugalware.org  Fri Jan 15 04:09:12 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 04:09:12 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115014619.31031.qmail@stuge.se>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
Message-ID: <20100115030912.GW29803@genesis.frugalware.org>

On Fri, Jan 15, 2010 at 02:46:19AM +0100, Peter Stuge <peter-Y+HMSxxDrH8 at public.gmane.org> wrote:
> Do you have wpa_supplicant running also when not using encryption?

Nope.

> I have made some noise on the ath9k list about it, and currently have
> a reboot pending to try the latest wireless-testing, which has gotten
> some more fixes.

Please let me know if that helped (which git repo, which branch?).

> I upgraded from ipw2200 to ath9k in my laptop and the old card never
> had trouble. Both ath9k and b43 use mac80211 but ipw2200 does not.
> With mac80211 you're apparently supposed to always have wpa_supplicant
> running - even if not using encryption. The supplicant is responsible
> for reconnecting if the interface is disconnected for any reason.
> 
> I'm not satisfied with this as the final answer yet. I find it
> suspicious that my card disconnects in the first place.

That does not seem to help here:

# wpa_supplicant -ieth0 -Dwext -c /etc/wpa_supplicant.conf -B
# iwconfig eth0 essid linksys
# iwconfig
lo        no wireless extensions.

eth1      no wireless extensions.

eth0      IEEE 802.11bg  Mode:Managed  Access Point: Not-Associated
          Tx-Power=27 dBm
          Retry  long limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:off

Note that this is different from what I got when wpa_supplicant was not
running. The output after ~5sec was:

# iwconfig
lo        no wireless extensions.

eth1      no wireless extensions.

eth0      IEEE 802.11bg  ESSID:"linksys"
          Mode:Managed  Access Point: Not-Associated   Tx-Power=27 dBm
          Retry  long limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:off

What should the wpa_supplicant config include? Currently my config has
nothing about the unencrypted access point. It's like:

# cat /etc/wpa_supplicant.conf

ctrl_interface=/var/run/wpa_supplicant

network={
        ssid="ap_with_wpa"
        psk="secret"
}

Should I include a section for the "linksys" (which has no encryption)
AP as well? if yes, what should it look like? The same as the above,
just without the psk line?

> I am normally in a moderately silent RF environment, with not many
> APs. With power management enabled (iwconfig eth1 power on) I
> experience this issue within minutes. With PM disabled, it happens
> only every couple of days. This is on wireless-testing as of Dec 14.
> In a very tough RF environment such as a hacker conference the
> problem is much more pronounced and disconnects happen many times per
> day also with PM off.
> 
> 
> > Any ideas?
> 
> Does iwconfig power off make a difference for you?

It seems to be already off, but when I run the command:

# iwconfig eth0 power off
Error for wireless request "Set Power Management" (8B2C) :
    SET failed on device eth0 ; Operation not supported.

Please keep me in CC, I'm not subscribed. (Actually I am, but mail
delivery is disabled.)

Thanks!

PS: I sent this mail twice, look like the first got lost because I
forgot to replace the public.gmane.org addresses in the mail. If this is
not the case, sorry for the dupe.


From peter at stuge.se  Fri Jan 15 04:51:33 2010
From: peter at stuge.se (Peter Stuge)
Date: Fri, 15 Jan 2010 04:51:33 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115030912.GW29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
Message-ID: <20100115035133.18257.qmail@stuge.se>

Miklos Vajna wrote:
> > I have made some noise on the ath9k list about it, and currently have
> > a reboot pending to try the latest wireless-testing, which has gotten
> > some more fixes.
> 
> Please let me know if that helped (which git repo, which branch?).

Will do.


> Should I include a section for the "linksys" (which has no encryption)
> AP as well? if yes, what should it look like?

Yes, otherwise I don't think wpa_supplicant will do anything.

network={
  ssid="linksys"
  key_mgmt=NONE
}

It could help to run it in foreground - you should see disconnect and
reauth then.


> > Does iwconfig power off make a difference for you?
> 
> It seems to be already off,

Ok.


//Peter


From zajec5 at gmail.com  Fri Jan 15 11:08:19 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 11:08:19 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115024758.GV29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>
	<20100115024758.GV29803@genesis.frugalware.org>
Message-ID: <b170af451001150208k1c166d97mc67ac04e0b6f5bd4@mail.gmail.com>

2010/1/15 Miklos Vajna <vmiklos at frugalware.org>:
> On Fri, Jan 15, 2010 at 03:36:54AM +0100, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> 14E4:4315 is an LP-PHY (specifically, for most people,, it is "the"
>> LP-PHY), for which 2.6.32 contains no calibration support, so
>> performance/range problems can be expected. 2.6.33 should have
>> improvements (part of calibration done), and 2.6.34 will (if I have
>> time to do it) have full calibration support.
>
> What does calibration support mean?
>
> By "performance problem" I mean that after "iwconfig eth0 essid" it's
> working for ~5sec, and then it's down till the next "iwconfig eth0
> essid", so it's basically unusable. :/
>
>
> By 2.6.33, you mean that I should give 2.6.33-rc4 a try?

That's right. You can try wireless-testing as well, currently it
contains same LP-PHY support level as 33-rc4.

-- 
Rafa?


From vmiklos at frugalware.org  Fri Jan 15 14:16:37 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 14:16:37 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115035133.18257.qmail@stuge.se>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
	<20100115035133.18257.qmail@stuge.se>
Message-ID: <20100115131637.GZ29803@genesis.frugalware.org>

On Fri, Jan 15, 2010 at 04:51:33AM +0100, Peter Stuge <peter at stuge.se> wrote:
> > Should I include a section for the "linksys" (which has no encryption)
> > AP as well? if yes, what should it look like?
> 
> Yes, otherwise I don't think wpa_supplicant will do anything.
> 
> network={
>   ssid="linksys"
>   key_mgmt=NONE
> }
> 
> It could help to run it in foreground - you should see disconnect and
> reauth then.

OK, when I add this, wpa_supplicant authenticates with the "wpa ap" on
startup. That's fine, but when I do an "iwconfig eth0 essid linksys",
the wpa_supplicant stdout is:

CTRL-EVENT-DISCONNECTED - Disconnect event - remove keys
ioctl[SIOCSIWSCAN]: Device or resource busy
Failed to initiate AP scan.
CTRL-EVENT-SCAN-RESULTS
Trying to associate with 00:1b:2f:51:25:70 (SSID='<wpa ap>' freq=2462 MHz)
CTRL-EVENT-SCAN-RESULTS
Associated with 00:1b:2f:51:25:70
WPA: Key negotiation completed with 00:1b:2f:51:25:70 [PTK=CCMP GTK=TKIP]
CTRL-EVENT-CONNECTED - Connection to 00:1b:2f:51:25:70 completed (reauth) [id=0 id_str=]

The dmesg diff is:

--- a   2010-01-15 14:13:47.951510823 +0100
+++ b   2010-01-15 14:13:54.064510826 +0100
@@ -709,3 +709,11 @@
 eth0: RX AssocResp from 00:1b:2f:51:25:70 (capab=0x431 status=0 aid=2)
 eth0: associated
 eth0: no IPv6 routers present
+eth0: deauthenticating from 00:1b:2f:51:25:70 by local choice (reason=3)
+eth0: direct probe to AP 00:1b:2f:51:25:70 (try 1)
+eth0: direct probe responded
+eth0: authenticate with AP 00:1b:2f:51:25:70 (try 1)
+eth0: authenticated
+eth0: associate with AP 00:1b:2f:51:25:70 (try 1)
+eth0: RX AssocResp from 00:1b:2f:51:25:70 (capab=0x431 status=0 aid=2)
+eth0: associated

The MAC you see is the "wpa ap" one, so basically I can't switch to the
linksys AP. (The MAC of the linksys AP - 00:12:17:D3:87:F5 - doesn't
show up in either outputs.)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/8ede359b/attachment.pgp>

From vmiklos at frugalware.org  Fri Jan 15 14:18:26 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 14:18:26 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <b170af451001150208k1c166d97mc67ac04e0b6f5bd4@mail.gmail.com>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>
	<20100115024758.GV29803@genesis.frugalware.org>
	<b170af451001150208k1c166d97mc67ac04e0b6f5bd4@mail.gmail.com>
Message-ID: <20100115131826.GA29803@genesis.frugalware.org>

On Fri, Jan 15, 2010 at 11:08:19AM +0100, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
> > By 2.6.33, you mean that I should give 2.6.33-rc4 a try?
> 
> That's right. You can try wireless-testing as well, currently it
> contains same LP-PHY support level as 33-rc4.

How do I see what's improved?

I just upgraded, and the only thing I could think of is to try "iwconfig
eth0 power off", but that's still not supported:

# iwconfig eth0 power off
Error for wireless request "Set Power Management" (8B2C) :
    SET failed on device eth0 ; Operation not supported.
# uname -r
2.6.33-rc4

Thanks.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/86bee584/attachment.pgp>

From zajec5 at gmail.com  Fri Jan 15 14:30:07 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 14:30:07 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115131826.GA29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<69e28c911001141836q297a24d0q18a00d259fadc91a@mail.gmail.com>
	<20100115024758.GV29803@genesis.frugalware.org>
	<b170af451001150208k1c166d97mc67ac04e0b6f5bd4@mail.gmail.com>
	<20100115131826.GA29803@genesis.frugalware.org>
Message-ID: <b170af451001150530n695f3fdq45949536a030d651@mail.gmail.com>

W dniu 15 stycznia 2010 14:18 u?ytkownik Miklos Vajna
<vmiklos at frugalware.org> napisa?:
> On Fri, Jan 15, 2010 at 11:08:19AM +0100, Rafa? Mi?ecki <zajec5 at gmail.com> wrote:
>> > By 2.6.33, you mean that I should give 2.6.33-rc4 a try?
>>
>> That's right. You can try wireless-testing as well, currently it
>> contains same LP-PHY support level as 33-rc4.
>
> How do I see what's improved?
>
> I just upgraded, and the only thing I could think of is to try "iwconfig
> eth0 power off", but that's still not supported:
>
> # iwconfig eth0 power off
> Error for wireless request "Set Power Management" (8B2C) :
> ? ?SET failed on device eth0 ; Operation not supported.
> # uname -r
> 2.6.33-rc4

Calibration is done initially, by
+       .pwork_15sec            = b43_lpphy_op_pwork_15sec,
+       .pwork_60sec            = lpphy_calibration,

To see what has changed, use "git log" for git or changelog for kernel
from archive.

-- 
Rafa?


From vmiklos at frugalware.org  Fri Jan 15 14:32:24 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Fri, 15 Jan 2010 14:32:24 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115131637.GZ29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
	<20100115035133.18257.qmail@stuge.se>
	<20100115131637.GZ29803@genesis.frugalware.org>
Message-ID: <20100115133224.GB29803@genesis.frugalware.org>

On Fri, Jan 15, 2010 at 02:16:37PM +0100, Miklos Vajna <vmiklos at frugalware.org> wrote:
> The MAC you see is the "wpa ap" one, so basically I can't switch to the
> linksys AP. (The MAC of the linksys AP - 00:12:17:D3:87:F5 - doesn't
> show up in either outputs.)

I just tried what happens when the "wpa ap" is not available, just the
linksys one. It still can't associate, but at least the MAC of the
linksys shows up in the wpa_supplicant output:

CTRL-EVENT-DISCONNECTED - Disconnect event - remove keys
CTRL-EVENT-SCAN-RESULTS
Trying to associate with 00:12:17:d3:87:f5 (SSID='linksys' freq=2462
MHz)
Associated with 00:12:17:d3:87:f5
CTRL-EVENT-CONNECTED - Connection to 00:12:17:d3:87:f5 completed
(reauth) [id=1 id_str=]

So it's like: it's avilable for about 5 secs, then it goes down for 2,
and this loops forever. :/

Again, this is with 2.6.33-rc4. Now my hope is that wireless-testing has
some changes which are not in 2.6.33-rc4 and that solves this issue, but
I'll wait for your experience first. :)

Thanks,

Miklos
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/4af12b44/attachment.pgp>

From zajec5 at gmail.com  Fri Jan 15 16:50:09 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 15 Jan 2010 16:50:09 +0100
Subject: [PATCHes] b43: all N-PHY patches
Message-ID: <op.u6kzlvlp9lhzdc@linux-g0th.site>

John, I spend whole day preparing all that patches to let you apply them easily, but I am not able to create and prepare 32 mails.

Please exceptionally accept that patches sent as archive which I attach.

That patches include fixes from all comments (Michael's mostly). For example (stopped grabbing after few):

0001: used Michael's suggestion to use fls
0002: G?bor Stefanik noticed we lack rev 14, but we didn't meet such device yet
0003: used Michael's suggestion to make tables static and drop definitions
0004: -
0005: formatted to match kernel coding style (thanks Michael for pointing out)
0006: we have to add some over-80-chars-lines there for readability
0007: -
0008: one table definition needs over 80 chars line
0009: this implements init with already corrected condition block noticed recently
b43: N-PHY: implement getting TX gains: some lines over 80 chars

I decided to add tables, structs, definitions as separated patches to make other cleaner.

I didn't add any new code than what last posted. Just updated some comments to don't cause warning (//comment) and don't be more than 80 chars.

0001-b43-use-standard-fls-for-finding-the-most-significan.patch
0002-b43-add-new-SSB-s-core-id-for-BCM4328.patch
0003-b43-N-PHY-clean-table-init-check-PHY-rev.patch
0004-b43-N-PHY-add-shared-memory-offsets-definitions.patch
0005-b43-N-PHY-add-needed-struct-definitions.patch
0006-b43-N-PHY-add-missing-register-definitions.patch
0007-b43-N-PHY-add-global-variables-to-b43_phy_n-struct.patch
0008-b43-N-PHY-add-various-tables.patch
0009-b43-N-PHY-update-init-code-to-match-current-specs.patch
0010-b43-N-PHY-update-CCA-reset.patch
0011-b43-N-PHY-split-RSSI-calibration-into-2-functions-re.patch
0012-b43-N-PHY-add-clip-detection-reading-writing-and-som.patch
0013-b43-N-PHY-implement-RSSI-selection-and-offset-scalin.patch
0014-b43-N-PHY-add-RSSI-polling-and-setting-2055-radio-VC.patch
0015-b43-N-PHY-RSSI-calibration-for-rev-3.patch
0016-b43-N-PHY-implement-PA-overriding-RF-control-related.patch
0017-b43-N-PHY-add-RSSI-calibration-restore.patch
0018-b43-N-PHY-add-function-than-forces-not-staying-in-ca.patch
0019-b43-N-PHY-implement-RX-IQ-coeffs.patch
0020-b43-N-PHY-implement-workaround-for-TX-IQ.patch
0021-b43-N-PHY-implement-restoring-general-configuration.patch
0022-b43-N-PHY-implement-RX-IQ-estimation.patch
0023-b43-N-PHY-implement-calculating-RX-IQ-comp.patch
0024-b43-N-PHY-implement-getting-TX-gains.patch
0025-b43-N-PHY-add-TX-LP-FBW-TX-filter-40-related.patch
0026-b43-N-PHY-add-RX-radio-cores-calibration.patch
0027-b43-N-PHY-update-TX-calibration-ladder.patch
0028-b43-N-PHY-implement-calculating-IQ-gain-params.patch
0029-b43-N-PHY-add-huge-calculating-TX-IQ-LO.patch
0030-b43-N-PHY-add-RX-IQ-calibrationi-for-rev-3.patch
0031-b43-N-PHY-implement-TX-power-control-coef-setup.patch
0032-b43-N-PHY-drop-unused-definition-uncomment-needed-ca.patch

-- 
Rafa?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: b43-N-PHY.tar.gz
Type: application/x-gzip
Size: 27678 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100115/8ac4fab5/attachment.bin>

From Larry.Finger at lwfinger.net  Fri Jan 15 20:59:18 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 15 Jan 2010 13:59:18 -0600
Subject: PHY Transmission error and radio turned off with b43legacy
In-Reply-To: <4B505B94.3020509@scram.de>
References: <51ab59276e22ee681f29560ebac67004.squirrel@unimail.uni-dortmund.de>
	<4B505B94.3020509@scram.de>
Message-ID: <4B50C916.7090303@lwfinger.net>

On 01/15/2010 06:12 AM, Jochen Friedrich wrote:
> Daniel Schmitt wrote:
> 
>> hostapd doesn't continue to work after controller is restarted.
>> I also have the problem that the wlan0-interface shall not be upped with
>> "ifconfig wlan0 0.0.0.0 up" before starting hostapd, otherwise no beacons
>> will be send. The interface must be down before starting hostapd.
>> If I terminate a not daemonized hostapd with CTRL+C and restart if
>> without
>> rmmod+modprobe b43legacy, no beacons are sent, too. And I cannot connect
>> the AP.
>> This happens with the bleeding-edge wireless drivers 2009-11-13.
> 
> I noticed the same on MN700 hardware running OpenWrt bleeding edge. The
> init scripts enable and disable wlan0 once before starting hostapd.
> Here, beacons are still being sent, but hostapd is unable to transmit
> any packet. When reloading b43legacy and starting hostapd manually it
> works, but only once.
> 
> The attached patch resolves the problem for me.

Daniel: Does this patch fix your problem as well?

Has this problem been reported in the kernel bugzilla? If so, what is the number?

How far back does this problem go? From the date of your compat-wireless
package, it seems that 2.6.32 would be affected. How about 2.6.31?

I have tested the patch on my system where it does no harm. I do not run that
system as an AP and had not seen the problem.

As soon as I have the answers to these questions, I will push the patch to
wireless testing.

Thanks for resolving this issue.

Larry


From peter at stuge.se  Sat Jan 16 05:49:48 2010
From: peter at stuge.se (Peter Stuge)
Date: Sat, 16 Jan 2010 05:49:48 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100115133224.GB29803@genesis.frugalware.org>
	<20100115030912.GW29803@genesis.frugalware.org>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
	<20100115035133.18257.qmail@stuge.se>
	<20100115131637.GZ29803@genesis.frugalware.org>
	<20100115133224.GB29803@genesis.frugalware.org>
	<20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
Message-ID: <20100116044948.30936.qmail@stuge.se>

Miklos Vajna wrote:
> > reboot pending to try the latest wireless-testing,
> 
> Please let me know if that helped (which git repo, which branch?).

It did not help. I merged
git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-testing.git master

into my kernel, and have posted a message about it to the ath9k list.


Miklos Vajna wrote:
> So it's like: it's avilable for about 5 secs, then it goes down for
> 2, and this loops forever. :/

My disconnects are nowhere nearly as frequent. I can provoke them
with power management on but with it off my card is very usable.

I suspect there may be a similar problem in the reception path of
both ath9k and b43, leading to the same error in mac80211.


> Again, this is with 2.6.33-rc4. Now my hope is that
> wireless-testing has some changes which are not in 2.6.33-rc4 and
> that solves this issue, but I'll wait for your experience first. :)

Not for me, but I'm also not exercising the b43 code at all, so maybe
there is something for you.. Dunno.

$ git log --oneline dec18..master drivers/net/wireless/b43|grep b43:
81f14df b43: LP-PHY: note and explain specs inconsistency
55afc80 Revert "b43: Enforce DMA descriptor memory constraints"
b02914a b43: Allow PIO mode to be selected at module load
214ac9a b43: Remove reset after fatal DMA error
df98a49 b43: fix two warnings
c2ff581 b43: avoid PPC fault during resume
07681e2 b43: Rewrite DMA Tx status handling sanity checks
9bd568a b43: Enforce DMA descriptor memory constraints
f54a520 b43: Rewrite TX bounce buffer handling
c1b84ab b43: Remove deprecated 'qual' from returned RX status
2c0d610 b43: LP-PHY: Begin implementing calibration & software RFKILL support
72f5f45 b43: use ieee80211_rx_ni()
88499ab b43: Optimize PIO scratchbuffer usage
bdcf8ff b43: Comment unused functions lpphy_restore_dig_flt_state and lpphy_disable_rx_gain_override


//Peter


From vmiklos at frugalware.org  Sat Jan 16 07:08:03 2010
From: vmiklos at frugalware.org (Miklos Vajna)
Date: Sat, 16 Jan 2010 07:08:03 +0100
Subject: No probe response from AP <address> after 500ms, disconnecting.
In-Reply-To: <20100116044948.30936.qmail@stuge.se>
References: <20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
	<20100115035133.18257.qmail@stuge.se>
	<20100115131637.GZ29803@genesis.frugalware.org>
	<20100115133224.GB29803@genesis.frugalware.org>
	<20100115011258.GS29803@genesis.frugalware.org>
	<20100115014619.31031.qmail@stuge.se>
	<20100115030912.GW29803@genesis.frugalware.org>
	<20100116044948.30936.qmail@stuge.se>
Message-ID: <20100116060803.GL29803@genesis.frugalware.org>

On Sat, Jan 16, 2010 at 05:49:48AM +0100, Peter Stuge <peter at stuge.se> wrote:
> > Please let me know if that helped (which git repo, which branch?).
> 
> It did not help. I merged
> git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-testing.git master
> 
> into my kernel, and have posted a message about it to the ath9k list.

:(

OK, for now I think I'll just live with the binary driver
(http://www.broadcom.com/docs/linux_sta/hybrid-portsrc-x86_64-v5.10.91.9.3.tar.gz),
I hate to use external modules, but that one at least works fine for me.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100116/954a3cbe/attachment.pgp>

From zajec5 at gmail.com  Sun Jan 17 13:03:28 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:03:28 +0100
Subject: [PATCH 1/7] b43: N-PHY: implement RX PHY cleanup and setup
Message-ID: <op.u6oefxwh9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   82 ++++++++++++++++++++++++++++++++++++++
  1 files changed, 82 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 4a817e3..4a1853b 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -579,6 +579,88 @@ static void b43_nphy_calc_rx_iq_comp(struct b43_wldev *dev, u8 mask)
  	b43_nphy_rx_iq_coeffs(dev, true, &new);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhyCleanup */
+static void b43_nphy_rx_cal_phy_cleanup(struct b43_wldev *dev, u8 core)
+{
+	u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
+
+	b43_phy_write(dev, B43_NPHY_RFSEQCA, regs[0]);
+	if (core == 0) {
+		b43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
+	} else {
+		b43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
+	}
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[3]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[4]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO1, regs[5]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO2, regs[6]);
+	b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, regs[7]);
+	b43_phy_write(dev, B43_NPHY_RFCTL_OVER, regs[8]);
+	b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
+	b43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhySetup */
+static void b43_nphy_rx_cal_phy_setup(struct b43_wldev *dev, u8 core)
+{
+	u8 rxval, txval;
+	u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
+
+	regs[0] = b43_phy_read(dev, B43_NPHY_RFSEQCA);
+	if (core == 0) {
+		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
+		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
+	} else {
+		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
+		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+	}
+	regs[3] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+	regs[4] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+	regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO1);
+	regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO2);
+	regs[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S1);
+	regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_OVER);
+	regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);
+	regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);
+
+	b43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);
+	b43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);
+
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, (u16)~B43_NPHY_RFSEQCA_RXDIS,
+			((1 - core) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,
+			((1 - core) << B43_NPHY_RFSEQCA_TXEN_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXEN,
+			(core << B43_NPHY_RFSEQCA_RXEN_SHIFT));
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXDIS,
+			(core << B43_NPHY_RFSEQCA_TXDIS_SHIFT));
+
+	if (core == 0) {
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x0007);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0007);
+	} else {
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x0007);
+		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0007);
+	}
+
+	/* TODO: Call N PHY RF Ctrl Intc Override with 2, 0, 3 as arguments */
+	/* TODO: Call N PHY RF Intc Override with 8, 0, 3, 0 as arguments */
+	/* TODO: Call N PHY RF Seq with 0 as argument */
+
+	if (core == 0) {
+		rxval = 1;
+		txval = 8;
+	} else {
+		rxval = 4;
+		txval = 2;
+	}
+
+	/* TODO: Call N PHY RF Ctrl Intc Override with 1, rxval, (core + 1) */
+	/* TODO: Call N PHY RF Ctrl Intc Override with 1, txval, (2 - core) */
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
  static void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)
  {
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:03:32 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:03:32 +0100
Subject: [PATCH 2/7] b43: N-PHY: implement TX PHY cleanup and setup
Message-ID: <op.u6oef6cl9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |  112 +++++++++++++++++++++++++++++++++++++-
  1 files changed, 110 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 4a1853b..34dd4a2 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1505,6 +1505,114 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
  	return target;
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhyCleanup */
+static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
+{
+	u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
+
+	if (dev->phy.rev >= 3) {
+		b43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[0]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[3]);
+		b43_phy_write(dev, B43_NPHY_BBCFG, regs[4]);
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
+			width 16, and data from regs[5] */
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
+			width 16, and data from regs[6] */
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[7]);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[8]);
+		b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
+		b43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);
+		b43_nphy_reset_cca(dev);
+	} else {
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, regs[0]);
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, regs[1]);
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
+			width 16, and data from regs[3] */
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
+			width 16, and data from regs[4] */
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[5]);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[6]);
+	}
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhySetup */
+static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
+{
+	u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
+	u16 tmp;
+
+	regs[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
+	regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
+	if (dev->phy.rev >= 3) {
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0xF0FF, 0x0A00);
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0xF0FF, 0x0A00);
+
+		tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
+		regs[2] = tmp;
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, tmp | 0x0600);
+
+		tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		regs[3] = tmp;
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x0600);
+
+		regs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);
+		b43_phy_mask(dev, B43_NPHY_BBCFG, ~B43_NPHY_BBCFG_RSTRX);
+
+		/* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
+			width 16, and data pointing to tmp */
+		regs[5] = tmp;
+
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
+			width 16, and data 0 */
+		/* TODO: Read an N PHY Table with ID 8, length 1, offset 19,
+			width 16, and data pointing to tmp */
+		regs[6] = tmp;
+
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
+			width 16, and data 0 */
+		regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+		regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+
+		/* TODO: Call N PHY RF Ctrl Intc Override with 2, 1, 3 */
+		/* TODO: Call N PHY RF Ctrl Intc Override with 1, 2, 1 */
+		/* TODO: Call N PHY RF Ctrl Intc Override with 1, 8, 2 */
+
+		regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);
+		regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);
+		b43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);
+		b43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);
+	} else {
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, 0xA000);
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, 0xA000);
+		tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
+		regs[2] = tmp;
+		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);
+		/* TODO: Read an N PHY Table with ID 8, length 1, offset 2,
+			width 16, and data pointing to tmp */
+		regs[3] = tmp;
+		tmp |= 0x2000;
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
+			width 16, and data pointer tmp */
+		/* TODO: Read an N PHY Table with ID 8, length 1, offset 18,
+			width 16, and data pointer tmp */
+		regs[4] = tmp;
+		tmp |= 0x2000;
+		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
+			width 16, and data pointer tmp */
+		regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
+		regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
+			tmp = 0x0180;
+		else
+			tmp = 0x0120;
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);
+		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);
+	}
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */
  static void b43_nphy_restore_cal(struct b43_wldev *dev)
  {
@@ -1617,7 +1725,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		width 16, and data pointer gain */

  	b43_nphy_tx_cal_radio_setup(dev);
-	/* TODO: Call N PHY TX Cal PHY Setup */
+	b43_nphy_tx_cal_phy_setup(dev);

  	phy6or5x = dev->phy.rev >= 6 ||
  		(dev->phy.rev == 5 && nphy->ipa2g_on &&
@@ -1788,7 +1896,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);
  	}

-	/* TODO: Call N PHY TX Cal PHY Cleanup */
+	b43_nphy_tx_cal_phy_cleanup(dev);
  	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
  		width 16, and data from save */

-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:03:40 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:03:40 +0100
Subject: [PATCH 3/7] b43: N-PHY: implement MIMO config update
Message-ID: <op.u6oegeb39lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   16 +++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 34dd4a2..582d6b0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -424,6 +424,20 @@ static void b43_nphy_reset_cca(struct b43_wldev *dev)
  	/* TODO: N PHY Force RF Seq with argument 2 */
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/MIMOConfig */
+static void b43_nphy_update_mimo_config(struct b43_wldev *dev, s32 preamble)
+{
+	u16 mimocfg = b43_phy_read(dev, B43_NPHY_MIMOCFG);
+
+	mimocfg |= B43_NPHY_MIMOCFG_AUTO;
+	if (preamble == 1)
+		mimocfg |= B43_NPHY_MIMOCFG_GFMIX;
+	else
+		mimocfg &= ~B43_NPHY_MIMOCFG_GFMIX;
+
+	b43_phy_write(dev, B43_NPHY_MIMOCFG, mimocfg);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */
  static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
  				u16 samps, u8 time, bool wait)
@@ -2180,7 +2194,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x50);
  	b43_phy_write(dev, B43_NPHY_TXRIFS_FRDEL, 0x30);

-	/* TODO MIMO-Config */
+	b43_nphy_update_mimo_config(dev, nphy->preamble_override);
  	/* TODO Update TX/RX chain */

  	if (phy->rev < 2) {
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 4572866..ae00e3f 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -973,6 +973,7 @@ struct b43_phy_n {
  	bool hang_avoid;
  	bool mute;
  	u16 papd_epsilon_offset[2];
+	s32 preamble_override;

  	u8 mphase_cal_phase_id;
  	u16 mphase_txcal_cmdidx;
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:03:48 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:03:48 +0100
Subject: [PATCH 4/7] b43: N-PHY: implement stopping playback
Message-ID: <op.u6oegmpb9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   34 +++++++++++++++++++++++++++++++---
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 582d6b0..c6d3d5a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -749,6 +749,34 @@ static void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)
  	}
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/stop-playback */
+static void b43_nphy_stop_playback(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u16 tmp;
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	tmp = b43_phy_read(dev, B43_NPHY_SAMP_STAT);
+	if (tmp & 0x1)
+		b43_phy_set(dev, B43_NPHY_SAMP_CMD, B43_NPHY_SAMP_CMD_STOP);
+	else if (tmp & 0x2)
+		b43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, (u16)~0x8000);
+
+	b43_phy_mask(dev, B43_NPHY_SAMP_CMD, ~0x0004);
+
+	if (nphy->bb_mult_save & 0x80000000) {
+		tmp = nphy->bb_mult_save & 0xFFFF;
+		/* TODO: Write an N PHY Table with ID 15, length 1, offset 87,
+			width 16 and data from tmp */
+		nphy->bb_mult_save = 0;
+	}
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */
  static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
  {
@@ -1906,7 +1934,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  				nphy->mphase_txcal_bestcoeffs */
  		}

-		/* TODO: Call N PHY Stop Playback */
+		b43_nphy_stop_playback(dev);
  		b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);
  	}

@@ -2053,7 +2081,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  			/* TODO:Call N PHY RF Ctrl Override with 0x400, tmp[0],
  				3, 0 as arguments */
  			/* TODO: Call N PHY Force RF Seq with 2 as argument */
-			/* TODO: Call N PHT Stop Playback */
+			b43_nphy_stop_playback(dev);

  			if (playtone) {
  				/* TODO: Call N PHY TX Tone with 4000,
@@ -2080,7 +2108,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  				} else {
  					b43_nphy_calc_rx_iq_comp(dev, 1 << i);
  				}
-				/* TODO: Call N PHY Stop Playback */
+				b43_nphy_stop_playback(dev);
  			}

  			if (ret != 0)
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index ae00e3f..d6c92a8 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -974,6 +974,7 @@ struct b43_phy_n {
  	bool mute;
  	u16 papd_epsilon_offset[2];
  	s32 preamble_override;
+	u32 bb_mult_save;

  	u8 mphase_cal_phase_id;
  	u16 mphase_txcal_cmdidx;
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:03:55 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:03:55 +0100
Subject: [PATCH 5/7] b43: N-PHY: implement chain selection
Message-ID: <op.u6oegtv69lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   30 +++++++++++++++++++++++++++++-
  drivers/net/wireless/b43/phy_n.h |    1 +
  2 files changed, 30 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c6d3d5a..d24e2b4 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -438,6 +438,34 @@ static void b43_nphy_update_mimo_config(struct b43_wldev *dev, s32 preamble)
  	b43_phy_write(dev, B43_NPHY_MIMOCFG, mimocfg);
  }

+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Chains */
+static void b43_nphy_update_txrx_chain(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	bool override = false;
+	u16 chain = 0x33;
+
+	if (nphy->txrx_chain == 0) {
+		chain = 0x11;
+		override = true;
+	} else if (nphy->txrx_chain == 1) {
+		chain = 0x22;
+		override = true;
+	}
+
+	b43_phy_maskset(dev, B43_NPHY_RFSEQCA,
+			~(B43_NPHY_RFSEQCA_TXEN | B43_NPHY_RFSEQCA_RXEN),
+			chain);
+
+	if (override)
+		b43_phy_set(dev, B43_NPHY_RFSEQMODE,
+				B43_NPHY_RFSEQMODE_CAOVER);
+	else
+		b43_phy_mask(dev, B43_NPHY_RFSEQMODE,
+				~B43_NPHY_RFSEQMODE_CAOVER);
+}
+
  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */
  static void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,
  				u16 samps, u8 time, bool wait)
@@ -2223,7 +2251,7 @@ int b43_phy_initn(struct b43_wldev *dev)
  	b43_phy_write(dev, B43_NPHY_TXRIFS_FRDEL, 0x30);

  	b43_nphy_update_mimo_config(dev, nphy->preamble_override);
-	/* TODO Update TX/RX chain */
+	b43_nphy_update_txrx_chain(dev);

  	if (phy->rev < 2) {
  		b43_phy_write(dev, B43_NPHY_DUP40_GFBL, 0xAA8);
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index d6c92a8..f5a2766 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -987,6 +987,7 @@ struct b43_phy_n {
  	bool txiqlocal_coeffsvalid;
  	struct b43_phy_n_txpwrindex txpwrindex[2];

+	u8 txrx_chain;
  	u16 tx_rx_cal_phy_saveregs[11];
  	u16 tx_rx_cal_radio_saveregs[22];

-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:04:02 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:04:02 +0100
Subject: [PATCH 6/7] b43: N-PHY: move RF sequence declarations top, add
	missing calls
Message-ID: <op.u6oeg0uf9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   28 ++++++++++++++++------------
  1 files changed, 16 insertions(+), 12 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d24e2b4..34be98b 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -55,6 +55,18 @@ struct nphy_iq_est {
  	u32 q1_pwr;
  };

+enum b43_nphy_rf_sequence {
+	B43_RFSEQ_RX2TX,
+	B43_RFSEQ_TX2RX,
+	B43_RFSEQ_RESET2RX,
+	B43_RFSEQ_UPDATE_GAINH,
+	B43_RFSEQ_UPDATE_GAINL,
+	B43_RFSEQ_UPDATE_GAINU,
+};
+
+static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
+				       enum b43_nphy_rf_sequence seq);
+
  void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
  {//TODO
  }
@@ -421,7 +433,7 @@ static void b43_nphy_reset_cca(struct b43_wldev *dev)
  	udelay(1);
  	b43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);
  	b43_nphy_bmac_clock_fgc(dev, 0);
-	/* TODO: N PHY Force RF Seq with argument 2 */
+	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
  }

  /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/MIMOConfig */
@@ -689,7 +701,7 @@ static void b43_nphy_rx_cal_phy_setup(struct b43_wldev *dev, u8 core)

  	/* TODO: Call N PHY RF Ctrl Intc Override with 2, 0, 3 as arguments */
  	/* TODO: Call N PHY RF Intc Override with 8, 0, 3, 0 as arguments */
-	/* TODO: Call N PHY RF Seq with 0 as argument */
+	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);

  	if (core == 0) {
  		rxval = 1;
@@ -872,15 +884,7 @@ static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
  		b43_nphy_stay_in_carrier_search(dev, false);
  }

-enum b43_nphy_rf_sequence {
-	B43_RFSEQ_RX2TX,
-	B43_RFSEQ_TX2RX,
-	B43_RFSEQ_RESET2RX,
-	B43_RFSEQ_UPDATE_GAINH,
-	B43_RFSEQ_UPDATE_GAINL,
-	B43_RFSEQ_UPDATE_GAINU,
-};
-
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ForceRFSeq */
  static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
  				       enum b43_nphy_rf_sequence seq)
  {
@@ -2156,7 +2160,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  	}

  	/* TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments*/
-	/* TODO: Call N PHY Force RF Seq with 2 as argument */
+	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
  	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
  		width 16, and data from gain_save */

-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 13:04:08 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 13:04:08 +0100
Subject: [PATCH 7/7] b43: N-PHY: store seq mode for proper restoring (follow
	specs)
Message-ID: <op.u6oeg6lf9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |    4 ++--
  1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 34be98b..141d4ed 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -897,6 +897,7 @@ static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
  		[B43_RFSEQ_UPDATE_GAINU]	= B43_NPHY_RFSEQTR_UPGU,
  	};
  	int i;
+	u16 seq_mode = b43_phy_read(dev, B43_NPHY_RFSEQMODE);

  	B43_WARN_ON(seq >= ARRAY_SIZE(trigger));

@@ -910,8 +911,7 @@ static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
  	}
  	b43err(dev->wl, "RF sequence status timeout\n");
  ok:
-	b43_phy_mask(dev, B43_NPHY_RFSEQMODE,
-		     ~(B43_NPHY_RFSEQMODE_CAOVER | B43_NPHY_RFSEQMODE_TROVER));
+	b43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);
  }

  static void b43_nphy_bphy_init(struct b43_wldev *dev)
-- 
1.6.4.2



From netrolller.3d at gmail.com  Sun Jan 17 17:37:29 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 17 Jan 2010 17:37:29 +0100
Subject: [PATCH 2/7] b43: N-PHY: implement TX PHY cleanup and setup
In-Reply-To: <op.u6oef6cl9lhzdc@linux-g0th.site>
References: <op.u6oef6cl9lhzdc@linux-g0th.site>
Message-ID: <69e28c911001170837u4ea715ddn4a8e2001f6c1acc3@mail.gmail.com>

2010/1/17 Rafa? Mi?ecki <zajec5 at gmail.com>:
>
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> ?drivers/net/wireless/b43/phy_n.c | ?112
> +++++++++++++++++++++++++++++++++++++-
> ?1 files changed, 110 insertions(+), 2 deletions(-)
>
> diff --git a/drivers/net/wireless/b43/phy_n.c
> b/drivers/net/wireless/b43/phy_n.c
> index 4a1853b..34dd4a2 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -1505,6 +1505,114 @@ static struct nphy_txgains
> b43_nphy_get_tx_gains(struct b43_wldev *dev)
> ? ? ? ?return target;
> ?}
>
> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhyCleanup */
> +static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
> +{
> + ? ? ? u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
> +
> + ? ? ? if (dev->phy.rev >= 3) {
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[0]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[3]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_BBCFG, regs[4]);
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data from regs[5] */
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset
> 19,

While you are at it, why aren't you programming these table writes?
The table handling functions are AFAIK already in place...

> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data from regs[6] */
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[7]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[8]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);
> + ? ? ? ? ? ? ? b43_nphy_reset_cca(dev);
> + ? ? ? } else {
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, regs[0]);
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, regs[1]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data from regs[3] */
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset
> 18,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data from regs[4] */
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[5]);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[6]);
> + ? ? ? }
> +}
> +
> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhySetup */
> +static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
> +{
> + ? ? ? u16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;
> + ? ? ? u16 tmp;
> +
> + ? ? ? regs[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);
> + ? ? ? regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);
> + ? ? ? if (dev->phy.rev >= 3) {
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0xF0FF, 0x0A00);
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0xF0FF, 0x0A00);
> +
> + ? ? ? ? ? ? ? tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);
> + ? ? ? ? ? ? ? regs[2] = tmp;
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, tmp | 0x0600);
> +
> + ? ? ? ? ? ? ? tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
> + ? ? ? ? ? ? ? regs[3] = tmp;
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x0600);
> +
> + ? ? ? ? ? ? ? regs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);
> + ? ? ? ? ? ? ? b43_phy_mask(dev, B43_NPHY_BBCFG, ~B43_NPHY_BBCFG_RSTRX);
> +
> + ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointing to tmp */
> + ? ? ? ? ? ? ? regs[5] = tmp;
> +
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data 0 */
> + ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 8, length 1, offset 19,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointing to tmp */
> + ? ? ? ? ? ? ? regs[6] = tmp;
> +
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset
> 19,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data 0 */
> + ? ? ? ? ? ? ? regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
> + ? ? ? ? ? ? ? regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
> +
> + ? ? ? ? ? ? ? /* TODO: Call N PHY RF Ctrl Intc Override with 2, 1, 3 */
> + ? ? ? ? ? ? ? /* TODO: Call N PHY RF Ctrl Intc Override with 1, 2, 1 */
> + ? ? ? ? ? ? ? /* TODO: Call N PHY RF Ctrl Intc Override with 1, 8, 2 */
> +
> + ? ? ? ? ? ? ? regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);
> + ? ? ? ? ? ? ? regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);
> + ? ? ? ? ? ? ? b43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);
> + ? ? ? ? ? ? ? b43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);
> + ? ? ? } else {
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, 0xA000);
> + ? ? ? ? ? ? ? b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, 0xA000);
> + ? ? ? ? ? ? ? tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
> + ? ? ? ? ? ? ? regs[2] = tmp;
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);
> + ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 8, length 1, offset 2,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointing to tmp */
> + ? ? ? ? ? ? ? regs[3] = tmp;
> + ? ? ? ? ? ? ? tmp |= 0x2000;
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointer tmp */
> + ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 8, length 1, offset 18,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointer tmp */
> + ? ? ? ? ? ? ? regs[4] = tmp;
> + ? ? ? ? ? ? ? tmp |= 0x2000;
> + ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 8, length 1, offset
> 18,
> + ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointer tmp */
> + ? ? ? ? ? ? ? regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
> + ? ? ? ? ? ? ? regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
> + ? ? ? ? ? ? ? if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
> + ? ? ? ? ? ? ? ? ? ? ? tmp = 0x0180;
> + ? ? ? ? ? ? ? else
> + ? ? ? ? ? ? ? ? ? ? ? tmp = 0x0120;
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);
> + ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);
> + ? ? ? }
> +}
> +
> ?/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */
> ?static void b43_nphy_restore_cal(struct b43_wldev *dev)
> ?{
> @@ -1617,7 +1725,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ?width 16, and data pointer gain */
>
> ? ? ? ?b43_nphy_tx_cal_radio_setup(dev);
> - ? ? ? /* TODO: Call N PHY TX Cal PHY Setup */
> + ? ? ? b43_nphy_tx_cal_phy_setup(dev);
>
> ? ? ? ?phy6or5x = dev->phy.rev >= 6 ||
> ? ? ? ? ? ? ? ?(dev->phy.rev == 5 && nphy->ipa2g_on &&
> @@ -1788,7 +1896,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ?b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);
> ? ? ? ?}
>
> - ? ? ? /* TODO: Call N PHY TX Cal PHY Cleanup */
> + ? ? ? b43_nphy_tx_cal_phy_cleanup(dev);
> ? ? ? ?/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
> ? ? ? ? ? ? ? ?width 16, and data from save */
>
> --
> 1.6.4.2
>
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sun Jan 17 17:41:00 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 17 Jan 2010 17:41:00 +0100
Subject: [PATCH 2/7] b43: N-PHY: implement TX PHY cleanup and setup
In-Reply-To: <69e28c911001170837u4ea715ddn4a8e2001f6c1acc3@mail.gmail.com>
References: <op.u6oef6cl9lhzdc@linux-g0th.site>
	<69e28c911001170837u4ea715ddn4a8e2001f6c1acc3@mail.gmail.com>
Message-ID: <201001171741.02945.mb@bu3sch.de>

On Sunday 17 January 2010 17:37:29 G?bor Stefanik wrote:
> While you are at it, why aren't you programming these table writes?
> The table handling functions are AFAIK already in place...

Because we like small patches.
Please do _not_ increase the patchsize.

-- 
Greetings, Michael.


From netrolller.3d at gmail.com  Sun Jan 17 17:44:42 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 17 Jan 2010 17:44:42 +0100
Subject: [PATCH 2/7] b43: N-PHY: implement TX PHY cleanup and setup
In-Reply-To: <201001171741.02945.mb@bu3sch.de>
References: <op.u6oef6cl9lhzdc@linux-g0th.site>
	<69e28c911001170837u4ea715ddn4a8e2001f6c1acc3@mail.gmail.com> 
	<201001171741.02945.mb@bu3sch.de>
Message-ID: <69e28c911001170844m2dd5beb9j6ebca9292f41f7ce@mail.gmail.com>

On Sun, Jan 17, 2010 at 5:41 PM, Michael Buesch <mb at bu3sch.de> wrote:
> On Sunday 17 January 2010 17:37:29 G?bor Stefanik wrote:
>> While you are at it, why aren't you programming these table writes?
>> The table handling functions are AFAIK already in place...
>
> Because we like small patches.
> Please do _not_ increase the patchsize.

They do not increase patch size - table reads/writes are one-line (in
fact, they are shorter than the placeholder comments in place of
them).

>
> --
> Greetings, Michael.
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Sun Jan 17 17:48:34 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 17:48:34 +0100
Subject: [PATCH 2/7] b43: N-PHY: implement TX PHY cleanup and setup
In-Reply-To: <69e28c911001170844m2dd5beb9j6ebca9292f41f7ce@mail.gmail.com>
References: <op.u6oef6cl9lhzdc@linux-g0th.site>
	<69e28c911001170837u4ea715ddn4a8e2001f6c1acc3@mail.gmail.com>
	<201001171741.02945.mb@bu3sch.de>
	<69e28c911001170844m2dd5beb9j6ebca9292f41f7ce@mail.gmail.com>
Message-ID: <b170af451001170848s27dab1acmac125287dacbb3ae@mail.gmail.com>

2010/1/17 G?bor Stefanik <netrolller.3d at gmail.com>:
> On Sun, Jan 17, 2010 at 5:41 PM, Michael Buesch <mb at bu3sch.de> wrote:
>> On Sunday 17 January 2010 17:37:29 G?bor Stefanik wrote:
>>> While you are at it, why aren't you programming these table writes?
>>> The table handling functions are AFAIK already in place...
>>
>> Because we like small patches.
>> Please do _not_ increase the patchsize.
>
> They do not increase patch size - table reads/writes are one-line (in
> fact, they are shorter than the placeholder comments in place of
> them).

Well, I just started implementing code without understanding of
tables... and got stick in implementing functions. There are some
"crazy" IDs, offsets and it's not only writing but also some
mysterious table reading... You know, it just sounds scary ;)

I'll have to finally read specs/existing code for tables, understand
it and implement.

-- 
Rafa?


From zajec5 at gmail.com  Sun Jan 17 23:37:50 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 23:37:50 +0100
Subject: [PATCH 1/4] b43: N-PHY: add writing one element tables
Message-ID: <op.u6o7s9rq9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c |   51 ++++++++++++-------------------------
  1 files changed, 17 insertions(+), 34 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 141d4ed..31eba7d 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -808,8 +808,7 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)

  	if (nphy->bb_mult_save & 0x80000000) {
  		tmp = nphy->bb_mult_save & 0xFFFF;
-		/* TODO: Write an N PHY Table with ID 15, length 1, offset 87,
-			width 16 and data from tmp */
+		b43_ntab_write(dev, B43_NTAB16(15, 87), tmp);
  		nphy->bb_mult_save = 0;
  	}

@@ -1486,13 +1485,11 @@ static void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)
  	for (i = 0; i < 18; i++) {
  		scale = (ladder_lo[i].percent * tmp) / 100;
  		entry = ((scale & 0xFF) << 8) | ladder_lo[i].g_env;
-		/* TODO: Write an N PHY Table with ID 15, length 1,
-			offset i, width 16, and data entry */
+		b43_ntab_write(dev, B43_NTAB16(15, i), entry);

  		scale = (ladder_iq[i].percent * tmp) / 100;
  		entry = ((scale & 0xFF) << 8) | ladder_iq[i].g_env;
-		/* TODO: Write an N PHY Table with ID 15, length 1,
-			offset i + 32, width 16, and data entry */
+		b43_ntab_write(dev, B43_NTAB16(15, i + 32), entry);
  	}
  }

@@ -1590,10 +1587,8 @@ static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[3]);
  		b43_phy_write(dev, B43_NPHY_BBCFG, regs[4]);
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data from regs[5] */
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data from regs[6] */
+		b43_ntab_write(dev, B43_NTAB16(8, 3), regs[5]);
+		b43_ntab_write(dev, B43_NTAB16(8, 19), regs[6]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[7]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[8]);
  		b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
@@ -1603,10 +1598,8 @@ static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
  		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, regs[0]);
  		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, regs[1]);
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data from regs[3] */
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data from regs[4] */
+		b43_ntab_write(dev, B43_NTAB16(8, 2), regs[3]);
+		b43_ntab_write(dev, B43_NTAB16(8, 18), regs[4]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[5]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[6]);
  	}
@@ -1638,15 +1631,10 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		/* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
  			width 16, and data pointing to tmp */
  		regs[5] = tmp;
-
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data 0 */
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data pointing to tmp */
+		b43_ntab_write(dev, B43_NTAB16(8, 3), 0);
+		b43_ntab_write(dev, B43_NTAB16(8, 19), tmp);
  		regs[6] = tmp;
-
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data 0 */
+		b43_ntab_write(dev, B43_NTAB16(8, 19), 0);
  		regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
  		regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);

@@ -1668,14 +1656,11 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  			width 16, and data pointing to tmp */
  		regs[3] = tmp;
  		tmp |= 0x2000;
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data pointer tmp */
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data pointer tmp */
+		b43_ntab_write(dev, B43_NTAB16(8, 2), tmp);
+		b43_ntab_write(dev, B43_NTAB16(8, 18), tmp);
  		regs[4] = tmp;
  		tmp |= 0x2000;
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data pointer tmp */
+		b43_ntab_write(dev, B43_NTAB16(8, 18), tmp);
  		regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
  		regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
  		if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
@@ -1895,14 +1880,12 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);

  			if (type == 1 || type == 3 || type == 4) {
-				/* TODO: Read an N PHY Table with ID 15,
-					length 1, offset 69 + core,
-					width 16, and data pointer buffer */
+				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
+						buffer[0]);
  				diq_start = buffer[0];
  				buffer[0] = 0;
-				/* TODO: Write an N PHY Table with ID 15,
-					length 1, offset 69 + core, width 16,
-					and data of 0 */
+				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
+						0);
  			}

  			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 23:37:55 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 23:37:55 +0100
Subject: [PATCH 2/4] b43: N-PHY: implement and add multi-dimensional table
	writing
Message-ID: <op.u6o7thcn9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   58 ++++++++++++++------------------
  drivers/net/wireless/b43/tables_nphy.c |   40 ++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    2 +
  3 files changed, 67 insertions(+), 33 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 31eba7d..6fd48d0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1697,8 +1697,7 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  		loft = &nphy->cal_cache.txcal_coeffs_5G[5];
  	}

-	/* TODO: Write an N PHY table with ID 15, length 4, offset 80,
-		width 16, and data from table */
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4, table);

  	for (i = 0; i < 4; i++) {
  		if (dev->phy.rev >= 3)
@@ -1707,12 +1706,9 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  			coef[i] = 0;
  	}

-	/* TODO: Write an N PHY table with ID 15, length 4, offset 88,
-		width 16, and data from coef */
-	/* TODO: Write an N PHY table with ID 15, length 2, offset 85,
-		width 16 and data from loft */
-	/* TODO: Write an N PHY table with ID 15, length 2, offset 93,
-		width 16 and data from loft */
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4, coef);
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2, loft);
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2, loft);

  	if (dev->phy.rev < 2)
  		b43_nphy_tx_iq_workaround(dev);
@@ -1780,8 +1776,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
  		gain[i] = params[i].cal_gain;
  	}
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data pointer gain */
+
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain);

  	b43_nphy_tx_cal_radio_setup(dev);
  	b43_nphy_tx_cal_phy_setup(dev);
@@ -1831,8 +1827,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			}
  		}

-		/* TODO: Write an N PHY Table with ID 15, length from above,
-			offset 64, width 16, and the data pointer from above */
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length, table);

  		if (full) {
  			if (dev->phy.rev >= 3)
@@ -1899,9 +1894,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			/* TODO: Read an N PHY Table with ID 15,
  				length table_length, offset 96, width 16,
  				and data pointer buffer */
-			/* TODO: Write an N PHY Table with ID 15,
-				length table_length, offset 64, width 16,
-				and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,
+						buffer);

  			if (type == 1 || type == 3 || type == 4)
  				buffer[0] = diq_start;
@@ -1913,8 +1907,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		last = (dev->phy.rev < 3) ? 6 : 7;

  		if (!mphase || nphy->mphase_cal_phase_id == last) {
-			/* TODO: Write an N PHY Table with ID 15, length 4,
-				offset 96, width 16, and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);
  			/* TODO: Read an N PHY Table with ID 15, length 4,
  				offset 80, width 16, and data pointer buffer */
  			if (dev->phy.rev < 3) {
@@ -1923,14 +1916,14 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  				buffer[2] = 0;
  				buffer[3] = 0;
  			}
-			/* TODO: Write an N PHY Table with ID 15, length 4,
-				offset 88, width 16, and data pointer buffer */
-			/* TODO: Read an N PHY Table with ID 15, length 2,
-				offset 101, width 16, and data pointer buffer*/
-			/* TODO: Write an N PHY Table with ID 15, length 2,
-				offset 85, width 16, and data pointer buffer */
-			/* TODO: Write an N PHY Table with ID 15, length 2,
-				offset 93, width 16, and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 101), 2,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,
+						buffer);
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
@@ -1954,8 +1947,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  	}

  	b43_nphy_tx_cal_phy_cleanup(dev);
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from save */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, save);

  	if (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id == last))
  		b43_nphy_tx_iq_workaround(dev);
@@ -2005,8 +1997,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
  		cal_gain[i] = cal_params[i].cal_gain;
  	}
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from cal_gain */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, cal_gain);

  	for (i = 0; i < 2; i++) {
  		if (i == 0) {
@@ -2144,8 +2135,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,

  	/* TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments*/
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from gain_save */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);

  	b43_nphy_stay_in_carrier_search(dev, 0);

@@ -2287,8 +2277,10 @@ int b43_phy_initn(struct b43_wldev *dev)
  	if (phy->rev >= 3) {
  		/* TODO */
  	} else {
-		/* TODO Write an N PHY table with ID 26, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table */
-		/* TODO Write an N PHY table with ID 27, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table */
+		b43_ntab_write_bulk(dev, B43_NTAB32(26, 192), 128,
+					b43_ntab_tx_gain_rev0_1_2);
+		b43_ntab_write_bulk(dev, B43_NTAB32(27, 192), 128,
+					b43_ntab_tx_gain_rev0_1_2);
  	}

  	if (nphy->phyrxchain != 3)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 7dff853..fc08be0 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2952,6 +2952,46 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  	assert_ntab_array_sizes();
  }

+void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
+			  unsigned int nr_elements, const void *_data)
+{
+	u32 type, value;
+	const u8 *data = _data;
+	unsigned int i;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+
+	for (i = 0; i < nr_elements; i++) {
+		switch (type) {
+		case B43_NTAB_8BIT:
+			value = *data;
+			data++;
+			B43_WARN_ON(value & ~0xFF);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
+			break;
+		case B43_NTAB_16BIT:
+			value = *((u16 *)data);
+			data += 2;
+			B43_WARN_ON(value & ~0xFFFF);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
+			break;
+		case B43_NTAB_32BIT:
+			value = *((u32 *)data);
+			data += 4;
+			b43_phy_write(dev, B43_NPHY_TABLE_DATAHI, value >> 16);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					value & 0xFFFF);
+			break;
+		default:
+			B43_WARN_ON(1);
+		}
+	}
+}
+
  #define ntab_upload(dev, offset, data) do { \
  		unsigned int i;						\
  		for (i = 0; i < (offset##_SIZE); i++)			\
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 51636d0..d5605df 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -143,6 +143,8 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
+void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
+			  unsigned int nr_elements, const void *_data);

  void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
  void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 23:38:02 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 23:38:02 +0100
Subject: [PATCH 3/4] b43: N-PHY: implement and add reading one element tables
Message-ID: <op.u6o7to019lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |    6 ++----
  drivers/net/wireless/b43/tables_nphy.c |   31 +++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    1 +
  3 files changed, 34 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6fd48d0..298a30a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1628,8 +1628,7 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		regs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);
  		b43_phy_mask(dev, B43_NPHY_BBCFG, ~B43_NPHY_BBCFG_RSTRX);

-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data pointing to tmp */
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 3));
  		regs[5] = tmp;
  		b43_ntab_write(dev, B43_NTAB16(8, 3), 0);
  		b43_ntab_write(dev, B43_NTAB16(8, 19), tmp);
@@ -1652,8 +1651,7 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
  		regs[2] = tmp;
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data pointing to tmp */
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 3));
  		regs[3] = tmp;
  		tmp |= 0x2000;
  		b43_ntab_write(dev, B43_NTAB16(8, 2), tmp);
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index fc08be0..b8aed45 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2919,6 +2919,37 @@ static inline void assert_ntab_array_sizes(void)
  #undef check
  }

+u32 b43_ntab_read(struct b43_wldev *dev, u32 offset)
+{
+	u32 type, value;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	switch (type) {
+	case B43_NTAB_8BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;
+		break;
+	case B43_NTAB_16BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+		break;
+	case B43_NTAB_32BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATAHI);
+		value <<= 16;
+		value |= b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+		break;
+	default:
+		B43_WARN_ON(1);
+		value = 0;
+	}
+
+	return value;
+}
+
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  {
  	u32 type;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index d5605df..64e990a 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -142,6 +142,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL		10
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

+u32 b43_ntab_read(struct b43_wldev *dev, u32 offset);
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
  void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
  			  unsigned int nr_elements, const void *_data);
-- 
1.6.4.2



From zajec5 at gmail.com  Sun Jan 17 23:38:07 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 23:38:07 +0100
Subject: [PATCH 4/4] b43: N-PHY: implement and add multi-dimensional table
	reading
Message-ID: <op.u6o7ttpo9lhzdc@linux-g0th.site>


Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
  drivers/net/wireless/b43/phy_n.c       |   30 ++++++++++-----------------
  drivers/net/wireless/b43/tables_nphy.c |   35 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    2 +
  3 files changed, 48 insertions(+), 19 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 298a30a..abd99a0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -829,8 +829,7 @@ static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
  	if (nphy->hang_avoid)
  		b43_nphy_stay_in_carrier_search(dev, true);

-	/* TODO: Read an N PHY Table with ID 15, length 7, offset 80,
-		width 16, and data pointer buffer */
+	b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);

  	for (i = 0; i < 2; i++) {
  		tmp = ((buffer[i * 2] & 0x3FF) << 10) |
@@ -1507,8 +1506,7 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)

  		if (nphy->hang_avoid)
  			b43_nphy_stay_in_carrier_search(dev, true);
-		/* TODO: Read an N PHY Table with ID 7, length 2,
-			offset 0x110, width 16, and curr_gain */
+		b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, curr_gain);
  		if (nphy->hang_avoid)
  			b43_nphy_stay_in_carrier_search(dev, false);

@@ -1767,8 +1765,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		nphy->hang_avoid = 0;
  	}

-	/* TODO: Read an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data pointer save */
+	b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, save);

  	for (i = 0; i < 2; i++) {
  		b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
@@ -1889,9 +1886,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  				udelay(10);
  			}

-			/* TODO: Read an N PHY Table with ID 15,
-				length table_length, offset 96, width 16,
-				and data pointer buffer */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						buffer);
  			b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,
  						buffer);

@@ -1906,8 +1902,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,

  		if (!mphase || nphy->mphase_cal_phase_id == last) {
  			b43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);
-			/* TODO: Read an N PHY Table with ID 15, length 4,
-				offset 80, width 16, and data pointer buffer */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 4, buffer);
  			if (dev->phy.rev < 3) {
  				buffer[0] = 0;
  				buffer[1] = 0;
@@ -1925,9 +1920,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
-			/* TODO: Read an N PHY Table with ID 15, length length,
-				offset 96, width 16, and data pointer
-				nphy->txiqlocal_bestc */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						nphy->txiqlocal_bestc);
  			nphy->txiqlocal_coeffsvalid = true;
  			/* TODO: Set nphy->txiqlocal_chanspec to
  				the current channel */
@@ -1935,9 +1929,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
-			/* TODO: Read an N PHY Table with ID 5, length length,
-				offset 96, width 16, and data pointer
-				nphy->mphase_txcal_bestcoeffs */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						nphy->mphase_txcal_bestcoeffs);
  		}

  		b43_nphy_stop_playback(dev);
@@ -1989,8 +1982,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,

  	if (dev->phy.rev < 2)
  		;/* TODO: Call N PHY Reapply TX Cal Coeffs */
-	/* TODO: Read an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data gain_save */
+	b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);
  	for (i = 0; i < 2; i++) {
  		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
  		cal_gain[i] = cal_params[i].cal_gain;
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index b8aed45..b8c9fc6 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2950,6 +2950,41 @@ u32 b43_ntab_read(struct b43_wldev *dev, u32 offset)
  	return value;
  }

+void b43_ntab_read_bulk(struct b43_wldev *dev, u32 offset,
+			 unsigned int nr_elements, void *_data)
+{
+	u32 type;
+	u8 *data = _data;
+	unsigned int i;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+
+	for (i = 0; i < nr_elements; i++) {
+		switch (type) {
+		case B43_NTAB_8BIT:
+			*data = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;
+			data++;
+			break;
+		case B43_NTAB_16BIT:
+			*((u16 *)data) = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+			data += 2;
+			break;
+		case B43_NTAB_32BIT:
+			*((u32 *)data) = b43_phy_read(dev, B43_NPHY_TABLE_DATAHI);
+			*((u32 *)data) <<= 16;
+			*((u32 *)data) |= b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+			data += 4;
+			break;
+		default:
+			B43_WARN_ON(1);
+		}
+	}
+}
+
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  {
  	u32 type;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 64e990a..6bbef89 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -143,6 +143,8 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

  u32 b43_ntab_read(struct b43_wldev *dev, u32 offset);
+void b43_ntab_read_bulk(struct b43_wldev *dev, u32 offset,
+			 unsigned int nr_elements, void *_data);
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
  void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
  			  unsigned int nr_elements, const void *_data);
-- 
1.6.4.2



From mb at bu3sch.de  Sun Jan 17 23:45:52 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 17 Jan 2010 23:45:52 +0100
Subject: [PATCH 1/4] b43: N-PHY: add writing one element tables
In-Reply-To: <op.u6o7s9rq9lhzdc@linux-g0th.site>
References: <op.u6o7s9rq9lhzdc@linux-g0th.site>
Message-ID: <201001172345.54110.mb@bu3sch.de>

On Sunday 17 January 2010 23:37:50 Rafa? Mi?ecki wrote:
> @@ -1895,14 +1880,12 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
>   			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);
> 
>   			if (type == 1 || type == 3 || type == 4) {
> -				/* TODO: Read an N PHY Table with ID 15,
> -					length 1, offset 69 + core,
> -					width 16, and data pointer buffer */
> +				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
> +						buffer[0]);
>   				diq_start = buffer[0];
>   				buffer[0] = 0;
> -				/* TODO: Write an N PHY Table with ID 15,
> -					length 1, offset 69 + core, width 16,
> -					and data of 0 */
> +				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
> +						0);
>   			}
> 
>   			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);

What is this supposed to do? It writes a value to a table entry and immediately
clobbers the entry with 0. This doesn't make any sense.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sun Jan 17 23:59:25 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 17 Jan 2010 23:59:25 +0100
Subject: [PATCH 1/4] b43: N-PHY: add writing one element tables
In-Reply-To: <201001172345.54110.mb@bu3sch.de>
References: <op.u6o7s9rq9lhzdc@linux-g0th.site>
	<201001172345.54110.mb@bu3sch.de>
Message-ID: <b170af451001171459s781bf60ao48a2bc937de50bb6@mail.gmail.com>

W dniu 17 stycznia 2010 23:45 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Sunday 17 January 2010 23:37:50 Rafa? Mi?ecki wrote:
>> @@ -1895,14 +1880,12 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
>> ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);
>>
>> ? ? ? ? ? ? ? ? ? ? ? if (type == 1 || type == 3 || type == 4) {
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 15,
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? length 1, offset 69 + core,
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? width 16, and data pointer buffer */
>> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
>> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer[0]);
>> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? diq_start = buffer[0];
>> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer[0] = 0;
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15,
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? length 1, offset 69 + core, width 16,
>> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? and data of 0 */
>> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
>> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? 0);
>> ? ? ? ? ? ? ? ? ? ? ? }
>>
>> ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);
>
> What is this supposed to do? It writes a value to a table entry and immediately
> clobbers the entry with 0. This doesn't make any sense.

Yaiks, you're great at patches reviewing. Thanks once more.

For explanation of my stupid mistake please compare removed comment to
added code...

-- 
Rafa?

From zajec5 at gmail.com  Mon Jan 18 00:21:17 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 00:21:17 +0100
Subject: [PATCH 1/5 V2] b43: N-PHY: add writing one element tables
Message-ID: <op.u6o9toms9lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: don't write instead of reading ;/ Thanks Michael
---
  drivers/net/wireless/b43/phy_n.c |   40 ++++++++++++-------------------------
  1 files changed, 13 insertions(+), 27 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 141d4ed..16f1f9b 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -808,8 +808,7 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)

  	if (nphy->bb_mult_save & 0x80000000) {
  		tmp = nphy->bb_mult_save & 0xFFFF;
-		/* TODO: Write an N PHY Table with ID 15, length 1, offset 87,
-			width 16 and data from tmp */
+		b43_ntab_write(dev, B43_NTAB16(15, 87), tmp);
  		nphy->bb_mult_save = 0;
  	}

@@ -1486,13 +1485,11 @@ static void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)
  	for (i = 0; i < 18; i++) {
  		scale = (ladder_lo[i].percent * tmp) / 100;
  		entry = ((scale & 0xFF) << 8) | ladder_lo[i].g_env;
-		/* TODO: Write an N PHY Table with ID 15, length 1,
-			offset i, width 16, and data entry */
+		b43_ntab_write(dev, B43_NTAB16(15, i), entry);

  		scale = (ladder_iq[i].percent * tmp) / 100;
  		entry = ((scale & 0xFF) << 8) | ladder_iq[i].g_env;
-		/* TODO: Write an N PHY Table with ID 15, length 1,
-			offset i + 32, width 16, and data entry */
+		b43_ntab_write(dev, B43_NTAB16(15, i + 32), entry);
  	}
  }

@@ -1590,10 +1587,8 @@ static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[3]);
  		b43_phy_write(dev, B43_NPHY_BBCFG, regs[4]);
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data from regs[5] */
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data from regs[6] */
+		b43_ntab_write(dev, B43_NTAB16(8, 3), regs[5]);
+		b43_ntab_write(dev, B43_NTAB16(8, 19), regs[6]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[7]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[8]);
  		b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);
@@ -1603,10 +1598,8 @@ static void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)
  		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, regs[0]);
  		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, regs[1]);
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data from regs[3] */
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data from regs[4] */
+		b43_ntab_write(dev, B43_NTAB16(8, 2), regs[3]);
+		b43_ntab_write(dev, B43_NTAB16(8, 18), regs[4]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[5]);
  		b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[6]);
  	}
@@ -1638,15 +1631,11 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		/* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
  			width 16, and data pointing to tmp */
  		regs[5] = tmp;
-
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data 0 */
+		b43_ntab_write(dev, B43_NTAB16(8, 3), 0);
  		/* TODO: Read an N PHY Table with ID 8, length 1, offset 19,
  			width 16, and data pointing to tmp */
  		regs[6] = tmp;
-
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data 0 */
+		b43_ntab_write(dev, B43_NTAB16(8, 19), 0);
  		regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
  		regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);

@@ -1668,14 +1657,12 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  			width 16, and data pointing to tmp */
  		regs[3] = tmp;
  		tmp |= 0x2000;
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data pointer tmp */
+		b43_ntab_write(dev, B43_NTAB16(8, 2), tmp);
  		/* TODO: Read an N PHY Table with ID 8, length 1, offset 18,
  			width 16, and data pointer tmp */
  		regs[4] = tmp;
  		tmp |= 0x2000;
-		/* TODO: Write an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data pointer tmp */
+		b43_ntab_write(dev, B43_NTAB16(8, 18), tmp);
  		regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
  		regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
  		if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
@@ -1900,9 +1887,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  					width 16, and data pointer buffer */
  				diq_start = buffer[0];
  				buffer[0] = 0;
-				/* TODO: Write an N PHY Table with ID 15,
-					length 1, offset 69 + core, width 16,
-					and data of 0 */
+				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
+						0);
  			}

  			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 18 00:21:21 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 00:21:21 +0100
Subject: [PATCH 2/5 V2] b43: N-PHY: implement and add multi-dimensional table
	writing
Message-ID: <op.u6o9tvst9lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: updated to apply without fuzz
---
  drivers/net/wireless/b43/phy_n.c       |   58 ++++++++++++++------------------
  drivers/net/wireless/b43/tables_nphy.c |   40 ++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    2 +
  3 files changed, 67 insertions(+), 33 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 16f1f9b..6b200e5 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1699,8 +1699,7 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  		loft = &nphy->cal_cache.txcal_coeffs_5G[5];
  	}

-	/* TODO: Write an N PHY table with ID 15, length 4, offset 80,
-		width 16, and data from table */
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4, table);

  	for (i = 0; i < 4; i++) {
  		if (dev->phy.rev >= 3)
@@ -1709,12 +1708,9 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
  			coef[i] = 0;
  	}

-	/* TODO: Write an N PHY table with ID 15, length 4, offset 88,
-		width 16, and data from coef */
-	/* TODO: Write an N PHY table with ID 15, length 2, offset 85,
-		width 16 and data from loft */
-	/* TODO: Write an N PHY table with ID 15, length 2, offset 93,
-		width 16 and data from loft */
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4, coef);
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2, loft);
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2, loft);

  	if (dev->phy.rev < 2)
  		b43_nphy_tx_iq_workaround(dev);
@@ -1782,8 +1778,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
  		gain[i] = params[i].cal_gain;
  	}
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data pointer gain */
+
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain);

  	b43_nphy_tx_cal_radio_setup(dev);
  	b43_nphy_tx_cal_phy_setup(dev);
@@ -1833,8 +1829,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			}
  		}

-		/* TODO: Write an N PHY Table with ID 15, length from above,
-			offset 64, width 16, and the data pointer from above */
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length, table);

  		if (full) {
  			if (dev->phy.rev >= 3)
@@ -1902,9 +1897,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			/* TODO: Read an N PHY Table with ID 15,
  				length table_length, offset 96, width 16,
  				and data pointer buffer */
-			/* TODO: Write an N PHY Table with ID 15,
-				length table_length, offset 64, width 16,
-				and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,
+						buffer);

  			if (type == 1 || type == 3 || type == 4)
  				buffer[0] = diq_start;
@@ -1916,8 +1910,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		last = (dev->phy.rev < 3) ? 6 : 7;

  		if (!mphase || nphy->mphase_cal_phase_id == last) {
-			/* TODO: Write an N PHY Table with ID 15, length 4,
-				offset 96, width 16, and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);
  			/* TODO: Read an N PHY Table with ID 15, length 4,
  				offset 80, width 16, and data pointer buffer */
  			if (dev->phy.rev < 3) {
@@ -1926,14 +1919,14 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  				buffer[2] = 0;
  				buffer[3] = 0;
  			}
-			/* TODO: Write an N PHY Table with ID 15, length 4,
-				offset 88, width 16, and data pointer buffer */
-			/* TODO: Read an N PHY Table with ID 15, length 2,
-				offset 101, width 16, and data pointer buffer*/
-			/* TODO: Write an N PHY Table with ID 15, length 2,
-				offset 85, width 16, and data pointer buffer */
-			/* TODO: Write an N PHY Table with ID 15, length 2,
-				offset 93, width 16, and data pointer buffer */
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 101), 2,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,
+						buffer);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,
+						buffer);
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
@@ -1957,8 +1950,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  	}

  	b43_nphy_tx_cal_phy_cleanup(dev);
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from save */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, save);

  	if (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id == last))
  		b43_nphy_tx_iq_workaround(dev);
@@ -2008,8 +2000,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
  		cal_gain[i] = cal_params[i].cal_gain;
  	}
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from cal_gain */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, cal_gain);

  	for (i = 0; i < 2; i++) {
  		if (i == 0) {
@@ -2147,8 +2138,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,

  	/* TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments*/
  	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
-	/* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data from gain_save */
+	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);

  	b43_nphy_stay_in_carrier_search(dev, 0);

@@ -2290,8 +2280,10 @@ int b43_phy_initn(struct b43_wldev *dev)
  	if (phy->rev >= 3) {
  		/* TODO */
  	} else {
-		/* TODO Write an N PHY table with ID 26, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table */
-		/* TODO Write an N PHY table with ID 27, length 128, offset 192, width 32, and the data from Rev 2 TX Power Control Table */
+		b43_ntab_write_bulk(dev, B43_NTAB32(26, 192), 128,
+					b43_ntab_tx_gain_rev0_1_2);
+		b43_ntab_write_bulk(dev, B43_NTAB32(27, 192), 128,
+					b43_ntab_tx_gain_rev0_1_2);
  	}

  	if (nphy->phyrxchain != 3)
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index 7dff853..fc08be0 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2952,6 +2952,46 @@ void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  	assert_ntab_array_sizes();
  }

+void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
+			  unsigned int nr_elements, const void *_data)
+{
+	u32 type, value;
+	const u8 *data = _data;
+	unsigned int i;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+
+	for (i = 0; i < nr_elements; i++) {
+		switch (type) {
+		case B43_NTAB_8BIT:
+			value = *data;
+			data++;
+			B43_WARN_ON(value & ~0xFF);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
+			break;
+		case B43_NTAB_16BIT:
+			value = *((u16 *)data);
+			data += 2;
+			B43_WARN_ON(value & ~0xFFFF);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
+			break;
+		case B43_NTAB_32BIT:
+			value = *((u32 *)data);
+			data += 4;
+			b43_phy_write(dev, B43_NPHY_TABLE_DATAHI, value >> 16);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					value & 0xFFFF);
+			break;
+		default:
+			B43_WARN_ON(1);
+		}
+	}
+}
+
  #define ntab_upload(dev, offset, data) do { \
  		unsigned int i;						\
  		for (i = 0; i < (offset##_SIZE); i++)			\
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 51636d0..d5605df 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -143,6 +143,8 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
+void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
+			  unsigned int nr_elements, const void *_data);

  void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
  void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 18 00:21:27 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 00:21:27 +0100
Subject: [PATCH 3/5 V2] b43: N-PHY: implement and add reading one element
	tables
Message-ID: <op.u6o9t1xp9lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: added missing reads after modification of 1/5
---
  drivers/net/wireless/b43/phy_n.c       |   18 +++++++-----------
  drivers/net/wireless/b43/tables_nphy.c |   31 +++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    1 +
  3 files changed, 39 insertions(+), 11 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6b200e5..6398656 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1628,12 +1628,11 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		regs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);
  		b43_phy_mask(dev, B43_NPHY_BBCFG, ~B43_NPHY_BBCFG_RSTRX);

-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 3,
-			width 16, and data pointing to tmp */
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 3));
  		regs[5] = tmp;
  		b43_ntab_write(dev, B43_NTAB16(8, 3), 0);
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 19,
-			width 16, and data pointing to tmp */
+
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 19));
  		regs[6] = tmp;
  		b43_ntab_write(dev, B43_NTAB16(8, 19), 0);
  		regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
@@ -1653,13 +1652,11 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		tmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);
  		regs[2] = tmp;
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 2,
-			width 16, and data pointing to tmp */
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 2));
  		regs[3] = tmp;
  		tmp |= 0x2000;
  		b43_ntab_write(dev, B43_NTAB16(8, 2), tmp);
-		/* TODO: Read an N PHY Table with ID 8, length 1, offset 18,
-			width 16, and data pointer tmp */
+		tmp = b43_ntab_read(dev, B43_NTAB16(8, 18));
  		regs[4] = tmp;
  		tmp |= 0x2000;
  		b43_ntab_write(dev, B43_NTAB16(8, 18), tmp);
@@ -1877,9 +1874,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);

  			if (type == 1 || type == 3 || type == 4) {
-				/* TODO: Read an N PHY Table with ID 15,
-					length 1, offset 69 + core,
-					width 16, and data pointer buffer */
+				buffer[0] = b43_ntab_read(dev,
+						B43_NTAB16(15, 69 + core));
  				diq_start = buffer[0];
  				buffer[0] = 0;
  				b43_ntab_write(dev, B43_NTAB16(15, 69 + core),
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index fc08be0..b8aed45 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2919,6 +2919,37 @@ static inline void assert_ntab_array_sizes(void)
  #undef check
  }

+u32 b43_ntab_read(struct b43_wldev *dev, u32 offset)
+{
+	u32 type, value;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	switch (type) {
+	case B43_NTAB_8BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;
+		break;
+	case B43_NTAB_16BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+		break;
+	case B43_NTAB_32BIT:
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+		value = b43_phy_read(dev, B43_NPHY_TABLE_DATAHI);
+		value <<= 16;
+		value |= b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+		break;
+	default:
+		B43_WARN_ON(1);
+		value = 0;
+	}
+
+	return value;
+}
+
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  {
  	u32 type;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index d5605df..64e990a 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -142,6 +142,7 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL		10
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

+u32 b43_ntab_read(struct b43_wldev *dev, u32 offset);
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
  void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
  			  unsigned int nr_elements, const void *_data);
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 18 00:21:35 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 00:21:35 +0100
Subject: [PATCH 4/5 V2] b43: N-PHY: implement and add multi-dimensional table
	reading
Message-ID: <op.u6o9t9t19lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: updated to apply without offset
---
  drivers/net/wireless/b43/phy_n.c       |   30 ++++++++++-----------------
  drivers/net/wireless/b43/tables_nphy.c |   35 ++++++++++++++++++++++++++++++++
  drivers/net/wireless/b43/tables_nphy.h |    2 +
  3 files changed, 48 insertions(+), 19 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6398656..2356d84 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -829,8 +829,7 @@ static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
  	if (nphy->hang_avoid)
  		b43_nphy_stay_in_carrier_search(dev, true);

-	/* TODO: Read an N PHY Table with ID 15, length 7, offset 80,
-		width 16, and data pointer buffer */
+	b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);

  	for (i = 0; i < 2; i++) {
  		tmp = ((buffer[i * 2] & 0x3FF) << 10) |
@@ -1507,8 +1506,7 @@ static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)

  		if (nphy->hang_avoid)
  			b43_nphy_stay_in_carrier_search(dev, true);
-		/* TODO: Read an N PHY Table with ID 7, length 2,
-			offset 0x110, width 16, and curr_gain */
+		b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, curr_gain);
  		if (nphy->hang_avoid)
  			b43_nphy_stay_in_carrier_search(dev, false);

@@ -1768,8 +1766,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  		nphy->hang_avoid = 0;
  	}

-	/* TODO: Read an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data pointer save */
+	b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, save);

  	for (i = 0; i < 2; i++) {
  		b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
@@ -1890,9 +1887,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  				udelay(10);
  			}

-			/* TODO: Read an N PHY Table with ID 15,
-				length table_length, offset 96, width 16,
-				and data pointer buffer */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						buffer);
  			b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,
  						buffer);

@@ -1907,8 +1903,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,

  		if (!mphase || nphy->mphase_cal_phase_id == last) {
  			b43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);
-			/* TODO: Read an N PHY Table with ID 15, length 4,
-				offset 80, width 16, and data pointer buffer */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 4, buffer);
  			if (dev->phy.rev < 3) {
  				buffer[0] = 0;
  				buffer[1] = 0;
@@ -1926,9 +1921,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
-			/* TODO: Read an N PHY Table with ID 15, length length,
-				offset 96, width 16, and data pointer
-				nphy->txiqlocal_bestc */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						nphy->txiqlocal_bestc);
  			nphy->txiqlocal_coeffsvalid = true;
  			/* TODO: Set nphy->txiqlocal_chanspec to
  				the current channel */
@@ -1936,9 +1930,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
  			length = 11;
  			if (dev->phy.rev < 3)
  				length -= 2;
-			/* TODO: Read an N PHY Table with ID 5, length length,
-				offset 96, width 16, and data pointer
-				nphy->mphase_txcal_bestcoeffs */
+			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
+						nphy->mphase_txcal_bestcoeffs);
  		}

  		b43_nphy_stop_playback(dev);
@@ -1990,8 +1983,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,

  	if (dev->phy.rev < 2)
  		;/* TODO: Call N PHY Reapply TX Cal Coeffs */
-	/* TODO: Read an N PHY Table with ID 7, length 2, offset 0x110,
-		width 16, and data gain_save */
+	b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);
  	for (i = 0; i < 2; i++) {
  		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
  		cal_gain[i] = cal_params[i].cal_gain;
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index b8aed45..b8c9fc6 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2950,6 +2950,41 @@ u32 b43_ntab_read(struct b43_wldev *dev, u32 offset)
  	return value;
  }

+void b43_ntab_read_bulk(struct b43_wldev *dev, u32 offset,
+			 unsigned int nr_elements, void *_data)
+{
+	u32 type;
+	u8 *data = _data;
+	unsigned int i;
+
+	type = offset & B43_NTAB_TYPEMASK;
+	offset &= ~B43_NTAB_TYPEMASK;
+	B43_WARN_ON(offset > 0xFFFF);
+
+	b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
+
+	for (i = 0; i < nr_elements; i++) {
+		switch (type) {
+		case B43_NTAB_8BIT:
+			*data = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;
+			data++;
+			break;
+		case B43_NTAB_16BIT:
+			*((u16 *)data) = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+			data += 2;
+			break;
+		case B43_NTAB_32BIT:
+			*((u32 *)data) = b43_phy_read(dev, B43_NPHY_TABLE_DATAHI);
+			*((u32 *)data) <<= 16;
+			*((u32 *)data) |= b43_phy_read(dev, B43_NPHY_TABLE_DATALO);
+			data += 4;
+			break;
+		default:
+			B43_WARN_ON(1);
+		}
+	}
+}
+
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)
  {
  	u32 type;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 64e990a..6bbef89 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -143,6 +143,8 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8 channel);
  #define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3		12

  u32 b43_ntab_read(struct b43_wldev *dev, u32 offset);
+void b43_ntab_read_bulk(struct b43_wldev *dev, u32 offset,
+			 unsigned int nr_elements, void *_data);
  void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
  void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
  			  unsigned int nr_elements, const void *_data);
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 18 00:21:49 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 00:21:49 +0100
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
Message-ID: <op.u6o9unx49lhzdc@linux-g0th.site>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
New patch I didn't include earlier.
---
  drivers/net/wireless/b43/phy_n.c |    6 +++---
  1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2356d84..3a3cc2f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1624,7 +1624,7 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
  		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x0600);

  		regs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);
-		b43_phy_mask(dev, B43_NPHY_BBCFG, ~B43_NPHY_BBCFG_RSTRX);
+		b43_phy_mask(dev, B43_NPHY_BBCFG, (u16)~B43_NPHY_BBCFG_RSTRX);

  		tmp = b43_ntab_read(dev, B43_NTAB16(8, 3));
  		regs[5] = tmp;
@@ -1970,7 +1970,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  	u16 lna[3] = { 3, 3, 1 };
  	u16 hpf1[3] = { 7, 2, 0 };
  	u16 hpf2[3] = { 2, 0, 0 };
-	u32 power[3];
+	u32 power[3] = { };
  	u16 gain_save[2];
  	u16 cal_gain[2];
  	struct nphy_iqcal_params cal_params[2];
@@ -2077,7 +2077,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
  					(cur_lna << 2));
  			/* TODO:Call N PHY RF Ctrl Override with 0x400, tmp[0],
  				3, 0 as arguments */
-			/* TODO: Call N PHY Force RF Seq with 2 as argument */
+			b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
  			b43_nphy_stop_playback(dev);

  			if (playtone) {
-- 
1.6.4.2



From netrolller.3d at gmail.com  Mon Jan 18 01:28:40 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Mon, 18 Jan 2010 01:28:40 +0100
Subject: [PATCH 2/5 V2] b43: N-PHY: implement and add multi-dimensional 
	table writing
In-Reply-To: <op.u6o9tvst9lhzdc@linux-g0th.site>
References: <op.u6o9tvst9lhzdc@linux-g0th.site>
Message-ID: <69e28c911001171628s684df11avb3e9f9586e64b69e@mail.gmail.com>

2010/1/18 Rafa? Mi?ecki <zajec5 at gmail.com>:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> V2: updated to apply without fuzz

Actually, you do not need to do that - offset or fuzzy patches will
still be applied cleanly AFAIK, without any intervention.
(John, correct me if I'm wrong here...)

> ---
> ?drivers/net/wireless/b43/phy_n.c ? ? ? | ? 58
> ++++++++++++++------------------
> ?drivers/net/wireless/b43/tables_nphy.c | ? 40 ++++++++++++++++++++++
> ?drivers/net/wireless/b43/tables_nphy.h | ? ?2 +
> ?3 files changed, 67 insertions(+), 33 deletions(-)
>
> diff --git a/drivers/net/wireless/b43/phy_n.c
> b/drivers/net/wireless/b43/phy_n.c
> index 16f1f9b..6b200e5 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -1699,8 +1699,7 @@ static void b43_nphy_restore_cal(struct b43_wldev
> *dev)
> ? ? ? ? ? ? ? ?loft = &nphy->cal_cache.txcal_coeffs_5G[5];
> ? ? ? ?}
>
> - ? ? ? /* TODO: Write an N PHY table with ID 15, length 4, offset 80,
> - ? ? ? ? ? ? ? width 16, and data from table */
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4, table);
>
> ? ? ? ?for (i = 0; i < 4; i++) {
> ? ? ? ? ? ? ? ?if (dev->phy.rev >= 3)
> @@ -1709,12 +1708,9 @@ static void b43_nphy_restore_cal(struct b43_wldev
> *dev)
> ? ? ? ? ? ? ? ? ? ? ? ?coef[i] = 0;
> ? ? ? ?}
>
> - ? ? ? /* TODO: Write an N PHY table with ID 15, length 4, offset 88,
> - ? ? ? ? ? ? ? width 16, and data from coef */
> - ? ? ? /* TODO: Write an N PHY table with ID 15, length 2, offset 85,
> - ? ? ? ? ? ? ? width 16 and data from loft */
> - ? ? ? /* TODO: Write an N PHY table with ID 15, length 2, offset 93,
> - ? ? ? ? ? ? ? width 16 and data from loft */
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4, coef);
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2, loft);
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2, loft);
>
> ? ? ? ?if (dev->phy.rev < 2)
> ? ? ? ? ? ? ? ?b43_nphy_tx_iq_workaround(dev);
> @@ -1782,8 +1778,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ?b43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);
> ? ? ? ? ? ? ? ?gain[i] = params[i].cal_gain;
> ? ? ? ?}
> - ? ? ? /* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
> - ? ? ? ? ? ? ? width 16, and data pointer gain */
> +
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain);
>
> ? ? ? ?b43_nphy_tx_cal_radio_setup(dev);
> ? ? ? ?b43_nphy_tx_cal_phy_setup(dev);
> @@ -1833,8 +1829,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ? ? ? ? ?}
> ? ? ? ? ? ? ? ?}
>
> - ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15, length from above,
> - ? ? ? ? ? ? ? ? ? ? ? offset 64, width 16, and the data pointer from above
> */
> + ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length, table);
>
> ? ? ? ? ? ? ? ?if (full) {
> ? ? ? ? ? ? ? ? ? ? ? ?if (dev->phy.rev >= 3)
> @@ -1902,9 +1897,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ? ? ? ? ?/* TODO: Read an N PHY Table with ID 15,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?length table_length, offset 96, width 16,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?and data pointer buffer */
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? length table_length, offset 64, width 16,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? and data pointer buffer */
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer);
>
> ? ? ? ? ? ? ? ? ? ? ? ?if (type == 1 || type == 3 || type == 4)
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?buffer[0] = diq_start;
> @@ -1916,8 +1910,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ?last = (dev->phy.rev < 3) ? 6 : 7;
>
> ? ? ? ? ? ? ? ?if (!mphase || nphy->mphase_cal_phase_id == last) {
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15, length 4,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? offset 96, width 16, and data pointer buffer
> */
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4,
> buffer);
> ? ? ? ? ? ? ? ? ? ? ? ?/* TODO: Read an N PHY Table with ID 15, length 4,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?offset 80, width 16, and data pointer buffer
> */
> ? ? ? ? ? ? ? ? ? ? ? ?if (dev->phy.rev < 3) {
> @@ -1926,14 +1919,14 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?buffer[2] = 0;
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?buffer[3] = 0;
> ? ? ? ? ? ? ? ? ? ? ? ?}
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15, length 4,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? offset 88, width 16, and data pointer buffer
> */
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Read an N PHY Table with ID 15, length 2,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? offset 101, width 16, and data pointer
> buffer*/
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15, length 2,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? offset 85, width 16, and data pointer buffer
> */
> - ? ? ? ? ? ? ? ? ? ? ? /* TODO: Write an N PHY Table with ID 15, length 2,
> - ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? offset 93, width 16, and data pointer buffer
> */
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer);
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 101), 2,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer);
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer);
> + ? ? ? ? ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? buffer);
> ? ? ? ? ? ? ? ? ? ? ? ?length = 11;
> ? ? ? ? ? ? ? ? ? ? ? ?if (dev->phy.rev < 3)
> ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?length -= 2;
> @@ -1957,8 +1950,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev
> *dev,
> ? ? ? ?}
>
> ? ? ? ?b43_nphy_tx_cal_phy_cleanup(dev);
> - ? ? ? /* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
> - ? ? ? ? ? ? ? width 16, and data from save */
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, save);
>
> ? ? ? ?if (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id ==
> last))
> ? ? ? ? ? ? ? ?b43_nphy_tx_iq_workaround(dev);
> @@ -2008,8 +2000,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev
> *dev,
> ? ? ? ? ? ? ? ?b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
> ? ? ? ? ? ? ? ?cal_gain[i] = cal_params[i].cal_gain;
> ? ? ? ?}
> - ? ? ? /* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
> - ? ? ? ? ? ? ? width 16, and data from cal_gain */
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, cal_gain);
>
> ? ? ? ?for (i = 0; i < 2; i++) {
> ? ? ? ? ? ? ? ?if (i == 0) {
> @@ -2147,8 +2138,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev
> *dev,
>
> ? ? ? ?/* TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as
> arguments*/
> ? ? ? ?b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
> - ? ? ? /* TODO: Write an N PHY Table with ID 7, length 2, offset 0x110,
> - ? ? ? ? ? ? ? width 16, and data from gain_save */
> + ? ? ? b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);
>
> ? ? ? ?b43_nphy_stay_in_carrier_search(dev, 0);
>
> @@ -2290,8 +2280,10 @@ int b43_phy_initn(struct b43_wldev *dev)
> ? ? ? ?if (phy->rev >= 3) {
> ? ? ? ? ? ? ? ?/* TODO */
> ? ? ? ?} else {
> - ? ? ? ? ? ? ? /* TODO Write an N PHY table with ID 26, length 128, offset
> 192, width 32, and the data from Rev 2 TX Power Control Table */
> - ? ? ? ? ? ? ? /* TODO Write an N PHY table with ID 27, length 128, offset
> 192, width 32, and the data from Rev 2 TX Power Control Table */
> + ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB32(26, 192), 128,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? b43_ntab_tx_gain_rev0_1_2);
> + ? ? ? ? ? ? ? b43_ntab_write_bulk(dev, B43_NTAB32(27, 192), 128,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? b43_ntab_tx_gain_rev0_1_2);
> ? ? ? ?}
>
> ? ? ? ?if (nphy->phyrxchain != 3)
> diff --git a/drivers/net/wireless/b43/tables_nphy.c
> b/drivers/net/wireless/b43/tables_nphy.c
> index 7dff853..fc08be0 100644
> --- a/drivers/net/wireless/b43/tables_nphy.c
> +++ b/drivers/net/wireless/b43/tables_nphy.c
> @@ -2952,6 +2952,46 @@ void b43_ntab_write(struct b43_wldev *dev, u32
> offset, u32 value)
> ? ? ? ?assert_ntab_array_sizes();
> ?}
>
> +void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
> + ? ? ? ? ? ? ? ? ? ? ? ? unsigned int nr_elements, const void *_data)
> +{
> + ? ? ? u32 type, value;
> + ? ? ? const u8 *data = _data;
> + ? ? ? unsigned int i;
> +
> + ? ? ? type = offset & B43_NTAB_TYPEMASK;
> + ? ? ? offset &= ~B43_NTAB_TYPEMASK;
> + ? ? ? B43_WARN_ON(offset > 0xFFFF);
> +
> + ? ? ? b43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);
> +
> + ? ? ? for (i = 0; i < nr_elements; i++) {
> + ? ? ? ? ? ? ? switch (type) {
> + ? ? ? ? ? ? ? case B43_NTAB_8BIT:
> + ? ? ? ? ? ? ? ? ? ? ? value = *data;
> + ? ? ? ? ? ? ? ? ? ? ? data++;
> + ? ? ? ? ? ? ? ? ? ? ? B43_WARN_ON(value & ~0xFF);
> + ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
> + ? ? ? ? ? ? ? ? ? ? ? break;
> + ? ? ? ? ? ? ? case B43_NTAB_16BIT:
> + ? ? ? ? ? ? ? ? ? ? ? value = *((u16 *)data);
> + ? ? ? ? ? ? ? ? ? ? ? data += 2;
> + ? ? ? ? ? ? ? ? ? ? ? B43_WARN_ON(value & ~0xFFFF);
> + ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);
> + ? ? ? ? ? ? ? ? ? ? ? break;
> + ? ? ? ? ? ? ? case B43_NTAB_32BIT:
> + ? ? ? ? ? ? ? ? ? ? ? value = *((u32 *)data);
> + ? ? ? ? ? ? ? ? ? ? ? data += 4;
> + ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_TABLE_DATAHI, value >>
> 16);
> + ? ? ? ? ? ? ? ? ? ? ? b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
> + ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? value & 0xFFFF);
> + ? ? ? ? ? ? ? ? ? ? ? break;
> + ? ? ? ? ? ? ? default:
> + ? ? ? ? ? ? ? ? ? ? ? B43_WARN_ON(1);
> + ? ? ? ? ? ? ? }
> + ? ? ? }
> +}
> +
> ?#define ntab_upload(dev, offset, data) do { \
> ? ? ? ? ? ? ? ?unsigned int i; ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? \
> ? ? ? ? ? ? ? ?for (i = 0; i < (offset##_SIZE); i++) ? ? ? ? ? ? ? ? ? \
> diff --git a/drivers/net/wireless/b43/tables_nphy.h
> b/drivers/net/wireless/b43/tables_nphy.h
> index 51636d0..d5605df 100644
> --- a/drivers/net/wireless/b43/tables_nphy.h
> +++ b/drivers/net/wireless/b43/tables_nphy.h
> @@ -143,6 +143,8 @@ b43_nphy_get_chantabent(struct b43_wldev *dev, u8
> channel);
> ?#define B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3 ? ? ? ? 12
>
> ?void b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value);
> +void b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,
> + ? ? ? ? ? ? ? ? ? ? ? ? unsigned int nr_elements, const void *_data);
>
> ?void b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev);
> ?void b43_nphy_rev3plus_tables_init(struct b43_wldev *dev);
> --
> 1.6.4.2
>
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)

From zajec5 at gmail.com  Mon Jan 18 15:16:08 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 18 Jan 2010 15:16:08 +0100
Subject: [PATCH 2/5 V2] b43: N-PHY: implement and add multi-dimensional 
	table writing
In-Reply-To: <69e28c911001171628s684df11avb3e9f9586e64b69e@mail.gmail.com>
References: <op.u6o9tvst9lhzdc@linux-g0th.site>
	<69e28c911001171628s684df11avb3e9f9586e64b69e@mail.gmail.com>
Message-ID: <b170af451001180616w5d79411fka3835e8da04e2bcf@mail.gmail.com>

W dniu 18 stycznia 2010 01:28 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/1/18 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> V2: updated to apply without fuzz
>
> Actually, you do not need to do that - offset or fuzzy patches will
> still be applied cleanly AFAIK, without any intervention.
> (John, correct me if I'm wrong here...)

That's right, it actually did. I just wanted to don't bother John with
wondering if everything gone correctly. I guess I could just mention
it instead of sending patch :)

-- 
Rafa?


From netrolller.3d at gmail.com  Mon Jan 18 16:24:51 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Mon, 18 Jan 2010 16:24:51 +0100
Subject: [PATCH 2/5 V2] b43: N-PHY: implement and add multi-dimensional 
	table writing
In-Reply-To: <b170af451001180616w5d79411fka3835e8da04e2bcf@mail.gmail.com>
References: <op.u6o9tvst9lhzdc@linux-g0th.site>
	<69e28c911001171628s684df11avb3e9f9586e64b69e@mail.gmail.com> 
	<b170af451001180616w5d79411fka3835e8da04e2bcf@mail.gmail.com>
Message-ID: <69e28c911001180724q58ff24eas8b6c72e834a6f818@mail.gmail.com>

You don't even need to mention it, as Git handles offset/fuzzy patches
automatically.

2010/1/18 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 18 stycznia 2010 01:28 u?ytkownik G?bor Stefanik
> <netrolller.3d at gmail.com> napisa?:
>> 2010/1/18 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>> ---
>>> V2: updated to apply without fuzz
>>
>> Actually, you do not need to do that - offset or fuzzy patches will
>> still be applied cleanly AFAIK, without any intervention.
>> (John, correct me if I'm wrong here...)
>
> That's right, it actually did. I just wanted to don't bother John with
> wondering if everything gone correctly. I guess I could just mention
> it instead of sending patch :)
>
> --
> Rafa?
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From linville at tuxdriver.com  Tue Jan 19 22:55:28 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Tue, 19 Jan 2010 16:55:28 -0500
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
In-Reply-To: <op.u6o9unx49lhzdc@linux-g0th.site>
References: <op.u6o9unx49lhzdc@linux-g0th.site>
Message-ID: <20100119215528.GB3078@tuxdriver.com>

On Mon, Jan 18, 2010 at 12:21:49AM +0100, Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> New patch I didn't include earlier.

Rafa?,

I just applied this 5-patch series and the preceding 7-patch series,
and I had to fixup every single one manually due to the apparently
busted mailer you are using.

	User-Agent: Opera Mail/10.10 (Linux)

The only reason I went to this trouble is because a) I want the
N-phy stuff and b) you sent small, manageable patches.  But don't
misunderstand -- I have no intention of continuing to fix these
manually.

Learn to use "git send-email" or find some other mailer to send
your patches -- I recommend Mutt.  In any case, do not expect your
patches to get merged unless in the future unless you can rectify
this situation at your end.  I just don't have the bandwidth for
dealing with crap like this.

Thanks,

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From mcgrof at gmail.com  Tue Jan 19 23:32:24 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Tue, 19 Jan 2010 14:32:24 -0800
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
In-Reply-To: <20100119215528.GB3078@tuxdriver.com>
References: <op.u6o9unx49lhzdc@linux-g0th.site>
	<20100119215528.GB3078@tuxdriver.com>
Message-ID: <43e72e891001191432nc034e52hf58ba47ee0d6d819@mail.gmail.com>

2010/1/19 John W. Linville <linville at tuxdriver.com>:
> On Mon, Jan 18, 2010 at 12:21:49AM +0100, Rafa? Mi?ecki wrote:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> New patch I didn't include earlier.
>
> Rafa?,
>
> I just applied this 5-patch series and the preceding 7-patch series,
> and I had to fixup every single one manually due to the apparently
> busted mailer you are using.
>
> ? ? ? ?User-Agent: Opera Mail/10.10 (Linux)
>
> The only reason I went to this trouble is because a) I want the
> N-phy stuff and b) you sent small, manageable patches. ?But don't
> misunderstand -- I have no intention of continuing to fix these
> manually.
>
> Learn to use "git send-email" or find some other mailer to send
> your patches -- I recommend Mutt. ?In any case, do not expect your
> patches to get merged unless in the future unless you can rectify
> this situation at your end. ?I just don't have the bandwidth for
> dealing with crap like this.

In case this helps:

http://wireless.kernel.org/en/developers/Documentation/git-guide#Sending_patches

  Luis


From zajec5 at gmail.com  Tue Jan 19 23:55:01 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 19 Jan 2010 23:55:01 +0100
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
In-Reply-To: <20100119215528.GB3078@tuxdriver.com>
References: <op.u6o9unx49lhzdc@linux-g0th.site>
	<20100119215528.GB3078@tuxdriver.com>
Message-ID: <b170af451001191455q2f75bef7ndbc946a263e5a597@mail.gmail.com>

W dniu 19 stycznia 2010 22:55 u?ytkownik John W. Linville
<linville at tuxdriver.com> napisa?:
> On Mon, Jan 18, 2010 at 12:21:49AM +0100, Rafa? Mi?ecki wrote:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> New patch I didn't include earlier.
>
> Rafa?,
>
> I just applied this 5-patch series and the preceding 7-patch series,
> and I had to fixup every single one manually due to the apparently
> busted mailer you are using.
>
> ? ? ? ?User-Agent: Opera Mail/10.10 (Linux)
>
> The only reason I went to this trouble is because a) I want the
> N-phy stuff and b) you sent small, manageable patches. ?But don't
> misunderstand -- I have no intention of continuing to fix these
> manually.
>
> Learn to use "git send-email" or find some other mailer to send
> your patches -- I recommend Mutt. ?In any case, do not expect your
> patches to get merged unless in the future unless you can rectify
> this situation at your end. ?I just don't have the bandwidth for
> dealing with crap like this.

John, I strongly believe you know I'm new to whole kernel-related
stuff. That just implies I make mistakes and ask simple questions but
definitely I don't try to make your work harder on purpose. I already
resend some of my first patches and after that no one hit issue you
got with applying my patches.

I have all patches here locally, you could just ask me to resend them
using other method. Didn't have to bother that effort you did and
become angry.

-- 
Rafa?


From zajec5 at gmail.com  Tue Jan 19 23:59:32 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 19 Jan 2010 23:59:32 +0100
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
In-Reply-To: <20100119215528.GB3078@tuxdriver.com>
References: <op.u6o9unx49lhzdc@linux-g0th.site>
	<20100119215528.GB3078@tuxdriver.com>
Message-ID: <b170af451001191459u37b53aeag835c1a5e873791a9@mail.gmail.com>

W dniu 19 stycznia 2010 22:55 u?ytkownik John W. Linville
<linville at tuxdriver.com> napisa?:
> On Mon, Jan 18, 2010 at 12:21:49AM +0100, Rafa? Mi?ecki wrote:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> New patch I didn't include earlier.
>
> Rafa?,
>
> I just applied this 5-patch series and the preceding 7-patch series,
> and I had to fixup every single one manually due to the apparently
> busted mailer you are using.
>
> ? ? ? ?User-Agent: Opera Mail/10.10 (Linux)
>
> The only reason I went to this trouble is because a) I want the
> N-phy stuff and b) you sent small, manageable patches. ?But don't
> misunderstand -- I have no intention of continuing to fix these
> manually.
>
> Learn to use "git send-email" or find some other mailer to send
> your patches -- I recommend Mutt. ?In any case, do not expect your
> patches to get merged unless in the future unless you can rectify
> this situation at your end. ?I just don't have the bandwidth for
> dealing with crap like this.

Out of curiosity, could someone tell what Opera does incorrectly when
sending patches?

-- 
Rafa?


From zajec5 at gmail.com  Wed Jan 20 01:06:37 2010
From: zajec5 at gmail.com (=?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 20 Jan 2010 01:06:37 +0100
Subject: [RFC] How to store HT (40MHz) support
Message-ID: <op.u6s09akf9lhzdc@linux-g0th.site>

In N-PHY code we have to make some decisions based on fact if band is 40MHz.

AFAIU when registering device, driver reports to mac80211 HT capability and this is not implemented yet. For that we will need to modify:
static struct ieee80211_supported_band b43_band_5GHz_nphy = { ... }

Then mac80211 can request switching to 40MHz usage using ieee80211_ops.config (which we handle in b43_op_config).

Is that correct? If so, is attached patch fine for storing 40MHz usage? We don't report HT support to mac80211 so it should not request 40MHz usage for now.




diff --git a/drivers/net/wireless/b43/main.c b/drivers/net/wireless/b43/main.c
index 9c5c7c9..641c7de 100644
--- a/drivers/net/wireless/b43/main.c
+++ b/drivers/net/wireless/b43/main.c
@@ -3571,6 +3571,9 @@ static int b43_op_config(struct ieee80211_hw *hw, u32 changed)
  	dev = wl->current_dev;
  	phy = &dev->phy;

+	if (phy->supports_40mhz)
+		phy->use_40mhz = conf_is_ht(conf);
+
  	b43_mac_suspend(dev);

  	if (changed & IEEE80211_CONF_CHANGE_RETRY_LIMITS)
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index 9edd4e8..62c7028 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -212,6 +212,10 @@ struct b43_phy {
  	bool supports_2ghz;
  	bool supports_5ghz;

+	/* Band width support and usage */
+	bool supports_40mhz;
+	bool use_40mhz;
+
  	/* GMODE bit enabled? */
  	bool gmode;

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index e77f1f2..ed8f372 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1787,7 +1787,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,

  	b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);

-	if (1 /* FIXME: the band width is 20 MHz */)
+	if (!dev->phy.use_40mhz)
  		freq = 2500;
  	else
  		freq = 5000;




-- 
Rafa?


From johannes at sipsolutions.net  Wed Jan 20 11:18:49 2010
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 20 Jan 2010 11:18:49 +0100
Subject: [RFC] How to store HT (40MHz) support
In-Reply-To: <op.u6s09akf9lhzdc@linux-g0th.site>
References: <op.u6s09akf9lhzdc@linux-g0th.site>
Message-ID: <1263982729.14538.5.camel@johannes.local>

On Wed, 2010-01-20 at 01:06 +0100, Rafa? Mi?ecki wrote:

> +	if (phy->supports_40mhz)

That is useless, if it doesn't support it then you should not advertise
it and mac80211 will not use it.

> +		phy->use_40mhz = conf_is_ht(conf);

This is wrong, conf_is_ht might also be 20mhz, look at the other
helpers.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100120/bf60fe91/attachment.pgp>

From mb at bu3sch.de  Wed Jan 20 11:52:18 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 20 Jan 2010 11:52:18 +0100
Subject: [PATCH 5/5 V2] b43: N-PHY: silence warnings, add missing call
In-Reply-To: <b170af451001191459u37b53aeag835c1a5e873791a9@mail.gmail.com>
References: <op.u6o9unx49lhzdc@linux-g0th.site>
	<20100119215528.GB3078@tuxdriver.com>
	<b170af451001191459u37b53aeag835c1a5e873791a9@mail.gmail.com>
Message-ID: <201001201152.18351.mb@bu3sch.de>

On Tuesday 19 January 2010 23:59:32 Rafa? Mi?ecki wrote:
> Out of curiosity, could someone tell what Opera does incorrectly when
> sending patches?

They are base64 encoded.
We use a 7 or 8bit encoding for our mails.
I think that opera automatically switches to base64 encoding due to
the special characters in your first and last name.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Thu Jan 21 16:50:20 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 21 Jan 2010 16:50:20 +0100
Subject: [RFC] How to store HT (40MHz) support
In-Reply-To: <1263982729.14538.5.camel@johannes.local>
References: <op.u6s09akf9lhzdc@linux-g0th.site>
	<1263982729.14538.5.camel@johannes.local>
Message-ID: <b170af451001210750t123a94e2r833e075933c06752@mail.gmail.com>

W dniu 20 stycznia 2010 11:18 u?ytkownik Johannes Berg
<johannes at sipsolutions.net> napisa?:
> On Wed, 2010-01-20 at 01:06 +0100, Rafa? Mi?ecki wrote:
>> + ? ? ? ? ? ? phy->use_40mhz = conf_is_ht(conf);
>
> This is wrong, conf_is_ht might also be 20mhz, look at the other
> helpers.

I tried to understand what actually is HT and after reading many
articles I have more knowledge but still I'm not 100% sure.

AFAIU:
1) HT means using more than 1 stream in channel (and can be on any:
20MHz or 40MHz)
2) conf_is_ht(...) checks if mac80211 want us to use more than 1
stream in channel
3) conf_is_ht40_minus(...) checks if we should use frequency below
current as additional 20MHz, so for example for channel 7 which is
2,431->2,453 we should use additinal 20MHz in channel 3 which is
2,411->2,433
4) conf_is_ht40_plus(...) checks if we should use frequency over
current as additional 20MHz, so for example for channel 3 which is
2,411->2,433 we should use additinal 20MHz in channel 7 which is
2,431->2,453

Is that correct?

-- 
Rafa?


From mcgrof at gmail.com  Thu Jan 21 18:18:09 2010
From: mcgrof at gmail.com (Luis R. Rodriguez)
Date: Thu, 21 Jan 2010 09:18:09 -0800
Subject: [RFC] How to store HT (40MHz) support
In-Reply-To: <b170af451001210750t123a94e2r833e075933c06752@mail.gmail.com>
References: <op.u6s09akf9lhzdc@linux-g0th.site>
	<1263982729.14538.5.camel@johannes.local> 
	<b170af451001210750t123a94e2r833e075933c06752@mail.gmail.com>
Message-ID: <43e72e891001210918m45039636j3d5963e83ae360eb@mail.gmail.com>

2010/1/21 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 20 stycznia 2010 11:18 u?ytkownik Johannes Berg
> <johannes at sipsolutions.net> napisa?:
>> On Wed, 2010-01-20 at 01:06 +0100, Rafa? Mi?ecki wrote:
>>> + ? ? ? ? ? ? phy->use_40mhz = conf_is_ht(conf);
>>
>> This is wrong, conf_is_ht might also be 20mhz, look at the other
>> helpers.
>
> I tried to understand what actually is HT and after reading many
> articles I have more knowledge but still I'm not 100% sure.
>
> AFAIU:
> 1) HT means using more than 1 stream in channel (and can be on any:
> 20MHz or 40MHz)

No, you can have single stream HT devices.

> 2) conf_is_ht(...) checks if mac80211 want us to use more than 1
> stream in channel

No, conf_is_ht() tells you whether or not the current device
configuration is set up to be on HT configuration.

> 3) conf_is_ht40_minus(...) checks if we should use frequency below
> current as additional 20MHz, so for example for channel 7 which is
> 2,431->2,453 we should use additinal 20MHz in channel 3 which is
> 2,411->2,433

Right it just means the secondary channel is on the lower part of the
primary, ht40_plus means its above.

> 4) conf_is_ht40_plus(...) checks if we should use frequency over
> current as additional 20MHz, so for example for channel 3 which is
> 2,411->2,433 we should use additinal 20MHz in channel 7 which is
> 2,431->2,453
>
> Is that correct?

Almost, may want to read this:

http://wireless.kernel.org/en/developers/Documentation/ieee80211/802.11n

I hope that helps.

  Luis


From bransone at ecs.csus.edu  Thu Jan 21 19:53:45 2010
From: bransone at ecs.csus.edu (Eric Branson)
Date: Thu, 21 Jan 2010 10:53:45 -0800 (PST)
Subject: 14e4:4315, 802.11w support?
In-Reply-To: <16577252.39691264099936756.JavaMail.root@venus.ecs.csus.edu>
Message-ID: <29916811.39711264100025968.JavaMail.root@venus.ecs.csus.edu>

What is the current state of b43 support for the 14e4:4315 card (I think rev 01...), and 802.11w support for the same?

-- 
Eric


From zajec5 at gmail.com  Thu Jan 21 20:13:00 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 21 Jan 2010 20:13:00 +0100
Subject: 14e4:4315, 802.11w support?
In-Reply-To: <29916811.39711264100025968.JavaMail.root@venus.ecs.csus.edu>
References: <16577252.39691264099936756.JavaMail.root@venus.ecs.csus.edu>
	<29916811.39711264100025968.JavaMail.root@venus.ecs.csus.edu>
Message-ID: <b170af451001211113n920d9adraeb7d6d53e860127@mail.gmail.com>

2010/1/21 Eric Branson <bransone at ecs.csus.edu>:
> What is the current state of b43 support for the 14e4:4315 card (I think rev 01...), and 802.11w support for the same?

14e4:4315 is supported, just without calibration yet. See
http://wireless.kernel.org/en/users/Drivers/b43

I think we already have partial calibration in wireless-testing (for 2.6.34).

As for 802.11w is this available for all standards? Or just 802.11n?

802.11w is implemented in mac80211 stack we just need someone who will
try this. We need to modify driver to report
"IEEE80211_HW_MFP_CAPABLE" to mac80211 and then test if it works.

-- 
Rafa?


From bransone at ecs.csus.edu  Thu Jan 21 20:39:03 2010
From: bransone at ecs.csus.edu (Eric Branson)
Date: Thu, 21 Jan 2010 11:39:03 -0800 (PST)
Subject: 14e4:4315, 802.11w support?
In-Reply-To: <b170af451001211113n920d9adraeb7d6d53e860127@mail.gmail.com>
Message-ID: <5162422.39871264102743561.JavaMail.root@venus.ecs.csus.edu>

----- "Rafa? Mi?ecki" <zajec5 at gmail.com> wrote:

> As for 802.11w is this available for all standards? Or just 802.11n?

As per the standard, the "amendment is based on IEEE Std 802.11-2007, as amended by IEEE Std 802.11k-2008, IEEE Std 802.11r-2008, and IEEE Std 802.11y-2008."

> 802.11w is implemented in mac80211 stack we just need someone who
> will
> try this. We need to modify driver to report
> "IEEE80211_HW_MFP_CAPABLE" to mac80211 and then test if it works.

How would one go about this? Has anyone been working on or following this and have a patch available? I have the standards available if needed.

-- 
Eric


From zajec5 at gmail.com  Thu Jan 21 21:34:07 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 21 Jan 2010 21:34:07 +0100
Subject: 14e4:4315, 802.11w support?
In-Reply-To: <5162422.39871264102743561.JavaMail.root@venus.ecs.csus.edu>
References: <b170af451001211113n920d9adraeb7d6d53e860127@mail.gmail.com>
	<5162422.39871264102743561.JavaMail.root@venus.ecs.csus.edu>
Message-ID: <b170af451001211234x6a293d8ahf850b201f3f56ea@mail.gmail.com>

2010/1/21 Eric Branson <bransone at ecs.csus.edu>:
> ----- "Rafa? Mi?ecki" <zajec5 at gmail.com> wrote:
>
>> As for 802.11w is this available for all standards? Or just 802.11n?
>
> As per the standard, the "amendment is based on IEEE Std 802.11-2007, as amended by IEEE Std 802.11k-2008, IEEE Std 802.11r-2008, and IEEE Std 802.11y-2008."
>
>> 802.11w is implemented in mac80211 stack we just need someone who
>> will
>> try this. We need to modify driver to report
>> "IEEE80211_HW_MFP_CAPABLE" to mac80211 and then test if it works.
>
> How would one go about this? Has anyone been working on or following this and have a patch available? I have the standards available if needed.

Please, check main.c for function b43_wireless_init. It sets flags
passed to mac80211:

	/* fill hw info */
	hw->flags = IEEE80211_HW_RX_INCLUDES_FCS |
		    IEEE80211_HW_SIGNAL_DBM |
		    IEEE80211_HW_NOISE_DBM;

(white space malformed copy&paste!)

Just try adding new flag (bit or it), get name from:
http://wireless.kernel.org/mac80211book/re02.html

-- 
Rafa?


From zajec5 at gmail.com  Fri Jan 22 01:53:11 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:11 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
Message-ID: <1264121596-9616-1-git-send-email-zajec5@gmail.com>

John, I hope to have patch submission fixed, please let me know if there
is anything wrong still.

Rafa? Mi?ecki (5):
  b43: check band width
  b43: N-PHY: implement overriding RF control
  b43: N-PHY: add running samples
  b43: N-PHY: add setting power amplifier filters
  b43: N-PHY: add TX tone

 drivers/net/wireless/b43/main.c        |    6 +
 drivers/net/wireless/b43/phy_common.h  |    3 +
 drivers/net/wireless/b43/phy_n.c       |  253 ++++++++++++++++++++++++++++++--
 drivers/net/wireless/b43/tables_nphy.c |   61 ++++++++
 drivers/net/wireless/b43/tables_nphy.h |   22 +++
 5 files changed, 330 insertions(+), 15 deletions(-)



From zajec5 at gmail.com  Fri Jan 22 01:53:12 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:12 +0100
Subject: [PATCH 1/5] b43: check band width
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264121596-9616-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/main.c       |    6 ++++++
 drivers/net/wireless/b43/phy_common.h |    3 +++
 drivers/net/wireless/b43/phy_n.c      |    2 +-
 3 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/main.c b/drivers/net/wireless/b43/main.c
index 9c5c7c9..a826e68 100644
--- a/drivers/net/wireless/b43/main.c
+++ b/drivers/net/wireless/b43/main.c
@@ -3571,6 +3571,12 @@ static int b43_op_config(struct ieee80211_hw *hw, u32 changed)
 	dev = wl->current_dev;
 	phy = &dev->phy;
 
+	if (conf_is_ht(conf))
+		phy->is_40mhz =
+			(conf_is_ht40_minus(conf) || conf_is_ht40_plus(conf));
+	else
+		phy->is_40mhz = false;
+
 	b43_mac_suspend(dev);
 
 	if (changed & IEEE80211_CONF_CHANGE_RETRY_LIMITS)
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index 9edd4e8..f635f9e 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -212,6 +212,9 @@ struct b43_phy {
 	bool supports_2ghz;
 	bool supports_5ghz;
 
+	/* HT info */
+	bool is_40mhz;
+
 	/* GMODE bit enabled? */
 	bool gmode;
 
diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index e77f1f2..2cdf32e 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1787,7 +1787,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 
 	b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);
 
-	if (1 /* FIXME: the band width is 20 MHz */)
+	if (!dev->phy.is_40mhz)
 		freq = 2500;
 	else
 		freq = 5000;
-- 
1.6.4.2



From zajec5 at gmail.com  Fri Jan 22 01:53:13 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:13 +0100
Subject: [PATCH 2/5] b43: N-PHY: implement overriding RF control
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264121596-9616-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c       |   82 ++++++++++++++++++++++++++++++-
 drivers/net/wireless/b43/tables_nphy.c |   37 ++++++++++++++
 drivers/net/wireless/b43/tables_nphy.h |   21 ++++++++
 3 files changed, 137 insertions(+), 3 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2cdf32e..d3c9783 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -912,6 +912,82 @@ ok:
 	b43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlOverride */
+static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
+						u16 value, u8 core, bool off)
+{
+	int i;
+	u8 index = fls(field);
+	u8 addr, en_addr, val_addr;
+	/* we expect only one bit set */
+	B43_WARN_ON(field & (~(1 << index)));
+
+	if (dev->phy.rev >= 3) {
+		const struct nphy_rf_control_override_rev3 *rf_ctrl;
+		for (i = 0; i < 2; i++) {
+			if (index == 0 || index == 16) {
+				b43err(dev->wl,
+					"Unsupported RF Ctrl Override call\n");
+				return;
+			}
+
+			rf_ctrl = &tbl_rf_control_override_rev3[index - 1];
+			en_addr = B43_PHY_N((i == 0) ?
+				rf_ctrl->en_addr0 : rf_ctrl->en_addr1);
+			val_addr = B43_PHY_N((i == 0) ?
+				rf_ctrl->val_addr0 : rf_ctrl->val_addr1);
+
+			if (off) {
+				b43_phy_mask(dev, en_addr, ~(field));
+				b43_phy_mask(dev, val_addr,
+						~(rf_ctrl->val_mask));
+			} else {
+				if (core == 0 || ((1 << core) & i) != 0) {
+					b43_phy_set(dev, en_addr, field);
+					b43_phy_maskset(dev, val_addr,
+						~(rf_ctrl->val_mask),
+						(value << rf_ctrl->val_shift));
+				}
+			}
+		}
+	} else {
+		const struct nphy_rf_control_override_rev2 *rf_ctrl;
+		if (off) {
+			b43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~(field));
+			value = 0;
+		} else {
+			b43_phy_set(dev, B43_NPHY_RFCTL_OVER, field);
+		}
+
+		for (i = 0; i < 2; i++) {
+			if (index <= 1 || index == 16) {
+				b43err(dev->wl,
+					"Unsupported RF Ctrl Override call\n");
+				return;
+			}
+
+			if (index == 2 || index == 10 ||
+			    (index >= 13 && index <= 15)) {
+				core = 1;
+			}
+
+			rf_ctrl = &tbl_rf_control_override_rev2[index - 2];
+			addr = B43_PHY_N((i == 0) ?
+				rf_ctrl->addr0 : rf_ctrl->addr1);
+
+			if ((core & (1 << i)) != 0)
+				b43_phy_maskset(dev, addr, ~(rf_ctrl->bmask),
+						(value << rf_ctrl->shift));
+
+			b43_phy_set(dev, B43_NPHY_RFCTL_OVER, 0x1);
+			b43_phy_set(dev, B43_NPHY_RFCTL_CMD,
+					B43_NPHY_RFCTL_CMD_START);
+			udelay(1);
+			b43_phy_mask(dev, B43_NPHY_RFCTL_OVER, 0xFFFE);
+		}
+	}
+}
+
 static void b43_nphy_bphy_init(struct b43_wldev *dev)
 {
 	unsigned int i;
@@ -2075,8 +2151,8 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 
 			tmp[0] = ((cur_hpf2 << 8) | (cur_hpf1 << 4) |
 					(cur_lna << 2));
-			/* TODO:Call N PHY RF Ctrl Override with 0x400, tmp[0],
-				3, 0 as arguments */
+			b43_nphy_rf_control_override(dev, 0x400, tmp[0], 3,
+									false);
 			b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
 			b43_nphy_stop_playback(dev);
 
@@ -2124,7 +2200,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 			break;
 	}
 
-	/* TODO: Call N PHY RF Ctrl Override with 0x400, 0, 3, 1 as arguments*/
+	b43_nphy_rf_control_override(dev, 0x400, 0, 3, true);
 	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
 	b43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);
 
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index b8c9fc6..dd9687d 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2883,6 +2883,43 @@ const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[] = {
 	0x9084, 0x9267, 0x9056, 0x9234
 };
 
+/* addr0,  addr1,  bmask,  shift */
+const struct nphy_rf_control_override_rev2 tbl_rf_control_override_rev2[] = {
+	{ 0x78, 0x78, 0x0038,  3 }, /* for field == 0x0002 (fls == 2) */
+	{ 0x7A, 0x7D, 0x0001,  0 }, /* for field == 0x0004 (fls == 3) */
+	{ 0x7A, 0x7D, 0x0002,  1 }, /* for field == 0x0008 (fls == 4) */
+	{ 0x7A, 0x7D, 0x0004,  2 }, /* for field == 0x0010 (fls == 5) */
+	{ 0x7A, 0x7D, 0x0030,  4 }, /* for field == 0x0020 (fls == 6) */
+	{ 0x7A, 0x7D, 0x00C0,  6 }, /* for field == 0x0040 (fls == 7) */
+	{ 0x7A, 0x7D, 0x0100,  8 }, /* for field == 0x0080 (fls == 8) */
+	{ 0x7A, 0x7D, 0x0200,  9 }, /* for field == 0x0100 (fls == 9) */
+	{ 0x78, 0x78, 0x0004,  2 }, /* for field == 0x0200 (fls == 10) */
+	{ 0x7B, 0x7E, 0x01FF,  0 }, /* for field == 0x0400 (fls == 11) */
+	{ 0x7C, 0x7F, 0x01FF,  0 }, /* for field == 0x0800 (fls == 12) */
+	{ 0x78, 0x78, 0x0100,  8 }, /* for field == 0x1000 (fls == 13) */
+	{ 0x78, 0x78, 0x0200,  9 }, /* for field == 0x2000 (fls == 14) */
+	{ 0x78, 0x78, 0xF000, 12 }  /* for field == 0x4000 (fls == 15) */
+};
+
+/* val_mask, val_shift, en_addr0, val_addr0, en_addr1, val_addr1 */
+const struct nphy_rf_control_override_rev3 tbl_rf_control_override_rev3[] = {
+	{ 0x8000, 15, 0xE5, 0xF9, 0xE6, 0xFB }, /* field == 0x0001 (fls 1) */
+	{ 0x0001,  0, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0002 (fls 2) */
+	{ 0x0002,  1, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0004 (fls 3) */
+	{ 0x0004,  2, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0008 (fls 4) */
+	{ 0x0016,  4, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0010 (fls 5) */
+	{ 0x0020,  5, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0020 (fls 6) */
+	{ 0x0040,  6, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0040 (fls 7) */
+	{ 0x0080,  6, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0080 (fls 8) */
+	{ 0x0100,  7, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0100 (fls 9) */
+	{ 0x0007,  0, 0xE7, 0xF8, 0xEC, 0xFA }, /* field == 0x0200 (fls 10) */
+	{ 0x0070,  4, 0xE7, 0xF8, 0xEC, 0xFA }, /* field == 0x0400 (fls 11) */
+	{ 0xE000, 13, 0xE7, 0x7A, 0xEC, 0x7D }, /* field == 0x0800 (fls 12) */
+	{ 0xFFFF,  0, 0xE7, 0x7B, 0xEC, 0x7E }, /* field == 0x1000 (fls 13) */
+	{ 0xFFFF,  0, 0xE7, 0x7C, 0xEC, 0x7F }, /* field == 0x2000 (fls 14) */
+	{ 0x00C0,  6, 0xE7, 0xF9, 0xEC, 0xFB }  /* field == 0x4000 (fls 15) */
+};
+
 static inline void assert_ntab_array_sizes(void)
 {
 #undef check
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 6bbef89..5d38172 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -51,6 +51,22 @@ struct nphy_txiqcal_ladder {
 	u8 g_env;
 };
 
+struct nphy_rf_control_override_rev2 {
+	u8 addr0;
+	u8 addr1;
+	u16 bmask;
+	u8 shift;
+};
+
+struct nphy_rf_control_override_rev3 {
+	u16 val_mask;
+	u8 val_shift;
+	u8 en_addr0;
+	u8 val_addr0;
+	u8 en_addr1;
+	u8 val_addr1;
+};
+
 /* Upload the default register value table.
  * If "ghz5" is true, we upload the 5Ghz table. Otherwise the 2.4Ghz
  * table is uploaded. If "ignore_uploadflag" is true, we upload any value
@@ -178,4 +194,9 @@ extern const u16 tbl_tx_iqlo_cal_cmds_recal[];
 extern const u16 tbl_tx_iqlo_cal_cmds_fullcal[];
 extern const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[];
 
+extern const struct nphy_rf_control_override_rev2
+	tbl_rf_control_override_rev2[];
+extern const struct nphy_rf_control_override_rev3
+	tbl_rf_control_override_rev3[];
+
 #endif /* B43_TABLES_NPHY_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Fri Jan 22 01:53:15 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:15 +0100
Subject: [PATCH 4/5] b43: N-PHY: add setting power amplifier filters
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264121596-9616-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c       |   41 ++++++++++++++++++++++++++++++-
 drivers/net/wireless/b43/tables_nphy.c |   24 ++++++++++++++++++
 drivers/net/wireless/b43/tables_nphy.h |    1 +
 3 files changed, 64 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index f5900f0..97a44e4 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1628,6 +1628,43 @@ static void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)
 	}
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ExtPaSetTxDigiFilts */
+static void b43_nphy_ext_pa_set_tx_dig_filters(struct b43_wldev *dev)
+{
+	int i;
+	for (i = 0; i < 15; i++)
+		b43_phy_write(dev, B43_PHY_N(0x2C5 + i),
+				tbl_tx_filter_coef_rev4[2][i]);
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IpaSetTxDigiFilts */
+static void b43_nphy_int_pa_set_tx_dig_filters(struct b43_wldev *dev)
+{
+	int i, j;
+	/* B43_NPHY_TXF_20CO_S0A1, B43_NPHY_TXF_40CO_S0A1, unknown */
+	u16 offset[] = { 0x186, 0x195, 0x2C5 };
+
+	for (i = 0; i < 3; i++)
+		for (j = 0; j < 15; j++)
+			b43_phy_write(dev, B43_PHY_N(offset[i] + j),
+					tbl_tx_filter_coef_rev4[i][j]);
+
+	if (dev->phy.is_40mhz) {
+		for (j = 0; j < 15; j++)
+			b43_phy_write(dev, B43_PHY_N(offset[0] + j),
+					tbl_tx_filter_coef_rev4[3][j]);
+	} else if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {
+		for (j = 0; j < 15; j++)
+			b43_phy_write(dev, B43_PHY_N(offset[0] + j),
+					tbl_tx_filter_coef_rev4[5][j]);
+	}
+
+	if (dev->phy.channel == 14)
+		for (j = 0; j < 15; j++)
+			b43_phy_write(dev, B43_PHY_N(offset[0] + j),
+					tbl_tx_filter_coef_rev4[6][j]);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
 static struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)
 {
@@ -2371,9 +2408,9 @@ int b43_phy_initn(struct b43_wldev *dev)
 		b43_phy_set(dev, B43_NPHY_PAPD_EN1, 0x1);
 		b43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F,
 				nphy->papd_epsilon_offset[1] << 7);
-		/* TODO N PHY IPA Set TX Dig Filters */
+		b43_nphy_int_pa_set_tx_dig_filters(dev);
 	} else if (phy->rev >= 5) {
-		/* TODO N PHY Ext PA Set TX Dig Filters */
+		b43_nphy_ext_pa_set_tx_dig_filters(dev);
 	}
 
 	b43_nphy_workarounds(dev);
diff --git a/drivers/net/wireless/b43/tables_nphy.c b/drivers/net/wireless/b43/tables_nphy.c
index dd9687d..a00d509 100644
--- a/drivers/net/wireless/b43/tables_nphy.c
+++ b/drivers/net/wireless/b43/tables_nphy.c
@@ -2883,6 +2883,30 @@ const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[] = {
 	0x9084, 0x9267, 0x9056, 0x9234
 };
 
+const s16 tbl_tx_filter_coef_rev4[7][15] = {
+	{  -377,   137,  -407,   208, -1527,
+	    956,    93,   186,    93,   230,
+	    -44,   230,    20,  -191,   201 },
+	{   -77,    20,   -98,    49,   -93,
+	     60,    56,   111,    56,    26,
+	     -5,    26,    34,   -32,    34 },
+	{  -360,   164,  -376,   164, -1533,
+	    576,   308,  -314,   308,   121,
+	    -73,   121,    91,   124,    91 },
+	{  -295,   200,  -363,   142, -1391,
+	    826,   151,   301,   151,   151,
+	    301,   151,   602,  -752,   602 },
+	{   -92,    58,   -96,    49,  -104,
+	     44,    17,    35,    17,    12,
+	     25,    12,    13,    27,    13 },
+	{  -375,   136,  -399,   209, -1479,
+	    949,   130,   260,   130,   230,
+	    -44,   230,   201,  -191,   201 },
+	{ 0xed9,  0xc8, 0xe95,  0x8e, 0xa91,
+	  0x33a,  0x97, 0x12d,  0x97,  0x97,
+	  0x12d,  0x97, 0x25a, 0xd10, 0x25a }
+};
+
 /* addr0,  addr1,  bmask,  shift */
 const struct nphy_rf_control_override_rev2 tbl_rf_control_override_rev2[] = {
 	{ 0x78, 0x78, 0x0038,  3 }, /* for field == 0x0002 (fls == 2) */
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 5d38172..9c1c6ec 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -193,6 +193,7 @@ extern const u16 tbl_tx_iqlo_cal_cmds_recal_nphyrev3[];
 extern const u16 tbl_tx_iqlo_cal_cmds_recal[];
 extern const u16 tbl_tx_iqlo_cal_cmds_fullcal[];
 extern const u16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[];
+extern const s16 tbl_tx_filter_coef_rev4[7][15];
 
 extern const struct nphy_rf_control_override_rev2
 	tbl_rf_control_override_rev2[];
-- 
1.6.4.2



From zajec5 at gmail.com  Fri Jan 22 01:53:14 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:14 +0100
Subject: [PATCH 3/5] b43: N-PHY: add running samples
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264121596-9616-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   68 +++++++++++++++++++++++++++++++++++--
 1 files changed, 64 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d3c9783..f5900f0 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -816,6 +816,66 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */
+static void b43_nphy_run_samples(struct b43_wldev *dev, u16 samps, u16 loops,
+					u16 wait, bool iqmode, bool dac_test)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	int i;
+	u16 seq_mode;
+	u32 tmp;
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, true);
+
+	if ((nphy->bb_mult_save & 0x80000000) == 0) {
+		tmp = b43_ntab_read(dev, B43_NTAB16(15, 87));
+		nphy->bb_mult_save = (tmp & 0xFFFF) | 0x80000000;
+	}
+
+	if (!dev->phy.is_40mhz)
+		tmp = 0x6464;
+	else
+		tmp = 0x4747;
+	b43_ntab_write(dev, B43_NTAB16(15, 87), tmp);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, false);
+
+	b43_phy_write(dev, B43_NPHY_SAMP_DEPCNT, (samps - 1));
+
+	if (loops != 0xFFFF)
+		b43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, (loops - 1));
+	else
+		b43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, loops);
+
+	b43_phy_write(dev, B43_NPHY_SAMP_WAITCNT, wait);
+
+	seq_mode = b43_phy_read(dev, B43_NPHY_RFSEQMODE);
+
+	b43_phy_set(dev, B43_NPHY_RFSEQMODE, B43_NPHY_RFSEQMODE_CAOVER);
+	if (iqmode) {
+		b43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x7FFF);
+		b43_phy_set(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8000);
+	} else {
+		if (dac_test)
+			b43_phy_write(dev, B43_NPHY_SAMP_CMD, 5);
+		else
+			b43_phy_write(dev, B43_NPHY_SAMP_CMD, 1);
+	}
+	for (i = 0; i < 100; i++) {
+		if (b43_phy_read(dev, B43_NPHY_RFSEQST) & 1) {
+			i = 0;
+			break;
+		}
+		udelay(10);
+	}
+	if (i)
+		b43err(dev->wl, "run samples timeout\n");
+
+	b43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */
 static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
 {
@@ -1869,8 +1929,8 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 		freq = 5000;
 
 	if (nphy->mphase_cal_phase_id > 2)
-		;/* TODO: Call N PHY Run Samples with (band width * 8),
-			0xFFFF, 0, 1, 0 as arguments */
+		b43_nphy_run_samples(dev, (dev->phy.is_40mhz ? 40 : 20) * 8,
+					0xFFFF, 0, true, false);
 	else
 		;/* TODO: Call N PHY TX Tone with freq, 250, 1, 0 as arguments
 			and save result as error */
@@ -2162,8 +2222,8 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 					as arguments and save result as ret */
 				playtone = false;
 			} else {
-				/* TODO: Call N PHY Run Samples with 160,
-					0xFFFF, 0, 0, 0 as arguments */
+				b43_nphy_run_samples(dev, 160, 0xFFFF, 0,
+							false, false);
 			}
 
 			if (ret == 0) {
-- 
1.6.4.2



From zajec5 at gmail.com  Fri Jan 22 01:53:16 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Fri, 22 Jan 2010 01:53:16 +0100
Subject: [PATCH 5/5] b43: N-PHY: add TX tone
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264121596-9616-6-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   60 ++++++++++++++++++++++++++++++++++---
 1 files changed, 55 insertions(+), 5 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 97a44e4..a45a1f3 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -816,6 +816,43 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */
+static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
+					bool test)
+{
+	int i;
+	u16 bw, len, num, rot, angle;
+	/* TODO: *buffer; */
+
+	bw = (dev->phy.is_40mhz) ? 40 : 20;
+	len = bw << 3;
+
+	if (test) {
+		if (b43_phy_read(dev, B43_NPHY_BBCFG) & B43_NPHY_BBCFG_RSTRX)
+			bw = 82;
+		else
+			bw = 80;
+
+		if (dev->phy.is_40mhz)
+			bw <<= 1;
+
+		len = bw << 1;
+	}
+
+	/* TODO: buffer = kzalloc(len * sizeof(u32), GFP_KERNEL); */
+	num = len;
+	rot = (((freq * 36) / bw) << 16) / 100;
+	angle = 0;
+
+	for (i = 0; i < num; i++) {
+		/* TODO */
+	}
+
+	/* TODO: Call N PHY Load Sample Table with buffer, num as arguments */
+	/* TODO: kfree(buffer); */
+	return num;
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */
 static void b43_nphy_run_samples(struct b43_wldev *dev, u16 samps, u16 loops,
 					u16 wait, bool iqmode, bool dac_test)
@@ -876,6 +913,20 @@ static void b43_nphy_run_samples(struct b43_wldev *dev, u16 samps, u16 loops,
 	b43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);
 }
 
+/*
+ * Transmits a known value for LO calibration
+ * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TXTone
+ */
+static int b43_nphy_tx_tone(struct b43_wldev *dev, u32 freq, u16 max_val,
+				bool iqmode, bool dac_test)
+{
+	u16 samp = b43_nphy_gen_load_samples(dev, freq, max_val, dac_test);
+	if (samp == 0)
+		return -1;
+	b43_nphy_run_samples(dev, samp, 0xFFFF, 0, iqmode, dac_test);
+	return 0;
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */
 static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
 {
@@ -1969,8 +2020,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 		b43_nphy_run_samples(dev, (dev->phy.is_40mhz ? 40 : 20) * 8,
 					0xFFFF, 0, true, false);
 	else
-		;/* TODO: Call N PHY TX Tone with freq, 250, 1, 0 as arguments
-			and save result as error */
+		error = b43_nphy_tx_tone(dev, freq, 250, true, false);
 
 	if (error == 0) {
 		if (nphy->mphase_cal_phase_id > 2) {
@@ -2254,9 +2304,9 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 			b43_nphy_stop_playback(dev);
 
 			if (playtone) {
-				/* TODO: Call N PHY TX Tone with 4000,
-					(nphy_rxcalparams & 0xffff), 0, 0
-					as arguments and save result as ret */
+				ret = b43_nphy_tx_tone(dev, 4000,
+						(nphy->rxcalparams & 0xFFFF),
+						false, false);
 				playtone = false;
 			} else {
 				b43_nphy_run_samples(dev, 160, 0xFFFF, 0,
-- 
1.6.4.2



From netrolller.3d at gmail.com  Fri Jan 22 16:01:37 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 22 Jan 2010 16:01:37 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>

2010/1/22 Rafa? Mi?ecki <zajec5 at gmail.com>:
> John, I hope to have patch submission fixed, please let me know if there
> is anything wrong still.

Nope, it is still base64-encoded.

I personally use Thunderbird 2 for patch submission (had weird
problems with Thunderbird 3 beta - not sure about the final version).

>
> Rafa? Mi?ecki (5):
> ?b43: check band width
> ?b43: N-PHY: implement overriding RF control
> ?b43: N-PHY: add running samples
> ?b43: N-PHY: add setting power amplifier filters
> ?b43: N-PHY: add TX tone
>
> ?drivers/net/wireless/b43/main.c ? ? ? ?| ? ?6 +
> ?drivers/net/wireless/b43/phy_common.h ?| ? ?3 +
> ?drivers/net/wireless/b43/phy_n.c ? ? ? | ?253 ++++++++++++++++++++++++++++++--
> ?drivers/net/wireless/b43/tables_nphy.c | ? 61 ++++++++
> ?drivers/net/wireless/b43/tables_nphy.h | ? 22 +++
> ?5 files changed, 330 insertions(+), 15 deletions(-)
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Jan 22 16:21:21 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jan 2010 09:21:21 -0600
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>
Message-ID: <4B59C271.7000701@lwfinger.net>

On 01/22/2010 09:01 AM, G?bor Stefanik wrote:
> 2010/1/22 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> John, I hope to have patch submission fixed, please let me know if there
>> is anything wrong still.
> 
> Nope, it is still base64-encoded.
> 
> I personally use Thunderbird 2 for patch submission (had weird
> problems with Thunderbird 3 beta - not sure about the final version).

I am reading mail with Thunderbird 3.0beta4, and only patch 1/5 was
base64-encoded. The other 4 were fine.

For the record, the final version of TBird 3 cannot read my profile. I battled
with the devs for a while, but have now given up.

Larry



From zajec5 at gmail.com  Fri Jan 22 21:47:03 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 22 Jan 2010 21:47:03 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>
Message-ID: <b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>

W dniu 22 stycznia 2010 16:01 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/1/22 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> John, I hope to have patch submission fixed, please let me know if there
>> is anything wrong still.
>
> Nope, it is still base64-encoded.
>
> I personally use Thunderbird 2 for patch submission (had weird
> problems with Thunderbird 3 beta - not sure about the final version).

I start hating that :| I checked for headers and all messages seem to have same:


Return-path: <zajec5 at gmail.com>
Received: from localhost.localdomain (c3-107.icpnet.pl [62.21.3.107]) by
 mx.google.com with ESMTPS id 16sm1347862ewy.14.2010.01.21.16.53.24
 (version=TLSv1/SSLv3 cipher=RC4-MD5); Thu, 21 Jan 2010 16:53:25 -0800 (PST)
From: =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?= <zajec5 at gmail.com>
To: linux-wireless at vger.kernel.org, "John W. Linville"
 <linville at tuxdriver.com>
Cc: bcm43xx-dev at lists.berlios.de, =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=
 <zajec5 at gmail.com>
Subject: [PATCH 1/5] b43: check band width
Date: Fri, 22 Jan 2010 01:53:12 +0100
Message-ID: <1264121596-9616-2-git-send-email-zajec5 at gmail.com>
X-Mailer: git-send-email 1.6.4.2
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5 at gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5 at gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa?? Mi??ecki <zajec5 at gmail.com>


=====


Return-path: <zajec5 at gmail.com>
Received: from localhost.localdomain (c3-107.icpnet.pl [62.21.3.107]) by
 mx.google.com with ESMTPS id 16sm1347862ewy.14.2010.01.21.16.53.12
 (version=TLSv1/SSLv3 cipher=RC4-MD5); Thu, 21 Jan 2010 16:53:12 -0800 (PST)
From: =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?= <zajec5 at gmail.com>
To: linux-wireless at vger.kernel.org, "John W. Linville"
 <linville at tuxdriver.com>
Cc: bcm43xx-dev at lists.berlios.de, =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=
 <zajec5 at gmail.com>
Subject: [PATCH 0/5] b43: more N-PHY stuff
Date: Fri, 22 Jan 2010 01:53:11 +0100
Message-ID: <1264121596-9616-1-git-send-email-zajec5 at gmail.com>
X-Mailer: git-send-email 1.6.4.2
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

John, I hope to have patch submission fixed, please let me know if there
is anything wrong still.


=====


Return-path: <zajec5 at gmail.com>
Received: from localhost.localdomain (c3-107.icpnet.pl [62.21.3.107]) by
 mx.google.com with ESMTPS id 16sm1347862ewy.14.2010.01.21.16.53.34
 (version=TLSv1/SSLv3 cipher=RC4-MD5); Thu, 21 Jan 2010 16:53:34 -0800 (PST)
From: =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?= <zajec5 at gmail.com>
To: linux-wireless at vger.kernel.org, "John W. Linville"
 <linville at tuxdriver.com>
Cc: bcm43xx-dev at lists.berlios.de, =?utf-8?B?UmFmYcWCIE1pxYJlY2tp?=
 <zajec5 at gmail.com>
Subject: [PATCH 2/5] b43: N-PHY: implement overriding RF control
Date: Fri, 22 Jan 2010 01:53:13 +0100
Message-ID: <1264121596-9616-3-git-send-email-zajec5 at gmail.com>
X-Mailer: git-send-email 1.6.4.2
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5 at gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5 at gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafa?? Mi??ecki <zajec5 at gmail.com>


As you can see I've used git send-email for submission this time! I've
no idea what I did wrong that patch 1/5 was sent incorrectly. I just
generated patches with
git format-patch --cover-letter -o b43
, then modified 0000-...patch (ONLY this one) and finally sent all
patches from b43 directory.

-- 
Rafa?


From linville at tuxdriver.com  Fri Jan 22 22:32:18 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 22 Jan 2010 16:32:18 -0500
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
Message-ID: <20100122213218.GD15055@tuxdriver.com>

On Fri, Jan 22, 2010 at 01:53:11AM +0100, Rafa? Mi?ecki wrote:
> John, I hope to have patch submission fixed, please let me know if there
> is anything wrong still.

This batch applied with no problems -- thanks, Rafa?!

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From mb at bu3sch.de  Fri Jan 22 22:59:26 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jan 2010 22:59:26 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<69e28c911001220701n7de4f943t60a9eda2b7791608@mail.gmail.com>
	<b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>
Message-ID: <201001222259.28933.mb@bu3sch.de>

On Friday 22 January 2010 21:47:03 Rafa? Mi?ecki wrote:
> As you can see I've used git send-email for submission this time! I've
> no idea what I did wrong that patch 1/5 was sent incorrectly. I just
> generated patches with
> git format-patch --cover-letter -o b43
> , then modified 0000-...patch (ONLY this one) and finally sent all
> patches from b43 directory.

The mails may be re-encoded on intermediate mailservers.
My server, for example, re-encodes all of your mails to base64.
(or it may be the list-mailserver re-encoding the mails, because by server
doesn't advertise the correct flags, I dunno...)
I don't know why it does this, however. I'm still pretty sure that it's related
to the characters in your name. Does anybody has an idea how to fix this? I'm using exim.

-- 
Greetings, Michael.


From mb at bu3sch.de  Fri Jan 22 23:33:40 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jan 2010 23:33:40 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <201001222259.28933.mb@bu3sch.de>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>
	<201001222259.28933.mb@bu3sch.de>
Message-ID: <201001222333.42554.mb@bu3sch.de>

On Friday 22 January 2010 22:59:26 Michael Buesch wrote:
> On Friday 22 January 2010 21:47:03 Rafa? Mi?ecki wrote:
> > As you can see I've used git send-email for submission this time! I've
> > no idea what I did wrong that patch 1/5 was sent incorrectly. I just
> > generated patches with
> > git format-patch --cover-letter -o b43
> > , then modified 0000-...patch (ONLY this one) and finally sent all
> > patches from b43 directory.
> 
> The mails may be re-encoded on intermediate mailservers.
> My server, for example, re-encodes all of your mails to base64.
> (or it may be the list-mailserver re-encoding the mails, because by server
> doesn't advertise the correct flags, I dunno...)
> I don't know why it does this, however. I'm still pretty sure that it's related
> to the characters in your name. Does anybody has an idea how to fix this? I'm using exim.
> 

Oh, I just realize that these patches received via vger.kernel.org list are just fine.
It's just berlios' mailman which mangles the mails for me. Which is not surprising,
because berlios is a really really broken platform and its mailservers are even worse than that.

So I guess everything is fine now.

So while we are at it, I'd really like to migrate away from the berlios list.
It's really just annoying. Does somebody have a good reliable mailinglist service
we could migrate to? Does vger offer lists to driver projects?

-- 
Greetings, Michael.


From linville at tuxdriver.com  Sat Jan 23 02:16:19 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 22 Jan 2010 20:16:19 -0500
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <201001222333.42554.mb@bu3sch.de>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>
	<201001222259.28933.mb@bu3sch.de> <201001222333.42554.mb@bu3sch.de>
Message-ID: <20100123011618.GA16135@tuxdriver.com>

On Fri, Jan 22, 2010 at 11:33:40PM +0100, Michael Buesch wrote:

> So while we are at it, I'd really like to migrate away from the berlios list.
> It's really just annoying. Does somebody have a good reliable mailinglist service
> we could migrate to? Does vger offer lists to driver projects?

Probably -- I think davem is the person to ask?  Infradead is probably
another option (dwmw2).

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From dwmw2 at infradead.org  Sat Jan 23 04:36:50 2010
From: dwmw2 at infradead.org (David Woodhouse)
Date: Sat, 23 Jan 2010 16:36:50 +1300
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <20100123011618.GA16135@tuxdriver.com>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<b170af451001221247j1b380703w4c09b5fdd601466b@mail.gmail.com>
	<201001222259.28933.mb@bu3sch.de> <201001222333.42554.mb@bu3sch.de>
	<20100123011618.GA16135@tuxdriver.com>
Message-ID: <1264217811.10468.46.camel@macbook.infradead.org>

On Fri, 2010-01-22 at 20:16 -0500, John W. Linville wrote:
> On Fri, Jan 22, 2010 at 11:33:40PM +0100, Michael Buesch wrote:
> 
> > So while we are at it, I'd really like to migrate away from the berlios list.
> > It's really just annoying. Does somebody have a good reliable mailinglist service
> > we could migrate to? Does vger offer lists to driver projects?
> 
> Probably -- I think davem is the person to ask?  Infradead is probably
> another option (dwmw2).

Yeah, pick one and either of us can set up a new list at the drop of a
hat. Strictly speaking I suspect it should be postmaster at vger rather
than just davem, but the effect is much the same most of the time.

Can you provide a list of existing subscribers?

-- 
David Woodhouse                            Open Source Technology Centre
David.Woodhouse at intel.com                              Intel Corporation



From mb at bu3sch.de  Sat Jan 23 12:33:00 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 23 Jan 2010 12:33:00 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <1264217811.10468.46.camel@macbook.infradead.org>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<20100123011618.GA16135@tuxdriver.com>
	<1264217811.10468.46.camel@macbook.infradead.org>
Message-ID: <201001231233.02501.mb@bu3sch.de>

On Saturday 23 January 2010 04:36:50 David Woodhouse wrote:
> On Fri, 2010-01-22 at 20:16 -0500, John W. Linville wrote:
> > On Fri, Jan 22, 2010 at 11:33:40PM +0100, Michael Buesch wrote:
> > 
> > > So while we are at it, I'd really like to migrate away from the berlios list.
> > > It's really just annoying. Does somebody have a good reliable mailinglist service
> > > we could migrate to? Does vger offer lists to driver projects?
> > 
> > Probably -- I think davem is the person to ask?  Infradead is probably
> > another option (dwmw2).
> 
> Yeah, pick one and either of us can set up a new list at the drop of a
> hat. Strictly speaking I suspect it should be postmaster at vger rather
> than just davem, but the effect is much the same most of the time.
> 
> Can you provide a list of existing subscribers?

I think Stefano has access to our berlios mailman.

-- 
Greetings, Michael.


From stefano.brivio at polimi.it  Sat Jan 23 16:09:12 2010
From: stefano.brivio at polimi.it (Stefano Brivio)
Date: Sat, 23 Jan 2010 16:09:12 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <201001231233.02501.mb@bu3sch.de>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<20100123011618.GA16135@tuxdriver.com>
	<1264217811.10468.46.camel@macbook.infradead.org>
	<201001231233.02501.mb@bu3sch.de>
Message-ID: <20100123160912.0e38a91c@vaiolo.stefanobrivio.net>

On Sat, 23 Jan 2010 12:33:00 +0100
Michael Buesch <mb at bu3sch.de> wrote:

> On Saturday 23 January 2010 04:36:50 David Woodhouse wrote:
> > 
> > Can you provide a list of existing subscribers?
> 
> I think Stefano has access to our berlios mailman.

Last time I tried, I couldn't get berlios mailman to export the list of
subscribers properly. I'll try to get around this (probably, HTML
parsing is my best bet).


--
Ciao
Stefano


From zajec5 at gmail.com  Sat Jan 23 16:28:13 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 23 Jan 2010 16:28:13 +0100
Subject: [PATCH 0/5] b43: more N-PHY stuff
In-Reply-To: <20100123160912.0e38a91c@vaiolo.stefanobrivio.net>
References: <1264121596-9616-1-git-send-email-zajec5@gmail.com>
	<20100123011618.GA16135@tuxdriver.com>
	<1264217811.10468.46.camel@macbook.infradead.org>
	<201001231233.02501.mb@bu3sch.de>
	<20100123160912.0e38a91c@vaiolo.stefanobrivio.net>
Message-ID: <b170af451001230728y55ca1e5ar6b8a1e5cfc2f8851@mail.gmail.com>

2010/1/23 Stefano Brivio <stefano.brivio at polimi.it>:
> On Sat, 23 Jan 2010 12:33:00 +0100
> Michael Buesch <mb at bu3sch.de> wrote:
>
>> On Saturday 23 January 2010 04:36:50 David Woodhouse wrote:
>> >
>> > Can you provide a list of existing subscribers?
>>
>> I think Stefano has access to our berlios mailman.
>
> Last time I tried, I couldn't get berlios mailman to export the list of
> subscribers properly. I'll try to get around this (probably, HTML
> parsing is my best bet).

If you're busy, please send me this HTML/whatever list, I'll check
what I can do.


-- 
Rafa?


From mb at bu3sch.de  Sun Jan 24 13:13:32 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 24 Jan 2010 13:13:32 +0100
Subject: [PATCH] b43: Workaround circular locking in hw-tkip key update
	callback
Message-ID: <201001241313.34784.mb@bu3sch.de>

The TKIP key update callback is called from the RX path, where the driver
mutex is already locked. This results in a circular locking bug.
Avoid this by removing the lock.

Johannes noted that there is a separate bug: The callback still breaks on SDIO
hardware, because SDIO hardware access needs to sleep, but we are not allowed
to sleep in the callback due to mac80211's RCU locking.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Tested-by: Larry Finger <Larry.Finger at lwfinger.net>
Reported-by: kecsa at kutfo.hit.bme.hu
Cc: Johannes Berg <johannes at sipsolutions.net>
Cc: stable <stable at kernel.org>

---
 drivers/net/wireless/b43/main.c |   13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -856,22 +856,19 @@ static void b43_op_update_tkip_key(struc
 	if (B43_WARN_ON(!modparam_hwtkip))
 		return;
 
-	mutex_lock(&wl->mutex);
-
+	/* This is only called from the RX path through mac80211, where
+	 * our mutex is already locked. */
+	B43_WARN_ON(!mutex_is_locked(&wl->mutex));
 	dev = wl->current_dev;
-	if (!dev || b43_status(dev) < B43_STAT_INITIALIZED)
-		goto out_unlock;
+	B43_WARN_ON(!dev || b43_status(dev) < B43_STAT_INITIALIZED);
 
 	keymac_write(dev, index, NULL);	/* First zero out mac to avoid race */
 
 	rx_tkip_phase1_write(dev, index, iv32, phase1key);
 	/* only pairwise TKIP keys are supported right now */
 	if (WARN_ON(!sta))
-		goto out_unlock;
+		return;
 	keymac_write(dev, index, sta->addr);
-
-out_unlock:
-	mutex_unlock(&wl->mutex);
 }
 
 static void do_key_write(struct b43_wldev *dev,

-- 
Greetings, Michael.


From ikorot at earthlink.net  Mon Jan 25 08:44:52 2010
From: ikorot at earthlink.net (ikorot at earthlink.net)
Date: Sun, 24 Jan 2010 23:44:52 -0800 (GMT-08:00)
Subject: Is this a known problem?
Message-ID: <19203935.1264405492997.JavaMail.root@elwamui-royal.atl.sa.earthlink.net>

Hi, ALL,
I have a Dell Laptop which has a Broadcom wireless device in it.
It is a dual-boot system with Windows XP/Gentoo.

This is the result of lspci:
0b:00.0 Network controller: Broadcom Corporation BCM4311 802.11b/g WLAN (rev 01)

This is the system name:
IgorsGentooOnNetwork buildGTK # uname -a
Linux IgorsGentooOnNetwork 2.6.30-gentoo-r6 #5 SMP Sun Oct 4 22:43:50 PDT 2009 i686 Genuine Intel(R) CPU T1350 @ 1.86GHz GenuineIntel GNU/Linux

When I boot in XP everything works perfect.
When I then boot in Gentoo then, I can't get an IP right away.

Asking about it on Gentoo forum, I got a responce that I should turn off the router for 30 seconds and then everything will work.

The router is using the WPA2 encryption and I am using wpa_supplicant.

Is this a problem with just the b43 driver or something on the lower level?
Is this at least known problem?

Thank you.



From zajec5 at gmail.com  Mon Jan 25 18:59:57 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Mon, 25 Jan 2010 18:59:57 +0100
Subject: [PATCH 0/4] more N-PHY, cordic stuff
Message-ID: <1264442401-6364-1-git-send-email-zajec5@gmail.com>

This adds more N-PHY code and modifies cordic function that is currently used
by LP-PHY code. Larry checked this and it still works fine on his LP-PHY card.

Rafa? Mi?ecki (4):
  b43: N-PHY: fix one bit off in parsing RF Ctrl Override arguments
  b43: make cordic common (LP-PHY and N-PHY need it)
  b43: update cordic code to match current specs
  b43: N-PHY: use cordic to generate samples

 drivers/net/wireless/b43/phy_common.c |   45 ++++++++++++++++++++++++++++
 drivers/net/wireless/b43/phy_common.h |    7 ++++
 drivers/net/wireless/b43/phy_lp.c     |   52 ++++-----------------------------
 drivers/net/wireless/b43/phy_n.c      |   23 ++++++++------
 4 files changed, 71 insertions(+), 56 deletions(-)



From zajec5 at gmail.com  Mon Jan 25 18:59:58 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Mon, 25 Jan 2010 18:59:58 +0100
Subject: [PATCH 1/4] b43: N-PHY: fix one bit off in parsing RF Ctrl Override
	arguments
In-Reply-To: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264442401-6364-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index a45a1f3..061b01b 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1031,7 +1031,7 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 	u8 index = fls(field);
 	u8 addr, en_addr, val_addr;
 	/* we expect only one bit set */
-	B43_WARN_ON(field & (~(1 << index)));
+	B43_WARN_ON(field & (~(1 << (index - 1))));
 
 	if (dev->phy.rev >= 3) {
 		const struct nphy_rf_control_override_rev3 *rf_ctrl;
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 25 18:59:59 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Mon, 25 Jan 2010 18:59:59 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264442401-6364-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_common.c |   38 +++++++++++++++++++++++++++
 drivers/net/wireless/b43/phy_common.h |    3 ++
 drivers/net/wireless/b43/phy_lp.c     |   45 +-------------------------------
 3 files changed, 43 insertions(+), 43 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
index 75b26e1..348a78f 100644
--- a/drivers/net/wireless/b43/phy_common.c
+++ b/drivers/net/wireless/b43/phy_common.c
@@ -421,3 +421,41 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on)
 {
 	b43_write16(dev, B43_MMIO_PHY0, on ? 0 : 0xF4);
 }
+
+b43_c32 b43_cordic(int theta)
+{
+	u32 arctg[] = { 2949120, 1740967, 919879, 466945, 234379, 117304,
+		      58666, 29335, 14668, 7334, 3667, 1833, 917, 458,
+		      229, 115, 57, 29, };
+	int i, tmp, signx = 1, angle = 0;
+	b43_c32 ret = { .i = 39797, .q = 0, };
+
+	theta = clamp_t(int, theta, -180, 180);
+
+	if (theta > 90) {
+		theta -= 180;
+		signx = -1;
+	} else if (theta < -90) {
+		theta += 180;
+		signx = -1;
+	}
+
+	for (i = 0; i <= 17; i++) {
+		if (theta > angle) {
+			tmp = ret.i - (ret.q >> i);
+			ret.q += ret.i >> i;
+			ret.i = tmp;
+			angle += arctg[i];
+		} else {
+			tmp = ret.i + (ret.q >> i);
+			ret.q -= ret.i >> i;
+			ret.i = tmp;
+			angle -= arctg[i];
+		}
+	}
+
+	ret.i *= signx;
+	ret.q *= signx;
+
+	return ret;
+}
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index f635f9e..7a38226 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -5,6 +5,8 @@
 
 struct b43_wldev;
 
+/* Complex number using 2 32-bit signed integers */
+typedef struct { s32 i, q; } b43_c32;
 
 /* PHY register routing bits */
 #define B43_PHYROUTE			0x0C00 /* PHY register routing bits mask */
@@ -421,5 +423,6 @@ int b43_phy_shm_tssi_read(struct b43_wldev *dev, u16 shm_offset);
  */
 void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on);
 
+b43_c32 b43_cordic(int theta);
 
 #endif /* LINUX_B43_PHY_COMMON_H_ */
diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index b58d6cf..a142804 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -1767,47 +1767,6 @@ out:
 	return ret;
 }
 
-/* Complex number using 2 32-bit signed integers */
-typedef struct {s32 i, q;} lpphy_c32;
-
-static lpphy_c32 lpphy_cordic(int theta)
-{
-	u32 arctg[] = { 2949120, 1740967, 919879, 466945, 234379, 117304,
-		      58666, 29335, 14668, 7334, 3667, 1833, 917, 458,
-		      229, 115, 57, 29, };
-	int i, tmp, signx = 1, angle = 0;
-	lpphy_c32 ret = { .i = 39797, .q = 0, };
-
-	theta = clamp_t(int, theta, -180, 180);
-
-	if (theta > 90) {
-		theta -= 180;
-		signx = -1;
-	} else if (theta < -90) {
-		theta += 180;
-		signx = -1;
-	}
-
-	for (i = 0; i <= 17; i++) {
-		if (theta > angle) {
-			tmp = ret.i - (ret.q >> i);
-			ret.q += ret.i >> i;
-			ret.i = tmp;
-			angle += arctg[i];
-		} else {
-			tmp = ret.i + (ret.q >> i);
-			ret.q -= ret.i >> i;
-			ret.i = tmp;
-			angle -= arctg[i];
-		}
-	}
-
-	ret.i *= signx;
-	ret.q *= signx;
-
-	return ret;
-}
-
 static void lpphy_run_samples(struct b43_wldev *dev, u16 samples, u16 loops,
 			      u16 wait)
 {
@@ -1826,7 +1785,7 @@ static void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)
 	struct b43_phy_lp *lpphy = dev->phy.lp;
 	u16 buf[64];
 	int i, samples = 0, angle = 0, rotation = (9 * freq) / 500;
-	lpphy_c32 sample;
+	b43_c32 sample;
 
 	lpphy->tx_tone_freq = freq;
 
@@ -1842,7 +1801,7 @@ static void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)
 	}
 
 	for (i = 0; i < samples; i++) {
-		sample = lpphy_cordic(angle);
+		sample = b43_cordic(angle);
 		angle += rotation;
 		buf[i] = ((sample.i * max) & 0xFF) << 8;
 		buf[i] |= (sample.q * max) & 0xFF;
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 25 19:00:00 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Mon, 25 Jan 2010 19:00:00 +0100
Subject: [PATCH 3/4] b43: update cordic code to match current specs
In-Reply-To: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264442401-6364-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
Tested-by: Larry Finger <Larry.Finger at lwfinger.net>
---
 drivers/net/wireless/b43/phy_common.c |   19 +++++++++++++------
 drivers/net/wireless/b43/phy_common.h |    4 ++++
 drivers/net/wireless/b43/phy_lp.c     |    7 ++++---
 3 files changed, 21 insertions(+), 9 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
index 348a78f..868b829 100644
--- a/drivers/net/wireless/b43/phy_common.c
+++ b/drivers/net/wireless/b43/phy_common.c
@@ -422,21 +422,28 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on)
 	b43_write16(dev, B43_MMIO_PHY0, on ? 0 : 0xF4);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/Cordic */
 b43_c32 b43_cordic(int theta)
 {
 	u32 arctg[] = { 2949120, 1740967, 919879, 466945, 234379, 117304,
 		      58666, 29335, 14668, 7334, 3667, 1833, 917, 458,
 		      229, 115, 57, 29, };
-	int i, tmp, signx = 1, angle = 0;
+	u8 i;
+	s32 tmp;
+	s8 signx = 1;
+	u32 angle = 0;
 	b43_c32 ret = { .i = 39797, .q = 0, };
 
-	theta = clamp_t(int, theta, -180, 180);
+	while (theta > (180 << 16))
+		theta -= (360 << 16);
+	while (theta < -(180 << 16))
+		theta += (360 << 16);
 
-	if (theta > 90) {
-		theta -= 180;
+	if (theta > (90 << 16)) {
+		theta -= (180 << 16);
 		signx = -1;
-	} else if (theta < -90) {
-		theta += 180;
+	} else if (theta < -(90 << 16)) {
+		theta += (180 << 16);
 		signx = -1;
 	}
 
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index 7a38226..0716f07 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -8,6 +8,10 @@ struct b43_wldev;
 /* Complex number using 2 32-bit signed integers */
 typedef struct { s32 i, q; } b43_c32;
 
+#define CORDIC_CONVERT(value)	(((value) >= 0) ? \
+				 ((((value) >> 15) + 1) >> 1) : \
+				 -((((-(value)) >> 15) + 1) >> 1))
+
 /* PHY register routing bits */
 #define B43_PHYROUTE			0x0C00 /* PHY register routing bits mask */
 #define  B43_PHYROUTE_BASE		0x0000 /* Base registers */
diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index a142804..e770aad 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -1784,7 +1784,8 @@ static void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)
 {
 	struct b43_phy_lp *lpphy = dev->phy.lp;
 	u16 buf[64];
-	int i, samples = 0, angle = 0, rotation = (9 * freq) / 500;
+	int i, samples = 0, angle = 0;
+	int rotation = (((36 * freq) / 20) << 16) / 100;
 	b43_c32 sample;
 
 	lpphy->tx_tone_freq = freq;
@@ -1803,8 +1804,8 @@ static void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)
 	for (i = 0; i < samples; i++) {
 		sample = b43_cordic(angle);
 		angle += rotation;
-		buf[i] = ((sample.i * max) & 0xFF) << 8;
-		buf[i] |= (sample.q * max) & 0xFF;
+		buf[i] = CORDIC_CONVERT((sample.i * max) & 0xFF) << 8;
+		buf[i] |= CORDIC_CONVERT((sample.q * max) & 0xFF);
 	}
 
 	b43_lptab_write_bulk(dev, B43_LPTAB16(5, 0), samples, buf);
-- 
1.6.4.2



From zajec5 at gmail.com  Mon Jan 25 19:00:01 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Mon, 25 Jan 2010 19:00:01 +0100
Subject: [PATCH 4/4] b43: N-PHY: use cordic to generate samples
In-Reply-To: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264442401-6364-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   21 ++++++++++++---------
 1 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 061b01b..e15f05c 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -821,8 +821,9 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 					bool test)
 {
 	int i;
-	u16 bw, len, num, rot, angle;
-	/* TODO: *buffer; */
+	u16 bw, len, rot, angle;
+	b43_c32 *samples;
+	
 
 	bw = (dev->phy.is_40mhz) ? 40 : 20;
 	len = bw << 3;
@@ -839,18 +840,20 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 		len = bw << 1;
 	}
 
-	/* TODO: buffer = kzalloc(len * sizeof(u32), GFP_KERNEL); */
-	num = len;
+	samples = kzalloc(len * sizeof(b43_c32), GFP_KERNEL);
 	rot = (((freq * 36) / bw) << 16) / 100;
 	angle = 0;
 
-	for (i = 0; i < num; i++) {
-		/* TODO */
+	for (i = 0; i < len; i++) {
+		samples[i] = b43_cordic(angle);
+		angle += rot;
+		samples[i].q = CORDIC_CONVERT(samples[i].q * max);
+		samples[i].i = CORDIC_CONVERT(samples[i].i * max);
 	}
 
-	/* TODO: Call N PHY Load Sample Table with buffer, num as arguments */
-	/* TODO: kfree(buffer); */
-	return num;
+	/* TODO: Call N PHY Load Sample Table with buffer, len as arguments */
+	kfree(samples);
+	return len;
 }
 
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */
-- 
1.6.4.2



From mb at bu3sch.de  Mon Jan 25 19:32:12 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 25 Jan 2010 19:32:12 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <1264442401-6364-3-git-send-email-zajec5@gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<1264442401-6364-3-git-send-email-zajec5@gmail.com>
Message-ID: <201001251932.14633.mb@bu3sch.de>

On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
> +/* Complex number using 2 32-bit signed integers */
> +typedef struct { s32 i, q; } b43_c32;

No typedef. ever.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Mon Jan 25 19:35:28 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 25 Jan 2010 19:35:28 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <201001251932.14633.mb@bu3sch.de>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<1264442401-6364-3-git-send-email-zajec5@gmail.com>
	<201001251932.14633.mb@bu3sch.de>
Message-ID: <b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>

2010/1/25 Michael Buesch <mb at bu3sch.de>:
> On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
>> +/* Complex number using 2 32-bit signed integers */
>> +typedef struct { s32 i, q; } b43_c32;
>
> No typedef. ever.

Well, I just copied (Gabor's?) code here. But of course I can fix this
by the way, no problem :)

Just read about typedef in Linux Kernel Coding Style, didn't know
about this earlier. Thanks for pointing.

-- 
Rafa?


From zajec5 at gmail.com  Mon Jan 25 19:36:27 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 25 Jan 2010 19:36:27 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<1264442401-6364-3-git-send-email-zajec5@gmail.com>
	<201001251932.14633.mb@bu3sch.de>
	<b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>
Message-ID: <b170af451001251036m8b33f3er9f0a363a03ea21cb@mail.gmail.com>

W dniu 25 stycznia 2010 19:35 u?ytkownik Rafa? Mi?ecki
<zajec5 at gmail.com> napisa?:
> 2010/1/25 Michael Buesch <mb at bu3sch.de>:
>> On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
>>> +/* Complex number using 2 32-bit signed integers */
>>> +typedef struct { s32 i, q; } b43_c32;
>>
>> No typedef. ever.
>
> Well, I just copied (Gabor's?) code here. But of course I can fix this
> by the way, no problem :)
>
> Just read about typedef in Linux Kernel Coding Style, didn't know
> about this earlier. Thanks for pointing.

Is this OK to fix this in separated patch? Or should I modify this set
of patches?

-- 
Rafa?


From mb at bu3sch.de  Mon Jan 25 19:53:19 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 25 Jan 2010 19:53:19 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <b170af451001251036m8b33f3er9f0a363a03ea21cb@mail.gmail.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>
	<b170af451001251036m8b33f3er9f0a363a03ea21cb@mail.gmail.com>
Message-ID: <201001251953.21692.mb@bu3sch.de>

On Monday 25 January 2010 19:36:27 Rafa? Mi?ecki wrote:
> W dniu 25 stycznia 2010 19:35 u?ytkownik Rafa? Mi?ecki
> <zajec5 at gmail.com> napisa?:
> > 2010/1/25 Michael Buesch <mb at bu3sch.de>:
> >> On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
> >>> +/* Complex number using 2 32-bit signed integers */
> >>> +typedef struct { s32 i, q; } b43_c32;
> >>
> >> No typedef. ever.
> >
> > Well, I just copied (Gabor's?) code here. But of course I can fix this
> > by the way, no problem :)

Yeah, I saw that. We can fix it while we're at it. ;)

> > Just read about typedef in Linux Kernel Coding Style, didn't know
> > about this earlier. Thanks for pointing.
> 
> Is this OK to fix this in separated patch? Or should I modify this set
> of patches?

Well, as you touch any reference to the typedef anyway (you renamed it),
you can just put the keyword "struct" in front of the references and no separate patch is needed.
It won't even grow your current patch in the number of changed lines.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Mon Jan 25 20:57:13 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 25 Jan 2010 13:57:13 -0600
Subject: Is this a known problem?
In-Reply-To: <19203935.1264405492997.JavaMail.root@elwamui-royal.atl.sa.earthlink.net>
References: <19203935.1264405492997.JavaMail.root@elwamui-royal.atl.sa.earthlink.net>
Message-ID: <4B5DF799.1090203@lwfinger.net>

On 01/25/2010 01:44 AM, ikorot at earthlink.net wrote:
> Hi, ALL,
> I have a Dell Laptop which has a Broadcom wireless device in it.
> It is a dual-boot system with Windows XP/Gentoo.
>
> This is the result of lspci:
> 0b:00.0 Network controller: Broadcom Corporation BCM4311 802.11b/g WLAN (rev 01)
>
> This is the system name:
> IgorsGentooOnNetwork buildGTK # uname -a
> Linux IgorsGentooOnNetwork 2.6.30-gentoo-r6 #5 SMP Sun Oct 4 22:43:50 PDT 2009 i686 Genuine Intel(R) CPU T1350 @ 1.86GHz GenuineIntel GNU/Linux
>
> When I boot in XP everything works perfect.
> When I then boot in Gentoo then, I can't get an IP right away.
>
> Asking about it on Gentoo forum, I got a responce that I should turn off the router for 30 seconds and then everything will work.
>
> The router is using the WPA2 encryption and I am using wpa_supplicant.
>
> Is this a problem with just the b43 driver or something on the lower level?
> Is this at least known problem?

No, it is not a known problem. The NM mailing list has had some traffic about 
DHCP timeouts on busy networks where the DHCP lease time is 1 day, thus the AP 
has to probe to find an unused IP, but that should not apply to you. On the 
other hand, if turning off the router does change the situation, you might try 
changing the lease time there.

I use WPA2 on my network with b43 and NetworkManager. My network does not start 
until I login, but an IP is always available within 15-20 seconds of the time 
that my desktop is ready.


From ljthode at gmail.com  Mon Jan 25 21:15:42 2010
From: ljthode at gmail.com (Lucas Thode)
Date: Mon, 25 Jan 2010 14:15:42 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
Message-ID: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>

---start dmesg snippet---
[17189.121003] b43-pci-bridge 0000:06:00.0: PCI INT A disabled
[17192.494272] cfg80211: Using static regulatory domain info
[17192.494279] cfg80211: Regulatory domain: US
[17192.494283]  (start_freq - end_freq @ bandwidth), (max_antenna_gain,
max_eirp
)
[17192.494292]  (2402000 KHz - 2472000 KHz @ 40000 KHz), (600 mBi, 2700 mBm)
[17192.494299]  (5170000 KHz - 5190000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
[17192.494306]  (5190000 KHz - 5210000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
[17192.494314]  (5210000 KHz - 5230000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
[17192.494321]  (5230000 KHz - 5330000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
[17192.494328]  (5735000 KHz - 5835000 KHz @ 40000 KHz), (600 mBi, 3000 mBm)
[17192.494418] cfg80211: Calling CRDA for country: US
[17192.658174] b43-pci-bridge 0000:06:00.0: PCI INT A -> GSI 19 (level, low)
->
IRQ 19
[17192.658206] b43-pci-bridge 0000:06:00.0: setting latency timer to 64
[17192.724352] ssb: Sonics Silicon Backplane found on PCI device
0000:06:00.0
[17192.769108] b43-phy0: Broadcom 4312 WLAN found (core revision 15)
[17192.843094] phy0: Selected rate control algorithm 'minstrel'
[17192.844206] Registered led device: b43-phy0::tx
[17192.844444] Registered led device: b43-phy0::rx
[17192.844500] Registered led device: b43-phy0::radio
[17192.844859] Broadcom 43xx driver loaded [ Features: PMLS, Firmware-ID:
FW13 ]
[17196.776755] b43 ssb0:0: firmware: requesting b43/ucode15.fw
[17196.780967] b43 ssb0:0: firmware: requesting b43/lp0initvals15.fw
[17196.784551] b43 ssb0:0: firmware: requesting b43/lp0bsinitvals15.fw
[17196.921708] b43-phy0: Loading firmware version 410.2160 (2007-05-26
15:32:10)
[17202.497881] ADDRCONF(NETDEV_UP): wlan0: link is not ready
[17202.934136] b43-phy0 ERROR: Fatal DMA error: 0x00000800, 0x00000000,
0x00000000, 0x00000000, 0x00000000, 0x00000000
[17202.934153] b43-phy0: Controller RESET (DMA error) ...
[17203.148369] b43-phy0: Loading firmware version 410.2160 (2007-05-26
15:32:10)
[17208.681254] b43-phy0: Controller restarted
[17208.696481] b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000,
0x00000000, 0x00000000, 0x00000000, 0x00000000
[17208.696490] b43-phy0: Controller RESET (DMA error) ...
[17208.914882] b43-phy0: Loading firmware version 410.2160 (2007-05-26
15:32:10)
[17214.461361] b43-phy0: Controller restarted
[17214.461610] b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000,
0x00000000, 0x00000000, 0x00000000, 0x00000000
[17214.461626] b43-phy0: Controller RESET (DMA error) ...
[17214.676285] b43-phy0: Loading firmware version 410.2160 (2007-05-26
15:32:10)
---end dmesg snippet---...and on and on the dma errors go.

This occured about (sorry, not sure exactly, but I don't think it quite
matters with this particular error) when I used "iwlist scan" to search for
wireless networks after I used the b43-fwcutter from Debian testing to
install the firmware and re-inserted the driver with 'modprobe -r b43;
modprobe b43'.

kb1rd at kb1rd-mobroost:~$ uname -a
Linux kb1rd-mobroost 2.6.32-trunk-amd64 #1 SMP Sun Jan 10 22:40:40 UTC 2010
x86_64 GNU/Linux
kb1rd at kb1rd-mobroost:~$ lspci -vvn | grep 43 -A7
06:00.0 0280: 14e4:4315 (rev 01)
    Subsystem: 1028:000b
    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr-
Stepping- SERR+ FastB2B- DisINTx-
    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort-
<MAbort- >SERR- <PERR- INTx-
    Latency: 0, Cache Line Size: 64 bytes
    Interrupt: pin A routed to IRQ 19
    Region 0: Memory at f4000000 (64-bit, non-prefetchable) [size=16K]
    Capabilities: <access denied>
    Kernel driver in use: b43-pci-bridge

<extraneous output having to do with my Ethernet chip snipped>
kb1rd at kb1rd-mobroost:~$ cat /proc/cpuinfo
processor    : 0
vendor_id    : GenuineIntel
cpu family    : 6
model        : 15
model name    : Intel(R) Core(TM)2 Duo CPU     T5670  @ 1.80GHz
stepping    : 13
cpu MHz        : 800.000
cache size    : 2048 KB
physical id    : 0
siblings    : 2
core id        : 0
cpu cores    : 2
apicid        : 0
initial apicid    : 0
fpu        : yes
fpu_exception    : yes
cpuid level    : 10
wp        : yes
flags        : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov
pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm
constant_tsc arch_perfmon pebs bts rep_good aperfmperf pni dtes64 monitor
ds_cpl est tm2 ssse3 cx16 xtpr pdcm lahf_lm ida
bogomips    : 3590.43
clflush size    : 64
cache_alignment    : 64
address sizes    : 36 bits physical, 48 bits virtual
power management:

<output for core 1 snipped>

As you can tell, this processor is neither an Atom nor a ULV Core 2 Duo.
The WLAN card is the Dell Wireless 1395 that came with the laptop (a Vostro
1510).  I can build a custom kernel based on the Debian kernel sources if
need be; just tell me what config options to flip/patches to apply.  Also,
wl.o works on this laptop with the Debian 2.6.30 kernel.  Aptitude lists the
kernel version as a 2.6.32-5.


--Lucas
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100125/0f68da07/attachment.html>

From ikorot at earthlink.net  Mon Jan 25 21:38:03 2010
From: ikorot at earthlink.net (ikorot at earthlink.net)
Date: Mon, 25 Jan 2010 15:38:03 -0500 (EST)
Subject: Is this a known problem?
Message-ID: <9152817.1264451883344.JavaMail.root@mswamui-bichon.atl.sa.earthlink.net>

Larry, list,


-----Original Message-----
>From: Larry Finger <Larry.Finger at lwfinger.net>
>Sent: Jan 25, 2010 2:57 PM
>To: ikorot at earthlink.net
>Cc: bcm43xx-dev at lists.berlios.de
>Subject: Re: Is this a known problem?
>
>On 01/25/2010 01:44 AM, ikorot at earthlink.net wrote:
>> Hi, ALL,
>> I have a Dell Laptop which has a Broadcom wireless device in it.
>> It is a dual-boot system with Windows XP/Gentoo.
>>
>> This is the result of lspci:
>> 0b:00.0 Network controller: Broadcom Corporation BCM4311 802.11b/g WLAN (rev 01)
>>
>> This is the system name:
>> IgorsGentooOnNetwork buildGTK # uname -a
>> Linux IgorsGentooOnNetwork 2.6.30-gentoo-r6 #5 SMP Sun Oct 4 22:43:50 PDT 2009 i686 Genuine Intel(R) CPU T1350 @ 1.86GHz GenuineIntel GNU/Linux
>>
>> When I boot in XP everything works perfect.
>> When I then boot in Gentoo then, I can't get an IP right away.
>>
>> Asking about it on Gentoo forum, I got a responce that I should turn off the router for 30 seconds and then everything will work.
>>
>> The router is using the WPA2 encryption and I am using wpa_supplicant.
>>
>> Is this a problem with just the b43 driver or something on the lower level?
>> Is this at least known problem?
>
>No, it is not a known problem. The NM mailing list has had some traffic about 
>DHCP timeouts on busy networks where the DHCP lease time is 1 day, thus the AP 
>has to probe to find an unused IP, but that should not apply to you. On the 
>other hand, if turning off the router does change the situation, you might try 
>changing the lease time there.
>
>I use WPA2 on my network with b43 and NetworkManager. My network does not start 
>until I login, but an IP is always available within 15-20 seconds of the time 
>that my desktop is ready.

Is there any additional information I can provide to further investigate the issue?
I'm assuming it's not a problem with the driver, but with something on lower
level...

Thank you.



From netrolller.3d at gmail.com  Mon Jan 25 21:49:31 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Mon, 25 Jan 2010 21:49:31 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
References: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
Message-ID: <69e28c911001251249l2903a154nc921e68a8c5e4432@mail.gmail.com>

On Mon, Jan 25, 2010 at 9:15 PM, Lucas Thode <ljthode at gmail.com> wrote:
> ---start dmesg snippet---
> [17189.121003] b43-pci-bridge 0000:06:00.0: PCI INT A disabled
> [17192.494272] cfg80211: Using static regulatory domain info
> [17192.494279] cfg80211: Regulatory domain: US
> [17192.494283]? (start_freq - end_freq @ bandwidth), (max_antenna_gain,
> max_eirp
> )
> [17192.494292]? (2402000 KHz - 2472000 KHz @ 40000 KHz), (600 mBi, 2700 mBm)
> [17192.494299]? (5170000 KHz - 5190000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
> [17192.494306]? (5190000 KHz - 5210000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
> [17192.494314]? (5210000 KHz - 5230000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
> [17192.494321]? (5230000 KHz - 5330000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
> [17192.494328]? (5735000 KHz - 5835000 KHz @ 40000 KHz), (600 mBi, 3000 mBm)
> [17192.494418] cfg80211: Calling CRDA for country: US
> [17192.658174] b43-pci-bridge 0000:06:00.0: PCI INT A -> GSI 19 (level, low)
> ->
> IRQ 19
> [17192.658206] b43-pci-bridge 0000:06:00.0: setting latency timer to 64
> [17192.724352] ssb: Sonics Silicon Backplane found on PCI device
> 0000:06:00.0
> [17192.769108] b43-phy0: Broadcom 4312 WLAN found (core revision 15)
> [17192.843094] phy0: Selected rate control algorithm 'minstrel'
> [17192.844206] Registered led device: b43-phy0::tx
> [17192.844444] Registered led device: b43-phy0::rx
> [17192.844500] Registered led device: b43-phy0::radio
> [17192.844859] Broadcom 43xx driver loaded [ Features: PMLS, Firmware-ID:
> FW13 ]
> [17196.776755] b43 ssb0:0: firmware: requesting b43/ucode15.fw
> [17196.780967] b43 ssb0:0: firmware: requesting b43/lp0initvals15.fw
> [17196.784551] b43 ssb0:0: firmware: requesting b43/lp0bsinitvals15.fw
> [17196.921708] b43-phy0: Loading firmware version 410.2160 (2007-05-26
> 15:32:10)
> [17202.497881] ADDRCONF(NETDEV_UP): wlan0: link is not ready
> [17202.934136] b43-phy0 ERROR: Fatal DMA error: 0x00000800, 0x00000000,
> 0x00000000, 0x00000000, 0x00000000, 0x00000000
> [17202.934153] b43-phy0: Controller RESET (DMA error) ...
> [17203.148369] b43-phy0: Loading firmware version 410.2160 (2007-05-26
> 15:32:10)
> [17208.681254] b43-phy0: Controller restarted
> [17208.696481] b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000,
> 0x00000000, 0x00000000, 0x00000000, 0x00000000
> [17208.696490] b43-phy0: Controller RESET (DMA error) ...
> [17208.914882] b43-phy0: Loading firmware version 410.2160 (2007-05-26
> 15:32:10)
> [17214.461361] b43-phy0: Controller restarted
> [17214.461610] b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000,
> 0x00000000, 0x00000000, 0x00000000, 0x00000000
> [17214.461626] b43-phy0: Controller RESET (DMA error) ...
> [17214.676285] b43-phy0: Loading firmware version 410.2160 (2007-05-26
> 15:32:10)
> ---end dmesg snippet---...and on and on the dma errors go.
>
> This occured about (sorry, not sure exactly, but I don't think it quite
> matters with this particular error) when I used "iwlist scan" to search for
> wireless networks after I used the b43-fwcutter from Debian testing to
> install the firmware and re-inserted the driver with 'modprobe -r b43;
> modprobe b43'.
>
> kb1rd at kb1rd-mobroost:~$ uname -a
> Linux kb1rd-mobroost 2.6.32-trunk-amd64 #1 SMP Sun Jan 10 22:40:40 UTC 2010
> x86_64 GNU/Linux
> kb1rd at kb1rd-mobroost:~$ lspci -vvn | grep 43 -A7
> 06:00.0 0280: 14e4:4315 (rev 01)
> ??? Subsystem: 1028:000b
> ??? Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr-
> Stepping- SERR+ FastB2B- DisINTx-
> ??? Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort-
> <MAbort- >SERR- <PERR- INTx-
> ??? Latency: 0, Cache Line Size: 64 bytes
> ??? Interrupt: pin A routed to IRQ 19
> ??? Region 0: Memory at f4000000 (64-bit, non-prefetchable) [size=16K]
> ??? Capabilities: <access denied>
> ??? Kernel driver in use: b43-pci-bridge
>
> <extraneous output having to do with my Ethernet chip snipped>
> kb1rd at kb1rd-mobroost:~$ cat /proc/cpuinfo
> processor??? : 0
> vendor_id??? : GenuineIntel
> cpu family??? : 6
> model??? ??? : 15
> model name??? : Intel(R) Core(TM)2 Duo CPU???? T5670? @ 1.80GHz
> stepping??? : 13
> cpu MHz??? ??? : 800.000
> cache size??? : 2048 KB
> physical id??? : 0
> siblings??? : 2
> core id??? ??? : 0
> cpu cores??? : 2
> apicid??? ??? : 0
> initial apicid??? : 0
> fpu??? ??? : yes
> fpu_exception??? : yes
> cpuid level??? : 10
> wp??? ??? : yes
> flags??? ??? : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov
> pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm
> constant_tsc arch_perfmon pebs bts rep_good aperfmperf pni dtes64 monitor
> ds_cpl est tm2 ssse3 cx16 xtpr pdcm lahf_lm ida
> bogomips??? : 3590.43
> clflush size??? : 64
> cache_alignment??? : 64
> address sizes??? : 36 bits physical, 48 bits virtual
> power management:
>
> <output for core 1 snipped>
>
> As you can tell, this processor is neither an Atom nor a ULV Core 2 Duo.
> The WLAN card is the Dell Wireless 1395 that came with the laptop (a Vostro
> 1510).? I can build a custom kernel based on the Debian kernel sources if
> need be; just tell me what config options to flip/patches to apply.? Also,
> wl.o works on this laptop with the Debian 2.6.30 kernel.? Aptitude lists the
> kernel version as a 2.6.32-5.
>
>
> --Lucas
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>

A few things to check:

-Is this on PhoenixBios?
-Does loading wl, doing a warm reboot and loading b43 make b43 work?
-Try updating the firmware to v478. (AFAIK there was someone on the
list before with a DMA error on a non-ULV, and it was solved by
updating the firmware. Broadcom's wl.ko uses a v5xx firmware for the
record.)



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Mon Jan 25 21:58:40 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 25 Jan 2010 14:58:40 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
References: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
Message-ID: <4B5E0600.9030109@lwfinger.net>

On 01/25/2010 02:15 PM, Lucas Thode wrote:
> As you can tell, this processor is neither an Atom nor a ULV Core 2
> Duo.  The WLAN card is the Dell Wireless 1395 that came with the laptop
> (a Vostro 1510).  I can build a custom kernel based on the Debian kernel
> sources if need be; just tell me what config options to flip/patches to
> apply.  Also, wl.o works on this laptop with the Debian 2.6.30 kernel.
> Aptitude lists the kernel version as a 2.6.32-5.

There is one other report of the DMA problem with a non-Atom CPU (I'm not sure 
about the non-ULV part.). We do not know what the wl driver does that we do not, 
or vice-versa. If you want to use b43, you need to build it to use PIO only. 
Choosing PIO is now available as a run-time option, but I do not think 2.6.32 
has this feature.

Debugging this problem has been most difficult as it only affects Intel CPUs and 
all my machines have AMD processors.

Larry





From linville at tuxdriver.com  Mon Jan 25 23:19:35 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Mon, 25 Jan 2010 17:19:35 -0500
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <201001251953.21692.mb@bu3sch.de>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>
	<b170af451001251036m8b33f3er9f0a363a03ea21cb@mail.gmail.com>
	<201001251953.21692.mb@bu3sch.de>
Message-ID: <20100125221935.GC14699@tuxdriver.com>

On Mon, Jan 25, 2010 at 07:53:19PM +0100, Michael Buesch wrote:
> On Monday 25 January 2010 19:36:27 Rafa? Mi?ecki wrote:
> > W dniu 25 stycznia 2010 19:35 u?ytkownik Rafa? Mi?ecki
> > <zajec5 at gmail.com> napisa?:
> > > 2010/1/25 Michael Buesch <mb at bu3sch.de>:
> > >> On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
> > >>> +/* Complex number using 2 32-bit signed integers */
> > >>> +typedef struct { s32 i, q; } b43_c32;
> > >>
> > >> No typedef. ever.
> > >
> > > Well, I just copied (Gabor's?) code here. But of course I can fix this
> > > by the way, no problem :)
> 
> Yeah, I saw that. We can fix it while we're at it. ;)
> 
> > > Just read about typedef in Linux Kernel Coding Style, didn't know
> > > about this earlier. Thanks for pointing.
> > 
> > Is this OK to fix this in separated patch? Or should I modify this set
> > of patches?
> 
> Well, as you touch any reference to the typedef anyway (you renamed it),
> you can just put the keyword "struct" in front of the references and no separate patch is needed.
> It won't even grow your current patch in the number of changed lines.

I took care of these modifications to the original patch...

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From zajec5 at gmail.com  Tue Jan 26 00:17:54 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Tue, 26 Jan 2010 00:17:54 +0100
Subject: [PATCH 2/4] b43: make cordic common (LP-PHY and N-PHY need it)
In-Reply-To: <20100125221935.GC14699@tuxdriver.com>
References: <1264442401-6364-1-git-send-email-zajec5@gmail.com>
	<b170af451001251035t23f3978cga52258722ea29770@mail.gmail.com>
	<b170af451001251036m8b33f3er9f0a363a03ea21cb@mail.gmail.com>
	<201001251953.21692.mb@bu3sch.de>
	<20100125221935.GC14699@tuxdriver.com>
Message-ID: <b170af451001251517u19130393kdd2bca4765dbc604@mail.gmail.com>

2010/1/25 John W. Linville <linville at tuxdriver.com>:
> On Mon, Jan 25, 2010 at 07:53:19PM +0100, Michael Buesch wrote:
>> On Monday 25 January 2010 19:36:27 Rafa? Mi?ecki wrote:
>> > W dniu 25 stycznia 2010 19:35 u?ytkownik Rafa? Mi?ecki
>> > <zajec5 at gmail.com> napisa?:
>> > > 2010/1/25 Michael Buesch <mb at bu3sch.de>:
>> > >> On Monday 25 January 2010 18:59:59 Rafa? Mi?ecki wrote:
>> > >>> +/* Complex number using 2 32-bit signed integers */
>> > >>> +typedef struct { s32 i, q; } b43_c32;
>> > >>
>> > >> No typedef. ever.
>> > >
>> > > Well, I just copied (Gabor's?) code here. But of course I can fix this
>> > > by the way, no problem :)
>>
>> Yeah, I saw that. We can fix it while we're at it. ;)
>>
>> > > Just read about typedef in Linux Kernel Coding Style, didn't know
>> > > about this earlier. Thanks for pointing.
>> >
>> > Is this OK to fix this in separated patch? Or should I modify this set
>> > of patches?
>>
>> Well, as you touch any reference to the typedef anyway (you renamed it),
>> you can just put the keyword "struct" in front of the references and no separate patch is needed.
>> It won't even grow your current patch in the number of changed lines.
>
> I took care of these modifications to the original patch...

Hey, thank you! :)

-- 
Rafa?


From ljthode at gmail.com  Tue Jan 26 03:13:26 2010
From: ljthode at gmail.com (Lucas Thode)
Date: Mon, 25 Jan 2010 20:13:26 -0600
Subject: Fwd: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <cb3b33ef1001251812w68c1c061r672b7f11b06d61d8@mail.gmail.com>
References: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
	<69e28c911001251249l2903a154nc921e68a8c5e4432@mail.gmail.com>
	<cb3b33ef1001251812w68c1c061r672b7f11b06d61d8@mail.gmail.com>
Message-ID: <cb3b33ef1001251813r3be6f8f4x4263df5805a1dfc8@mail.gmail.com>

Sorry, hit Reply instead of Reply All *d'oh*
---------- Forwarded message ----------
From: Lucas Thode <ljthode at gmail.com>
Date: 2010/1/25
Subject: Re: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
To: G?bor Stefanik <netrolller.3d at gmail.com>




2010/1/25 G?bor Stefanik <netrolller.3d at gmail.com>


>
> A few things to check:
>
> -Is this on PhoenixBios?
>
Indeed, the Vostro 1510 uses a (Dell branded) PhoenixBIOS.

> -Does loading wl, doing a warm reboot and loading b43 make b43 work?
> -Try updating the firmware to v478. (AFAIK there was someone on the
> list before with a DMA error on a non-ULV, and it was solved by
> updating the firmware. Broadcom's wl.ko uses a v5xx firmware for the
> record.)
>
I will attempt a firmware upgrade (manually downloading/compiling/running
b43-fwcutter) when I have access to this laptop again (later today).  Debian
bug #561450 covers the fact that the Debian b43-fwcutter package is too old;
I have added a post to that bug report mentioning the v478 firmware + the
"Fatal DMA error" message (the original bug reporter did not check his
dmesg).

--Lucas

>
>
>
> --
>
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100125/fdb3ec4d/attachment.html>

From ljthode at gmail.com  Tue Jan 26 04:26:35 2010
From: ljthode at gmail.com (Lucas Thode)
Date: Mon, 25 Jan 2010 21:26:35 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <cb3b33ef1001251812w68c1c061r672b7f11b06d61d8@mail.gmail.com>
References: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
	<69e28c911001251249l2903a154nc921e68a8c5e4432@mail.gmail.com>
	<cb3b33ef1001251812w68c1c061r672b7f11b06d61d8@mail.gmail.com>
Message-ID: <cb3b33ef1001251926nf33837ctf23722da5bb2c247@mail.gmail.com>

2010/1/25 Lucas Thode <ljthode at gmail.com>

>
>
> 2010/1/25 G?bor Stefanik <netrolller.3d at gmail.com>
>
>
>>
>> A few things to check:
>>
>> -Is this on PhoenixBios?
>>
> Indeed, the Vostro 1510 uses a (Dell branded) PhoenixBIOS.
>
>> -Does loading wl, doing a warm reboot and loading b43 make b43 work?
>> -Try updating the firmware to v478. (AFAIK there was someone on the
>> list before with a DMA error on a non-ULV, and it was solved by
>> updating the firmware. Broadcom's wl.ko uses a v5xx firmware for the
>> record.)
>>
> I will attempt a firmware upgrade (manually downloading/compiling/running
> b43-fwcutter) when I have access to this laptop again (later today).  Debian
> bug #561450 covers the fact that the Debian b43-fwcutter package is too old;
> I have added a post to that bug report mentioning the v478 firmware + the
> "Fatal DMA error" message (the original bug reporter did not check his
> dmesg).
>

UPDATE: Upgraded firmware to v478.  The original "Fatal DMA error" (the code
0x800 one) no longer appears, replaced now by a code 0x400 one.  Also, the
wireless-LAN light on my laptop will flicker off and back on every so often,
accompanied by a temporary system freeze.  I assume that this is occurring
in synchrony with the card restarting.

--Lucas

>
> --Lucas
>
>>
>>
>>
>> --
>>
>> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100125/da3718c3/attachment.html>

From ljthode at gmail.com  Tue Jan 26 04:53:31 2010
From: ljthode at gmail.com (Lucas Thode)
Date: Mon, 25 Jan 2010 21:53:31 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <cb3b33ef1001251926nf33837ctf23722da5bb2c247@mail.gmail.com>
References: <cb3b33ef1001251215v64456ff4v13071f8f3c72d952@mail.gmail.com>
	<69e28c911001251249l2903a154nc921e68a8c5e4432@mail.gmail.com>
	<cb3b33ef1001251812w68c1c061r672b7f11b06d61d8@mail.gmail.com>
	<cb3b33ef1001251926nf33837ctf23722da5bb2c247@mail.gmail.com>
Message-ID: <cb3b33ef1001251953i2f0e4bf5w5933c888df0ae1c5@mail.gmail.com>

2010/1/25 Lucas Thode <ljthode at gmail.com>

>
>
> 2010/1/25 Lucas Thode <ljthode at gmail.com>
>
>
>>
>> 2010/1/25 G?bor Stefanik <netrolller.3d at gmail.com>
>>
>>
>>>
>>> A few things to check:
>>>
>>> -Is this on PhoenixBios?
>>>
>> Indeed, the Vostro 1510 uses a (Dell branded) PhoenixBIOS.
>>
>>> -Does loading wl, doing a warm reboot and loading b43 make b43 work?
>>>
>> UPDATE 2: No, I tried loading my 2.6.30 kernel (which has working wireless
using wl.ko) then Ctrl-Alt-Del-ing into my 2.6.32 kernel, and the Fatal DMA
errors perisisted.  (They seem to start happening shortly after system
startup, too; no action on my part is needed to provoke them.)

> -Try updating the firmware to v478. (AFAIK there was someone on the
>>> list before with a DMA error on a non-ULV, and it was solved by
>>> updating the firmware. Broadcom's wl.ko uses a v5xx firmware for the
>>> record.)
>>>
>> I will attempt a firmware upgrade (manually downloading/compiling/running
>> b43-fwcutter) when I have access to this laptop again (later today).  Debian
>> bug #561450 covers the fact that the Debian b43-fwcutter package is too old;
>> I have added a post to that bug report mentioning the v478 firmware + the
>> "Fatal DMA error" message (the original bug reporter did not check his
>> dmesg).
>>
>
> UPDATE: Upgraded firmware to v478.  The original "Fatal DMA error" (the
> code 0x800 one) no longer appears, replaced now by a code 0x400 one.  Also,
> the wireless-LAN light on my laptop will flicker off and back on every so
> often, accompanied by a temporary system freeze.  I assume that this is
> occurring in synchrony with the card restarting.
>
> --Lucas
>
>>
>> --Lucas
>>
>>>
>>>
>>>
>>> --
>>>
>>> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>>>
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100125/18a2bd52/attachment.html>

From Larry.Finger at lwfinger.net  Tue Jan 26 23:42:02 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 26 Jan 2010 16:42:02 -0600
Subject: [PATCH] b43: N PHY: Fix compilation after removal of typdef
 b43_c32
Message-ID: <4b5f6fba.foXrkAD8gU11wYBv%Larry.Finger@lwfinger.net>

In the conversion between typedef and struct, two places that needed a "struct"
were missed.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

Without these, compilation fails.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/phy_n.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/phy_n.c
+++ wireless-testing/drivers/net/wireless/b43/phy_n.c
@@ -822,7 +822,7 @@ static u16 b43_nphy_gen_load_samples(str
 {
 	int i;
 	u16 bw, len, rot, angle;
-	b43_c32 *samples;
+	struct b43_c32 *samples;
 
 
 	bw = (dev->phy.is_40mhz) ? 40 : 20;
@@ -840,7 +840,7 @@ static u16 b43_nphy_gen_load_samples(str
 		len = bw << 1;
 	}
 
-	samples = kzalloc(len * sizeof(b43_c32), GFP_KERNEL);
+	samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
 	rot = (((freq * 36) / bw) << 16) / 100;
 	angle = 0;
 


From yhager at yhager.com  Wed Jan 27 15:04:31 2010
From: yhager at yhager.com (Yuval Hager)
Date: Wed, 27 Jan 2010 16:04:31 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <200912271626.27144.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
	<200912271626.27144.yhager@yhager.com>
Message-ID: <201001271604.31640.yhager@yhager.com>

On Sunday 27 December 2009, Yuval Hager wrote:
> On Saturday 26 December 2009, G?bor Stefanik wrote:
> > Update your pci.ids file - what you have is a BCM4311/02 ABG.
> 
> I ran update-pciids successfully, now dmesg says:
> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
> 
> and lspci:
> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
>  802.11a/b/g [14e4:4312] (rev 02)
> 
> > Also, could you check a few more kernels in-between .29 and .32?
> 
> I have checked the following kernels, and found they all work correctly:
> 2.6.29
> 2.6.29.6
> 2.6.30.4
> 2.6.31.9
> 
> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned in
>  the original post. Before checking 2.6.32, I have removed
>  /lib/firmware/b43 completely and installed the firmware based on the
>  detailed instructions on the web site. I also enabled
>  CONFIG_B43_PHY_LP=y for 2.6.32.
> 
> all kernels checked are vanilla kernels, from kernel.org.
> 

Just a quick update on this - this still happes on latest - 2.6.32.6.

--yuval

> --y
> 
> > On Sat, Dec 26, 2009 at 8:01 PM,  <yhager at yhager.com> wrote:
> > > Hi,
> > >
> > > First, some adminstrativa..
> > >
> > > $ uname -srvmip
> > > Linux 2.6.29 #4 Fri Aug 28 13:17:05 IDT 2009 i686 VIA C7-M Processor
> > > 1600MHz CentaurHauls
> > >
> > > $ lspci -vnn |grep 14e4
> > > 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> > > 802.11a/b/g [14e4:4312] (rev 02) 07:03.0 Ethernet controller [0200]:
> > > Broadcom Corporation NetXtreme BCM5788 Gigabit Ethernet [14e4:169c]
> > > (rev 03)
> > >
> > > $ dmesg|grep b43-phy | head -1
> > > [    7.461364] b43-phy0: Broadcom 4311 WLAN found
> > >
> > > This same machine works fine when I use the 2.6.29 kernel, but when I
> > > use 2.6.32, I get "Carrier lost" disconnection after a couple of
> > > minutes (exact times vary between 30 seconds to about 2-3 minutes).
> > >
> > > Before filling everyone's inbox with large kernel logs, here's a
> > > snippet from dmesg:
> > > # dmesg | egrep  "b43|wlan|AP"
> > > [    0.000000] ACPI: APIC 6feb0390 00060 (v02 HP     APIC2203
> > > 20080820 MSFT 00000097) [    0.000000]   #5 [0000008000 - 000000f000]
> > > BOOTMAP ==> [0000008000 - 000000f000] [    0.121705] ACPI: Power
> > > Resource [APMF] (off)
> > > [    4.608781] b43-pci-bridge 0000:02:00.0: PCI INT A -> Link[LNKH]
> > > -> GSI 10 (level, low) -> IRQ 10 [    4.608809] b43-pci-bridge
> > > 0000:02:00.0: setting latency timer to 64 [    4.807626] b43-phy0:
> > > Broadcom 4311 WLAN found (core revision 13) [    4.900090] b43-phy0
> > > debug: Found PHY: Analog 4, Type 2, Revision 9 [    4.900120]
> > > b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> > > [ 4.960151] b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in
> > > kernel config [    4.966071] Registered led device: b43-phy0::tx [   
> > > 4.966125] Registered led device: b43-phy0::rx
> > > [    4.966179] Registered led device: b43-phy0::radio
> > > [    5.048461] fuse init (API version 7.13)
> > > [   34.990139] b43 ssb0:0: firmware: requesting b43/ucode13.fw
> > > [   35.080855] b43 ssb0:0: firmware: requesting b43/b0g0initvals13.fw
> > > [   35.250092] b43-phy0: Loading firmware version 478.104 (2008-07-01
> > > 00:50:23) [   35.360376] b43-phy0 debug: Chip initialized
> > > [   35.360441] b43-pci-bridge 0000:02:00.0: PCI: Disallowing DAC for
> > > device [   35.360452] b43-phy0: DMA mask fallback from 64-bit to
> > > 32-bit [   35.360809] b43-phy0 debug: 64-bit DMA initialized
> > > [   35.360893] b43-phy0 debug: QoS enabled
> > > [   35.400721] b43-phy0 debug: Wireless interface started
> > > [   35.400741] b43-phy0 debug: Adding Interface type 2
> > > [   45.267169] b43-phy0 debug: Removing Interface type 2
> > > [   45.267283] b43-phy0 debug: Wireless interface stopped
> > > [   45.267295] b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64,
> > > Failed frames 0/0 = 0.0%, Average tries 0.00 [   45.267421] b43-phy0
> > > debug: DMA-64 tx_ring_AC_BK: Used slots 0/256, Failed frames 0/0 =
> > > 0.0%, Average tries 0.00 [   45.280097] b43-phy0 debug: DMA-64
> > > tx_ring_AC_BE: Used slots 0/256, Failed frames 0/0 = 0.0%, Average
> > > tries 0.00 [ 45.300151] b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used
> > > slots 0/256, Failed frames 0/0 = 0.0%, Average tries 0.00 [  
> > > 45.320064] b43-phy0 debug: DMA-64 tx_ring_AC_VO: Used slots 2/256,
> > > Failed frames 0/22 = 0.0%, Average tries 1.00 [   45.340060] b43-phy0
> > > debug: DMA-64 tx_ring_mcast: Used slots 0/256, Failed frames 0/0 =
> > > 0.0%, Average tries 0.00 [   45.620280] b43-phy0: Loading firmware
> > > version 478.104 (2008-07-01 00:50:23) [   45.730312] b43-phy0 debug:
> > > Chip initialized [   45.730374] b43-pci-bridge 0000:02:00.0: PCI:
> > > Disallowing DAC for device [   45.730383] b43-phy0: DMA mask fallback
> > > from 64-bit to 32-bit [   45.730623] b43-phy0 debug: 64-bit DMA
> > > initialized
> > > [   45.730703] b43-phy0 debug: QoS enabled
> > > [   45.770718] b43-phy0 debug: Wireless interface started
> > > [   45.770732] b43-phy0 debug: Adding Interface type 2
> > > [   45.858474] wlan0: direct probe to AP 00:22:3f:18:89:5e (try 1)
> > > [   45.860542] wlan0: direct probe responded
> > > [   45.860551] wlan0: authenticate with AP 00:22:3f:18:89:5e (try 1)
> > > [   45.862212] wlan0: authenticated
> > > [   45.862250] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > > [   45.864940] wlan0: RX AssocResp from 00:22:3f:18:89:5e
> > > (capab=0x401 status=0 aid=2) [   45.864948] wlan0: associated
> > > [   45.866668] wlan0: deauthenticating from 00:22:3f:18:89:5e by
> > > local choice (reason=3) [   45.866797] wlan0: direct probe to AP
> > > 00:22:3f:18:89:5e (try 1) [   45.869397] wlan0: direct probe
> > > responded [   45.869406] wlan0: authenticate with AP
> > > 00:22:3f:18:89:5e (try 1) [   45.871106] wlan0: authenticated
> > > [   45.871141] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > > [   45.873524] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > > (capab=0x401 status=0 aid=2) [   45.873532] wlan0: associated
> > > [   45.874266] wlan0: deauthenticating from 00:22:3f:18:89:5e by
> > > local choice (reason=3) [   45.874364] wlan0: direct probe to AP
> > > 00:22:3f:18:89:5e (try 1) [   45.876965] wlan0: direct probe
> > > responded [   45.876975] wlan0: authenticate with AP
> > > 00:22:3f:18:89:5e (try 1) [   45.878663] wlan0: authenticated
> > > [   45.878697] wlan0: associate with AP 00:22:3f:18:89:5e (try 1)
> > > [   45.881069] wlan0: RX ReassocResp from 00:22:3f:18:89:5e
> > > (capab=0x401 status=0 aid=2) [   45.881077] wlan0: associated
> > > [   93.540091] No probe response from AP 00:22:3f:18:89:5e after
> > > 500ms, disconnecting.
> > >
> > > Any ideas?
> > >
> > > PS - I have also tried 2.6.32.2, with same results.
> > >
> > > --
> > > Yuval Hager
> > > [@] yuval at avramzon.net
> > > _______________________________________________
> > > Bcm43xx-dev mailing list
> > > Bcm43xx-dev at lists.berlios.de
> > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100127/bf44f83e/attachment.pgp>

From zajec5 at gmail.com  Wed Jan 27 16:38:26 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 27 Jan 2010 16:38:26 +0100
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001271604.31640.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
	<200912271626.27144.yhager@yhager.com>
	<201001271604.31640.yhager@yhager.com>
Message-ID: <b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>

2010/1/27 Yuval Hager <yhager at yhager.com>:
> On Sunday 27 December 2009, Yuval Hager wrote:
>> On Saturday 26 December 2009, G?bor Stefanik wrote:
>> > Update your pci.ids file - what you have is a BCM4311/02 ABG.
>>
>> I ran update-pciids successfully, now dmesg says:
>> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
>>
>> and lspci:
>> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
>> ?802.11a/b/g [14e4:4312] (rev 02)
>>
>> > Also, could you check a few more kernels in-between .29 and .32?
>>
>> I have checked the following kernels, and found they all work correctly:
>> 2.6.29
>> 2.6.29.6
>> 2.6.30.4
>> 2.6.31.9
>>
>> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned in
>> ?the original post. Before checking 2.6.32, I have removed
>> ?/lib/firmware/b43 completely and installed the firmware based on the
>> ?detailed instructions on the web site. I also enabled
>> ?CONFIG_B43_PHY_LP=y for 2.6.32.
>>
>> all kernels checked are vanilla kernels, from kernel.org.
>>
>
> Just a quick update on this - this still happes on latest - 2.6.32.6.

Could you try to (git) bisect this problem?

This will unfortunately take hours to do, but should give us commit
that broke support for your wifi.

For howto you can check http://landley.net/writing/git-quick.html

Generally I think you should do something like:

git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git
cd linux-2.6
git bisect bad 22763c5cf3690a681551162c15d34d935308c8d7
git bisect good 74fca6a42863ffacaf7ba6f1936a9f228950f657

You can eventually bisect on drivers/net/wireless but I'm not sure how
to do this properly.

-- 
Rafa?


From Larry.Finger at lwfinger.net  Wed Jan 27 17:05:14 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 27 Jan 2010 10:05:14 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
References: <20091226190129.GA20638@garlic>	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>	<200912271626.27144.yhager@yhager.com>	<201001271604.31640.yhager@yhager.com>
	<b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
Message-ID: <4B60643A.2050106@lwfinger.net>

On 01/27/2010 09:38 AM, Rafa? Mi?ecki wrote:
> 2010/1/27 Yuval Hager<yhager at yhager.com>:
>> On Sunday 27 December 2009, Yuval Hager wrote:
>>> On Saturday 26 December 2009, G?bor Stefanik wrote:
>>>> Update your pci.ids file - what you have is a BCM4311/02 ABG.
>>>
>>> I ran update-pciids successfully, now dmesg says:
>>> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
>>>
>>> and lspci:
>>> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
>>>   802.11a/b/g [14e4:4312] (rev 02)
>>>
>>>> Also, could you check a few more kernels in-between .29 and .32?
>>>
>>> I have checked the following kernels, and found they all work correctly:
>>> 2.6.29
>>> 2.6.29.6
>>> 2.6.30.4
>>> 2.6.31.9
>>>
>>> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned in
>>>   the original post. Before checking 2.6.32, I have removed
>>>   /lib/firmware/b43 completely and installed the firmware based on the
>>>   detailed instructions on the web site. I also enabled
>>>   CONFIG_B43_PHY_LP=y for 2.6.32.
>>>
>>> all kernels checked are vanilla kernels, from kernel.org.
>>>
>>
>> Just a quick update on this - this still happes on latest - 2.6.32.6.
>
> Could you try to (git) bisect this problem?
>
> This will unfortunately take hours to do, but should give us commit
> that broke support for your wifi.
>
> For howto you can check http://landley.net/writing/git-quick.html
>
> Generally I think you should do something like:
>
> git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git
> cd linux-2.6
> git bisect bad 22763c5cf3690a681551162c15d34d935308c8d7
> git bisect good 74fca6a42863ffacaf7ba6f1936a9f228950f657
>
> You can eventually bisect on drivers/net/wireless but I'm not sure how
> to do this properly.

git start drivers/net/wireless
git good blahblah
git bad blahblah



From zajec5 at gmail.com  Wed Jan 27 17:36:42 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Wed, 27 Jan 2010 17:36:42 +0100
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B60643A.2050106@lwfinger.net>
References: <20091226190129.GA20638@garlic>
	<69e28c910912261306l2d991d4ax55afe18b618acac5@mail.gmail.com>
	<200912271626.27144.yhager@yhager.com>
	<201001271604.31640.yhager@yhager.com>
	<b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
	<4B60643A.2050106@lwfinger.net>
Message-ID: <b170af451001270836v5e57042cn576b39f19797d919@mail.gmail.com>

W dniu 27 stycznia 2010 17:05 u?ytkownik Larry Finger
<Larry.Finger at lwfinger.net> napisa?:
> On 01/27/2010 09:38 AM, Rafa? Mi?ecki wrote:
>>
>> 2010/1/27 Yuval Hager<yhager at yhager.com>:
>>>
>>> On Sunday 27 December 2009, Yuval Hager wrote:
>>>>
>>>> On Saturday 26 December 2009, G?bor Stefanik wrote:
>>>>>
>>>>> Update your pci.ids file - what you have is a BCM4311/02 ABG.
>>>>
>>>> I ran update-pciids successfully, now dmesg says:
>>>> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
>>>>
>>>> and lspci:
>>>> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
>>>> ?802.11a/b/g [14e4:4312] (rev 02)
>>>>
>>>>> Also, could you check a few more kernels in-between .29 and .32?
>>>>
>>>> I have checked the following kernels, and found they all work correctly:
>>>> 2.6.29
>>>> 2.6.29.6
>>>> 2.6.30.4
>>>> 2.6.31.9
>>>>
>>>> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned in
>>>> ?the original post. Before checking 2.6.32, I have removed
>>>> ?/lib/firmware/b43 completely and installed the firmware based on the
>>>> ?detailed instructions on the web site. I also enabled
>>>> ?CONFIG_B43_PHY_LP=y for 2.6.32.
>>>>
>>>> all kernels checked are vanilla kernels, from kernel.org.
>>>>
>>>
>>> Just a quick update on this - this still happes on latest - 2.6.32.6.
>>
>> Could you try to (git) bisect this problem?
>>
>> This will unfortunately take hours to do, but should give us commit
>> that broke support for your wifi.
>>
>> For howto you can check http://landley.net/writing/git-quick.html
>>
>> Generally I think you should do something like:
>>
>> git clone
>> git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git
>> cd linux-2.6
>> git bisect bad 22763c5cf3690a681551162c15d34d935308c8d7
>> git bisect good 74fca6a42863ffacaf7ba6f1936a9f228950f657
>>
>> You can eventually bisect on drivers/net/wireless but I'm not sure how
>> to do this properly.
>
> git start drivers/net/wireless
> git good blahblah
> git bad blahblah

Thanks Larry.

Yuval: this way it should be really fast to find first-bad-commit.
Would be great if you could do this bisect.

-- 
Rafa?


From yhager at yhager.com  Wed Jan 27 17:54:17 2010
From: yhager at yhager.com (Yuval Hager)
Date: Wed, 27 Jan 2010 18:54:17 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <b170af451001270836v5e57042cn576b39f19797d919@mail.gmail.com>
References: <20091226190129.GA20638@garlic> <4B60643A.2050106@lwfinger.net>
	<b170af451001270836v5e57042cn576b39f19797d919@mail.gmail.com>
Message-ID: <201001271854.18821.yhager@yhager.com>

On Wednesday 27 January 2010, Rafa? Mi?ecki wrote:
> W dniu 27 stycznia 2010 17:05 u?ytkownik Larry Finger
> 
> <Larry.Finger at lwfinger.net> napisa?:
> > On 01/27/2010 09:38 AM, Rafa? Mi?ecki wrote:
> >> 2010/1/27 Yuval Hager<yhager at yhager.com>:
> >>> On Sunday 27 December 2009, Yuval Hager wrote:
> >>>> On Saturday 26 December 2009, G?bor Stefanik wrote:
> >>>>> Update your pci.ids file - what you have is a BCM4311/02 ABG.
> >>>>
> >>>> I ran update-pciids successfully, now dmesg says:
> >>>> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
> >>>>
> >>>> and lspci:
> >>>> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> >>>>  802.11a/b/g [14e4:4312] (rev 02)
> >>>>
> >>>>> Also, could you check a few more kernels in-between .29 and .32?
> >>>>
> >>>> I have checked the following kernels, and found they all work
> >>>> correctly: 2.6.29
> >>>> 2.6.29.6
> >>>> 2.6.30.4
> >>>> 2.6.31.9
> >>>>
> >>>> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned
> >>>> in the original post. Before checking 2.6.32, I have removed
> >>>>  /lib/firmware/b43 completely and installed the firmware based on
> >>>> the detailed instructions on the web site. I also enabled
> >>>>  CONFIG_B43_PHY_LP=y for 2.6.32.
> >>>>
> >>>> all kernels checked are vanilla kernels, from kernel.org.
> >>>
> >>> Just a quick update on this - this still happes on latest - 2.6.32.6.
> >>
> >> Could you try to (git) bisect this problem?
> >>
> >> This will unfortunately take hours to do, but should give us commit
> >> that broke support for your wifi.
> >>
> >> For howto you can check http://landley.net/writing/git-quick.html
> >>
> >> Generally I think you should do something like:
> >>
> >> git clone
> >> git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git
> >> cd linux-2.6
> >> git bisect bad 22763c5cf3690a681551162c15d34d935308c8d7
> >> git bisect good 74fca6a42863ffacaf7ba6f1936a9f228950f657
> >>
> >> You can eventually bisect on drivers/net/wireless but I'm not sure how
> >> to do this properly.
> >
> > git start drivers/net/wireless
> > git good blahblah
> > git bad blahblah
> 
> Thanks Larry.
> 
> Yuval: this way it should be really fast to find first-bad-commit.
> Would be great if you could do this bisect.
> 

Yes, I know about 'git bisect', I used it in the past, and it's an awesome 
tool. I will run the test, and reply here when I have the result.
It might take me some time though..

--y
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100127/949d4f4d/attachment.pgp>

From linville at tuxdriver.com  Wed Jan 27 20:31:55 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 27 Jan 2010 14:31:55 -0500
Subject: [PATCH] b43: N PHY: Fix compilation after removal of typdef
	b43_c32
In-Reply-To: <4b5f6fba.foXrkAD8gU11wYBv%Larry.Finger@lwfinger.net>
References: <4b5f6fba.foXrkAD8gU11wYBv%Larry.Finger@lwfinger.net>
Message-ID: <20100127193155.GH2962@tuxdriver.com>

On Tue, Jan 26, 2010 at 04:42:02PM -0600, Larry Finger wrote:
> In the conversion between typedef and struct, two places that needed a "struct"
> were missed.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> Without these, compilation fails.
> 
> Larry

Larry, thanks for fixing this!  Sorry I missed those bits.

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From yhager at yhager.com  Thu Jan 28 10:38:30 2010
From: yhager at yhager.com (Yuval Hager)
Date: Thu, 28 Jan 2010 11:38:30 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
References: <20091226190129.GA20638@garlic>
	<201001271604.31640.yhager@yhager.com>
	<b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
Message-ID: <201001281138.39651.yhager@yhager.com>

On Wednesday 27 January 2010, Rafa? Mi?ecki wrote:
> 2010/1/27 Yuval Hager <yhager at yhager.com>:
> > On Sunday 27 December 2009, Yuval Hager wrote:
> >> On Saturday 26 December 2009, G?bor Stefanik wrote:
> >> > Update your pci.ids file - what you have is a BCM4311/02 ABG.
> >>
> >> I ran update-pciids successfully, now dmesg says:
> >> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
> >>
> >> and lspci:
> >> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> >>  802.11a/b/g [14e4:4312] (rev 02)
> >>
> >> > Also, could you check a few more kernels in-between .29 and .32?
> >>
> >> I have checked the following kernels, and found they all work
> >> correctly: 2.6.29
> >> 2.6.29.6
> >> 2.6.30.4
> >> 2.6.31.9
> >>
> >> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned
> >> in the original post. Before checking 2.6.32, I have removed
> >>  /lib/firmware/b43 completely and installed the firmware based on the
> >>  detailed instructions on the web site. I also enabled
> >>  CONFIG_B43_PHY_LP=y for 2.6.32.
> >>
> >> all kernels checked are vanilla kernels, from kernel.org.
> >
> > Just a quick update on this - this still happes on latest - 2.6.32.6.
> 
> Could you try to (git) bisect this problem?
> 

I've done the bisecting - here's the first commit that started this issue:

commit 36dbd9548e92268127b0c31b0e121e63e9207108
Author: Michael Buesch <mb at bu3sch.de>
Date:   Fri Sep 4 22:51:29 2009 +0200

    b43: Use a threaded IRQ handler
    
    Use a threaded IRQ handler to allow locking the mutex and
    sleeping while executing an interrupt.
    This removes usage of the irq_lock spinlock, but introduces
    a new hardirq_lock, which is _only_ used for the PCI/SSB lowlevel
    hard-irq handler. Sleeping busses (SDIO) will use mutex instead.
    
    Signed-off-by: Michael Buesch <mb at bu3sch.de>
    Tested-by: Larry Finger <Larry.Finger at lwfinger.net>
    Signed-off-by: John W. Linville <linville at tuxdriver.com>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100128/5cd73f44/attachment.pgp>

From zajec5 at gmail.com  Thu Jan 28 11:40:40 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 28 Jan 2010 11:40:40 +0100
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001281138.39651.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>
	<201001271604.31640.yhager@yhager.com>
	<b170af451001270738i115aca33r3e943c9132674c14@mail.gmail.com>
	<201001281138.39651.yhager@yhager.com>
Message-ID: <b170af451001280240l1f313544t78ff0a30f384295d@mail.gmail.com>

2010/1/28 Yuval Hager <yhager at yhager.com>:
> On Wednesday 27 January 2010, Rafa? Mi?ecki wrote:
>> 2010/1/27 Yuval Hager <yhager at yhager.com>:
>> > On Sunday 27 December 2009, Yuval Hager wrote:
>> >> On Saturday 26 December 2009, G?bor Stefanik wrote:
>> >> > Update your pci.ids file - what you have is a BCM4311/02 ABG.
>> >>
>> >> I ran update-pciids successfully, now dmesg says:
>> >> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
>> >>
>> >> and lspci:
>> >> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
>> >> ?802.11a/b/g [14e4:4312] (rev 02)
>> >>
>> >> > Also, could you check a few more kernels in-between .29 and .32?
>> >>
>> >> I have checked the following kernels, and found they all work
>> >> correctly: 2.6.29
>> >> 2.6.29.6
>> >> 2.6.30.4
>> >> 2.6.31.9
>> >>
>> >> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I mentioned
>> >> in the original post. Before checking 2.6.32, I have removed
>> >> ?/lib/firmware/b43 completely and installed the firmware based on the
>> >> ?detailed instructions on the web site. I also enabled
>> >> ?CONFIG_B43_PHY_LP=y for 2.6.32.
>> >>
>> >> all kernels checked are vanilla kernels, from kernel.org.
>> >
>> > Just a quick update on this - this still happes on latest - 2.6.32.6.
>>
>> Could you try to (git) bisect this problem?
>>
>
> I've done the bisecting - here's the first commit that started this issue:
>
> commit 36dbd9548e92268127b0c31b0e121e63e9207108
> Author: Michael Buesch <mb at bu3sch.de>
> Date: ? Fri Sep 4 22:51:29 2009 +0200
>
> ? ?b43: Use a threaded IRQ handler
>
> ? ?Use a threaded IRQ handler to allow locking the mutex and
> ? ?sleeping while executing an interrupt.
> ? ?This removes usage of the irq_lock spinlock, but introduces
> ? ?a new hardirq_lock, which is _only_ used for the PCI/SSB lowlevel
> ? ?hard-irq handler. Sleeping busses (SDIO) will use mutex instead.
>
> ? ?Signed-off-by: Michael Buesch <mb at bu3sch.de>
> ? ?Tested-by: Larry Finger <Larry.Finger at lwfinger.net>
> ? ?Signed-off-by: John W. Linville <linville at tuxdriver.com>

Ouch :( Thanks a lot for bisecting, unfortunately it's quite big,
non-trivial change. Can be hard to track what has changed incorrectly.
Diff:
http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=36dbd9548e92268127b0c31b0e121e63e9207108

Michael: could you check this, comment, please? Do you have any
suspections what can go wrong there?

-- 
Rafa?


From yhager at yhager.com  Thu Jan 28 11:42:34 2010
From: yhager at yhager.com (Yuval Hager)
Date: Thu, 28 Jan 2010 12:42:34 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <b170af451001280240l1f313544t78ff0a30f384295d@mail.gmail.com>
References: <20091226190129.GA20638@garlic>
	<201001281138.39651.yhager@yhager.com>
	<b170af451001280240l1f313544t78ff0a30f384295d@mail.gmail.com>
Message-ID: <201001281242.34828.yhager@yhager.com>

On Thursday 28 January 2010, Rafa? Mi?ecki wrote:
> 2010/1/28 Yuval Hager <yhager at yhager.com>:
> > On Wednesday 27 January 2010, Rafa? Mi?ecki wrote:
> >> 2010/1/27 Yuval Hager <yhager at yhager.com>:
> >> > On Sunday 27 December 2009, Yuval Hager wrote:
> >> >> On Saturday 26 December 2009, G?bor Stefanik wrote:
> >> >> > Update your pci.ids file - what you have is a BCM4311/02 ABG.
> >> >>
> >> >> I ran update-pciids successfully, now dmesg says:
> >> >> b43-phy0: Broadcom 4311 WLAN found (core revision 13)
> >> >>
> >> >> and lspci:
> >> >> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4312
> >> >>  802.11a/b/g [14e4:4312] (rev 02)
> >> >>
> >> >> > Also, could you check a few more kernels in-between .29 and .32?
> >> >>
> >> >> I have checked the following kernels, and found they all work
> >> >> correctly: 2.6.29
> >> >> 2.6.29.6
> >> >> 2.6.30.4
> >> >> 2.6.31.9
> >> >>
> >> >> Kernels 2.6.32 and 2.6.32.2 experience the disconnection I
> >> >> mentioned in the original post. Before checking 2.6.32, I have
> >> >> removed /lib/firmware/b43 completely and installed the firmware
> >> >> based on the detailed instructions on the web site. I also enabled
> >> >>  CONFIG_B43_PHY_LP=y for 2.6.32.
> >> >>
> >> >> all kernels checked are vanilla kernels, from kernel.org.
> >> >
> >> > Just a quick update on this - this still happes on latest -
> >> > 2.6.32.6.
> >>
> >> Could you try to (git) bisect this problem?
> >
> > I've done the bisecting - here's the first commit that started this
> > issue:
> >
> > commit 36dbd9548e92268127b0c31b0e121e63e9207108
> > Author: Michael Buesch <mb at bu3sch.de>
> > Date:   Fri Sep 4 22:51:29 2009 +0200
> >
> >    b43: Use a threaded IRQ handler
> >
> >    Use a threaded IRQ handler to allow locking the mutex and
> >    sleeping while executing an interrupt.
> >    This removes usage of the irq_lock spinlock, but introduces
> >    a new hardirq_lock, which is _only_ used for the PCI/SSB lowlevel
> >    hard-irq handler. Sleeping busses (SDIO) will use mutex instead.
> >
> >    Signed-off-by: Michael Buesch <mb at bu3sch.de>
> >    Tested-by: Larry Finger <Larry.Finger at lwfinger.net>
> >    Signed-off-by: John W. Linville <linville at tuxdriver.com>
> 
> Ouch :( Thanks a lot for bisecting, unfortunately it's quite big,
> non-trivial change. Can be hard to track what has changed incorrectly.
> Diff:
> http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit
> diff;h=36dbd9548e92268127b0c31b0e121e63e9207108
> 
> Michael: could you check this, comment, please? Do you have any
> suspections what can go wrong there?
> 

I'll be happy to apply patches as you wish.

--y
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100128/9f20e0e6/attachment.pgp>

From Larry.Finger at lwfinger.net  Thu Jan 28 17:25:50 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 28 Jan 2010 10:25:50 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001281242.34828.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>	<201001281138.39651.yhager@yhager.com>	<b170af451001280240l1f313544t78ff0a30f384295d@mail.gmail.com>
	<201001281242.34828.yhager@yhager.com>
Message-ID: <4B61BA8E.6070504@lwfinger.net>

On 01/28/2010 04:42 AM, Yuval Hager wrote:
>
> I'll be happy to apply patches as you wish.
>

Does this patch make any difference?


Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
  	}

  	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
  	b43_set_status(dev, B43_STAT_STARTED);

  	/* Start data flow (TX/RX). */


---

Larry




From yhager at yhager.com  Thu Jan 28 18:16:30 2010
From: yhager at yhager.com (Yuval Hager)
Date: Thu, 28 Jan 2010 19:16:30 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B61BA8E.6070504@lwfinger.net>
References: <20091226190129.GA20638@garlic>
	<201001281242.34828.yhager@yhager.com>
	<4B61BA8E.6070504@lwfinger.net>
Message-ID: <201001281916.30984.yhager@yhager.com>

On Thursday 28 January 2010 18:25:50 Larry Finger wrote:
> On 01/28/2010 04:42 AM, Yuval Hager wrote:
> > I'll be happy to apply patches as you wish.
> 
> Does this patch make any difference?
> 

No.
The patch did not apply on 36dbd954, I had to apply it manually. Should I 
switch to latest wireless testing for this?

--y
> 
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c
> +++ wireless-testing/drivers/net/wireless/b43/main.c
> @@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
>   	}
> 
>   	/* We are ready to run. */
> +	ieee80211_wake_queues(dev->wl->hw);
>   	b43_set_status(dev, B43_STAT_STARTED);
> 
>   	/* Start data flow (TX/RX). */
> 
> 
> ---
> 
> Larry
> 


From Larry.Finger at lwfinger.net  Thu Jan 28 18:57:10 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 28 Jan 2010 11:57:10 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001281916.30984.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>	<201001281242.34828.yhager@yhager.com>	<4B61BA8E.6070504@lwfinger.net>
	<201001281916.30984.yhager@yhager.com>
Message-ID: <4B61CFF6.5000303@lwfinger.net>

On 01/28/2010 11:16 AM, Yuval Hager wrote:
> On Thursday 28 January 2010 18:25:50 Larry Finger wrote:
>> On 01/28/2010 04:42 AM, Yuval Hager wrote:
>>> I'll be happy to apply patches as you wish.
>>
>> Does this patch make any difference?
>>
> 
> No.
> The patch did not apply on 36dbd954, I had to apply it manually. Should I 
> switch to latest wireless testing for this?

Have you tried wireless testing? If so, I don't see it in the mail messages.
There is a possibility that this problem has been fixed, but not backported.
Using wireless testing would also be helpful as then any patches that we provide
would apply without fiddling.

In the meantime, I will switch to my BCM4311 to see if it is affected. The PHY
is similar to yours, except for the 802.11a capability. It has been a while
since it was in the machine.

Larry


From yhager at yhager.com  Thu Jan 28 23:00:35 2010
From: yhager at yhager.com (Yuval Hager)
Date: Fri, 29 Jan 2010 00:00:35 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B61CFF6.5000303@lwfinger.net>
References: <20091226190129.GA20638@garlic>
	<201001281916.30984.yhager@yhager.com>
	<4B61CFF6.5000303@lwfinger.net>
Message-ID: <201001290000.35829.yhager@yhager.com>

On Thursday 28 January 2010, Larry Finger wrote:
> On 01/28/2010 11:16 AM, Yuval Hager wrote:
> > On Thursday 28 January 2010 18:25:50 Larry Finger wrote:
> >> On 01/28/2010 04:42 AM, Yuval Hager wrote:
> >>> I'll be happy to apply patches as you wish.
> >>
> >> Does this patch make any difference?
> >
> > No.
> > The patch did not apply on 36dbd954, I had to apply it manually. Should
> > I switch to latest wireless testing for this?
> 
> Have you tried wireless testing? If so, I don't see it in the mail
>  messages. There is a possibility that this problem has been fixed, but
>  not backported. Using wireless testing would also be helpful as then any
>  patches that we provide would apply without fiddling.
> 

I've just tried wireless-testing(1e95174e5), with and without the patch in the previous email - both produce the same result, but with different timing:

# tail dmesg-wireless-testing*
==> dmesg-wireless-testing <==
[   88.900721] b43-phy0 debug: Wireless interface started
[   88.900735] b43-phy0 debug: Adding Interface type 2
[   89.010202] wlan0: direct probe to 00:22:3f:18:89:5e (try 1)
[   89.015605] wlan0: direct probe responded
[   89.015633] wlan0: authenticate with 00:22:3f:18:89:5e (try 1)
[   89.017343] wlan0: authenticated
[   89.017769] wlan0: associate with 00:22:3f:18:89:5e (try 1)
[   89.022662] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
[   89.022675] wlan0: associated
[  243.540077] No probe response from AP 00:22:3f:18:89:5e after 500ms, disconnecting.

==> dmesg-wireless-testing-with-lf-patch <==
[   44.580752] b43-phy0 debug: Adding Interface type 2
[   44.700222] wlan0: direct probe to 00:22:3f:18:89:5e (try 1)
[   44.703326] wlan0: direct probe to 00:22:3f:18:89:5e (try 1)
[   44.706915] wlan0: direct probe responded
[   44.706949] wlan0: authenticate with 00:22:3f:18:89:5e (try 1)
[   44.711608] wlan0: authenticated
[   44.712026] wlan0: associate with 00:22:3f:18:89:5e (try 1)
[   44.716710] wlan0: RX AssocResp from 00:22:3f:18:89:5e (capab=0x401 status=0 aid=2)
[   44.716726] wlan0: associated
[   49.540068] No probe response from AP 00:22:3f:18:89:5e after 500ms, disconnecting.

--yuval
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100129/db739713/attachment.pgp>

From smpuj at bk.ru  Fri Jan 29 10:05:35 2010
From: smpuj at bk.ru (Orivej Desh)
Date: Fri, 29 Jan 2010 12:05:35 +0300
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001271604.31640.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>
	<200912271626.27144.yhager@yhager.com>
	<201001271604.31640.yhager@yhager.com>
Message-ID: <201001291205.36942.smpuj@bk.ru>

Not sure if this helps, but on my system (Network controller [0280]: Broadcom 
Corporation BCM4311 802.11b/g WLAN [14e4:4311] (rev 01); b43-phy0: Broadcom 4311 
WLAN found (core revision 10)) network controller no longer operates after 
disconnect. That is, "iwlist wlan0 scan" finds nothing.

My other details are similar to Yuval's one ? I've got the latest firmware, the 
problem appeared in 2.6.32, I've tested latest git without luck. Can't help too 
much, though, because there is no unprotected network over here (from which 
laptop disconnects immediately), and on the protected one on-line time is too 
large: at this session the first disconnect occured after 35 hours, the second - 
after half an hour after driver reset with ifconfig wlan0 down/up, the third - 
hour and an half after reset; this is not normal because I had no disconnects 
before 2.6.32.


From zajec5 at gmail.com  Sat Jan 30 00:12:19 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 00:12:19 +0100
Subject: [PATCH 1/2] b43: N-PHY: update general workarounds
Message-ID: <1264806740-691-1-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |  215 ++++++++++++++++++++------------------
 drivers/net/wireless/b43/phy_n.h |    4 +
 2 files changed, 115 insertions(+), 104 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 8c39fb1..60e730a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -246,110 +246,6 @@ static void b43_nphy_tables_init(struct b43_wldev *dev)
 		b43_nphy_rev3plus_tables_init(dev);
 }
 
-static void b43_nphy_workarounds(struct b43_wldev *dev)
-{
-	struct b43_phy *phy = &dev->phy;
-	unsigned int i;
-
-	b43_phy_set(dev, B43_NPHY_IQFLIP,
-		    B43_NPHY_IQFLIP_ADC1 | B43_NPHY_IQFLIP_ADC2);
-	if (1 /* FIXME band is 2.4GHz */) {
-		b43_phy_set(dev, B43_NPHY_CLASSCTL,
-			    B43_NPHY_CLASSCTL_CCKEN);
-	} else {
-		b43_phy_mask(dev, B43_NPHY_CLASSCTL,
-			     ~B43_NPHY_CLASSCTL_CCKEN);
-	}
-	b43_radio_set(dev, B2055_C1_TX_RF_SPARE, 0x8);
-	b43_phy_write(dev, B43_NPHY_TXFRAMEDELAY, 8);
-
-	/* Fixup some tables */
-	b43_ntab_write(dev, B43_NTAB16(8, 0x00), 0xA);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x10), 0xA);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x02), 0xCDAA);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x12), 0xCDAA);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x08), 0);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x18), 0);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x07), 0x7AAB);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x17), 0x7AAB);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x06), 0x800);
-	b43_ntab_write(dev, B43_NTAB16(8, 0x16), 0x800);
-
-	b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);
-	b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);
-	b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);
-	b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);
-
-	//TODO set RF sequence
-
-	/* Set narrowband clip threshold */
-	b43_phy_write(dev, B43_NPHY_C1_NBCLIPTHRES, 66);
-	b43_phy_write(dev, B43_NPHY_C2_NBCLIPTHRES, 66);
-
-	/* Set wideband clip 2 threshold */
-	b43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,
-			~B43_NPHY_C1_CLIPWBTHRES_CLIP2,
-			21 << B43_NPHY_C1_CLIPWBTHRES_CLIP2_SHIFT);
-	b43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,
-			~B43_NPHY_C2_CLIPWBTHRES_CLIP2,
-			21 << B43_NPHY_C2_CLIPWBTHRES_CLIP2_SHIFT);
-
-	/* Set Clip 2 detect */
-	b43_phy_set(dev, B43_NPHY_C1_CGAINI,
-		    B43_NPHY_C1_CGAINI_CL2DETECT);
-	b43_phy_set(dev, B43_NPHY_C2_CGAINI,
-		    B43_NPHY_C2_CGAINI_CL2DETECT);
-
-	if (0 /*FIXME*/) {
-		/* Set dwell lengths */
-		b43_phy_write(dev, B43_NPHY_CLIP1_NBDWELL_LEN, 43);
-		b43_phy_write(dev, B43_NPHY_CLIP2_NBDWELL_LEN, 43);
-		b43_phy_write(dev, B43_NPHY_W1CLIP1_DWELL_LEN, 9);
-		b43_phy_write(dev, B43_NPHY_W1CLIP2_DWELL_LEN, 9);
-
-		/* Set gain backoff */
-		b43_phy_maskset(dev, B43_NPHY_C1_CGAINI,
-				~B43_NPHY_C1_CGAINI_GAINBKOFF,
-				1 << B43_NPHY_C1_CGAINI_GAINBKOFF_SHIFT);
-		b43_phy_maskset(dev, B43_NPHY_C2_CGAINI,
-				~B43_NPHY_C2_CGAINI_GAINBKOFF,
-				1 << B43_NPHY_C2_CGAINI_GAINBKOFF_SHIFT);
-
-		/* Set HPVGA2 index */
-		b43_phy_maskset(dev, B43_NPHY_C1_INITGAIN,
-				~B43_NPHY_C1_INITGAIN_HPVGA2,
-				6 << B43_NPHY_C1_INITGAIN_HPVGA2_SHIFT);
-		b43_phy_maskset(dev, B43_NPHY_C2_INITGAIN,
-				~B43_NPHY_C2_INITGAIN_HPVGA2,
-				6 << B43_NPHY_C2_INITGAIN_HPVGA2_SHIFT);
-
-		//FIXME verify that the specs really mean to use autoinc here.
-		for (i = 0; i < 3; i++)
-			b43_ntab_write(dev, B43_NTAB16(7, 0x106) + i, 0x673);
-	}
-
-	/* Set minimum gain value */
-	b43_phy_maskset(dev, B43_NPHY_C1_MINMAX_GAIN,
-			~B43_NPHY_C1_MINGAIN,
-			23 << B43_NPHY_C1_MINGAIN_SHIFT);
-	b43_phy_maskset(dev, B43_NPHY_C2_MINMAX_GAIN,
-			~B43_NPHY_C2_MINGAIN,
-			23 << B43_NPHY_C2_MINGAIN_SHIFT);
-
-	if (phy->rev < 2) {
-		b43_phy_mask(dev, B43_NPHY_SCRAM_SIGCTL,
-			     ~B43_NPHY_SCRAM_SIGCTL_SCM);
-	}
-
-	/* Set phase track alpha and beta */
-	b43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x125);
-	b43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x1B3);
-	b43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x105);
-	b43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x16E);
-	b43_phy_write(dev, B43_NPHY_PHASETR_B1, 0xCD);
-	b43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x20);
-}
-
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PA%20override */
 static void b43_nphy_pa_override(struct b43_wldev *dev, bool enable)
 {
@@ -816,6 +712,117 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Workarounds */
+static void b43_nphy_workarounds(struct b43_wldev *dev)
+{
+	struct ssb_bus *bus = dev->dev->bus;
+	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = phy->n;
+
+	u8 events1[7] = { 0x0, 0x1, 0x2, 0x8, 0x4, 0x5, 0x3 };
+	u8 delays1[7] = { 0x8, 0x6, 0x6, 0x2, 0x4, 0x3C, 0x1 };
+
+	u8 events2[7] = { 0x0, 0x3, 0x5, 0x4, 0x2, 0x1, 0x8 };
+	u8 delays2[7] = { 0x8, 0x6, 0x2, 0x4, 0x4, 0x6, 0x1 };
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
+		b43_nphy_classifier(dev, 1, 0);
+	else
+		b43_nphy_classifier(dev, 1, 1);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	b43_phy_set(dev, B43_NPHY_IQFLIP,
+		    B43_NPHY_IQFLIP_ADC1 | B43_NPHY_IQFLIP_ADC2);
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	} else {
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ &&
+		    nphy->band5g_pwrgain) {
+			b43_radio_mask(dev, B2055_C1_TX_RF_SPARE, ~0x8);
+			b43_radio_mask(dev, B2055_C2_TX_RF_SPARE, ~0x8);
+		} else {
+			b43_radio_set(dev, B2055_C1_TX_RF_SPARE, 0x8);
+			b43_radio_set(dev, B2055_C2_TX_RF_SPARE, 0x8);
+		}
+
+		/* TODO: convert to b43_ntab_write? */
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2000);
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x000A);
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2010);
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x000A);
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2002);
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0xCDAA);
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2012);
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0xCDAA);
+
+		if (dev->phy.rev < 2) {
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2008);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0000);
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2018);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0000);
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2007);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x7AAB);
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2017);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x7AAB);
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2006);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0800);
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x2016);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0800);
+		}
+
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);
+		b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);
+
+		if (bus->sprom.boardflags2_lo & 0x100 &&
+		    bus->boardinfo.type == 0x8B) {
+			delays1[0] = 0x1;
+			delays1[5] = 0x14;
+		}
+		/*TODO:b43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);*/
+		/*TODO:b43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);*/
+
+		/*TODO:b43_nphy_gain_crtl_workarounds(dev);*/
+
+		if (dev->phy.rev < 2) {
+			if (b43_phy_read(dev, B43_NPHY_RXCTL) & 0x2)
+				; /*TODO: b43_mhf(dev, 2, 0x0010, 0x0010, 3);*/
+		} else if (dev->phy.rev == 2) {
+			b43_phy_write(dev, B43_NPHY_CRSCHECK2, 0);
+			b43_phy_write(dev, B43_NPHY_CRSCHECK3, 0);
+		}
+
+		if (dev->phy.rev < 2)
+			b43_phy_mask(dev, B43_NPHY_SCRAM_SIGCTL,
+					~B43_NPHY_SCRAM_SIGCTL_SCM);
+
+		/* Set phase track alpha and beta */
+		b43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x125);
+		b43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x1B3);
+		b43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x105);
+		b43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x16E);
+		b43_phy_write(dev, B43_NPHY_PHASETR_B1, 0xCD);
+		b43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x20);
+
+		b43_phy_mask(dev, B43_NPHY_PIL_DW1,
+				(u16)~B43_NPHY_PIL_DW_64QAM);
+		b43_phy_write(dev, B43_NPHY_TXF_20CO_S2B1, 0xB5);
+		b43_phy_write(dev, B43_NPHY_TXF_20CO_S2B2, 0xA4);
+		b43_phy_write(dev, B43_NPHY_TXF_20CO_S2B3, 0x00);
+
+		if (dev->phy.rev == 2)
+			b43_phy_set(dev, B43_NPHY_FINERX2_CGC,
+					B43_NPHY_FINERX2_CGC_DECGC);
+	}
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */
 static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 					bool test)
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index f5a2766..ae82f0f 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -976,6 +976,10 @@ struct b43_phy_n {
 	s32 preamble_override;
 	u32 bb_mult_save;
 
+	bool gain_boost;
+	bool elna_gain_config;
+	bool band5g_pwrgain;
+
 	u8 mphase_cal_phase_id;
 	u16 mphase_txcal_cmdidx;
 	u16 mphase_txcal_numcmds;
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 00:12:20 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 00:12:20 +0100
Subject: [PATCH 2/2] b43: N-PHY: add workarounds for gain control
In-Reply-To: <1264806740-691-1-git-send-email-zajec5@gmail.com>
References: <1264806740-691-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264806740-691-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |  130 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 129 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 60e730a..d738d76 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -712,6 +712,134 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */
+static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u8 i, j;
+	u8 code;
+
+	/* TODO: for PHY >= 3
+	s8 *lna1_gain, *lna2_gain;
+	u8 *gain_db, *gain_bits;
+	u16 *rfseq_init;
+	u8 lpf_gain[6] = { 0x00, 0x06, 0x0C, 0x12, 0x12, 0x12 };
+	u8 lpf_bits[6] = { 0, 1, 2, 3, 3, 3 };
+	*/
+
+	u8 rfseq_events[3] = { 6, 8, 7 };
+	u8 rfseq_delays[3] = { 10, 30, 1 };
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	} else {
+		/* Set Clip 2 detect */
+		b43_phy_set(dev, B43_NPHY_C1_CGAINI,
+				B43_NPHY_C1_CGAINI_CL2DETECT);
+		b43_phy_set(dev, B43_NPHY_C2_CGAINI,
+				B43_NPHY_C2_CGAINI_CL2DETECT);
+
+		/* Set narrowband clip threshold */
+		b43_phy_set(dev, B43_NPHY_C1_NBCLIPTHRES, 0x84);
+		b43_phy_set(dev, B43_NPHY_C2_NBCLIPTHRES, 0x84);
+
+		if (!dev->phy.is_40mhz) {
+			/* Set dwell lengths */
+			b43_phy_set(dev, B43_NPHY_CLIP1_NBDWELL_LEN, 0x002B);
+			b43_phy_set(dev, B43_NPHY_CLIP2_NBDWELL_LEN, 0x002B);
+			b43_phy_set(dev, B43_NPHY_W1CLIP1_DWELL_LEN, 0x0009);
+			b43_phy_set(dev, B43_NPHY_W1CLIP2_DWELL_LEN, 0x0009);
+		}
+
+		/* Set wideband clip 2 threshold */
+		b43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,
+				~B43_NPHY_C1_CLIPWBTHRES_CLIP2,
+				21);
+		b43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,
+				~B43_NPHY_C2_CLIPWBTHRES_CLIP2,
+				21);
+
+		if (!dev->phy.is_40mhz) {
+			b43_phy_maskset(dev, B43_NPHY_C1_CGAINI,
+				~B43_NPHY_C1_CGAINI_GAINBKOFF, 0x1);
+			b43_phy_maskset(dev, B43_NPHY_C2_CGAINI,
+				~B43_NPHY_C2_CGAINI_GAINBKOFF, 0x1);
+			b43_phy_maskset(dev, B43_NPHY_C1_CCK_CGAINI,
+				~B43_NPHY_C1_CCK_CGAINI_GAINBKOFF, 0x1);
+			b43_phy_maskset(dev, B43_NPHY_C2_CCK_CGAINI,
+				~B43_NPHY_C2_CCK_CGAINI_GAINBKOFF, 0x1);
+		}
+
+		b43_phy_set(dev, B43_NPHY_CCK_SHIFTB_REF, 0x809C);
+
+		if (nphy->gain_boost) {
+			if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ &&
+			    dev->phy.is_40mhz)
+				code = 4;
+			else
+				code = 5;
+		} else {
+			code = dev->phy.is_40mhz ? 6 : 7;
+		}
+
+		/* Set HPVGA2 index */
+		b43_phy_maskset(dev, B43_NPHY_C1_INITGAIN,
+				~B43_NPHY_C1_INITGAIN_HPVGA2,
+				code << B43_NPHY_C1_INITGAIN_HPVGA2_SHIFT);
+		b43_phy_maskset(dev, B43_NPHY_C2_INITGAIN,
+				~B43_NPHY_C2_INITGAIN_HPVGA2,
+				code << B43_NPHY_C2_INITGAIN_HPVGA2_SHIFT);
+
+		b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(code << 8 | 0x7C));
+		b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(code << 8 | 0x7C));
+
+		/* TODO: b43_nphy_adjust_lna_gain_table(dev); */
+
+		if (nphy->elna_gain_config) {
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0808);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0C08);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);
+
+			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(code << 8 | 0x74));
+			b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
+					(code << 8 | 0x74));
+		}
+
+		if (dev->phy.rev == 2) {
+			for (i = 0; i < 4; i++) {
+				b43_phy_write(dev, B43_NPHY_TABLE_ADDR,
+						(0x0400 * i) + 0x0020);
+				for (j = 0; j < 21; j++)
+					b43_phy_write(dev,
+						B43_NPHY_TABLE_DATALO, 3 * j);
+			}
+
+			/* TODO: b43_nphy_set_rf_sequence(dev, 5,
+					rfseq_events, rfseq_delays, 3);*/
+			b43_phy_maskset(dev, B43_NPHY_OVER_DGAIN1,
+				(u16)~B43_NPHY_OVER_DGAIN_CCKDGECV,
+				0x5A << B43_NPHY_OVER_DGAIN_CCKDGECV_SHIFT);
+
+			if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
+				b43_phy_maskset(dev, B43_PHY_N(0xC5D),
+						0xFF80, 4);
+		}
+	}
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Workarounds */
 static void b43_nphy_workarounds(struct b43_wldev *dev)
 {
@@ -786,7 +914,7 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
 		/*TODO:b43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);*/
 		/*TODO:b43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);*/
 
-		/*TODO:b43_nphy_gain_crtl_workarounds(dev);*/
+		b43_nphy_gain_crtl_workarounds(dev);
 
 		if (dev->phy.rev < 2) {
 			if (b43_phy_read(dev, B43_NPHY_RXCTL) & 0x2)
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 20:18:03 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 20:18:03 +0100
Subject: [PATCH 1/5] b43: N-PHY: split RSSI selection into two
	per-PHY-revision functions
Message-ID: <1264879087-14326-1-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |  101 +++++++++++++++++++------------------
 1 files changed, 52 insertions(+), 49 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index d738d76..c6a4dde 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1316,66 +1316,69 @@ static void b43_nphy_scale_offset_rssi(struct b43_wldev *dev, u16 scale,
 		b43_phy_write(dev, B43_NPHY_RSSIMC_1Q_TSSI, tmp);
 }
 
-/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */
-static void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
+static void b43_nphy_rev2_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
 {
 	u16 val;
 
-	if (dev->phy.rev >= 3) {
-		/* TODO */
-	} else {
-		if (type < 3)
-			val = 0;
-		else if (type == 6)
-			val = 1;
-		else if (type == 3)
-			val = 2;
-		else
-			val = 3;
+	if (type < 3)
+		val = 0;
+	else if (type == 6)
+		val = 1;
+	else if (type == 3)
+		val = 2;
+	else
+		val = 3;
 
-		val = (val << 12) | (val << 14);
-		b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, val);
-		b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, val);
+	val = (val << 12) | (val << 14);
+	b43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, val);
+	b43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, val);
 
+	if (type < 3) {
+		b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO1, 0xFFCF,
+				(type + 1) << 4);
+		b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO2, 0xFFCF,
+				(type + 1) << 4);
+	}
+
+	/* TODO use some definitions */
+	if (code == 0) {
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF, 0);
 		if (type < 3) {
-			b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO1, 0xFFCF,
-					(type + 1) << 4);
-			b43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO2, 0xFFCF,
-					(type + 1) << 4);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD, 0xFEC7, 0);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER, 0xEFDC, 0);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD, 0xFFFE, 0);
+			udelay(20);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER, 0xFFFE, 0);
 		}
-
-		/* TODO use some definitions */
-		if (code == 0) {
-			b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF, 0);
-			if (type < 3) {
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
-						0xFEC7, 0);
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
-						0xEFDC, 0);
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
-						0xFFFE, 0);
-				udelay(20);
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
-						0xFFFE, 0);
-			}
-		} else {
-			b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF,
-					0x3000);
-			if (type < 3) {
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
-						0xFEC7, 0x0180);
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
-						0xEFDC, (code << 1 | 0x1021));
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,
-						0xFFFE, 0x0001);
-				udelay(20);
-				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
-						0xFFFE, 0);
-			}
+	} else {
+		b43_phy_maskset(dev, B43_NPHY_AFECTL_OVER, 0xCFFF,
+				0x3000);
+		if (type < 3) {
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD, 
+					0xFEC7, 0x0180);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+					0xEFDC, (code << 1 | 0x1021));
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_CMD, 0xFFFE, 0x1);
+			udelay(20);
+			b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER, 0xFFFE, 0);
 		}
 	}
 }
 
+static void b43_nphy_rev3_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
+{
+	/* TODO */
+}
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */
+static void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
+{
+	if (dev->phy.rev >= 3)
+		b43_nphy_rev3_rssi_select(dev, code, type);
+	else
+		b43_nphy_rev2_rssi_select(dev, code, type);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRssi2055Vcm */
 static void b43_nphy_set_rssi_2055_vcm(struct b43_wldev *dev, u8 type, u8 *buf)
 {
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 20:18:04 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 20:18:04 +0100
Subject: [PATCH 2/5] b43: N-PHY: add RSSI selection for newer PHYs
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264879087-14326-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   84 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 83 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c6a4dde..690aaad 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1367,7 +1367,89 @@ static void b43_nphy_rev2_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
 
 static void b43_nphy_rev3_rssi_select(struct b43_wldev *dev, u8 code, u8 type)
 {
-	/* TODO */
+	struct b43_phy_n *nphy = dev->phy.n;
+	u8 i;
+	u16 reg, val;
+
+	if (code == 0) {
+		b43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, 0xFDFF);
+		b43_phy_mask(dev, B43_NPHY_AFECTL_OVER, 0xFDFF);
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C1, 0xFCFF);
+		b43_phy_mask(dev, B43_NPHY_AFECTL_C2, 0xFCFF);
+		b43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S0, 0xFFDF);
+		b43_phy_mask(dev, B43_NPHY_TXF_40CO_B32S1, 0xFFDF);
+		b43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0xFFC3);
+		b43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0xFFC3);
+	} else {
+		for (i = 0; i < 2; i++) {
+			if ((code == 1 && i == 1) || (code == 2 && !i))
+				continue;
+
+			reg = (i == 0) ?
+				B43_NPHY_AFECTL_OVER1 : B43_NPHY_AFECTL_OVER;
+			b43_phy_maskset(dev, reg, 0xFDFF, 0x0200);
+
+			if (type < 3) {
+				reg = (i == 0) ?
+					B43_NPHY_AFECTL_C1 :
+					B43_NPHY_AFECTL_C2;
+				b43_phy_maskset(dev, reg, 0xFCFF, 0);
+
+				reg = (i == 0) ?
+					B43_NPHY_RFCTL_LUT_TRSW_UP1 :
+					B43_NPHY_RFCTL_LUT_TRSW_UP2;
+				b43_phy_maskset(dev, reg, 0xFFC3, 0);
+
+				if (type == 0)
+					val = (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) ? 4 : 8;
+				else if (type == 1)
+					val = 16;
+				else
+					val = 32;
+				b43_phy_set(dev, reg, val);
+
+				reg = (i == 0) ?
+					B43_NPHY_TXF_40CO_B1S0 :
+					B43_NPHY_TXF_40CO_B32S1;
+				b43_phy_set(dev, reg, 0x0020);
+			} else {
+				if (type == 6)
+					val = 0x0100;
+				else if (type == 3)
+					val = 0x0200;
+				else
+					val = 0x0300;
+
+				reg = (i == 0) ?
+					B43_NPHY_AFECTL_C1 :
+					B43_NPHY_AFECTL_C2;
+
+				b43_phy_maskset(dev, reg, 0xFCFF, val);
+				b43_phy_maskset(dev, reg, 0xF3FF, val << 2);
+
+				if (type != 3 && type != 6) {
+					enum ieee80211_band band =
+						b43_current_band(dev->wl);
+
+					if ((nphy->ipa2g_on &&
+						band == IEEE80211_BAND_2GHZ) ||
+						(nphy->ipa5g_on &&
+						band == IEEE80211_BAND_5GHZ))
+						val = (band == IEEE80211_BAND_5GHZ) ? 0xC : 0xE;
+					else
+						val = 0x11;
+					reg = (i == 0) ? 0x2000 : 0x3000;
+					reg |= B2055_PADDRV;
+					b43_radio_write16(dev, reg, val);
+
+					reg = (i == 0) ?
+						B43_NPHY_AFECTL_OVER1 :
+						B43_NPHY_AFECTL_OVER;
+					b43_phy_set(dev, reg, 0x0200);
+				}
+			}
+		}
+	}
 }
 
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 20:18:05 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 20:18:05 +0100
Subject: [PATCH 3/5] b43: N-PHY: fix Cal TX IQ LO for newer PHYs
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264879087-14326-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 690aaad..cf107c5 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -2229,7 +2229,17 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 		(dev->phy.rev == 5 && nphy->ipa2g_on &&
 		b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ);
 	if (phy6or5x) {
-		/* TODO */
+		if (dev->phy.is_40mhz) {
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 0), 18,
+					tbl_tx_iqlo_cal_loft_ladder_40);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 32), 18,
+					tbl_tx_iqlo_cal_iqimb_ladder_40);
+		} else {
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 0), 18,
+					tbl_tx_iqlo_cal_loft_ladder_20);
+			b43_ntab_write_bulk(dev, B43_NTAB16(15, 32), 18,
+					tbl_tx_iqlo_cal_iqimb_ladder_20);
+		}
 	}
 
 	b43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 20:18:06 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 20:18:06 +0100
Subject: [PATCH 4/5] b43: N-PHY: add TX radio setup for newer PHYs
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264879087-14326-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   53 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 52 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index cf107c5..c1fc3cc 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1803,9 +1803,60 @@ static void b43_nphy_tx_cal_radio_setup(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy = dev->phy.n;
 	u16 *save = nphy->tx_rx_cal_radio_saveregs;
+	u16 tmp;
+	u8 offset, i;
 
 	if (dev->phy.rev >= 3) {
-		/* TODO */
+	    for (i = 0; i < 2; i++) {
+		tmp = (i == 0) ? 0x2000 : 0x3000;
+		offset = i * 11;
+
+		save[offset + 0] = b43_radio_read16(dev, B2055_CAL_RVARCTL);
+		save[offset + 1] = b43_radio_read16(dev, B2055_CAL_LPOCTL);
+		save[offset + 2] = b43_radio_read16(dev, B2055_CAL_TS);
+		save[offset + 3] = b43_radio_read16(dev, B2055_CAL_RCCALRTS);
+		save[offset + 4] = b43_radio_read16(dev, B2055_CAL_RCALRTS);
+		save[offset + 5] = b43_radio_read16(dev, B2055_PADDRV);
+		save[offset + 6] = b43_radio_read16(dev, B2055_XOCTL1);
+		save[offset + 7] = b43_radio_read16(dev, B2055_XOCTL2);
+		save[offset + 8] = b43_radio_read16(dev, B2055_XOREGUL);
+		save[offset + 9] = b43_radio_read16(dev, B2055_XOMISC);
+		save[offset + 10] = b43_radio_read16(dev, B2055_PLL_LFC1);
+
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {
+			b43_radio_write16(dev, tmp | B2055_CAL_RVARCTL, 0x0A);
+			b43_radio_write16(dev, tmp | B2055_CAL_LPOCTL, 0x40);
+			b43_radio_write16(dev, tmp | B2055_CAL_TS, 0x55);
+			b43_radio_write16(dev, tmp | B2055_CAL_RCCALRTS, 0);
+			b43_radio_write16(dev, tmp | B2055_CAL_RCALRTS, 0);
+			if (nphy->ipa5g_on) {
+				b43_radio_write16(dev, tmp | B2055_PADDRV, 4);
+				b43_radio_write16(dev, tmp | B2055_XOCTL1, 1);
+			} else {
+				b43_radio_write16(dev, tmp | B2055_PADDRV, 0);
+				b43_radio_write16(dev, tmp | B2055_XOCTL1, 0x2F);
+			}
+			b43_radio_write16(dev, tmp | B2055_XOCTL2, 0);
+		} else {
+			b43_radio_write16(dev, tmp | B2055_CAL_RVARCTL, 0x06);
+			b43_radio_write16(dev, tmp | B2055_CAL_LPOCTL, 0x40);
+			b43_radio_write16(dev, tmp | B2055_CAL_TS, 0x55);
+			b43_radio_write16(dev, tmp | B2055_CAL_RCCALRTS, 0);
+			b43_radio_write16(dev, tmp | B2055_CAL_RCALRTS, 0);
+			b43_radio_write16(dev, tmp | B2055_XOCTL1, 0);
+			if (nphy->ipa2g_on) {
+				b43_radio_write16(dev, tmp | B2055_PADDRV, 6);
+				b43_radio_write16(dev, tmp | B2055_XOCTL2,
+					(dev->phy.rev < 5) ? 0x11 : 0x01);
+			} else {
+				b43_radio_write16(dev, tmp | B2055_PADDRV, 0);
+				b43_radio_write16(dev, tmp | B2055_XOCTL2, 0);
+			}
+		}
+		b43_radio_write16(dev, tmp | B2055_XOREGUL, 0);
+		b43_radio_write16(dev, tmp | B2055_XOMISC, 0);
+		b43_radio_write16(dev, tmp | B2055_PLL_LFC1, 0);
+	    }
 	} else {
 		save[0] = b43_radio_read16(dev, B2055_C1_TX_RF_IQCAL1);
 		b43_radio_write16(dev, B2055_C1_TX_RF_IQCAL1, 0x29);
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Jan 30 20:18:07 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 30 Jan 2010 20:18:07 +0100
Subject: [PATCH 5/5] b43: N-PHY: implement setting RF sequence
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <1264879087-14326-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   35 +++++++++++++++++++++++++++++++----
 1 files changed, 31 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index c1fc3cc..ff42bd4 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -64,6 +64,8 @@ enum b43_nphy_rf_sequence {
 	B43_RFSEQ_UPDATE_GAINU,
 };
 
+static void b43_nphy_set_rf_sequence(struct b43_wldev *dev, u8 cmd,
+					u8 *events, u8 *delays, u8 length);
 static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
 				       enum b43_nphy_rf_sequence seq);
 
@@ -827,8 +829,8 @@ static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 						B43_NPHY_TABLE_DATALO, 3 * j);
 			}
 
-			/* TODO: b43_nphy_set_rf_sequence(dev, 5,
-					rfseq_events, rfseq_delays, 3);*/
+			b43_nphy_set_rf_sequence(dev, 5,
+					rfseq_events, rfseq_delays, 3);
 			b43_phy_maskset(dev, B43_NPHY_OVER_DGAIN1,
 				(u16)~B43_NPHY_OVER_DGAIN_CCKDGECV,
 				0x5A << B43_NPHY_OVER_DGAIN_CCKDGECV_SHIFT);
@@ -911,8 +913,8 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
 			delays1[0] = 0x1;
 			delays1[5] = 0x14;
 		}
-		/*TODO:b43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);*/
-		/*TODO:b43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);*/
+		b43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);
+		b43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);
 
 		b43_nphy_gain_crtl_workarounds(dev);
 
@@ -1131,6 +1133,31 @@ static void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, false);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRfSeq */
+static void b43_nphy_set_rf_sequence(struct b43_wldev *dev, u8 cmd,
+					u8 *events, u8 *delays, u8 length)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u8 i;
+	u8 end = (dev->phy.rev >= 3) ? 0x1F : 0x0F;
+	u16 offset1 = cmd << 4;
+	u16 offset2 = offset1 + 0x80;
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, true);
+
+	b43_ntab_write_bulk(dev, B43_NTAB8(7, offset1), length, events);
+	b43_ntab_write_bulk(dev, B43_NTAB8(7, offset2), length, delays);
+
+	for (i = length; i < 16; i++) {
+		b43_ntab_write(dev, B43_NTAB8(7, offset1 + i), end);
+		b43_ntab_write(dev, B43_NTAB8(7, offset2 + i), 1);
+	}
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, false);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ForceRFSeq */
 static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
 				       enum b43_nphy_rf_sequence seq)
-- 
1.6.4.2



From Larry.Finger at lwfinger.net  Sun Jan 31 23:03:25 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 31 Jan 2010 16:03:25 -0600
Subject: [RFC/RFT] b43: Fix regression from commit c7ab5ef
Message-ID: <4b65fe2d.tW61Y0okWmOLTL3e%Larry.Finger@lwfinger.net>

I had planned to address the issues reported in the thread "BCM4311/02
ABG disconnects on 2.6.32"; however, when I installed my BCM4311/2 card,
I found that the transmit rate as measured using program tcpperf was
greatly reduced from what I had seen when it was last in the machine.
With bisection, mainline commit number c7ab5ef9b was the problem. This
patch was part of the 2.6.28 merge, thus this problem has existed for
some time.

The patch changes basic rate handling and implements short slot handling.
The rate handling is OK - only the short slot changes were affecting
the performance. Further investigation showed that the original code
never called the routines that enable/disable short slot treatment,
but the revised code does. From the specs, changing this parameter
involves writing new values into a location in MMIO space and one in
the shared memory. Experimentation showed that writing the new value
to shared memory was the culprit. Changing the value in MMIO space
actually helped performance in some cases.

Tests on all my G PHY devices are summarized below. My AP is a Linksys
WRT54G V5 running the latest version of standard firmware, and with
combined 802.11b/g mode enabled. Transmit tests use program tcpperf
with a fast computer in my network as the tcpperf server. It is connected
to the AP/router with a 100 Mb/s wired connection. The results for all
my devices as as follows:

                         Transmit throughput in Mb/s
Device        Before c7ab5ef   After c7ab5ef  With this patch

BCM4306/3       unknown          5.3             19.0
BCM4318/2       unknown         18.3             18.3
BCM4311/2       18.3             0.7             22.1
BCM4312/1       N/A*            12.2             12.2

* LP PHY that was not supported until 2.6.32.

I have no idea what causes some devices to be unaffected, while others
are greatly improved. Please test to see if your device is adversely
affested.

Thanks,

Larry

--- Proposed commit message below. ---

Commit c7ab5ef9bcd281135c21b4732c9be779585181be entitled "b43: implement
short slot and basic rate handling" reduced the transmit throughput for
my BCM4311 device from 18 Mb/s to 0.7 Mb/s. The basic rate handling
portion is OK, the problem is in the short slot handling.

Prior to this change, the short slot enable/disable routines were never
called. Experimentation showed that the critical part was changing the
value at offset 0x0010 in the shared memory. This is supposed to contain
the 802.11 Slot Time in usec, but if it is changed from its initial value
of zero, performance is destroyed. On the other hand, changing the value
in the MMIO register corresponding to the Interframe Slot Time increased
performance from 18 to 22 Mb/s. A BCM4306/3 also shows dramatic
improvement of the transmit rate.

Other changes in the patch include removal of the magic number for the
MMIO register, and allowing the slot time to be set for any PHY operating
in the 2.4 GHz band. Previously, the routine was executed only for G PHYs.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
Cc: Stable <stable at kernel.org> [Any stable version back through 2.6.28]
---

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -637,10 +637,17 @@ static void b43_upload_card_macaddress(s
 static void b43_set_slot_time(struct b43_wldev *dev, u16 slot_time)
 {
 	/* slot_time is in usec. */
-	if (dev->phy.type != B43_PHYTYPE_G)
+	/* This test used to exit for all but a G PHY. */
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
 		return;
-	b43_write16(dev, 0x684, 510 + slot_time);
-	b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	b43_write16(dev, B43_MMIO_IFSSLOT, 510 + slot_time);
+	/* Shared memory location 0x0010 is the slot time and should be
+	 * set to slot_time; however, this register is initially 0 and changing
+	 * the value adversely affects the transmit rate for BCM4311
+	 * devices. Until this behavior is unterstood, delete this step
+	 *
+	 * b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	 */
 }
 
 static void b43_short_slot_timing_enable(struct b43_wldev *dev)
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h
+++ wireless-testing/drivers/net/wireless/b43/b43.h
@@ -115,6 +115,7 @@
 #define B43_MMIO_TSF_2			0x636	/* core rev < 3 only */
 #define B43_MMIO_TSF_3			0x638	/* core rev < 3 only */
 #define B43_MMIO_RNG			0x65A
+#define B43_MMIO_IFSSLOT		0x684	/* Interframe slot time */
 #define B43_MMIO_IFSCTL			0x688 /* Interframe space control */
 #define  B43_MMIO_IFSCTL_USE_EDCF	0x0004
 #define B43_MMIO_POWERUP_DELAY		0x6A8


From Larry.Finger at lwfinger.net  Sun Jan 31 23:51:49 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 31 Jan 2010 16:51:49 -0600
Subject: [PATCH 1/5] b43: N-PHY: split RSSI selection into
	two	per-PHY-revision functions
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <4B660985.6050203@lwfinger.net>

On 01/30/2010 01:18 PM, Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---

This one yields "Warning: trailing whitespace in line 1357 of
drivers/net/wireless/b43/phy_n.c"

Larry



From Larry.Finger at lwfinger.net  Sun Jan 31 23:51:49 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 31 Jan 2010 16:51:49 -0600
Subject: [PATCH 1/5] b43: N-PHY: split RSSI selection into
	two	per-PHY-revision functions
In-Reply-To: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
References: <1264879087-14326-1-git-send-email-zajec5@gmail.com>
Message-ID: <4B660985.6050203@lwfinger.net>

On 01/30/2010 01:18 PM, Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---

This one yields "Warning: trailing whitespace in line 1357 of
drivers/net/wireless/b43/phy_n.c"

Larry

--
To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
the body of a message to majordomo at vger.kernel.org
More majordomo info at  http://vger.kernel.org/majordomo-info.html


