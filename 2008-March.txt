From stefano.brivio at polimi.it  Sun Mar  2 12:04:41 2008
From: stefano.brivio at polimi.it (Stefano Brivio)
Date: Sun, 2 Mar 2008 12:04:41 +0100
Subject: Oops in mac80211:rate_control_pid_tx_status
In-Reply-To: <2c0942db0803011705j260186bbgb02dcd8f9842e52b@mail.gmail.com>
References: <2c0942db0803011705j260186bbgb02dcd8f9842e52b@mail.gmail.com>
Message-ID: <20080302120441.26c1b8a3@morte>

On Sat, 1 Mar 2008 17:05:50 -0800
"Ray Lee" <ray-lk at madrabbit.org> wrote:

> Kernel version 2.6.24+ a little (but pre-rc1).
> 
> I have a wireless base station that I switched from B/G mixed mode to
> purely B to try to debug a separate issue with a different device on
> my network. As soon as I did that (and on every subsequent boot), the
> system oopses as soon as it tries to associate. Switching the base
> station back to "mixed" avoids the oops.

Known and fixed. The fix is in the wireless-testing tree, and I just sent
it rebased against 2.6.25-rc3. Please test:
http://marc.info/?l=linux-wireless&m=120445495012387&w=2


--
Ciao
Stefano


From samuel at slbdata.se  Mon Mar  3 01:02:43 2008
From: samuel at slbdata.se (Samuel =?ISO-8859-1?Q?Lid=E9n?= Borell)
Date: Mon, 03 Mar 2008 01:02:43 +0100
Subject: Hibernate in Kernel 2.6.24.3 with BCM4318
Message-ID: <1204502563.5852.19.camel@crashie>

Hi,

I'm using Linux version 2.6.24.3 with Ubuntu modifications, and I have
some problems with the hibernate functionality. It's gotten much better
since 2.6.24 (it doesn't crash after reboot any longer), but the card
still doesn't work after hibernating and then resuming. I'm using the
4.80.53.0, which AFAIK is the correct one. 

I get these messages from 'dmesg' after resuming (only lines containing
b43 are included):
        [   30.345501] b43-phy0: Broadcom 4318 WLAN found
        [   41.505147] input: b43-phy0 as /devices/virtual/input/input9
        [   42.781607] Registered led device: b43-phy0:radio
        [ 1786.427336] input: b43-phy0 as /devices/virtual/input/input10
        [ 1788.215776] Registered led device: b43-phy0:radio
        [   27.509348] input: b43-phy0 as /devices/virtual/input/input11
        [   27.631654] b43-phy0 ERROR: Microcode not responding
        [   27.631661] b43-phy0 ERROR: You must go to
        http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and
        download the correct firmware (version 4).

This happens on a HP Pavilion dv5062ea. Here's the output from lspci:
http://launchpadlibrarian.net/12335793/lspci.txt

Of course the card works well before hibernating.

Kind regards,
Samuel Lid?n Borell



From fxschauber at gmail.com  Mon Mar  3 12:20:52 2008
From: fxschauber at gmail.com (Francois Schauber)
Date: Mon, 3 Mar 2008 12:20:52 +0100
Subject: b4306 issues with b43legacy
Message-ID: <79a239460803030320t4c3d79a5x27186da45dbb570c@mail.gmail.com>

Hi,

I'm working on a Efika powerpc card with a pci WMP54G card (BCM 4306)j. I
tried the 3 kernel drivers (b43xx, b43 & b43legacy). Only the b43legacy one
seems to work with my card.

lspci -vn :

00:18.0 0280: 14e4:4320 (rev 02)
        Subsystem: 1737:0013
        Flags: bus master, fast devsel, latency 0, IRQ 16
        Memory at 80000000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: [40] Power Management version 2

modprobe b43legacy :

b43legacy-phy0: Broadcom 4306 WLAN found

dmesg :
b43legacy-phy0: Broadcom 4306 WLAN found
b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
b43legacy-phy0 debug: Radio initialized
phy0: Selected rate control algorithm 'simple'


ifconfig :

wlan0     Link encap:Ethernet  HWaddr 00:0C:41:13:89:28
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

wmaster0  Link encap:UNSPEC  HWaddr 00-0C-41-13-89-28-10-0D-00-00
-00-00-00-00-00-00
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)


iwconfig :

lo        no wireless extensions.

eth0      no wireless extensions.

dummy0    no wireless extensions.

tunl0     no wireless extensions.

gre0      no wireless extensions.

wmaster0  no wireless extensions.

Warning: Driver for device wlan0 has been compiled with version 22
of Wireless Extension, while this program supports up to version 20.
Some things may be broken...

wlan0     IEEE 802.11g  ESSID:""
          Mode:Managed  Channel:0  Access Point: Not-Associated
          Tx-Power=0 dBm
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


I also put the V3 firmware on /lib/firmware with b43-fwcutter  but it seems
not to be found, when i try an ifconfig wlan0 up dmesg gives me :

b43legacy-phy0 ERROR: Firmware file "b43legacy/ucode4.fw" not found or load
failed.
b43legacy-phy0 ERROR: You must go to
http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and download
the correct firmware (version 3).

I also tried to put it on /lib/hotplug/firmware,  /usr/lib/firmware,
/usr/lib/hotplug/firmware  and it's juste the same !

Someone to help ?
thx,
Francois
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080303/b14039e1/attachment.html>

From netrolller.3d at gmail.com  Tue Mar  4 00:01:05 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 4 Mar 2008 00:01:05 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
Message-ID: <69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>

Hi all and let me repost my previous question (with a few updates) as I got
no answer for it:

I have a strange problem with my Asus WL-138G V2 (which is AFAIK a BCM4318
non-E card). It works fine with bcm43xx (since 2.6.22, works with 2.6.24's
bcm43xx too), but not with b43. I can scan without problems (iwlist scan
works, knetworkmanager lists networks properly), monitor mode works with
kismet (both on main interface and on a dedicated rfmon interface), but I
can't associate (authenticate timeout). Radiotap injection also doesn't
work, packetspammer doesn't complain about errors, but there is nothing
actually sent out. Basically, anything that involves transmitting is broken,
while receiving works fine.
I have tried with the following kernel+firmware combos (all 2.6.24 kernels
were opensuse-pae, while the 2.6.24.1 one was opensuse-default, tried
2.6.25-rc3 in both vanilla and opensuse-pae flavors since my previous post,
neither worked):
-kernel 2.6.24+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.150.10.5 "wl_apsta_mimo.o"
-kernel 2.6.25-rc3 (vanilla and opensuse-pae+firmware 4.80.53 "wl_apsta.o"
 All produced the same error.
I will post my dmesg output if needed, but I can see no error messages from
the driver in it (even though I have enabled b43 and mac80211 debugging in
the compat-wireless config.mk file), only a message about "authentication
timed out". The message is the same for unencrypted, WEP104 open and
WPA-PSK. I haven't tested WPA-EAP and WPA2-EAP as I don't have the needed
hardware (no RADIUS), but I can test WEP40 open, WEP shared (both 40 and
104), 802.1X, WPA2-PSK and mixed-mode (v1+v2) WPA-PSK. (It might be
interesting that while bcm43xx reported by card power levels as 15dBm,
2.6.24(.1)'s b43 (just like 2.6.25-rc3's one) reports it as 27dBm (which is
IMHO a bit high, as that would be 400mW, while the card has an output of
about 20mW - again, bcm43xx reports it as 15dBm!), and compat-wireless-2.6's
b43 reports 0dBm, yes, 0dBm. That's quite odd. But it appears that
compat-wireless-2.6 is right about the transmit power. :-)
Is this a known bug? What can I do about it?
Thanks,
.NetRolller 3D

P.S. Please answer, I don't want to repost again!
-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080304/c1d8d07e/attachment.html>

From netrolller.3d at gmail.com  Tue Mar  4 00:01:05 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 4 Mar 2008 00:01:05 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
Message-ID: <69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>

Hi all and let me repost my previous question (with a few updates) as I got
no answer for it:

I have a strange problem with my Asus WL-138G V2 (which is AFAIK a BCM4318
non-E card). It works fine with bcm43xx (since 2.6.22, works with 2.6.24's
bcm43xx too), but not with b43. I can scan without problems (iwlist scan
works, knetworkmanager lists networks properly), monitor mode works with
kismet (both on main interface and on a dedicated rfmon interface), but I
can't associate (authenticate timeout). Radiotap injection also doesn't
work, packetspammer doesn't complain about errors, but there is nothing
actually sent out. Basically, anything that involves transmitting is broken,
while receiving works fine.
I have tried with the following kernel+firmware combos (all 2.6.24 kernels
were opensuse-pae, while the 2.6.24.1 one was opensuse-default, tried
2.6.25-rc3 in both vanilla and opensuse-pae flavors since my previous post,
neither worked):
-kernel 2.6.24+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.150.10.5 "wl_apsta_mimo.o"
-kernel 2.6.25-rc3 (vanilla and opensuse-pae+firmware 4.80.53 "wl_apsta.o"
 All produced the same error.
I will post my dmesg output if needed, but I can see no error messages from
the driver in it (even though I have enabled b43 and mac80211 debugging in
the compat-wireless config.mk file), only a message about "authentication
timed out". The message is the same for unencrypted, WEP104 open and
WPA-PSK. I haven't tested WPA-EAP and WPA2-EAP as I don't have the needed
hardware (no RADIUS), but I can test WEP40 open, WEP shared (both 40 and
104), 802.1X, WPA2-PSK and mixed-mode (v1+v2) WPA-PSK. (It might be
interesting that while bcm43xx reported by card power levels as 15dBm,
2.6.24(.1)'s b43 (just like 2.6.25-rc3's one) reports it as 27dBm (which is
IMHO a bit high, as that would be 400mW, while the card has an output of
about 20mW - again, bcm43xx reports it as 15dBm!), and compat-wireless-2.6's
b43 reports 0dBm, yes, 0dBm. That's quite odd. But it appears that
compat-wireless-2.6 is right about the transmit power. :-)
Is this a known bug? What can I do about it?
Thanks,
.NetRolller 3D

P.S. Please answer, I don't want to repost again!
-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080304/c1d8d07e/attachment-0001.html>

From netrolller.3d at gmail.com  Tue Mar  4 00:04:31 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 4 Mar 2008 00:04:31 +0100
Subject: Fwd: b4306 issues with b43legacy
In-Reply-To: <69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
References: <79a239460803030320t4c3d79a5x27186da45dbb570c@mail.gmail.com>
	<69e28c910803031339r736ea91fk719fe13f5d1aa2d5@mail.gmail.com>
	<79a239460803031359q556390cjacf33d2d7f76c0c3@mail.gmail.com>
	<69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
Message-ID: <69e28c910803031504j25a608aw68b1da1cac9c5058@mail.gmail.com>

I accidentally sent this message to Francois directly, rather than the
mailing list. Here is it reposted on the list. (I don't know how "That cle"
got in the message.)

---------- Forwarded message ----------
From: Stefanik G?bor <netrolller.3d at gmail.com>
Date: Mon, Mar 3, 2008 at 11:50 PM
Subject: Re: b4306 issues with b43legacy
To: Francois Schauber <fxschauber at gmail.com>


Try extracting to /lib/firmware/`uname -r` (cd there to see if it exists, if
not, mkdir it - it will not actually be called "`uname -r`", but "2.6.24..."
the version of your kernel).  Ubuntu tends to put firmware there. Udev can't
cause "unable to load firmware" errors.

That cle


On Mon, Mar 3, 2008 at 10:59 PM, Francois Schauber <fxschauber at gmail.com>
wrote:

> that's all i'have made, i made test with an other card, a Dlink with RT61
> driver, it's juste the same ! it's not a driver probem, someone told me it
> may be because of udev but i don't know.
>
>
>  2008/3/3, Stefanik G?bor <netrolller.3d at gmail.com>:
>
> > B43legacy is a branch of b43 (not bcm43xx), so you will need
> > b43-fwcutter, not bcm43xx-fwcutter. Same for the regular (non-legacy) b43
> > driver. You need version 3 firmware for b43legacy, and version 4.80 (or
> > 4.150 if you are on a 2.6.25 test kernel) for b43. Use version 011 of
> > the fwcutter.
> >
> > On Mon, Mar 3, 2008 at 12:20 PM, Francois Schauber <fxschauber at gmail.com>
> > wrote:
> >
> > > Hi,
> > >
> > > I'm working on a Efika powerpc card with a pci WMP54G card (BCM
> > > 4306)j. I tried the 3 kernel drivers (b43xx, b43 & b43legacy). Only the
> > > b43legacy one seems to work with my card.
> > >
> > > lspci -vn :
> > >
> > > 00:18.0 0280: 14e4:4320 (rev 02)
> > >         Subsystem: 1737:0013
> > >         Flags: bus master, fast devsel, latency 0, IRQ 16
> > >         Memory at 80000000 (32-bit, non-prefetchable) [size=8K]
> > >         Capabilities: [40] Power Management version 2
> > >
> > > modprobe b43legacy :
> > >
> > > b43legacy-phy0: Broadcom 4306 WLAN found
> > >
> > > dmesg :
> > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
> > > b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050,
> > > Revision 2
> > > b43legacy-phy0 debug: Radio initialized
> > > phy0: Selected rate control algorithm 'simple'
> > >
> > >
> > > ifconfig :
> > >
> > > wlan0     Link encap:Ethernet  HWaddr 00:0C:41:13:89:28
> > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > >           collisions:0 txqueuelen:1000
> > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > >
> > > wmaster0  Link encap:UNSPEC  HWaddr 00-0C-41-13-89-28-10-0D-00-00
> > > -00-00-00-00-00-00
> > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > >           collisions:0 txqueuelen:1000
> > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > >
> > >
> > > iwconfig :
> > >
> > > lo        no wireless extensions.
> > >
> > > eth0      no wireless extensions.
> > >
> > > dummy0    no wireless extensions.
> > >
> > > tunl0     no wireless extensions.
> > >
> > > gre0      no wireless extensions.
> > >
> > > wmaster0  no wireless extensions.
> > >
> > > Warning: Driver for device wlan0 has been compiled with version 22
> > > of Wireless Extension, while this program supports up to version 20.
> > > Some things may be broken...
> > >
> > > wlan0     IEEE 802.11g  ESSID:""
> > >           Mode:Managed  Channel:0  Access Point: Not-Associated
> > >           Tx-Power=0 dBm
> > >           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
> > >           Encryption key:off
> > >           Link Quality:0  Signal level:0  Noise level:0
> > >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> > >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > >
> > >
> > > I also put the V3 firmware on /lib/firmware with b43-fwcutter  but it
> > > seems not to be found, when i try an ifconfig wlan0 up dmesg gives me :
> > >
> > > b43legacy-phy0 ERROR: Firmware file "b43legacy/ucode4.fw" not found or
> > > load failed.
> > > b43legacy-phy0 ERROR: You must go to
> > > http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and
> > > download the correct firmware (version 3).
> > >
> > > I also tried to put it on /lib/hotplug/firmware,  /usr/lib/firmware,
> > > /usr/lib/hotplug/firmware  and it's juste the same !
> > >
> > > Someone to help ?
> > > thx,
> > > Francois
> > >
> > > _______________________________________________
> > > Bcm43xx-dev mailing list
> > > Bcm43xx-dev at lists.berlios.de
> > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > >
> > >
> >
> >
> > --
> > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
>
>


-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080304/639deed1/attachment.html>

From netrolller.3d at gmail.com  Tue Mar  4 00:04:31 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 4 Mar 2008 00:04:31 +0100
Subject: Fwd: b4306 issues with b43legacy
In-Reply-To: <69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
References: <79a239460803030320t4c3d79a5x27186da45dbb570c@mail.gmail.com>
	<69e28c910803031339r736ea91fk719fe13f5d1aa2d5@mail.gmail.com>
	<79a239460803031359q556390cjacf33d2d7f76c0c3@mail.gmail.com>
	<69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
Message-ID: <69e28c910803031504j25a608aw68b1da1cac9c5058@mail.gmail.com>

I accidentally sent this message to Francois directly, rather than the
mailing list. Here is it reposted on the list. (I don't know how "That cle"
got in the message.)

---------- Forwarded message ----------
From: Stefanik G?bor <netrolller.3d at gmail.com>
Date: Mon, Mar 3, 2008 at 11:50 PM
Subject: Re: b4306 issues with b43legacy
To: Francois Schauber <fxschauber at gmail.com>


Try extracting to /lib/firmware/`uname -r` (cd there to see if it exists, if
not, mkdir it - it will not actually be called "`uname -r`", but "2.6.24..."
the version of your kernel).  Ubuntu tends to put firmware there. Udev can't
cause "unable to load firmware" errors.

That cle


On Mon, Mar 3, 2008 at 10:59 PM, Francois Schauber <fxschauber at gmail.com>
wrote:

> that's all i'have made, i made test with an other card, a Dlink with RT61
> driver, it's juste the same ! it's not a driver probem, someone told me it
> may be because of udev but i don't know.
>
>
>  2008/3/3, Stefanik G?bor <netrolller.3d at gmail.com>:
>
> > B43legacy is a branch of b43 (not bcm43xx), so you will need
> > b43-fwcutter, not bcm43xx-fwcutter. Same for the regular (non-legacy) b43
> > driver. You need version 3 firmware for b43legacy, and version 4.80 (or
> > 4.150 if you are on a 2.6.25 test kernel) for b43. Use version 011 of
> > the fwcutter.
> >
> > On Mon, Mar 3, 2008 at 12:20 PM, Francois Schauber <fxschauber at gmail.com>
> > wrote:
> >
> > > Hi,
> > >
> > > I'm working on a Efika powerpc card with a pci WMP54G card (BCM
> > > 4306)j. I tried the 3 kernel drivers (b43xx, b43 & b43legacy). Only the
> > > b43legacy one seems to work with my card.
> > >
> > > lspci -vn :
> > >
> > > 00:18.0 0280: 14e4:4320 (rev 02)
> > >         Subsystem: 1737:0013
> > >         Flags: bus master, fast devsel, latency 0, IRQ 16
> > >         Memory at 80000000 (32-bit, non-prefetchable) [size=8K]
> > >         Capabilities: [40] Power Management version 2
> > >
> > > modprobe b43legacy :
> > >
> > > b43legacy-phy0: Broadcom 4306 WLAN found
> > >
> > > dmesg :
> > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
> > > b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050,
> > > Revision 2
> > > b43legacy-phy0 debug: Radio initialized
> > > phy0: Selected rate control algorithm 'simple'
> > >
> > >
> > > ifconfig :
> > >
> > > wlan0     Link encap:Ethernet  HWaddr 00:0C:41:13:89:28
> > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > >           collisions:0 txqueuelen:1000
> > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > >
> > > wmaster0  Link encap:UNSPEC  HWaddr 00-0C-41-13-89-28-10-0D-00-00
> > > -00-00-00-00-00-00
> > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > >           collisions:0 txqueuelen:1000
> > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > >
> > >
> > > iwconfig :
> > >
> > > lo        no wireless extensions.
> > >
> > > eth0      no wireless extensions.
> > >
> > > dummy0    no wireless extensions.
> > >
> > > tunl0     no wireless extensions.
> > >
> > > gre0      no wireless extensions.
> > >
> > > wmaster0  no wireless extensions.
> > >
> > > Warning: Driver for device wlan0 has been compiled with version 22
> > > of Wireless Extension, while this program supports up to version 20.
> > > Some things may be broken...
> > >
> > > wlan0     IEEE 802.11g  ESSID:""
> > >           Mode:Managed  Channel:0  Access Point: Not-Associated
> > >           Tx-Power=0 dBm
> > >           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
> > >           Encryption key:off
> > >           Link Quality:0  Signal level:0  Noise level:0
> > >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> > >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > >
> > >
> > > I also put the V3 firmware on /lib/firmware with b43-fwcutter  but it
> > > seems not to be found, when i try an ifconfig wlan0 up dmesg gives me :
> > >
> > > b43legacy-phy0 ERROR: Firmware file "b43legacy/ucode4.fw" not found or
> > > load failed.
> > > b43legacy-phy0 ERROR: You must go to
> > > http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and
> > > download the correct firmware (version 3).
> > >
> > > I also tried to put it on /lib/hotplug/firmware,  /usr/lib/firmware,
> > > /usr/lib/hotplug/firmware  and it's juste the same !
> > >
> > > Someone to help ?
> > > thx,
> > > Francois
> > >
> > > _______________________________________________
> > > Bcm43xx-dev mailing list
> > > Bcm43xx-dev at lists.berlios.de
> > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > >
> > >
> >
> >
> > --
> > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
>
>


-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080304/639deed1/attachment-0001.html>

From fxschauber at gmail.com  Tue Mar  4 00:10:41 2008
From: fxschauber at gmail.com (Francois Schauber)
Date: Tue, 4 Mar 2008 00:10:41 +0100
Subject: b4306 issues with b43legacy
In-Reply-To: <69e28c910803031504j25a608aw68b1da1cac9c5058@mail.gmail.com>
References: <79a239460803030320t4c3d79a5x27186da45dbb570c@mail.gmail.com>
	<69e28c910803031339r736ea91fk719fe13f5d1aa2d5@mail.gmail.com>
	<79a239460803031359q556390cjacf33d2d7f76c0c3@mail.gmail.com>
	<69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
	<69e28c910803031504j25a608aw68b1da1cac9c5058@mail.gmail.com>
Message-ID: <79a239460803031510jd5d5203y1e4db76333531cfa@mail.gmail.com>

yep i also tried this one. Is there a way ton know where is looking at ?
Maybe i forgot to install a kernel module, i don't see someone else in the
same case..

2008/3/4, Stefanik G?bor <netrolller.3d at gmail.com>:
>
> I accidentally sent this message to Francois directly, rather than the
> mailing list. Here is it reposted on the list. (I don't know how "That cle"
> got in the message.)
>
> ---------- Forwarded message ----------
> From: Stefanik G?bor <netrolller.3d at gmail.com>
> Date: Mon, Mar 3, 2008 at 11:50 PM
> Subject: Re: b4306 issues with b43legacy
> To: Francois Schauber <fxschauber at gmail.com>
>
>
> Try extracting to /lib/firmware/`uname -r` (cd there to see if it exists,
> if not, mkdir it - it will not actually be called "`uname -r`", but "
> 2.6.24..." the version of your kernel).  Ubuntu tends to put firmware
> there. Udev can't cause "unable to load firmware" errors.
>
> That cle
>
>
> On Mon, Mar 3, 2008 at 10:59 PM, Francois Schauber <fxschauber at gmail.com>
> wrote:
>
> > that's all i'have made, i made test with an other card, a Dlink with
> > RT61 driver, it's juste the same ! it's not a driver probem, someone told me
> > it may be because of udev but i don't know.
> >
> >
> >  2008/3/3, Stefanik G?bor <netrolller.3d at gmail.com>:
> >
> > > B43legacy is a branch of b43 (not bcm43xx), so you will need
> > > b43-fwcutter, not bcm43xx-fwcutter. Same for the regular (non-legacy) b43
> > > driver. You need version 3 firmware for b43legacy, and version 4.80(or
> > > 4.150 if you are on a 2.6.25 test kernel) for b43. Use version 011 of
> > > the fwcutter.
> > >
> > > On Mon, Mar 3, 2008 at 12:20 PM, Francois Schauber <
> > > fxschauber at gmail.com> wrote:
> > >
> > > > Hi,
> > > >
> > > > I'm working on a Efika powerpc card with a pci WMP54G card (BCM
> > > > 4306)j. I tried the 3 kernel drivers (b43xx, b43 & b43legacy). Only the
> > > > b43legacy one seems to work with my card.
> > > >
> > > > lspci -vn :
> > > >
> > > > 00:18.0 0280: 14e4:4320 (rev 02)
> > > >         Subsystem: 1737:0013
> > > >         Flags: bus master, fast devsel, latency 0, IRQ 16
> > > >         Memory at 80000000 (32-bit, non-prefetchable) [size=8K]
> > > >         Capabilities: [40] Power Management version 2
> > > >
> > > > modprobe b43legacy :
> > > >
> > > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > >
> > > > dmesg :
> > > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > > b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
> > > > b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050,
> > > > Revision 2
> > > > b43legacy-phy0 debug: Radio initialized
> > > > phy0: Selected rate control algorithm 'simple'
> > > >
> > > >
> > > > ifconfig :
> > > >
> > > > wlan0     Link encap:Ethernet  HWaddr 00:0C:41:13:89:28
> > > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > > >           collisions:0 txqueuelen:1000
> > > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > > >
> > > > wmaster0  Link encap:UNSPEC  HWaddr 00-0C-41-13-89-28-10-0D-00-00
> > > > -00-00-00-00-00-00
> > > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > > >           collisions:0 txqueuelen:1000
> > > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > > >
> > > >
> > > > iwconfig :
> > > >
> > > > lo        no wireless extensions.
> > > >
> > > > eth0      no wireless extensions.
> > > >
> > > > dummy0    no wireless extensions.
> > > >
> > > > tunl0     no wireless extensions.
> > > >
> > > > gre0      no wireless extensions.
> > > >
> > > > wmaster0  no wireless extensions.
> > > >
> > > > Warning: Driver for device wlan0 has been compiled with version 22
> > > > of Wireless Extension, while this program supports up to version 20.
> > > > Some things may be broken...
> > > >
> > > > wlan0     IEEE 802.11g  ESSID:""
> > > >           Mode:Managed  Channel:0  Access Point: Not-Associated
> > > >           Tx-Power=0 dBm
> > > >           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
> > > >           Encryption key:off
> > > >           Link Quality:0  Signal level:0  Noise level:0
> > > >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> > > >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > > >
> > > >
> > > > I also put the V3 firmware on /lib/firmware with b43-fwcutter  but
> > > > it seems not to be found, when i try an ifconfig wlan0 up dmesg gives me :
> > > >
> > > > b43legacy-phy0 ERROR: Firmware file "b43legacy/ucode4.fw" not found
> > > > or load failed.
> > > > b43legacy-phy0 ERROR: You must go to
> > > > http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and
> > > > download the correct firmware (version 3).
> > > >
> > > > I also tried to put it on /lib/hotplug/firmware,  /usr/lib/firmware,
> > > > /usr/lib/hotplug/firmware  and it's juste the same !
> > > >
> > > > Someone to help ?
> > > > thx,
> > > > Francois
> > > >
> > > > _______________________________________________
> > > > Bcm43xx-dev mailing list
> > > > Bcm43xx-dev at lists.berlios.de
> > > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > > >
> > > >
> > >
> > >
> > > --
> > > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
> >
> >
> >
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080304/c349b820/attachment.html>

From abhijit at deeproot.co.in  Tue Mar  4 06:58:58 2008
From: abhijit at deeproot.co.in (Abhijit Hoskeri)
Date: Tue, 4 Mar 2008 11:28:58 +0530
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
Message-ID: <20080304055858.GA2537@deeproot.co.in>

Hi,

I have a Broadcom 4311 card that ndiswrapper detects and scans but
cannot associate with. The b43 driver that ships with 2.6.24 does not detect
anything at all. However If I patch the kernel with this patch

http://linuxwireless.org/download/b43/patch_2.6.24_for_4311_2

the b43 driver appears to detect the card, find my access point and try
to associate, but then suddenly the wireless LED starts blinking
accompanied by some kernel messages from b43, continiously until I
manage to reboot.

Complete details

lspci output (from a 2.6.24 kernel without the patch):

01:00.0 Network controller: Broadcom Corporation Dell Wireless 1390 WLAN Mini-PCI Card (rev 02)
        Subsystem: Hewlett-Packard Company Unknown device 1375
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR-
        Latency: 0
        Interrupt: pin A routed to IRQ 17
        Region 0: Memory at 91300000 (64-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 3
                Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)
                Status: D0 PME-Enable- DSel=0 DScale=2 PME-
        Capabilities: [58] Vendor Specific Information
        Capabilities: [e8] Message Signalled Interrupts: Mask- 64bit+ Queue=0/0 Enable-
                Address: 0000000000000000  Data: 0000
        Capabilities: [d0] Express Endpoint IRQ 0
                Device: Supported: MaxPayload 128 bytes, PhantFunc 0, ExtTag+
                Device: Latency L0s <4us, L1 unlimited
                Device: AtnBtn- AtnInd- PwrInd-
                Device: Errors: Correctable- Non-Fatal- Fatal- Unsupported-
                Device: RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop-
                Device: MaxPayload 128 bytes, MaxReadReq 128 bytes
                Link: Supported Speed 2.5Gb/s, Width x1, ASPM L0s, Port 0
                Link: Latency L0s <4us, L1 <64us
                Link: ASPM L1 Enabled RCB 64 bytes CommClk+ ExtSynch-
                Link: Speed 2.5Gb/s, Width x1
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel
        Capabilities: [160] Device Serial Number 1a-00-a9-ff-ff-73-be-09
        Capabilities: [16c] Power Budgeting

Kernel logs: (With comments and questions)

kern.info: b43-phy0: Broadcom 4311 WLAN found
kern.info: ACPI: Sleep Button (CM) [SLPB]
kern.info: input: PS/2 Mouse as /class/input/input6
kern.debug: phy0: Selected rate control algorithm 'simple'
kern.info: ACPI: AC Adapter [AC] (on-line)
kern.info: input: Video Bus as /class/input/input7
kern.info: input: AlpsPS/2 ALPS GlidePoint as /class/input/input8
kern.info: ACPI: Video Device [OVGA] (multi-head: yes  rom: no  post: no)
kern.info: iTCO_wdt: Found a ICH8M TCO device (Version=2, TCOBASE=0x0460)
kern.info: iTCO_wdt: initialized. heartbeat=30 sec (nowayout=0)
kern.warn: hda_intel: azx_get_response timeout, switching to polling mode: last cmd=0x011f000c
kern.info: Adding 2097136k swap on /dev/sda2.  Priority:-1 extents:1 across:2097136k
kern.info: device-mapper: uevent: version 1.0.3
kern.info: device-mapper: ioctl: 4.12.0-ioctl (2007-10-02) initialised: dm-devel at redhat.com
kern.notice: ReiserFS: sda3: found reiserfs format "3.6" with standard journal
kern.notice: ReiserFS: sda3: using ordered data mode
kern.notice: ReiserFS: sda3: journal params: device sda3, size 8192, journal first block 18, max trans len 1024, max batch 900, max commit age 30, max trans age 30
kern.notice: ReiserFS: sda3: checking transaction log (sda3)
kern.notice: ReiserFS: sda3: Using r5 hash to sort names
kern.info: eth0: link down
kern.info: input: b43-phy0 as /class/input/input9
kern.info: NET: Registered protocol family 10
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.err: b43-phy0 ERROR: PHY transmission error
kern.info: lo: Disabled Privacy Extensions
kern.info: ADDRCONF(NETDEV_UP): eth0: link is not ready
kern.info: ADDRCONF(NETDEV_UP): wlan0: link is not ready
kern.info: ip_tables: (C) 2000-2006 Netfilter Core Team
kern.warn: nf_conntrack version 0.5.0 (16384 buckets, 65536 max)
kern.debug: wlan0: Initial auth_alg=0
kern.debug: wlan0: authenticate with AP 00:0c:41:0c:2a:d7
kern.debug: wlan0: authenticate with AP 00:0c:41:0c:2a:d7
kern.debug: wlan0: authenticate with AP 00:0c:41:0c:2a:d7
kern.debug: wlan0: authentication with AP 00:0c:41:0c:2a:d7 timed out
kern.debug: wlan0: authentication frame received from 00:0c:41:0c:2a:d7, but not in authenticate state - ignored

# Here it tries to authenticate against my AP, but it times out - how do we
# increase the timeout?

kern.info: b43-phy0: Radio hardware status changed to DISABLED
kern.info: b43-phy0: Radio hardware status changed to ENABLED

# These two are me pressing my wireless button on the laptop

# Here onwards the wireless light starts blinking.. until I panic and reboot

kern.err: b43-phy0 ERROR: Fatal DMA error: 0x00000800, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.info: b43-phy0: Controller RESET (DMA error) ...
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.err: b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.info: b43-phy0: Controller RESET (DMA error) ...
kern.info: b43-phy0: Controller restarted
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.info: b43-phy0: <3>b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.info: b43-phy0: Controller RESET (DMA error) ...
kern.warn: Controller restarted
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.info: b43-phy0: <3>b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.warn: Controller restarted
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.warn: printk: 1 messages suppressed.
kern.info: b43-phy0: Controller restarted
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.info: Registered led device: b43-phy0:tx
kern.info: Registered led device: b43-phy0:rx
kern.info: Registered led device: b43-phy0:radio
kern.warn: printk: 8 messages suppressed.

... and so on.

Thanks for the help...

-Abhijit


From netrolller.3d at gmail.com  Tue Mar  4 17:32:46 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 4 Mar 2008 17:32:46 +0100
Subject: b4306 issues with b43legacy
In-Reply-To: <79a239460803031510jd5d5203y1e4db76333531cfa@mail.gmail.com>
References: <79a239460803030320t4c3d79a5x27186da45dbb570c@mail.gmail.com>
	<69e28c910803031339r736ea91fk719fe13f5d1aa2d5@mail.gmail.com>
	<79a239460803031359q556390cjacf33d2d7f76c0c3@mail.gmail.com>
	<69e28c910803031450q3e3ad11q3a5fe1c18757e341@mail.gmail.com>
	<69e28c910803031504j25a608aw68b1da1cac9c5058@mail.gmail.com>
	<79a239460803031510jd5d5203y1e4db76333531cfa@mail.gmail.com>
Message-ID: <69e28c910803040832g45587c5fh369f85de9ea82431@mail.gmail.com>

It's not a kernel module problem, it's clearly the firmware that is missing.
B43 devs: please help, how does the driver determine the location of
the firmware?

On 3/4/08, Francois Schauber <fxschauber at gmail.com> wrote:
> yep i also tried this one. Is there a way ton know where is looking at ?
> Maybe i forgot to install a kernel module, i don't see someone else in the
> same case..
>
> 2008/3/4, Stefanik G?bor <netrolller.3d at gmail.com>:
> >
> > I accidentally sent this message to Francois directly, rather than the
> > mailing list. Here is it reposted on the list. (I don't know how "That
> cle"
> > got in the message.)
> >
> > ---------- Forwarded message ----------
> > From: Stefanik G?bor <netrolller.3d at gmail.com>
> > Date: Mon, Mar 3, 2008 at 11:50 PM
> > Subject: Re: b4306 issues with b43legacy
> > To: Francois Schauber <fxschauber at gmail.com>
> >
> >
> > Try extracting to /lib/firmware/`uname -r` (cd there to see if it exists,
> > if not, mkdir it - it will not actually be called "`uname -r`", but "
> > 2.6.24..." the version of your kernel).  Ubuntu tends to put firmware
> > there. Udev can't cause "unable to load firmware" errors.
> >
> > That cle
> >
> >
> > On Mon, Mar 3, 2008 at 10:59 PM, Francois Schauber <fxschauber at gmail.com>
> > wrote:
> >
> > > that's all i'have made, i made test with an other card, a Dlink with
> > > RT61 driver, it's juste the same ! it's not a driver probem, someone
> told me
> > > it may be because of udev but i don't know.
> > >
> > >
> > >  2008/3/3, Stefanik G?bor <netrolller.3d at gmail.com>:
> > >
> > > > B43legacy is a branch of b43 (not bcm43xx), so you will need
> > > > b43-fwcutter, not bcm43xx-fwcutter. Same for the regular (non-legacy)
> b43
> > > > driver. You need version 3 firmware for b43legacy, and version
> 4.80(or
> > > > 4.150 if you are on a 2.6.25 test kernel) for b43. Use version 011 of
> > > > the fwcutter.
> > > >
> > > > On Mon, Mar 3, 2008 at 12:20 PM, Francois Schauber <
> > > > fxschauber at gmail.com> wrote:
> > > >
> > > > > Hi,
> > > > >
> > > > > I'm working on a Efika powerpc card with a pci WMP54G card (BCM
> > > > > 4306)j. I tried the 3 kernel drivers (b43xx, b43 & b43legacy). Only
> the
> > > > > b43legacy one seems to work with my card.
> > > > >
> > > > > lspci -vn :
> > > > >
> > > > > 00:18.0 0280: 14e4:4320 (rev 02)
> > > > >         Subsystem: 1737:0013
> > > > >         Flags: bus master, fast devsel, latency 0, IRQ 16
> > > > >         Memory at 80000000 (32-bit, non-prefetchable) [size=8K]
> > > > >         Capabilities: [40] Power Management version 2
> > > > >
> > > > > modprobe b43legacy :
> > > > >
> > > > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > > >
> > > > > dmesg :
> > > > > b43legacy-phy0: Broadcom 4306 WLAN found
> > > > > b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
> > > > > b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050,
> > > > > Revision 2
> > > > > b43legacy-phy0 debug: Radio initialized
> > > > > phy0: Selected rate control algorithm 'simple'
> > > > >
> > > > >
> > > > > ifconfig :
> > > > >
> > > > > wlan0     Link encap:Ethernet  HWaddr 00:0C:41:13:89:28
> > > > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > > > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > > > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > > > >           collisions:0 txqueuelen:1000
> > > > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > > > >
> > > > > wmaster0  Link encap:UNSPEC  HWaddr 00-0C-41-13-89-28-10-0D-00-00
> > > > > -00-00-00-00-00-00
> > > > >           BROADCAST MULTICAST  MTU:1500  Metric:1
> > > > >           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> > > > >           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> > > > >           collisions:0 txqueuelen:1000
> > > > >           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> > > > >
> > > > >
> > > > > iwconfig :
> > > > >
> > > > > lo        no wireless extensions.
> > > > >
> > > > > eth0      no wireless extensions.
> > > > >
> > > > > dummy0    no wireless extensions.
> > > > >
> > > > > tunl0     no wireless extensions.
> > > > >
> > > > > gre0      no wireless extensions.
> > > > >
> > > > > wmaster0  no wireless extensions.
> > > > >
> > > > > Warning: Driver for device wlan0 has been compiled with version 22
> > > > > of Wireless Extension, while this program supports up to version
> 20.
> > > > > Some things may be broken...
> > > > >
> > > > > wlan0     IEEE 802.11g  ESSID:""
> > > > >           Mode:Managed  Channel:0  Access Point: Not-Associated
> > > > >           Tx-Power=0 dBm
> > > > >           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
> > > > >           Encryption key:off
> > > > >           Link Quality:0  Signal level:0  Noise level:0
> > > > >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> > > > >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > > > >
> > > > >
> > > > > I also put the V3 firmware on /lib/firmware with b43-fwcutter  but
> > > > > it seems not to be found, when i try an ifconfig wlan0 up dmesg
> gives me :
> > > > >
> > > > > b43legacy-phy0 ERROR: Firmware file "b43legacy/ucode4.fw" not found
> > > > > or load failed.
> > > > > b43legacy-phy0 ERROR: You must go to
> > > > > http://linuxwireless.org/en/users/Drivers/b43#devicefirmware and
> > > > > download the correct firmware (version 3).
> > > > >
> > > > > I also tried to put it on /lib/hotplug/firmware,
> /usr/lib/firmware,
> > > > > /usr/lib/hotplug/firmware  and it's juste the same !
> > > > >
> > > > > Someone to help ?
> > > > > thx,
> > > > > Francois
> > > > >
> > > > > _______________________________________________
> > > > > Bcm43xx-dev mailing list
> > > > > Bcm43xx-dev at lists.berlios.de
> > > > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > > > >
> > > > >
> > > >
> > > >
> > > > --
> > > > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
> > >
> > >
> > >
> >
> >
> > --
> > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
> >
> >
> >
> > --
> > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
> >
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
> >
>


-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Tue Mar  4 20:31:13 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 4 Mar 2008 20:31:13 +0100
Subject: [PATCH] b43legacy: Fix module init message
Message-ID: <200803042031.13929.mb@bu3sch.de>

This fixes the module init message to tell that the legacy
driver loaded. This makes it less confusing, in case both drivers are loaded.

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c	2008-02-24 14:23:51.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43legacy/main.c	2008-03-04 20:29:32.000000000 +0100
@@ -3870,7 +3870,7 @@ static void b43legacy_print_driverinfo(v
 #ifdef CONFIG_B43LEGACY_DMA
 	feat_dma = "D";
 #endif
-	printk(KERN_INFO "Broadcom 43xx driver loaded "
+	printk(KERN_INFO "Broadcom 43xx-legacy driver loaded "
 	       "[ Features: %s%s%s%s%s, Firmware-ID: "
 	       B43legacy_SUPPORTED_FIRMWARE_ID " ]\n",
 	       feat_pci, feat_leds, feat_rfkill, feat_pio, feat_dma);

-- 
Greetings Michael.


From stefano.brivio at polimi.it  Wed Mar  5 13:56:34 2008
From: stefano.brivio at polimi.it (Stefano Brivio)
Date: Wed, 5 Mar 2008 13:56:34 +0100
Subject: [PATCH] b43legacy: Fix module init message
In-Reply-To: <200803042031.13929.mb@bu3sch.de>
References: <200803042031.13929.mb@bu3sch.de>
Message-ID: <20080305135634.113e7c14@morte>

On Tue, 4 Mar 2008 20:31:13 +0100
Michael Buesch <mb at bu3sch.de> wrote:

> This fixes the module init message to tell that the legacy
> driver loaded. This makes it less confusing, in case both drivers are loaded.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>

Acked-by: Stefano Brivio <stefano.brivio at polimi.it>


--
Ciao
Stefano


From mb at bu3sch.de  Wed Mar  5 21:18:49 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 5 Mar 2008 21:18:49 +0100
Subject: [PATCH] b43: Add QOS support
Message-ID: <200803052118.50458.mb@bu3sch.de>

This adds QOS support to the b43 driver.
QOS can be disabled on driver level with a module parameter for debugging purposes.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-03-05 20:53:21.000000000 +0100
@@ -96,12 +96,14 @@
 #define B43_MMIO_TSF_CFP_START_HIGH	0x606
 #define B43_MMIO_TSF_0			0x632	/* core rev < 3 only */
 #define B43_MMIO_TSF_1			0x634	/* core rev < 3 only */
 #define B43_MMIO_TSF_2			0x636	/* core rev < 3 only */
 #define B43_MMIO_TSF_3			0x638	/* core rev < 3 only */
 #define B43_MMIO_RNG			0x65A
+#define B43_MMIO_IFSCTL			0x688 /* Interframe space control */
+#define  B43_MMIO_IFSCTL_USE_EDCF	0x0004
 #define B43_MMIO_POWERUP_DELAY		0x6A8
 
 /* SPROM boardflags_lo values */
 #define B43_BFL_BTCOEXIST		0x0001	/* implements Bluetooth coexistance */
 #define B43_BFL_PACTRL			0x0002	/* GPIO 9 controlling the PA */
 #define B43_BFL_AIRLINEMODE		0x0004	/* implements GPIO 13 radio disable indication */
@@ -618,12 +620,41 @@ struct b43_key {
 	 * keyconf is a cookie. Don't derefenrence it outside of the set_key
 	 * path, because b43 doesn't own it. */
 	struct ieee80211_key_conf *keyconf;
 	u8 algorithm;
 };
 
+/* SHM offsets to the QOS data structures for the 4 different queues. */
+#define B43_QOS_PARAMS(queue)	(B43_SHM_SH_EDCFQ + \
+				 (B43_NR_QOSPARAMS * sizeof(u16) * (queue)))
+#define B43_QOS_BACKGROUND	B43_QOS_PARAMS(0)
+#define B43_QOS_BESTEFFORT	B43_QOS_PARAMS(1)
+#define B43_QOS_VIDEO		B43_QOS_PARAMS(2)
+#define B43_QOS_VOICE		B43_QOS_PARAMS(3)
+
+/* QOS parameter hardware data structure offsets. */
+#define B43_NR_QOSPARAMS	22
+enum {
+	B43_QOSPARAM_TXOP = 0,
+	B43_QOSPARAM_CWMIN,
+	B43_QOSPARAM_CWMAX,
+	B43_QOSPARAM_CWCUR,
+	B43_QOSPARAM_AIFS,
+	B43_QOSPARAM_BSLOTS,
+	B43_QOSPARAM_REGGAP,
+	B43_QOSPARAM_STATUS,
+};
+
+/* QOS parameters for a queue. */
+struct b43_qos_params {
+	/* The QOS parameters */
+	struct ieee80211_tx_queue_params p;
+	/* Does this need to get uploaded to hardware? */
+	bool need_hw_update;
+};
+
 struct b43_wldev;
 
 /* Data structure for the WLAN parts (802.11 cores) of the b43 chip. */
 struct b43_wl {
 	/* Pointer to the active wireless device on this chip */
 	struct b43_wldev *current_dev;
@@ -670,12 +701,18 @@ struct b43_wl {
 
 	/* The beacon we are currently using (AP or IBSS mode).
 	 * This beacon stuff is protected by the irq_lock. */
 	struct sk_buff *current_beacon;
 	bool beacon0_uploaded;
 	bool beacon1_uploaded;
+
+	/* The current QOS parameters for the 4 queues.
+	 * This is protected by the irq_lock. */
+	struct b43_qos_params qos_params[4];
+	/* Workqueue for updating QOS parameters in hardware. */
+	struct work_struct qos_update_work;
 };
 
 /* In-memory representation of a cached microcode file. */
 struct b43_firmware_file {
 	const char *filename;
 	const struct firmware *data;
Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-05 21:16:28.000000000 +0100
@@ -288,58 +288,12 @@ static inline int request_slot(struct b4
 
 	update_max_used_slots(ring, ring->used_slots);
 
 	return slot;
 }
 
-/* Mac80211-queue to b43-ring mapping */
-static struct b43_dmaring *priority_to_txring(struct b43_wldev *dev,
-					      int queue_priority)
-{
-	struct b43_dmaring *ring;
-
-/*FIXME: For now we always run on TX-ring-1 */
-	return dev->dma.tx_ring1;
-
-	/* 0 = highest priority */
-	switch (queue_priority) {
-	default:
-		B43_WARN_ON(1);
-		/* fallthrough */
-	case 0:
-		ring = dev->dma.tx_ring3;
-		break;
-	case 1:
-		ring = dev->dma.tx_ring2;
-		break;
-	case 2:
-		ring = dev->dma.tx_ring1;
-		break;
-	case 3:
-		ring = dev->dma.tx_ring0;
-		break;
-	}
-
-	return ring;
-}
-
-/* b43-ring to mac80211-queue mapping */
-static inline int txring_to_priority(struct b43_dmaring *ring)
-{
-	static const u8 idx_to_prio[] = { 3, 2, 1, 0, };
-	unsigned int index;
-
-/*FIXME: have only one queue, for now */
-	return 0;
-
-	index = ring->index;
-	if (B43_WARN_ON(index >= ARRAY_SIZE(idx_to_prio)))
-		index = 0;
-	return idx_to_prio[index];
-}
-
 static u16 b43_dmacontroller_base(enum b43_dmatype type, int controller_idx)
 {
 	static const u16 map64[] = {
 		B43_MMIO_DMA64_BASE0,
 		B43_MMIO_DMA64_BASE1,
 		B43_MMIO_DMA64_BASE2,
@@ -1269,12 +1223,43 @@ static inline int should_inject_overflow
 		}
 	}
 #endif /* CONFIG_B43_DEBUG */
 	return 0;
 }
 
+/* Static mapping of mac80211's queues (priorities) to b43 DMA rings. */
+static struct b43_dmaring * select_ring_by_priority(struct b43_wldev *dev,
+						    u8 queue_prio)
+{
+	struct b43_dmaring *ring;
+
+	if (b43_modparam_qos) {
+		/* 0 = highest priority */
+		switch (queue_prio) {
+		default:
+			B43_WARN_ON(1);
+			/* fallthrough */
+		case 0:
+			ring = dev->dma.tx_ring3; /* AC_VO */
+			break;
+		case 1:
+			ring = dev->dma.tx_ring2; /* AC_VI */
+			break;
+		case 2:
+			ring = dev->dma.tx_ring1; /* AC_BE */
+			break;
+		case 3:
+			ring = dev->dma.tx_ring0; /* AC_BK */
+			break;
+		}
+	} else
+		ring = dev->dma.tx_ring1;
+
+	return ring;
+}
+
 int b43_dma_tx(struct b43_wldev *dev,
 	       struct sk_buff *skb, struct ieee80211_tx_control *ctl)
 {
 	struct b43_dmaring *ring;
 	struct ieee80211_hdr *hdr;
 	int err = 0;
@@ -1291,13 +1276,13 @@ int b43_dma_tx(struct b43_wldev *dev,
 		ring = dev->dma.tx_ring4;
 		/* Set the more-data bit. Ucode will clear it on
 		 * the last frame for us. */
 		hdr->frame_control |= cpu_to_le16(IEEE80211_FCTL_MOREDATA);
 	} else {
 		/* Decide by priority where to put this frame. */
-		ring = priority_to_txring(dev, ctl->queue);
+		ring = select_ring_by_priority(dev, ctl->queue);
 	}
 
 	spin_lock_irqsave(&ring->lock, flags);
 	B43_WARN_ON(!ring->tx);
 	if (unlikely(free_slots(ring) < SLOTS_PER_PACKET)) {
 		b43warn(dev->wl, "DMA queue overflow\n");
@@ -1306,12 +1291,17 @@ int b43_dma_tx(struct b43_wldev *dev,
 	}
 	/* Check if the queue was stopped in mac80211,
 	 * but we got called nevertheless.
 	 * That would be a mac80211 bug. */
 	B43_WARN_ON(ring->stopped);
 
+	/* Assign the queue number to the ring (if not already done before)
+	 * so TX status handling can use it. The queue to ring mapping is
+	 * static, so we don't need to store it per frame. */
+	ring->queue_prio = ctl->queue;
+
 	err = dma_tx_fragment(ring, skb, ctl);
 	if (unlikely(err == -ENOKEY)) {
 		/* Drop this packet, as we don't have the encryption key
 		 * anymore and must not transmit it unencrypted. */
 		dev_kfree_skb_any(skb);
 		err = 0;
@@ -1322,13 +1312,13 @@ int b43_dma_tx(struct b43_wldev *dev,
 		goto out_unlock;
 	}
 	ring->nr_tx_packets++;
 	if ((free_slots(ring) < SLOTS_PER_PACKET) ||
 	    should_inject_overflow(ring)) {
 		/* This TX ring is full. */
-		ieee80211_stop_queue(dev->wl->hw, txring_to_priority(ring));
+		ieee80211_stop_queue(dev->wl->hw, ctl->queue);
 		ring->stopped = 1;
 		if (b43_debug(dev, B43_DBG_DMAVERBOSE)) {
 			b43dbg(dev->wl, "Stopped TX ring %d\n", ring->index);
 		}
 	}
 out_unlock:
@@ -1401,13 +1391,13 @@ void b43_dma_handle_txstatus(struct b43_
 			break;
 		slot = next_slot(ring, slot);
 	}
 	dev->stats.last_tx = jiffies;
 	if (ring->stopped) {
 		B43_WARN_ON(free_slots(ring) < SLOTS_PER_PACKET);
-		ieee80211_wake_queue(dev->wl->hw, txring_to_priority(ring));
+		ieee80211_wake_queue(dev->wl->hw, ring->queue_prio);
 		ring->stopped = 0;
 		if (b43_debug(dev, B43_DBG_DMAVERBOSE)) {
 			b43dbg(dev->wl, "Woke up TX ring %d\n", ring->index);
 		}
 	}
 
@@ -1422,13 +1412,13 @@ void b43_dma_get_tx_stats(struct b43_wld
 	struct ieee80211_tx_queue_stats_data *data;
 	unsigned long flags;
 	int i;
 
 	for (i = 0; i < nr_queues; i++) {
 		data = &(stats->data[i]);
-		ring = priority_to_txring(dev, i);
+		ring = select_ring_by_priority(dev, i);
 
 		spin_lock_irqsave(&ring->lock, flags);
 		data->len = ring->used_slots / SLOTS_PER_PACKET;
 		data->limit = ring->nr_slots / SLOTS_PER_PACKET;
 		data->count = ring->nr_tx_packets;
 		spin_unlock_irqrestore(&ring->lock, flags);
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-03-05 20:53:21.000000000 +0100
@@ -75,12 +75,17 @@ module_param_named(hwpctl, modparam_hwpc
 MODULE_PARM_DESC(hwpctl, "Enable hardware-side power control (default off)");
 
 static int modparam_nohwcrypt;
 module_param_named(nohwcrypt, modparam_nohwcrypt, int, 0444);
 MODULE_PARM_DESC(nohwcrypt, "Disable hardware encryption.");
 
+int b43_modparam_qos = 1;
+module_param_named(qos, b43_modparam_qos, int, 0444);
+MODULE_PARM_DESC(qos, "Enable QOS support (default on)");
+
+
 static const struct ssb_device_id b43_ssb_tbl[] = {
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 5),
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 6),
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 7),
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 9),
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 10),
@@ -2705,16 +2710,184 @@ static int b43_op_tx(struct ieee80211_hw
 out:
 	if (unlikely(err))
 		return NETDEV_TX_BUSY;
 	return NETDEV_TX_OK;
 }
 
+/* Locking: wl->irq_lock */
+static void b43_qos_params_upload(struct b43_wldev *dev,
+				  const struct ieee80211_tx_queue_params *p,
+				  u16 shm_offset)
+{
+	u16 params[B43_NR_QOSPARAMS];
+	int cw_min, cw_max, aifs, bslots, tmp;
+	unsigned int i;
+
+	const u16 aCWmin = 0x0001;
+	const u16 aCWmax = 0x03FF;
+
+	/* Calculate the default values for the parameters, if needed. */
+	switch (shm_offset) {
+	case B43_QOS_VOICE:
+		aifs = (p->aifs == -1) ? 2 : p->aifs;
+		cw_min = (p->cw_min == 0) ? ((aCWmin + 1) / 4 - 1) : p->cw_min;
+		cw_max = (p->cw_max == 0) ? ((aCWmin + 1) / 2 - 1) : p->cw_max;
+		break;
+	case B43_QOS_VIDEO:
+		aifs = (p->aifs == -1) ? 2 : p->aifs;
+		cw_min = (p->cw_min == 0) ? ((aCWmin + 1) / 2 - 1) : p->cw_min;
+		cw_max = (p->cw_max == 0) ? aCWmin : p->cw_max;
+		break;
+	case B43_QOS_BESTEFFORT:
+		aifs = (p->aifs == -1) ? 3 : p->aifs;
+		cw_min = (p->cw_min == 0) ? aCWmin : p->cw_min;
+		cw_max = (p->cw_max == 0) ? aCWmax : p->cw_max;
+		break;
+	case B43_QOS_BACKGROUND:
+		aifs = (p->aifs == -1) ? 7 : p->aifs;
+		cw_min = (p->cw_min == 0) ? aCWmin : p->cw_min;
+		cw_max = (p->cw_max == 0) ? aCWmax : p->cw_max;
+		break;
+	default:
+		B43_WARN_ON(1);
+		return;
+	}
+	if (cw_min <= 0)
+		cw_min = aCWmin;
+	if (cw_max <= 0)
+		cw_max = aCWmin;
+	bslots = b43_read16(dev, B43_MMIO_RNG) % cw_min;
+
+	memset(&params, 0, sizeof(params));
+
+	params[B43_QOSPARAM_TXOP] = p->txop * 32;
+	params[B43_QOSPARAM_CWMIN] = cw_min;
+	params[B43_QOSPARAM_CWMAX] = cw_max;
+	params[B43_QOSPARAM_CWCUR] = cw_min;
+	params[B43_QOSPARAM_AIFS] = aifs;
+	params[B43_QOSPARAM_BSLOTS] = bslots;
+	params[B43_QOSPARAM_REGGAP] = bslots + aifs;
+
+	for (i = 0; i < ARRAY_SIZE(params); i++) {
+		if (i == B43_QOSPARAM_STATUS) {
+			tmp = b43_shm_read16(dev, B43_SHM_SHARED,
+					     shm_offset + (i * 2));
+			/* Mark the parameters as updated. */
+			tmp |= 0x100;
+			b43_shm_write16(dev, B43_SHM_SHARED,
+					shm_offset + (i * 2),
+					tmp);
+		} else {
+			b43_shm_write16(dev, B43_SHM_SHARED,
+					shm_offset + (i * 2),
+					params[i]);
+		}
+	}
+}
+
+/* Update the QOS parameters in hardware. */
+static void b43_qos_update(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+	struct b43_qos_params *params;
+	unsigned long flags;
+	unsigned int i;
+
+	/* Mapping of mac80211 queues to b43 SHM offsets. */
+	static const u16 qos_shm_offsets[] = {
+		[0] = B43_QOS_VOICE,
+		[1] = B43_QOS_VIDEO,
+		[2] = B43_QOS_BESTEFFORT,
+		[3] = B43_QOS_BACKGROUND,
+	};
+	BUILD_BUG_ON(ARRAY_SIZE(qos_shm_offsets) != ARRAY_SIZE(wl->qos_params));
+
+	b43_mac_suspend(dev);
+	spin_lock_irqsave(&wl->irq_lock, flags);
+
+	for (i = 0; i < ARRAY_SIZE(wl->qos_params); i++) {
+		params = &(wl->qos_params[i]);
+		if (params->need_hw_update) {
+			b43_qos_params_upload(dev, &(params->p),
+					      qos_shm_offsets[i]);
+			params->need_hw_update = 0;
+		}
+	}
+
+	spin_unlock_irqrestore(&wl->irq_lock, flags);
+	b43_mac_enable(dev);
+}
+
+static void b43_qos_clear(struct b43_wl *wl)
+{
+	struct b43_qos_params *params;
+	unsigned int i;
+
+	for (i = 0; i < ARRAY_SIZE(wl->qos_params); i++) {
+		params = &(wl->qos_params[i]);
+
+		memset(&(params->p), 0, sizeof(params->p));
+		params->p.aifs = -1;
+		params->need_hw_update = 1;
+	}
+}
+
+/* Initialize the core's QOS capabilities */
+static void b43_qos_init(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+	unsigned int i;
+
+	/* Upload the current QOS parameters. */
+	for (i = 0; i < ARRAY_SIZE(wl->qos_params); i++)
+		wl->qos_params[i].need_hw_update = 1;
+	b43_qos_update(dev);
+
+	/* Enable QOS support. */
+	b43_hf_write(dev, b43_hf_read(dev) | B43_HF_EDCF);
+	b43_write16(dev, B43_MMIO_IFSCTL,
+		    b43_read16(dev, B43_MMIO_IFSCTL)
+		    | B43_MMIO_IFSCTL_USE_EDCF);
+}
+
+static void b43_qos_update_work(struct work_struct *work)
+{
+	struct b43_wl *wl = container_of(work, struct b43_wl, qos_update_work);
+	struct b43_wldev *dev;
+
+	mutex_lock(&wl->mutex);
+	dev = wl->current_dev;
+	if (likely(dev && (b43_status(dev) >= B43_STAT_INITIALIZED)))
+		b43_qos_update(dev);
+	mutex_unlock(&wl->mutex);
+}
+
 static int b43_op_conf_tx(struct ieee80211_hw *hw,
-			  int queue,
+			  int _queue,
 			  const struct ieee80211_tx_queue_params *params)
 {
+	struct b43_wl *wl = hw_to_b43_wl(hw);
+	unsigned long flags;
+	unsigned int queue = (unsigned int)_queue;
+	struct b43_qos_params *p;
+
+	if (queue >= ARRAY_SIZE(wl->qos_params)) {
+		/* Queue not available or don't support setting
+		 * params on this queue. Return success to not
+		 * confuse mac80211. */
+		return 0;
+	}
+
+	spin_lock_irqsave(&wl->irq_lock, flags);
+	p = &(wl->qos_params[queue]);
+	memcpy(&(p->p), params, sizeof(p->p));
+	p->need_hw_update = 1;
+	spin_unlock_irqrestore(&wl->irq_lock, flags);
+
+	queue_work(hw->workqueue, &wl->qos_update_work);
+
 	return 0;
 }
 
 static int b43_op_get_tx_stats(struct ieee80211_hw *hw,
 			       struct ieee80211_tx_queue_stats *stats)
 {
@@ -3729,12 +3902,13 @@ static int b43_op_start(struct ieee80211
 	 * the card won't use it in the short timeframe between start
 	 * and mac80211 reconfiguring it. */
 	memset(wl->bssid, 0, ETH_ALEN);
 	memset(wl->mac_addr, 0, ETH_ALEN);
 	wl->filter_flags = 0;
 	wl->radiotap_enabled = 0;
+	b43_qos_clear(wl);
 
 	/* First register RFkill.
 	 * LEDs that are registered later depend on it. */
 	b43_rfkill_init(dev);
 
 	mutex_lock(&wl->mutex);
@@ -3770,12 +3944,13 @@ static int b43_op_start(struct ieee80211
 static void b43_op_stop(struct ieee80211_hw *hw)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
 
 	b43_rfkill_exit(dev);
+	cancel_work_sync(&(wl->qos_update_work));
 
 	mutex_lock(&wl->mutex);
 	if (b43_status(dev) >= B43_STAT_STARTED)
 		b43_wireless_core_stop(dev);
 	b43_wireless_core_exit(dev);
 	mutex_unlock(&wl->mutex);
@@ -4130,13 +4305,13 @@ static int b43_wireless_init(struct ssb_
 	/* fill hw info */
 	hw->flags = IEEE80211_HW_HOST_GEN_BEACON_TEMPLATE |
 		    IEEE80211_HW_RX_INCLUDES_FCS;
 	hw->max_signal = 100;
 	hw->max_rssi = -110;
 	hw->max_noise = -110;
-	hw->queues = 1;		/* FIXME: hardware has more queues */
+	hw->queues = b43_modparam_qos ? 4 : 1;
 	SET_IEEE80211_DEV(hw, dev->dev);
 	if (is_valid_ether_addr(sprom->et1mac))
 		SET_IEEE80211_PERM_ADDR(hw, sprom->et1mac);
 	else
 		SET_IEEE80211_PERM_ADDR(hw, sprom->il0mac);
 
@@ -4146,12 +4321,13 @@ static int b43_wireless_init(struct ssb_
 	wl->hw = hw;
 	spin_lock_init(&wl->irq_lock);
 	spin_lock_init(&wl->leds_lock);
 	spin_lock_init(&wl->shm_lock);
 	mutex_init(&wl->mutex);
 	INIT_LIST_HEAD(&wl->devlist);
+	INIT_WORK(&wl->qos_update_work, b43_qos_update_work);
 
 	ssb_set_devtypedata(dev, wl);
 	b43info(wl, "Broadcom %04X WLAN found\n", dev->bus->chip_id);
 	err = 0;
       out:
 	return err;
Index: wireless-testing/drivers/net/wireless/b43/xmit.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/xmit.c	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/xmit.c	2008-03-05 20:53:21.000000000 +0100
@@ -702,33 +702,6 @@ void b43_tx_suspend(struct b43_wldev *de
 
 /* Resume any TX operation on the device (resume the hardware queues) */
 void b43_tx_resume(struct b43_wldev *dev)
 {
 	b43_dma_tx_resume(dev);
 }
-
-#if 0
-static void upload_qos_parms(struct b43_wldev *dev,
-			     const u16 * parms, u16 offset)
-{
-	int i;
-
-	for (i = 0; i < B43_NR_QOSPARMS; i++) {
-		b43_shm_write16(dev, B43_SHM_SHARED,
-				offset + (i * 2), parms[i]);
-	}
-}
-#endif
-
-/* Initialize the QoS parameters */
-void b43_qos_init(struct b43_wldev *dev)
-{
-	/* FIXME: This function must probably be called from the mac80211
-	 * config callback. */
-	return;
-
-	b43_hf_write(dev, b43_hf_read(dev) | B43_HF_EDCF);
-	//FIXME kill magic
-	b43_write16(dev, 0x688, b43_read16(dev, 0x688) | 0x4);
-
-	/*TODO: We might need some stack support here to get the values. */
-}
Index: wireless-testing/drivers/net/wireless/b43/xmit.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/xmit.h	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/xmit.h	2008-03-05 20:53:21.000000000 +0100
@@ -299,24 +299,12 @@ void b43_handle_txstatus(struct b43_wlde
 void b43_handle_hwtxstatus(struct b43_wldev *dev,
 			   const struct b43_hwtxstatus *hw);
 
 void b43_tx_suspend(struct b43_wldev *dev);
 void b43_tx_resume(struct b43_wldev *dev);
 
-#define B43_NR_QOSPARMS		22
-enum {
-	B43_QOSPARM_TXOP = 0,
-	B43_QOSPARM_CWMIN,
-	B43_QOSPARM_CWMAX,
-	B43_QOSPARM_CWCUR,
-	B43_QOSPARM_AIFS,
-	B43_QOSPARM_BSLOTS,
-	B43_QOSPARM_REGGAP,
-	B43_QOSPARM_STATUS,
-};
-void b43_qos_init(struct b43_wldev *dev);
 
 /* Helper functions for converting the key-table index from "firmware-format"
  * to "raw-format" and back. The firmware API changed for this at some revision.
  * We need to account for that here. */
 static inline int b43_new_kidx_api(struct b43_wldev *dev)
 {
Index: wireless-testing/drivers/net/wireless/b43/dma.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.h	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.h	2008-03-05 20:53:21.000000000 +0100
@@ -242,12 +242,15 @@ struct b43_dmaring {
 	/* Boolean. Is this a TX ring? */
 	bool tx;
 	/* The type of DMA engine used. */
 	enum b43_dmatype type;
 	/* Boolean. Is this ring stopped at ieee80211 level? */
 	bool stopped;
+	/* The QOS priority assigned to this ring. Only used for TX rings.
+	 * This is the mac80211 "queue" value. */
+	u8 queue_prio;
 	/* Lock, only used for TX. */
 	spinlock_t lock;
 	struct b43_wldev *dev;
 #ifdef CONFIG_B43_DEBUG
 	/* Maximum number of used slots. */
 	int max_used_slots;
Index: wireless-testing/drivers/net/wireless/b43/main.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.h	2008-03-05 20:53:06.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/main.h	2008-03-05 20:53:21.000000000 +0100
@@ -35,12 +35,16 @@
 
 #define P4D_BYT3S(magic, nr_bytes)	u8 __p4dding##magic[nr_bytes]
 #define P4D_BYTES(line, nr_bytes)	P4D_BYT3S(line, nr_bytes)
 /* Magic helper macro to pad structures. Ignore those above. It's magic. */
 #define PAD_BYTES(nr_bytes)		P4D_BYTES( __LINE__ , (nr_bytes))
 
+
+extern int b43_modparam_qos;
+
+
 /* Lightweight function to convert a frequency (in Mhz) to a channel number. */
 static inline u8 b43_freq_to_channel_5ghz(int freq)
 {
 	return ((freq - 5000) / 5);
 }
 static inline u8 b43_freq_to_channel_2ghz(int freq)


From mb at bu3sch.de  Thu Mar  6 16:32:46 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 6 Mar 2008 16:32:46 +0100
Subject: [PATCH] b43: Rename the DMA ring pointers
Message-ID: <200803061632.46568.mb@bu3sch.de>

Rename the DMA ring pointers to have more descriptive and standard
names. Also remove the 6th unused TX ring. We can add it back later,
if we need it. The unused TX-status rx-ring is also removed, as that's
only used by legacy devices not supported by this driver anyway.

This is no functional change, except less memory allocation for
the removed rings.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-03-06 16:15:23.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-03-06 16:15:24.000000000 +0100
@@ -586,21 +586,19 @@ struct b43_phy {
 	bool phy_locked;
 #endif /* B43_DEBUG */
 };
 
 /* Data structures for DMA transmission, per 80211 core. */
 struct b43_dma {
-	struct b43_dmaring *tx_ring0;
-	struct b43_dmaring *tx_ring1;
-	struct b43_dmaring *tx_ring2;
-	struct b43_dmaring *tx_ring3;
-	struct b43_dmaring *tx_ring4;
-	struct b43_dmaring *tx_ring5;
+	struct b43_dmaring *tx_ring_AC_BK; /* Background */
+	struct b43_dmaring *tx_ring_AC_BE; /* Best Effort */
+	struct b43_dmaring *tx_ring_AC_VI; /* Video */
+	struct b43_dmaring *tx_ring_AC_VO; /* Voice */
+	struct b43_dmaring *tx_ring_mcast; /* Multicast */
 
-	struct b43_dmaring *rx_ring0;
-	struct b43_dmaring *rx_ring3;	/* only available on core.rev < 5 */
+	struct b43_dmaring *rx_ring;
 };
 
 /* Context information for a noise calculation (Link Quality). */
 struct b43_noise_calculation {
 	u8 channel_at_start;
 	bool calculation_running;
Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-06 16:15:23.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-06 16:30:32.000000000 +0100
@@ -876,60 +876,53 @@ struct b43_dmaring *b43_setup_dmaring(st
 	kfree(ring);
 	ring = NULL;
 	goto out;
 }
 
 /* Main cleanup function. */
-static void b43_destroy_dmaring(struct b43_dmaring *ring)
+static void b43_destroy_dmaring(struct b43_dmaring *ring,
+				const char *ringname)
 {
 	if (!ring)
 		return;
 
-	b43dbg(ring->dev->wl, "DMA-%u 0x%04X (%s) max used slots: %d/%d\n",
-	       (unsigned int)(ring->type),
-	       ring->mmio_base,
-	       (ring->tx) ? "TX" : "RX", ring->max_used_slots, ring->nr_slots);
+	b43dbg(ring->dev->wl, "DMA-%u %s max used slots: %d/%d\n",
+	       (unsigned int)(ring->type), ringname,
+	       ring->max_used_slots, ring->nr_slots);
 	/* Device IRQs are disabled prior entering this function,
 	 * so no need to take care of concurrency with rx handler stuff.
 	 */
 	dmacontroller_cleanup(ring);
 	free_all_descbuffers(ring);
 	free_ringmemory(ring);
 
 	kfree(ring->txhdr_cache);
 	kfree(ring->meta);
 	kfree(ring);
 }
 
+#define destroy_ring(dma, ring) do {				\
+	b43_destroy_dmaring((dma)->ring, __stringify(ring));	\
+	(dma)->ring = NULL;					\
+    } while (0)
+
 void b43_dma_free(struct b43_wldev *dev)
 {
 	struct b43_dma *dma = &dev->dma;
 
-	b43_destroy_dmaring(dma->rx_ring3);
-	dma->rx_ring3 = NULL;
-	b43_destroy_dmaring(dma->rx_ring0);
-	dma->rx_ring0 = NULL;
-
-	b43_destroy_dmaring(dma->tx_ring5);
-	dma->tx_ring5 = NULL;
-	b43_destroy_dmaring(dma->tx_ring4);
-	dma->tx_ring4 = NULL;
-	b43_destroy_dmaring(dma->tx_ring3);
-	dma->tx_ring3 = NULL;
-	b43_destroy_dmaring(dma->tx_ring2);
-	dma->tx_ring2 = NULL;
-	b43_destroy_dmaring(dma->tx_ring1);
-	dma->tx_ring1 = NULL;
-	b43_destroy_dmaring(dma->tx_ring0);
-	dma->tx_ring0 = NULL;
+	destroy_ring(dma, rx_ring);
+	destroy_ring(dma, tx_ring_AC_BK);
+	destroy_ring(dma, tx_ring_AC_BE);
+	destroy_ring(dma, tx_ring_AC_VI);
+	destroy_ring(dma, tx_ring_AC_VO);
+	destroy_ring(dma, tx_ring_mcast);
 }
 
 int b43_dma_init(struct b43_wldev *dev)
 {
 	struct b43_dma *dma = &dev->dma;
-	struct b43_dmaring *ring;
 	int err;
 	u64 dmamask;
 	enum b43_dmatype type;
 
 	dmamask = supported_dma_mask(dev);
 	switch (dmamask) {
@@ -953,122 +946,75 @@ int b43_dma_init(struct b43_wldev *dev)
 		       (unsigned int)(dmamask & 0x00000000FFFFFFFFULL));
 		return -EOPNOTSUPP;
 	}
 
 	err = -ENOMEM;
 	/* setup TX DMA channels. */
-	ring = b43_setup_dmaring(dev, 0, 1, type);
-	if (!ring)
+	dma->tx_ring_AC_BK = b43_setup_dmaring(dev, 0, 1, type);
+	if (!dma->tx_ring_AC_BK)
 		goto out;
-	dma->tx_ring0 = ring;
-
-	ring = b43_setup_dmaring(dev, 1, 1, type);
-	if (!ring)
-		goto err_destroy_tx0;
-	dma->tx_ring1 = ring;
 
-	ring = b43_setup_dmaring(dev, 2, 1, type);
-	if (!ring)
-		goto err_destroy_tx1;
-	dma->tx_ring2 = ring;
+	dma->tx_ring_AC_BE = b43_setup_dmaring(dev, 1, 1, type);
+	if (!dma->tx_ring_AC_BE)
+		goto err_destroy_bk;
+
+	dma->tx_ring_AC_VI = b43_setup_dmaring(dev, 2, 1, type);
+	if (!dma->tx_ring_AC_VI)
+		goto err_destroy_be;
+
+	dma->tx_ring_AC_VO = b43_setup_dmaring(dev, 3, 1, type);
+	if (!dma->tx_ring_AC_VO)
+		goto err_destroy_vi;
+
+	dma->tx_ring_mcast = b43_setup_dmaring(dev, 4, 1, type);
+	if (!dma->tx_ring_mcast)
+		goto err_destroy_vo;
+
+	/* setup RX DMA channel. */
+	dma->rx_ring = b43_setup_dmaring(dev, 0, 0, type);
+	if (!dma->rx_ring)
+		goto err_destroy_mcast;
 
-	ring = b43_setup_dmaring(dev, 3, 1, type);
-	if (!ring)
-		goto err_destroy_tx2;
-	dma->tx_ring3 = ring;
-
-	ring = b43_setup_dmaring(dev, 4, 1, type);
-	if (!ring)
-		goto err_destroy_tx3;
-	dma->tx_ring4 = ring;
-
-	ring = b43_setup_dmaring(dev, 5, 1, type);
-	if (!ring)
-		goto err_destroy_tx4;
-	dma->tx_ring5 = ring;
-
-	/* setup RX DMA channels. */
-	ring = b43_setup_dmaring(dev, 0, 0, type);
-	if (!ring)
-		goto err_destroy_tx5;
-	dma->rx_ring0 = ring;
-
-	if (dev->dev->id.revision < 5) {
-		ring = b43_setup_dmaring(dev, 3, 0, type);
-		if (!ring)
-			goto err_destroy_rx0;
-		dma->rx_ring3 = ring;
-	}
+	/* No support for the TX status DMA ring. */
+	B43_WARN_ON(dev->dev->id.revision < 5);
 
 	b43dbg(dev->wl, "%u-bit DMA initialized\n",
 	       (unsigned int)type);
 	err = 0;
-      out:
+out:
 	return err;
 
-      err_destroy_rx0:
-	b43_destroy_dmaring(dma->rx_ring0);
-	dma->rx_ring0 = NULL;
-      err_destroy_tx5:
-	b43_destroy_dmaring(dma->tx_ring5);
-	dma->tx_ring5 = NULL;
-      err_destroy_tx4:
-	b43_destroy_dmaring(dma->tx_ring4);
-	dma->tx_ring4 = NULL;
-      err_destroy_tx3:
-	b43_destroy_dmaring(dma->tx_ring3);
-	dma->tx_ring3 = NULL;
-      err_destroy_tx2:
-	b43_destroy_dmaring(dma->tx_ring2);
-	dma->tx_ring2 = NULL;
-      err_destroy_tx1:
-	b43_destroy_dmaring(dma->tx_ring1);
-	dma->tx_ring1 = NULL;
-      err_destroy_tx0:
-	b43_destroy_dmaring(dma->tx_ring0);
-	dma->tx_ring0 = NULL;
-	goto out;
+err_destroy_mcast:
+	destroy_ring(dma, tx_ring_mcast);
+err_destroy_vo:
+	destroy_ring(dma, tx_ring_AC_VO);
+err_destroy_vi:
+	destroy_ring(dma, tx_ring_AC_VI);
+err_destroy_be:
+	destroy_ring(dma, tx_ring_AC_BE);
+err_destroy_bk:
+	destroy_ring(dma, tx_ring_AC_BK);
+	return err;
 }
 
 /* Generate a cookie for the TX header. */
 static u16 generate_cookie(struct b43_dmaring *ring, int slot)
 {
-	u16 cookie = 0x1000;
+	u16 cookie;
 
 	/* Use the upper 4 bits of the cookie as
 	 * DMA controller ID and store the slot number
 	 * in the lower 12 bits.
 	 * Note that the cookie must never be 0, as this
 	 * is a special value used in RX path.
 	 * It can also not be 0xFFFF because that is special
 	 * for multicast frames.
 	 */
-	switch (ring->index) {
-	case 0:
-		cookie = 0x1000;
-		break;
-	case 1:
-		cookie = 0x2000;
-		break;
-	case 2:
-		cookie = 0x3000;
-		break;
-	case 3:
-		cookie = 0x4000;
-		break;
-	case 4:
-		cookie = 0x5000;
-		break;
-	case 5:
-		cookie = 0x6000;
-		break;
-	default:
-		B43_WARN_ON(1);
-	}
+	cookie = (((u16)ring->index + 1) << 12);
 	B43_WARN_ON(slot & ~0x0FFF);
-	cookie |= (u16) slot;
+	cookie |= (u16)slot;
 
 	return cookie;
 }
 
 /* Inspect a cookie and find out to which controller/slot it belongs. */
 static
@@ -1076,28 +1022,25 @@ struct b43_dmaring *parse_cookie(struct 
 {
 	struct b43_dma *dma = &dev->dma;
 	struct b43_dmaring *ring = NULL;
 
 	switch (cookie & 0xF000) {
 	case 0x1000:
-		ring = dma->tx_ring0;
+		ring = dma->tx_ring_AC_BK;
 		break;
 	case 0x2000:
-		ring = dma->tx_ring1;
+		ring = dma->tx_ring_AC_BE;
 		break;
 	case 0x3000:
-		ring = dma->tx_ring2;
+		ring = dma->tx_ring_AC_VI;
 		break;
 	case 0x4000:
-		ring = dma->tx_ring3;
+		ring = dma->tx_ring_AC_VO;
 		break;
 	case 0x5000:
-		ring = dma->tx_ring4;
-		break;
-	case 0x6000:
-		ring = dma->tx_ring5;
+		ring = dma->tx_ring_mcast;
 		break;
 	default:
 		B43_WARN_ON(1);
 	}
 	*slot = (cookie & 0x0FFF);
 	B43_WARN_ON(!(ring && *slot >= 0 && *slot < ring->nr_slots));
@@ -1236,26 +1179,26 @@ static struct b43_dmaring * select_ring_
 		/* 0 = highest priority */
 		switch (queue_prio) {
 		default:
 			B43_WARN_ON(1);
 			/* fallthrough */
 		case 0:
-			ring = dev->dma.tx_ring3; /* AC_VO */
+			ring = dev->dma.tx_ring_AC_VO;
 			break;
 		case 1:
-			ring = dev->dma.tx_ring2; /* AC_VI */
+			ring = dev->dma.tx_ring_AC_VI;
 			break;
 		case 2:
-			ring = dev->dma.tx_ring1; /* AC_BE */
+			ring = dev->dma.tx_ring_AC_BE;
 			break;
 		case 3:
-			ring = dev->dma.tx_ring0; /* AC_BK */
+			ring = dev->dma.tx_ring_AC_BK;
 			break;
 		}
 	} else
-		ring = dev->dma.tx_ring1;
+		ring = dev->dma.tx_ring_AC_BE;
 
 	return ring;
 }
 
 int b43_dma_tx(struct b43_wldev *dev,
 	       struct sk_buff *skb, struct ieee80211_tx_control *ctl)
@@ -1270,13 +1213,13 @@ int b43_dma_tx(struct b43_wldev *dev,
 		return -EINVAL;
 	}
 
 	hdr = (struct ieee80211_hdr *)skb->data;
 	if (ctl->flags & IEEE80211_TXCTL_SEND_AFTER_DTIM) {
 		/* The multicast ring will be sent after the DTIM */
-		ring = dev->dma.tx_ring4;
+		ring = dev->dma.tx_ring_mcast;
 		/* Set the more-data bit. Ucode will clear it on
 		 * the last frame for us. */
 		hdr->frame_control |= cpu_to_le16(IEEE80211_FCTL_MOREDATA);
 	} else {
 		/* Decide by priority where to put this frame. */
 		ring = select_ring_by_priority(dev, ctl->queue);
@@ -1438,31 +1381,12 @@ static void dma_rx(struct b43_dmaring *r
 
 	desc = ops->idx2desc(ring, *slot, &meta);
 
 	sync_descbuffer_for_cpu(ring, meta->dmaaddr, ring->rx_buffersize);
 	skb = meta->skb;
 
-	if (ring->index == 3) {
-		/* We received an xmit status. */
-		struct b43_hwtxstatus *hw = (struct b43_hwtxstatus *)skb->data;
-		int i = 0;
-
-		while (hw->cookie == 0) {
-			if (i > 100)
-				break;
-			i++;
-			udelay(2);
-			barrier();
-		}
-		b43_handle_hwtxstatus(ring->dev, hw);
-		/* recycle the descriptor buffer. */
-		sync_descbuffer_for_device(ring, meta->dmaaddr,
-					   ring->rx_buffersize);
-
-		return;
-	}
 	rxhdr = (struct b43_rxhdr_fw4 *)skb->data;
 	len = le16_to_cpu(rxhdr->frame_len);
 	if (len == 0) {
 		int i = 0;
 
 		do {
@@ -1513,13 +1437,13 @@ static void dma_rx(struct b43_dmaring *r
 
 	unmap_descbuffer(ring, dmaaddr, ring->rx_buffersize, 0);
 	skb_put(skb, len + ring->frameoffset);
 	skb_pull(skb, ring->frameoffset);
 
 	b43_rx(ring->dev, skb, rxhdr);
-      drop:
+drop:
 	return;
 }
 
 void b43_dma_rx(struct b43_dmaring *ring)
 {
 	const struct b43_dma_ops *ops = ring->ops;
@@ -1559,24 +1483,22 @@ static void b43_dma_tx_resume_ring(struc
 	spin_unlock_irqrestore(&ring->lock, flags);
 }
 
 void b43_dma_tx_suspend(struct b43_wldev *dev)
 {
 	b43_power_saving_ctl_bits(dev, B43_PS_AWAKE);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring0);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring1);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring2);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring3);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring4);
-	b43_dma_tx_suspend_ring(dev->dma.tx_ring5);
+	b43_dma_tx_suspend_ring(dev->dma.tx_ring_AC_BK);
+	b43_dma_tx_suspend_ring(dev->dma.tx_ring_AC_BE);
+	b43_dma_tx_suspend_ring(dev->dma.tx_ring_AC_VI);
+	b43_dma_tx_suspend_ring(dev->dma.tx_ring_AC_VO);
+	b43_dma_tx_suspend_ring(dev->dma.tx_ring_mcast);
 }
 
 void b43_dma_tx_resume(struct b43_wldev *dev)
 {
-	b43_dma_tx_resume_ring(dev->dma.tx_ring5);
-	b43_dma_tx_resume_ring(dev->dma.tx_ring4);
-	b43_dma_tx_resume_ring(dev->dma.tx_ring3);
-	b43_dma_tx_resume_ring(dev->dma.tx_ring2);
-	b43_dma_tx_resume_ring(dev->dma.tx_ring1);
-	b43_dma_tx_resume_ring(dev->dma.tx_ring0);
+	b43_dma_tx_resume_ring(dev->dma.tx_ring_mcast);
+	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_VO);
+	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_VI);
+	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_BE);
+	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_BK);
 	b43_power_saving_ctl_bits(dev, 0);
 }
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-03-06 16:15:23.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-03-06 16:15:24.000000000 +0100
@@ -1591,17 +1591,16 @@ static void b43_interrupt_tasklet(struct
 		;/* TODO */
 	if (reason & B43_IRQ_NOISESAMPLE_OK)
 		handle_irq_noise(dev);
 
 	/* Check the DMA reason registers for received data. */
 	if (dma_reason[0] & B43_DMAIRQ_RX_DONE)
-		b43_dma_rx(dev->dma.rx_ring0);
-	if (dma_reason[3] & B43_DMAIRQ_RX_DONE)
-		b43_dma_rx(dev->dma.rx_ring3);
+		b43_dma_rx(dev->dma.rx_ring);
 	B43_WARN_ON(dma_reason[1] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[2] & B43_DMAIRQ_RX_DONE);
+	B43_WARN_ON(dma_reason[3] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[4] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[5] & B43_DMAIRQ_RX_DONE);
 
 	if (reason & B43_IRQ_TX_OK)
 		handle_irq_transmit_status(dev);
 


From zajec5polish at gmail.com  Fri Mar  7 14:03:19 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Fri, 7 Mar 2008 14:03:19 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
Message-ID: <14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>

Could we get any word from some developer, please? Does anyone have
any idea, what may be a reason of such a loops?

I would like to be able to give you any more info but have no idea
what more can I do. I just attach part of my /var/log/messages

-- 
Rafa? Mi?ecki
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: 4318.02.disassociate.loop.txt
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080307/58121716/attachment.txt>

From johannes at sipsolutions.net  Fri Mar  7 14:26:22 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 07 Mar 2008 14:26:22 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	(sfid-20080307_130416_724135_BCDA0A61)
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
	<14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	(sfid-20080307_130416_724135_BCDA0A61)
Message-ID: <1204896382.6387.19.camel@johannes.berg>


On Fri, 2008-03-07 at 14:03 +0100, Rafa? Mi?ecki wrote:
> 
> Mar  7 13:23:05 acer kernel: wlan0: associate with AP
> 00:18:39:dd:ee:78
> Mar  7 13:23:05 acer kernel: wlan0: authentication frame received from
> 00:18:39:dd:ee:78, but not in authenticate state - ignored
> Mar  7 13:23:05 acer kernel: wlan0: RX deauthentication from
> 00:18:39:dd:ee:78 (reason=6)

Maybe somebody's trying to hack your network? reason 6 means

WLAN_REASON_CLASS2_FRAME_FROM_NONAUTH_STA

which means: don't send association frames when you're not
authenticated.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080307/71f11463/attachment.pgp>

From zajec5polish at gmail.com  Fri Mar  7 14:45:07 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Fri, 7 Mar 2008 14:45:07 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <69e28c910803070521s653318c6p453fc82e17cc8624@mail.gmail.com>
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
	<14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	<69e28c910803070521s653318c6p453fc82e17cc8624@mail.gmail.com>
Message-ID: <14b026160803070545t695f60e8h3042ff8c907ac6f3@mail.gmail.com>

07-03-08, Stefanik G?bor <netrolller.3d at gmail.com> napisa?(a):
> Just read your log, and it appears that NetworkManager is the source of such
> loops. I noticed such a loop with a Ralink RT73, so it's not driver-related.
> Most likely you are trying to connect to an AP with a tool that circumvents
> Netman, and Netman, seeing that you are connected to an "untrusted network",
> quickly disconnects you, and reinitializes the card. Netman also has a
> tendency to reinitialize cards (to managed mode, channel 0, transmit power
> 0, disassociated state) that it believes to be unused every once a while,
> regardless of other processes using the card (a huge annoyance with Kismet,
> which had to implement a Netman sleep trick to prevent it). But you are
> actually in a state much better than me, as I can't even associate, it just
> times out without any warning, even though I am only 5M away from the AP.

Do you mean NetworkManager by "Netman"? If so I use KNetworkManager to
connect to my AP so I guess there isn't any other tool than
NetworkManager. But on the other hand what you talk has some sense. It
indeed looks like some other tool trying to disconnect me and
reinitialize my card.

Do you think updating NetworkManager to 0.7 may help?

P.S.
Please, add bcm43xx-dev at lists.berlios.de as BB if you write sth that
may be usefull of others :)

-- 
Rafa? Mi?ecki

From zajec5polish at gmail.com  Fri Mar  7 14:48:43 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Fri, 7 Mar 2008 14:48:43 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <1204896382.6387.19.camel@johannes.berg>
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
	<14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	<1204896382.6387.19.camel@johannes.berg>
Message-ID: <14b026160803070548ud33d733rb91517faebe48e48@mail.gmail.com>

2008/3/7, Johannes Berg <johannes at sipsolutions.net>:
>
>  On Fri, 2008-03-07 at 14:03 +0100, Rafa? Mi?ecki wrote:
>  >
>  > Mar  7 13:23:05 acer kernel: wlan0: associate with AP
>  > 00:18:39:dd:ee:78
>  > Mar  7 13:23:05 acer kernel: wlan0: authentication frame received from
>  > 00:18:39:dd:ee:78, but not in authenticate state - ignored
>  > Mar  7 13:23:05 acer kernel: wlan0: RX deauthentication from
>  > 00:18:39:dd:ee:78 (reason=6)
>
>  Maybe somebody's trying to hack your network? reason 6 means
>
>  WLAN_REASON_CLASS2_FRAME_FROM_NONAUTH_STA
>
>  which means: don't send association frames when you're not
>  authenticated.

Well, I can't be 100% sure that there isn't anyone trying to break my
network's security but:
1) I live outside town, there are only a few houses in my neightbour
2) I already had this disassociate problem two weeks ago so I think
noone would try to hack my network for 2 weeks :)


-- 
Rafa? Mi?ecki

From johannes at sipsolutions.net  Fri Mar  7 14:55:31 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 07 Mar 2008 14:55:31 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <14b026160803070548ud33d733rb91517faebe48e48@mail.gmail.com>
	(sfid-20080307_134847_604642_94F99910)
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
	<14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	<1204896382.6387.19.camel@johannes.berg>
	<14b026160803070548ud33d733rb91517faebe48e48@mail.gmail.com>
	(sfid-20080307_134847_604642_94F99910)
Message-ID: <1204898131.6387.21.camel@johannes.berg>


> >  > Mar  7 13:23:05 acer kernel: wlan0: associate with AP
> >  > 00:18:39:dd:ee:78
> >  > Mar  7 13:23:05 acer kernel: wlan0: authentication frame received from
> >  > 00:18:39:dd:ee:78, but not in authenticate state - ignored
> >  > Mar  7 13:23:05 acer kernel: wlan0: RX deauthentication from
> >  > 00:18:39:dd:ee:78 (reason=6)
> >
> >  Maybe somebody's trying to hack your network? reason 6 means
> >
> >  WLAN_REASON_CLASS2_FRAME_FROM_NONAUTH_STA
> >
> >  which means: don't send association frames when you're not
> >  authenticated.
> 
> Well, I can't be 100% sure that there isn't anyone trying to break my
> network's security but:
> 1) I live outside town, there are only a few houses in my neightbour
> 2) I already had this disassociate problem two weeks ago so I think
> noone would try to hack my network for 2 weeks :)

Heh ok. So I guess it's more likely that you're sending those rogue
packets yourself. Do you have a second card and can provide a monitor
dump?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080307/e6ef49c4/attachment.pgp>

From mb at bu3sch.de  Fri Mar  7 15:50:02 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 7 Mar 2008 15:50:02 +0100
Subject: [PATCH] b43: Add TX statistics debugging counters
Message-ID: <200803071550.03185.mb@bu3sch.de>

This adds a few debugging counters, that are useful for debugging the
"card does not transmit" or "connection is unstable" kind of problems.
It's also useful for tuning an RC algorithm.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-06 16:30:32.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-07 15:42:18.000000000 +0100
@@ -35,12 +35,13 @@
 
 #include <linux/dma-mapping.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/skbuff.h>
 #include <linux/etherdevice.h>
+#include <asm/div64.h>
 
 
 /* 32bit DMA ops. */
 static
 struct b43_dmadesc_generic *op32_idx2desc(struct b43_dmaring *ring,
 					  int slot,
@@ -875,22 +876,58 @@ struct b43_dmaring *b43_setup_dmaring(st
       err_kfree_ring:
 	kfree(ring);
 	ring = NULL;
 	goto out;
 }
 
+#define divide(a, b)	({	\
+	typeof(a) __a = a;	\
+	do_div(__a, b);		\
+	__a;			\
+  })
+
+#define modulo(a, b)	({	\
+	typeof(a) __a = a;	\
+	do_div(__a, b);		\
+  })
+
 /* Main cleanup function. */
 static void b43_destroy_dmaring(struct b43_dmaring *ring,
 				const char *ringname)
 {
 	if (!ring)
 		return;
 
-	b43dbg(ring->dev->wl, "DMA-%u %s max used slots: %d/%d\n",
-	       (unsigned int)(ring->type), ringname,
-	       ring->max_used_slots, ring->nr_slots);
+#ifdef CONFIG_B43_DEBUG
+	{
+		/* Print some statistics. */
+		u64 failed_packets = ring->nr_failed_tx_packets;
+		u64 succeed_packets = ring->nr_succeed_tx_packets;
+		u64 nr_packets = failed_packets + succeed_packets;
+		u64 permille_failed = 0, average_tries = 0;
+
+		if (nr_packets)
+			permille_failed = divide(failed_packets * 1000, nr_packets);
+		if (nr_packets)
+			average_tries = divide(ring->nr_total_packet_tries * 100, nr_packets);
+
+		b43dbg(ring->dev->wl, "DMA-%u %s: "
+		       "Used slots %d/%d, Failed frames %llu/%llu = %llu.%01llu%%, "
+		       "Average tries %llu.%02llu\n",
+		       (unsigned int)(ring->type), ringname,
+		       ring->max_used_slots,
+		       ring->nr_slots,
+		       (unsigned long long)failed_packets,
+		       (unsigned long long)succeed_packets,
+		       (unsigned long long)divide(permille_failed, 10),
+		       (unsigned long long)modulo(permille_failed, 10),
+		       (unsigned long long)divide(average_tries, 100),
+		       (unsigned long long)modulo(average_tries, 100));
+	}
+#endif /* DEBUG */
+
 	/* Device IRQs are disabled prior entering this function,
 	 * so no need to take care of concurrency with rx handler stuff.
 	 */
 	dmacontroller_cleanup(ring);
 	free_all_descbuffers(ring);
 	free_ringmemory(ring);
@@ -1267,12 +1304,44 @@ int b43_dma_tx(struct b43_wldev *dev,
 out_unlock:
 	spin_unlock_irqrestore(&ring->lock, flags);
 
 	return err;
 }
 
+static void b43_fill_txstatus_report(struct b43_dmaring *ring,
+				    struct ieee80211_tx_status *report,
+				    const struct b43_txstatus *status)
+{
+	bool frame_failed = 0;
+
+	if (status->acked) {
+		/* The frame was ACKed. */
+		report->flags |= IEEE80211_TX_STATUS_ACK;
+	} else {
+		/* The frame was not ACKed... */
+		if (!(report->control.flags & IEEE80211_TXCTL_NO_ACK)) {
+			/* ...but we expected an ACK. */
+			frame_failed = 1;
+			report->excessive_retries = 1;
+		}
+	}
+	if (status->frame_count == 0) {
+		/* The frame was not transmitted at all. */
+		report->retry_count = 0;
+	} else {
+		report->retry_count = status->frame_count - 1;
+#ifdef CONFIG_B43_DEBUG
+		if (frame_failed)
+			ring->nr_failed_tx_packets++;
+		else
+			ring->nr_succeed_tx_packets++;
+		ring->nr_total_packet_tries += status->frame_count;
+#endif /* DEBUG */
+	}
+}
+
 void b43_dma_handle_txstatus(struct b43_wldev *dev,
 			     const struct b43_txstatus *status)
 {
 	const struct b43_dma_ops *ops;
 	struct b43_dmaring *ring;
 	struct b43_dmadesc_generic *desc;
@@ -1301,24 +1370,13 @@ void b43_dma_handle_txstatus(struct b43_
 		if (meta->is_last_fragment) {
 			B43_WARN_ON(!meta->skb);
 			/* Call back to inform the ieee80211 subsystem about the
 			 * status of the transmission.
 			 * Some fields of txstat are already filled in dma_tx().
 			 */
-			if (status->acked) {
-				meta->txstat.flags |= IEEE80211_TX_STATUS_ACK;
-			} else {
-				if (!(meta->txstat.control.flags
-				      & IEEE80211_TXCTL_NO_ACK))
-					meta->txstat.excessive_retries = 1;
-			}
-			if (status->frame_count == 0) {
-				/* The frame was not transmitted at all. */
-				meta->txstat.retry_count = 0;
-			} else
-				meta->txstat.retry_count = status->frame_count - 1;
+			b43_fill_txstatus_report(ring, &(meta->txstat), status);
 			ieee80211_tx_status_irqsafe(dev->wl->hw, meta->skb,
 						    &(meta->txstat));
 			/* skb is freed by ieee80211_tx_status_irqsafe() */
 			meta->skb = NULL;
 		} else {
 			/* No need to call free_descriptor_buffer here, as
Index: wireless-testing/drivers/net/wireless/b43/dma.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.h	2008-03-06 16:15:23.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.h	2008-03-06 20:09:46.000000000 +0100
@@ -253,13 +253,19 @@ struct b43_dmaring {
 	struct b43_wldev *dev;
 #ifdef CONFIG_B43_DEBUG
 	/* Maximum number of used slots. */
 	int max_used_slots;
 	/* Last time we injected a ring overflow. */
 	unsigned long last_injected_overflow;
-#endif				/* CONFIG_B43_DEBUG */
+	/* Statistics: Number of successfully transmitted packets */
+	u64 nr_succeed_tx_packets;
+	/* Statistics: Number of failed TX packets */
+	u64 nr_failed_tx_packets;
+	/* Statistics: Total number of TX plus all retries. */
+	u64 nr_total_packet_tries;
+#endif /* CONFIG_B43_DEBUG */
 };
 
 static inline u32 b43_dma_read(struct b43_dmaring *ring, u16 offset)
 {
 	return b43_read32(ring->dev, ring->mmio_base + offset);
 }


From zajec5polish at gmail.com  Fri Mar  7 16:09:24 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Fri, 7 Mar 2008 16:09:24 +0100
Subject: powerbook 4306 disassociate/reassociate 'bouncing' with
	b43/2.6.24.x
In-Reply-To: <1204898131.6387.21.camel@johannes.berg>
References: <a4403ff60802270919y22b33d4dv8cade0dd41c76ba3@mail.gmail.com>
	<14b026160803070503p521288edk284de5cf97697c95@mail.gmail.com>
	<1204896382.6387.19.camel@johannes.berg>
	<14b026160803070548ud33d733rb91517faebe48e48@mail.gmail.com>
	<1204898131.6387.21.camel@johannes.berg>
Message-ID: <14b026160803070709qec77e16k2c102eb466af9303@mail.gmail.com>

2008/3/7, Johannes Berg <johannes at sipsolutions.net>:
> Heh ok. So I guess it's more likely that you're sending those rogue
>  packets yourself. Do you have a second card and can provide a monitor
>  dump?

I have Toshiba notebook with
Intel Corporation PRO/Wireless 3945ABG
which works for me with ipw3945 (it doesn't with iwl3945).

I have also Windows XP on this notebook with working wireless.

Will this be enought? If so, can you tell me how can I get some
usefull info for you?

-- 
Rafa? Mi?ecki

From mb at bu3sch.de  Fri Mar  7 19:52:24 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 7 Mar 2008 19:52:24 +0100
Subject: [PATCH] b43: Fix failed frames status report typo
Message-ID: <200803071952.24332.mb@bu3sch.de>

This fixes a typo in the status report.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-07 19:48:55.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-07 19:49:23.000000000 +0100
@@ -914,13 +914,13 @@ static void b43_destroy_dmaring(struct b
 		       "Used slots %d/%d, Failed frames %llu/%llu = %llu.%01llu%%, "
 		       "Average tries %llu.%02llu\n",
 		       (unsigned int)(ring->type), ringname,
 		       ring->max_used_slots,
 		       ring->nr_slots,
 		       (unsigned long long)failed_packets,
-		       (unsigned long long)succeed_packets,
+		       (unsigned long long)nr_packets,
 		       (unsigned long long)divide(permille_failed, 10),
 		       (unsigned long long)modulo(permille_failed, 10),
 		       (unsigned long long)divide(average_tries, 100),
 		       (unsigned long long)modulo(average_tries, 100));
 	}
 #endif /* DEBUG */


From ptrdsnr at googlemail.com  Fri Mar  7 19:57:57 2008
From: ptrdsnr at googlemail.com (Peter Diesner)
Date: Fri, 7 Mar 2008 19:57:57 +0100
Subject: b43 on gutsy using 2.6.24 doesn't work
Message-ID: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>

Hi,
i compiled kernel 2.6.24 with debbuging for b43 enabled:

dmesg | grep b43
[   38.504708] b43-phy0: Broadcom 4311 WLAN found
[   38.544980] b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 8
[   38.545001] b43-phy0 debug: Found Radio: Manuf 0x17F, Version
0x2050, Revision 2
[   73.928683] input: b43-phy0 as /devices/virtual/input/input9
[   74.200180] b43-phy0 debug: Loading firmware version 351.126
(2006-07-29 05:54:02)
[   75.953345] b43-phy0 debug: Chip initialized
[   75.953532] b43-phy0 debug: 32-bit DMA initialized
[   75.973197] Registered led device: b43-phy0:tx
[   75.973216] Registered led device: b43-phy0:rx
[   75.973237] Registered led device: b43-phy0:radio
[   75.973272] b43-phy0 debug: Wireless interface started
[   75.973276] b43-phy0 debug: Adding Interface type 2

Does this help you to analyze the problem ?

Regards

Peter


>  Date: Fri, 22 Feb 2008 12:50:52 +0100
>  From: "Peter Diesner" <ptrdsnr at googlemail.com>
>  Subject: b43 on gutsy using 2.6.24 doesn't work
>  To: bcm43xx-dev at lists.berlios.de
>  Message-ID:
>         <329b1a20802220350x1c272a05kcb7512355870218e at mail.gmail.com>
>  Content-Type: text/plain; charset="iso-8859-1"
>
>  Hi,
>  i just can't get my wlan  work properly  on my extensa 5220.
>  Here's  a bunch of information about my notebook.
>
>  uname -r
>  2.6.24-8-generic
>
>  lspci | grep -i netw
>  04:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan
mini-PCI
>  (rev 01)
>
>
>  dmesg | grep b43
>  [   34.924306] b43-phy0: Broadcom 4311 WLAN found
>  [   40.414718] input: b43-phy0 as /devices/virtual/input/input9
>  [   42.491768] Registered led device: b43-phy0:tx
>  [   42.491789] Registered led device: b43-phy0:rx
>  [   42.491806] Registered led device: b43-phy0:radio
>
>  dmesg | grep -i wlan
>  [   34.924306] b43-phy0: Broadcom 4311 WLAN found
>  [   51.908877] ADDRCONF(NETDEV_UP): wlan0: link is not ready
>
>  ifconfig
>  eth0      Protokoll:Ethernet  Hardware Adresse 00:1D:72:0C:BD:FB
>           inet Adresse:192.168.123.101  Bcast:192.168.123.255  Maske:
>  255.255.255.0
>           inet6 Adresse: fe80::21d:72ff:fe0c:bdfb/64
>  G?ltigkeitsbereich:Verbindung
>           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
>           RX packets:9667 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:5021 errors:0 dropped:0 overruns:0 carrier:0
>           Kollisionen:0 Sendewarteschlangenl?nge:1000
>           RX bytes:12138424 (11.5 MB)  TX bytes:580582 (566.9 KB)
>           Interrupt:16
>
>  lo        Protokoll:Lokale Schleife
>           inet Adresse:127.0.0.1  Maske:255.0.0.0
>           inet6 Adresse: ::1/128 G?ltigkeitsbereich:Maschine
>           UP LOOPBACK RUNNING  MTU:16436  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           Kollisionen:0 Sendewarteschlangenl?nge:0
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
>  wlan0     Protokoll:Ethernet  Hardware Adresse 00:1E:4C:4E:15:14
>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           Kollisionen:0 Sendewarteschlangenl?nge:1000
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
>  wmaster0  Protokoll:UNSPEC  Hardware Adresse
>  00-1E-4C-4E-15-14-00-00-00-00-00-00-00-00-00-00
>           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           Kollisionen:0 Sendewarteschlangenl?nge:1000
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
>
>  iwconfig
>  lo        no wireless extensions.
>
>  eth0      no wireless extensions.
>
>  irda0     no wireless extensions.
>
>  wmaster0  no wireless extensions.
>
>  wlan0     IEEE 802.11g  ESSID:""
>           Mode:Managed  Frequency:2.412 GHz  Access Point: Not-Associated
>           Tx-Power=27 dBm
>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
>           Link Quality:0  Signal level:0  Noise level:0
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
>  sudo iwlist scan
>  lo        Interface doesn't support scanning.
>
>  eth0      Interface doesn't support scanning.
>
>  irda0     Interface doesn't support scanning.
>
>  wmaster0  Interface doesn't support scanning.
>
>  wlan0     Scan completed :
>           Cell 01 - Address: 00:C0:49:E3:59:B6
>                     ESSID:"HONOLULU"
>                     Mode:Master
>                     Channel:8
>                     Frequency:2.447 GHz (Channel 8)
>                     Quality=90/100  Signal level=-45 dBm  Noise level=-67
>  dBm
>                     Encryption key:off
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 22 Mb/s
>                               6 Mb/s; 9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s
>                               36 Mb/s; 48 Mb/s; 54 Mb/s
>                     Extra:tsf=000000b5c96d4121
>
>
>  cat /etc/network/interfaces
>  auto lo
>  iface lo inet loopback
>  address 127.0.0.1
>  netmask 255.0.0.0
>
>  iface wlan0 inet dhcp
>  wireless-rate 11M
>  wireless-essid HONOLULU
>
>
>  cat /etc/udev/rules.d/70-persistent-net.rules
>  # This file maintains persistent names for network interfaces.
>  # See udev(7) for syntax.
>  #
>  # Entries are automatically added by the
75-persistent-net-generator.rules
>  # file; however you are also free to add your own entries.
>
>
>  # PCI device 0x14e4:0x1693 (tg3)
>  SUBSYSTEM=="net", DRIVERS=="?*", ATTRS{address}=="00:1d:72:0c:bd:fb",
>  NAME="eth0"
>
>  # PCI device 0x14e4:0x4311 (b43-pci-bridge)
>  SUBSYSTEM=="net", DRIVERS=="?*", ATTRS{address}=="00:1e:4c:4e:15:14",
>  ATTRS{type}=="1", NAME="wlan0"
>
>
>  sudo dhclient wlan0
>  There is already a pid file /var/run/dhclient.pid with pid 134519120
>  Internet Systems Consortium DHCP Client V3.0.5
>  Copyright 2004-2006 Internet Systems Consortium.
>  All rights reserved.
>  For info, please visit http://www.isc.org/sw/dhcp/
>
>  wmaster0: unknown hardware address type 801
>  wmaster0: unknown hardware address type 801
>  Listening on LPF/wlan0/00:1e:4c:4e:15:14
>  Sending on   LPF/wlan0/00:1e:4c:4e:15:14
>  Sending on   Socket/fallback
>  DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 4
>  DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 10
>  DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 13
>  DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 4
>  No DHCPOFFERS received.
>  No working leases in persistent database - sleeping.
>
>
>
>
>
>  Any ideas, why dhcp doesn't work and what i can do to make it work ?
>
>  Peter
>  -------------- next part --------------
>  An HTML attachment was scrubbed...
>  URL:
https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080222/f752dd36/attachment-0001.html
>
>  ------------------------------
>
>  Message: 2
>  Date: Fri, 22 Feb 2008 14:42:05 +0200
>  From: Alberto Mardegan <mardy at users.sourceforge.net>
>  Subject: Re: b43 on gutsy using 2.6.24 doesn't work
>  To: bcm43xx-dev at lists.berlios.de
>  Message-ID: <47BEC31D.1090804 at users.sourceforge.net>
>  Content-Type: text/plain; charset=ISO-8859-1; format=flowed
>
>  ext Peter Diesner wrote:
>  > Hi,
>  > i just can't get my wlan  work properly  on my extensa 5220.
>  > Here's  a bunch of information about my notebook.
>  [...]
>  > dmesg | grep b43
>  > [   34.924306] b43-phy0: Broadcom 4311 WLAN found
>  > [   40.414718] input: b43-phy0 as /devices/virtual/input/input9
>  > [   42.491768] Registered led device: b43-phy0:tx
>  > [   42.491789] Registered led device: b43-phy0:rx
>  > [   42.491806] Registered led device: b43-phy0:radio
>
>  There is a debug option in the kernel configuration that can be enabled
>  for this module (sorry, I don't remember the name, but it's in the same
>  place as the other b43 related options).
>  That will provide more information.
>
>  Ciao,
>    Alberto
>
>  --
>  http://www.mardy.it <-- Geek in un lingua international!
>
>
>  ------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080307/2b5353f0/attachment.html>

From mb at bu3sch.de  Fri Mar  7 20:14:09 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 7 Mar 2008 20:14:09 +0100
Subject: b43 on gutsy using 2.6.24 doesn't work
In-Reply-To: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>
References: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>
Message-ID: <200803072014.09323.mb@bu3sch.de>

On Friday 07 March 2008 19:57:57 Peter Diesner wrote:
> Hi,
> i compiled kernel 2.6.24 with debbuging for b43 enabled:
> 
> dmesg | grep b43
> [   38.504708] b43-phy0: Broadcom 4311 WLAN found

Use bleeding edge b43.

-- 
Greetings Michael.


From ptrdsnr at googlemail.com  Fri Mar  7 23:21:02 2008
From: ptrdsnr at googlemail.com (Peter Diesner)
Date: Fri, 7 Mar 2008 23:21:02 +0100
Subject: b43 on gutsy using 2.6.24 doesn't work
In-Reply-To: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>
References: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>
Message-ID: <329b1a20803071421m15635fffi52dd5d65867e603@mail.gmail.com>

Hi,
I downloaded, compiled and installed
http://linuxwireless.org/download/compat-wireless-2.6/compat-wireless-2.6.tar.bz2
following the instruction at http://www.linuxwireless.org/en/users/Download.
I also installed the firmware from
http://mirror2.openwrt.org/sources/broadcom-wl-4.150.10.5.tar.bz2

Now dmesg | grep b43 throws the following messages:

[   39.044712] b43: disagrees about version of symbol ssb_device_is_enabled
[   39.044717] b43: Unknown symbol ssb_device_is_enabled
[   39.044857] b43: disagrees about version of symbol
ssb_pcicore_dev_irqvecs_enable
[   39.044859] b43: Unknown symbol ssb_pcicore_dev_irqvecs_enable
[   39.044939] b43: disagrees about version of symbol ssb_bus_may_powerdown
[   39.044941] b43: Unknown symbol ssb_bus_may_powerdown
[   39.045234] b43: disagrees about version of symbol ssb_bus_unregister
[   39.045235] b43: Unknown symbol ssb_bus_unregister
[   39.045385] b43: disagrees about version of symbol ssb_set_devtypedata
[   39.045387] b43: Unknown symbol ssb_set_devtypedata
[   39.045590] b43: disagrees about version of symbol ssb_device_disable
[   39.045591] b43: Unknown symbol ssb_device_disable
[   39.045793] b43: disagrees about version of symbol ssb_dma_set_mask
[   39.045795] b43: Unknown symbol ssb_dma_set_mask
[   39.046052] b43: disagrees about version of symbol ssb_device_enable
[   39.046053] b43: Unknown symbol ssb_device_enable
[   39.046174] b43: disagrees about version of symbol ssb_driver_unregister
[   39.046175] b43: Unknown symbol ssb_driver_unregister
[   39.046302] b43: disagrees about version of symbol __ssb_driver_register
[   39.046303] b43: Unknown symbol __ssb_driver_register
[   39.046562] b43: Unknown symbol ssb_bus_pcmciabus_register
[   39.046638] b43: disagrees about version of symbol ssb_bus_powerup
[   39.046640] b43: Unknown symbol ssb_bus_powerup
[   39.047177] b43: disagrees about version of symbol ssb_dma_translation
[   39.047179] b43: Unknown symbol ssb_dma_translation
[  588.043396] b43: disagrees about version of symbol ssb_device_is_enabled
[  588.043406] b43: Unknown symbol ssb_device_is_enabled
[  588.043562] b43: disagrees about version of symbol
ssb_pcicore_dev_irqvecs_enable
[  588.043564] b43: Unknown symbol ssb_pcicore_dev_irqvecs_enable
[  588.043650] b43: disagrees about version of symbol ssb_bus_may_powerdown
[  588.043652] b43: Unknown symbol ssb_bus_may_powerdown
[  588.043982] b43: disagrees about version of symbol ssb_bus_unregister
[  588.043984] b43: Unknown symbol ssb_bus_unregister
[  588.044150] b43: disagrees about version of symbol ssb_set_devtypedata
[  588.044152] b43: Unknown symbol ssb_set_devtypedata
[  588.044377] b43: disagrees about version of symbol ssb_device_disable
[  588.044378] b43: Unknown symbol ssb_device_disable
[  588.044602] b43: disagrees about version of symbol ssb_dma_set_mask
[  588.044604] b43: Unknown symbol ssb_dma_set_mask
[  588.044877] b43: disagrees about version of symbol ssb_device_enable
[  588.044878] b43: Unknown symbol ssb_device_enable
[  588.045009] b43: disagrees about version of symbol ssb_driver_unregister
[  588.045011] b43: Unknown symbol ssb_driver_unregister
[  588.045153] b43: disagrees about version of symbol __ssb_driver_register
[  588.045155] b43: Unknown symbol __ssb_driver_register
[  588.045444] b43: Unknown symbol ssb_bus_pcmciabus_register
[  588.045531] b43: disagrees about version of symbol ssb_bus_powerup
[  588.045533] b43: Unknown symbol ssb_bus_powerup
[  588.046073] b43: disagrees about version of symbol ssb_dma_translation
[  588.046075] b43: Unknown symbol ssb_dma_translation
[  588.172618] b43legacy: disagrees about version of symbol
ssb_device_is_enabled
[  588.172625] b43legacy: Unknown symbol ssb_device_is_enabled
[  588.172704] b43legacy: disagrees about version of symbol
ssb_pcicore_dev_irqvecs_enable
[  588.172706] b43legacy: Unknown symbol ssb_pcicore_dev_irqvecs_enable
[  588.172803] b43legacy: disagrees about version of symbol
ssb_bus_may_powerdown
[  588.172804] b43legacy: Unknown symbol ssb_bus_may_powerdown
[  588.173125] b43legacy: disagrees about version of symbol
ssb_set_devtypedata
[  588.173127] b43legacy: Unknown symbol ssb_set_devtypedata
[  588.173273] b43legacy: disagrees about version of symbol
ssb_device_disable
[  588.173275] b43legacy: Unknown symbol ssb_device_disable
[  588.173378] b43legacy: disagrees about version of symbol ssb_dma_set_mask
[  588.173379] b43legacy: Unknown symbol ssb_dma_set_mask
[  588.173610] b43legacy: disagrees about version of symbol
ssb_device_enable
[  588.173611] b43legacy: Unknown symbol ssb_device_enable
[  588.173729] b43legacy: disagrees about version of symbol
ssb_driver_unregister
[  588.173730] b43legacy: Unknown symbol ssb_driver_unregister
[  588.173821] b43legacy: disagrees about version of symbol
__ssb_driver_register
[  588.173823] b43legacy: Unknown symbol __ssb_driver_register
[  588.173998] b43legacy: disagrees about version of symbol ssb_bus_powerup
[  588.173999] b43legacy: Unknown symbol ssb_bus_powerup
[  588.174275] b43legacy: disagrees about version of symbol
ssb_dma_translation
[  588.174277] b43legacy: Unknown symbol ssb_dma_translation

Any  advise ?

Regards Peter


2008/3/7, Michael Buesch <mb at bu3sch.de>:
- Zitierten Text ausblenden -
> On Friday 07 March 2008 19:57:57 Peter Diesner wrote:
>  > Hi,
>
> > i compiled kernel 2.6.24 with debbuging for b43 enabled:
>  >
>  > dmesg | grep b43
>  > [   38.504708] b43-phy0: Broadcom 4311 WLAN found
>
>
> Use bleeding edge b43.
>
>
>  --
>  Greetings Michael.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080307/6246c0c8/attachment.html>

From richie at coderworld.net  Sat Mar  8 10:04:11 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Sat, 08 Mar 2008 10:04:11 +0100
Subject: b43 on gutsy using 2.6.24 doesn't work
In-Reply-To: <329b1a20803071421m15635fffi52dd5d65867e603@mail.gmail.com>
References: <329b1a20803071057m70d83893t4eb82ba5a8228ac1@mail.gmail.com>
	<329b1a20803071421m15635fffi52dd5d65867e603@mail.gmail.com>
Message-ID: <47D2568B.6060301@coderworld.net>

Peter Diesner skrev:
> Hi,
> I downloaded, compiled and installed
> http://linuxwireless.org/download/compat-wireless-2.6/compat-wireless-2.6.tar.bz2
> following the instruction at http://www.linuxwireless.org/en/users/Download.
> I also installed the firmware from
> http://mirror2.openwrt.org/sources/broadcom-wl-4.150.10.5.tar.bz2
> 
> Now dmesg | grep b43 throws the following messages:
> 
> [   39.044712] b43: disagrees about version of symbol ssb_device_is_enabled
> [   39.044717] b43: Unknown symbol ssb_device_is_enabled
> [   39.044857] b43: disagrees about version of symbol
> ssb_pcicore_dev_irqvecs_enable
> [   39.044859] b43: Unknown symbol ssb_pcicore_dev_irqvecs_enable
> [   39.044939] b43: disagrees about version of symbol ssb_bus_may_powerdown
> [   39.044941] b43: Unknown symbol ssb_bus_may_powerdown
> [   39.045234] b43: disagrees about version of symbol ssb_bus_unregister
> [   39.045235] b43: Unknown symbol ssb_bus_unregister

Hi Peter,

You probably use a kernel that has the option "Module versioning 
support", CONFIG_MODVERSIONS in .config.
IMHO you need to disable that option to use modules built after the 
kernel, or it will spit out those messages.

hth, Richard


From dragonk at gmail.com  Sat Mar  8 23:48:43 2008
From: dragonk at gmail.com (DragonK)
Date: Sun, 9 Mar 2008 00:48:43 +0200
Subject: bcm 4311 + 2.6.25-rc4 problems
Message-ID: <8fa12ca90803081448i5b71310cm7437383aeabd9384@mail.gmail.com>

Hi,

I'm having problems with my broadcom 4311 card, using the latest
snapshot from the wireless-testing tree; I can't connect to my AP, nor
I see any wireless networks with iwlist scan.

I've used b43-fwcutter 011 and firmware from broadcom-wl-4.150.10.5

Here are my system's details:

# lspci -n -v
...
0b:00.0 0280: 14e4:4311 (rev 01)
        Subsystem: 1028:0007
        Flags: bus master, fast devsel, latency 0, IRQ 16
        Memory at efcfc000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit-
Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint, MSI 00
        Capabilities: [100] Advanced Error Reporting <?>
        Capabilities: [13c] Virtual Channel <?>
        Kernel driver in use: b43-pci-bridge
        Kernel modules: ssb

# uname -a
Linux dell.lan.local 2.6.25-rc4-wl #3 SMP Sun Mar 9 00:22:58 EET 2008
x86_64 Intel(R) Core(TM)2 CPU T7200 @ 2.00GHz GenuineIntel GNU/Linux

# lsmod
Module                  Size  Used by
b43                   174192  0
tun                    13248  0
fuse                   54976  0
arc4                    2496  2
ecb                     4288  2
firmware_class         11328  1 b43
mac80211              154764  1 b43
cfg80211               30800  1 mac80211
firewire_ohci          21952  0
ohci_hcd               28996  0
b44                    31568  0
firewire_core          49504  1 firewire_ohci
led_class               6408  1 b43
crc_itu_t               2624  1 firewire_core
sdhci                  20364  0
ohci1394               41396  0
mmc_core               55264  1 sdhci
mii                     6528  1 b44
ieee1394              106488  1 ohci1394
i2c_i801               11612  0
wmi                     8896  0
i2c_core               28512  1 i2c_i801
ssb                    37956  3 b43,ohci_hcd,b44
rng_core                6024  1 b43
uhci_hcd               27544  0
sr_mod                 18948  0
cdrom                  40424  1 sr_mod

# modinfo b43
filename:
/lib/modules/2.6.25-rc4-wl/kernel/drivers/net/wireless/b43/b43.ko
firmware:       FW13
license:        GPL
author:         Michael Buesch
author:         Stefano Brivio
author:         Martin Langer
description:    Broadcom B43 wireless driver
alias:          ssb:v4243id0812rev0D*
alias:          ssb:v4243id0812rev0B*
alias:          ssb:v4243id0812rev0A*
alias:          ssb:v4243id0812rev09*
alias:          ssb:v4243id0812rev07*
alias:          ssb:v4243id0812rev06*
alias:          ssb:v4243id0812rev05*
depends:        mac80211,ssb,led-class,rng-core,firmware_class
vermagic:       2.6.25-rc4-wl SMP mod_unload
parm:           bad_frames_preempt:enable(1) / disable(0) Bad Frames
Preemption (int)
parm:           fwpostfix:Postfix for the .fw files to load. (string)
parm:           hwpctl:Enable hardware-side power control (default off) (int)
parm:           nohwcrypt:Disable hardware encryption. (int)
parm:           qos:Enable QOS support (default on) (int)


I've attached a copy of the messages in syslog which I got after
inserting the b43 module and trying to connect to the AP a couple of
times.

...
Mar  9 00:29:08 dell eth1: RX authentication from 00:16:b6:d9:7b:6f
(alg=0 transaction=2 status=0)
Mar  9 00:29:08 dell eth1: authenticated
Mar  9 00:29:08 dell eth1: associate with AP 00:16:b6:d9:7b:6f
Mar  9 00:29:08 dell eth1: associate with AP 00:16:b6:d9:7b:6f
Mar  9 00:29:09 dell eth1: associate with AP 00:16:b6:d9:7b:6f
Mar  9 00:29:09 dell eth1: association with AP 00:16:b6:d9:7b:6f timed out
Mar  9 00:29:13 dell eth1: association frame received from
00:16:b6:d9:7b:6f, but not in associate state - ignored
Mar  9 00:29:13 dell eth1: association frame received from
00:16:b6:d9:7b:6f, but not in associate state - ignored
Mar  9 00:29:13 dell eth1: association frame received from
00:16:b6:d9:7b:6f, but not in associate state - ignored
...

What should I understand from this? That my laptop's card receives the
association frame too late, from the AP ?

Scanning for networks is not working either and I know for sure there
are about 5 around my location:

# iwlist eth1 scan
eth1      No scan results


Thanks for any feedback!

PS: I'm not using any encryption at all on my wireless network.

-- 
...it's only a matter of time...
-------------- next part --------------
A non-text attachment was scrubbed...
Name: messages
Type: application/octet-stream
Size: 6606 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080309/46ea271f/attachment.obj>

From ccmcphe at verizon.net  Sun Mar  9 17:28:33 2008
From: ccmcphe at verizon.net (Dad)
Date: Sun, 09 Mar 2008 12:28:33 -0400
Subject: Invalid MAC address with B43 and Broadcom 4318
Message-ID: <47D41031.40904@verizon.net>

I have been trying to use my broadcom 4318. The B43 software finds the 
card I am using but the MAC address is not correct. I am using Ubuntu 
7.10 using the 2.6.22-14 kernel and the compat-wireless-2.6.tar.bz  
wireless distribution, with the broadcom-wl-4.150.10.5 firmware. The 
true MAC address of the card is 00:0B:6B:1D:27:AD and the MAC address 
reported by ifconfig varies each time I try to initialize it. I hope 
someone can help me solve my problem.

 Here is the ifconfig:
wlan0     Link encap:Ethernet  HWaddr 0E:C0:DB:7D:DC:10
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

The kern.log entries are (I built b43 with debug):
Mar  9 12:08:22 ubuntu kernel: [ 2776.884000] pccard: PCMCIA card 
inserted into slot 0
Mar  9 12:08:22 ubuntu kernel: [ 2776.884000] pcmcia: registering new 
device pcmcia0.0
Mar  9 12:08:22 ubuntu kernel: [ 2776.924000] b43-phy3: Broadcom 4318 
WLAN found
Mar  9 12:08:22 ubuntu kernel: [ 2776.972000] phy3: Selected rate 
control algorithm 'pid'
Mar  9 12:08:22 ubuntu kernel: [ 2776.972000] ssb: Sonics Silicon 
Backplane found on PCMCIA device pcmcia0.0
Mar  9 12:08:23 ubuntu kernel: [ 2777.328000] b43-phy3: Loading firmware 
version 410.2160 (2007-05-26 15:32:10)
Mar  9 12:08:24 ubuntu kernel: [ 2778.700000] ADDRCONF(NETDEV_UP): 
wlan0: link is not ready

Here is what lshw sees for the network:
  *-network
       description: 802.11g SC CF
       vendor: Broadcom
       physical id: 0
       version: 4.0
       slot: Socket 0
       resources: irq:3
  *-network
       description: Ethernet interface
       product: 82801CAM (ICH3) PRO/100 VM (KM) Ethernet Controller
       vendor: Intel Corporation
       physical id: 8
       bus info: pci at 0000:02:08.0
       logical name: eth0
       version: 42
       serial: 00:08:02:93:eb:7a
       size: 10MB/s
       capacity: 100MB/s
       width: 32 bits
       clock: 33MHz
       capabilities: pm bus_master cap_list ethernet physical tp mii 
10bt 10bt-fd 100bt 100bt-fd autonegotiation
       configuration: autonegotiation=on broadcast=yes driver=e100 
driverversion=3.5.17-k4-NAPI duplex=half firmware=N/A latency=66 link=no 
maxlatency=56 mingnt=8 module=e100 multicast=yes port=MII speed=10MB/s
  *-network
       description: Wireless interface
       physical id: 2
       logical name: wlan0
       serial: 0e:c0:db:7d:dc:10
       capabilities: ethernet physical wireless
       configuration: broadcast=yes multicast=yes wireless=IEEE 802.11

Thanks for all your help
Tex





From gavron at wetwork.net  Sun Mar  9 17:32:08 2008
From: gavron at wetwork.net (gavron at wetwork.net)
Date: Sun, 09 Mar 2008 09:32:08 -0700
Subject: Invalid MAC address with B43 and Broadcom 4318
In-Reply-To: <47D41031.40904@verizon.net>
References: <47D41031.40904@verizon.net>
Message-ID: <47D41108.7030608@wetwork.net>

Do you have an equivalent of an 
/etc/sysconfig/network-scripts/ifup-wlan0 that has a line that specifies
HWADDR=something?

Ehud

Dad wrote:
> I have been trying to use my broadcom 4318. The B43 software finds the 
> card I am using but the MAC address is not correct. I am using Ubuntu 
> 7.10 using the 2.6.22-14 kernel and the compat-wireless-2.6.tar.bz  
> wireless distribution, with the broadcom-wl-4.150.10.5 firmware. The 
> true MAC address of the card is 00:0B:6B:1D:27:AD and the MAC address 
> reported by ifconfig varies each time I try to initialize it. I hope 
> someone can help me solve my problem.
>
>  Here is the ifconfig:
> wlan0     Link encap:Ethernet  HWaddr 0E:C0:DB:7D:DC:10
>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
> The kern.log entries are (I built b43 with debug):
> Mar  9 12:08:22 ubuntu kernel: [ 2776.884000] pccard: PCMCIA card 
> inserted into slot 0
> Mar  9 12:08:22 ubuntu kernel: [ 2776.884000] pcmcia: registering new 
> device pcmcia0.0
> Mar  9 12:08:22 ubuntu kernel: [ 2776.924000] b43-phy3: Broadcom 4318 
> WLAN found
> Mar  9 12:08:22 ubuntu kernel: [ 2776.972000] phy3: Selected rate 
> control algorithm 'pid'
> Mar  9 12:08:22 ubuntu kernel: [ 2776.972000] ssb: Sonics Silicon 
> Backplane found on PCMCIA device pcmcia0.0
> Mar  9 12:08:23 ubuntu kernel: [ 2777.328000] b43-phy3: Loading firmware 
> version 410.2160 (2007-05-26 15:32:10)
> Mar  9 12:08:24 ubuntu kernel: [ 2778.700000] ADDRCONF(NETDEV_UP): 
> wlan0: link is not ready
>
> Here is what lshw sees for the network:
>   *-network
>        description: 802.11g SC CF
>        vendor: Broadcom
>        physical id: 0
>        version: 4.0
>        slot: Socket 0
>        resources: irq:3
>   *-network
>        description: Ethernet interface
>        product: 82801CAM (ICH3) PRO/100 VM (KM) Ethernet Controller
>        vendor: Intel Corporation
>        physical id: 8
>        bus info: pci at 0000:02:08.0
>        logical name: eth0
>        version: 42
>        serial: 00:08:02:93:eb:7a
>        size: 10MB/s
>        capacity: 100MB/s
>        width: 32 bits
>        clock: 33MHz
>        capabilities: pm bus_master cap_list ethernet physical tp mii 
> 10bt 10bt-fd 100bt 100bt-fd autonegotiation
>        configuration: autonegotiation=on broadcast=yes driver=e100 
> driverversion=3.5.17-k4-NAPI duplex=half firmware=N/A latency=66 link=no 
> maxlatency=56 mingnt=8 module=e100 multicast=yes port=MII speed=10MB/s
>   *-network
>        description: Wireless interface
>        physical id: 2
>        logical name: wlan0
>        serial: 0e:c0:db:7d:dc:10
>        capabilities: ethernet physical wireless
>        configuration: broadcast=yes multicast=yes wireless=IEEE 802.11
>
> Thanks for all your help
> Tex
>
>
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   


From mb at bu3sch.de  Sun Mar  9 18:41:12 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 9 Mar 2008 18:41:12 +0100
Subject: Invalid MAC address with B43 and Broadcom 4318
In-Reply-To: <47D41031.40904@verizon.net>
References: <47D41031.40904@verizon.net>
Message-ID: <200803091841.12396.mb@bu3sch.de>

On Sunday 09 March 2008 17:28:33 Dad wrote:
> Mar  9 12:08:22 ubuntu kernel: [ 2776.972000] ssb: Sonics Silicon 
> Backplane found on PCMCIA device pcmcia0.0

PCMCIA devices are not supported, yet. They don't work, yet.

We don't read the SPROM, but generate a random MAC address.
That's why you see a different MAC address.

-- 
Greetings Michael.


From artem.v.antonov at gmail.com  Sun Mar  9 22:55:31 2008
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Mon, 10 Mar 2008 00:55:31 +0300
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
Message-ID: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>

Hi!
I can't make them work together. I'm using b43 driver from wireless-testing
(+ allow-ap-vlan-modes patch) and hostapd from git.

Here is hostapd log:

STA 00:1b:fc:f2:49:b2 sent probe request for broadcast SSID
MGMT (TX callback) ACK
mgmt::proberesp cb
STA 00:1b:fc:f2:49:b2 sent probe request for broadcast SSID
MGMT (TX callback) ACK
mgmt::proberesp cb
STA 00:1b:fc:f2:49:b2 sent probe request for broadcast SSID
MGMT (TX callback) ACK
mgmt::proberesp cb
STA 00:1b:fc:f2:49:b2 sent probe request for broadcast SSID
MGMT (TX callback) ACK
mgmt::proberesp cb
MGMT
mgmt::deauth
deauthentication: STA=00:1b:fc:f2:49:b2 reason_code=3
Station 00:1b:fc:f2:49:b2 trying to deauthenticate, but it is not
authenticated.

dmesg log:

b43-phy3: Broadcom 4318 WLAN found
b43-phy3 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy3 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
b43-phy3 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
phy3: Selected rate control algorithm 'pid'
Broadcom 43xx driver loaded [ Features: L, Firmware-ID: FW13 ]
b43-phy3: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy3 debug: Chip initialized
b43-phy3 debug: 32-bit DMA initialized
b43-phy3 debug: Wireless interface started
b43-phy3 debug: Adding Interface type 1
b43-phy3 debug: Removing Interface type 1
b43-phy3 debug: Wireless interface stopped
b43-phy3 debug: DMA-32 rx_ring: Used slots 1/64, Failed frames 0/0 = 0.0%,
Average tries 0.00
b43-phy3 debug: DMA-32 tx_ring_AC_BK: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
b43-phy3 debug: DMA-32 tx_ring_AC_BE: Used slots 2/128, Failed frames 0/5 =
0.0%, Average tries 1.80
b43-phy3 debug: DMA-32 tx_ring_AC_VI: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
b43-phy3 debug: DMA-32 tx_ring_AC_VO: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
b43-phy3 debug: DMA-32 tx_ring_mcast: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00

Best regards.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080310/2a06d43e/attachment.html>

From mb at bu3sch.de  Mon Mar 10 17:26:32 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 10 Mar 2008 17:26:32 +0100
Subject: [PATCH] ssb: Add SPROM/invariants support for PCMCIA devices
Message-ID: <200803101726.32658.mb@bu3sch.de>

This adds support for reading/writing the SPROM invariants
for PCMCIA based devices.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.26.


Index: wireless-testing/drivers/ssb/Kconfig
===================================================================
--- wireless-testing.orig/drivers/ssb/Kconfig	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/Kconfig	2008-03-10 17:23:59.000000000 +0100
@@ -17,20 +17,25 @@ config SSB
 	  environments.
 
 	  The module will be called ssb.
 
 	  If unsure, say N.
 
+# Common SPROM support routines
+config SSB_SPROM
+	bool
+
 config SSB_PCIHOST_POSSIBLE
 	bool
 	depends on SSB && (PCI = y || PCI = SSB)
 	default y
 
 config SSB_PCIHOST
 	bool "Support for SSB on PCI-bus host"
 	depends on SSB_PCIHOST_POSSIBLE
+	select SSB_SPROM
 	default y
 	help
 	  Support for a Sonics Silicon Backplane on top
 	  of a PCI device.
 
 	  If unsure, say Y
@@ -45,12 +50,13 @@ config SSB_PCMCIAHOST_POSSIBLE
 	depends on SSB && (PCMCIA = y || PCMCIA = SSB) && EXPERIMENTAL
 	default y
 
 config SSB_PCMCIAHOST
 	bool "Support for SSB on PCMCIA-bus host (EXPERIMENTAL)"
 	depends on SSB_PCMCIAHOST_POSSIBLE
+	select SSB_SPROM
 	help
 	  Support for a Sonics Silicon Backplane on top
 	  of a PCMCIA device.
 
 	  If unsure, say N
 
Index: wireless-testing/drivers/ssb/Makefile
===================================================================
--- wireless-testing.orig/drivers/ssb/Makefile	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/Makefile	2008-03-10 17:15:52.000000000 +0100
@@ -1,9 +1,10 @@
 # core
 ssb-y					+= main.o scan.o
 ssb-$(CONFIG_SSB_EMBEDDED)		+= embedded.o
+ssb-$(CONFIG_SSB_SPROM)			+= sprom.o
 
 # host support
 ssb-$(CONFIG_SSB_PCIHOST)		+= pci.o pcihost_wrapper.o
 ssb-$(CONFIG_SSB_PCMCIAHOST)		+= pcmcia.o
 
 # built-in drivers
Index: wireless-testing/drivers/ssb/main.c
===================================================================
--- wireless-testing.orig/drivers/ssb/main.c	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/main.c	2008-03-10 17:15:52.000000000 +0100
@@ -65,12 +65,31 @@ found:
 	ssb_buses_unlock();
 
 	return bus;
 }
 #endif /* CONFIG_SSB_PCIHOST */
 
+#ifdef CONFIG_SSB_PCMCIAHOST
+struct ssb_bus *ssb_pcmcia_dev_to_bus(struct pcmcia_device *pdev)
+{
+	struct ssb_bus *bus;
+
+	ssb_buses_lock();
+	list_for_each_entry(bus, &buses, list) {
+		if (bus->bustype == SSB_BUSTYPE_PCMCIA &&
+		    bus->host_pcmcia == pdev)
+			goto found;
+	}
+	bus = NULL;
+found:
+	ssb_buses_unlock();
+
+	return bus;
+}
+#endif /* CONFIG_SSB_PCMCIAHOST */
+
 static struct ssb_device *ssb_device_get(struct ssb_device *dev)
 {
 	if (dev)
 		get_device(dev->dev);
 	return dev;
 }
@@ -375,13 +394,13 @@ void ssb_bus_unregister(struct ssb_bus *
 {
 	ssb_buses_lock();
 	ssb_devices_unregister(bus);
 	list_del(&bus->list);
 	ssb_buses_unlock();
 
-	/* ssb_pcmcia_exit(bus); */
+	ssb_pcmcia_exit(bus);
 	ssb_pci_exit(bus);
 	ssb_iounmap(bus);
 }
 EXPORT_SYMBOL(ssb_bus_unregister);
 
 static void ssb_release_dev(struct device *dev)
@@ -640,13 +659,13 @@ static int ssb_bus_register(struct ssb_b
 out:
 	return err;
 
 err_dequeue:
 	list_del(&bus->list);
 err_pcmcia_exit:
-/*	ssb_pcmcia_exit(bus); */
+	ssb_pcmcia_exit(bus);
 err_pci_exit:
 	ssb_pci_exit(bus);
 err_unmap:
 	ssb_iounmap(bus);
 err_disable_xtal:
 	ssb_buses_unlock();
Index: wireless-testing/drivers/ssb/pci.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pci.c	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/pci.c	2008-03-10 17:15:52.000000000 +0100
@@ -224,13 +224,13 @@ static u8 ssb_sprom_crc(const u16 *sprom
 	crc = ssb_crc8(crc, sprom[size - 1] & 0x00FF);
 	crc ^= 0xFF;
 
 	return crc;
 }
 
-static int sprom_check_crc(const u16 *sprom, u16 size)
+static int sprom_check_crc(const u16 *sprom, size_t size)
 {
 	u8 crc;
 	u8 expected_crc;
 	u16 tmp;
 
 	crc = ssb_sprom_crc(sprom, size);
@@ -239,18 +239,20 @@ static int sprom_check_crc(const u16 *sp
 	if (crc != expected_crc)
 		return -EPROTO;
 
 	return 0;
 }
 
-static void sprom_do_read(struct ssb_bus *bus, u16 *sprom)
+static int sprom_do_read(struct ssb_bus *bus, u16 *sprom)
 {
 	int i;
 
 	for (i = 0; i < bus->sprom_size; i++)
 		sprom[i] = ioread16(bus->mmio + SSB_SPROM_BASE + (i * 2));
+
+	return 0;
 }
 
 static int sprom_do_write(struct ssb_bus *bus, const u16 *sprom)
 {
 	struct pci_dev *pdev = bus->host_pci;
 	int i, err;
@@ -657,134 +659,39 @@ const struct ssb_bus_ops ssb_pci_ops = {
 	.read32		= ssb_pci_read32,
 	.write8		= ssb_pci_write8,
 	.write16	= ssb_pci_write16,
 	.write32	= ssb_pci_write32,
 };
 
-static int sprom2hex(const u16 *sprom, char *buf, size_t buf_len, u16 size)
-{
-	int i, pos = 0;
-
-	for (i = 0; i < size; i++)
-		pos += snprintf(buf + pos, buf_len - pos - 1,
-				"%04X", swab16(sprom[i]) & 0xFFFF);
-	pos += snprintf(buf + pos, buf_len - pos - 1, "\n");
-
-	return pos + 1;
-}
-
-static int hex2sprom(u16 *sprom, const char *dump, size_t len, u16 size)
-{
-	char tmp[5] = { 0 };
-	int cnt = 0;
-	unsigned long parsed;
-
-	if (len < size * 2)
-		return -EINVAL;
-
-	while (cnt < size) {
-		memcpy(tmp, dump, 4);
-		dump += 4;
-		parsed = simple_strtoul(tmp, NULL, 16);
-		sprom[cnt++] = swab16((u16)parsed);
-	}
-
-	return 0;
-}
-
 static ssize_t ssb_pci_attr_sprom_show(struct device *pcidev,
 				       struct device_attribute *attr,
 				       char *buf)
 {
 	struct pci_dev *pdev = container_of(pcidev, struct pci_dev, dev);
 	struct ssb_bus *bus;
-	u16 *sprom;
-	int err = -ENODEV;
-	ssize_t count = 0;
 
 	bus = ssb_pci_dev_to_bus(pdev);
 	if (!bus)
-		goto out;
-	err = -ENOMEM;
-	sprom = kcalloc(bus->sprom_size, sizeof(u16), GFP_KERNEL);
-	if (!sprom)
-		goto out;
-
-	/* Use interruptible locking, as the SPROM write might
-	 * be holding the lock for several seconds. So allow userspace
-	 * to cancel operation. */
-	err = -ERESTARTSYS;
-	if (mutex_lock_interruptible(&bus->pci_sprom_mutex))
-		goto out_kfree;
-	sprom_do_read(bus, sprom);
-	mutex_unlock(&bus->pci_sprom_mutex);
+		return -ENODEV;
 
-	count = sprom2hex(sprom, buf, PAGE_SIZE, bus->sprom_size);
-	err = 0;
-
-out_kfree:
-	kfree(sprom);
-out:
-	return err ? err : count;
+	return ssb_attr_sprom_show(bus, buf, sprom_do_read);
 }
 
 static ssize_t ssb_pci_attr_sprom_store(struct device *pcidev,
 					struct device_attribute *attr,
 					const char *buf, size_t count)
 {
 	struct pci_dev *pdev = container_of(pcidev, struct pci_dev, dev);
 	struct ssb_bus *bus;
-	u16 *sprom;
-	int res = 0, err = -ENODEV;
 
 	bus = ssb_pci_dev_to_bus(pdev);
 	if (!bus)
-		goto out;
-	err = -ENOMEM;
-	sprom = kcalloc(bus->sprom_size, sizeof(u16), GFP_KERNEL);
-	if (!sprom)
-		goto out;
-	err = hex2sprom(sprom, buf, count, bus->sprom_size);
-	if (err) {
-		err = -EINVAL;
-		goto out_kfree;
-	}
-	err = sprom_check_crc(sprom, bus->sprom_size);
-	if (err) {
-		err = -EINVAL;
-		goto out_kfree;
-	}
+		return -ENODEV;
 
-	/* Use interruptible locking, as the SPROM write might
-	 * be holding the lock for several seconds. So allow userspace
-	 * to cancel operation. */
-	err = -ERESTARTSYS;
-	if (mutex_lock_interruptible(&bus->pci_sprom_mutex))
-		goto out_kfree;
-	err = ssb_devices_freeze(bus);
-	if (err == -EOPNOTSUPP) {
-		ssb_printk(KERN_ERR PFX "SPROM write: Could not freeze devices. "
-			   "No suspend support. Is CONFIG_PM enabled?\n");
-		goto out_unlock;
-	}
-	if (err) {
-		ssb_printk(KERN_ERR PFX "SPROM write: Could not freeze all devices\n");
-		goto out_unlock;
-	}
-	res = sprom_do_write(bus, sprom);
-	err = ssb_devices_thaw(bus);
-	if (err)
-		ssb_printk(KERN_ERR PFX "SPROM write: Could not thaw all devices\n");
-out_unlock:
-	mutex_unlock(&bus->pci_sprom_mutex);
-out_kfree:
-	kfree(sprom);
-out:
-	if (res)
-		return res;
-	return err ? err : count;
+	return ssb_attr_sprom_store(bus, buf, count,
+				    sprom_check_crc, sprom_do_write);
 }
 
 static DEVICE_ATTR(ssb_sprom, 0600,
 		   ssb_pci_attr_sprom_show,
 		   ssb_pci_attr_sprom_store);
 
@@ -805,13 +712,13 @@ int ssb_pci_init(struct ssb_bus *bus)
 	int err;
 
 	if (bus->bustype != SSB_BUSTYPE_PCI)
 		return 0;
 
 	pdev = bus->host_pci;
-	mutex_init(&bus->pci_sprom_mutex);
+	mutex_init(&bus->sprom_mutex);
 	err = device_create_file(&pdev->dev, &dev_attr_ssb_sprom);
 	if (err)
 		goto out;
 
 out:
 	return err;
Index: wireless-testing/drivers/ssb/pcmcia.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pcmcia.c	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/pcmcia.c	2008-03-10 17:15:52.000000000 +0100
@@ -1,19 +1,20 @@
 /*
  * Sonics Silicon Backplane
  * PCMCIA-Hostbus related functions
  *
  * Copyright 2006 Johannes Berg <johannes at sipsolutions.net>
- * Copyright 2007 Michael Buesch <mb at bu3sch.de>
+ * Copyright 2007-2008 Michael Buesch <mb at bu3sch.de>
  *
  * Licensed under the GNU/GPL. See COPYING for details.
  */
 
 #include <linux/ssb/ssb.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/etherdevice.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/cs.h>
 #include <pcmcia/cistpl.h>
 #include <pcmcia/ciscode.h>
 #include <pcmcia/ds.h>
@@ -23,74 +24,147 @@
 
 
 /* Define the following to 1 to enable a printk on each coreswitch. */
 #define SSB_VERBOSE_PCMCIACORESWITCH_DEBUG		0
 
 
+/* PCMCIA configuration registers */
+#define SSB_PCMCIA_CORECTL		0x00
+#define  SSB_PCMCIA_CORECTL_RESET	0x80 /* Core reset */
+#define  SSB_PCMCIA_CORECTL_IRQEN	0x04 /* IRQ enable */
+#define  SSB_PCMCIA_CORECTL_FUNCEN	0x01 /* Function enable */
+#define SSB_PCMCIA_CORECTL2		0x80
+#define SSB_PCMCIA_ADDRESS0		0x2E
+#define SSB_PCMCIA_ADDRESS1		0x30
+#define SSB_PCMCIA_ADDRESS2		0x32
+#define SSB_PCMCIA_MEMSEG		0x34
+#define SSB_PCMCIA_SPROMCTL		0x36
+#define  SSB_PCMCIA_SPROMCTL_IDLE	0
+#define  SSB_PCMCIA_SPROMCTL_WRITE	1
+#define  SSB_PCMCIA_SPROMCTL_READ	2
+#define  SSB_PCMCIA_SPROMCTL_WRITEEN	4
+#define  SSB_PCMCIA_SPROMCTL_WRITEDIS	7
+#define  SSB_PCMCIA_SPROMCTL_DONE	8
+#define SSB_PCMCIA_SPROM_DATALO		0x38
+#define SSB_PCMCIA_SPROM_DATAHI		0x3A
+#define SSB_PCMCIA_SPROM_ADDRLO		0x3C
+#define SSB_PCMCIA_SPROM_ADDRHI		0x3E
+
+/* Hardware invariants CIS tuples */
+#define SSB_PCMCIA_CIS			0x80
+#define  SSB_PCMCIA_CIS_ID		0x01
+#define  SSB_PCMCIA_CIS_BOARDREV	0x02
+#define  SSB_PCMCIA_CIS_PA		0x03
+#define   SSB_PCMCIA_CIS_PA_PA0B0_LO	0
+#define   SSB_PCMCIA_CIS_PA_PA0B0_HI	1
+#define   SSB_PCMCIA_CIS_PA_PA0B1_LO	2
+#define   SSB_PCMCIA_CIS_PA_PA0B1_HI	3
+#define   SSB_PCMCIA_CIS_PA_PA0B2_LO	4
+#define   SSB_PCMCIA_CIS_PA_PA0B2_HI	5
+#define   SSB_PCMCIA_CIS_PA_ITSSI	6
+#define   SSB_PCMCIA_CIS_PA_MAXPOW	7
+#define  SSB_PCMCIA_CIS_OEMNAME		0x04
+#define  SSB_PCMCIA_CIS_CCODE		0x05
+#define  SSB_PCMCIA_CIS_ANTENNA		0x06
+#define  SSB_PCMCIA_CIS_ANTGAIN		0x07
+#define  SSB_PCMCIA_CIS_BFLAGS		0x08
+#define  SSB_PCMCIA_CIS_LEDS		0x09
+
+/* PCMCIA SPROM size. */
+#define SSB_PCMCIA_SPROM_SIZE		256
+#define SSB_PCMCIA_SPROM_SIZE_BYTES	(SSB_PCMCIA_SPROM_SIZE * sizeof(u16))
+
+
+/* Write to a PCMCIA configuration register. */
+static int ssb_pcmcia_cfg_write(struct ssb_bus *bus, u8 offset, u8 value)
+{
+	conf_reg_t reg;
+	int res;
+
+	memset(&reg, 0, sizeof(reg));
+	reg.Offset = offset;
+	reg.Action = CS_WRITE;
+	reg.Value = value;
+	res = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
+	if (unlikely(res != CS_SUCCESS))
+		return -EBUSY;
+
+	return 0;
+}
+
+/* Read from a PCMCIA configuration register. */
+static int ssb_pcmcia_cfg_read(struct ssb_bus *bus, u8 offset, u8 *value)
+{
+	conf_reg_t reg;
+	int res;
+
+	memset(&reg, 0, sizeof(reg));
+	reg.Offset = offset;
+	reg.Action = CS_READ;
+	res = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
+	if (unlikely(res != CS_SUCCESS))
+		return -EBUSY;
+	*value = reg.Value;
+
+	return 0;
+}
+
 int ssb_pcmcia_switch_coreidx(struct ssb_bus *bus,
 			      u8 coreidx)
 {
-	struct pcmcia_device *pdev = bus->host_pcmcia;
 	int err;
 	int attempts = 0;
 	u32 cur_core;
-	conf_reg_t reg;
 	u32 addr;
 	u32 read_addr;
+	u8 val;
 
 	addr = (coreidx * SSB_CORE_SIZE) + SSB_ENUM_BASE;
 	while (1) {
-		reg.Action = CS_WRITE;
-		reg.Offset = 0x2E;
-		reg.Value = (addr & 0x0000F000) >> 12;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_ADDRESS0,
+					   (addr & 0x0000F000) >> 12);
+		if (err)
 			goto error;
-		reg.Offset = 0x30;
-		reg.Value = (addr & 0x00FF0000) >> 16;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_ADDRESS1,
+					   (addr & 0x00FF0000) >> 16);
+		if (err)
 			goto error;
-		reg.Offset = 0x32;
-		reg.Value = (addr & 0xFF000000) >> 24;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_ADDRESS2,
+					   (addr & 0xFF000000) >> 24);
+		if (err)
 			goto error;
 
 		read_addr = 0;
 
-		reg.Action = CS_READ;
-		reg.Offset = 0x2E;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_ADDRESS0, &val);
+		if (err)
 			goto error;
-		read_addr |= ((u32)(reg.Value & 0x0F)) << 12;
-		reg.Offset = 0x30;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		read_addr |= ((u32)(val & 0x0F)) << 12;
+		err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_ADDRESS1, &val);
+		if (err)
 			goto error;
-		read_addr |= ((u32)reg.Value) << 16;
-		reg.Offset = 0x32;
-		err = pcmcia_access_configuration_register(pdev, &reg);
-		if (err != CS_SUCCESS)
+		read_addr |= ((u32)val) << 16;
+		err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_ADDRESS2, &val);
+		if (err)
 			goto error;
-		read_addr |= ((u32)reg.Value) << 24;
+		read_addr |= ((u32)val) << 24;
 
 		cur_core = (read_addr - SSB_ENUM_BASE) / SSB_CORE_SIZE;
 		if (cur_core == coreidx)
 			break;
 
+		err = -ETIMEDOUT;
 		if (attempts++ > SSB_BAR0_MAX_RETRIES)
 			goto error;
 		udelay(10);
 	}
 
 	return 0;
 error:
 	ssb_printk(KERN_ERR PFX "Failed to switch to core %u\n", coreidx);
-	return -ENODEV;
+	return err;
 }
 
 int ssb_pcmcia_switch_core(struct ssb_bus *bus,
 			   struct ssb_device *dev)
 {
 	int err;
@@ -109,43 +183,37 @@ int ssb_pcmcia_switch_core(struct ssb_bu
 	return err;
 }
 
 int ssb_pcmcia_switch_segment(struct ssb_bus *bus, u8 seg)
 {
 	int attempts = 0;
-	conf_reg_t reg;
-	int res;
+	int err;
+	u8 val;
 
 	SSB_WARN_ON((seg != 0) && (seg != 1));
-	reg.Offset = 0x34;
-	reg.Function = 0;
 	while (1) {
-		reg.Action = CS_WRITE;
-		reg.Value = seg;
-		res = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
-		if (unlikely(res != CS_SUCCESS))
+		err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_MEMSEG, seg);
+		if (err)
 			goto error;
-		reg.Value = 0xFF;
-		reg.Action = CS_READ;
-		res = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
-		if (unlikely(res != CS_SUCCESS))
+		err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_MEMSEG, &val);
+		if (err)
 			goto error;
-
-		if (reg.Value == seg)
+		if (val == seg)
 			break;
 
+		err = -ETIMEDOUT;
 		if (unlikely(attempts++ > SSB_BAR0_MAX_RETRIES))
 			goto error;
 		udelay(10);
 	}
 	bus->mapped_pcmcia_seg = seg;
 
 	return 0;
 error:
 	ssb_printk(KERN_ERR PFX "Failed to switch pcmcia segment\n");
-	return -ENODEV;
+	return err;
 }
 
 static int select_core_and_segment(struct ssb_device *dev,
 				   u16 *offset)
 {
 	struct ssb_bus *bus = dev->bus;
@@ -273,47 +341,377 @@ const struct ssb_bus_ops ssb_pcmcia_ops 
 	.read32		= ssb_pcmcia_read32,
 	.write8		= ssb_pcmcia_write8,
 	.write16	= ssb_pcmcia_write16,
 	.write32	= ssb_pcmcia_write32,
 };
 
-#include <linux/etherdevice.h>
+static int ssb_pcmcia_sprom_command(struct ssb_bus *bus, u8 command)
+{
+	unsigned int i;
+	int err;
+	u8 value;
+
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROMCTL, command);
+	if (err)
+		return err;
+	for (i = 0; i < 1000; i++) {
+		err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_SPROMCTL, &value);
+		if (err)
+			return err;
+		if (value & SSB_PCMCIA_SPROMCTL_DONE)
+			return 0;
+		udelay(10);
+	}
+
+	return -ETIMEDOUT;
+}
+
+/* offset is the 16bit word offset */
+static int ssb_pcmcia_sprom_read(struct ssb_bus *bus, u16 offset, u16 *value)
+{
+	int err;
+	u8 lo, hi;
+
+	offset *= 2; /* Make byte offset */
+
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_ADDRLO,
+				   (offset & 0x00FF));
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_ADDRHI,
+				   (offset & 0xFF00) >> 8);
+	if (err)
+		return err;
+	err = ssb_pcmcia_sprom_command(bus, SSB_PCMCIA_SPROMCTL_READ);
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_SPROM_DATALO, &lo);
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_read(bus, SSB_PCMCIA_SPROM_DATAHI, &hi);
+	if (err)
+		return err;
+	*value = (lo | (((u16)hi) << 8));
+
+	return 0;
+}
+
+/* offset is the 16bit word offset */
+static int ssb_pcmcia_sprom_write(struct ssb_bus *bus, u16 offset, u16 value)
+{
+	int err;
+
+	offset *= 2; /* Make byte offset */
+
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_ADDRLO,
+				   (offset & 0x00FF));
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_ADDRHI,
+				   (offset & 0xFF00) >> 8);
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_DATALO,
+				   (value & 0x00FF));
+	if (err)
+		return err;
+	err = ssb_pcmcia_cfg_write(bus, SSB_PCMCIA_SPROM_DATAHI,
+				   (value & 0xFF00) >> 8);
+	if (err)
+		return err;
+	err = ssb_pcmcia_sprom_command(bus, SSB_PCMCIA_SPROMCTL_WRITE);
+	if (err)
+		return err;
+	msleep(20);
+
+	return 0;
+}
+
+/* Read the SPROM image. bufsize is in 16bit words. */
+static int ssb_pcmcia_sprom_read_all(struct ssb_bus *bus, u16 *sprom)
+{
+	int err, i;
+
+	for (i = 0; i < SSB_PCMCIA_SPROM_SIZE; i++) {
+		err = ssb_pcmcia_sprom_read(bus, i, &sprom[i]);
+		if (err)
+			return err;
+	}
+
+	return 0;
+}
+
+/* Write the SPROM image. size is in 16bit words. */
+static int ssb_pcmcia_sprom_write_all(struct ssb_bus *bus, const u16 *sprom)
+{
+	int i, err;
+	bool failed = 0;
+	size_t size = SSB_PCMCIA_SPROM_SIZE;
+
+	ssb_printk(KERN_NOTICE PFX
+		   "Writing SPROM. Do NOT turn off the power! "
+		   "Please stand by...\n");
+	err = ssb_pcmcia_sprom_command(bus, SSB_PCMCIA_SPROMCTL_WRITEEN);
+	if (err) {
+		ssb_printk(KERN_NOTICE PFX
+			   "Could not enable SPROM write access.\n");
+		return -EBUSY;
+	}
+	ssb_printk(KERN_NOTICE PFX "[ 0%%");
+	msleep(500);
+	for (i = 0; i < size; i++) {
+		if (i == size / 4)
+			ssb_printk("25%%");
+		else if (i == size / 2)
+			ssb_printk("50%%");
+		else if (i == (size * 3) / 4)
+			ssb_printk("75%%");
+		else if (i % 2)
+			ssb_printk(".");
+		err = ssb_pcmcia_sprom_write(bus, i, sprom[i]);
+		if (err) {
+			ssb_printk("\n" KERN_NOTICE PFX
+				   "Failed to write to SPROM.\n");
+			failed = 1;
+			break;
+		}
+	}
+	err = ssb_pcmcia_sprom_command(bus, SSB_PCMCIA_SPROMCTL_WRITEDIS);
+	if (err) {
+		ssb_printk("\n" KERN_NOTICE PFX
+			   "Could not disable SPROM write access.\n");
+		failed = 1;
+	}
+	msleep(500);
+	if (!failed) {
+		ssb_printk("100%% ]\n");
+		ssb_printk(KERN_NOTICE PFX "SPROM written.\n");
+	}
+
+	return failed ? -EBUSY : 0;
+}
+
+static int ssb_pcmcia_sprom_check_crc(const u16 *sprom, size_t size)
+{
+	//TODO
+	return 0;
+}
+
+#define GOTO_ERROR_ON(condition, description) do {	\
+	if (unlikely(condition)) {			\
+		error_description = description;	\
+		goto error;				\
+	}						\
+  } while (0)
+
 int ssb_pcmcia_get_invariants(struct ssb_bus *bus,
 			      struct ssb_init_invariants *iv)
 {
-	//TODO
-	random_ether_addr(iv->sprom.il0mac);
+	tuple_t tuple;
+	int res;
+	unsigned char buf[32];
+	struct ssb_sprom *sprom = &iv->sprom;
+	struct ssb_boardinfo *bi = &iv->boardinfo;
+	const char *error_description;
+
+	memset(sprom, 0xFF, sizeof(*sprom));
+	sprom->revision = 1;
+	sprom->boardflags_lo = 0;
+	sprom->boardflags_hi = 0;
+
+	/* First fetch the MAC address. */
+	memset(&tuple, 0, sizeof(tuple));
+	tuple.DesiredTuple = CISTPL_FUNCE;
+	tuple.TupleData = buf;
+	tuple.TupleDataMax = sizeof(buf);
+	res = pcmcia_get_first_tuple(bus->host_pcmcia, &tuple);
+	GOTO_ERROR_ON(res != CS_SUCCESS, "MAC first tpl");
+	res = pcmcia_get_tuple_data(bus->host_pcmcia, &tuple);
+	GOTO_ERROR_ON(res != CS_SUCCESS, "MAC first tpl data");
+	while (1) {
+		GOTO_ERROR_ON(tuple.TupleDataLen < 1, "MAC tpl < 1");
+		if (tuple.TupleData[0] == CISTPL_FUNCE_LAN_NODE_ID)
+			break;
+		res = pcmcia_get_next_tuple(bus->host_pcmcia, &tuple);
+		GOTO_ERROR_ON(res != CS_SUCCESS, "MAC next tpl");
+		res = pcmcia_get_tuple_data(bus->host_pcmcia, &tuple);
+		GOTO_ERROR_ON(res != CS_SUCCESS, "MAC next tpl data");
+	}
+	GOTO_ERROR_ON(tuple.TupleDataLen != ETH_ALEN + 2, "MAC tpl size");
+	memcpy(sprom->il0mac, &tuple.TupleData[2], ETH_ALEN);
+
+	/* Fetch the vendor specific tuples. */
+	memset(&tuple, 0, sizeof(tuple));
+	tuple.DesiredTuple = SSB_PCMCIA_CIS;
+	tuple.TupleData = buf;
+	tuple.TupleDataMax = sizeof(buf);
+	res = pcmcia_get_first_tuple(bus->host_pcmcia, &tuple);
+	GOTO_ERROR_ON(res != CS_SUCCESS, "VEN first tpl");
+	res = pcmcia_get_tuple_data(bus->host_pcmcia, &tuple);
+	GOTO_ERROR_ON(res != CS_SUCCESS, "VEN first tpl data");
+	while (1) {
+		GOTO_ERROR_ON(tuple.TupleDataLen < 1, "VEN tpl < 1");
+		switch (tuple.TupleData[0]) {
+		case SSB_PCMCIA_CIS_ID:
+			GOTO_ERROR_ON((tuple.TupleDataLen != 5) &&
+				      (tuple.TupleDataLen != 7),
+				      "id tpl size");
+			bi->vendor = tuple.TupleData[1] |
+			       ((u16)tuple.TupleData[2] << 8);
+			break;
+		case SSB_PCMCIA_CIS_BOARDREV:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 2,
+				      "boardrev tpl size");
+			sprom->board_rev = tuple.TupleData[1];
+			break;
+		case SSB_PCMCIA_CIS_PA:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 9,
+				      "pa tpl size");
+			sprom->pa0b0 = tuple.TupleData[1] |
+				 ((u16)tuple.TupleData[2] << 8);
+			sprom->pa0b1 = tuple.TupleData[3] |
+				 ((u16)tuple.TupleData[4] << 8);
+			sprom->pa0b2 = tuple.TupleData[5] |
+				 ((u16)tuple.TupleData[6] << 8);
+			sprom->itssi_a = tuple.TupleData[7];
+			sprom->itssi_bg = tuple.TupleData[7];
+			sprom->maxpwr_a = tuple.TupleData[8];
+			sprom->maxpwr_bg = tuple.TupleData[8];
+			break;
+		case SSB_PCMCIA_CIS_OEMNAME:
+			/* We ignore this. */
+			break;
+		case SSB_PCMCIA_CIS_CCODE:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 2,
+				      "ccode tpl size");
+			sprom->country_code = tuple.TupleData[1];
+			break;
+		case SSB_PCMCIA_CIS_ANTENNA:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 2,
+				      "ant tpl size");
+			sprom->ant_available_a = tuple.TupleData[1];
+			sprom->ant_available_bg = tuple.TupleData[1];
+			break;
+		case SSB_PCMCIA_CIS_ANTGAIN:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 2,
+				      "antg tpl size");
+			sprom->antenna_gain.ghz24.a0 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz24.a1 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz24.a2 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz24.a3 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz5.a0 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz5.a1 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz5.a2 = tuple.TupleData[1];
+			sprom->antenna_gain.ghz5.a3 = tuple.TupleData[1];
+			break;
+		case SSB_PCMCIA_CIS_BFLAGS:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 3,
+				      "bfl tpl size");
+			sprom->boardflags_lo = tuple.TupleData[1] |
+					 ((u16)tuple.TupleData[2] << 8);
+			break;
+		case SSB_PCMCIA_CIS_LEDS:
+			GOTO_ERROR_ON(tuple.TupleDataLen != 5,
+				      "leds tpl size");
+			sprom->gpio0 = tuple.TupleData[1];
+			sprom->gpio1 = tuple.TupleData[2];
+			sprom->gpio2 = tuple.TupleData[3];
+			sprom->gpio3 = tuple.TupleData[4];
+			break;
+		}
+		res = pcmcia_get_next_tuple(bus->host_pcmcia, &tuple);
+		if (res == CS_NO_MORE_ITEMS)
+			break;
+		GOTO_ERROR_ON(res != CS_SUCCESS, "VEN next tpl");
+		res = pcmcia_get_tuple_data(bus->host_pcmcia, &tuple);
+		GOTO_ERROR_ON(res != CS_SUCCESS, "VEN next tpl data");
+	}
+
 	return 0;
+error:
+	ssb_printk(KERN_ERR PFX
+		   "PCMCIA: Failed to fetch device invariants: %s\n",
+		   error_description);
+	return -ENODEV;
+}
+
+static ssize_t ssb_pcmcia_attr_sprom_show(struct device *pcmciadev,
+					  struct device_attribute *attr,
+					  char *buf)
+{
+	struct pcmcia_device *pdev =
+		container_of(pcmciadev, struct pcmcia_device, dev);
+	struct ssb_bus *bus;
+
+	bus = ssb_pcmcia_dev_to_bus(pdev);
+	if (!bus)
+		return -ENODEV;
+
+	return ssb_attr_sprom_show(bus, buf,
+				   ssb_pcmcia_sprom_read_all);
+}
+
+static ssize_t ssb_pcmcia_attr_sprom_store(struct device *pcmciadev,
+					   struct device_attribute *attr,
+					   const char *buf, size_t count)
+{
+	struct pcmcia_device *pdev =
+		container_of(pcmciadev, struct pcmcia_device, dev);
+	struct ssb_bus *bus;
+
+	bus = ssb_pcmcia_dev_to_bus(pdev);
+	if (!bus)
+		return -ENODEV;
+
+	return ssb_attr_sprom_store(bus, buf, count,
+				    ssb_pcmcia_sprom_check_crc,
+				    ssb_pcmcia_sprom_write_all);
+}
+
+static DEVICE_ATTR(ssb_sprom, 0600,
+		   ssb_pcmcia_attr_sprom_show,
+		   ssb_pcmcia_attr_sprom_store);
+
+void ssb_pcmcia_exit(struct ssb_bus *bus)
+{
+	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
+		return;
+
+	device_remove_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
 }
 
 int ssb_pcmcia_init(struct ssb_bus *bus)
 {
-	conf_reg_t reg;
+	u8 val, offset;
 	int err;
 
 	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
 		return 0;
 
 	/* Switch segment to a known state and sync
 	 * bus->mapped_pcmcia_seg with hardware state. */
 	ssb_pcmcia_switch_segment(bus, 0);
 
 	/* Init IRQ routing */
-	reg.Action = CS_READ;
-	reg.Function = 0;
 	if (bus->chip_id == 0x4306)
-		reg.Offset = 0x00;
+		offset = SSB_PCMCIA_CORECTL;
 	else
-		reg.Offset = 0x80;
-	err = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
-	if (err != CS_SUCCESS)
+		offset = SSB_PCMCIA_CORECTL2;
+	err = ssb_pcmcia_cfg_read(bus, offset, &val);
+	if (err)
 		goto error;
-	reg.Action = CS_WRITE;
-	reg.Value |= 0x04 | 0x01;
-	err = pcmcia_access_configuration_register(bus->host_pcmcia, &reg);
-	if (err != CS_SUCCESS)
+	val |= SSB_PCMCIA_CORECTL_IRQEN | SSB_PCMCIA_CORECTL_FUNCEN;
+	err = ssb_pcmcia_cfg_write(bus, offset, val);
+	if (err)
+		goto error;
+
+	bus->sprom_size = SSB_PCMCIA_SPROM_SIZE;
+	mutex_init(&bus->sprom_mutex);
+	err = device_create_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
+	if (err)
 		goto error;
 
 	return 0;
 error:
-	return -ENODEV;
+	ssb_printk(KERN_ERR PFX "Failed to initialize PCMCIA host device\n");
+	return err;
 }
Index: wireless-testing/drivers/ssb/sprom.c
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ wireless-testing/drivers/ssb/sprom.c	2008-03-10 17:15:52.000000000 +0100
@@ -0,0 +1,133 @@
+/*
+ * Sonics Silicon Backplane
+ * Common SPROM support routines
+ *
+ * Copyright (C) 2005-2008 Michael Buesch <mb at bu3sch.de>
+ * Copyright (C) 2005 Martin Langer <martin-langer at gmx.de>
+ * Copyright (C) 2005 Stefano Brivio <st3 at riseup.net>
+ * Copyright (C) 2005 Danny van Dyk <kugelfang at gentoo.org>
+ * Copyright (C) 2005 Andreas Jaggi <andreas.jaggi at waterwave.ch>
+ *
+ * Licensed under the GNU/GPL. See COPYING for details.
+ */
+
+#include "ssb_private.h"
+
+
+static int sprom2hex(const u16 *sprom, char *buf, size_t buf_len,
+		     size_t sprom_size_words)
+{
+	int i, pos = 0;
+
+	for (i = 0; i < sprom_size_words; i++)
+		pos += snprintf(buf + pos, buf_len - pos - 1,
+				"%04X", swab16(sprom[i]) & 0xFFFF);
+	pos += snprintf(buf + pos, buf_len - pos - 1, "\n");
+
+	return pos + 1;
+}
+
+static int hex2sprom(u16 *sprom, const char *dump, size_t len,
+		     size_t sprom_size_words)
+{
+	char tmp[5] = { 0 };
+	int cnt = 0;
+	unsigned long parsed;
+
+	if (len < sprom_size_words * 2)
+		return -EINVAL;
+
+	while (cnt < sprom_size_words) {
+		memcpy(tmp, dump, 4);
+		dump += 4;
+		parsed = simple_strtoul(tmp, NULL, 16);
+		sprom[cnt++] = swab16((u16)parsed);
+	}
+
+	return 0;
+}
+
+/* Common sprom device-attribute show-handler */
+ssize_t ssb_attr_sprom_show(struct ssb_bus *bus, char *buf,
+			    int (*sprom_read)(struct ssb_bus *bus, u16 *sprom))
+{
+	u16 *sprom;
+	int err = -ENOMEM;
+	ssize_t count = 0;
+	size_t sprom_size_words = bus->sprom_size;
+
+	sprom = kcalloc(sprom_size_words, sizeof(u16), GFP_KERNEL);
+	if (!sprom)
+		goto out;
+
+	/* Use interruptible locking, as the SPROM write might
+	 * be holding the lock for several seconds. So allow userspace
+	 * to cancel operation. */
+	err = -ERESTARTSYS;
+	if (mutex_lock_interruptible(&bus->sprom_mutex))
+		goto out_kfree;
+	err = sprom_read(bus, sprom);
+	mutex_unlock(&bus->sprom_mutex);
+
+	if (!err)
+		count = sprom2hex(sprom, buf, PAGE_SIZE, sprom_size_words);
+
+out_kfree:
+	kfree(sprom);
+out:
+	return err ? err : count;
+}
+
+/* Common sprom device-attribute store-handler */
+ssize_t ssb_attr_sprom_store(struct ssb_bus *bus,
+			     const char *buf, size_t count,
+			     int (*sprom_check_crc)(const u16 *sprom, size_t size),
+			     int (*sprom_write)(struct ssb_bus *bus, const u16 *sprom))
+{
+	u16 *sprom;
+	int res = 0, err = -ENOMEM;
+	size_t sprom_size_words = bus->sprom_size;
+
+	sprom = kcalloc(bus->sprom_size, sizeof(u16), GFP_KERNEL);
+	if (!sprom)
+		goto out;
+	err = hex2sprom(sprom, buf, count, sprom_size_words);
+	if (err) {
+		err = -EINVAL;
+		goto out_kfree;
+	}
+	err = sprom_check_crc(sprom, sprom_size_words);
+	if (err) {
+		err = -EINVAL;
+		goto out_kfree;
+	}
+
+	/* Use interruptible locking, as the SPROM write might
+	 * be holding the lock for several seconds. So allow userspace
+	 * to cancel operation. */
+	err = -ERESTARTSYS;
+	if (mutex_lock_interruptible(&bus->sprom_mutex))
+		goto out_kfree;
+	err = ssb_devices_freeze(bus);
+	if (err == -EOPNOTSUPP) {
+		ssb_printk(KERN_ERR PFX "SPROM write: Could not freeze devices. "
+			   "No suspend support. Is CONFIG_PM enabled?\n");
+		goto out_unlock;
+	}
+	if (err) {
+		ssb_printk(KERN_ERR PFX "SPROM write: Could not freeze all devices\n");
+		goto out_unlock;
+	}
+	res = sprom_write(bus, sprom);
+	err = ssb_devices_thaw(bus);
+	if (err)
+		ssb_printk(KERN_ERR PFX "SPROM write: Could not thaw all devices\n");
+out_unlock:
+	mutex_unlock(&bus->sprom_mutex);
+out_kfree:
+	kfree(sprom);
+out:
+	if (res)
+		return res;
+	return err ? err : count;
+}
Index: wireless-testing/drivers/ssb/ssb_private.h
===================================================================
--- wireless-testing.orig/drivers/ssb/ssb_private.h	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/drivers/ssb/ssb_private.h	2008-03-10 17:15:52.000000000 +0100
@@ -78,12 +78,13 @@ extern int ssb_pcmcia_switch_core(struct
 extern int ssb_pcmcia_switch_coreidx(struct ssb_bus *bus,
 				     u8 coreidx);
 extern int ssb_pcmcia_switch_segment(struct ssb_bus *bus,
 				     u8 seg);
 extern int ssb_pcmcia_get_invariants(struct ssb_bus *bus,
 				     struct ssb_init_invariants *iv);
+extern void ssb_pcmcia_exit(struct ssb_bus *bus);
 extern int ssb_pcmcia_init(struct ssb_bus *bus);
 extern const struct ssb_bus_ops ssb_pcmcia_ops;
 #else /* CONFIG_SSB_PCMCIAHOST */
 static inline int ssb_pcmcia_switch_core(struct ssb_bus *bus,
 					 struct ssb_device *dev)
 {
@@ -96,12 +97,15 @@ static inline int ssb_pcmcia_switch_core
 }
 static inline int ssb_pcmcia_switch_segment(struct ssb_bus *bus,
 					    u8 seg)
 {
 	return 0;
 }
+static inline void ssb_pcmcia_exit(struct ssb_bus *bus)
+{
+}
 static inline int ssb_pcmcia_init(struct ssb_bus *bus)
 {
 	return 0;
 }
 #endif /* CONFIG_SSB_PCMCIAHOST */
 
@@ -110,17 +114,30 @@ static inline int ssb_pcmcia_init(struct
 extern const char *ssb_core_name(u16 coreid);
 extern int ssb_bus_scan(struct ssb_bus *bus,
 			unsigned long baseaddr);
 extern void ssb_iounmap(struct ssb_bus *ssb);
 
 
+/* sprom.c */
+extern
+ssize_t ssb_attr_sprom_show(struct ssb_bus *bus, char *buf,
+			    int (*sprom_read)(struct ssb_bus *bus, u16 *sprom));
+extern
+ssize_t ssb_attr_sprom_store(struct ssb_bus *bus,
+			     const char *buf, size_t count,
+			     int (*sprom_check_crc)(const u16 *sprom, size_t size),
+			     int (*sprom_write)(struct ssb_bus *bus, const u16 *sprom));
+
+
 /* core.c */
 extern u32 ssb_calc_clock_rate(u32 plltype, u32 n, u32 m);
 extern int ssb_devices_freeze(struct ssb_bus *bus);
 extern int ssb_devices_thaw(struct ssb_bus *bus);
 extern struct ssb_bus *ssb_pci_dev_to_bus(struct pci_dev *pdev);
+extern struct ssb_bus *ssb_pcmcia_dev_to_bus(struct pcmcia_device *pdev);
+
 
 /* b43_pci_bridge.c */
 #ifdef CONFIG_SSB_B43_PCI_BRIDGE
 extern int __init b43_pci_ssb_bridge_init(void);
 extern void __exit b43_pci_ssb_bridge_exit(void);
 #else /* CONFIG_SSB_B43_PCI_BRIDGR */
Index: wireless-testing/include/linux/ssb/ssb.h
===================================================================
--- wireless-testing.orig/include/linux/ssb/ssb.h	2008-03-10 17:15:50.000000000 +0100
+++ wireless-testing/include/linux/ssb/ssb.h	2008-03-10 17:23:43.000000000 +0100
@@ -242,15 +242,15 @@ struct ssb_bus {
 	enum ssb_bustype bustype;
 	/* Pointer to the PCI bus (only valid if bustype == SSB_BUSTYPE_PCI). */
 	struct pci_dev *host_pci;
 	/* Pointer to the PCMCIA device (only if bustype == SSB_BUSTYPE_PCMCIA). */
 	struct pcmcia_device *host_pcmcia;
 
-#ifdef CONFIG_SSB_PCIHOST
+#ifdef CONFIG_SSB_SPROM
 	/* Mutex to protect the SPROM writing. */
-	struct mutex pci_sprom_mutex;
+	struct mutex sprom_mutex;
 #endif
 
 	/* ID information about the Chip. */
 	u16 chip_id;
 	u16 chip_rev;
 	u16 sprom_size;		/* number of words in sprom */


From ptrdsnr at googlemail.com  Tue Mar 11 21:59:28 2008
From: ptrdsnr at googlemail.com (Peter Diesner)
Date: Tue, 11 Mar 2008 21:59:28 +0100
Subject: b43 on gutsy using 2.6.24 doesn't work
Message-ID: <329b1a20803111359h3428f5f7vd8992321071455a9@mail.gmail.com>

Hi,
I think I'm a little closer to a solution.

Wlan0 doesn't work after system start. But executing the following command
manually helps:

sudo modprobe -r b43
sleep 3
sudo modprobe b43
sleep 3
sudo iwconfig wlan0 essid XXXXXXXX
sleep 3
sudo dhclient wlan0


Without sleep 3 it doesn't work. May be a timing problem ?

Regards Peter
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080311/1f890c35/attachment.html>

From golemkroasan at gmail.com  Wed Mar 12 02:03:00 2008
From: golemkroasan at gmail.com (lowdown)
Date: Wed, 12 Mar 2008 02:03:00 +0100
Subject: HELP BROADCOM bcm43xxx driver instalation on mandriva 2006
Message-ID: <9c84f24c0803111803o2db70192yf1777a722fff5bfa@mail.gmail.com>

I'm trying to install bcm43xxx driver for mandriva, here are the steps:
(Before  cutting the windows diriver and "make installfw" there wasn't
directory in  /lib/ named firmware, is there anythig with default
firmwire directory.
Somwhre i've read that mandriva default firmware directory is
/lib/firmware/ but the directory firmwire was't there before commnad
"make installfw")

./bcm43xx-fwcutter /home/kristijan/Desktop/broadcom\ 4318/R102320/bcmwl5*.sys

filename : bcmwl5.sys
version : 3.120.27.0
MD5 : 8d49f11238815a320880fee9f98b2c92
microcodes : 2 4 5
pcms : 4 5

microcode : 2
revision : 0x0123
patchlevel : 0x0023
date : 2005-03-22
time : 00:11:18

microcode : 4
revision : 0x0123
patchlevel : 0x0023
date : 2005-03-22
time : 00:11:18

microcode : 5
revision : 0x0123
patchlevel : 0x0023
date : 2005-03-22
time : 00:11:18

extracting bcm43xx_microcode2.fw ...
extracting bcm43xx_microcode4.fw ...
extracting bcm43xx_microcode5.fw ...
extracting bcm43xx_pcm4.fw ...
extracting bcm43xx_pcm5.fw ...
extracting bcm43xx_initval01.fw ...
extracting bcm43xx_initval02.fw ...
extracting bcm43xx_initval03.fw ...
extracting bcm43xx_initval04.fw ...
extracting bcm43xx_initval05.fw ...
extracting bcm43xx_initval06.fw ...
extracting bcm43xx_initval07.fw ...
extracting bcm43xx_initval08.fw ...
extracting bcm43xx_initval09.fw ...
extracting bcm43xx_initval10.fw ...
[root at DARKSTAR bcm43xx-fwcutter-006]# make installfw
if ! [ -d /lib/firmware ]; then mkdir -p /lib/firmware; fi
install -o 0 -g 0 -m 600 bcm43xx_*.fw /lib/firmware
root at DARKSTAR bcm43xx-fwcutter-006]# lsmod | grep bcm43xx
[root at DARKSTAR bcm43xx-fwcutter-006]#
[root at DARKSTAR bcm43xx-fwcutter-006]# modprobe bcm43xx
FATAL: Module bcm43xx not found.

What i'm doing wrong, any ideas?


From comphappy at gmail.com  Wed Mar 12 05:46:37 2008
From: comphappy at gmail.com (Brennan Ashton)
Date: Tue, 11 Mar 2008 21:46:37 -0700
Subject: HELP BROADCOM bcm43xxx driver instalation on mandriva 2006
In-Reply-To: <9c84f24c0803111803o2db70192yf1777a722fff5bfa@mail.gmail.com>
References: <9c84f24c0803111803o2db70192yf1777a722fff5bfa@mail.gmail.com>
Message-ID: <b2d05de20803112146h49d28ae6i37fb27e803787dad@mail.gmail.com>

dont use the bcm43xx driver use b43 and the firmware at
www.linuxwireless.org (directions there as well)

On Tue, Mar 11, 2008 at 6:03 PM, lowdown <golemkroasan at gmail.com> wrote:

> I'm trying to install bcm43xxx driver for mandriva, here are the steps:
> (Before  cutting the windows diriver and "make installfw" there wasn't
> directory in  /lib/ named firmware, is there anythig with default
> firmwire directory.
> Somwhre i've read that mandriva default firmware directory is
> /lib/firmware/ but the directory firmwire was't there before commnad
> "make installfw")
>
> ./bcm43xx-fwcutter /home/kristijan/Desktop/broadcom\
> 4318/R102320/bcmwl5*.sys
>
> filename : bcmwl5.sys
> version : 3.120.27.0
> MD5 : 8d49f11238815a320880fee9f98b2c92
> microcodes : 2 4 5
> pcms : 4 5
>
> microcode : 2
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> microcode : 4
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> microcode : 5
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> extracting bcm43xx_microcode2.fw ...
> extracting bcm43xx_microcode4.fw ...
> extracting bcm43xx_microcode5.fw ...
> extracting bcm43xx_pcm4.fw ...
> extracting bcm43xx_pcm5.fw ...
> extracting bcm43xx_initval01.fw ...
> extracting bcm43xx_initval02.fw ...
> extracting bcm43xx_initval03.fw ...
> extracting bcm43xx_initval04.fw ...
> extracting bcm43xx_initval05.fw ...
> extracting bcm43xx_initval06.fw ...
> extracting bcm43xx_initval07.fw ...
> extracting bcm43xx_initval08.fw ...
> extracting bcm43xx_initval09.fw ...
> extracting bcm43xx_initval10.fw ...
> [root at DARKSTAR bcm43xx-fwcutter-006]# make installfw
> if ! [ -d /lib/firmware ]; then mkdir -p /lib/firmware; fi
> install -o 0 -g 0 -m 600 bcm43xx_*.fw /lib/firmware
> root at DARKSTAR bcm43xx-fwcutter-006]# lsmod | grep bcm43xx
> [root at DARKSTAR bcm43xx-fwcutter-006]#
> [root at DARKSTAR bcm43xx-fwcutter-006]# modprobe bcm43xx
> FATAL: Module bcm43xx not found.
>
> What i'm doing wrong, any ideas?
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows XP or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080311/f9b7f786/attachment.html>

From ftoledo at docksud.com.ar  Wed Mar 12 14:03:54 2008
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Wed, 12 Mar 2008 11:03:54 -0200
Subject: warning sotirq
Message-ID: <200803121103.56301.ftoledo@docksud.com.ar>

hi all!
i test my kernel with the rtpatch(real time)
now, b43 has that warnings:
i still connect fine.

Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 10, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/debugfs.c:635 b43_debugfs_log_txstat()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad144f>] b43_debugfs_log_txstat+0x4b/0x88 [b43]
 [<f8ace5ac>] b43_handle_txstatus+0xb/0x61 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================
WARNING: at drivers/net/wireless/b43/dma.c:1276 b43_dma_handle_txstatus()
Pid: 22, comm: softirq-tasklet Not tainted 2.6.24.3-rt3fer #8
 [<f8ad3b69>] b43_dma_handle_txstatus+0x11a/0x344 [b43]
 [<f8ac4499>] b43_interrupt_tasklet+0x649/0x6ce [b43]
 [<c01239ba>] finish_task_switch+0x33/0xb5
 [<c012cc22>] __tasklet_action+0xa6/0x123
 [<c02c7084>] schedule+0xef/0x114
 [<c012d548>] ksoftirqd+0x166/0x24b
 [<c012d3e2>] ksoftirqd+0x0/0x24b
 [<c01392cc>] kthread+0x38/0x60
 [<c0139294>] kthread+0x0/0x60
 [<c0107d1b>] kernel_thread_helper+0x7/0x10
 =======================

-- 
Dock Sud BBS
http://www.docksud.com.ar
telnet://bbs.docksud.com.ar
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080312/5dcee2a1/attachment.pgp>

From mb at bu3sch.de  Wed Mar 12 17:51:04 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 12 Mar 2008 17:51:04 +0100
Subject: [PATCH] b43: phy.c fix typo in register write
Message-ID: <200803121751.04560.mb@bu3sch.de>

From: Harvey Harrison <harvey.harrison at gmail.com>

Commit 61bca6eb85c863603d6054530e2f65c3b9aba85b b43: rewrite A PHY initialization
has a typo, the result of the register read should be masked, not the
register offset.

Signed-off-by: Harvey Harrison <harvey.harrison at gmail.com>
Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

Can be applied for 2.6.25, although this is A-PHY only.


 drivers/net/wireless/b43/phy.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy.c b/drivers/net/wireless/b43/phy.c
index 71507b2..575c543 100644
--- a/drivers/net/wireless/b43/phy.c
+++ b/drivers/net/wireless/b43/phy.c
@@ -860,7 +860,7 @@ static void b43_phy_ww(struct b43_wldev *dev)
 	b43_phy_write(dev, B43_PHY_OFDM(0xBB),
 		(b43_phy_read(dev, B43_PHY_OFDM(0xBB)) & 0xF000) | 0x0053);
 	b43_phy_write(dev, B43_PHY_OFDM61,
-		(b43_phy_read(dev, B43_PHY_OFDM61 & 0xFE1F)) | 0x0120);
+		(b43_phy_read(dev, B43_PHY_OFDM61) & 0xFE1F) | 0x0120);
 	b43_phy_write(dev, B43_PHY_OFDM(0x13),
 		(b43_phy_read(dev, B43_PHY_OFDM(0x13)) & 0x0FFF) | 0x3000);
 	b43_phy_write(dev, B43_PHY_OFDM(0x14),
-- 
1.5.4.4.592.g32d4c





-------------------------------------------------------

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Thu Mar 13 05:16:11 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 12 Mar 2008 21:16:11 -0700
Subject: b43 on gutsy using 2.6.24 doesn't work
In-Reply-To: <329b1a20803111359h3428f5f7vd8992321071455a9@mail.gmail.com>
References: <329b1a20803111359h3428f5f7vd8992321071455a9@mail.gmail.com>
Message-ID: <47D8AA8B.2040600@lwfinger.net>

Peter Diesner wrote:
> Hi,
> I think I'm a little closer to a solution.
> 
> Wlan0 doesn't work after system start. But executing the following
> command manually helps:
> 
> sudo modprobe -r b43
> sleep 3
> sudo modprobe b43
> sleep 3
> sudo iwconfig wlan0 essid XXXXXXXX
> sleep 3
> sudo dhclient wlan0
> 
> 
> Without sleep 3 it doesn't work. May be a timing problem ?

I'm pretty sure that not all the sleeps are needed. In any case, why don't you prepare a proper
ifcfg-wlan0 file and simply do an ifup wlan0? With openSUSE 10.3, that file is prepared with a YaST
GUI. Even better would be to use NetworkManager.

Larry



From abhijit at deeproot.co.in  Wed Mar 12 16:41:07 2008
From: abhijit at deeproot.co.in (Abhijit Hoskeri)
Date: Wed, 12 Mar 2008 21:11:07 +0530
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
Message-ID: <20080312154107.GA2696@deeproot.co.in>

On Tue, Mar 04, 2008 at 09:44:33AM +0000, C?dric Caumont wrote:
> 
> I use the git kernel ans the good firmware on my debian and every thinks are ok!!
> 
> http://linuxwireless.org/en/users/Drivers/b43#firmwareinstallation
> 
> git-clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-testing.git
> cd wireless-testing

Thanks for the tip... but it still does not work for me for some strange
reason :-(

I am running the latest git of the kernel you specified above. I still
kept getting the same behaviour and a firmware upgrade warning. I upgraded the
firmware. The firmware warning is now gone but the DMA errors keep
coming even if the only thing I do is to scan. ( I used to see scan
results without errors until yesterday's git update). The new kernel
logs after the latest git update is as follows.

I am not getting the rc5 kernel if I do a git-pull from the above tree. 
Isn't it always supposed to be synced with upstream?

Is this card officially supported/will be supported in 2.6.25?

Thanks,
Abhijit.

----------------------------------------------------------------------

uname -r: 2.6.25-rc4-wl

dmesg output:

kern.info: ACPI: Lid Switch [LID0]
kern.info: input: Sleep Button (CM) as /class/input/input7
kern.info: ACPI: Sleep Button (CM) [SLPB]
kern.info: b43-phy0: Broadcom 4311 WLAN found
kern.debug: b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 9
kern.debug: b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
kern.debug: phy0: Selected rate control algorithm 'pid'
kern.info: Broadcom 43xx driver loaded [ Features: PMLR, Firmware-ID: FW13 ]
kern.info: Adding 2097136k swap on /dev/sda2.  Priority:-1 extents:1 across:2097136k
kern.info: device-mapper: uevent: version 1.0.3
kern.info: device-mapper: ioctl: 4.13.0-ioctl (2007-10-18) initialised: dm-devel at redhat.com
kern.warn: hda_intel: azx_get_response timeout, switching to polling mode: last cmd=0x011b8000
kern.notice: ReiserFS: sda3: found reiserfs format "3.6" with standard journal
kern.notice: ReiserFS: sda3: using ordered data mode
kern.notice: ReiserFS: sda3: journal params: device sda3, size 8192, journal first block 18, max trans len 1024, max batch 900, max commit age 30, max trans age 30
kern.notice: ReiserFS: sda3: checking transaction log (sda3)
kern.notice: ReiserFS: sda3: Using r5 hash to sort names
kern.info: eth0: link up, 100Mbps, full-duplex, lpa 0x45E1
kern.info: NET: Registered protocol family 10
kern.info: lo: Disabled Privacy Extensions
kern.info: ip_tables: (C) 2000-2006 Netfilter Core Team
kern.warn: nf_conntrack version 0.5.0 (16384 buckets, 65536 max)
kern.debug: eth0: no IPv6 routers present
kern.info: [drm] Initialized drm 1.1.0 20060810
kern.info: ACPI: PCI Interrupt 0000:00:02.0[A] -> GSI 16 (level, low) -> IRQ 16
kern.debug: PCI: Setting latency timer of device 0000:00:02.0 to 64
kern.info: [drm] Initialized i915 1.6.0 20060119 on minor 0
kern.info: input: b43-phy0 as /class/input/input8
kern.info: b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
kern.debug: b43-phy0 debug: Chip initialized
kern.debug: b43-phy0 debug: 64-bit DMA initialized
kern.info: Registered led device: b43-phy0::tx
kern.info: Registered led device: b43-phy0::rx
kern.info: Registered led device: b43-phy0::radio
kern.err: b43-phy0 ERROR: PHY transmission error
kern.debug: b43-phy0 debug: Wireless interface started
kern.debug: b43-phy0 debug: Adding Interface type 2
kern.info: b43-phy0: Radio hardware status changed to DISABLED
kern.info: ADDRCONF(NETDEV_UP): wlan0: link is not ready
kern.info: b43-phy0: Radio hardware status changed to ENABLED
kern.err: b43-phy0 ERROR: Fatal DMA error: 0x00000800, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.info: b43-phy0: Controller RESET (DMA error) ...
kern.debug: b43-phy0 debug: Wireless interface stopped
kern.debug: b43-phy0 debug: DMA-64 rx_ring: Used slots 1/64, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_BK: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_BE: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_VO: Used slots 16/128, Failed frames 0/12 = 0.0%, Average tries 1.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_mcast: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.info: b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
kern.debug: b43-phy0 debug: Chip initialized
kern.debug: b43-phy0 debug: 64-bit DMA initialized
kern.info: Registered led device: b43-phy0::tx
kern.info: Registered led device: b43-phy0::rx
kern.info: Registered led device: b43-phy0::radio
kern.debug: b43-phy0 debug: Wireless interface started
kern.info: b43-phy0: Controller restarted
kern.err: b43-phy0 ERROR: Fatal DMA error: 0x00000400, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
kern.info: b43-phy0: Controller RESET (DMA error) ...
kern.debug: b43-phy0 debug: Wireless interface stopped
kern.debug: b43-phy0 debug: DMA-64 rx_ring: Used slots 0/64, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_BK: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_BE: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_VI: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_AC_VO: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.debug: b43-phy0 debug: DMA-64 tx_ring_mcast: Used slots 0/128, Failed frames 0/0 = 0.0%, Average tries 0.00
kern.info: b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
kern.debug: b43-phy0 debug: Chip initialized
kern.debug: b43-phy0 debug: 64-bit DMA initialized
kern.info: Registered led device: b43-phy0::tx
kern.info: Registered led device: b43-phy0::rx
kern.info: Registered led device: b43-phy0::radio


From artem.v.antonov at gmail.com  Thu Mar 13 18:20:47 2008
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Thu, 13 Mar 2008 20:20:47 +0300
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
In-Reply-To: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
References: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
Message-ID: <6bc534830803131020p34afb1d2kce90a4ab84cd5292@mail.gmail.com>

Does anybody else have such problem?
btw, I'm using PDA ASUS 696 as a client (if this means anything).
With 2.4 kernel and binary broadcom driver it seems to work well.
But I'm not sure, if it's the right place for seeking a solving of my
problem (becouse it can be also a hostapd bug or mac80211 bug :)
And I managed to make it work with hostapd and b43 driver a couple months
ago, but now I can't make it work.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080313/c4187919/attachment.html>

From abhijit at deeproot.co.in  Fri Mar 14 12:56:57 2008
From: abhijit at deeproot.co.in (Abhijit Hoskeri)
Date: Fri, 14 Mar 2008 17:26:57 +0530
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <47D939FD.5070308@lwfinger.net>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in>
	<47D939FD.5070308@lwfinger.net>
Message-ID: <20080314115656.GA32222@deeproot.co.in>

On Thu, Mar 13, 2008 at 07:28:13AM -0700, Larry Finger wrote:
> I think your card should be supported. Did you checkout branch
> everything of Linville's tree, or are you running under the master
> branch? Issue the command 'git branch' and see which branch has the
> star. If you have used the master branch, you should issue the command
> 'git checkout --track -b everything origin/everything' to checkout the
> proper branch. It will have the latest code including the fix for your
> 64-bit card. Those devices used to work but a change in the DMA buffer
> handling elsewhere in the kernel broke them.

Thanks a lot! 

I ran this command, but it did not work:

    abhijit at azad:~/src/wireless-testing$ git branch
    * master
    abhijit at azad:~/src/wireless-testing$ git branch -l
    * master
    abhijit at azad:~/src/wireless-testing$ git-branch -r
      origin/HEAD
      origin/at76
      origin/base
      origin/extra
      origin/fixes
      origin/master
      origin/merged-fixes
      origin/merged-upstream
      origin/upstream
      origin/upstream-pending
    abhijit at azad:~/src/wireless-testing$ git checkout --track -b everything origin/everything
    git checkout: updating paths is incompatible with switching branches/forcing
    Did you intend to checkout 'origin/everything' which can not be resolved as commit?

I am sorry, I do not know enough about git yet to guess what the correct
incantation should be. 

Anyway I just did a git-pull and got 2.6.25-rc5-wl. I have built it but not had
opportunity to test it yet. Is this new enough to work?

Thanks,
Abhijit


From abhijit at deeproot.co.in  Fri Mar 14 13:23:11 2008
From: abhijit at deeproot.co.in (Abhijit Hoskeri)
Date: Fri, 14 Mar 2008 17:53:11 +0530
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <20080314115656.GA32222@deeproot.co.in>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in>
	<47D939FD.5070308@lwfinger.net>
	<20080314115656.GA32222@deeproot.co.in>
Message-ID: <20080314122311.GA3330@deeproot.co.in>

On Fri, Mar 14, 2008 at 05:26:57PM +0530, Abhijit Hoskeri wrote:
> On Thu, Mar 13, 2008 at 07:28:13AM -0700, Larry Finger wrote:
> > I think your card should be supported. Did you checkout branch
> > everything of Linville's tree, or are you running under the master
> > branch? Issue the command 'git branch' and see which branch has the
> > star. If you have used the master branch, you should issue the command
> > 'git checkout --track -b everything origin/everything' to checkout the
> > proper branch. It will have the latest code including the fix for your
> > 64-bit card. Those devices used to work but a change in the DMA buffer
> > handling elsewhere in the kernel broke them.
>     abhijit at azad:~/src/wireless-testing$ git checkout --track -b everything origin/everything
>     git checkout: updating paths is incompatible with switching branches/forcing
>     Did you intend to checkout 'origin/everything' which can not be resolved as commit?
> 
> Anyway I just did a git-pull and got 2.6.25-rc5-wl. I have built it but not had
> opportunity to test it yet. Is this new enough to work?

Okay this kernel did not work either and has the same behaviour. Did not
really expect this to work, since it may not have the DMA handling fix
Larry talked about above.

-Abhijit


From linville at tuxdriver.com  Fri Mar 14 14:13:33 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 14 Mar 2008 09:13:33 -0400
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <20080314115656.GA32222@deeproot.co.in>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in>
	<47D939FD.5070308@lwfinger.net>
	<20080314115656.GA32222@deeproot.co.in>
Message-ID: <20080314131333.GA3493@tuxdriver.com>

On Fri, Mar 14, 2008 at 05:26:57PM +0530, Abhijit Hoskeri wrote:

>     abhijit at azad:~/src/wireless-testing$ git checkout --track -b everything origin/everything
>     git checkout: updating paths is incompatible with switching branches/forcing
>     Did you intend to checkout 'origin/everything' which can not be resolved as commit?

This was the old practice from before the latest tree organization
(mid-February).

> I am sorry, I do not know enough about git yet to guess what the correct
> incantation should be. 
> 
> Anyway I just did a git-pull and got 2.6.25-rc5-wl. I have built it but not had
> opportunity to test it yet. Is this new enough to work?

This is exactly what you want.

John
-- 
John W. Linville
linville at tuxdriver.com


From Larry.Finger at lwfinger.net  Fri Mar 14 15:49:02 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 14 Mar 2008 07:49:02 -0700
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <20080314131333.GA3493@tuxdriver.com>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in>
	<47D939FD.5070308@lwfinger.net>
	<20080314115656.GA32222@deeproot.co.in>
	<20080314131333.GA3493@tuxdriver.com>
Message-ID: <47DA905E.4020902@lwfinger.net>

John W. Linville wrote:
> On Fri, Mar 14, 2008 at 05:26:57PM +0530, Abhijit Hoskeri wrote:
> 
>>     abhijit at azad:~/src/wireless-testing$ git checkout --track -b everything origin/everything
>>     git checkout: updating paths is incompatible with switching branches/forcing
>>     Did you intend to checkout 'origin/everything' which can not be resolved as commit?
> 
> This was the old practice from before the latest tree organization
> (mid-February).

What is current practice? While I have been on the road, I unsubscribed from wireless and probably
missed any appropriate messages. Does the master branch of wireless-2.6.git now have what used to be
in "everything"?

Larry



From proski at gnu.org  Fri Mar 14 16:36:02 2008
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 14 Mar 2008 11:36:02 -0400
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <47DA905E.4020902@lwfinger.net>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in> <47D939FD.5070308@lwfinger.net>
	<20080314115656.GA32222@deeproot.co.in>
	<20080314131333.GA3493@tuxdriver.com> <47DA905E.4020902@lwfinger.net>
Message-ID: <1205508962.28355.0.camel@dv>

On Fri, 2008-03-14 at 07:49 -0700, Larry Finger wrote:

> What is current practice? While I have been on the road, I unsubscribed from wireless and probably
> missed any appropriate messages. Does the master branch of wireless-2.6.git now have what used to be
> in "everything"?

wireless-testing/master is what used to be wireless-2.6/everything

-- 
Regards,
Pavel Roskin


From linville at tuxdriver.com  Fri Mar 14 16:20:56 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 14 Mar 2008 11:20:56 -0400
Subject: bcm4311 + 2.6.24 + patch gives blinking wireless LED
In-Reply-To: <47DA905E.4020902@lwfinger.net>
References: <20080304055858.GA2537@deeproot.co.in>
	<BAY134-W38EB5FF48DE978848CB137B7100@phx.gbl>
	<20080312154107.GA2696@deeproot.co.in>
	<47D939FD.5070308@lwfinger.net>
	<20080314115656.GA32222@deeproot.co.in>
	<20080314131333.GA3493@tuxdriver.com>
	<47DA905E.4020902@lwfinger.net>
Message-ID: <20080314152056.GA7247@tuxdriver.com>

On Fri, Mar 14, 2008 at 07:49:02AM -0700, Larry Finger wrote:
> John W. Linville wrote:
> > On Fri, Mar 14, 2008 at 05:26:57PM +0530, Abhijit Hoskeri wrote:
> > 
> >>     abhijit at azad:~/src/wireless-testing$ git checkout --track -b everything origin/everything
> >>     git checkout: updating paths is incompatible with switching branches/forcing
> >>     Did you intend to checkout 'origin/everything' which can not be resolved as commit?
> > 
> > This was the old practice from before the latest tree organization
> > (mid-February).
> 
> What is current practice? While I have been on the road, I unsubscribed from wireless and probably
> missed any appropriate messages. Does the master branch of wireless-2.6.git now have what used to be
> in "everything"?

No, but the master branch of wireless-testing.git does.  Please use
that for general development.

Check the News page here:

	http://www.linuxwireless.org/

Hth!

John
-- 
John W. Linville
linville at tuxdriver.com


From johannes at sipsolutions.net  Fri Mar 14 18:02:06 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 14 Mar 2008 18:02:06 +0100
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
In-Reply-To: <6bc534830803131020p34afb1d2kce90a4ab84cd5292@mail.gmail.com>
	(sfid-20080313_174603_381504_73BA7A87)
References: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
	<6bc534830803131020p34afb1d2kce90a4ab84cd5292@mail.gmail.com>
	(sfid-20080313_174603_381504_73BA7A87)
Message-ID: <1205514126.15910.28.camel@johannes.berg>


On Thu, 2008-03-13 at 20:20 +0300, Artem Antonov wrote:
> Does anybody else have such problem?
> btw, I'm using PDA ASUS 696 as a client (if this means anything).
> With 2.4 kernel and binary broadcom driver it seems to work well.
> But I'm not sure, if it's the right place for seeking a solving of my
> problem (becouse it can be also a hostapd bug or mac80211 bug :)
> And I managed to make it work with hostapd and b43 driver a couple
> months ago, but now I can't make it work.

If you did make it work then you certainly had to patch the kernel and
hostapd. You still have to do that.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/2ca5efbe/attachment.pgp>

From artem.v.antonov at gmail.com  Fri Mar 14 18:16:42 2008
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Fri, 14 Mar 2008 20:16:42 +0300
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
In-Reply-To: <1205514126.15910.28.camel@johannes.berg>
References: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
	<6bc534830803131020p34afb1d2kce90a4ab84cd5292@mail.gmail.com>
	<1205514126.15910.28.camel@johannes.berg>
Message-ID: <6bc534830803141016o5ffc5572oc1e5d296e5c39c94@mail.gmail.com>

I've used your pathes for hostapd and mac80211 a couple months ago and it
have been working.
But the code of hostapd and mac80211 has been changed.
So, I've applied your latest patches:

001-beacon-int-hack.patch for hostapd
006-allow-ap-vlan-modes.patch for mac80211

Do I need any patches else? (I'm using hostapd from git and b43&mac80211
form wireless-testing.git)

2008/3/14, Johannes Berg <johannes at sipsolutions.net>:
>
>
> On Thu, 2008-03-13 at 20:20 +0300, Artem Antonov wrote:
> > Does anybody else have such problem?
> > btw, I'm using PDA ASUS 696 as a client (if this means anything).
> > With 2.4 kernel and binary broadcom driver it seems to work well.
> > But I'm not sure, if it's the right place for seeking a solving of my
> > problem (becouse it can be also a hostapd bug or mac80211 bug :)
> > And I managed to make it work with hostapd and b43 driver a couple
> > months ago, but now I can't make it work.
>
>
> If you did make it work then you certainly had to patch the kernel and
> hostapd. You still have to do that.
>
>
> johannes
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/17f2511f/attachment.html>

From johannes at sipsolutions.net  Fri Mar 14 18:19:13 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 14 Mar 2008 18:19:13 +0100
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
In-Reply-To: <6bc534830803141016o5ffc5572oc1e5d296e5c39c94@mail.gmail.com>
	(sfid-20080314_171645_967082_34EB00BB)
References: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
	<6bc534830803131020p34afb1d2kce90a4ab84cd5292@mail.gmail.com>
	<1205514126.15910.28.camel@johannes.berg>
	<6bc534830803141016o5ffc5572oc1e5d296e5c39c94@mail.gmail.com>
	(sfid-20080314_171645_967082_34EB00BB)
Message-ID: <1205515153.15910.30.camel@johannes.berg>


On Fri, 2008-03-14 at 20:16 +0300, Artem Antonov wrote:
> I've used your pathes for hostapd and mac80211 a couple months ago and
> it have been working.
> But the code of hostapd and mac80211 has been changed.
> So, I've applied your latest patches:
> 
> 001-beacon-int-hack.patch for hostapd
> 006-allow-ap-vlan-modes.patch for mac80211
> 
> Do I need any patches else? (I'm using hostapd from git and
> b43&mac80211 form wireless-testing.git)

That should work. Haven't tried for quite a while and the b43 driver
seems to have problems with beaconing currently.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/f180152b/attachment.pgp>

From netrolller.3d at gmail.com  Fri Mar 14 20:09:56 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Fri, 14 Mar 2008 20:09:56 +0100
Subject: HELP BROADCOM bcm43xxx driver instalation on mandriva 2006
In-Reply-To: <9c84f24c0803111803o2db70192yf1777a722fff5bfa@mail.gmail.com>
References: <9c84f24c0803111803o2db70192yf1777a722fff5bfa@mail.gmail.com>
Message-ID: <69e28c910803141209k3fa9f14fh3e2a4ef22c8442de@mail.gmail.com>

"bcm43xx not found" means either that your kernel is too old (made before
bcm43xx landed) or "too" new (the driver is now called b43). Try cutting the
firmware with b43-fwcutter from the 4.80 firmware file on linuxwireless (NOT
from your driver file!), then modprobing b43 (instead of bcm43xx). If b43 is
also missing, then you have to compile a new kernel.

On Wed, Mar 12, 2008 at 2:03 AM, lowdown <golemkroasan at gmail.com> wrote:

> I'm trying to install bcm43xxx driver for mandriva, here are the steps:
> (Before  cutting the windows diriver and "make installfw" there wasn't
> directory in  /lib/ named firmware, is there anythig with default
> firmwire directory.
> Somwhre i've read that mandriva default firmware directory is
> /lib/firmware/ but the directory firmwire was't there before commnad
> "make installfw")
>
> ./bcm43xx-fwcutter /home/kristijan/Desktop/broadcom\
> 4318/R102320/bcmwl5*.sys
>
> filename : bcmwl5.sys
> version : 3.120.27.0
> MD5 : 8d49f11238815a320880fee9f98b2c92
> microcodes : 2 4 5
> pcms : 4 5
>
> microcode : 2
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> microcode : 4
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> microcode : 5
> revision : 0x0123
> patchlevel : 0x0023
> date : 2005-03-22
> time : 00:11:18
>
> extracting bcm43xx_microcode2.fw ...
> extracting bcm43xx_microcode4.fw ...
> extracting bcm43xx_microcode5.fw ...
> extracting bcm43xx_pcm4.fw ...
> extracting bcm43xx_pcm5.fw ...
> extracting bcm43xx_initval01.fw ...
> extracting bcm43xx_initval02.fw ...
> extracting bcm43xx_initval03.fw ...
> extracting bcm43xx_initval04.fw ...
> extracting bcm43xx_initval05.fw ...
> extracting bcm43xx_initval06.fw ...
> extracting bcm43xx_initval07.fw ...
> extracting bcm43xx_initval08.fw ...
> extracting bcm43xx_initval09.fw ...
> extracting bcm43xx_initval10.fw ...
> [root at DARKSTAR bcm43xx-fwcutter-006]# make installfw
> if ! [ -d /lib/firmware ]; then mkdir -p /lib/firmware; fi
> install -o 0 -g 0 -m 600 bcm43xx_*.fw /lib/firmware
> root at DARKSTAR bcm43xx-fwcutter-006]# lsmod | grep bcm43xx
> [root at DARKSTAR bcm43xx-fwcutter-006]#
> [root at DARKSTAR bcm43xx-fwcutter-006]# modprobe bcm43xx
> FATAL: Module bcm43xx not found.
>
> What i'm doing wrong, any ideas?
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/ff7269f2/attachment.html>

From netrolller.3d at gmail.com  Fri Mar 14 20:30:00 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Fri, 14 Mar 2008 20:30:00 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
Message-ID: <69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>

Hi all and let me repost my previous question again (with a few more
updates, also directly to Linville, as well as to the list) as I STILL got
no answer for it (Don't ignore it this time!):


I have a strange problem with my Asus WL-138G V2 (which is AFAIK a BCM4318
non-E card). It works fine with bcm43xx (since 2.6.22, works with 2.6.24's
bcm43xx too), but not with b43. I can scan without problems (iwlist scan
works, knetworkmanager lists networks properly), monitor mode works with
kismet (both on main interface and on a dedicated rfmon interface), but I
can't associate (authenticate timeout). Radiotap injection also doesn't
work, packetspammer doesn't complain about errors, but there is nothing
actually sent out. Basically, anything that involves transmitting is broken,
while receiving works fine.
I have tried with the following kernel+firmware combos (all 2.6.24 kernels
were opensuse-pae, while the 2.6.24.1 one was opensuse-default, tried
2.6.25-rc3 in both vanilla and opensuse-pae flavors since my previous post,
neither worked):

-kernel 2.6.24+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24.1+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.80.53 "wl_apsta_mimo.o"
-kernel 2.6.24+compat-wireless-2.6+firmware 4.150.10.5 "wl_apsta_mimo.o"
-kernel 2.6.25-rc3 (vanilla and opensuse-pae)+firmware 4.80.53 "wl_apsta.o"
-a recent wireless-testing kernel with opensuse patches+firmware
4.80.53"wl_apsta.o" (I only used this kernel for one day, as it messed
up my
ReiserFS root partition, had to reiserfsck --fix-fixable to regain 18
gigabytes of free space that was somehow marked as used - maybe I got my
config wrong, or the 2.6.25-rc opensuse reiser patches don't like
wireless-testing).

All produced the same error.
(Strangely, the wireless-testing git kernel showed this error with a ZD1211B
and an RT73 USB stick, not just with my Broadcom PCI, so it might be a
mac80211 issue.)
I will post my dmesg output if needed, but I can see no error messages from
the driver in it (even though I have enabled b43 and mac80211 debugging in
the compat-wireless config.mk file), only a message about "authentication
timed out". The message is the same for unencrypted, WEP104 open and
WPA-PSK. I haven't tested WPA-EAP and WPA2-EAP as I don't have the needed
hardware (no RADIUS), but I can test WEP40 open, WEP shared (both 40 and
104), 802.1X, WPA2-PSK and mixed-mode (v1+v2) WPA-PSK. (It might be
interesting that while bcm43xx reported by card power levels as 15dBm,
2.6.24(.1)'s b43 (just like 2.6.25-rc3's one) reports it as 27dBm (which is
IMHO a bit high, as that would be 400mW, while the card has an output of
about 20mW - again, bcm43xx reports it as 15dBm!), and compat-wireless-2.6's
b43 reports 0dBm, yes, 0dBm, just like the wireless-testing git kernel.
That's quite odd. But it appears that compat-wireless-2.6 is right about the
transmit power. :-)

Is this a known bug? What can I do about it?
Thanks,
.NetRolller 3D

P.S. Please answer, I don't want to repost again! This time really!
P.P.S. Don't ignore this message! I can't stress it enough, I need an
answer!

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/6acf71ea/attachment.html>

From slipszi at gmail.com  Fri Mar 14 21:19:18 2008
From: slipszi at gmail.com (Silvester Erdeg)
Date: Fri, 14 Mar 2008 21:19:18 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
Message-ID: <ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>

On Fri, Mar 14, 2008 at 8:30 PM, Stefanik G?bor <netrolller.3d at gmail.com> wrote:
> Hi all and let me repost my previous question again (with a few more
> updates, also directly to Linville, as well as to the list) as I STILL got
> no answer for it (Don't ignore it this time!):

I have the exact same problem as described by Gabor. I have also tried
most of the things mentioned in Gabor's post, without success. I am
willing to try any patch or advice to solve this problem. Thanks in
advance!

Szilveszter


From artem.v.antonov at gmail.com  Fri Mar 14 21:36:15 2008
From: artem.v.antonov at gmail.com (Artem Antonov)
Date: Fri, 14 Mar 2008 23:36:15 +0300
Subject: BCM4318 (ASUS WL-500gP) & hostapd problem
In-Reply-To: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
References: <6bc534830803091455g7fb1739me3f83fc1826acac6@mail.gmail.com>
Message-ID: <6bc534830803141336y3616d361rb1d7b563601d5818@mail.gmail.com>

btw, in Ad-Hoc mode it seems to work, but i get some errors:

b43-phy4: Broadcom 4318 WLAN found
b43-phy4 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy4 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
b43-phy4 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
phy4: Selected rate control algorithm 'pid'
Broadcom 43xx driver loaded [ Features: N, Firmware-ID: FW13 ]
wlan0: Trigger new scan to find an IBSS to join
b43-phy4: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy4 debug: Chip initialized
b43-phy4 debug: 32-bit DMA initialized
b43-phy4 debug: Wireless interface started
b43-phy4 debug: Adding Interface type 3
phy4: Adding new IBSS station 00:1b:fc:f2:49:b2 (dev=wlan0)
WARNING: at
/usr/src2/openwrt/trunk/build_dir/linux-brcm47xx/mac80211/net/mac80211/ieee80211_rate.h:153
rate_lowest_index()
Call
Trace:[<8000a344>][<8000a344>][<c00f5da0>][<c00e15e0>][<802077c0>][<c00ed114>][<c0159b9c>][<8001e278>][<80105120>][<c00ef1dc>][<8016d6c8>][<8016d87c>][<80179d4c>][<80105120>][<80177f78>][<c00f0000>][<c00da9b8>][<8002b568>][<8004b1e0>][<8002afb0>][<8004d170>][<8002b094>][<80001d44>][<80003e44>][<800038f4>][<8017cff0>][<80006000>][<80006000>][<800fdfd4>][<80263d4c>][<80263198>]
wlan0: Trigger new scan to find an IBSS to join
wlan0: Creating new IBSS network, BSSID 22:08:a1:65:b7:fc
RTNL: assertion failed at
/usr/src2/openwrt/trunk/build_dir/linux-brcm47xx/mac80211/net/mac80211/sta_info.c
(140)
Call
Trace:[<8000a344>][<8000a344>][<c00dd7a4>][<c00dd724>][<c00dda4c>][<8001f634>][<c00e1f5c>][<80074b58>][<c00e281c>][<c00e4148>][<8016d6c8>][<8001dd90>][<c00e3770>][<80181e08>][<c00e46a0>][<8001c9d4>][<80037b4c>][<80037b4c>][<800388f4>][<8021173c>][<8003d1b0>][<80038838>][<8003ce9c>][<8003ce80>][<80005d50>][<80005d40>]
RTNL: assertion failed at
/usr/src2/openwrt/trunk/build_dir/linux-brcm47xx/mac80211/net/mac80211/key.c
(275)
Call
Trace:[<8000a344>][<8000a344>][<c00f38f8>][<c00dd7b4>][<c00dd724>][<c00dda4c>][<8001f634>][<c00e1f5c>][<80074b58>][<c00e281c>][<c00e4148>][<8016d6c8>][<8001dd90>][<c00e3770>][<80181e08>][<c00e46a0>][<8001c9d4>][<80037b4c>][<80037b4c>][<800388f4>][<8021173c>][<8003d1b0>][<80038838>][<8003ce9c>][<8003ce80>][<80005d50>][<80005d40>]
wlan0: Configured IBSS beacon template
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
phy4: Adding new IBSS station 00:1b:fc:f2:49:b2 (dev=wlan0)
wlan0: expiring inactive STA 00:1b:fc:f2:49:b2
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
phy4: Adding new IBSS station 00:1b:fc:f2:49:b2 (dev=wlan0)
device wlan0 entered promiscuous mode
br-lan: port 2(wlan0) entering learning state
br-lan: topology change detected, propagating
br-lan: port 2(wlan0) entering forwarding state
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
b43-phy4 ERROR: PHY transmission error
......
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
wlan0: expiring inactive STA 00:1b:fc:f2:49:b2
wlan0: No active IBSS STAs - trying to scan for other IBSS networks with
same SSID (merge)
b43-phy4 debug: Removing Interface type 3
b43-phy4 debug: Wireless interface stopped
b43-phy4 debug: DMA-32 rx_ring: Used slots 5/64, Failed frames 0/0 = 0.0%,
Average tries 0.00
b43-phy4 debug: DMA-32 tx_ring_AC_BK: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
b43-phy4 debug: DMA-32 tx_ring_AC_BE: Used slots 48/128, Failed frames
13/1280 = 1.0%, Average tries 1.36
b43-phy4 debug: DMA-32 tx_ring_AC_VI: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
b43-phy4 debug: DMA-32 tx_ring_AC_VO: Used slots 20/128, Failed frames 3/198
= 1.5%, Average tries 1.12
b43-phy4 debug: DMA-32 tx_ring_mcast: Used slots 0/128, Failed frames 0/0 =
0.0%, Average tries 0.00
br-lan: port 2(wlan0) entering disabled state
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080314/289ab023/attachment.html>

From d.g.jansen at googlemail.com  Fri Mar 14 23:55:28 2008
From: d.g.jansen at googlemail.com (D. Jansen)
Date: Fri, 14 Mar 2008 23:55:28 +0100
Subject: b43 and 4311 connection problems under Kubuntu 7.10 kernel
	2.6.24-vanilla x64
In-Reply-To: <e678b6ed0803071515n711ef74by9cb9ccfa7af10f8c@mail.gmail.com>
References: <e678b6ed0803071515n711ef74by9cb9ccfa7af10f8c@mail.gmail.com>
Message-ID: <e678b6ed0803141555v2679629dga1f8c3ad3a0ca3eb@mail.gmail.com>

Hey, I've had a lot of connection problems with b43.
 bcm43xx didn't work for me either under 2.6.24.
Now with 2.6.24.3 it's working flawlessly.

 My configuration
Acer Extensa 5220
 Kubuntu Gutsy x64 7.10
 Linux * 2.6.24.2(vanilla) #10 PREEMPT * x86_64 GNU/Linux

 wpa_supplicant-0.5.9 from source

 the tests were all made several times,
 without moving the laptop
 connection quality 55-60
 scan_ssid is active in wpa_supplicant.conf for faster association

 with b43 from wireless-compat(v2.6.25-rc3-1062-g7db6747)
 (and new firmware v.4.150.10.5)
 a card and firmware load message appears in dmesg,
 but nothing else and the card is not shown in ifconfig -a

 b43 from 2.6.24 and old firmware
 card shown but always association time out
 constant messages authentication packet received, but
 not in authentication state, packet ignored

 with b43 from older wireless-compat (v2.6.24-818-gd86916b)
 (and new firmware v.4.150.10.5)
 association fine (wpa_supplicant says "COMPLETED"), but
 no packets coming through afterwards,

 with b43 from older wireless-compat (v2.6.24-818-gd86916b)
 (and new firmware v.4.150.10.5)
 and nohwcrypt=1
 association fine, and connection fine at first,
 but only a few packets come through and only at
 the beginning (about 3-5 pings/7 seconds), then maybe one more,
 then no connection at all. have to reset several times
 with intensive trying, about after 20-30 retries,
 reloading the module with each try
 a connection sometimes works for about 30-60 minutes,
 than hangs again. without moving the notebook.
 below 56, connection drops.

 under windows and with ndiswrapper and
Wireless_Broadcom_4311_v4.100.15.5_XP.zip
 association fine, connection fine. tx-power 32 dB (instead of 18/27 i think)
 signal quality shown between 15-22, below 15, connection drops

now with kernel 2.6.24.3 it's working flawlessly. without nohwcrypt as well :)

If someone wants to find out why this happened - what information will
be needed?

Cheers


From netrolller.3d at gmail.com  Sat Mar 15 14:19:44 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 15 Mar 2008 14:19:44 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
Message-ID: <69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>

Wait, are you Hungarian too? Looks like b43 specifically hates 4318/02s
designed for the EU (13 channel versions). Someone from the USA should
confirm, this looks more and more like a mac80211 bug. (Note: my AP is on
channel 1, so it's not in the EU-only range.) Also, are there any records of
an EU 4318/02 user getting b43 to work? Japan might also be of interest.
Someone should also try loading mac80211 (or cfg80211 on the
wireless-testing tree) with ieee80211_regdom=64 to see if that helps. (I
can't, as my OpenSUSE box died.)

On Fri, Mar 14, 2008 at 9:19 PM, Silvester Erdeg <slipszi at gmail.com> wrote:

> On Fri, Mar 14, 2008 at 8:30 PM, Stefanik G?bor <netrolller.3d at gmail.com>
> wrote:
> > Hi all and let me repost my previous question again (with a few more
> > updates, also directly to Linville, as well as to the list) as I STILL
> got
> > no answer for it (Don't ignore it this time!):
>
> I have the exact same problem as described by Gabor. I have also tried
> most of the things mentioned in Gabor's post, without success. I am
> willing to try any patch or advice to solve this problem. Thanks in
> advance!
>
> Szilveszter
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080315/ba4dc185/attachment.html>

From linville at tuxdriver.com  Sat Mar 15 15:35:31 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Sat, 15 Mar 2008 10:35:31 -0400
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
	associate using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
Message-ID: <20080315143531.GA5019@tuxdriver.com>

On Sat, Mar 15, 2008 at 02:19:44PM +0100, Stefanik G?bor wrote:
> Wait, are you Hungarian too? Looks like b43 specifically hates 4318/02s
> designed for the EU (13 channel versions). Someone from the USA should
> confirm, this looks more and more like a mac80211 bug. (Note: my AP is on
> channel 1, so it's not in the EU-only range.) Also, are there any records of
> an EU 4318/02 user getting b43 to work? Japan might also be of interest.
> Someone should also try loading mac80211 (or cfg80211 on the
> wireless-testing tree) with ieee80211_regdom=64 to see if that helps. (I
> can't, as my OpenSUSE box died.)

Hmmm...that is an interesting thought.  I'll have to give that a try.

BTW, with the wireless-testing tree it is:

	options cfg80211 ieee80211_regdom="JP"

whereas the older trees had it as:

	options mac80211 ieee80211_regdom=64

Hth!

John
-- 
John W. Linville
linville at tuxdriver.com


From johannes at sipsolutions.net  Sun Mar 16 10:24:48 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 16 Mar 2008 10:24:48 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
	associate using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	(sfid-20080315_133236_485132_4AA5ADAC)
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	(sfid-20080315_133236_485132_4AA5ADAC)
Message-ID: <1205659488.15910.55.camel@johannes.berg>


On Sat, 2008-03-15 at 14:19 +0100, Stefanik G?bor wrote:
> Wait, are you Hungarian too? Looks like b43 specifically hates
> 4318/02s designed for the EU (13 channel versions). 

Nah. The hardware is identical, regulatory enforcement is done in
software.

> Someone from the USA should confirm, this looks more and more like a
> mac80211 bug. (Note: my AP is on channel 1, so it's not in the EU-only
> range.) Also, are there any records of an EU 4318/02 user getting b43
> to work? Japan might also be of interest. Someone should also try
> loading mac80211 (or cfg80211 on the wireless-testing tree) with
> ieee80211_regdom=64 to see if that helps. (I can't, as my OpenSUSE box
> died.)

You currently can't use channels 12/13 with mac80211, but that shouldn't
matter if your AP is on channel 1.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080316/4d9cf3bd/attachment.pgp>

From netrolller.3d at gmail.com  Mon Mar 17 11:09:02 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 17 Mar 2008 11:09:02 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <1205659488.15910.55.camel@johannes.berg>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<1205659488.15910.55.camel@johannes.berg>
Message-ID: <69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>

Not sure if it's related, but I have read somewhere that 4318/02 requires
wl_apsta.o when using fw4.80.53, it doesn't work with wl_apsta_mimo.o from
the same package. Maybe it would be a good idea to add support for the new
wl_apsta.o (as opposed to wl_apsta_mimo.o) to fwcutter (or make fwcutter use
search-and-cut instead of hardcoded offsets, making it compatible with
future firmware files). Possibly wl_apsta_mimo.o still doesn't support
4318/02.

On Sun, Mar 16, 2008 at 10:24 AM, Johannes Berg <johannes at sipsolutions.net>
wrote:

>
> On Sat, 2008-03-15 at 14:19 +0100, Stefanik G?bor wrote:
> > Wait, are you Hungarian too? Looks like b43 specifically hates
> > 4318/02s designed for the EU (13 channel versions).
>
> Nah. The hardware is identical, regulatory enforcement is done in
> software.
>

Um... not really. WL-138G V2 includes a hardware limit that prevents
switching to forbidden channels. Regardless of REGDOM, you won't be able to
switch to channel 14 (except maybe if you hack the SPROM, possibly the HW
regulatory domain setting is stored there, but it might also be embedded on
the chip) on a non-JP card. Not sure about other 4318/02 brands though. (I
suspect that this hardware lockout is the one that conflicts with mac80211,
although it might be unrelated, as I got this error on the wireless-testing
tree with an RalinkTech 2573 AKA RT73 USB dongle as well.) Possibly USA
versions don't have this lockout, but EU versions do. (Even the old bcm43xx
gives "Operation not permitted" regardless of REGDOM for iwconfig <card>
channel 14.)


>
> > Someone from the USA should confirm, this looks more and more like a
> > mac80211 bug. (Note: my AP is on channel 1, so it's not in the EU-only
> > range.) Also, are there any records of an EU 4318/02 user getting b43
> > to work? Japan might also be of interest. Someone should also try
> > loading mac80211 (or cfg80211 on the wireless-testing tree) with
> > ieee80211_regdom=64 to see if that helps. (I can't, as my OpenSUSE box
> > died.)
>
> You currently can't use channels 12/13 with mac80211, but that shouldn't
> matter if your AP is on channel 1.
>
I suspect that if the card has a hardware-level 13-channel limit, then
mac80211 doesn't work with it at all, regardless of channel. It receives,
but doesn't transmit, maybe a safety feature in the hw/fw to avoid
transmitting on disallowed channels.

>
> johannes
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/342b07f4/attachment.html>

From johannes at sipsolutions.net  Mon Mar 17 11:19:09 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 17 Mar 2008 11:19:09 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
	associate using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>
	(sfid-20080317_100907_022654_FC3C6D96)
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<1205659488.15910.55.camel@johannes.berg>
	<69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>
	(sfid-20080317_100907_022654_FC3C6D96)
Message-ID: <1205749149.1614.20.camel@johannes.berg>


On Mon, 2008-03-17 at 11:09 +0100, Stefanik G?bor wrote:
> Not sure if it's related, but I have read somewhere that 4318/02
> requires wl_apsta.o when using fw4.80.53, it doesn't work with
> wl_apsta_mimo.o from the same package.

There are lots of rumors, but they are all false.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/f580870e/attachment.pgp>

From netrolller.3d at gmail.com  Mon Mar 17 12:36:52 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 17 Mar 2008 12:36:52 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <1205749149.1614.20.camel@johannes.berg>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<1205659488.15910.55.camel@johannes.berg>
	<69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>
	<1205749149.1614.20.camel@johannes.berg>
Message-ID: <69e28c910803170436m439fcab0i14910a2748288ff8@mail.gmail.com>

If you also meant this to be an answer for the regdom lockout, then all I
can say is that I haven't read that on the web, it's what I am seeing. With
the bcm43xx driver (that works to some extent), I can switch to channels
1-13, but not 14, even if the regulatory domain is set to Japan. It gives
"Operation not permitted". Possibly this is Asus-specific (and not present
on other 4318/02-based cards), and maybe it is only present in EU versions
(so US and JP versions are identical).

BTW, what's the ieee80211_regdom code for the EU? Is 64 EU or JP?
On Mon, Mar 17, 2008 at 11:19 AM, Johannes Berg <johannes at sipsolutions.net>
wrote:

>
> On Mon, 2008-03-17 at 11:09 +0100, Stefanik G?bor wrote:
> > Not sure if it's related, but I have read somewhere that 4318/02
> > requires wl_apsta.o when using fw4.80.53, it doesn't work with
> > wl_apsta_mimo.o from the same package.
>
> There are lots of rumors, but they are all false.
>
> johannes
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/db099d24/attachment.html>

From netrolller.3d at gmail.com  Mon Mar 17 13:22:02 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 17 Mar 2008 13:22:02 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <1205754126.1614.36.camel@johannes.berg>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<1205659488.15910.55.camel@johannes.berg>
	<69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>
	<1205749149.1614.20.camel@johannes.berg>
	<69e28c910803170436m439fcab0i14910a2748288ff8@mail.gmail.com>
	<1205754126.1614.36.camel@johannes.berg>
Message-ID: <69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>

I got that with bcm43xx (not b43!), which is ieee80211-softmac-based. AFAIK
that defaults to Japan, yet it doesn't let me switch to channel 14. Channel
13 works fine, though. (In bcm43xx. In b43, nothing works.) (This message is
a repost of my previous message that I accidentally sent to Johannes Berg
only.)

On Mon, Mar 17, 2008 at 12:42 PM, Johannes Berg <johannes at sipsolutions.net>
wrote:

>
> On Mon, 2008-03-17 at 12:36 +0100, Stefanik G?bor wrote:
> > If you also meant this to be an answer for the regdom lockout, then
> > all I can say is that I haven't read that on the web, it's what I am
> > seeing. With the bcm43xx driver (that works to some extent), I can
> > switch to channels 1-13, but not 14, even if the regulatory domain is
> > set to Japan. It gives "Operation not permitted". Possibly this is
> > Asus-specific (and not present on other 4318/02-based cards), and
> > maybe it is only present in EU versions (so US and JP versions are
> > identical).
>
> Ahrg. I don't get why people think that this is related to the firmware.
> It's cfg80211's fault because it defaults to the US domain.
>
> johannes
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/4a9f7286/attachment.html>

From johannes at sipsolutions.net  Mon Mar 17 12:42:06 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 17 Mar 2008 12:42:06 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
	associate using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803170436m439fcab0i14910a2748288ff8@mail.gmail.com>
	(sfid-20080317_113658_616967_ABEE6923)
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<1205659488.15910.55.camel@johannes.berg>
	<69e28c910803170309jabbc015u9b9bb726cdc5c840@mail.gmail.com>
	<1205749149.1614.20.camel@johannes.berg>
	<69e28c910803170436m439fcab0i14910a2748288ff8@mail.gmail.com>
	(sfid-20080317_113658_616967_ABEE6923)
Message-ID: <1205754126.1614.36.camel@johannes.berg>


On Mon, 2008-03-17 at 12:36 +0100, Stefanik G?bor wrote:
> If you also meant this to be an answer for the regdom lockout, then
> all I can say is that I haven't read that on the web, it's what I am
> seeing. With the bcm43xx driver (that works to some extent), I can
> switch to channels 1-13, but not 14, even if the regulatory domain is
> set to Japan. It gives "Operation not permitted". Possibly this is
> Asus-specific (and not present on other 4318/02-based cards), and
> maybe it is only present in EU versions (so US and JP versions are
> identical).

Ahrg. I don't get why people think that this is related to the firmware.
It's cfg80211's fault because it defaults to the US domain.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/e1046259/attachment.pgp>

From mb at bu3sch.de  Mon Mar 17 13:29:16 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 17 Mar 2008 13:29:16 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<1205754126.1614.36.camel@johannes.berg>
	<69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>
Message-ID: <200803171329.16867.mb@bu3sch.de>

On Monday 17 March 2008 13:22:02 Stefanik G?bor wrote:
> I got that with bcm43xx (not b43!), which is ieee80211-softmac-based. AFAIK
> that defaults to Japan, yet it doesn't let me switch to channel 14. Channel
> 13 works fine, though. (In bcm43xx. In b43, nothing works.) (This message is
> a repost of my previous message that I accidentally sent to Johannes Berg
> only.)

The hardware does not limit the channel. The firmware hardly knows about
the current channel anyway. It just makes sure that packets are transmitted on
the currently selected channel. No matter which one that is.

But what does it mean when you say "it doesn't let me switch to channel 14"?
Does it return an error code, or does iwconfig report success, but it doesn't
_work_ on channel 14? That would make a major difference to debug this problem.

-- 
Greetings Michael.


From netrolller.3d at gmail.com  Mon Mar 17 14:57:53 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 17 Mar 2008 14:57:53 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <200803171329.16867.mb@bu3sch.de>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<1205754126.1614.36.camel@johannes.berg>
	<69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>
	<200803171329.16867.mb@bu3sch.de>
Message-ID: <69e28c910803170657t5de8a3e2h5782960fe9cd7bae@mail.gmail.com>

Here is what I get:
With the old bcm43xx (softmac) driver, iwconfig returns "Operation not
permitted" for "iwconfig <card> channel 14". Kismet's backend process
crashes if I set its channel hopping range to include channel 14.
NetworkManager and iwlist scan doesn't scan on ch14. Channels 12 and 13 are
not affected, only the Japanese channel 14. Channels 1 through 13 work fine,
I can scan, associate, transmit, receive, even monitor mode works.

With the new mac80211 driver (b43), things are a bit more complicated: When
mac80211 (or cfg80211 on wireless-testing) is loaded without
ieee80211_regdom, iwconfig goes up to channel 11, after that, "Operation not
permitted". Kismet doesn't crash though, it just prints an error when it
tries to switch to a channel over 11. NetworkManager and iwlist scan skips
channels 12, 13 and 14. Loading {mac|cfg}80211 with ieee80211_regdom=64
(which is Japan AFAIK, so it should allow 14 channels) makes channels 12 and
13 work to some extent, but not channel 14. Iwconfig works up to ch13, while
ch14 gives "Operation not permitted". Kismet goes into channel 12 and 13
nicely, but crashes on channel 14. (It doesn't crash, only throws an error
when {mac|cfg}80211 is loaded without ieee80211_regdom.)
Iwlist/NetworkManager scan like with bcm43xx. The different errors of Kismet
suggest a regional lockout on the hardware, which is likely specific to this
card, and not present on non-Asus 4318s. Maybe there is a protection/"cop"
chip connected to the radio, I don't know as I haven't removed the cover of
the radio.

However, this is a heavy digression from the thread's topic. The biggest
problem is that regardless of ieee80211_regdom, only scanning and monitor
mode (that is, tasks that only require receiving data, not transmitting)
work, anything that requires transmitting (association, packet injection
with Packetspammer, software AP mode) is broken. The card's LED doesn't show
activity when it tries to transmit, and I fail to capture Packetspammer's
test packets on another interface. When trying to associate, dmesg shows
"Authentication with <BSSID>" 3 or 4 times, then "Authentication with
<BSSID> timed out". No "PHY Transmission Error"s, and in general, no b43
errors (or even warnings) show up, even if I compile b43 with debugging
enabled. This error shows up with all kernels I tested, including
wireless-testing and 2.6.24. This might be a mac80211 problem, as on
wireless-testing, a similar error affected my rt73 USB dongle. Judging from
the fact that the card's LED doesn't blink while transmitting/trying to
transmit (as it does on Windows), even though I compiled my kernel with LED
support enabled, I suspect that the card doesn't even try to transmit. The
problem is not unique to me, as Szilveszter Erdeg (another Hungarian, with
an EU WL-138G V2) has the same problem. Likely the US version of the 138G is
identical to the Japanese one, only the EU version has the lockout, so the 2
problems might be related.

On Mon, Mar 17, 2008 at 1:29 PM, Michael Buesch <mb at bu3sch.de> wrote:

> On Monday 17 March 2008 13:22:02 Stefanik G?bor wrote:
> > I got that with bcm43xx (not b43!), which is ieee80211-softmac-based.
> AFAIK
> > that defaults to Japan, yet it doesn't let me switch to channel 14.
> Channel
> > 13 works fine, though. (In bcm43xx. In b43, nothing works.) (This
> message is
> > a repost of my previous message that I accidentally sent to Johannes
> Berg
> > only.)
>
> The hardware does not limit the channel. The firmware hardly knows about
> the current channel anyway. It just makes sure that packets are
> transmitted on
> the currently selected channel. No matter which one that is.
>
> But what does it mean when you say "it doesn't let me switch to channel
> 14"?
> Does it return an error code, or does iwconfig report success, but it
> doesn't
> _work_ on channel 14? That would make a major difference to debug this
> problem.
>
> --
> Greetings Michael.
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/a08811d2/attachment.html>

From johannes at sipsolutions.net  Mon Mar 17 15:18:49 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 17 Mar 2008 15:18:49 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
	associate using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803170657t5de8a3e2h5782960fe9cd7bae@mail.gmail.com>
	(sfid-20080317_135755_731690_3733A808)
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<1205754126.1614.36.camel@johannes.berg>
	<69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>
	<200803171329.16867.mb@bu3sch.de>
	<69e28c910803170657t5de8a3e2h5782960fe9cd7bae@mail.gmail.com>
	(sfid-20080317_135755_731690_3733A808)
Message-ID: <1205763529.1614.103.camel@johannes.berg>


> With the old bcm43xx (softmac) driver, iwconfig returns "Operation not
> permitted" for "iwconfig <card> channel 14". Kismet's backend process
> crashes if I set its channel hopping range to include channel 14.
> NetworkManager and iwlist scan doesn't scan on ch14. Channels 12 and
> 13 are not affected, only the Japanese channel 14. Channels 1 through
> 13 work fine, I can scan, associate, transmit, receive, even monitor
> mode works.

To be honest, both bcm43xx and ieee80211softmac have been removed from
the kernel so nobody cares about channel 14 not being available there.

> When mac80211 (or cfg80211 on wireless-testing) is loaded without
> ieee80211_regdom, iwconfig goes up to channel 11, after that,
> "Operation not permitted". Kismet doesn't crash though, it just prints
> an error when it tries to switch to a channel over 11. NetworkManager
> and iwlist scan skips channels 12, 13 and 14. Loading {mac|cfg}80211
> with ieee80211_regdom=64 (which is Japan AFAIK, so it should allow 14
> channels) makes channels 12 and 13 work to some extent, but not
> channel 14. 

You have to load cfg80211 with ieee80211_regdom=JP, it's a character
string now, using =64 will just get you US again and even 12 and 13
won't work. I just tried, and channel 14 works flawlessly.

> Iwconfig works up to ch13, while ch14 gives "Operation not permitted".

You get operation not permitted when your configured regdomain doesn't
include the channel you want. I also don't believe you that you get
channels 12 and 13 when loading cfg80211 with ieee80211_regdom=64, that
will get you only channels 1-11.

>  Kismet goes into channel 12 and 13 nicely, but crashes on channel 14.

Sounds like a kismet bug.

> The different errors of Kismet suggest a regional lockout on the
> hardware, which is likely specific to this card, and not present on
> non-Asus 4318s. Maybe there is a protection/"cop" chip connected to
> the radio, I don't know as I haven't removed the cover of the radio.

Nope. There is no such thing. You cannot get an -EPERM error from the
b43 driver.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/30826783/attachment.pgp>

From netrolller.3d at gmail.com  Mon Mar 17 15:43:15 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 17 Mar 2008 15:43:15 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803170740u24f91787x50028e5c276ac2f5@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<1205754126.1614.36.camel@johannes.berg>
	<69e28c910803170522o5c901ca1vb837321096b6cd8b@mail.gmail.com>
	<200803171329.16867.mb@bu3sch.de>
	<69e28c910803170657t5de8a3e2h5782960fe9cd7bae@mail.gmail.com>
	<1205763529.1614.103.camel@johannes.berg>
	<69e28c910803170740u24f91787x50028e5c276ac2f5@mail.gmail.com>
Message-ID: <69e28c910803170743i30c7c421i1dbc600a52f1f44b@mail.gmail.com>

Oops. I clicked "Reply" instead of "Reply to all". Forwarded to list.

---------- Forwarded message ----------
From: Stefanik G?bor <netrolller.3d at gmail.com>
Date: Mon, Mar 17, 2008 at 3:40 PM
Subject: Re: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't
associate using b43 driver, works with bcm43xx
To: Johannes Berg <johannes at sipsolutions.net>


Something I forgot: I'm using OpenSUSE.
Also, I think it's more important to solve the no-transmit problem than the
channel 14 one, so let's not digress too much.

Some more comments are in the text.
On Mon, Mar 17, 2008 at 3:18 PM, Johannes Berg <johannes at sipsolutions.net>
wrote:

>
> > With the old bcm43xx (softmac) driver, iwconfig returns "Operation not
> > permitted" for "iwconfig <card> channel 14". Kismet's backend process
> > crashes if I set its channel hopping range to include channel 14.
> > NetworkManager and iwlist scan doesn't scan on ch14. Channels 12 and
> > 13 are not affected, only the Japanese channel 14. Channels 1 through
> > 13 work fine, I can scan, associate, transmit, receive, even monitor
> > mode works.
>
> To be honest, both bcm43xx and ieee80211softmac have been removed from
> the kernel so nobody cares about channel 14 not being available there.
>

I know, just I wrote it down to be comparable to the new driver.

>
> > When mac80211 (or cfg80211 on wireless-testing) is loaded without
> > ieee80211_regdom, iwconfig goes up to channel 11, after that,
> > "Operation not permitted". Kismet doesn't crash though, it just prints
> > an error when it tries to switch to a channel over 11. NetworkManager
> > and iwlist scan skips channels 12, 13 and 14. Loading {mac|cfg}80211
> > with ieee80211_regdom=64 (which is Japan AFAIK, so it should allow 14
> > channels) makes channels 12 and 13 work to some extent, but not
> > channel 14.
>
> You have to load cfg80211 with ieee80211_regdom=JP, it's a character
> string now, using =64 will just get you US again and even 12 and 13
> won't work. I just tried, and channel 14 works flawlessly.
>

I  tested with 2.6.25-rc4, so it's 64 there, yet it only went up to channel
13.

>
> > Iwconfig works up to ch13, while ch14 gives "Operation not permitted".
>
> You get operation not permitted when your configured regdomain doesn't
> include the channel you want. I also don't believe you that you get
> channels 12 and 13 when loading cfg80211 with ieee80211_regdom=64, that
> will get you only channels 1-11.
>

Again, in 2.6.25-rc4, the one that gets the parameter is mac80211, and the
value is 64. I remember receiving beacons on channel 12 (but obviously no
transmit).

>
> >  Kismet goes into channel 12 and 13 nicely, but crashes on channel 14.
>
> Sounds like a kismet bug.
>

I don't know, as other channel hoppers (airodump-ng, for example) behave the
same way.

>
> > The different errors of Kismet suggest a regional lockout on the
> > hardware, which is likely specific to this card, and not present on
> > non-Asus 4318s. Maybe there is a protection/"cop" chip connected to
> > the radio, I don't know as I haven't removed the cover of the radio.
>
> Nope. There is no such thing. You cannot get an -EPERM error from the
> b43 driver.


I am not sure if it was "Operation not permitted", it might have been a
hardware-related error or "Operation not supported".

>
> johannes
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080317/0b9ed04b/attachment.html>

From slipszi at gmail.com  Mon Mar 17 21:41:54 2008
From: slipszi at gmail.com (Silvester Erdeg)
Date: Mon, 17 Mar 2008 21:41:54 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
Message-ID: <ac67d9130803171341i698c3361j51bce8af329a3d73@mail.gmail.com>

On Sat, Mar 15, 2008 at 2:19 PM, Stefanik G?bor <netrolller.3d at gmail.com> wrote:
> Wait, are you Hungarian too?

Yes, I am.

> Someone should also try loading mac80211 (or cfg80211 on the
> wireless-testing tree) with ieee80211_regdom=64 to see if that helps. (I
> can't, as my OpenSUSE box died.)

I have tried this (options cfg80211 ieee80211_regdom="JP") with the
latest wireless-testing tree. The result is the same: the driver tries
to authenticate with the AP four times after which the authentication
times out.

I will have another laptop in a few days and I will try to see if my
card transmits anything at all.

Szilveszter


From myheadblewoff at hotmail.com  Wed Mar 19 05:37:18 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Wed, 19 Mar 2008 14:37:18 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>


I'm new to this list ~ greetings all round,

                                                               I've been following the thread on the above card for a few days now  -- as luck (or misfortune) would have it, I bought a number of these cards a couple of weeks ago....I live in Australia. WLAN is all a bit new to me, but I'm a quick study. I'll no doubt get further when (and if) I can get these cards to play the linux game....

For starters, the box is a P4 with a debian 3.0 rc1 instance thereto installed. 

The cards are branded [see topic], but for the record the broadcom IC onboard is marked   'BCM4318KFBG'

Initial plans entertained running the P4 as a WLAN AP, still the thin blue wires run the hall...

The kernel shipped with the deb3 release [linux-2.6.18-4-686] will use the (now deprecated) bcm43xx driver module, and it gives every impression via dmesg that things are going to work (once I get the firmware loading sorted and configure the stack itself)...;

bcm43xx: Chip ID 0x4318, rev 0x2
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev b43-phy0: Broadcom 4318 WLAN found                                              
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
bcm43xx: Radio turned off
bcm43xx: Radio turned off


.....but, I dunno for sure...yet....'coz I didn't get there. Rather, I saw tthe B43 website, the word 'deprecated', and concluded to download a fresh linux-2.6.24 tarball, and have at it from there. Now...2.6.24 is much LESS interested in this hardware, quote...;


b43-phy0: Broadcom 4318 WLAN found                                              
b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 15, Type 15, Revision 255)        
b43: probe of ssb0:0 failed with error -95


...and I went "hmmm, maybe I need an even more current kernel?"....or....is this a problem...??...


..hence this email. Any answers, pointer, clues or comments welcome,

                                                                                               regards,

                                                                                                            Donald
_________________________________________________________________
Overpaid or Underpaid? Check our comprehensive Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fcontent%2Emycareer%2Ecom%2Eau%2Fsalary%2Dcentre%3Fs%5Fcid%3D595810&_t=766724125&_r=Hotmail_Email_Tagline_MyCareer_Oct07&_m=EXT

From zajec5polish at gmail.com  Wed Mar 19 09:04:42 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Wed, 19 Mar 2008 09:04:42 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>
References: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>
Message-ID: <14b026160803190104k3e243414j7b851e54a4da2567@mail.gmail.com>

2008/3/19, kala mazoo <myheadblewoff at hotmail.com>:
>  .....but, I dunno for sure...yet....'coz I didn't get there. Rather, I saw tthe B43 website, the word 'deprecated', and concluded to download a fresh linux-2.6.24 tarball, and have at it from there. Now...2.6.24 is much LESS interested in this hardware, quote...;
>
>
>  b43-phy0: Broadcom 4318 WLAN found
>  b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 15, Type 15, Revision 255)
>  b43: probe of ssb0:0 failed with error -95

What about firmware? Did you install a version that is needed by b43?
AFAIR 2.6.24 doesn't have nice messages about wrong firmware. If I'm
right it was implemented (these messages) in 2.6.25-rcX.

Everytihng you need to know about versions of firmware is od linuxwireless:
http://linuxwireless.org/en/users/Drivers/b43


-- 
Rafa? Mi?ecki

From myheadblewoff at hotmail.com  Wed Mar 19 09:27:34 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Wed, 19 Mar 2008 18:27:34 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W36AF3F89F5645565AD256CA0070@phx.gbl>



----------------------------------------
> Date: Wed, 19 Mar 2008 09:04:42 +0100
> From: zajec5polish at gmail.com
> To: myheadblewoff at hotmail.com
> Subject: Re: More on ASUS WL-138G V2
> CC: bcm43xx-dev at lists.berlios.de
>
> 2008/3/19, kala mazoo :
>>  .....but, I dunno for sure...yet....'coz I didn't get there. Rather, I saw tthe B43 website, the word 'deprecated', and concluded to download a fresh linux-2.6.24 tarball, and have at it from there. Now...2.6.24 is much LESS interested in this hardware, quote...;
>>
>>
>>  b43-phy0: Broadcom 4318 WLAN found
>>  b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 15, Type 15, Revision 255)
>>  b43: probe of ssb0:0 failed with error -95
>
> What about firmware? Did you install a version that is needed by b43?
> AFAIR 2.6.24 doesn't have nice messages about wrong firmware. If I'm
> right it was implemented (these messages) in 2.6.25-rcX.

   ......Hey there Rafa?,
                                    Yeah, in the few hours since my last posting, I got around to the firmware business....results were not as expected

Using the shipped 2.6.18-4 in deb4 (not deb3 as I erroneously reported before ;) + bcm43xx in deprecation, the driver keep erroring out, complaing about IRQ timeout as it goes to core_up with errorcode -19 -- it attempts this twice and seemingly runs way....

Using a pristine 2.6.24 + b43 path, results in exactly the same response as above -- b43-phy0 ERROR: FOUND UNSUPPORTED PHY (Analog 15, Type 15, Revision 255).....so it would>appear< having the firmware available & load made no difference at all...
>
> Everytihng you need to know about versions of firmware is od linuxwireless:
> http://linuxwireless.org/en/users/Drivers/b43
>

....Yes, that's where I found out about this list!! ...

>
                                               Regards, 
                                                              Donald

> --
> Rafa? Mi?ecki

_________________________________________________________________
What are you waiting for? Join Lavalife FREE
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Flavalife9%2Eninemsn%2Ecom%2Eau%2Fclickthru%2Fclickthru%2Eact%3Fid%3Dninemsn%26context%3Dan99%26locale%3Den%5FAU%26a%3D30288&_t=764581033&_r=email_taglines_Join_free_OCT07&_m=EXT

From mb at bu3sch.de  Wed Mar 19 10:25:34 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 19 Mar 2008 10:25:34 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>
References: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>
Message-ID: <200803191025.34335.mb@bu3sch.de>

On Wednesday 19 March 2008 05:37:18 kala mazoo wrote:
> 
> I'm new to this list ~ greetings all round,
> 
>                                                                I've been following the thread on the above card for a few days now  -- as luck (or misfortune) would have it, I bought a number of these cards a couple of weeks ago....I live in Australia. WLAN is all a bit new to me, but I'm a quick study. I'll no doubt get further when (and if) I can get these cards to play the linux game....
> 
> For starters, the box is a P4 with a debian 3.0 rc1 instance thereto installed. 
> 
> The cards are branded [see topic], but for the record the broadcom IC onboard is marked   'BCM4318KFBG'
> 
> Initial plans entertained running the P4 as a WLAN AP, still the thin blue wires run the hall...
> 
> The kernel shipped with the deb3 release [linux-2.6.18-4-686] will use the (now deprecated) bcm43xx driver module, and it gives every impression via dmesg that things are going to work (once I get the firmware loading sorted and configure the stack itself)...;
> 
> bcm43xx: Chip ID 0x4318, rev 0x2
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
> bcm43xx: Core 1: ID 0x812, rev b43-phy0: Broadcom 4318 WLAN found                                              

Ehm, what da hell is that? Are you probing b43 and bcm43xx at the same time?
Disable bcm43xx, please.

> bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
> bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
> bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> 


-- 
Greetings Michael.


From netrolller.3d at gmail.com  Wed Mar 19 15:18:02 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Wed, 19 Mar 2008 15:18:02 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <200803191025.34335.mb@bu3sch.de>
References: <BAY107-W522A5D8ABDD01CFA642C1DA0070@phx.gbl>
	<200803191025.34335.mb@bu3sch.de>
Message-ID: <69e28c910803190718tf4f3882ve2633f36b6b96e29@mail.gmail.com>

2.6.18 doesn't support 4318. Try 2.6.22 or 2.6.23 if you want proper
functionality. However, it would be good if you tried 2.6.24, 2.6.25 or
wireless-dev (with new firmware, of course), as we are having extreme
problems with it, and you (from AU, which is outside of the US - what
channels can you use in AU?) can help debug it.

On Wed, Mar 19, 2008 at 10:25 AM, Michael Buesch <mb at bu3sch.de> wrote:

> On Wednesday 19 March 2008 05:37:18 kala mazoo wrote:
> >
> > I'm new to this list ~ greetings all round,
> >
> >                                                                I've been
> following the thread on the above card for a few days now  -- as luck (or
> misfortune) would have it, I bought a number of these cards a couple of
> weeks ago....I live in Australia. WLAN is all a bit new to me, but I'm a
> quick study. I'll no doubt get further when (and if) I can get these cards
> to play the linux game....
> >
> > For starters, the box is a P4 with a debian 3.0 rc1 instance thereto
> installed.
> >
> > The cards are branded [see topic], but for the record the broadcom IC
> onboard is marked   'BCM4318KFBG'
> >
> > Initial plans entertained running the P4 as a WLAN AP, still the thin
> blue wires run the hall...
> >
> > The kernel shipped with the deb3 release [linux-2.6.18-4-686] will use
> the (now deprecated) bcm43xx driver module, and it gives every impression
> via dmesg that things are going to work (once I get the firmware loading
> sorted and configure the stack itself)...;
> >
> > bcm43xx: Chip ID 0x4318, rev 0x2
> > bcm43xx: Number of cores: 4
> > bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
> > bcm43xx: Core 1: ID 0x812, rev b43-phy0: Broadcom 4318 WLAN found
>
> Ehm, what da hell is that? Are you probing b43 and bcm43xx at the same
> time?
> Disable bcm43xx, please.
>
> > bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
> > bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
> > bcm43xx: PHY connected
> > bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
> > bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
> > bcm43xx: Radio turned off
> > bcm43xx: Radio turned off
> >
>
>
> --
> Greetings Michael.
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080319/0d313b9f/attachment.html>

From netrolller.3d at gmail.com  Wed Mar 19 15:57:33 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Wed, 19 Mar 2008 15:57:33 +0100
Subject: Asus WL-138G V2 (BCM4318 non-E rev02) scans but doesn't associate
	using b43 driver, works with bcm43xx
In-Reply-To: <ac67d9130803171341i698c3361j51bce8af329a3d73@mail.gmail.com>
References: <69e28c910802271032u830a27es91d42d9cc1c31be0@mail.gmail.com>
	<69e28c910803031501p6cafb809te679606ca780e175@mail.gmail.com>
	<69e28c910803141230j49d4bf5cu8be892c1fd04efa4@mail.gmail.com>
	<ac67d9130803141319g550d5923ye73b8cc5a5d64671@mail.gmail.com>
	<69e28c910803150619y52d29cd8tac1a17cff83e84c4@mail.gmail.com>
	<ac67d9130803171341i698c3361j51bce8af329a3d73@mail.gmail.com>
Message-ID: <69e28c910803190757g4eef70e2v74b21508b0186726@mail.gmail.com>

You don't need another laptop, just create a radiotap monitor interface with
iw (iw dev <card> interface add rtap0 type monitor), then run
kismet/airodump/wireshark/<your favorite packet dumper> on rtap0, and try to
authenticate on your main interface. Or try ieee80211_regdom="EU", possibly
the card requires it. (This message is in English because it needs to be
readable on the list.)

On Mon, Mar 17, 2008 at 9:41 PM, Silvester Erdeg <slipszi at gmail.com> wrote:

> On Sat, Mar 15, 2008 at 2:19 PM, Stefanik G?bor <netrolller.3d at gmail.com>
> wrote:
> > Wait, are you Hungarian too?
>
> Yes, I am.
>
> > Someone should also try loading mac80211 (or cfg80211 on the
> > wireless-testing tree) with ieee80211_regdom=64 to see if that helps. (I
> > can't, as my OpenSUSE box died.)
>
> I have tried this (options cfg80211 ieee80211_regdom="JP") with the
> latest wireless-testing tree. The result is the same: the driver tries
> to authenticate with the AP four times after which the authentication
> times out.
>
> I will have another laptop in a few days and I will try to see if my
> card transmits anything at all.
>
> Szilveszter
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080319/26798910/attachment.html>

From myheadblewoff at hotmail.com  Thu Mar 20 03:58:44 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Thu, 20 Mar 2008 12:58:44 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W56F6DE59EAA893C7BD1A6DA0000@phx.gbl>



Greets,

________________________________
> Date: Wed, 19 Mar 2008 15:18:02 +0100
> From: netrolller.3d at gmail.com
> To: myheadblewoff at hotmail.com
> Subject: Re: More on ASUS WL-138G V2
> CC: bcm43xx-dev at lists.berlios.de; mb at bu3sch.de
>
> 2.6.18 doesn't support 4318. Try 2.6.22 or 2.6.23 if you want proper functionality. However, it would be good if you tried 2.6.24, 2.6.25 or wireless-dev>(with new firmware, of course), as we are having extreme problems with it, and you (from AU, which is outside of the US - what channels can you use in>AU?) can help debug it.
>

....okidoki, that more than less concurs with what I discovered last night. I've got 2.6.24 here ~ were there any changes (to b43 & co) in 2.6.25?
.
......wireless-dev...[if this is] .compat-wireless-2.6] actually failed to compile on this {my} machine -- in  .compat-wireless-2.6/net/ieee80211/ieee80211_module.c
....it bails due to no definition for 'init_net' -- I shouldn't need this anyhow if I'm running a late model penguin of 2.6.24 or greater, true? That will be my path...I'll look into what's going on here later on (..famous last words..)

...regarding channel restrictions here (if any), I can personally state that I don't know. -If- I were to take the example given to me by my son's XP box in the next room....same card + shipped wiin drivers and config GUI frontend...then I would report channels 1->13 inclusive. Regardless of more complete functionality or not, I've eventually shoved one of the cards in this machine running 2.6.22, and using the bcm43xx driver set it all -appears- to be as expected. In this case, debug pumped to dmesg reported more or less the same thing....the whole snippet reads ;

 bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Associate: failed to initiate scan. Is device up?
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1489:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1489:bcm43xx_find_lopair()
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1489:bcm43xx_find_lopair()
ADDRCONF(NETDEV_UP): eth1: link is not ready
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Scanning finished: scanned 13 channels starting with channel 1
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Unable to find matching network after scan!

...Don't know if that's sane or typical -- the last line is the correct result though, there is no network setup yet. This may be blabla et_al ; the aim is to use b43 instead -- but for the sake of completeness this is what it looks like here under 2.6.22. I'll build & install (at least..) 2.4.24 here later and see what b43 thinks of it now...at least I know that hardware talks, firmware loading works, iwconfig works..etc.etc

...happy to help my end trying to debug things. Do you want a card to play with?...


Regarding using one of these cards in AP mode, I've read a few threads describing patches needing to be included in various places - is this still the case? 



> On Wed, Mar 19, 2008 at 10:25 AM, Michael Buesch <mb at bu3sch.de> wrote:
> On Wednesday 19 March 2008 05:37:18 kala mazoo wrote:

>> The kernel shipped with the deb3 release [linux-2.6.18-4-686] will use the (now deprecated) bcm43xx driver module, and it gives every impression via dmesg that things are going to work (once I get the firmware loading sorted and configure the stack itself)...;
>>
>> bcm43xx: Chip ID 0x4318, rev 0x2
>> bcm43xx: Number of cores: 4
>> bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
>> bcm43xx: Core 1: ID 0x812, rev b43-phy0: Broadcom 4318 WLAN found
>
> Ehm, what da hell is that? Are you probing b43 and bcm43xx at the same time?
> Disable bcm43xx, please.
>
>> bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
>> bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
>> bcm43xx: PHY connected
>

Ummm...what that is, is an example of seamonkey's inability to recognize and correct the mistake made when a careless human being accidentally picks the wrong insertion point on a pending paste operation and goes click! Damn, i though I'd editted out all the splatter, apparently not, sorry about that. Hopefully, they'll fix seamonkey anyday soon now and get rid of this problem....

                                                                                                                           Regards,
                                                                                                                                            Donald


_________________________________________________________________
Overpaid or Underpaid? Check our comprehensive Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fcontent%2Emycareer%2Ecom%2Eau%2Fsalary%2Dcentre%3Fs%5Fcid%3D595810&_t=766724125&_r=Hotmail_Email_Tagline_MyCareer_Oct07&_m=EXT

From myheadblewoff at hotmail.com  Fri Mar 21 08:03:43 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Fri, 21 Mar 2008 17:03:43 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W31AB793F447F40389ADF00A0010@phx.gbl>



________________________________
> Date: Wed, 19 Mar 2008 15:18:02 +0100
> From: netrolller.3d at gmail.com
> To: myheadblewoff at hotmail.com
> Subject: Re: More on ASUS WL-138G V2
> CC: bcm43xx-dev at lists.berlios.de; mb at bu3sch.de
>
> 2.6.18 doesn't support 4318. Try 2.6.22 or 2.6.23 if you want proper functionality. However, it would be good if you tried 2.6.24, 2.6.25 or wireless-dev (with>new>firmware, of course), as we are having extreme problems with it, and you (from AU, which is outside of the US - what channels can you use in AU?) can help>debug it.
>


 Hello again,

                   Well, things have moved along a bit here -- nothing works, but it all looks like it wants to...

Upgraded to 2.6.24, now using b43 driver + debug on

  Perhaps I'm doing something wrong....anyhow, the background realm consists of my son's XP box, running one of the same cards with the asus proprietary drivers + config frontend, and is setup in so called 'softAP' mode instead of 'station' mode, I'm telling it channel 1...and no additional encryption (which I hope infers WEP only encryption), it's network IP is set on 192.168.1.0/24 space, and as far as the blowz' box is concerned, everything it's end is hunky-dory. Except it can't seemingly see this machine at all...

....on this linux end (and being all new to this), I'm not sure if what I'm seeing is actually correct. For instance ;

root at bits64:# iwconfig wlan0
wlan0     IEEE 802.11g  ESSID:"dfg"  
          Mode:Managed  Frequency:2.412 GHz  Access Point: 00:1B:FC:61:19:58   
          Tx-Power=27 dBm   
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B   
          Encryption key:1122-3344-55
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

...the AP Mac is that of the XP box -- I didn't expect to see 'Link Quality:0  Signal level:0  Noise level:0'...

Looking at the same situation from another point of view....;

root at bits64:# iwlist wlan0 scanning
wlan0     Scan completed :
          Cell 01 - Address: 00:1B:FC:61:19:58
                    ESSID:"dfg"
                    Mode:Master
                    Channel:1
                    Frequency:2.412 GHz (Channel 1)
                    Quality=73/100  Signal level=-15 dBm  Noise level=-52 dBm
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s
                              24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s
                              12 Mb/s; 48 Mb/s
                    Extra:tsf=00000004c4c6c18b

....and I'll convince myself that sortta looks correct...but shouldn't the link/signal/noise stats have appeared in the output of iwconfig? Why are they not? 

What is the purpose of the wmaster0 interface, and when does it get used? Issuing 'ifconfig' returns ;

wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1  
          inet addr:192.168.1.123  Bcast:192.168.1.255  Mask:255.255.255.0
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

wmaster0  Link encap:UNSPEC  HWaddr 00-1B-FC-61-15-E1-0A-00-00-00-00-00-00-00-00-00  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

...and I've no idea if that's correct, whether wmaster0 has to be ifconfigured or not, or indeed whether wlan0 has to be bridged or not, because I'm having trouble finding any good, new, recent documentation about some of this stuff...

All the zeros are correct - as far as XP and this box are concerned, there is no route to either host

...I'm seeing a lot of this in dmesg....

b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped
b43-phy0 debug: RX: Packet dropped

....and 2.6.24 breaks lircd-0.8.2 so my IR remote control is lame (^;

....am I doing something wrong here, or am I seeing 'the problem'?

                        Regards,
                                       Donald
_________________________________________________________________
New music from the Rogue Traders - listen now!
http://ninemsn.com.au/share/redir/adTrack.asp?mode=click&clientID=832&referral=hotmailtaglineOct07&URL=http://music.ninemsn.com.au/roguetraders

From Larry.Finger at lwfinger.net  Fri Mar 21 16:10:16 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 21 Mar 2008 08:10:16 -0700
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W31AB793F447F40389ADF00A0010@phx.gbl>
References: <BAY107-W31AB793F447F40389ADF00A0010@phx.gbl>
Message-ID: <47E3CFD8.4090200@lwfinger.net>

kala mazoo wrote:
>                    Well, things have moved along a bit here -- nothing works, but it all looks like it wants to...
> 
> Upgraded to 2.6.24, now using b43 driver + debug on
> 
>   Perhaps I'm doing something wrong....anyhow, the background realm consists of my son's XP box,
 > running one of the same cards with the asus proprietary drivers + config frontend, and is setup
 > in so called 'softAP' mode instead of 'station' mode, I'm telling it channel 1...and no
 > additional encryption (which I hope infers WEP only encryption), it's network IP is set on
 > 192.168.1.0/24 space, and as far as the blowz' box is concerned, everything it's end is
 > hunky-dory. Except it can't seemingly see this machine at all...
> 
> ....on this linux end (and being all new to this), I'm not sure if what I'm seeing is actually
 > correct. For instance ;
> 
> root at bits64:# iwconfig wlan0
> wlan0     IEEE 802.11g  ESSID:"dfg"  
>           Mode:Managed  Frequency:2.412 GHz  Access Point: 00:1B:FC:61:19:58   
>           Tx-Power=27 dBm   
>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B   
>           Encryption key:1122-3344-55
>           Link Quality:0  Signal level:0  Noise level:0
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> ...the AP Mac is that of the XP box -- I didn't expect to see 'Link Quality:0  Signal level:0  Noise level:0'...

The zeros in the signal level is a minor problem that is not severe enough for anyone to spend time 
fixing. Please ignore it for now. The fact that you see the AP's MAC address implies association, 
and the presence of the encryption key means that it has authenticated. Everything looks normal.

> Looking at the same situation from another point of view....;
> 
> root at bits64:# iwlist wlan0 scanning
> wlan0     Scan completed :
>           Cell 01 - Address: 00:1B:FC:61:19:58
>                     ESSID:"dfg"
>                     Mode:Master
>                     Channel:1
>                     Frequency:2.412 GHz (Channel 1)
>                     Quality=73/100  Signal level=-15 dBm  Noise level=-52 dBm
>                     Encryption key:on
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s
>                               24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s
>                               12 Mb/s; 48 Mb/s
>                     Extra:tsf=00000004c4c6c18b
> 
> ....and I'll convince myself that sortta looks correct...but shouldn't the link/signal/noise stats have appeared in the output of iwconfig? Why are they not? 

What is "sortta"? This is _exactly_ what you should see.

> What is the purpose of the wmaster0 interface, and when does it get used? Issuing 'ifconfig' returns ;

With mac80211, multiple interfaces of multiple types are supported. The master controller for all of 
these is 'wmaster0'. It is always there, but you can ignore it.

> wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1  
>           inet addr:192.168.1.123  Bcast:192.168.1.255  Mask:255.255.255.0
>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000 
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

Was this IP address obtained by DHCP or did you manually assign it? If the former, then all is 
working in the Linux box. In either case, I would look to problems with the Windoze setup. Their 
wizards make everything look deceptively simple, but often it doesn't work. In addition, make sure 
that all firewalls are off until you get it working. Then turn them back on separately on both ends
and fix any problems that turn up.

What does a 'route' command show on the Linux box? Can the Linux box ping localhost? If the answer 
is yes, what does 'ping 192.168.1.123' show? Finally ping the default gateway shown in the route 
command output. If that works, your Linux box is doing exactly what it should.

Larry




From myheadblewoff at hotmail.com  Fri Mar 21 23:07:03 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Sat, 22 Mar 2008 08:07:03 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W3981A4F79B450060F93786A0010@phx.gbl>



G'day, thanks for all the input Stefanik ,

________________________________
> Date: Fri, 21 Mar 2008 13:42:20 +0100
> From: netrolller.3d at gmail.com
> To: myheadblewoff at hotmail.com
> Subject: Re: More on ASUS WL-138G V2
>
> You need hostapd (bleeding edge version, as release supports Prism cards only with softmac driver) for AP mode with any mac80211 driver. Without it, it just won't> work.
>

.....True? I was under the impression that I'd only need hostapd if I planned to use the card as an accesspoint? Yes, I know I said my plan was to do just that, but I was thinking managed/ad-hoc modes wouldn't need hostapd to get running --- are my thoughts in error?

   Yesterday was Good Friday, so I was snookered by the public holiday -- today is another matter, and I think I'll go out and buy a wireless router/AP for the setup -- what you are saying is that I'll need hostapd even for that?....


                        Regards,
                                         Donald



> On Fri, Mar 21, 2008 at 8:03 AM, kala mazoo <myheadblewoff at hotmail.com> wrote:
>
>
> ________________________________
>> Date: Wed, 19 Mar 2008 15:18:02 +0100
>> From: netrolller.3d at gmail.com
>> To: myheadblewoff at hotmail.com
>> Subject: Re: More on ASUS WL-138G V2
>> CC: bcm43xx-dev at lists.berlios.de; mb at bu3sch.de
>>
>> 2.6.18 doesn't support 4318. Try 2.6.22 or 2.6.23 if you want proper functionality. However, it would be good if you tried 2.6.24, 2.6.25 or wireless-dev (with>new>firmware, of course), as we are having extreme problems with it, and you (from AU, which is outside of the US - what channels can you use in AU?) can help>debug it.
>>
>
>
>  Hello again,
>
>                   Well, things have moved along a bit here -- nothing works, but it all looks like it wants to...
>
> Upgraded to 2.6.24, now using b43 driver + debug on
>
>  Perhaps I'm doing something wrong....anyhow, the background realm consists of my son's XP box, running one of the same cards with the asus proprietary drivers + config frontend, and is setup in so called 'softAP' mode instead of 'station' mode, I'm telling it channel 1...and no additional encryption (which I hope infers WEP only encryption), it's network IP is set on 192.168.1.0/24 space, and as far as the blowz' box is concerned, everything it's end is hunky-dory. Except it can't seemingly see this machine at all...
>
> ....on this linux end (and being all new to this), I'm not sure if what I'm seeing is actually correct. For instance ;
>
> root at bits64:# iwconfig wlan0
> wlan0     IEEE 802.11g  ESSID:"dfg"
>          Mode:Managed  Frequency:2.412 GHz  Access Point: 00:1B:FC:61:19:58
>          Tx-Power=27 dBm
>          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
>          Encryption key:1122-3344-55
>          Link Quality:0  Signal level:0  Noise level:0
>          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
> ...the AP Mac is that of the XP box -- I didn't expect to see 'Link Quality:0  Signal level:0  Noise level:0'...
>
> Looking at the same situation from another point of view....;
>
> root at bits64:# iwlist wlan0 scanning
> wlan0     Scan completed :
>          Cell 01 - Address: 00:1B:FC:61:19:58
>                    ESSID:"dfg"
>                    Mode:Master
>                    Channel:1
>                    Frequency:2.412 GHz (Channel 1)
>                    Quality=73/100  Signal level=-15 dBm  Noise level=-52 dBm
>                    Encryption key:on
>                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s
>                              24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s
>                              12 Mb/s; 48 Mb/s
>                    Extra:tsf=00000004c4c6c18b
>
> ....and I'll convince myself that sortta looks correct...but shouldn't the link/signal/noise stats have appeared in the output of iwconfig? Why are they not?
>
> What is the purpose of the wmaster0 interface, and when does it get used? Issuing 'ifconfig' returns ;
>
> wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1
>          inet addr:192.168.1.123  Bcast:192.168.1.255  Mask:255.255.255.0
>          UP BROADCAST MULTICAST  MTU:1500  Metric:1
>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>          collisions:0 txqueuelen:1000
>          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
> wmaster0  Link encap:UNSPEC  HWaddr 00-1B-FC-61-15-E1-0A-00-00-00-00-00-00-00-00-00
>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>          collisions:0 txqueuelen:1000
>          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
>
> ...and I've no idea if that's correct, whether wmaster0 has to be ifconfigured or not, or indeed whether wlan0 has to be bridged or not, because I'm having trouble finding any good, new, recent documentation about some of this stuff...
>
> All the zeros are correct - as far as XP and this box are concerned, there is no route to either host
>
> ...I'm seeing a lot of this in dmesg....
>
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
> b43-phy0 debug: RX: Packet dropped
>
> ....and 2.6.24 breaks lircd-0.8.2 so my IR remote control is lame (^;
>
> ....am I doing something wrong here, or am I seeing 'the problem'?
>
>                        Regards,
>                                       Donald
> _________________________________________________________________
> New music from the Rogue Traders - listen now!
> http://ninemsn.com.au/share/redir/adTrack.asp?mode=click&clientID=832&referral=hotmailtaglineOct07&URL=http://music.ninemsn.com.au/roguetraders
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)

_________________________________________________________________
Get MOTORAZR MAXX V6 now $249 on Next G? Pre-Paid
http://clk.atdmt.com/OAT/go/nnmsntel0690000034oat/direct/01/

From myheadblewoff at hotmail.com  Sat Mar 22 00:09:23 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Sat, 22 Mar 2008 09:09:23 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W436503577B2B0EB45B31B3A0010@phx.gbl>


  G'day Larry. thanks for your imput here,


----------------------------------------
> Date: Fri, 21 Mar 2008 08:10:16 -0700
> From: Larry.Finger at lwfinger.net
> To: myheadblewoff at hotmail.com
> CC: bcm43xx-dev at lists.berlios.de
> Subject: Re: More on ASUS WL-138G V2
>
> kala mazoo wrote:
>>                    Well, things have moved along a bit here -- nothing works, but it all looks like it wants to...
>>
>> Upgraded to 2.6.24, now using b43 driver + debug on
>>
>>   Perhaps I'm doing something wrong....anyhow, the background realm consists of my son's XP box,
>> running one of the same cards with the asus proprietary drivers + config frontend, and is setup
>> in so called 'softAP' mode instead of 'station' mode, I'm telling it channel 1...and no
>> additional encryption (which I hope infers WEP only encryption), it's network IP is set on
>> 192.168.1.0/24 space, and as far as the blowz' box is concerned, everything it's end is
>> hunky-dory. Except it can't seemingly see this machine at all...
>>
>> ....on this linux end (and being all new to this), I'm not sure if what I'm seeing is actually
>> correct. For instance ;
>>
>> root at bits64:# iwconfig wlan0
>> wlan0     IEEE 802.11g  ESSID:"dfg"
>>           Mode:Managed  Frequency:2.412 GHz  Access Point: 00:1B:FC:61:19:58
>>           Tx-Power=27 dBm
>>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
>>           Encryption key:1122-3344-55
>>           Link Quality:0  Signal level:0  Noise level:0
>>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>>
>> ...the AP Mac is that of the XP box -- I didn't expect to see 'Link Quality:0  Signal level:0  Noise level:0'...

>
> The zeros in the signal level is a minor problem that is not severe enough for anyone to spend time
> fixing. Please ignore it for now. The fact that you see the AP's MAC address implies association,
> and the presence of the encryption key means that it has authenticated. Everything looks normal.
>

Okay...ignoring the reporting error forthwith.......


>> Looking at the same situation from another point of view....;
>>
>> root at bits64:# iwlist wlan0 scanning
>> wlan0     Scan completed :
>>           Cell 01 - Address: 00:1B:FC:61:19:58
>>                     ESSID:"dfg"
>>                     Mode:Master
>>                     Channel:1
>>                     Frequency:2.412 GHz (Channel 1)
>>                     Quality=73/100  Signal level=-15 dBm  Noise level=-52 dBm
>>                     Encryption key:on
>>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s
>>                               24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s
>>                               12 Mb/s; 48 Mb/s
>>                     Extra:tsf=00000004c4c6c18b
>>
>> ....and I'll convince myself that sortta looks correct...but shouldn't the link/signal/noise stats have appeared in the output of iwconfig? Why are they not?
>
> What is "sortta"? This is _exactly_ what you should see.
>

The word 'sortta' is an Australian colloquialism which implies the paraphrase  'sort of'....which means something looks right even if one is not 100% sure that it's all actually correct. Without knowing the word's meaning, you've answered it correctly!! Well done....


>> What is the purpose of the wmaster0 interface, and when does it get used? Issuing 'ifconfig' returns ;
>
> With mac80211, multiple interfaces of multiple types are supported. The master controller for all of
> these is 'wmaster0'. It is always there, but you can ignore it.
>
>> wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1
>>           inet addr:192.168.1.123  Bcast:192.168.1.255  Mask:255.255.255.0
>>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>>           collisions:0 txqueuelen:1000
>>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

Okay, I understand now....

>
> Was this IP address obtained by DHCP or did you manually assign it? If the former, then all is
> working in the Linux box. 

It was actually the latter - I manually assigned that IP_addr to wlan0.....
 

> In either case, I would look to problems with the Windoze setup. Their
> wizards make everything look deceptively simple, but often it doesn't work. In addition, make sure
> that all firewalls are off until you get it working. Then turn them back on separately on both ends
> and fix any problems that turn up.

Yeah, I was loath to do what I did for exactly these reasons - one can never be sure if 'blowz is doing the right thing. I did remember to drop all firewalls (both ends), but such made no difference....I'll go out and buy a wireless router/AP today and remove this conjecture altogether....


>
> What does a 'route' command show on the Linux box? Can the Linux box ping localhost? If the answer
> is yes, what does 'ping 192.168.1.123' show? Finally ping the default gateway shown in the route
> command output. If that works, your Linux box is doing exactly what it should.

Well, considered the WIRED interface is still active, the routing table looks like ;

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     *               255.255.255.0   U     0      0        0 wlan0
172.16.1.0      *               255.255.255.0   U     0      0        0 eth0
default         desmo.thehut.ne 0.0.0.0         UG    0      0        0 eth0

..the 'blowz box is at 192.168.1.1 ....I cannot ping it, and it cannot ping me. I can rehash this to ;

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     *               255.255.255.0   U     0      0        0 wlan0
172.16.1.0      *               255.255.255.0   U     0      0        0 eth0
default         192.168.1.1     0.0.0.0         UG    0      0        0 wlan0


but this changes nothing ;


PING 192.168.1.1 (192.168.1.1): 48 data bytes
60 bytes from 192.168.1.123: Destination Host Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst Data
 4  5  c0 6800 366f   0 0000  40  01 5886 192.168.1.123  192.168.1.123 
--- 192.168.1.1 ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss


and even if I add a host route..so it looks like this;


Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.1     *               255.255.255.255 UH    0      0        0 wlan0
192.168.1.0     *               255.255.255.0   U     0      0        0 wlan0
172.16.1.0      *               255.255.255.0   U     0      0        0 eth0
default         desmo.thehut.ne 0.0.0.0         UG    0      0        0 eth0

..but again, this changes nothing. To answer the other questions...

PING localhost (127.0.0.1): 48 data bytes
56 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.109 ms
56 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.082 ms
56 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.074 ms
--- localhost ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.074/0.088/0.109/0.015 ms


PING 192.168.1.123 (192.168.1.123): 48 data bytes
56 bytes from 192.168.1.123: icmp_seq=0 ttl=64 time=0.103 ms
56 bytes from 192.168.1.123: icmp_seq=1 ttl=64 time=0.704 ms
56 bytes from 192.168.1.123: icmp_seq=2 ttl=64 time=0.452 ms
--- 192.168.1.123 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.103/0.420/0.704/0.246 ms


So go figure. I did all this hours ago, and it was about then I decided it was XP's fault ...

Unless of course if the other posting is right, and I actually need hostapd to use the card in managed/ad-hoc modes....in which case all of this is myfault instead...


         Thanks for everyone's help here, I'll be back,

                                                                             Donald 








>
> Larry
>
>

_________________________________________________________________
Are you paid what you're worth? Find out: SEEK Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fninemsn%2Eseek%2Ecom%2Eau%2Fcareer%2Dresources%2Fsalary%2Dcentre%2F%3Ftracking%3Dsk%3Ahet%3Asc%3Anine%3A0%3Ahot%3Atext&_t=764565661&_r=OCT07_endtext_salary&_m=EXT

From netrolller.3d at gmail.com  Sat Mar 22 15:29:23 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 22 Mar 2008 15:29:23 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W3981A4F79B450060F93786A0010@phx.gbl>
References: <BAY107-W3981A4F79B450060F93786A0010@phx.gbl>
Message-ID: <69e28c910803220729l7c78f516gf8b420ec3c83c3b5@mail.gmail.com>

Looks like I misunderstood what you want to do. I thought you want to use
the card as an AP.

On Fri, Mar 21, 2008 at 11:07 PM, kala mazoo <myheadblewoff at hotmail.com>
wrote:

>
>
> G'day, thanks for all the input Stefanik ,
>
> ________________________________
> > Date: Fri, 21 Mar 2008 13:42:20 +0100
> > From: netrolller.3d at gmail.com
> > To: myheadblewoff at hotmail.com
> > Subject: Re: More on ASUS WL-138G V2
> >
> > You need hostapd (bleeding edge version, as release supports Prism cards
> only with softmac driver) for AP mode with any mac80211 driver. Without it,
> it just won't> work.
> >
>
> .....True? I was under the impression that I'd only need hostapd if I
> planned to use the card as an accesspoint? Yes, I know I said my plan was to
> do just that, but I was thinking managed/ad-hoc modes wouldn't need hostapd
> to get running --- are my thoughts in error?
>
>   Yesterday was Good Friday, so I was snookered by the public holiday --
> today is another matter, and I think I'll go out and buy a wireless
> router/AP for the setup -- what you are saying is that I'll need hostapd
> even for that?....
>
>
>                        Regards,
>                                         Donald
>
>
>
> > On Fri, Mar 21, 2008 at 8:03 AM, kala mazoo <myheadblewoff at hotmail.com>
> wrote:
> >
> >
> > ________________________________
> >> Date: Wed, 19 Mar 2008 15:18:02 +0100
> >> From: netrolller.3d at gmail.com
> >> To: myheadblewoff at hotmail.com
> >> Subject: Re: More on ASUS WL-138G V2
> >> CC: bcm43xx-dev at lists.berlios.de; mb at bu3sch.de
> >>
> >> 2.6.18 doesn't support 4318. Try 2.6.22 or 2.6.23 if you want proper
> functionality. However, it would be good if you tried 2.6.24, 2.6.25 or
> wireless-dev (with>new>firmware, of course), as we are having extreme
> problems with it, and you (from AU, which is outside of the US - what
> channels can you use in AU?) can help>debug it.
> >>
> >
> >
> >  Hello again,
> >
> >                   Well, things have moved along a bit here -- nothing
> works, but it all looks like it wants to...
> >
> > Upgraded to 2.6.24, now using b43 driver + debug on
> >
> >  Perhaps I'm doing something wrong....anyhow, the background realm
> consists of my son's XP box, running one of the same cards with the asus
> proprietary drivers + config frontend, and is setup in so called 'softAP'
> mode instead of 'station' mode, I'm telling it channel 1...and no additional
> encryption (which I hope infers WEP only encryption), it's network IP is set
> on 192.168.1.0/24 space, and as far as the blowz' box is concerned,
> everything it's end is hunky-dory. Except it can't seemingly see this
> machine at all...
> >
> > ....on this linux end (and being all new to this), I'm not sure if what
> I'm seeing is actually correct. For instance ;
> >
> > root at bits64:# iwconfig wlan0
> > wlan0     IEEE 802.11g  ESSID:"dfg"
> >          Mode:Managed  Frequency:2.412 GHz  Access Point:
> 00:1B:FC:61:19:58
> >          Tx-Power=27 dBm
> >          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
> >          Encryption key:1122-3344-55
> >          Link Quality:0  Signal level:0  Noise level:0
> >          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> >          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> >
> > ...the AP Mac is that of the XP box -- I didn't expect to see 'Link
> Quality:0  Signal level:0  Noise level:0'...
> >
> > Looking at the same situation from another point of view....;
> >
> > root at bits64:# iwlist wlan0 scanning
> > wlan0     Scan completed :
> >          Cell 01 - Address: 00:1B:FC:61:19:58
> >                    ESSID:"dfg"
> >                    Mode:Master
> >                    Channel:1
> >                    Frequency:2.412 GHz (Channel 1)
> >                    Quality=73/100  Signal level=-15 dBm  Noise level=-52
> dBm
> >                    Encryption key:on
> >                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s
> >                              24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s
> >                              12 Mb/s; 48 Mb/s
> >                    Extra:tsf=00000004c4c6c18b
> >
> > ....and I'll convince myself that sortta looks correct...but shouldn't
> the link/signal/noise stats have appeared in the output of iwconfig? Why are
> they not?
> >
> > What is the purpose of the wmaster0 interface, and when does it get
> used? Issuing 'ifconfig' returns ;
> >
> > wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1
> >          inet addr:192.168.1.123  Bcast:192.168.1.255  Mask:
> 255.255.255.0
> >          UP BROADCAST MULTICAST  MTU:1500  Metric:1
> >          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> >          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> >          collisions:0 txqueuelen:1000
> >          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> >
> > wmaster0  Link encap:UNSPEC  HWaddr
> 00-1B-FC-61-15-E1-0A-00-00-00-00-00-00-00-00-00
> >          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
> >          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
> >          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
> >          collisions:0 txqueuelen:1000
> >          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> >
> > ...and I've no idea if that's correct, whether wmaster0 has to be
> ifconfigured or not, or indeed whether wlan0 has to be bridged or not,
> because I'm having trouble finding any good, new, recent documentation about
> some of this stuff...
> >
> > All the zeros are correct - as far as XP and this box are concerned,
> there is no route to either host
> >
> > ...I'm seeing a lot of this in dmesg....
> >
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> > b43-phy0 debug: RX: Packet dropped
> >
> > ....and 2.6.24 breaks lircd-0.8.2 so my IR remote control is lame (^;
> >
> > ....am I doing something wrong here, or am I seeing 'the problem'?
> >
> >                        Regards,
> >                                       Donald
> > _________________________________________________________________
> > New music from the Rogue Traders - listen now!
> >
> http://ninemsn.com.au/share/redir/adTrack.asp?mode=click&clientID=832&referral=hotmailtaglineOct07&URL=http://music.ninemsn.com.au/roguetraders
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
> >
> >
> > --
> > Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>
> _________________________________________________________________
> Get MOTORAZR MAXX V6 now $249 on Next G? Pre-Paid
> http://clk.atdmt.com/OAT/go/nnmsntel0690000034oat/direct/01/
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080322/4ade1d96/attachment.html>

From mb at bu3sch.de  Sat Mar 22 22:04:45 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 22 Mar 2008 22:04:45 +0100
Subject: [PATCH] b43: Fix DMA mapping leakage
Message-ID: <200803222204.45919.mb@bu3sch.de>

This fixes a DMA mapping leakage in the case where we reject a DMA
buffer because of its address.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Cc: Christian Casteyde <casteyde.christian at free.fr>

---

John, this is a fix for 2.6.25.


Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-22 21:50:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-22 21:57:53.000000000 +0100
@@ -512,34 +512,40 @@ static int b43_dmacontroller_tx_reset(st
 	return 0;
 }
 
 /* Check if a DMA mapping address is invalid. */
 static bool b43_dma_mapping_error(struct b43_dmaring *ring,
 				  dma_addr_t addr,
-				  size_t buffersize)
+				  size_t buffersize, bool dma_to_device)
 {
 	if (unlikely(dma_mapping_error(addr)))
 		return 1;
 
 	switch (ring->type) {
 	case B43_DMA_30BIT:
 		if ((u64)addr + buffersize > (1ULL << 30))
-			return 1;
+			goto address_error;
 		break;
 	case B43_DMA_32BIT:
 		if ((u64)addr + buffersize > (1ULL << 32))
-			return 1;
+			goto address_error;
 		break;
 	case B43_DMA_64BIT:
 		/* Currently we can't have addresses beyond
 		 * 64bit in the kernel. */
 		break;
 	}
 
 	/* The address is OK. */
 	return 0;
+
+address_error:
+	/* We can't support this address. Unmap it again. */
+	unmap_descbuffer(ring, addr, buffersize, dma_to_device);
+
+	return 1;
 }
 
 static int setup_rx_descbuffer(struct b43_dmaring *ring,
 			       struct b43_dmadesc_generic *desc,
 			       struct b43_dmadesc_meta *meta, gfp_t gfp_flags)
 {
@@ -551,26 +557,26 @@ static int setup_rx_descbuffer(struct b4
 	B43_WARN_ON(ring->tx);
 
 	skb = __dev_alloc_skb(ring->rx_buffersize, gfp_flags);
 	if (unlikely(!skb))
 		return -ENOMEM;
 	dmaaddr = map_descbuffer(ring, skb->data, ring->rx_buffersize, 0);
-	if (b43_dma_mapping_error(ring, dmaaddr, ring->rx_buffersize)) {
+	if (b43_dma_mapping_error(ring, dmaaddr, ring->rx_buffersize, 0)) {
 		/* ugh. try to realloc in zone_dma */
 		gfp_flags |= GFP_DMA;
 
 		dev_kfree_skb_any(skb);
 
 		skb = __dev_alloc_skb(ring->rx_buffersize, gfp_flags);
 		if (unlikely(!skb))
 			return -ENOMEM;
 		dmaaddr = map_descbuffer(ring, skb->data,
 					 ring->rx_buffersize, 0);
 	}
 
-	if (b43_dma_mapping_error(ring, dmaaddr, ring->rx_buffersize)) {
+	if (b43_dma_mapping_error(ring, dmaaddr, ring->rx_buffersize, 0)) {
 		dev_kfree_skb_any(skb);
 		return -EIO;
 	}
 
 	meta->skb = skb;
 	meta->dmaaddr = dmaaddr;
@@ -804,13 +810,14 @@ struct b43_dmaring *b43_setup_dmaring(st
 		/* test for ability to dma to txhdr_cache */
 		dma_test = dma_map_single(dev->dev->dev,
 					  ring->txhdr_cache,
 					  b43_txhdr_size(dev),
 					  DMA_TO_DEVICE);
 
-		if (b43_dma_mapping_error(ring, dma_test, b43_txhdr_size(dev))) {
+		if (b43_dma_mapping_error(ring, dma_test,
+					  b43_txhdr_size(dev), 1)) {
 			/* ugh realloc */
 			kfree(ring->txhdr_cache);
 			ring->txhdr_cache = kcalloc(nr_slots,
 						    b43_txhdr_size(dev),
 						    GFP_KERNEL | GFP_DMA);
 			if (!ring->txhdr_cache)
@@ -819,13 +826,13 @@ struct b43_dmaring *b43_setup_dmaring(st
 			dma_test = dma_map_single(dev->dev->dev,
 						  ring->txhdr_cache,
 						  b43_txhdr_size(dev),
 						  DMA_TO_DEVICE);
 
 			if (b43_dma_mapping_error(ring, dma_test,
-						  b43_txhdr_size(dev)))
+						  b43_txhdr_size(dev), 1))
 				goto err_kfree_txhdr_cache;
 		}
 
 		dma_unmap_single(dev->dev->dev,
 				 dma_test, b43_txhdr_size(dev),
 				 DMA_TO_DEVICE);
@@ -1120,13 +1127,13 @@ static int dma_tx_fragment(struct b43_dm
 		ring->used_slots = old_used_slots;
 		return err;
 	}
 
 	meta_hdr->dmaaddr = map_descbuffer(ring, (unsigned char *)header,
 					   hdrsize, 1);
-	if (b43_dma_mapping_error(ring, meta_hdr->dmaaddr, hdrsize)) {
+	if (b43_dma_mapping_error(ring, meta_hdr->dmaaddr, hdrsize, 1)) {
 		ring->current_slot = old_top_slot;
 		ring->used_slots = old_used_slots;
 		return -EIO;
 	}
 	ops->fill_descriptor(ring, desc, meta_hdr->dmaaddr,
 			     hdrsize, 1, 0, 0);
@@ -1139,13 +1146,13 @@ static int dma_tx_fragment(struct b43_dm
 	memcpy(&meta->txstat.control, ctl, sizeof(*ctl));
 	meta->skb = skb;
 	meta->is_last_fragment = 1;
 
 	meta->dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
 	/* create a bounce buffer in zone_dma on mapping failure. */
-	if (b43_dma_mapping_error(ring, meta->dmaaddr, skb->len)) {
+	if (b43_dma_mapping_error(ring, meta->dmaaddr, skb->len, 1)) {
 		bounce_skb = __dev_alloc_skb(skb->len, GFP_ATOMIC | GFP_DMA);
 		if (!bounce_skb) {
 			ring->current_slot = old_top_slot;
 			ring->used_slots = old_used_slots;
 			err = -ENOMEM;
 			goto out_unmap_hdr;
@@ -1153,13 +1160,13 @@ static int dma_tx_fragment(struct b43_dm
 
 		memcpy(skb_put(bounce_skb, skb->len), skb->data, skb->len);
 		dev_kfree_skb_any(skb);
 		skb = bounce_skb;
 		meta->skb = skb;
 		meta->dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
-		if (b43_dma_mapping_error(ring, meta->dmaaddr, skb->len)) {
+		if (b43_dma_mapping_error(ring, meta->dmaaddr, skb->len, 1)) {
 			ring->current_slot = old_top_slot;
 			ring->used_slots = old_used_slots;
 			err = -EIO;
 			goto out_free_bounce;
 		}
 	}


From mb at bu3sch.de  Sun Mar 23 01:08:22 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 23 Mar 2008 01:08:22 +0100
Subject: [PATCH] b43: Remove irqs_disabled() sanity checks
Message-ID: <200803230108.22652.mb@bu3sch.de>

Remove all irqs_disabled() sanity checks, as they are not safe on
a RT-enabled kernel and will trigger bogus warnings.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, please apply to 2.6.25


Index: wireless-testing/drivers/net/wireless/b43/debugfs.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/debugfs.c	2008-02-15 21:39:56.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/debugfs.c	2008-03-23 01:00:40.000000000 +0100
@@ -615,25 +615,25 @@ void b43_debugfs_remove_device(struct b4
 
 	debugfs_remove(e->subdir);
 	kfree(e->txstatlog.log);
 	kfree(e);
 }
 
+/* Called with IRQs disabled. */
 void b43_debugfs_log_txstat(struct b43_wldev *dev,
 			    const struct b43_txstatus *status)
 {
 	struct b43_dfsentry *e = dev->dfsentry;
 	struct b43_txstatus_log *log;
 	struct b43_txstatus *cur;
 	int i;
 
 	if (!e)
 		return;
 	log = &e->txstatlog;
-	B43_WARN_ON(!irqs_disabled());
-	spin_lock(&log->lock);
+	spin_lock(&log->lock); /* IRQs are already disabled. */
 	i = log->end + 1;
 	if (i == B43_NR_LOGGED_TXSTATUS)
 		i = 0;
 	log->end = i;
 	cur = &(log->log[i]);
 	memcpy(cur, status, sizeof(*cur));
Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-23 00:54:27.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-23 01:01:14.000000000 +0100
@@ -1343,26 +1343,27 @@ static void b43_fill_txstatus_report(str
 			ring->nr_succeed_tx_packets++;
 		ring->nr_total_packet_tries += status->frame_count;
 #endif /* DEBUG */
 	}
 }
 
+/* Called with IRQs disabled. */
 void b43_dma_handle_txstatus(struct b43_wldev *dev,
 			     const struct b43_txstatus *status)
 {
 	const struct b43_dma_ops *ops;
 	struct b43_dmaring *ring;
 	struct b43_dmadesc_generic *desc;
 	struct b43_dmadesc_meta *meta;
 	int slot;
 
 	ring = parse_cookie(dev, status->cookie, &slot);
 	if (unlikely(!ring))
 		return;
-	B43_WARN_ON(!irqs_disabled());
-	spin_lock(&ring->lock);
+
+	spin_lock(&ring->lock); /* IRQs are already disabled. */
 
 	B43_WARN_ON(!ring->tx);
 	ops = ring->ops;
 	while (1) {
 		B43_WARN_ON(!(slot >= 0 && slot < ring->nr_slots));
 		desc = ops->idx2desc(ring, slot, &meta);
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-03-22 21:50:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-03-23 00:59:05.000000000 +0100
@@ -2155,13 +2155,12 @@ static void b43_gpio_cleanup(struct b43_
 
 /* http://bcm-specs.sipsolutions.net/EnableMac */
 static void b43_mac_enable(struct b43_wldev *dev)
 {
 	dev->mac_suspended--;
 	B43_WARN_ON(dev->mac_suspended < 0);
-	B43_WARN_ON(irqs_disabled());
 	if (dev->mac_suspended == 0) {
 		b43_write32(dev, B43_MMIO_MACCTL,
 			    b43_read32(dev, B43_MMIO_MACCTL)
 			    | B43_MACCTL_ENABLED);
 		b43_write32(dev, B43_MMIO_GEN_IRQ_REASON,
 			    B43_IRQ_MAC_SUSPENDED);
@@ -2181,13 +2180,12 @@ static void b43_mac_enable(struct b43_wl
 static void b43_mac_suspend(struct b43_wldev *dev)
 {
 	int i;
 	u32 tmp;
 
 	might_sleep();
-	B43_WARN_ON(irqs_disabled());
 	B43_WARN_ON(dev->mac_suspended < 0);
 
 	if (dev->mac_suspended == 0) {
 		/* Mask IRQs before suspending MAC. Otherwise
 		 * the MAC stays busy and won't suspend. */
 		spin_lock_irq(&dev->wl->irq_lock);


From mb at bu3sch.de  Sun Mar 23 01:33:58 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 23 Mar 2008 01:33:58 +0100
Subject: [PATCH] b43: Don't compile N-PHY code when N-PHY is disabled
Message-ID: <200803230133.58314.mb@bu3sch.de>

There's no need to compile the N-PHY support code, when the
N-PHY support is disabled in Kconfig.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, please apply to 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/Makefile
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Makefile	2008-02-15 21:39:56.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/Makefile	2008-03-23 01:21:01.000000000 +0100
@@ -1,11 +1,11 @@
 b43-y				+= main.o
 b43-y				+= tables.o
-b43-y				+= tables_nphy.o
+b43-$(CONFIG_B43_NPHY)		+= tables_nphy.o
 b43-y				+= phy.o
-b43-y				+= nphy.o
+b43-$(CONFIG_B43_NPHY)		+= nphy.o
 b43-y				+= sysfs.o
 b43-y				+= xmit.o
 b43-y				+= lo.o
 b43-y				+= wa.o
 b43-y				+= dma.o
 b43-$(CONFIG_B43_RFKILL)	+= rfkill.o
Index: wireless-testing/drivers/net/wireless/b43/nphy.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/nphy.h	2008-02-15 21:39:56.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/nphy.h	2008-03-23 01:24:54.000000000 +0100
@@ -916,17 +916,57 @@
 #define B2055_C2_GENSPARE2		0xE2 /* Core 2 GEN spare 2 */
 
 
 
 struct b43_wldev;
 
+
+#ifdef CONFIG_B43_NPHY
+/* N-PHY support enabled */
+
 int b43_phy_initn(struct b43_wldev *dev);
 
 void b43_nphy_radio_turn_on(struct b43_wldev *dev);
 void b43_nphy_radio_turn_off(struct b43_wldev *dev);
 
 int b43_nphy_selectchannel(struct b43_wldev *dev, u8 channel);
 
 void b43_nphy_xmitpower(struct b43_wldev *dev);
 void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna);
 
+
+#else /* CONFIG_B43_NPHY */
+/* N-PHY support disabled */
+
+
+static inline
+int b43_phy_initn(struct b43_wldev *dev)
+{
+	return -EOPNOTSUPP;
+}
+
+static inline
+void b43_nphy_radio_turn_on(struct b43_wldev *dev)
+{
+}
+static inline
+void b43_nphy_radio_turn_off(struct b43_wldev *dev)
+{
+}
+
+static inline
+int b43_nphy_selectchannel(struct b43_wldev *dev, u8 channel)
+{
+	return -ENOSYS;
+}
+
+static inline
+void b43_nphy_xmitpower(struct b43_wldev *dev)
+{
+}
+static inline
+void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
+{
+}
+
+#endif /* CONFIG_B43_NPHY */
 #endif /* B43_NPHY_H_ */


From myheadblewoff at hotmail.com  Sun Mar 23 02:58:28 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Sun, 23 Mar 2008 11:58:28 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W8CCD1FBFBA9EA8B43EA32A0030@phx.gbl>



Greetings again,


....and the plot thickens....

  .....I was already thinking like Larry's posting, about how much I could actually trust this so called 'softAP' mode of the XP - asus driver&management suite, so probably right about the time Larry was typing that down, I'd concluded to buy a wireless router/AP instead, and help remove any doubts here...thus, what I've ended up with is a Netgear WGR614 r7 device, and it appears to work 'as expected' out-of-the-box. I dialled in the same WLAN params I've been using thus far, into the netgear wap, hit the apply button...amble into my son's XP box, change from 'softAP' to 'infrastructure' mode..and after XP thought about it some, the wifi connection came up, worked, inet connectivity and all....
                                ....[and just as quickly a few minutes later, it all fell on it's face....apparently that XP box has some contention over who is handling the wifi connection, 'windoze zero config' or the asus config manager]...but I managed to shut one of them up, and it worked....


..Meanwhile, back at this linux box, I'm in a different situation again...now I know the hardware actually works, that my configurata was valid input..and that there no love|hate war between asus cards and netgear waps...at least,this is what XP exampled. The linux side of the fence looks different but nowhere near sane ;


wlan0     Link encap:Ethernet  HWaddr 00:1B:FC:61:15:E1
          inet addr:172.16.1.234  Bcast:172.16.1.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:894 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:54238 (52.9 KiB)

...that zero RX packet has got to be a worrying field. If it is to be believed, it'd certainly explain why I can't ping anything, anywhere with tcpip on wlan0...

...I'd be fairly sure that I shouldn't see this either ;

wlan0: authenticate with AP 00:1e:2a:61:7d:2c
phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
wlan0: authenticate with AP 00:1e:2a:61:7d:2c
phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out

....on the other hand, if RX packets = 0 on the interface and that's true, then I probably would expect to see something like that...

Strangely, turning encryption off altogether in the AP itself and the linux setup here, made absolutely no difference apart from the fact that you then don't get debug messages about authentication attempts and failures.....and this make me think it's not authenticaion/encryption, seeing as the use (or not) of such security measures makes absolutly no difference to the tcpip layer - it seems dead. AFAICT, the radio (wireless) layer is doing all the right things, and the tcpip networking & routing>should< work, but and alas nothing happens...in fact, I doubt I've see ANY count on RX packets on wlan0 ever....

One other curious thing -- if this machine is at 172.16.1.234 and the wireless AP is at 172.16.1.1 and I try to ping that end address across wlan0, the ping command itself performs very slowly, and I'll have to send it several rapidfire ^C breaks to get it to return. It might take it up to 10second to release and give me my prompt back, but in doing so it reports that it only got around to sending 3 packets in 10-15seconds worth of realtime - this is fairly bizarre behaviour, and no..there's no firewall in anyone's way.....

   So...does anyone have any suggestion? Before I start c&p attachments willynilly, what in particular does anybody want to see? Or what path should I take to find out just what's going wrong here?

       I'll just keep poking it with a stick and hope it gets as mad at me, as I am with it (;

                           
                                                 Regards,

                                                               Donald



_________________________________________________________________
Search for local singles online @ Lavalife
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Flavalife9%2Eninemsn%2Ecom%2Eau%2Fclickthru%2Fclickthru%2Eact%3Fid%3Dninemsn%26context%3Dan99%26locale%3Den%5FAU%26a%3D30290&_t=764581033&_r=email_taglines_Search_OCT07&_m=EXT

From johannes at sipsolutions.net  Sun Mar 23 13:31:23 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 23 Mar 2008 13:31:23 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W8CCD1FBFBA9EA8B43EA32A0030@phx.gbl>
	(sfid-20080323_021747_299680_ECEDD4C1)
References: <BAY107-W8CCD1FBFBA9EA8B43EA32A0030@phx.gbl>
	(sfid-20080323_021747_299680_ECEDD4C1)
Message-ID: <1206275483.16475.189.camel@johannes.berg>


> ...I'd be fairly sure that I shouldn't see this either ;
> 
> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
> phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
> phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
> wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out

For one you should turn off low-level debugging ;)

But the timeouts are another matter.

> ....on the other hand, if RX packets = 0 on the interface and that's
> true, then I probably would expect to see something like that...

Not entirely sure those stats are kept properly, but I think they are.

> Strangely, turning encryption off altogether in the AP itself and the
> linux setup here, made absolutely no difference apart from the fact
> that you then don't get debug messages about authentication attempts
> and failures.....and this make me think it's not
> authenticaion/encryption, seeing as the use (or not) of such security
> measures makes absolutly no difference to the tcpip layer - it seems
> dead. AFAICT, the radio (wireless) layer is doing all the right
> things, and the tcpip networking & routing>should< work, but and alas
> nothing happens...in fact, I doubt I've see ANY count on RX packets on
> wlan0 ever....

No, it's more likely a transmission bug. Can you enable b43 debugfs,
mount debugfs, and check the output of
cat /debug/b43/phy*/txstat

> One other curious thing -- if this machine is at 172.16.1.234 and the
> wireless AP is at 172.16.1.1 and I try to ping that end address across
> wlan0, the ping command itself performs very slowly, and I'll have to
> send it several rapidfire ^C breaks to get it to return. It might take
> it up to 10second to release and give me my prompt back, but in doing
> so it reports that it only got around to sending 3 packets in
> 10-15seconds worth of realtime - this is fairly bizarre behaviour, and
> no..there's no firewall in anyone's way.....

That's pretty normal if it cannot reverse-resolve the name.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080323/3b7e3628/attachment.pgp>

From myheadblewoff at hotmail.com  Sun Mar 23 14:58:08 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Sun, 23 Mar 2008 23:58:08 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W49D21AF13B41837AA42DE1A0030@phx.gbl>



----------------------------------------
> Subject: RE: More on ASUS WL-138G V2
> From: johannes at sipsolutions.net
> To: myheadblewoff at hotmail.com
> CC: bcm43xx-dev at lists.berlios.de
> Date: Sun, 23 Mar 2008 13:31:23 +0100
>
>
>> ...I'd be fairly sure that I shouldn't see this either ;
>>
>> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
>> phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
>> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
>> phy3: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
>> wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out
>
> For one you should turn off low-level debugging ;)
>
> But the timeouts are another matter.
>
>> ....on the other hand, if RX packets = 0 on the interface and that's
>> true, then I probably would expect to see something like that...
>
> Not entirely sure those stats are kept properly, but I think they are.
>

....okay...

[snip]...

>
> No, it's more likely a transmission bug. Can you enable b43 debugfs,
> mount debugfs, and check the output of
> cat /debug/b43/phy*/txstat
>

.....all ready to go, mounted it and saw...


root at bits64:~# cat /debug/b43/phy*/txstat

Nothing transmitted, yet.


That situation did not change -- 5minutes of low level gibberish in dmesg (like the above ;) and /debug/b43/phy*/txstat did NOT change...


   That's not good, is it?.....Next?...


                         Kind regards,
                                             Donald
>
> johannes

_________________________________________________________________
Fashion, beauty, health, relationship advice and horoscopes.
http://ninemsn.com.au/share/redir/adTrack.asp?mode=click&clientID=873&referral=MarchHotmailTagline&URL=http://lifestyle.ninemsn.com.au/?ocid=T003HOT40A0710G

From mb at bu3sch.de  Sun Mar 23 15:04:09 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 23 Mar 2008 15:04:09 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W49D21AF13B41837AA42DE1A0030@phx.gbl>
References: <BAY107-W49D21AF13B41837AA42DE1A0030@phx.gbl>
Message-ID: <200803231504.09464.mb@bu3sch.de>

On Sunday 23 March 2008 14:58:08 kala mazoo wrote:
> root at bits64:~# cat /debug/b43/phy*/txstat
> 
> Nothing transmitted, yet.
> 
> 
> That situation did not change -- 5minutes of low level gibberish in dmesg (like the above ;) and /debug/b43/phy*/txstat did NOT change...
> 
> 
>    That's not good, is it?.....Next?...

dmesg after ifconfig down with b43 debug enabled, please.

-- 
Greetings Michael.


From myheadblewoff at hotmail.com  Sun Mar 23 15:11:37 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Mon, 24 Mar 2008 00:11:37 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W4820125E79E1D61F589B21A0030@phx.gbl>



----------------------------------------
> From: mb at bu3sch.de
> To: bcm43xx-dev at lists.berlios.de
> Subject: Re: More on ASUS WL-138G V2
> Date: Sun, 23 Mar 2008 15:04:09 +0100
> CC: myheadblewoff at hotmail.com; johannes at sipsolutions.net
>
> On Sunday 23 March 2008 14:58:08 kala mazoo wrote:
>> root at bits64:~# cat /debug/b43/phy*/txstat
>>
>> Nothing transmitted, yet.
>>
>>
>> That situation did not change -- 5minutes of low level gibberish in dmesg (like the above ;) and /debug/b43/phy*/txstat did NOT change...
>>
>>
>>    That's not good, is it?.....Next?...
>
> dmesg after ifconfig down with b43 debug enabled, please.
>
> --
> Greetings Michael.

   Hey there Michael,

                                What you ask for appears below with a little preamble...;

HW CONFIG: channel=1 freq=2412 phymode=2
HW CONFIG: channel=1 freq=2412 phymode=2
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:1e:2a:61:7d:2c
phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
wlan0: authenticate with AP 00:1e:2a:61:7d:2c
phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
wlan0: authenticate with AP 00:1e:2a:61:7d:2c
phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out
b43-phy0 debug: Disabling hardware based encryption for keyidx: 0, mac: ff:ff:ff
:ff:ff:ff
b43-phy0 debug: Removing Interface type 2
b43-phy0 debug: Wireless interface stopped
b43-phy0 debug: DMA-32 0x0200 (RX) max used slots: 1/64
b43-phy0 debug: DMA-32 0x02A0 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0280 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0260 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0240 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0220 (TX) max used slots: 50/128
b43-phy0 debug: DMA-32 0x0200 (TX) max used slots: 0/128


                            Kind regards,
                                                   Donald

_________________________________________________________________
It's simple! Sell your car for just $30 at CarPoint.com.au
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fsecure%2Dau%2Eimrworldwide%2Ecom%2Fcgi%2Dbin%2Fa%2Fci%5F450304%2Fet%5F2%2Fcg%5F801459%2Fpi%5F1004813%2Fai%5F859641&_t=762955845&_r=tig_OCT07&_m=EXT

From mb at bu3sch.de  Sun Mar 23 15:17:06 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 23 Mar 2008 15:17:06 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W4820125E79E1D61F589B21A0030@phx.gbl>
References: <BAY107-W4820125E79E1D61F589B21A0030@phx.gbl>
Message-ID: <200803231517.06314.mb@bu3sch.de>

On Sunday 23 March 2008 15:11:37 kala mazoo wrote:
> 
> ----------------------------------------
> > From: mb at bu3sch.de
> > To: bcm43xx-dev at lists.berlios.de
> > Subject: Re: More on ASUS WL-138G V2
> > Date: Sun, 23 Mar 2008 15:04:09 +0100
> > CC: myheadblewoff at hotmail.com; johannes at sipsolutions.net
> >
> > On Sunday 23 March 2008 14:58:08 kala mazoo wrote:
> >> root at bits64:~# cat /debug/b43/phy*/txstat
> >>
> >> Nothing transmitted, yet.
> >>
> >>
> >> That situation did not change -- 5minutes of low level gibberish in dmesg (like the above ;) and /debug/b43/phy*/txstat did NOT change...
> >>
> >>
> >>    That's not good, is it?.....Next?...
> >
> > dmesg after ifconfig down with b43 debug enabled, please.
> >
> > --
> > Greetings Michael.
> 
>    Hey there Michael,
> 
>                                 What you ask for appears below with a little preamble...;
> 
> HW CONFIG: channel=1 freq=2412 phymode=2
> HW CONFIG: channel=1 freq=2412 phymode=2
> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c 
> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
> wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out
> b43-phy0 debug: Disabling hardware based encryption for keyidx: 0, mac: ff:ff:ff
> :ff:ff:ff
> b43-phy0 debug: Removing Interface type 2
> b43-phy0 debug: Wireless interface stopped
> b43-phy0 debug: DMA-32 0x0200 (RX) max used slots: 1/64
> b43-phy0 debug: DMA-32 0x02A0 (TX) max used slots: 0/128
> b43-phy0 debug: DMA-32 0x0280 (TX) max used slots: 0/128
> b43-phy0 debug: DMA-32 0x0260 (TX) max used slots: 0/128
> b43-phy0 debug: DMA-32 0x0240 (TX) max used slots: 0/128
> b43-phy0 debug: DMA-32 0x0220 (TX) max used slots: 50/128
> b43-phy0 debug: DMA-32 0x0200 (TX) max used slots: 0/128

Ok, the card does not transmit the data.
A few people reported this and I have absolutely no idea what's going on.

-- 
Greetings Michael.


From myheadblewoff at hotmail.com  Sun Mar 23 15:53:27 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Mon, 24 Mar 2008 00:53:27 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W4C189D096B2AC4C2971C2A0030@phx.gbl>



----------------------------------------
> From: mb at bu3sch.de
> To: myheadblewoff at hotmail.com
> Subject: Re: More on ASUS WL-138G V2
> Date: Sun, 23 Mar 2008 15:17:06 +0100
> CC: bcm43xx-dev at lists.berlios.de
>
> On Sunday 23 March 2008 15:11:37 kala mazoo wrote:
>>
>> ----------------------------------------
>>> From: mb at bu3sch.de
>>> To: bcm43xx-dev at lists.berlios.de
>>> Subject: Re: More on ASUS WL-138G V2
>>> Date: Sun, 23 Mar 2008 15:04:09 +0100
>>> CC: myheadblewoff at hotmail.com; johannes at sipsolutions.net
>>>
>>> On Sunday 23 March 2008 14:58:08 kala mazoo wrote:
>>>> root at bits64:~# cat /debug/b43/phy*/txstat
>>>>
>>>> Nothing transmitted, yet.
>>>>
>>>>
>>>> That situation did not change -- 5minutes of low level gibberish in dmesg (like the above ;) and /debug/b43/phy*/txstat did NOT change...
>>>>
>>>>
>>>>    That's not good, is it?.....Next?...
>>>
>>> dmesg after ifconfig down with b43 debug enabled, please.
>>>
>>> --
>>> Greetings Michael.
>>
>>    Hey there Michael,
>>
>>                                 What you ask for appears below with a little preamble...;
>>
>> HW CONFIG: channel=1 freq=2412 phymode=2
>> HW CONFIG: channel=1 freq=2412 phymode=2
>> wlan0: Initial auth_alg=0
>> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
>> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c
>> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
>> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
>> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c
>> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
>> wlan0: authenticate with AP 00:1e:2a:61:7d:2c
>> phy0: TX to low-level driver (len=30) FC=0x00b0 DUR=0x013a A1=00:1e:2a:61:7d:2c
>> A2=00:1b:fc:61:15:e1 A3=00:1e:2a:61:7d:2c
>> wlan0: authentication with AP 00:1e:2a:61:7d:2c timed out
>> b43-phy0 debug: Disabling hardware based encryption for keyidx: 0, mac: ff:ff:ff
>> :ff:ff:ff
>> b43-phy0 debug: Removing Interface type 2
>> b43-phy0 debug: Wireless interface stopped
>> b43-phy0 debug: DMA-32 0x0200 (RX) max used slots: 1/64
>> b43-phy0 debug: DMA-32 0x02A0 (TX) max used slots: 0/128
>> b43-phy0 debug: DMA-32 0x0280 (TX) max used slots: 0/128
>> b43-phy0 debug: DMA-32 0x0260 (TX) max used slots: 0/128
>> b43-phy0 debug: DMA-32 0x0240 (TX) max used slots: 0/128
>> b43-phy0 debug: DMA-32 0x0220 (TX) max used slots: 50/128
>> b43-phy0 debug: DMA-32 0x0200 (TX) max used slots: 0/128
>
> Ok, the card does not transmit the data.
> A few people reported this and I have absolutely no idea what's going on.
>

....well, there you go ...I am sane after all. Perhaps should someone put up a little compatibility caveat on the b43 webpage, warning people that there are issues with this brand/model of card that remain unresolved? Not to worry....I'll just backtrack all this on the 32bit P4 box to make sure the situation with that older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...

...does ebay run 'give away' ads? ..ie; "Give Away ASUS WL-138G V2 wireless LAN cards, PCI....suit linux software driver developer.."   (hehe)

   Thanks to all who replied and helped me out -- I'll monitor the list and watch for developments. If you need me to try something out, just email me - I'll be glad to help out if I can...

                      Kind regards,

                                           Donald

_________________________________________________________________
It's simple! Sell your car for just $30 at CarPoint.com.au
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fsecure%2Dau%2Eimrworldwide%2Ecom%2Fcgi%2Dbin%2Fa%2Fci%5F450304%2Fet%5F2%2Fcg%5F801459%2Fpi%5F1004813%2Fai%5F859641&_t=762955845&_r=tig_OCT07&_m=EXT

From Larry.Finger at lwfinger.net  Sun Mar 23 17:08:46 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 23 Mar 2008 09:08:46 -0700
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W4C189D096B2AC4C2971C2A0030@phx.gbl>
References: <BAY107-W4C189D096B2AC4C2971C2A0030@phx.gbl>
Message-ID: <47E6808E.9080800@lwfinger.net>

kala mazoo wrote:
> 
> ----------------------------------------
>> From: mb at bu3sch.de
>> Ok, the card does not transmit the data.
>> A few people reported this and I have absolutely no idea what's going on.
>>
> 
> ....well, there you go ...I am sane after all. Perhaps should someone put up a little compatibility caveat on the b43 webpage, warning people that there are issues with this brand/model of card that remain unresolved? Not to worry....I'll just backtrack all this on the 32bit P4 box to make sure the situation with that older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...
> 
> ...does ebay run 'give away' ads? ..ie; "Give Away ASUS WL-138G V2 wireless LAN cards, PCI....suit linux software driver developer.."   (hehe)
> 
>    Thanks to all who replied and helped me out -- I'll monitor the list and watch for developments. If you need me to try something out, just email me - I'll be glad to help out if I can...

What format is this card. It is probably someplace in the thread, but I have developed bad habits by 
watching the behaviour (British spelling intentional!!) of others on this list. Perhaps there is a 
developer in AU that might be interested in looking at this card to solve the issue. If there is no 
one there, I would be willing to pay the shipping cost to the US if it will fit in one of my machines.

Larry



From mb at bu3sch.de  Mon Mar 24 00:37:51 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 24 Mar 2008 00:37:51 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W4C189D096B2AC4C2971C2A0030@phx.gbl>
References: <BAY107-W4C189D096B2AC4C2971C2A0030@phx.gbl>
Message-ID: <200803240037.51257.mb@bu3sch.de>

On Sunday 23 March 2008 15:53:27 kala mazoo wrote:
> ....well, there you go ...I am sane after all. Perhaps should someone put
> up a little compatibility caveat on the b43 webpage, warning people that there are
> issues with this brand/model of card that remain unresolved? Not to worry....I'll

We don't even know why and on which hardware it does happen. So how can we
add a warning about something we don't know?

> just backtrack all this on the 32bit P4 box to make sure the situation with that 
> older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...    

Are you running on x86_64?
Can you try booting without IOMMU support?
I think it's the commanline option iommu=0 or iommu=off or something like that.

The driver does not work on x86_64 with IOMMU. That's because the IOMMU
code is broken. (not a b43 bug)

-- 
Greetings Michael.


From myheadblewoff at hotmail.com  Mon Mar 24 03:10:37 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Mon, 24 Mar 2008 12:10:37 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W51B7C9D4DEB7EE3D09D37FA0FD0@phx.gbl>



----------------------------------------
> Date: Sun, 23 Mar 2008 09:08:46 -0700
> From: Larry.Finger at lwfinger.net
> To: myheadblewoff at hotmail.com
> CC: mb at bu3sch.de; bcm43xx-dev at lists.berlios.de
> Subject: Re: More on ASUS WL-138G V2
>
> kala mazoo wrote:
>>
>> ----------------------------------------
>>> From: mb at bu3sch.de
>>> Ok, the card does not transmit the data.
>>> A few people reported this and I have absolutely no idea what's going on.
>>>
>>
>> ....well, there you go ...I am sane after all. Perhaps should someone put up a little compatibility caveat on the b43 webpage, warning people that there are issues with this brand/model of card that remain unresolved? Not to worry....I'll just backtrack all this on the 32bit P4 box to make sure the situation with that older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...
>>
>> ...does ebay run 'give away' ads? ..ie; "Give Away ASUS WL-138G V2 wireless LAN cards, PCI....suit linux software driver developer.."   (hehe)
>>
>>    Thanks to all who replied and helped me out -- I'll monitor the list and watch for developments. If you need me to try something out, just email me - I'll be glad to help out if I can...
>
> What format is this card. It is probably someplace in the thread, but I have developed bad habits by
> watching the behaviour (British spelling intentional!!) of others on this list. Perhaps there is a
> developer in AU that might be interested in looking at this card to solve the issue. If there is no
> one there, I would be willing to pay the shipping cost to the US if it will fit in one of my machines.
>
> Larry
>

    Hey there Larry,
                                The cards are PCI form. If there is someone in .AU wanting to help with this, then they'd better speak up (here, on the list),because otherwise I won't ever know they're out there...

                  If you want a card to play with, get back to me with your snail address and I'll pop one in the mail for you. Don't worry about shipping costs, I'll pickup that tab (and the cost of the card itself)  and consider it my donation to the b43 development drive....


                          Kind regards,

                                                 Donald
_________________________________________________________________
Search for local singles online @ Lavalife
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Flavalife9%2Eninemsn%2Ecom%2Eau%2Fclickthru%2Fclickthru%2Eact%3Fid%3Dninemsn%26context%3Dan99%26locale%3Den%5FAU%26a%3D30290&_t=764581033&_r=email_taglines_Search_OCT07&_m=EXT

From myheadblewoff at hotmail.com  Mon Mar 24 02:59:53 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Mon, 24 Mar 2008 11:59:53 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W5248F1D4C3CB6D8914FE1BA0FD0@phx.gbl>



----------------------------------------
> From: mb at bu3sch.de
> To: bcm43xx-dev at lists.berlios.de
> Subject: Re: More on ASUS WL-138G V2
> Date: Mon, 24 Mar 2008 00:37:51 +0100
> CC: myheadblewoff at hotmail.com
>
> On Sunday 23 March 2008 15:53:27 kala mazoo wrote:
>> ....well, there you go ...I am sane after all. Perhaps should someone put
>> up a little compatibility caveat on the b43 webpage, warning people that there are
>> issues with this brand/model of card that remain unresolved? Not to worry....I'll
>
> We don't even know why and on which hardware it does happen. So how can we
> add a warning about something we don't know?
>

....Faith? No, seriously....point taken, but we do know -something- ...ie; as you indicated earlier, a few people have reported this problem before..not just me, and so even though we don't know exactly why it is so or which hardware combination(s) exhibit this behaviour....(yet!).....we>do< know that -some- examples of bcm4318 based wireless PCI LAN adapters...particularly the asus WL-138G V2....suffer from this problem in some hardware setups.

   Do we know if anybody out there has this card working 'as expected' yet? If so, what hardware setup are they using? .....

     My point is, anyone going to the b43 website would be forgiven for presuming that this card *does* work with the b43 driver, because nothing says otherwise. Sure, a quick check of the bcm43xx-dev-mailing-list will have them discover otherwise...(and if they knew this aforehand they'd probably AVOID buying one of these card types in the first place)....but *most* people don't do things like this - they'll just go to the website, see that bcm4318 is supported and working and expect things to work...

    So, your question is 'how can we add a warning about something we don't know?' Well...in the supported/unsupported section of the b43 website, you could include a paragraph like this ;

                                   Note that some users of the b43 driver code are reporting issues with some (not all?) bcm4318 based hardware implementations. In particular, the ASUS branded cards, model WL-138G V2, are being reported as not working by a number of users, but as yet we are unsure as to exactly what is causing this problem, or in what specific hardware combinations the problem manifests itself. This issue is being actively investigated and hopefully will be resolved in the fullness of time, but for now 'your mileage may vary' with this particular brand/model of card. See the bcm43xx-dev mailing list archives for more...   


.....like that...


>> just backtrack all this on the 32bit P4 box to make sure the situation with that
>> older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...
>
> Are you running on x86_64?
> Can you try booting without IOMMU support?
> I think it's the commanline option iommu=0 or iommu=off or something like that.
>
> The driver does not work on x86_64 with IOMMU. That's because the IOMMU
> code is broken. (not a b43 bug)
>

....Yes, this machine is an AMD64 (AM2 x2) setup --- I'll hunt down the exact kernel param to boot with and get back to you with any results...


                                  Kind regards,
                                                        Donald




> --
> Greetings Michael.

_________________________________________________________________
Get MOTORAZR MAXX V6 now $249 on Next G? Pre-Paid
http://clk.atdmt.com/OAT/go/nnmsntel0690000034oat/direct/01/

From gavron at wetwork.net  Mon Mar 24 03:30:50 2008
From: gavron at wetwork.net (gavron at wetwork.net)
Date: Sun, 23 Mar 2008 19:30:50 -0700
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W51B7C9D4DEB7EE3D09D37FA0FD0@phx.gbl>
References: <BAY107-W51B7C9D4DEB7EE3D09D37FA0FD0@phx.gbl>
Message-ID: <47E7125A.1070102@wetwork.net>

I'll happily pick up the cost of shipping his card to Larry if it will 
make him shut up.  You can send it on my FedEx code or I'll PayPal you 
the cost.

Ehud
(less Human than Michael)

kala mazoo wrote:
> ----------------------------------------
>   
>> Date: Sun, 23 Mar 2008 09:08:46 -0700
>> From: Larry.Finger at lwfinger.net
>> To: myheadblewoff at hotmail.com
>> CC: mb at bu3sch.de; bcm43xx-dev at lists.berlios.de
>> Subject: Re: More on ASUS WL-138G V2
>>
>> kala mazoo wrote:
>>     
>>> ----------------------------------------
>>>       
>>>> From: mb at bu3sch.de
>>>> Ok, the card does not transmit the data.
>>>> A few people reported this and I have absolutely no idea what's going on.
>>>>
>>>>         
>>> ....well, there you go ...I am sane after all. Perhaps should someone put up a little compatibility caveat on the b43 webpage, warning people that there are issues with this brand/model of card that remain unresolved? Not to worry....I'll just backtrack all this on the 32bit P4 box to make sure the situation with that older slower hardware....and I guess it's off to the computer shop on tuesday to buy some different cards...
>>>
>>> ...does ebay run 'give away' ads? ..ie; "Give Away ASUS WL-138G V2 wireless LAN cards, PCI....suit linux software driver developer.."   (hehe)
>>>
>>>    Thanks to all who replied and helped me out -- I'll monitor the list and watch for developments. If you need me to try something out, just email me - I'll be glad to help out if I can...
>>>       
>> What format is this card. It is probably someplace in the thread, but I have developed bad habits by
>> watching the behaviour (British spelling intentional!!) of others on this list. Perhaps there is a
>> developer in AU that might be interested in looking at this card to solve the issue. If there is no
>> one there, I would be willing to pay the shipping cost to the US if it will fit in one of my machines.
>>
>> Larry
>>
>>     
>
>     Hey there Larry,
>                                 The cards are PCI form. If there is someone in .AU wanting to help with this, then they'd better speak up (here, on the list),because otherwise I won't ever know they're out there...
>
>                   If you want a card to play with, get back to me with your snail address and I'll pop one in the mail for you. Don't worry about shipping costs, I'll pickup that tab (and the cost of the card itself)  and consider it my donation to the b43 development drive....
>
>
>                           Kind regards,
>
>                                                  Donald
> _________________________________________________________________
> Search for local singles online @ Lavalife
> http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Flavalife9%2Eninemsn%2Ecom%2Eau%2Fclickthru%2Fclickthru%2Eact%3Fid%3Dninemsn%26context%3Dan99%26locale%3Den%5FAU%26a%3D30290&_t=764581033&_r=email_taglines_Search_OCT07&_m=EXT
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   


From Larry.Finger at lwfinger.net  Mon Mar 24 05:45:46 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 23 Mar 2008 21:45:46 -0700
Subject: More on ASUS WL-138G V2
In-Reply-To: <47E7125A.1070102@wetwork.net>
References: <BAY107-W51B7C9D4DEB7EE3D09D37FA0FD0@phx.gbl>
	<47E7125A.1070102@wetwork.net>
Message-ID: <47E731FA.5070207@lwfinger.net>

gavron at wetwork.net wrote:
> I'll happily pick up the cost of shipping his card to Larry if it will 
> make him shut up.  You can send it on my FedEx code or I'll PayPal you 
> the cost.

If the problem is an IOMMU problem with x86_64, I wouldn't be able to reproduce it anyway. My only 
PCI system has a P4 cpu.

Larry



From myheadblewoff at hotmail.com  Mon Mar 24 06:52:29 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Mon, 24 Mar 2008 15:52:29 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W20429AF77E63DF7973A0E1A0FD0@phx.gbl>





>
> Are you running on x86_64?
> Can you try booting without IOMMU support?
> I think it's the commanline option iommu=0 or iommu=off or something like that.
>
> The driver does not work on x86_64 with IOMMU. That's because the IOMMU
> code is broken. (not a b43 bug)
>
> --

  Hi Michael,

                       As requested, booted with ..

Linux version 2.6.24 (root at bits64.thehut.net) (gcc version 4.1.1) #3 SMP Sun Mar 23 16:43:09 EST 2008
Command line: BOOT_IMAGE=linux ro root=806 iommu=off


    This made no difference to the situation here at all -- things are exactly the same as before.


 If we -assume- from this that IOMMU functionality in X86_64 is *not* the issue here, then perhaps Larry's P4 will be of use finding this fault after all?


    Let me know....


                            Kind regards,
                                                   Donald




_________________________________________________________________
Fashion, beauty, health, relationship advice and horoscopes.
http://ninemsn.com.au/share/redir/adTrack.asp?mode=click&clientID=873&referral=MarchHotmailTagline&URL=http://lifestyle.ninemsn.com.au/?ocid=T003HOT40A0710G

From mb at bu3sch.de  Mon Mar 24 10:40:37 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 24 Mar 2008 10:40:37 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W5248F1D4C3CB6D8914FE1BA0FD0@phx.gbl>
References: <BAY107-W5248F1D4C3CB6D8914FE1BA0FD0@phx.gbl>
Message-ID: <200803241040.38337.mb@bu3sch.de>

On Monday 24 March 2008 02:59:53 kala mazoo wrote:
> ....Faith? No, seriously....point taken, but we do know -something- 
> ...ie; as you indicated earlier, a few people have reported this 
> problem before..not just me, and so even though we don't know exactly 
> why it is so or which hardware combination(s) exhibit this behaviour
> ....(yet!).....we>do< know that -some- examples of bcm4318 based wireless 
> PCI LAN adapters...particularly the asus WL-138G V2....suffer from this 
> problem in some hardware setups.      

So, why don't you collect that info, verify it and put it into the wiki?

>    Do we know if anybody out there has this card working 'as expected' yet?

I have plenty of 4318s working.

>    If so, what hardware setup are they using? ..... 

i386 and powerpc.

>      My point is, anyone going to the b43 website would be forgiven 
>      for presuming that this card *does* work with the b43 driver, because nothing says otherwise.

We are not even sure yet that it's the _card_ that makes it fail.
It could also be the architecture.

>      Sure, a quick check of the bcm43xx-dev-mailing-list will have them discover 
>      otherwise...(and if they knew this aforehand they'd probably AVOID buying 
>      one of these card types in the first place)....but *most* people don't do 
>      things like this - they'll just go to the website, see that bcm4318 is 
>      supported and working and expect things to work...      
> 
>     So, your question is 'how can we add a warning about something we don't 
>     know?' Well...in the supported/unsupported section of the b43 website, 
>     you could include a paragraph like this ;  
> 
>                                    Note that some users of the b43 driver 
>                                    code are reporting issues with some (not all?) 
>                                    bcm4318 based hardware implementations. In particular, 
>                                    the ASUS branded cards, model WL-138G V2, are being 
>                                    reported as not working by a number of users, but as 
>                                    yet we are unsure as to exactly what is causing this 
>                                    problem, or in what specific hardware combinations the 
>                                    problem manifests itself. This issue is being actively 
>                                    investigated and hopefully will be resolved in the 
>                                    fullness of time, but for now 'your mileage may vary'
>                                    with this particular brand/model of card. See the 
>                                    bcm43xx-dev mailing list archives for more...    

In general such warning messages tend to live forever.
We still have people telling others that we have TX power issues. The actual issue
is gone for a long time, but still people think it's there.
That's the reason why I do _not_ put such warnings on the page. As removing them
again (from peoples heads) is impossible.
 
> > The driver does not work on x86_64 with IOMMU. That's because the IOMMU
> > code is broken. (not a b43 bug)
> >
> 
> ....Yes, this machine is an AMD64 (AM2 x2) setup --- I'll hunt down 
> the exact kernel param to boot with and get back to you with any results... 

Thanks.

PS: Could you please hit the return key at about 80col?
It's painful to quote your posts.

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Mar 24 10:43:05 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 24 Mar 2008 10:43:05 +0100
Subject: More on ASUS WL-138G V2
In-Reply-To: <47E731FA.5070207@lwfinger.net>
References: <BAY107-W51B7C9D4DEB7EE3D09D37FA0FD0@phx.gbl>
	<47E7125A.1070102@wetwork.net> <47E731FA.5070207@lwfinger.net>
Message-ID: <200803241043.06135.mb@bu3sch.de>

On Monday 24 March 2008 05:45:46 Larry Finger wrote:
> gavron at wetwork.net wrote:
> > I'll happily pick up the cost of shipping his card to Larry if it will 
> > make him shut up.  You can send it on my FedEx code or I'll PayPal you 
> > the cost.
> 
> If the problem is an IOMMU problem with x86_64, I wouldn't be able to reproduce it anyway. My only 
> PCI system has a P4 cpu.

Well, you could test if the card works at all.
The IOMMU bug doesn't need to get debugged. We know that it will most likely
get fixed by the new mask allocator in one of the future kernel releases.

-- 
Greetings Michael.


From david at dgreaves.com  Mon Mar 24 11:34:36 2008
From: david at dgreaves.com (David Greaves)
Date: Mon, 24 Mar 2008 10:34:36 +0000
Subject: b43legacy BIOS issue : FYI and some wiki updates
Message-ID: <47E783BC.6040401@dgreaves.com>

Hi

I had some problems getting my 4306 card running with b43legacy.

This is mainly for google and to comment that I've updated the FAQ
 http://linuxwireless.org/en/users/Drivers/b43/faq
and the drivers page
 http://linuxwireless.org/en/users/Drivers/b43#devicefirmware

Maybe someone more knowledgeable could double check my text...

I was able to get b43legacy running fine - great instructions.
However wpa_supplicant wouldn't work and iwconfig showed
  Link Quality:0  Signal level:0
The module was loaded and there was no indication that anything was wrong.
It turns out that the Dell BIOS was set to 'application control' which windows
presumably can toggle. Setting it to 'on' fixed that problem.

Secondly there are lots of references to a 'broadcom' driver for wpa_supplicant.
It's not clear that the b43 class drivers need to use 'wext' (thanks to mb__ on
#bcm-users).

Cheers

David


From krop at free.fr  Mon Mar 24 16:39:50 2008
From: krop at free.fr (krop)
Date: Mon, 24 Mar 2008 16:39:50 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
Message-ID: <200803241639.50900.krop@free.fr>

(Re-posting, since I forgot to confirm)

Hello,
After two monthes trying to find a solution, I'll post directly on the bcm43xx 
ML.

- The Launchpad bug is there : 
https://bugs.launchpad.net/ubuntu/+source/linux/+bug/182716 (this thread is 
confusing and solves different issues but not the main one)

Tech info :

- uname -a
Linux mokona 2.6.24-12-generic #1 SMP Wed Mar 12 23:01:54 UTC 2008 i686 
GNU/Linux

- lspci -nnvvv
02:09.0 Network controller [0280]: Broadcom Corporation BCM4306 802.11b/g 
Wireless LAN Controller [14e4:4320] (rev 03)
        Subsystem: Linksys Unknown device [1737:0013]
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
Stepping- SERR- FastB2B- DisINTx-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- 
<TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 32
        Interrupt: pin A routed to IRQ 20
        Region 0: Memory at fdffe000 (32-bit, non-prefetchable) [size=8K]

- b43-fwcutter -l
b43-fwcutter version 011
The firmwares are in /lib/firmware/b43 and /lib/firmware/b43legacy

The issues, now :

Despite what is mentionned there :
http://linuxwireless.org/en/users/Drivers/b43#bcm43xx.2Cb43legacy.2Cb43.2Csoftmac.2C...thefullstory 
, this card (Linksys WMP-54G pci) doesn't work with b43legacy but b43.
Indeed, blacklisting b43 and loading b43legacy won't create any interface.
Removing b43 module from blacklist and loading b43legacy will also load b43 : 

root at mokona:~# modprobe b43legacy
root at mokona:~# lsmod | fgrep b43

b43                   118176  0
b43legacy             129564  0
ssb                    32772  2 b43,b43legacy
mac80211              165652  2 b43,b43legacy
rfkill                  8592  8 b43,b43legacy,rfkill_input
led_class               6020  2 b43,b43legacy
input_polldev           5896  2 b43,b43legacy

- While everything works fine with bcm43xx, replacing it with b43 results in 
timeouts (the same thing as described in this thread :

https://lists.berlios.de/pipermail/bcm43xx-dev/2008-March/006995.html )

Dmesg output after loading b43legacy :
[481560.308707] ACPI: PCI Interrupt 0000:02:09.0[A] -> Link [APC4] -> GSI 19 
(level, low) -> IRQ 20
[481560.331833] ssb: SPROM revision 1 detected.
[481560.348634] ssb: Sonics Silicon Backplane found on PCI device 0000:02:09.0
[481560.581763] b43-phy4: Broadcom 4306 WLAN found
[481560.650004] phy4: Selected rate control algorithm 'simple'
[481560.675163] udev: renamed network interface wlan0 to eth0
[481560.733573] input: b43-phy4 as /devices/virtual/input/input82

lshw -C network
  *-network
       description: Network controller
       product: BCM4306 802.11b/g Wireless LAN Controller
       vendor: Broadcom Corporation
       physical id: 9
       bus info: pci at 0000:02:09.0
       version: 03
       width: 32 bits
       clock: 33MHz
       capabilities: bus_master
       configuration: driver=b43-pci-bridge latency=32 module=ssb
  *-network
       description: Wireless interface
       physical id: 1
       logical name: eth0
       serial: 00:0f:66:f2:8e:4a
       capabilities: ethernet physical wireless
       configuration: broadcast=yes multicast=yes wireless=IEEE 802.11g

iwconfig after reloading the network :

lo        no wireless extensions.
wmaster0  no wireless extensions.
eth0      IEEE 802.11g  ESSID:"freebox"
          Mode:Managed  Frequency:2.447 GHz  Access Point: BA:FA:E6:72:E9:0C
          Tx-Power=20 dBm
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

Finally dmesg :

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080324/c7f7957a/attachment.html>

From krop at free.fr  Mon Mar 24 16:55:41 2008
From: krop at free.fr (krop)
Date: Mon, 24 Mar 2008 16:55:41 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <200803241639.50900.krop@free.fr>
References: <200803241639.50900.krop@free.fr>
Message-ID: <1206374141.47e7cefdb8f3a@imp.free.fr>

The end of the message had a problem, here it is, sorry :

Finally dmesg :
[481907.430896] eth0: Initial auth_alg=0
[481907.430907] eth0: authenticate with AP ba:fa:e6:72:e9:0c
[481907.629997] eth0: authenticate with AP ba:fa:e6:72:e9:0c
[481907.830001] eth0: authenticate with AP ba:fa:e6:72:e9:0c
[481908.030004] eth0: authentication with AP ba:fa:e6:72:e9:0c timed out
and wpa_supplicant output :
Trying to associate with ba:fa:e6:72:e9:0c (SSID='freebox' freq=2447 MHz)
Authentication with 00:00:00:00:00:00 timed out.
Here's the situation and I don't have any idea of the causes or the way to solve
this problem.
Any help would be appreciated.
Thank you.


From Larry.Finger at lwfinger.net  Mon Mar 24 17:03:42 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 24 Mar 2008 09:03:42 -0700
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <200803241639.50900.krop@free.fr>
References: <200803241639.50900.krop@free.fr>
Message-ID: <47E7D0DE.9060408@lwfinger.net>

krop wrote:
> (Re-posting, since I forgot to confirm)
> 
> Hello,
> 
> After two monthes trying to find a solution, I'll post directly on the 
> bcm43xx ML.
> 
> - The Launchpad bug is there : 
> https://bugs.launchpad.net/ubuntu/+source/linux/+bug/182716 (this thread 
> is confusing and solves different issues but not the main one)
> 
> Tech info :
> 
> - uname -a
> 
> Linux mokona 2.6.24-12-generic #1 SMP Wed Mar 12 23:01:54 UTC 2008 i686 
> GNU/Linux
> 
> - lspci -nnvvv
> 
> 02:09.0 Network controller [0280]: Broadcom Corporation BCM4306 
> 802.11b/g Wireless LAN Controller [14e4:4320] (rev 03)
> Subsystem: Linksys Unknown device [1737:0013]
> Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
> Stepping- SERR- FastB2B- DisINTx-
> Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- 
> <MAbort- >SERR- <PERR- INTx-
  Latency: 32
> Interrupt: pin A routed to IRQ 20
> Region 0: Memory at fdffe000 (32-bit, non-prefetchable) [size=8K]
> - b43-fwcutter -l
> b43-fwcutter version 011
> The firmwares are in /lib/firmware/b43 and /lib/firmware/b43legacy
> The issues, now :
> 
> Despite what is mentionned there :
> http://linuxwireless.org/en/users/Drivers/b43#bcm43xx.2Cb43legacy.2Cb43.2Csoftmac.2C...thefullstory 
> , this card (Linksys WMP-54G pci) doesn't work with b43legacy but b43.

This is exactly what is expected. The BCM4306 rev 02 uses b43legacy. A BCM4306
rev 03 _needs_ b43.

> - While everything works fine with bcm43xx, replacing it with b43 
> results in timeouts (the same thing as described in this thread :
> https://lists.berlios.de/pipermail/bcm43xx-dev/2008-March/006995.html )
> 
> Dmesg output after loading b43legacy :
> 
> [481560.308707] ACPI: PCI Interrupt 0000:02:09.0[A] -> Link [APC4] -> 
> GSI 19 (level, low) -> IRQ 20
> [481560.331833] ssb: SPROM revision 1 detected.
> [481560.348634] ssb: Sonics Silicon Backplane found on PCI device 
> 0000:02:09.0
> [481560.581763] b43-phy4: Broadcom 4306 WLAN found
> [481560.650004] phy4: Selected rate control algorithm 'simple'
> [481560.675163] udev: renamed network interface wlan0 to eth0
> [481560.733573] input: b43-phy4 as /devices/virtual/input/input82
> iwconfig after reloading the network :
> lo no wireless extensions.
> wmaster0 no wireless extensions.
> eth0 IEEE 802.11g ESSID:"freebox"
> Mode:Managed Frequency:2.447 GHz Access Point: BA:FA:E6:72:E9:0C
> Tx-Power=20 dBm
> Retry min limit:7 RTS thr:off Fragment thr=2346 B
> Encryption key:off
> Link Quality:0 Signal level:0 Noise level:0
> Rx invalid nwid:0 Rx invalid crypt:0 Rx invalid frag:0
> Tx excessive retries:0 Invalid misc:0 Missed beacon:0

> Finally dmesg :
> [481907.430896] eth0: Initial auth_alg=0
> [481907.430907] eth0: authenticate with AP ba:fa:e6:72:e9:0c
> [481907.629997] eth0: authenticate with AP ba:fa:e6:72:e9:0c
> [481907.830001] eth0: authenticate with AP ba:fa:e6:72:e9:0c
> [481908.030004] eth0: authentication with AP ba:fa:e6:72:e9:0c timed out

> and wpa_supplicant output :
> <2>Trying to associate with ba:fa:e6:72:e9:0c (SSID='freebox' freq=2447 
> MHz)
> <2>Authentication with 00:00:00:00:00:00 timed out.

> Here's the situation and I don't have any idea of the causes or the way 
> to solve this problem.

Your iwconfig output shows that the interface has authenticated, which implies
transmit and receive both working. Please check that your copy of wpa_supplicant
has the "wext" interface enabled. There has been a report of failures for this reason.

Larry


From Larry.Finger at lwfinger.net  Mon Mar 24 17:08:43 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 24 Mar 2008 09:08:43 -0700
Subject: More on ASUS WL-138G V2
In-Reply-To: <BAY107-W20429AF77E63DF7973A0E1A0FD0@phx.gbl>
References: <BAY107-W20429AF77E63DF7973A0E1A0FD0@phx.gbl>
Message-ID: <47E7D20B.1020302@lwfinger.net>

kala mazoo wrote:
> 
> 
> 
>> Are you running on x86_64?
>> Can you try booting without IOMMU support?
>> I think it's the commanline option iommu=0 or iommu=off or something like that.
>>
>> The driver does not work on x86_64 with IOMMU. That's because the IOMMU
>> code is broken. (not a b43 bug)
>>
>> --
> 
>   Hi Michael,
> 
>                        As requested, booted with ..
> 
> Linux version 2.6.24 (root at bits64.thehut.net) (gcc version 4.1.1) #3 SMP Sun Mar 23 16:43:09 EST 2008
> Command line: BOOT_IMAGE=linux ro root=806 iommu=off
> 
> 
>     This made no difference to the situation here at all -- things are exactly the same as before.
> 
> 
>  If we -assume- from this that IOMMU functionality in X86_64 is *not* the issue here, then perhaps Larry's P4 will be of use finding this fault after all?
> 
> 
>     Let me know....

I just sent Donald my snail-mail address privately. I'll keep the list 
informed on what I find.

Larry



From krop at free.fr  Mon Mar 24 17:44:07 2008
From: krop at free.fr (krop)
Date: Mon, 24 Mar 2008 17:44:07 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E7D0DE.9060408@lwfinger.net>
References: <200803241639.50900.krop@free.fr> <47E7D0DE.9060408@lwfinger.net>
Message-ID: <1206377047.47e7da5749c0b@imp.free.fr>

Selon Larry Finger <Larry.Finger at lwfinger.net>:

> > Despite what is mentionned there :
> >
>
http://linuxwireless.org/en/users/Drivers/b43#bcm43xx.2Cb43legacy.2Cb43.2Csoftmac.2C...thefullstory
> > , this card (Linksys WMP-54G pci) doesn't work with b43legacy but b43.
>
> This is exactly what is expected. The BCM4306 rev 02 uses b43legacy. A
> BCM4306
> rev 03 _needs_ b43.
>

Thank you for this information :-)

> > and wpa_supplicant output :
> > <2>Trying to associate with ba:fa:e6:72:e9:0c (SSID='freebox' freq=2447
> > MHz)
> > <2>Authentication with 00:00:00:00:00:00 timed out.
>
> > Here's the situation and I don't have any idea of the causes or the way
> > to solve this problem.
>
> Your iwconfig output shows that the interface has authenticated, which
> implies
> transmit and receive both working. Please check that your copy of
> wpa_supplicant
> has the "wext" interface enabled. There has been a report of failures for
> this reason.
>
wpa_supplicant configuration is the same as when I use bcm43xx :
in /etc/network/interfaces :
auto eth0
iface eth0 inet dhcp
pre-up wpa_supplicant -Bw -dd -Dwext -ieth0 -c/etc/wpa_supplicant.conf
post-down killall -q wpa_supplicant

To be sure, I've just tried with latest wpa_supplicant (0.5.10) and have the
same result.

iwconfig output with bcm43xx :
eth0      IEEE 802.11b/g  ESSID:"freebox"  Nickname:"Broadcom 4306"
          Mode:Managed  Frequency=2.447 GHz  Access Point: BA:FA:E6:72:E9:0C
          Bit Rate=24 Mb/s   Tx-Power=15 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:<deleted string>   Security mode:open
          Link Quality=78/100  Signal level=-53 dBm  Noise level=-67 dBm
          Rx invalid nwid:0  Rx invalid crypt:2  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

iwconfig output with b43 :
eth0      IEEE 802.11g  ESSID:"freebox"
          Mode:Managed  Frequency:2.447 GHz  Access Point: BA:FA:E6:72:E9:0C
          Tx-Power=27 dBm
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0



From Larry.Finger at lwfinger.net  Mon Mar 24 18:58:14 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 24 Mar 2008 10:58:14 -0700
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <1206377047.47e7da5749c0b@imp.free.fr>
References: <200803241639.50900.krop@free.fr> <47E7D0DE.9060408@lwfinger.net>
	<1206377047.47e7da5749c0b@imp.free.fr>
Message-ID: <47E7EBB6.3090603@lwfinger.net>

krop wrote:
> Selon Larry Finger <Larry.Finger at lwfinger.net>:
> 
>>> Despite what is mentionned there :
>>>
> http://linuxwireless.org/en/users/Drivers/b43#bcm43xx.2Cb43legacy.2Cb43.2Csoftmac.2C...thefullstory
>>> , this card (Linksys WMP-54G pci) doesn't work with b43legacy but b43.
>> This is exactly what is expected. The BCM4306 rev 02 uses b43legacy. A
>> BCM4306
>> rev 03 _needs_ b43.
>>
> 
> Thank you for this information :-)
> 
>>> and wpa_supplicant output :
>>> <2>Trying to associate with ba:fa:e6:72:e9:0c (SSID='freebox' freq=2447
>>> MHz)
>>> <2>Authentication with 00:00:00:00:00:00 timed out.
>>> Here's the situation and I don't have any idea of the causes or the way
>>> to solve this problem.
>> Your iwconfig output shows that the interface has authenticated, which
>> implies
>> transmit and receive both working. Please check that your copy of
>> wpa_supplicant
>> has the "wext" interface enabled. There has been a report of failures for
>> this reason.
>>
> wpa_supplicant configuration is the same as when I use bcm43xx :
> in /etc/network/interfaces :
> auto eth0
> iface eth0 inet dhcp
> pre-up wpa_supplicant -Bw -dd -Dwext -ieth0 -c/etc/wpa_supplicant.conf
> post-down killall -q wpa_supplicant

If wpa_supplicant shows up in a 'ps ax' output, kill it and restart 
from a root-privileged command using the command

wpa_supplicant -Dwext -ieth0 -c/etc/wpa_supplicant.conf -ddd

and send the resulting console output. You may have to issue an 'ifup 
eth0' command on another terminal.

Larry



From krop at free.fr  Mon Mar 24 19:40:19 2008
From: krop at free.fr (krop)
Date: Mon, 24 Mar 2008 19:40:19 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E7EBB6.3090603@lwfinger.net>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net> <1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net>
Message-ID: <20080324194019.5jridhmi0o480kg4@imp4.free.fr>

> If wpa_supplicant shows up in a 'ps ax' output, kill it and restart
> from a root-privileged command using the command
>
> wpa_supplicant -Dwext -ieth0 -c/etc/wpa_supplicant.conf -ddd
>
> and send the resulting console output. You may have to issue an 'ifup
> eth0' command on another terminal.
>
> Larry

Thank you for your answer.

The output is available here :
http://pastebin.com/f648ec9dd



From krop at free.fr  Mon Mar 24 19:21:52 2008
From: krop at free.fr (krop)
Date: Mon, 24 Mar 2008 19:21:52 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E7EBB6.3090603@lwfinger.net>
References: <200803241639.50900.krop@free.fr> <47E7D0DE.9060408@lwfinger.net>
	<1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net>
Message-ID: <1206382912.47e7f140ae7a2@imp.free.fr>

>
> If wpa_supplicant shows up in a 'ps ax' output, kill it and restart
> from a root-privileged command using the command
>
> wpa_supplicant -Dwext -ieth0 -c/etc/wpa_supplicant.conf -ddd
>
> and send the resulting console output. You may have to issue an 'ifup
> eth0' command on another terminal.
>
Thank you for answering.

The output is available here :
http://pastebin.com/f648ec9dd



From Larry.Finger at lwfinger.net  Tue Mar 25 03:49:23 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 24 Mar 2008 19:49:23 -0700
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <1206382912.47e7f140ae7a2@imp.free.fr>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net>	<1206377047.47e7da5749c0b@imp.free.fr>	<47E7EBB6.3090603@lwfinger.net>
	<1206382912.47e7f140ae7a2@imp.free.fr>
Message-ID: <47E86833.90201@lwfinger.net>

krop wrote:
>> If wpa_supplicant shows up in a 'ps ax' output, kill it and restart
>> from a root-privileged command using the command
>>
>> wpa_supplicant -Dwext -ieth0 -c/etc/wpa_supplicant.conf -ddd
>>
>> and send the resulting console output. You may have to issue an 'ifup
>> eth0' command on another terminal.
>>
> Thank you for answering.
> 
> The output is available here :
> http://pastebin.com/f648ec9dd

The problem is with authentication. The interface is actively 
scanning, thus transmit is working. It is also receiving the beacons 
from 4 different AP's, thus that part is also working. Is your AP 
using WPA-PSK encryption? I see wpa_supplicant trying to use WPA to 
authenticate, but it never gets into the 4-way handshake. Please check 
your /etc/wpa_supplicant.conf for correctness.

Is it possible for you to use NetworkManager to control your network 
interfaces? If so, please try it that way. NM should set up the 
control file correctly.

If you cannot use NM, is it possible to turn off encryption for a 
short time to see if the interface will connect in that case?

Larry


From krop at free.fr  Tue Mar 25 13:22:33 2008
From: krop at free.fr (krop)
Date: Tue, 25 Mar 2008 13:22:33 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E86833.90201@lwfinger.net>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net> <1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net> <1206382912.47e7f140ae7a2@imp.free.fr>
	<47E86833.90201@lwfinger.net>
Message-ID: <20080325132233.hn8uebp8g04s4oo0@imp4.free.fr>



   I think Larry received the first part of my answer directly. was  
just a copy of my wpa_supplicant.conf and the debug outputs with both  
b43 and bcm43xx.

   > Is it possible for you to use NetworkManager to control your network
> interfaces? If so, please try it that way. NM should set up the control
> file correctly.

   Here are the results of the tests with network-manager.

   I have to mention first that I did let udev calling the wifi card  
wlan0 instead of eth0. That's not a mistake :-)

   http://pastebin.org/25243

   I added comments at lines #1, #68 and #90 to let you know what happened.

   Note : the signal strength reported by knetworkmanager was  
different with both modules : bcm43xx gives a 89% signal and b43 gives  
68%

   Thank you.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080325/03ee8fe8/attachment.html>

From Larry.Finger at lwfinger.net  Tue Mar 25 16:39:23 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 25 Mar 2008 08:39:23 -0700
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
References: <200803241639.50900.krop@free.fr>	<47E7D0DE.9060408@lwfinger.net>
	<1206377047.47e7da5749c0b@imp.free.fr>	<47E7EBB6.3090603@lwfinger.net>
	<1206382912.47e7f140ae7a2@imp.free.fr>	<47E86833.90201@lwfinger.net>
	<20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
Message-ID: <47E91CAB.2010408@lwfinger.net>

Jouni and Johannes,

The correspondent below has a problem authenticating when using the 
b43 driver with mac80211, but all works with bcm43xx/SoftMAC. As far 
as I can tell, the problem driver is transmitting and receiving, but 
still no go. Please look at the wpa_supplicant -ddd output posted at

http://pastebin.org/25229 for b43, and
http://pastebin.org/25230 for bcm43xx.

Thanks,

Larry

krop wrote:
> Four modes are available : WEP / WPA(TKIP) / WPA(AES/CCMP) / WPA(TKIP+AES).
> 
> Actually, the last one is selected. I cleared my wpa_supplicant.conf 
> (removed a few options to leave the program select them) :
> ctrl_interface=/var/run/wpa_supplicant
> ap_scan=1
> 
> network={
>         ssid="freebox"
>         scan_ssid=1
>         mode=0
>         proto=WPA
>         psk=[removed]
>         key_mgmt=WPA-PSK
>         priority=5
> }
> 
> I post below the console output with both bcm43xx and b43 (this one 
> looks like yesterday's one).
> 
> - b43 : http://pastebin.org/25229
> - bcm43xx : http://pastebin.org/25230



From johannes at sipsolutions.net  Tue Mar 25 16:52:38 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 25 Mar 2008 16:52:38 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E91CAB.2010408@lwfinger.net>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net> <1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net> <1206382912.47e7f140ae7a2@imp.free.fr>
	<47E86833.90201@lwfinger.net>
	<20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
	<47E91CAB.2010408@lwfinger.net>
Message-ID: <1206460359.16475.296.camel@johannes.berg>


> http://pastebin.org/25229 for b43, and

that doesn't seem to exist any more.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080325/ec7d39d8/attachment.pgp>

From mb at bu3sch.de  Tue Mar 25 16:59:29 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 25 Mar 2008 16:59:29 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E91CAB.2010408@lwfinger.net>
References: <200803241639.50900.krop@free.fr>
	<20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
	<47E91CAB.2010408@lwfinger.net>
Message-ID: <200803251659.29799.mb@bu3sch.de>

On Tuesday 25 March 2008 16:39:23 Larry Finger wrote:
> Jouni and Johannes,
> 
> The correspondent below has a problem authenticating when using the 
> b43 driver with mac80211, but all works with bcm43xx/SoftMAC. As far 
> as I can tell, the problem driver is transmitting and receiving, but 
> still no go. Please look at the wpa_supplicant -ddd output posted at
> 
> http://pastebin.org/25229 for b43, and
> http://pastebin.org/25230 for bcm43xx.

Which version of wpa_supplicant is this? Can you try latest stable?


-- 
Greetings Michael.


From krop at free.fr  Tue Mar 25 17:14:17 2008
From: krop at free.fr (krop)
Date: Tue, 25 Mar 2008 17:14:17 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <200803251659.29799.mb@bu3sch.de>
References: <200803241639.50900.krop@free.fr> <47E91CAB.2010408@lwfinger.net>
	<200803251659.29799.mb@bu3sch.de>
Message-ID: <200803251714.19499.krop@free.fr>

Le Tuesday 25 March 2008 16:59:29 Michael Buesch, vous avez ?crit :
> On Tuesday 25 March 2008 16:39:23 Larry Finger wrote:
> > Jouni and Johannes,
> >
> > The correspondent below has a problem authenticating when using the
> > b43 driver with mac80211, but all works with bcm43xx/SoftMAC. As far
> > as I can tell, the problem driver is transmitting and receiving, but
> > still no go. Please look at the wpa_supplicant -ddd output posted at
> >
> > http://pastebin.org/25229 for b43, and
> > http://pastebin.org/25230 for bcm43xx.
>
> Which version of wpa_supplicant is this? Can you try latest stable?

I replaced the version shipped with my distro. Unless I'm wrong, it is the 
latest wpa_supplicant :
root at mokona:~# wpa_supplicant -v
wpa_supplicant v0.5.10
Copyright (c) 2003-2008, Jouni Malinen <j [at] w1.fi> and contributors

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080325/15472a13/attachment.html>

From krop at free.fr  Tue Mar 25 17:51:26 2008
From: krop at free.fr (krop)
Date: Tue, 25 Mar 2008 17:51:26 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <200803251659.29799.mb@bu3sch.de>
References: <200803241639.50900.krop@free.fr>
	<20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
	<47E91CAB.2010408@lwfinger.net> <200803251659.29799.mb@bu3sch.de>
Message-ID: <1206463886.47e92d8e4c5cf@imp.free.fr>

Quoting Michael Buesch <mb at bu3sch.de>:

>
> Which version of wpa_supplicant is this? Can you try latest stable?
>
>
Here are the results with wpa_supplicant 0.6.3 :
bcm43xx : http://pastebin.org/25286
b43 : http://pastebin.org/25289


From proski at gnu.org  Tue Mar 25 18:47:47 2008
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 25 Mar 2008 13:47:47 -0400
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <47E86833.90201@lwfinger.net>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net>	<1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net> <1206382912.47e7f140ae7a2@imp.free.fr>
	<47E86833.90201@lwfinger.net>
Message-ID: <1206467267.10805.1.camel@dv>


On Mon, 2008-03-24 at 19:49 -0700, Larry Finger wrote:

> The problem is with authentication. The interface is actively 
> scanning, thus transmit is working.

How do you know that?  Receiving beacons doesn't require transmission.
Just trying to understand your logic.

-- 
Regards,
Pavel Roskin


From netrolller.3d at gmail.com  Wed Mar 26 13:35:00 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Wed, 26 Mar 2008 13:35:00 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <1206497800.12588.5.camel@dv>
References: <200803241639.50900.krop@free.fr> <47E7D0DE.9060408@lwfinger.net>
	<1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net>
	<1206382912.47e7f140ae7a2@imp.free.fr> <47E86833.90201@lwfinger.net>
	<1206467267.10805.1.camel@dv>
	<69e28c910803251148u734565f6u8bfdfc229cb78940@mail.gmail.com>
	<1206497800.12588.5.camel@dv>
Message-ID: <69e28c910803260535m57c3f58ahd7043e0cd156d738@mail.gmail.com>

(This email contains my conversation history with Pavel, where I
accidentally didn't CC the list.)

Scanning is a passive operation, so most likely it doesn't transmit, just
like my card. Maybe you should try a wireless-testing kernel, and experiment
with ieee80211_regdom. I hope that helps.

On Wed, Mar 26, 2008 at 3:16 AM, Pavel Roskin <proski at gnu.org> wrote:

>
> On Tue, 2008-03-25 at 19:48 +0100, Stefanik G?bor wrote:
> > Hmmm... what card are you using exactly? And where do you live (in
> > what regulatory domain, eg. US, EU or Japan)? I have a similar problem
> > with an Asus WL-138G V2 (which is a 4318, not a 4306, but it is a
> > Broadcom nevertheless), which only appears to affect cards made for/in
> > the EU.
>
> I'm in the US now, but I bought my Broadcom cards on eBay from China.
> They are not new, so I don't know where they have been.
>
> As it stands now, both 4306 and 4318 are working on some of my
> computers, but I used to get similar messages until I installed bigger
> antennas.  I've seen it with iwlwifi as well.  That's why I'm asking
> whether is can be assumed that the packets are transmitted (with a
> reasonable power) just because scanning is working.
>
> --
> Regards,
> Pavel Roskin
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080326/7dd36a72/attachment.html>

From netrolller.3d at gmail.com  Wed Mar 26 13:46:46 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Wed, 26 Mar 2008 13:46:46 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <1206467267.10805.1.camel@dv>
References: <200803241639.50900.krop@free.fr> <47E7D0DE.9060408@lwfinger.net>
	<1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net>
	<1206382912.47e7f140ae7a2@imp.free.fr> <47E86833.90201@lwfinger.net>
	<1206467267.10805.1.camel@dv>
Message-ID: <69e28c910803260546n3c207e77obba520bab91f2056@mail.gmail.com>

An idea: Are you using a kernel with SMP and/or PAE enabled? I suspect an
SMP-related issue (I got this problem with OpenSUSE kernels, which are all
SMP-enabled), or maybe HPET/high-resolution timer/tickless system related.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080326/08b1eddb/attachment.html>

From johannes at sipsolutions.net  Wed Mar 26 13:55:39 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 26 Mar 2008 13:55:39 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <20080326080600.GF5304@jm.kir.nu>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net> <1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net> <1206382912.47e7f140ae7a2@imp.free.fr>
	<47E86833.90201@lwfinger.net>
	<20080325112844.yvtr2i6yowwg48wc@imp4.free.fr>
	<47E91CAB.2010408@lwfinger.net>  <20080326080600.GF5304@jm.kir.nu>
Message-ID: <1206536139.16475.316.camel@johannes.berg>


> wpa_supplicant seems to find a suitable AP and it is requesting kernel
> (mac80211 in this case) to associate. However, that is timing out.
> wpa_supplicant does not has visibility to what mac80211 does here, so
> the next step would be to debug what is happening there (first step
> might be to just take a look at 'dmesg' output). It looks like either
> the AP is rejecting the STA for some reason or the STA does not even try
> to associate.

Just to expand on that, you need to enable mac80211 debugging to get
decent output for this case, and it is well possible that it's still a
driver problem if mac80211 is transmitting packets to the driver but
they never make it to the air. Please enable mac80211 debugging and post
the kernel's log.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080326/bbaa8daa/attachment.pgp>

From krop at free.fr  Wed Mar 26 19:33:18 2008
From: krop at free.fr (krop)
Date: Wed, 26 Mar 2008 19:33:18 +0100
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <1206536139.16475.316.camel@johannes.berg>
References: <200803241639.50900.krop@free.fr> <20080326080600.GF5304@jm.kir.nu>
	<1206536139.16475.316.camel@johannes.berg>
Message-ID: <200803261933.19826.krop@free.fr>

Le Wednesday 26 March 2008 13:55:39 Johannes Berg, vous avez ?crit :
>
> Just to expand on that, you need to enable mac80211 debugging to get
> decent output for this case, and it is well possible that it's still a
> driver problem if mac80211 is transmitting packets to the driver but
> they never make it to the air. Please enable mac80211 debugging and post
> the kernel's log.

Hello,

It took some times to compile everything and the result is not what I expected 
: it's not really verbose.

I used : 

CONFIG_MAC80211=m
CONFIG_MAC80211_RCSIMPLE=y
CONFIG_MAC80211_LEDS=y
CONFIG_MAC80211_DEBUGFS=y
CONFIG_MAC80211_DEBUG=y
CONFIG_MAC80211_VERBOSE_DEBUG=y
CONFIG_MAC80211_LOWTX_FRAME_DUMP=y
CONFIG_MAC80211_DEBUG_COUNTERS=y
CONFIG_MAC80211_IBSS_DEBUG=y
CONFIG_MAC80211_VERBOSE_PS_DEBUG=y

And the kernel log :
http://pastebin.org/25505

Did I forget anything ? 

Christophe.


From proski at gnu.org  Wed Mar 26 23:10:45 2008
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 26 Mar 2008 18:10:45 -0400
Subject: Problems with a bcm4306 (03) and b43/b43legacy
In-Reply-To: <69e28c910803260546n3c207e77obba520bab91f2056@mail.gmail.com>
References: <200803241639.50900.krop@free.fr>
	<47E7D0DE.9060408@lwfinger.net> <1206377047.47e7da5749c0b@imp.free.fr>
	<47E7EBB6.3090603@lwfinger.net> <1206382912.47e7f140ae7a2@imp.free.fr>
	<47E86833.90201@lwfinger.net> <1206467267.10805.1.camel@dv>
	<69e28c910803260546n3c207e77obba520bab91f2056@mail.gmail.com>
Message-ID: <1206569445.2362.11.camel@dv>

On Wed, 2008-03-26 at 13:46 +0100, Stefanik G?bor wrote:
> An idea: Are you using a kernel with SMP and/or PAE enabled? I suspect
> an SMP-related issue (I got this problem with OpenSUSE kernels, which
> are all SMP-enabled), or maybe HPET/high-resolution timer/tickless
> system related.

I'm not sure why you are asking me, since I'm not experiencing any major
problems now.

bcm4318 is working for me with or without SMP.  PAE is not enabled.
That's the latest wireless-testing kernel.  Both the old and the new 4.x
firmware is working fine.  I tried removing the antenna, but it's still
working (the link quality is lower, of course).

If you have kernels that work and those that don't work, it's a good
starting point.

I would try to capture packets going in both directions on a separate
machine, note the signal strength, then load ndiswrapper with Windows
drivers, capture the packets and compare the results.  It's very
important that you don't even touch any antenna between measurements or
reorient anything.

-- 
Regards,
Pavel Roskin


From myheadblewoff at hotmail.com  Thu Mar 27 00:00:49 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Thu, 27 Mar 2008 09:00:49 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W36DCE25F8A8354642D7020A0FF0@phx.gbl>


Greets,

                Although this will never be the point, I jammed one of these cards into
 a 32bit machine here (Via EPIA-TC) running linux-2.6.20 and using the bcm43xx
driver code....and it would appear to be working.....

//associate with AP, WEP only. key=open//

  =======================
ADDRCONF(NETDEV_UP): eth1: link is not ready
SoftMAC: Open Authentication completed with 00:1e:2a:61:7d:2c
ADDRCONF(NETDEV_CHANGE): eth1: link becomes ready
eth1: no IPv6 routers present


...caveat some dropped RX packets (which might be normal AFAIK) ;

eth1      Link encap:Ethernet  HWaddr 00:1B:FC:61:1B:62
          inet addr:172.16.1.234  Bcast:172.16.1.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1285 errors:0 dropped:94 overruns:0 frame:0
          TX packets:1020 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:113528 (110.8 Kb)  TX bytes:147761 (144.2 Kb)
          Interrupt:5 Base address:0x4000


I'll upgrade to 2.6.24 on the same machine and see what happens...


          Regards,
                             Donald

_________________________________________________________________
Are you paid what you're worth? Find out: SEEK Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fninemsn%2Eseek%2Ecom%2Eau%2Fcareer%2Dresources%2Fsalary%2Dcentre%2F%3Ftracking%3Dsk%3Ahet%3Asc%3Anine%3A0%3Ahot%3Atext&_t=764565661&_r=OCT07_endtext_salary&_m=EXT

From myheadblewoff at hotmail.com  Thu Mar 27 05:35:16 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Thu, 27 Mar 2008 14:35:16 +1000
Subject: More on ASUS WL-138G V2
Message-ID: <BAY107-W235CC292A78A43559960F8A0FE0@phx.gbl>



Greets,

            As conjecture has been raised over how much of this might
be architecture related, versus how much of it is the card's fault, I've
done a few hours checking on both 32 & 64 bit machines here, and
this is what I have found ;

32bit    bcm43xx    linux-2.6.20      working
                              linux-2.6.24      working

(disregard earlier report of RX packet dropping - my fault...)


64bit    bcm43xx   linux-2.6.24       not working

One line (two words) of debug are logged - 'bcm43xx driver' then
nothing. Modules registers in kernel tree, associates with other
dependant modules, appears to be loaded but no interface in
either iwconfig or ifconfig is registered.


32bit    b43        linux-2.6.24         not working

64bit    b43        linux-2.6.24         not working

The 32bit kernel build displays the exact same problem as I first
noted using this 64bit machine.

All the firmware installed/used was as per b43 webpage..


                    Regards,

                                   Donald.

_________________________________________________________________
Are you paid what you're worth? Find out: SEEK Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fninemsn%2Eseek%2Ecom%2Eau%2Fcareer%2Dresources%2Fsalary%2Dcentre%2F%3Ftracking%3Dsk%3Ahet%3Asc%3Anine%3A0%3Ahot%3Atext&_t=764565661&_r=OCT07_endtext_salary&_m=EXT

From mb at bu3sch.de  Fri Mar 28 10:34:55 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 28 Mar 2008 10:34:55 +0100
Subject: [PATCH] ssb-pcmcia: IRQ and DMA related fixes
Message-ID: <200803281034.55731.mb@bu3sch.de>

Here come some IRQ and DMA related fixes for the ssb PCMCIA-host code.
Not much to say, actually. I think the patch explains itself.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

For 2.6.25

Index: wireless-testing/drivers/ssb/pcmcia.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pcmcia.c	2008-03-28 10:23:09.000000000 +0100
+++ wireless-testing/drivers/ssb/pcmcia.c	2008-03-28 10:25:00.000000000 +0100
@@ -25,17 +25,12 @@
 
 /* Define the following to 1 to enable a printk on each coreswitch. */
 #define SSB_VERBOSE_PCMCIACORESWITCH_DEBUG		0
 
 
 /* PCMCIA configuration registers */
-#define SSB_PCMCIA_CORECTL		0x00
-#define  SSB_PCMCIA_CORECTL_RESET	0x80 /* Core reset */
-#define  SSB_PCMCIA_CORECTL_IRQEN	0x04 /* IRQ enable */
-#define  SSB_PCMCIA_CORECTL_FUNCEN	0x01 /* Function enable */
-#define SSB_PCMCIA_CORECTL2		0x80
 #define SSB_PCMCIA_ADDRESS0		0x2E
 #define SSB_PCMCIA_ADDRESS1		0x30
 #define SSB_PCMCIA_ADDRESS2		0x32
 #define SSB_PCMCIA_MEMSEG		0x34
 #define SSB_PCMCIA_SPROMCTL		0x36
 #define  SSB_PCMCIA_SPROMCTL_IDLE	0
@@ -668,42 +663,55 @@ static ssize_t ssb_pcmcia_attr_sprom_sto
 }
 
 static DEVICE_ATTR(ssb_sprom, 0600,
 		   ssb_pcmcia_attr_sprom_show,
 		   ssb_pcmcia_attr_sprom_store);
 
+static int ssb_pcmcia_cor_setup(struct ssb_bus *bus, u8 cor)
+{
+	u8 val;
+	int err;
+
+	err = ssb_pcmcia_cfg_read(bus, cor, &val);
+	if (err)
+		return err;
+	val &= ~COR_SOFT_RESET;
+	val |= COR_FUNC_ENA | COR_IREQ_ENA | COR_LEVEL_REQ;
+	err = ssb_pcmcia_cfg_write(bus, cor, val);
+	if (err)
+		return err;
+	msleep(40);
+
+	return 0;
+}
+
 void ssb_pcmcia_exit(struct ssb_bus *bus)
 {
 	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
 		return;
 
 	device_remove_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
 }
 
 int ssb_pcmcia_init(struct ssb_bus *bus)
 {
-	u8 val, offset;
 	int err;
 
 	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
 		return 0;
 
 	/* Switch segment to a known state and sync
 	 * bus->mapped_pcmcia_seg with hardware state. */
 	ssb_pcmcia_switch_segment(bus, 0);
 
-	/* Init IRQ routing */
-	if (bus->chip_id == 0x4306)
-		offset = SSB_PCMCIA_CORECTL;
-	else
-		offset = SSB_PCMCIA_CORECTL2;
-	err = ssb_pcmcia_cfg_read(bus, offset, &val);
+	/* Init the COR register. */
+	err = ssb_pcmcia_cor_setup(bus, CISREG_COR);
 	if (err)
 		goto error;
-	val |= SSB_PCMCIA_CORECTL_IRQEN | SSB_PCMCIA_CORECTL_FUNCEN;
-	err = ssb_pcmcia_cfg_write(bus, offset, val);
+	/* Some cards also need this register to get poked. */
+	err = ssb_pcmcia_cor_setup(bus, CISREG_COR + 0x80);
 	if (err)
 		goto error;
 
 	bus->sprom_size = SSB_PCMCIA_SPROM_SIZE;
 	mutex_init(&bus->sprom_mutex);
 	err = device_create_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
Index: wireless-testing/drivers/ssb/main.c
===================================================================
--- wireless-testing.orig/drivers/ssb/main.c	2008-03-28 10:23:21.000000000 +0100
+++ wireless-testing/drivers/ssb/main.c	2008-03-28 10:25:00.000000000 +0100
@@ -1061,15 +1061,15 @@ void ssb_device_disable(struct ssb_devic
 EXPORT_SYMBOL(ssb_device_disable);
 
 u32 ssb_dma_translation(struct ssb_device *dev)
 {
 	switch (dev->bus->bustype) {
 	case SSB_BUSTYPE_SSB:
+	case SSB_BUSTYPE_PCMCIA:
 		return 0;
 	case SSB_BUSTYPE_PCI:
-	case SSB_BUSTYPE_PCMCIA:
 		return SSB_PCI_DMA;
 	}
 	return 0;
 }
 EXPORT_SYMBOL(ssb_dma_translation);
 


From mb at bu3sch.de  Fri Mar 28 11:46:58 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 28 Mar 2008 11:46:58 +0100
Subject: [PATCH] b43: Add DMA mapping failure messages
Message-ID: <200803281146.59217.mb@bu3sch.de>

This adds messages for some DMA mapping failures.
These are useful for debugging DMA address problems, as they appear
on x86_64 machines with IOMMU enabled.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

Please queue for 2.6.25

Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-28 11:33:52.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-28 11:34:12.000000000 +0100
@@ -571,12 +571,13 @@ static int setup_rx_descbuffer(struct b4
 			return -ENOMEM;
 		dmaaddr = map_descbuffer(ring, skb->data,
 					 ring->rx_buffersize, 0);
 	}
 
 	if (b43_dma_mapping_error(ring, dmaaddr, ring->rx_buffersize, 0)) {
+		b43err(ring->dev->wl, "RX DMA buffer allocation failed\n");
 		dev_kfree_skb_any(skb);
 		return -EIO;
 	}
 
 	meta->skb = skb;
 	meta->dmaaddr = dmaaddr;
@@ -826,14 +827,18 @@ struct b43_dmaring *b43_setup_dmaring(st
 			dma_test = dma_map_single(dev->dev->dev,
 						  ring->txhdr_cache,
 						  b43_txhdr_size(dev),
 						  DMA_TO_DEVICE);
 
 			if (b43_dma_mapping_error(ring, dma_test,
-						  b43_txhdr_size(dev), 1))
+						  b43_txhdr_size(dev), 1)) {
+
+				b43err(dev->wl,
+				       "TXHDR DMA allocation failed\n");
 				goto err_kfree_txhdr_cache;
+			}
 		}
 
 		dma_unmap_single(dev->dev->dev,
 				 dma_test, b43_txhdr_size(dev),
 				 DMA_TO_DEVICE);
 	}


From mb at bu3sch.de  Fri Mar 28 11:48:53 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 28 Mar 2008 11:48:53 +0100
Subject: [PATCH] b43: Fix PCMCIA IRQ routing
Message-ID: <200803281148.53300.mb@bu3sch.de>

This fixes the IRQ routing on PCMCIA devices.
With this patch the card will finally be able to receive IRQs.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

Please queue for 2.6.25

Index: wireless-testing/drivers/net/wireless/b43/pcmcia.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/pcmcia.c	2008-03-28 11:35:25.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/pcmcia.c	2008-03-28 11:38:14.000000000 +0100
@@ -88,12 +88,14 @@ static int __devinit b43_pcmcia_probe(st
 	res = pcmcia_parse_tuple(dev, &tuple, &parse);
 	if (res != CS_SUCCESS)
 		goto err_kfree_ssb;
 
 	dev->conf.ConfigBase = parse.config.base;
 	dev->conf.Present = parse.config.rmask[0];
+	dev->conf.Attributes = CONF_ENABLE_IRQ;
+	dev->conf.IntType = INT_MEMORY_AND_IO;
 
 	dev->io.BasePort2 = 0;
 	dev->io.NumPorts2 = 0;
 	dev->io.Attributes2 = 0;
 
 	win.Attributes = WIN_ADDR_SPACE_MEM | WIN_MEMORY_TYPE_CM |
@@ -109,14 +111,14 @@ static int __devinit b43_pcmcia_probe(st
 	mem.CardOffset = 0;
 	mem.Page = 0;
 	res = pcmcia_map_mem_page(dev->win, &mem);
 	if (res != CS_SUCCESS)
 		goto err_disable;
 
-	dev->irq.Attributes = IRQ_TYPE_DYNAMIC_SHARING | IRQ_FIRST_SHARED;
-	dev->irq.IRQInfo1 = IRQ_LEVEL_ID | IRQ_SHARE_ID;
+	dev->irq.Attributes = IRQ_TYPE_DYNAMIC_SHARING;
+	dev->irq.IRQInfo1 = IRQ_LEVEL_ID;
 	dev->irq.Handler = NULL; /* The handler is registered later. */
 	dev->irq.Instance = NULL;
 	res = pcmcia_request_irq(dev, &dev->irq);
 	if (res != CS_SUCCESS)
 		goto err_disable;
 


From michael.bernhard at bfh.ch  Fri Mar 28 15:02:53 2008
From: michael.bernhard at bfh.ch (Bernhard Michael)
Date: Fri, 28 Mar 2008 15:02:53 +0100
Subject: b43legacy poor connection
Message-ID: <47ECFA8D.501@bfh.ch>

Hi

I own a Linksys WPC54G card with a BCM4306 chipset which requires b43legacy.

The card worked with the bcm43xx driver. I now compiled the latest (march 25)
wireless-testing kernel and use now the b43legacy driver.

The card seems working, I notice however the same behavior David Ellingsworth 
in his post described (http://lists.berlios.de/pipermail/bcm43xx-dev/2007-August/005733.html).
Only 1 Mbit/s despite good link quality and constant reassociation.
I use the card at the university where many access points are installed.

Did anybody observe the same behavior or is there already a solution?

Here the syslog output:

Loading the module (modprobe b43legacy):

pccard: CardBus card inserted into slot 1
PCI: Enabling device 0000:06:00.0 (0000 -> 0002)
ACPI: PCI Interrupt 0000:06:00.0[A] -> Link [LNKB] -> GSI 4 (level, low) -> IRQ 4
PCI: Setting latency timer of device 0000:06:00.0 to 64
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x02, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x04, vendor 0x4243)
ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x01, vendor 0x4243)
ssb: Core 3 found: V90 (cc 0x807, rev 0x01, vendor 0x4243)
ssb: Core 4 found: PCI (cc 0x804, rev 0x07, vendor 0x4243)
ssb: Core 5 found: IEEE 802.11 (cc 0x812, rev 0x04, vendor 0x4243)
ssb: Ignoring additional 802.11 core
ssb: SPROM revision 1 detected.
ssb: Sonics Silicon Backplane found on PCI device 0000:06:00.0
b43legacy-phy0: Broadcom 4306 WLAN found
b43legacy-phy0 debug: Found PHY: Analog 1, Type 2, Revision 1
b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
b43legacy-phy0 debug: Radio initialized
phy0: Selected rate control algorithm 'pid'
Broadcom 43xx-legacy driver loaded [ Features: PID, Firmware-ID: FW10 ]


Bringing the interface up (ifconfig wlan0 up), the firmware gets loaded:

b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
b43legacy-phy0 debug: Chip initialized
b43legacy-phy0 debug: 30-bit DMA initialized
b43legacy-phy0 debug: Wireless interface started
b43legacy-phy0 debug: Adding Interface type 2


Configure the essid (iwconfig wlan0 essid yyyy), the device associates

wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:xx:xx:xx:xx:xx
wlan0: RX authentication from 00:xx:xx:xx:xx:xx (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:xx:xx:xx:xx:xx
wlan0: authentication frame received from 00:xx:xx:xx:xx:xx, but not in authenticate state - ignored
wlan0: authentication frame received from 00:xx:xx:xx:xx:xx, but not in authenticate state - ignored
wlan0: RX AssocResp from 00:xx:xx:xx:xx:xx (capab=0x421 status=0 aid=103)
wlan0: associated


Now the network connection is up and I can access the internet. However is see a bunch of the following messages:

Sometimes CTS protection gets enabled and disabled:

wlan0: CTS protection enabled (BSSID=00:xx:xx:xx:xx:xx)
wlan0: CTS protection disabled (BSSID=00:xx:xx:xx:xx:xx)


The WLAN-Device keeps reauthenticating with the same access point:

wlan0: RX deauthentication from 00:xx:xx:xx:xx:xx (reason=2)
wlan0: deauthenticated
wlan0: authenticate with AP 00:xx:xx:xx:xx:xx
wlan0: RX authentication from 00:xx:xx:xx:xx:xx (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:xx:xx:xx:xx:xx
wlan0: associate with AP 00:xx:xx:xx:xx:xx
wlan0: RX ReassocResp from 00:xx:xx:xx:xx:xx (capab=0x421 status=0 aid=48)
wlan0: associated


After I stopped the network interface (ifconfig wlan0 down) I got following debug messages:

b43legacy-phy0 debug: Removing Interface type 2
b43legacy-phy0 debug: Wireless interface stopped
b43legacy-phy0 debug: DMA-30 0x0260 (RX) max used slots: 5/64
b43legacy-phy0 debug: DMA-30 0x0200 (RX) max used slots: 13/64
b43legacy-phy0 debug: DMA-30 0x02A0 (TX) max used slots: 0/128
b43legacy-phy0 debug: DMA-30 0x0280 (TX) max used slots: 0/128
b43legacy-phy0 debug: DMA-30 0x0260 (TX) max used slots: 0/128
b43legacy-phy0 debug: DMA-30 0x0240 (TX) max used slots: 0/128
b43legacy-phy0 debug: DMA-30 0x0220 (TX) max used slots: 128/128
b43legacy-phy0 debug: DMA-30 0x0200 (TX) max used slots: 0/128
b43legacy-phy0 debug: Radio initialized

Cheers
Mike


From seandarcy2 at gmail.com  Sat Mar 29 02:51:58 2008
From: seandarcy2 at gmail.com (sean darcy)
Date: Fri, 28 Mar 2008 21:51:58 -0400
Subject: new firmware: b43-phy0 ERROR: PHY transmission error
Message-ID: <c195ebf70803281851y4a608c47j49c0dfd61e3ca9a2@mail.gmail.com>

Using a
Broadcom Corporation BCM94311MCG wlan mini-PCI (rev 01)
on
2.6.24.3-50.fc8

With the 4.80.53 firmware, the b43 driver told me ( in syslog ) to
upgrade the fw before july 2008. So I did it today.

Now:

b43-phy0 ERROR: PHY transmission error
last message repeated 7 times
b43-phy0 ERROR: PHY transmission error
printk: 23 messages suppressed.
..............

constantly.

It seems to work fine, just all these syslog messages.

sean


From netrolller.3d at gmail.com  Sat Mar 29 13:04:14 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 29 Mar 2008 13:04:14 +0100
Subject: new firmware: b43-phy0 ERROR: PHY transmission error
In-Reply-To: <c195ebf70803281851y4a608c47j49c0dfd61e3ca9a2@mail.gmail.com>
References: <c195ebf70803281851y4a608c47j49c0dfd61e3ca9a2@mail.gmail.com>
Message-ID: <69e28c910803290504j2230e060k6c22745488cc4611@mail.gmail.com>

2.6.24 *needs* v4.80 firmware. 4.150 only works with 2.6.25+.

On Sat, Mar 29, 2008 at 2:51 AM, sean darcy <seandarcy2 at gmail.com> wrote:

> Using a
> Broadcom Corporation BCM94311MCG wlan mini-PCI (rev 01)
> on
> 2.6.24.3-50.fc8
>
> With the 4.80.53 firmware, the b43 driver told me ( in syslog ) to
> upgrade the fw before july 2008. So I did it today.
>
> Now:
>
> b43-phy0 ERROR: PHY transmission error
> last message repeated 7 times
> b43-phy0 ERROR: PHY transmission error
> printk: 23 messages suppressed.
> ..............
>
> constantly.
>
> It seems to work fine, just all these syslog messages.
>
> sean
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080329/8a025a81/attachment.html>

From bou.gui at laposte.net  Sat Mar 29 18:43:37 2008
From: bou.gui at laposte.net (Guillaume)
Date: Sat, 29 Mar 2008 18:43:37 +0100
Subject: Unstable wifi connection
Message-ID: <47EE7FC9.9020208@laposte.net>

Hi every one.

I use b43 for my Broadcom 4306 chipset ; but since the 2.6.24.11 kernel, 
my wifi connection is very unstable (with network-manger but also with 
Wicd), with a lot of hazardous disconnection and sometimes no network 
found till 5 or 10 minutes.

Can someone help me ?

Thanks for answer.

Guillaume

-- 
Mail garanti 0% Microsoft, envoy? sous Ubuntu Hardy

Pourquoi payer des logiciels inutiles en achetant un ordinateur ?
http://www.racketiciel.info
http://www.detaxe.org



From mb at bu3sch.de  Sat Mar 29 21:01:16 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 29 Mar 2008 21:01:16 +0100
Subject: [PATCH] b43: Add PIO support for PCMCIA devices
Message-ID: <200803292101.16696.mb@bu3sch.de>

This adds PIO support back (D'oh!) for PCMCIA devices.
This is a complete rewrite of the old PIO code. It does actually work
and we get reasonable performance out of it on a modern machine.
On a PowerBook G4 I get a few MBit for TX and a few more for RX.
So it doesn't work as well as DMA (of course), but it's a _lot_ faster
than the old PIO code (only got a few kBit with that).

The limiting factor is the host CPU speed. So it will generate 100%
CPU usage when the network interface is heavily loaded. A voluntary preemption
point in the RX path makes sure Desktop Latency isn't hurt.

PIO is needed for 16bit PCMCIA devices, as we really don't want to poke with
the braindead DMA mechanisms on PCMCIA sockets. Additionally, not all
PCMCIA sockets do actually support DMA in 16bit mode (mine doesn't).

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, please queue for 2.6.26
With this patch (and the others I sent earlier) we can finally get
16bit PCMCIA and Compact Flash cards working.

Index: wireless-testing/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Kconfig	2008-03-29 19:52:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/Kconfig	2008-03-29 19:52:35.000000000 +0100
@@ -59,12 +59,19 @@ config B43_PCMCIA
 	  CF b43 cards can sometimes be found in handheld PCs.
 
 	  It's safe to select Y here, even if you don't have a B43 PCMCIA device.
 
 	  If unsure, say N.
 
+# Data transfers to the device via PIO
+# This is only needed on PCMCIA devices. All others can do DMA properly.
+config B43_PIO
+	bool
+	depends on B43 && (B43_PCMCIA || B43_FORCE_PIO)
+	default y
+
 config B43_NPHY
 	bool "Pre IEEE 802.11n support (BROKEN)"
 	depends on B43 && EXPERIMENTAL
 	---help---
 	  Support for the IEEE 802.11n draft.
 
@@ -91,6 +98,16 @@ config B43_DEBUG
 	depends on B43
 	---help---
 	  Broadcom 43xx debugging messages.
 
 	  Say Y, if you want to find out why the driver does not
 	  work for you.
+
+config B43_FORCE_PIO
+	bool "Force usage of PIO instead of DMA"
+	depends on B43 && B43_DEBUG
+	---help---
+	  This will disable DMA and always enable PIO instead.
+
+	  Say N!
+	  This is only for debugging the PIO engine code. You do
+	  _NOT_ want to enable this.
Index: wireless-testing/drivers/net/wireless/b43/pio.c
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ wireless-testing/drivers/net/wireless/b43/pio.c	2008-03-29 19:53:10.000000000 +0100
@@ -0,0 +1,835 @@
+/*
+
+  Broadcom B43 wireless driver
+
+  PIO data transfer
+
+  Copyright (c) 2005-2008 Michael Buesch <mb at bu3sch.de>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; see the file COPYING.  If not, write to
+  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,
+  Boston, MA 02110-1301, USA.
+
+*/
+
+#include "b43.h"
+#include "pio.h"
+#include "dma.h"
+#include "main.h"
+#include "xmit.h"
+
+#include <linux/delay.h>
+
+
+static void b43_pio_rx_work(struct work_struct *work);
+
+
+static u16 generate_cookie(struct b43_pio_txqueue *q,
+			   struct b43_pio_txpacket *pack)
+{
+	u16 cookie;
+
+	/* Use the upper 4 bits of the cookie as
+	 * PIO controller ID and store the packet index number
+	 * in the lower 12 bits.
+	 * Note that the cookie must never be 0, as this
+	 * is a special value used in RX path.
+	 * It can also not be 0xFFFF because that is special
+	 * for multicast frames.
+	 */
+	cookie = (((u16)q->index + 1) << 12);
+	cookie |= pack->index;
+
+	return cookie;
+}
+
+static
+struct b43_pio_txqueue * parse_cookie(struct b43_wldev *dev,
+				      u16 cookie,
+				      struct b43_pio_txpacket **pack)
+{
+	struct b43_pio *pio = &dev->pio;
+	struct b43_pio_txqueue *q = NULL;
+	unsigned int pack_index;
+
+	switch (cookie & 0xF000) {
+	case 0x1000:
+		q = pio->tx_queue_AC_BK;
+		break;
+	case 0x2000:
+		q = pio->tx_queue_AC_BE;
+		break;
+	case 0x3000:
+		q = pio->tx_queue_AC_VI;
+		break;
+	case 0x4000:
+		q = pio->tx_queue_AC_VO;
+		break;
+	case 0x5000:
+		q = pio->tx_queue_mcast;
+		break;
+	}
+	if (B43_WARN_ON(!q))
+		return NULL;
+	pack_index = (cookie & 0x0FFF);
+	if (B43_WARN_ON(pack_index >= ARRAY_SIZE(q->packets)))
+		return NULL;
+	*pack = &q->packets[pack_index];
+
+	return q;
+}
+
+static u16 index_to_pioqueue_base(struct b43_wldev *dev,
+				  unsigned int index)
+{
+	static const u16 bases[] = {
+		B43_MMIO_PIO_BASE0,
+		B43_MMIO_PIO_BASE1,
+		B43_MMIO_PIO_BASE2,
+		B43_MMIO_PIO_BASE3,
+		B43_MMIO_PIO_BASE4,
+		B43_MMIO_PIO_BASE5,
+		B43_MMIO_PIO_BASE6,
+		B43_MMIO_PIO_BASE7,
+	};
+	static const u16 bases_rev11[] = {
+		B43_MMIO_PIO11_BASE0,
+		B43_MMIO_PIO11_BASE1,
+		B43_MMIO_PIO11_BASE2,
+		B43_MMIO_PIO11_BASE3,
+		B43_MMIO_PIO11_BASE4,
+		B43_MMIO_PIO11_BASE5,
+	};
+
+	if (dev->dev->id.revision >= 11) {
+		B43_WARN_ON(index >= ARRAY_SIZE(bases_rev11));
+		return bases_rev11[index];
+	}
+	B43_WARN_ON(index >= ARRAY_SIZE(bases));
+	return bases[index];
+}
+
+static u16 pio_txqueue_offset(struct b43_wldev *dev)
+{
+	if (dev->dev->id.revision >= 11)
+		return 0x18;
+	return 0;
+}
+
+static u16 pio_rxqueue_offset(struct b43_wldev *dev)
+{
+	if (dev->dev->id.revision >= 11)
+		return 0x38;
+	return 8;
+}
+
+static struct b43_pio_txqueue * b43_setup_pioqueue_tx(struct b43_wldev *dev,
+						      unsigned int index)
+{
+	struct b43_pio_txqueue *q;
+	struct b43_pio_txpacket *p;
+	unsigned int i;
+
+	q = kzalloc(sizeof(*q), GFP_KERNEL);
+	if (!q)
+		return NULL;
+	spin_lock_init(&q->lock);
+	q->dev = dev;
+	q->rev = dev->dev->id.revision;
+	q->mmio_base = index_to_pioqueue_base(dev, index) +
+		       pio_txqueue_offset(dev);
+	q->index = index;
+
+	q->free_packet_slots = B43_PIO_MAX_NR_TXPACKETS;
+	if (q->rev >= 8) {
+		q->buffer_size = 1920; //FIXME this constant is wrong.
+	} else {
+		q->buffer_size = b43_piotx_read16(q, B43_PIO_TXQBUFSIZE);
+		q->buffer_size -= 80;
+	}
+
+	INIT_LIST_HEAD(&q->packets_list);
+	for (i = 0; i < ARRAY_SIZE(q->packets); i++) {
+		p = &(q->packets[i]);
+		INIT_LIST_HEAD(&p->list);
+		p->index = i;
+		p->queue = q;
+		list_add(&p->list, &q->packets_list);
+	}
+
+	return q;
+}
+
+static struct b43_pio_rxqueue * b43_setup_pioqueue_rx(struct b43_wldev *dev,
+						      unsigned int index)
+{
+	struct b43_pio_rxqueue *q;
+
+	q = kzalloc(sizeof(*q), GFP_KERNEL);
+	if (!q)
+		return NULL;
+	spin_lock_init(&q->lock);
+	q->dev = dev;
+	q->rev = dev->dev->id.revision;
+	q->mmio_base = index_to_pioqueue_base(dev, index) +
+		       pio_rxqueue_offset(dev);
+	INIT_WORK(&q->rx_work, b43_pio_rx_work);
+
+	/* Enable Direct FIFO RX (PIO) on the engine. */
+	b43_dma_direct_fifo_rx(dev, index, 1);
+
+	return q;
+}
+
+static void b43_pio_cancel_tx_packets(struct b43_pio_txqueue *q)
+{
+	struct b43_pio_txpacket *pack;
+	unsigned int i;
+
+	for (i = 0; i < ARRAY_SIZE(q->packets); i++) {
+		pack = &(q->packets[i]);
+		if (pack->skb) {
+			dev_kfree_skb_any(pack->skb);
+			pack->skb = NULL;
+		}
+	}
+}
+
+static void b43_destroy_pioqueue_tx(struct b43_pio_txqueue *q,
+				    const char *name)
+{
+	if (!q)
+		return;
+	b43_pio_cancel_tx_packets(q);
+	kfree(q);
+}
+
+static void b43_destroy_pioqueue_rx(struct b43_pio_rxqueue *q,
+				    const char *name)
+{
+	if (!q)
+		return;
+	kfree(q);
+}
+
+#define destroy_queue_tx(pio, queue) do {				\
+	b43_destroy_pioqueue_tx((pio)->queue, __stringify(queue));	\
+	(pio)->queue = NULL;						\
+  } while (0)
+
+#define destroy_queue_rx(pio, queue) do {				\
+	b43_destroy_pioqueue_rx((pio)->queue, __stringify(queue));	\
+	(pio)->queue = NULL;						\
+  } while (0)
+
+void b43_pio_free(struct b43_wldev *dev)
+{
+	struct b43_pio *pio;
+
+	if (!b43_using_pio_transfers(dev))
+		return;
+	pio = &dev->pio;
+
+	destroy_queue_rx(pio, rx_queue);
+	destroy_queue_tx(pio, tx_queue_mcast);
+	destroy_queue_tx(pio, tx_queue_AC_VO);
+	destroy_queue_tx(pio, tx_queue_AC_VI);
+	destroy_queue_tx(pio, tx_queue_AC_BE);
+	destroy_queue_tx(pio, tx_queue_AC_BK);
+}
+
+void b43_pio_stop(struct b43_wldev *dev)
+{
+	if (!b43_using_pio_transfers(dev))
+		return;
+	cancel_work_sync(&dev->pio.rx_queue->rx_work);
+}
+
+int b43_pio_init(struct b43_wldev *dev)
+{
+	struct b43_pio *pio = &dev->pio;
+	int err = -ENOMEM;
+
+	b43_write32(dev, B43_MMIO_MACCTL, b43_read32(dev, B43_MMIO_MACCTL)
+		    & ~B43_MACCTL_BE);
+	b43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_RXPADOFF, 0);
+
+	pio->tx_queue_AC_BK = b43_setup_pioqueue_tx(dev, 0);
+	if (!pio->tx_queue_AC_BK)
+		goto out;
+
+	pio->tx_queue_AC_BE = b43_setup_pioqueue_tx(dev, 1);
+	if (!pio->tx_queue_AC_BE)
+		goto err_destroy_bk;
+
+	pio->tx_queue_AC_VI = b43_setup_pioqueue_tx(dev, 2);
+	if (!pio->tx_queue_AC_VI)
+		goto err_destroy_be;
+
+	pio->tx_queue_AC_VO = b43_setup_pioqueue_tx(dev, 3);
+	if (!pio->tx_queue_AC_VO)
+		goto err_destroy_vi;
+
+	pio->tx_queue_mcast = b43_setup_pioqueue_tx(dev, 4);
+	if (!pio->tx_queue_mcast)
+		goto err_destroy_vo;
+
+	pio->rx_queue = b43_setup_pioqueue_rx(dev, 0);
+	if (!pio->rx_queue)
+		goto err_destroy_mcast;
+
+	b43dbg(dev->wl, "PIO initialized\n");
+	err = 0;
+out:
+	return err;
+
+err_destroy_mcast:
+	destroy_queue_tx(pio, tx_queue_mcast);
+err_destroy_vo:
+	destroy_queue_tx(pio, tx_queue_AC_VO);
+err_destroy_vi:
+	destroy_queue_tx(pio, tx_queue_AC_VI);
+err_destroy_be:
+	destroy_queue_tx(pio, tx_queue_AC_BE);
+err_destroy_bk:
+	destroy_queue_tx(pio, tx_queue_AC_BK);
+	return err;
+}
+
+/* Static mapping of mac80211's queues (priorities) to b43 PIO queues. */
+static struct b43_pio_txqueue * select_queue_by_priority(struct b43_wldev *dev,
+							 u8 queue_prio)
+{
+	struct b43_pio_txqueue *q;
+
+	if (b43_modparam_qos) {
+		/* 0 = highest priority */
+		switch (queue_prio) {
+		default:
+			B43_WARN_ON(1);
+			/* fallthrough */
+		case 0:
+			q = dev->pio.tx_queue_AC_VO;
+			break;
+		case 1:
+			q = dev->pio.tx_queue_AC_VI;
+			break;
+		case 2:
+			q = dev->pio.tx_queue_AC_BE;
+			break;
+		case 3:
+			q = dev->pio.tx_queue_AC_BK;
+			break;
+		}
+	} else
+		q = dev->pio.tx_queue_AC_BE;
+
+	return q;
+}
+
+static inline void tx_write_2byte_queue(struct b43_pio_txqueue *q,
+					u16 *ctl,
+					const void *_data,
+					unsigned int data_len)
+{
+	const u8 *data = _data;
+	unsigned int i;
+	u16 value;
+
+	*ctl |= B43_PIO_TXCTL_WRITELO | B43_PIO_TXCTL_WRITEHI;
+	b43_piotx_write16(q, B43_PIO_TXCTL, *ctl);
+	for (i = 0; i < data_len; i += 2) {
+		value = data[i];
+		if (i + 1 < data_len) {
+			value |= (u16)(data[i + 1]) << 8;
+		} else {
+			*ctl &= ~B43_PIO_TXCTL_WRITEHI;
+			b43_piotx_write16(q, B43_PIO_TXCTL, *ctl);
+		}
+		b43_piotx_write16(q, B43_PIO_TXDATA, value);
+	}
+}
+
+static void pio_tx_frame_2byte_queue(struct b43_pio_txpacket *pack,
+				     const u8 *hdr, unsigned int hdrlen)
+{
+	struct b43_pio_txqueue *q = pack->queue;
+	const char *frame = pack->skb->data;
+	unsigned int frame_len = pack->skb->len;
+	u16 ctl;
+
+	ctl = b43_piotx_read16(q, B43_PIO_TXCTL);
+	ctl |= B43_PIO_TXCTL_FREADY;
+	ctl &= ~B43_PIO_TXCTL_EOF;
+
+	/* Transfer the header data. */
+	tx_write_2byte_queue(q, &ctl, hdr, hdrlen);
+	/* Transfer the frame data. */
+	tx_write_2byte_queue(q, &ctl, frame, frame_len);
+
+	ctl |= B43_PIO_TXCTL_EOF;
+	b43_piotx_write16(q, B43_PIO_TXCTL, ctl);
+}
+
+static inline void tx_write_4byte_queue(struct b43_pio_txqueue *q,
+					u32 *ctl,
+					const void *_data,
+					unsigned int data_len)
+{
+	const u8 *data = _data;
+	unsigned int i;
+	u32 value;
+	bool ctl_changed = 0;
+
+	*ctl |= B43_PIO8_TXCTL_0_7 | B43_PIO8_TXCTL_8_15 |
+		B43_PIO8_TXCTL_16_23 | B43_PIO8_TXCTL_24_31;
+	b43_piotx_write32(q, B43_PIO8_TXCTL, *ctl);
+	for (i = 0; i < data_len; i += 4) {
+		value = data[i];
+		if (i + 1 < data_len) {
+			value |= (u32)(data[i + 1]) << 8;
+		} else {
+			*ctl &= ~B43_PIO8_TXCTL_8_15;
+			ctl_changed = 1;
+		}
+		if (i + 2 < data_len) {
+			value |= (u32)(data[i + 2]) << 16;
+		} else {
+			*ctl &= ~B43_PIO8_TXCTL_16_23;
+			ctl_changed = 1;
+		}
+		if (i + 3 < data_len) {
+			value |= (u32)(data[i + 3]) << 24;
+		} else {
+			*ctl &= ~B43_PIO8_TXCTL_24_31;
+			ctl_changed = 1;
+		}
+		if (ctl_changed)
+			b43_piotx_write32(q, B43_PIO8_TXCTL, *ctl);
+		b43_piotx_write32(q, B43_PIO8_TXDATA, value);
+	}
+}
+
+static void pio_tx_frame_4byte_queue(struct b43_pio_txpacket *pack,
+				     const u8 *hdr, unsigned int hdrlen)
+{
+	struct b43_pio_txqueue *q = pack->queue;
+	const char *frame = pack->skb->data;
+	unsigned int frame_len = pack->skb->len;
+	u32 ctl;
+
+	ctl = b43_piotx_read32(q, B43_PIO8_TXCTL);
+	ctl |= B43_PIO8_TXCTL_FREADY;
+	ctl &= ~B43_PIO8_TXCTL_EOF;
+
+	/* Transfer the header data. */
+	tx_write_4byte_queue(q, &ctl, hdr, hdrlen);
+	/* Transfer the frame data. */
+	tx_write_4byte_queue(q, &ctl, frame, frame_len);
+
+	ctl |= B43_PIO8_TXCTL_EOF;
+	b43_piotx_write32(q, B43_PIO_TXCTL, ctl);
+}
+
+static int pio_tx_frame(struct b43_pio_txqueue *q,
+			struct sk_buff *skb,
+			struct ieee80211_tx_control *ctl)
+{
+	struct b43_pio_txpacket *pack;
+	struct b43_txhdr txhdr;
+	u16 cookie;
+	int err;
+	unsigned int hdrlen;
+
+	B43_WARN_ON(list_empty(&q->packets_list));
+	pack = list_entry(q->packets_list.next,
+			  struct b43_pio_txpacket, list);
+	memset(&pack->txstat, 0, sizeof(pack->txstat));
+	memcpy(&pack->txstat.control, ctl, sizeof(*ctl));
+
+	cookie = generate_cookie(q, pack);
+	hdrlen = b43_txhdr_size(q->dev);
+	err = b43_generate_txhdr(q->dev, (u8 *)&txhdr, skb->data,
+				 skb->len, ctl, cookie);
+	if (err)
+		return err;
+
+	if (ctl->flags & IEEE80211_TXCTL_SEND_AFTER_DTIM) {
+		/* Tell the firmware about the cookie of the last
+		 * mcast frame, so it can clear the more-data bit in it. */
+		b43_shm_write16(q->dev, B43_SHM_SHARED,
+				B43_SHM_SH_MCASTCOOKIE, cookie);
+	}
+
+	pack->skb = skb;
+	if (q->rev >= 8)
+		pio_tx_frame_4byte_queue(pack, (const u8 *)&txhdr, hdrlen);
+	else
+		pio_tx_frame_2byte_queue(pack, (const u8 *)&txhdr, hdrlen);
+
+	/* Remove it from the list of available packet slots.
+	 * It will be put back when we receive the status report. */
+	list_del(&pack->list);
+
+	/* Update the queue statistics. */
+	q->buffer_used += roundup(skb->len + hdrlen, 4);
+	q->free_packet_slots -= 1;
+
+	return 0;
+}
+
+int b43_pio_tx(struct b43_wldev *dev,
+	       struct sk_buff *skb, struct ieee80211_tx_control *ctl)
+{
+	struct b43_pio_txqueue *q;
+	struct ieee80211_hdr *hdr;
+	unsigned long flags;
+	unsigned int hdrlen, total_len;
+	int err = 0;
+
+	hdr = (struct ieee80211_hdr *)skb->data;
+	if (ctl->flags & IEEE80211_TXCTL_SEND_AFTER_DTIM) {
+		/* The multicast queue will be sent after the DTIM. */
+		q = dev->pio.tx_queue_mcast;
+		/* Set the frame More-Data bit. Ucode will clear it
+		 * for us on the last frame. */
+		hdr->frame_control |= cpu_to_le16(IEEE80211_FCTL_MOREDATA);
+	} else {
+		/* Decide by priority where to put this frame. */
+		q = select_queue_by_priority(dev, ctl->queue);
+	}
+
+	spin_lock_irqsave(&q->lock, flags);
+
+	hdrlen = b43_txhdr_size(dev);
+	total_len = roundup(skb->len + hdrlen, 4);
+
+	if (unlikely(total_len > q->buffer_size)) {
+		err = -ENOBUFS;
+		b43dbg(dev->wl, "PIO: TX packet longer than queue.\n");
+		goto out_unlock;
+	}
+	if (unlikely(q->free_packet_slots == 0)) {
+		err = -ENOBUFS;
+		b43warn(dev->wl, "PIO: TX packet overflow.\n");
+		goto out_unlock;
+	}
+	B43_WARN_ON(q->buffer_used > q->buffer_size);
+
+	if (total_len > (q->buffer_size - q->buffer_used)) {
+		/* Not enough memory on the queue. */
+		err = -EBUSY;
+		ieee80211_stop_queue(dev->wl->hw, ctl->queue);
+		q->stopped = 1;
+		goto out_unlock;
+	}
+
+	/* Assign the queue number to the ring (if not already done before)
+	 * so TX status handling can use it. The mac80211-queue to b43-queue
+	 * mapping is static, so we don't need to store it per frame. */
+	q->queue_prio = ctl->queue;
+
+	err = pio_tx_frame(q, skb, ctl);
+	if (unlikely(err == -ENOKEY)) {
+		/* Drop this packet, as we don't have the encryption key
+		 * anymore and must not transmit it unencrypted. */
+		dev_kfree_skb_any(skb);
+		err = 0;
+		goto out_unlock;
+	}
+	if (unlikely(err)) {
+		b43err(dev->wl, "PIO transmission failure\n");
+		goto out_unlock;
+	}
+	q->nr_tx_packets++;
+
+	B43_WARN_ON(q->buffer_used > q->buffer_size);
+	if (((q->buffer_size - q->buffer_used) < roundup(2 + 2 + 6, 4)) ||
+	    (q->free_packet_slots == 0)) {
+		/* The queue is full. */
+		ieee80211_stop_queue(dev->wl->hw, ctl->queue);
+		q->stopped = 1;
+	}
+
+out_unlock:
+	spin_unlock_irqrestore(&q->lock, flags);
+
+	return err;
+}
+
+/* Called with IRQs disabled. */
+void b43_pio_handle_txstatus(struct b43_wldev *dev,
+			     const struct b43_txstatus *status)
+{
+	struct b43_pio_txqueue *q;
+	struct b43_pio_txpacket *pack = NULL;
+	unsigned int total_len;
+
+	q = parse_cookie(dev, status->cookie, &pack);
+	if (unlikely(!q))
+		return;
+	B43_WARN_ON(!pack);
+
+	spin_lock(&q->lock); /* IRQs are already disabled. */
+
+	b43_fill_txstatus_report(&(pack->txstat), status);
+
+	total_len = pack->skb->len + b43_txhdr_size(dev);
+	total_len = roundup(total_len, 4);
+	q->buffer_used -= total_len;
+	q->free_packet_slots += 1;
+
+	ieee80211_tx_status_irqsafe(dev->wl->hw, pack->skb,
+				    &(pack->txstat));
+	pack->skb = NULL;
+	list_add(&pack->list, &q->packets_list);
+
+	if (q->stopped) {
+		ieee80211_wake_queue(dev->wl->hw, q->queue_prio);
+		q->stopped = 0;
+	}
+
+	spin_unlock(&q->lock);
+}
+
+void b43_pio_get_tx_stats(struct b43_wldev *dev,
+			  struct ieee80211_tx_queue_stats *stats)
+{
+	const int nr_queues = dev->wl->hw->queues;
+	struct b43_pio_txqueue *q;
+	struct ieee80211_tx_queue_stats_data *data;
+	unsigned long flags;
+	int i;
+
+	for (i = 0; i < nr_queues; i++) {
+		data = &(stats->data[i]);
+		q = select_queue_by_priority(dev, i);
+
+		spin_lock_irqsave(&q->lock, flags);
+		data->len = B43_PIO_MAX_NR_TXPACKETS - q->free_packet_slots;
+		data->limit = B43_PIO_MAX_NR_TXPACKETS;
+		data->count = q->nr_tx_packets;
+		spin_unlock_irqrestore(&q->lock, flags);
+	}
+}
+
+/* Returns whether we should fetch another frame. */
+static bool pio_rx_frame(struct b43_pio_rxqueue *q)
+{
+	struct b43_rxhdr_fw4 rxhdr;
+	u16 len;
+	u32 macstat;
+	unsigned int i, padding;
+	struct sk_buff *skb;
+	const char *err_msg = NULL;
+
+	memset(&rxhdr, 0, sizeof(rxhdr));
+
+	/* Check if we have data and wait for it to get ready. */
+	if (q->rev >= 8) {
+		u32 ctl;
+
+		ctl = b43_piorx_read32(q, B43_PIO8_RXCTL);
+		if (!(ctl & B43_PIO8_RXCTL_FRAMERDY))
+			return 0;
+		b43_piorx_write32(q, B43_PIO8_RXCTL,
+				  B43_PIO8_RXCTL_FRAMERDY);
+		for (i = 0; i < 10; i++) {
+			ctl = b43_piorx_read32(q, B43_PIO8_RXCTL);
+			if (ctl & B43_PIO8_RXCTL_DATARDY)
+				goto data_ready;
+			udelay(10);
+		}
+	} else {
+		u16 ctl;
+
+		ctl = b43_piorx_read16(q, B43_PIO_RXCTL);
+		if (!(ctl & B43_PIO_RXCTL_FRAMERDY))
+			return 0;
+		b43_piorx_write16(q, B43_PIO_RXCTL,
+				  B43_PIO_RXCTL_FRAMERDY);
+		for (i = 0; i < 10; i++) {
+			ctl = b43_piorx_read16(q, B43_PIO_RXCTL);
+			if (ctl & B43_PIO_RXCTL_DATARDY)
+				goto data_ready;
+			udelay(10);
+		}
+	}
+	b43dbg(q->dev->wl, "PIO RX timed out\n");
+	return 1;
+data_ready:
+
+	/* Get the preamble (RX header) */
+	if (q->rev >= 8) {
+		u32 *preamble = (u32 *)&rxhdr;
+		u32 value;
+
+		for (i = 0; i < sizeof(rxhdr); i += 4) {
+			value = b43_piorx_read32(q, B43_PIO8_RXDATA);
+			preamble[i / 4] = cpu_to_le32(value);
+		}
+	} else {
+		u16 *preamble = (u16 *)&rxhdr;
+		u16 value;
+
+		for (i = 0; i < sizeof(rxhdr); i += 2) {
+			value = b43_piorx_read16(q, B43_PIO_RXDATA);
+			preamble[i / 2] = cpu_to_le16(value);
+		}
+	}
+	/* Sanity checks. */
+	len = le16_to_cpu(rxhdr.frame_len);
+	if (unlikely(len > 0x700)) {
+		err_msg = "len > 0x700";
+		goto rx_error;
+	}
+	if (unlikely(len == 0)) {
+		err_msg = "len == 0";
+		goto rx_error;
+	}
+
+	macstat = le32_to_cpu(rxhdr.mac_status);
+	if (macstat & B43_RX_MAC_FCSERR) {
+		if (!(q->dev->wl->filter_flags & FIF_FCSFAIL)) {
+			/* Drop frames with failed FCS. */
+			err_msg = "Frame FCS error";
+			goto rx_error;
+		}
+	}
+
+	/* We always pad 2 bytes, as that's what upstream code expects
+	 * due to the RX-header being 30 bytes. In case the frame is
+	 * unaligned, we pad another 2 bytes. */
+	padding = (macstat & B43_RX_MAC_PADDING) ? 2 : 0;
+	skb = dev_alloc_skb(len + padding + 2);
+	if (unlikely(!skb)) {
+		err_msg = "Out of memory";
+		goto rx_error;
+	}
+	skb_reserve(skb, 2);
+	skb_put(skb, len + padding);
+	if (q->rev >= 8) {
+		u32 value;
+
+		for (i = padding; i < len + padding; i += 4) {
+			value = b43_piorx_read32(q, B43_PIO8_RXDATA);
+			skb->data[i] = value;
+			if ((i + 1) < (len + padding))
+				skb->data[i + 1] = value >> 8;
+			if ((i + 2) < (len + padding))
+				skb->data[i + 2] = value >> 16;
+			if ((i + 3) < (len + padding))
+				skb->data[i + 3] = value >> 24;
+		}
+	} else {
+		u16 value;
+
+		for (i = padding; i < len + padding; i += 2) {
+			value = b43_piorx_read16(q, B43_PIO_RXDATA);
+			skb->data[i] = value;
+			if ((i + 1) < (len + padding))
+				skb->data[i + 1] = value >> 8;
+		}
+	}
+
+	b43_rx(q->dev, skb, &rxhdr);
+
+	return 1;
+
+rx_error:
+	if (err_msg)
+		b43dbg(q->dev->wl, "PIO RX error: %s\n", err_msg);
+	b43_piorx_write16(q, B43_PIO_RXCTL, B43_PIO_RXCTL_DATARDY);
+	return 1;
+}
+
+/* RX workqueue. We can sleep, yay! */
+static void b43_pio_rx_work(struct work_struct *work)
+{
+	struct b43_pio_rxqueue *q = container_of(work, struct b43_pio_rxqueue,
+						 rx_work);
+	unsigned int budget = 50;
+	bool stop;
+
+	do {
+		spin_lock_irq(&q->lock);
+		stop = (pio_rx_frame(q) == 0);
+		spin_unlock_irq(&q->lock);
+		cond_resched();
+		if (stop)
+			break;
+	} while (--budget);
+}
+
+/* Called with IRQs disabled. */
+void b43_pio_rx(struct b43_pio_rxqueue *q)
+{
+	/* Due to latency issues we must run the RX path in
+	 * a workqueue to be able to schedule between packets. */
+	queue_work(q->dev->wl->hw->workqueue, &q->rx_work);
+}
+
+static void b43_pio_tx_suspend_queue(struct b43_pio_txqueue *q)
+{
+	unsigned long flags;
+
+	spin_lock_irqsave(&q->lock, flags);
+	if (q->rev >= 8) {
+		b43_piotx_write32(q, B43_PIO8_TXCTL,
+				  b43_piotx_read32(q, B43_PIO8_TXCTL)
+				  | B43_PIO8_TXCTL_SUSPREQ);
+	} else {
+		b43_piotx_write16(q, B43_PIO_TXCTL,
+				  b43_piotx_read16(q, B43_PIO_TXCTL)
+				  | B43_PIO_TXCTL_SUSPREQ);
+	}
+	spin_unlock_irqrestore(&q->lock, flags);
+}
+
+static void b43_pio_tx_resume_queue(struct b43_pio_txqueue *q)
+{
+	unsigned long flags;
+
+	spin_lock_irqsave(&q->lock, flags);
+	if (q->rev >= 8) {
+		b43_piotx_write32(q, B43_PIO8_TXCTL,
+				  b43_piotx_read32(q, B43_PIO8_TXCTL)
+				  & ~B43_PIO8_TXCTL_SUSPREQ);
+	} else {
+		b43_piotx_write16(q, B43_PIO_TXCTL,
+				  b43_piotx_read16(q, B43_PIO_TXCTL)
+				  & ~B43_PIO_TXCTL_SUSPREQ);
+	}
+	spin_unlock_irqrestore(&q->lock, flags);
+}
+
+void b43_pio_tx_suspend(struct b43_wldev *dev)
+{
+	b43_power_saving_ctl_bits(dev, B43_PS_AWAKE);
+	b43_pio_tx_suspend_queue(dev->pio.tx_queue_AC_BK);
+	b43_pio_tx_suspend_queue(dev->pio.tx_queue_AC_BE);
+	b43_pio_tx_suspend_queue(dev->pio.tx_queue_AC_VI);
+	b43_pio_tx_suspend_queue(dev->pio.tx_queue_AC_VO);
+	b43_pio_tx_suspend_queue(dev->pio.tx_queue_mcast);
+}
+
+void b43_pio_tx_resume(struct b43_wldev *dev)
+{
+	b43_pio_tx_resume_queue(dev->pio.tx_queue_mcast);
+	b43_pio_tx_resume_queue(dev->pio.tx_queue_AC_VO);
+	b43_pio_tx_resume_queue(dev->pio.tx_queue_AC_VI);
+	b43_pio_tx_resume_queue(dev->pio.tx_queue_AC_BE);
+	b43_pio_tx_resume_queue(dev->pio.tx_queue_AC_BK);
+	b43_power_saving_ctl_bits(dev, 0);
+}
Index: wireless-testing/drivers/net/wireless/b43/pio.h
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ wireless-testing/drivers/net/wireless/b43/pio.h	2008-03-29 19:52:35.000000000 +0100
@@ -0,0 +1,220 @@
+#ifndef B43_PIO_H_
+#define B43_PIO_H_
+
+#include "b43.h"
+
+#include <linux/interrupt.h>
+#include <linux/io.h>
+#include <linux/list.h>
+#include <linux/skbuff.h>
+
+
+/*** Registers for PIO queues up to revision 7. ***/
+/* TX queue. */
+#define B43_PIO_TXCTL			0x00
+#define  B43_PIO_TXCTL_WRITELO		0x0001
+#define  B43_PIO_TXCTL_WRITEHI		0x0002
+#define  B43_PIO_TXCTL_EOF		0x0004
+#define  B43_PIO_TXCTL_FREADY		0x0008
+#define  B43_PIO_TXCTL_FLUSHREQ		0x0020
+#define  B43_PIO_TXCTL_FLUSHPEND	0x0040
+#define  B43_PIO_TXCTL_SUSPREQ		0x0080
+#define  B43_PIO_TXCTL_QSUSP		0x0100
+#define  B43_PIO_TXCTL_COMMCNT		0xFC00
+#define  B43_PIO_TXCTL_COMMCNT_SHIFT	10
+#define B43_PIO_TXDATA			0x02
+#define B43_PIO_TXQBUFSIZE		0x04
+/* RX queue. */
+#define B43_PIO_RXCTL			0x00
+#define  B43_PIO_RXCTL_FRAMERDY		0x0001
+#define  B43_PIO_RXCTL_DATARDY		0x0002
+#define B43_PIO_RXDATA			0x02
+
+/*** Registers for PIO queues revision 8 and later. ***/
+/* TX queue */
+#define B43_PIO8_TXCTL			0x00
+#define  B43_PIO8_TXCTL_0_7		0x00000001
+#define  B43_PIO8_TXCTL_8_15		0x00000002
+#define  B43_PIO8_TXCTL_16_23		0x00000004
+#define  B43_PIO8_TXCTL_24_31		0x00000008
+#define  B43_PIO8_TXCTL_EOF		0x00000010
+#define  B43_PIO8_TXCTL_FREADY		0x00000080
+#define  B43_PIO8_TXCTL_SUSPREQ		0x00000100
+#define  B43_PIO8_TXCTL_QSUSP		0x00000200
+#define  B43_PIO8_TXCTL_FLUSHREQ	0x00000400
+#define  B43_PIO8_TXCTL_FLUSHPEND	0x00000800
+#define B43_PIO8_TXDATA			0x04
+/* RX queue */
+#define B43_PIO8_RXCTL			0x00
+#define  B43_PIO8_RXCTL_FRAMERDY	0x00000001
+#define  B43_PIO8_RXCTL_DATARDY		0x00000002
+#define B43_PIO8_RXDATA			0x04
+
+
+/* The maximum number of TX-packets the HW can handle. */
+#define B43_PIO_MAX_NR_TXPACKETS	32
+
+
+#ifdef CONFIG_B43_PIO
+
+struct b43_pio_txpacket {
+	/* Pointer to the TX queue we belong to. */
+	struct b43_pio_txqueue *queue;
+	/* The TX data packet. */
+	struct sk_buff *skb;
+	/* The status meta data. */
+	struct ieee80211_tx_status txstat;
+	/* Index in the (struct b43_pio_txqueue)->packets array. */
+	u8 index;
+
+	struct list_head list;
+};
+
+struct b43_pio_txqueue {
+	struct b43_wldev *dev;
+	spinlock_t lock;
+	u16 mmio_base;
+
+	/* The device queue buffer size in bytes. */
+	u16 buffer_size;
+	/* The number of used bytes in the device queue buffer. */
+	u16 buffer_used;
+	/* The number of packets that can still get queued.
+	 * This is decremented on queueing a packet and incremented
+	 * after receiving the transmit status. */
+	u16 free_packet_slots;
+
+	/* True, if the mac80211 queue was stopped due to overflow at TX. */
+	bool stopped;
+	/* Our b43 queue index number */
+	u8 index;
+	/* The mac80211 QoS queue priority. */
+	u8 queue_prio;
+
+	/* Buffer for TX packet meta data. */
+	struct b43_pio_txpacket packets[B43_PIO_MAX_NR_TXPACKETS];
+	struct list_head packets_list;
+
+	/* Total number of transmitted packets. */
+	unsigned int nr_tx_packets;
+
+	/* Shortcut to the 802.11 core revision. This is to
+	 * avoid horrible pointer dereferencing in the fastpaths. */
+	u8 rev;
+};
+
+struct b43_pio_rxqueue {
+	struct b43_wldev *dev;
+	spinlock_t lock;
+	u16 mmio_base;
+
+	/* Work to reduce latency issues on RX. */
+	struct work_struct rx_work;
+
+	/* Shortcut to the 802.11 core revision. This is to
+	 * avoid horrible pointer dereferencing in the fastpaths. */
+	u8 rev;
+};
+
+
+static inline u16 b43_piotx_read16(struct b43_pio_txqueue *q, u16 offset)
+{
+	return b43_read16(q->dev, q->mmio_base + offset);
+}
+
+static inline u32 b43_piotx_read32(struct b43_pio_txqueue *q, u16 offset)
+{
+	return b43_read32(q->dev, q->mmio_base + offset);
+}
+
+static inline void b43_piotx_write16(struct b43_pio_txqueue *q,
+				     u16 offset, u16 value)
+{
+	b43_write16(q->dev, q->mmio_base + offset, value);
+}
+
+static inline void b43_piotx_write32(struct b43_pio_txqueue *q,
+				     u16 offset, u32 value)
+{
+	b43_write32(q->dev, q->mmio_base + offset, value);
+}
+
+
+static inline u16 b43_piorx_read16(struct b43_pio_rxqueue *q, u16 offset)
+{
+	return b43_read16(q->dev, q->mmio_base + offset);
+}
+
+static inline u32 b43_piorx_read32(struct b43_pio_rxqueue *q, u16 offset)
+{
+	return b43_read32(q->dev, q->mmio_base + offset);
+}
+
+static inline void b43_piorx_write16(struct b43_pio_rxqueue *q,
+				     u16 offset, u16 value)
+{
+	b43_write16(q->dev, q->mmio_base + offset, value);
+}
+
+static inline void b43_piorx_write32(struct b43_pio_rxqueue *q,
+				     u16 offset, u32 value)
+{
+	b43_write32(q->dev, q->mmio_base + offset, value);
+}
+
+
+int b43_pio_init(struct b43_wldev *dev);
+void b43_pio_stop(struct b43_wldev *dev);
+void b43_pio_free(struct b43_wldev *dev);
+
+int b43_pio_tx(struct b43_wldev *dev,
+	       struct sk_buff *skb, struct ieee80211_tx_control *ctl);
+void b43_pio_handle_txstatus(struct b43_wldev *dev,
+			     const struct b43_txstatus *status);
+void b43_pio_get_tx_stats(struct b43_wldev *dev,
+			  struct ieee80211_tx_queue_stats *stats);
+void b43_pio_rx(struct b43_pio_rxqueue *q);
+
+void b43_pio_tx_suspend(struct b43_wldev *dev);
+void b43_pio_tx_resume(struct b43_wldev *dev);
+
+
+#else /* CONFIG_B43_PIO */
+
+
+static inline int b43_pio_init(struct b43_wldev *dev)
+{
+	return 0;
+}
+static inline void b43_pio_free(struct b43_wldev *dev)
+{
+}
+static inline void b43_pio_stop(struct b43_wldev *dev)
+{
+}
+static inline int b43_pio_tx(struct b43_wldev *dev,
+			     struct sk_buff *skb,
+			     struct ieee80211_tx_control *ctl)
+{
+	return 0;
+}
+static inline void b43_pio_handle_txstatus(struct b43_wldev *dev,
+					   const struct b43_txstatus *status)
+{
+}
+static inline void b43_pio_get_tx_stats(struct b43_wldev *dev,
+					struct ieee80211_tx_queue_stats *stats)
+{
+}
+static inline void b43_pio_rx(struct b43_pio_rxqueue *q)
+{
+}
+static inline void b43_pio_tx_suspend(struct b43_wldev *dev)
+{
+}
+static inline void b43_pio_tx_resume(struct b43_wldev *dev)
+{
+}
+
+#endif /* CONFIG_B43_PIO */
+#endif /* B43_PIO_H_ */
Index: wireless-testing/drivers/net/wireless/b43/Makefile
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Makefile	2008-03-29 19:52:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/Makefile	2008-03-29 19:52:35.000000000 +0100
@@ -5,12 +5,13 @@ b43-y				+= phy.o
 b43-$(CONFIG_B43_NPHY)		+= nphy.o
 b43-y				+= sysfs.o
 b43-y				+= xmit.o
 b43-y				+= lo.o
 b43-y				+= wa.o
 b43-y				+= dma.o
+b43-$(CONFIG_B43_PIO)		+= pio.o
 b43-$(CONFIG_B43_RFKILL)	+= rfkill.o
 b43-$(CONFIG_B43_LEDS)		+= leds.o
 b43-$(CONFIG_B43_PCMCIA)	+= pcmcia.o
 b43-$(CONFIG_B43_DEBUG)		+= debugfs.o
 
 obj-$(CONFIG_B43)		+= b43.o
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-03-29 19:52:14.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-03-29 19:52:35.000000000 +0100
@@ -72,12 +72,29 @@
 #define B43_MMIO_DMA64_BASE1		0x240
 #define B43_MMIO_DMA64_BASE2		0x280
 #define B43_MMIO_DMA64_BASE3		0x2C0
 #define B43_MMIO_DMA64_BASE4		0x300
 #define B43_MMIO_DMA64_BASE5		0x340
 
+/* PIO on core rev < 11 */
+#define B43_MMIO_PIO_BASE0		0x300
+#define B43_MMIO_PIO_BASE1		0x310
+#define B43_MMIO_PIO_BASE2		0x320
+#define B43_MMIO_PIO_BASE3		0x330
+#define B43_MMIO_PIO_BASE4		0x340
+#define B43_MMIO_PIO_BASE5		0x350
+#define B43_MMIO_PIO_BASE6		0x360
+#define B43_MMIO_PIO_BASE7		0x370
+/* PIO on core rev >= 11 */
+#define B43_MMIO_PIO11_BASE0		0x200
+#define B43_MMIO_PIO11_BASE1		0x240
+#define B43_MMIO_PIO11_BASE2		0x280
+#define B43_MMIO_PIO11_BASE3		0x2C0
+#define B43_MMIO_PIO11_BASE4		0x300
+#define B43_MMIO_PIO11_BASE5		0x340
+
 #define B43_MMIO_PHY_VER		0x3E0
 #define B43_MMIO_PHY_RADIO		0x3E2
 #define B43_MMIO_PHY0			0x3E6
 #define B43_MMIO_ANTENNA		0x3E8
 #define B43_MMIO_CHANNEL		0x3F0
 #define B43_MMIO_CHANNEL_EXT		0x3F4
@@ -439,13 +456,12 @@ enum {
 	B43_SEC_ALGO_AES,
 	B43_SEC_ALGO_WEP104,
 	B43_SEC_ALGO_AES_LEGACY,
 };
 
 struct b43_dmaring;
-struct b43_pioqueue;
 
 /* The firmware file header */
 #define B43_FW_TYPE_UCODE	'u'
 #define B43_FW_TYPE_PCM		'p'
 #define B43_FW_TYPE_IV		'i'
 struct b43_fw_header {
@@ -595,12 +611,26 @@ struct b43_dma {
 	struct b43_dmaring *tx_ring_AC_VO; /* Voice */
 	struct b43_dmaring *tx_ring_mcast; /* Multicast */
 
 	struct b43_dmaring *rx_ring;
 };
 
+struct b43_pio_txqueue;
+struct b43_pio_rxqueue;
+
+/* Data structures for PIO transmission, per 80211 core. */
+struct b43_pio {
+	struct b43_pio_txqueue *tx_queue_AC_BK; /* Background */
+	struct b43_pio_txqueue *tx_queue_AC_BE; /* Best Effort */
+	struct b43_pio_txqueue *tx_queue_AC_VI; /* Video */
+	struct b43_pio_txqueue *tx_queue_AC_VO; /* Voice */
+	struct b43_pio_txqueue *tx_queue_mcast; /* Multicast */
+
+	struct b43_pio_rxqueue *rx_queue;
+};
+
 /* Context information for a noise calculation (Link Quality). */
 struct b43_noise_calculation {
 	u8 channel_at_start;
 	bool calculation_running;
 	u8 nr_samples;
 	s8 samples[8][4];
@@ -770,14 +800,21 @@ struct b43_wldev {
 	bool radio_hw_enable;	/* saved state of radio hardware enabled state */
 	bool suspend_in_progress;	/* TRUE, if we are in a suspend/resume cycle */
 
 	/* PHY/Radio device. */
 	struct b43_phy phy;
 
-	/* DMA engines. */
-	struct b43_dma dma;
+	union {
+		/* DMA engines. */
+		struct b43_dma dma;
+		/* PIO engines. */
+		struct b43_pio pio;
+	};
+	/* Use b43_using_pio_transfers() to check whether we are using
+	 * DMA or PIO data transfers. */
+	bool __using_pio_transfers;
 
 	/* Various statistics about the physical device. */
 	struct b43_stats stats;
 
 	/* The device LEDs. */
 	struct b43_led led_tx;
@@ -855,12 +892,28 @@ static inline u32 b43_read32(struct b43_
 
 static inline void b43_write32(struct b43_wldev *dev, u16 offset, u32 value)
 {
 	ssb_write32(dev->dev, offset, value);
 }
 
+static inline bool b43_using_pio_transfers(struct b43_wldev *dev)
+{
+#ifdef CONFIG_B43_PIO
+	return dev->__using_pio_transfers;
+#else
+	return 0;
+#endif
+}
+
+#ifdef CONFIG_B43_FORCE_PIO
+# define B43_FORCE_PIO	1
+#else
+# define B43_FORCE_PIO	0
+#endif
+
+
 /* Message printing */
 void b43info(struct b43_wl *wl, const char *fmt, ...)
     __attribute__ ((format(printf, 2, 3)));
 void b43err(struct b43_wl *wl, const char *fmt, ...)
     __attribute__ ((format(printf, 2, 3)));
 void b43warn(struct b43_wl *wl, const char *fmt, ...)
Index: wireless-testing/drivers/net/wireless/b43/dma.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.c	2008-03-29 19:52:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.c	2008-03-29 19:52:35.000000000 +0100
@@ -547,13 +547,12 @@ address_error:
 
 static int setup_rx_descbuffer(struct b43_dmaring *ring,
 			       struct b43_dmadesc_generic *desc,
 			       struct b43_dmadesc_meta *meta, gfp_t gfp_flags)
 {
 	struct b43_rxhdr_fw4 *rxhdr;
-	struct b43_hwtxstatus *txstat;
 	dma_addr_t dmaaddr;
 	struct sk_buff *skb;
 
 	B43_WARN_ON(ring->tx);
 
 	skb = __dev_alloc_skb(ring->rx_buffersize, gfp_flags);
@@ -583,14 +582,12 @@ static int setup_rx_descbuffer(struct b4
 	meta->dmaaddr = dmaaddr;
 	ring->ops->fill_descriptor(ring, desc, dmaaddr,
 				   ring->rx_buffersize, 0, 0, 0);
 
 	rxhdr = (struct b43_rxhdr_fw4 *)(skb->data);
 	rxhdr->frame_len = 0;
-	txstat = (struct b43_hwtxstatus *)(skb->data);
-	txstat->cookie = 0;
 
 	return 0;
 }
 
 /* Allocate the initial descbuffers.
  * This is used for an RX ring only.
@@ -773,12 +770,24 @@ static u64 supported_dma_mask(struct b43
 	if (tmp & B43_DMA32_TXADDREXT_MASK)
 		return DMA_32BIT_MASK;
 
 	return DMA_30BIT_MASK;
 }
 
+static enum b43_dmatype dma_mask_to_engine_type(u64 dmamask)
+{
+	if (dmamask == DMA_30BIT_MASK)
+		return B43_DMA_30BIT;
+	if (dmamask == DMA_32BIT_MASK)
+		return B43_DMA_32BIT;
+	if (dmamask == DMA_64BIT_MASK)
+		return B43_DMA_64BIT;
+	B43_WARN_ON(1);
+	return B43_DMA_30BIT;
+}
+
 /* Main initialization function. */
 static
 struct b43_dmaring *b43_setup_dmaring(struct b43_wldev *dev,
 				      int controller_index,
 				      int for_tx,
 				      enum b43_dmatype type)
@@ -953,13 +962,17 @@ static void b43_destroy_dmaring(struct b
 	b43_destroy_dmaring((dma)->ring, __stringify(ring));	\
 	(dma)->ring = NULL;					\
     } while (0)
 
 void b43_dma_free(struct b43_wldev *dev)
 {
-	struct b43_dma *dma = &dev->dma;
+	struct b43_dma *dma;
+
+	if (b43_using_pio_transfers(dev))
+		return;
+	dma = &dev->dma;
 
 	destroy_ring(dma, rx_ring);
 	destroy_ring(dma, tx_ring_AC_BK);
 	destroy_ring(dma, tx_ring_AC_BE);
 	destroy_ring(dma, tx_ring_AC_VI);
 	destroy_ring(dma, tx_ring_AC_VO);
@@ -971,25 +984,13 @@ int b43_dma_init(struct b43_wldev *dev)
 	struct b43_dma *dma = &dev->dma;
 	int err;
 	u64 dmamask;
 	enum b43_dmatype type;
 
 	dmamask = supported_dma_mask(dev);
-	switch (dmamask) {
-	default:
-		B43_WARN_ON(1);
-	case DMA_30BIT_MASK:
-		type = B43_DMA_30BIT;
-		break;
-	case DMA_32BIT_MASK:
-		type = B43_DMA_32BIT;
-		break;
-	case DMA_64BIT_MASK:
-		type = B43_DMA_64BIT;
-		break;
-	}
+	type = dma_mask_to_engine_type(dmamask);
 	err = ssb_dma_set_mask(dev->dev, dmamask);
 	if (err) {
 		b43err(dev->wl, "The machine/kernel does not support "
 		       "the required DMA mask (0x%08X%08X)\n",
 		       (unsigned int)((dmamask & 0xFFFFFFFF00000000ULL) >> 32),
 		       (unsigned int)(dmamask & 0x00000000FFFFFFFFULL));
@@ -1110,13 +1111,12 @@ static int dma_tx_fragment(struct b43_dm
 	struct b43_dmadesc_meta *meta_hdr;
 	struct sk_buff *bounce_skb;
 	u16 cookie;
 	size_t hdrsize = b43_txhdr_size(ring->dev);
 
 #define SLOTS_PER_PACKET  2
-	B43_WARN_ON(skb_shinfo(skb)->nr_frags);
 
 	old_top_slot = ring->current_slot;
 	old_used_slots = ring->used_slots;
 
 	/* Get a slot for the header. */
 	slot = request_slot(ring);
@@ -1254,17 +1254,12 @@ int b43_dma_tx(struct b43_wldev *dev,
 {
 	struct b43_dmaring *ring;
 	struct ieee80211_hdr *hdr;
 	int err = 0;
 	unsigned long flags;
 
-	if (unlikely(skb->len < 2 + 2 + 6)) {
-		/* Too short, this can't be a valid frame. */
-		return -EINVAL;
-	}
-
 	hdr = (struct ieee80211_hdr *)skb->data;
 	if (ctl->flags & IEEE80211_TXCTL_SEND_AFTER_DTIM) {
 		/* The multicast ring will be sent after the DTIM */
 		ring = dev->dma.tx_ring_mcast;
 		/* Set the more-data bit. Ucode will clear it on
 		 * the last frame for us. */
@@ -1316,53 +1311,22 @@ int b43_dma_tx(struct b43_wldev *dev,
 out_unlock:
 	spin_unlock_irqrestore(&ring->lock, flags);
 
 	return err;
 }
 
-static void b43_fill_txstatus_report(struct b43_dmaring *ring,
-				    struct ieee80211_tx_status *report,
-				    const struct b43_txstatus *status)
-{
-	bool frame_failed = 0;
-
-	if (status->acked) {
-		/* The frame was ACKed. */
-		report->flags |= IEEE80211_TX_STATUS_ACK;
-	} else {
-		/* The frame was not ACKed... */
-		if (!(report->control.flags & IEEE80211_TXCTL_NO_ACK)) {
-			/* ...but we expected an ACK. */
-			frame_failed = 1;
-			report->excessive_retries = 1;
-		}
-	}
-	if (status->frame_count == 0) {
-		/* The frame was not transmitted at all. */
-		report->retry_count = 0;
-	} else {
-		report->retry_count = status->frame_count - 1;
-#ifdef CONFIG_B43_DEBUG
-		if (frame_failed)
-			ring->nr_failed_tx_packets++;
-		else
-			ring->nr_succeed_tx_packets++;
-		ring->nr_total_packet_tries += status->frame_count;
-#endif /* DEBUG */
-	}
-}
-
 /* Called with IRQs disabled. */
 void b43_dma_handle_txstatus(struct b43_wldev *dev,
 			     const struct b43_txstatus *status)
 {
 	const struct b43_dma_ops *ops;
 	struct b43_dmaring *ring;
 	struct b43_dmadesc_generic *desc;
 	struct b43_dmadesc_meta *meta;
 	int slot;
+	bool frame_succeed;
 
 	ring = parse_cookie(dev, status->cookie, &slot);
 	if (unlikely(!ring))
 		return;
 
 	spin_lock(&ring->lock); /* IRQs are already disabled. */
@@ -1383,13 +1347,21 @@ void b43_dma_handle_txstatus(struct b43_
 		if (meta->is_last_fragment) {
 			B43_WARN_ON(!meta->skb);
 			/* Call back to inform the ieee80211 subsystem about the
 			 * status of the transmission.
 			 * Some fields of txstat are already filled in dma_tx().
 			 */
-			b43_fill_txstatus_report(ring, &(meta->txstat), status);
+			frame_succeed = b43_fill_txstatus_report(
+						&(meta->txstat), status);
+#ifdef CONFIG_B43_DEBUG
+			if (frame_succeed)
+				ring->nr_succeed_tx_packets++;
+			else
+				ring->nr_failed_tx_packets++;
+			ring->nr_total_packet_tries += status->frame_count;
+#endif /* DEBUG */
 			ieee80211_tx_status_irqsafe(dev->wl->hw, meta->skb,
 						    &(meta->txstat));
 			/* skb is freed by ieee80211_tx_status_irqsafe() */
 			meta->skb = NULL;
 		} else {
 			/* No need to call free_descriptor_buffer here, as
@@ -1570,6 +1542,42 @@ void b43_dma_tx_resume(struct b43_wldev 
 	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_VO);
 	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_VI);
 	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_BE);
 	b43_dma_tx_resume_ring(dev->dma.tx_ring_AC_BK);
 	b43_power_saving_ctl_bits(dev, 0);
 }
+
+#ifdef CONFIG_B43_PIO
+static void direct_fifo_rx(struct b43_wldev *dev, enum b43_dmatype type,
+			   u16 mmio_base, bool enable)
+{
+	u32 ctl;
+
+	if (type == B43_DMA_64BIT) {
+		ctl = b43_read32(dev, mmio_base + B43_DMA64_RXCTL);
+		ctl &= ~B43_DMA64_RXDIRECTFIFO;
+		if (enable)
+			ctl |= B43_DMA64_RXDIRECTFIFO;
+		b43_write32(dev, mmio_base + B43_DMA64_RXCTL, ctl);
+	} else {
+		ctl = b43_read32(dev, mmio_base + B43_DMA32_RXCTL);
+		ctl &= ~B43_DMA32_RXDIRECTFIFO;
+		if (enable)
+			ctl |= B43_DMA32_RXDIRECTFIFO;
+		b43_write32(dev, mmio_base + B43_DMA32_RXCTL, ctl);
+	}
+}
+
+/* Enable/Disable Direct FIFO Receive Mode (PIO) on a RX engine.
+ * This is called from PIO code, so DMA structures are not available. */
+void b43_dma_direct_fifo_rx(struct b43_wldev *dev,
+			    unsigned int engine_index, bool enable)
+{
+	enum b43_dmatype type;
+	u16 mmio_base;
+
+	type = dma_mask_to_engine_type(supported_dma_mask(dev));
+
+	mmio_base = b43_dmacontroller_base(type, engine_index);
+	direct_fifo_rx(dev, type, mmio_base, enable);
+}
+#endif /* CONFIG_B43_PIO */
Index: wireless-testing/drivers/net/wireless/b43/dma.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/dma.h	2008-03-29 19:52:14.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/dma.h	2008-03-29 19:52:35.000000000 +0100
@@ -288,7 +288,10 @@ int b43_dma_tx(struct b43_wldev *dev,
 	       struct sk_buff *skb, struct ieee80211_tx_control *ctl);
 void b43_dma_handle_txstatus(struct b43_wldev *dev,
 			     const struct b43_txstatus *status);
 
 void b43_dma_rx(struct b43_dmaring *ring);
 
+void b43_dma_direct_fifo_rx(struct b43_wldev *dev,
+			    unsigned int engine_index, bool enable);
+
 #endif /* B43_DMA_H_ */
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-03-29 19:52:35.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-03-29 19:52:35.000000000 +0100
@@ -44,12 +44,13 @@
 
 #include "b43.h"
 #include "main.h"
 #include "debugfs.h"
 #include "phy.h"
 #include "dma.h"
+#include "pio.h"
 #include "sysfs.h"
 #include "xmit.h"
 #include "lo.h"
 #include "pcmcia.h"
 
 MODULE_DESCRIPTION("Broadcom B43 wireless driver");
@@ -1590,14 +1591,18 @@ static void b43_interrupt_tasklet(struct
 	if (reason & B43_IRQ_TXFIFO_FLUSH_OK)
 		;/* TODO */
 	if (reason & B43_IRQ_NOISESAMPLE_OK)
 		handle_irq_noise(dev);
 
 	/* Check the DMA reason registers for received data. */
-	if (dma_reason[0] & B43_DMAIRQ_RX_DONE)
-		b43_dma_rx(dev->dma.rx_ring);
+	if (dma_reason[0] & B43_DMAIRQ_RX_DONE) {
+		if (b43_using_pio_transfers(dev))
+			b43_pio_rx(dev->pio.rx_queue);
+		else
+			b43_dma_rx(dev->dma.rx_ring);
+	}
 	B43_WARN_ON(dma_reason[1] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[2] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[3] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[4] & B43_DMAIRQ_RX_DONE);
 	B43_WARN_ON(dma_reason[5] & B43_DMAIRQ_RX_DONE);
 
@@ -2695,18 +2700,27 @@ static int b43_op_tx(struct ieee80211_hw
 		     struct ieee80211_tx_control *ctl)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
 	int err = -ENODEV;
 
+	if (unlikely(skb->len < 2 + 2 + 6)) {
+		/* Too short, this can't be a valid frame. */
+		return -EINVAL;
+	}
+	B43_WARN_ON(skb_shinfo(skb)->nr_frags);
+
 	if (unlikely(!dev))
 		goto out;
 	if (unlikely(b43_status(dev) < B43_STAT_STARTED))
 		goto out;
-	/* DMA-TX is done without a global lock. */
-	err = b43_dma_tx(dev, skb, ctl);
+	/* TX is done without a global lock. */
+	if (b43_using_pio_transfers(dev))
+		err = b43_pio_tx(dev, skb, ctl);
+	else
+		err = b43_dma_tx(dev, skb, ctl);
 out:
 	if (unlikely(err))
 		return NETDEV_TX_BUSY;
 	return NETDEV_TX_OK;
 }
 
@@ -2894,13 +2908,16 @@ static int b43_op_get_tx_stats(struct ie
 	int err = -ENODEV;
 
 	if (!dev)
 		goto out;
 	spin_lock_irqsave(&wl->irq_lock, flags);
 	if (likely(b43_status(dev) >= B43_STAT_STARTED)) {
-		b43_dma_get_tx_stats(dev, stats);
+		if (b43_using_pio_transfers(dev))
+			b43_pio_get_tx_stats(dev, stats);
+		else
+			b43_dma_get_tx_stats(dev, stats);
 		err = 0;
 	}
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
 out:
 	return err;
 }
@@ -3363,12 +3380,13 @@ static void b43_wireless_core_stop(struc
 	b43_read32(dev, B43_MMIO_GEN_IRQ_MASK);	/* flush */
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
 	b43_synchronize_irq(dev);
 
 	b43_set_status(dev, B43_STAT_INITIALIZED);
 
+	b43_pio_stop(dev);
 	mutex_unlock(&wl->mutex);
 	/* Must unlock as it would otherwise deadlock. No races here.
 	 * Cancel the possibly running self-rearming periodic work. */
 	cancel_delayed_work_sync(&dev->periodic_work);
 	mutex_lock(&wl->mutex);
 
@@ -3680,12 +3698,13 @@ static void b43_wireless_core_exit(struc
 
 	if (!dev->suspend_in_progress) {
 		b43_leds_exit(dev);
 		b43_rng_exit(dev->wl, false);
 	}
 	b43_dma_free(dev);
+	b43_pio_free(dev);
 	b43_chip_exit(dev);
 	b43_radio_turn_off(dev, 1);
 	b43_switch_analog(dev, 0);
 	if (phy->dyn_tssi_tbl)
 		kfree(phy->tssi2dbm);
 	kfree(phy->lo_control);
@@ -3777,13 +3796,19 @@ static int b43_wireless_core_init(struct
 	} else {
 		b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_MINCONT, 0xF);
 	}
 	/* Maximum Contention Window */
 	b43_shm_write16(dev, B43_SHM_SCRATCH, B43_SHM_SC_MAXCONT, 0x3FF);
 
-	err = b43_dma_init(dev);
+	if ((dev->dev->bus->bustype == SSB_BUSTYPE_PCMCIA) || B43_FORCE_PIO) {
+		dev->__using_pio_transfers = 1;
+		err = b43_pio_init(dev);
+	} else {
+		dev->__using_pio_transfers = 0;
+		err = b43_dma_init(dev);
+	}
 	if (err)
 		goto err_chip_exit;
 	b43_qos_init(dev);
 
 //FIXME
 #if 1
Index: wireless-testing/drivers/net/wireless/b43/xmit.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/xmit.c	2008-03-29 19:52:14.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/xmit.c	2008-03-29 19:52:35.000000000 +0100
@@ -27,12 +27,13 @@
 
 */
 
 #include "xmit.h"
 #include "phy.h"
 #include "dma.h"
+#include "pio.h"
 
 
 /* Extract the bitrate index out of a CCK PLCP header. */
 static int b43_plcp_get_bitrate_idx_cck(struct b43_plcp_hdr6 *plcp)
 {
 	switch (plcp->raw[0]) {
@@ -665,43 +666,57 @@ void b43_handle_txstatus(struct b43_wlde
 		if (status->rts_count == 0xF)	//FIXME
 			dev->wl->ieee_stats.dot11RTSFailureCount++;
 		else
 			dev->wl->ieee_stats.dot11RTSSuccessCount++;
 	}
 
-	b43_dma_handle_txstatus(dev, status);
+	if (b43_using_pio_transfers(dev))
+		b43_pio_handle_txstatus(dev, status);
+	else
+		b43_dma_handle_txstatus(dev, status);
 }
 
-/* Handle TX status report as received through DMA/PIO queues */
-void b43_handle_hwtxstatus(struct b43_wldev *dev,
-			   const struct b43_hwtxstatus *hw)
-{
-	struct b43_txstatus status;
-	u8 tmp;
-
-	status.cookie = le16_to_cpu(hw->cookie);
-	status.seq = le16_to_cpu(hw->seq);
-	status.phy_stat = hw->phy_stat;
-	tmp = hw->count;
-	status.frame_count = (tmp >> 4);
-	status.rts_count = (tmp & 0x0F);
-	tmp = hw->flags;
-	status.supp_reason = ((tmp & 0x1C) >> 2);
-	status.pm_indicated = !!(tmp & 0x80);
-	status.intermediate = !!(tmp & 0x40);
-	status.for_ampdu = !!(tmp & 0x20);
-	status.acked = !!(tmp & 0x02);
+/* Fill out the mac80211 TXstatus report based on the b43-specific
+ * txstatus report data. This returns a boolean whether the frame was
+ * successfully transmitted. */
+bool b43_fill_txstatus_report(struct ieee80211_tx_status *report,
+			      const struct b43_txstatus *status)
+{
+	bool frame_success = 1;
 
-	b43_handle_txstatus(dev, &status);
+	if (status->acked) {
+		/* The frame was ACKed. */
+		report->flags |= IEEE80211_TX_STATUS_ACK;
+	} else {
+		/* The frame was not ACKed... */
+		if (!(report->control.flags & IEEE80211_TXCTL_NO_ACK)) {
+			/* ...but we expected an ACK. */
+			frame_success = 0;
+			report->excessive_retries = 1;
+		}
+	}
+	if (status->frame_count == 0) {
+		/* The frame was not transmitted at all. */
+		report->retry_count = 0;
+	} else
+		report->retry_count = status->frame_count - 1;
+
+	return frame_success;
 }
 
 /* Stop any TX operation on the device (suspend the hardware queues) */
 void b43_tx_suspend(struct b43_wldev *dev)
 {
-	b43_dma_tx_suspend(dev);
+	if (b43_using_pio_transfers(dev))
+		b43_pio_tx_suspend(dev);
+	else
+		b43_dma_tx_suspend(dev);
 }
 
 /* Resume any TX operation on the device (resume the hardware queues) */
 void b43_tx_resume(struct b43_wldev *dev)
 {
-	b43_dma_tx_resume(dev);
+	if (b43_using_pio_transfers(dev))
+		b43_pio_tx_resume(dev);
+	else
+		b43_dma_tx_resume(dev);
 }
Index: wireless-testing/drivers/net/wireless/b43/xmit.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/xmit.h	2008-03-29 19:52:14.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/xmit.h	2008-03-29 19:52:35.000000000 +0100
@@ -204,24 +204,12 @@ enum {
 	B43_TXST_SUPP_CHAN,	/* Channel mismatch */
 	B43_TXST_SUPP_LIFE,	/* Lifetime expired */
 	B43_TXST_SUPP_UNDER,	/* Buffer underflow */
 	B43_TXST_SUPP_ABNACK,	/* Afterburner NACK */
 };
 
-/* Transmit Status as received through DMA/PIO on old chips */
-struct b43_hwtxstatus {
-	PAD_BYTES(4);
-	__le16 cookie;
-	u8 flags;
-	u8 count;
-	 PAD_BYTES(2);
-	__le16 seq;
-	u8 phy_stat;
-	 PAD_BYTES(1);
-} __attribute__ ((__packed__));
-
 /* Receive header for v4 firmware. */
 struct b43_rxhdr_fw4 {
 	__le16 frame_len;	/* Frame length */
 	 PAD_BYTES(2);
 	__le16 phy_status0;	/* PHY RX Status 0 */
 	__u8 jssi;		/* PHY RX Status 1: JSSI */
@@ -292,15 +280,14 @@ void b43_generate_plcp_hdr(struct b43_pl
 			   const u16 octets, const u8 bitrate);
 
 void b43_rx(struct b43_wldev *dev, struct sk_buff *skb, const void *_rxhdr);
 
 void b43_handle_txstatus(struct b43_wldev *dev,
 			 const struct b43_txstatus *status);
-
-void b43_handle_hwtxstatus(struct b43_wldev *dev,
-			   const struct b43_hwtxstatus *hw);
+bool b43_fill_txstatus_report(struct ieee80211_tx_status *report,
+			      const struct b43_txstatus *status);
 
 void b43_tx_suspend(struct b43_wldev *dev);
 void b43_tx_resume(struct b43_wldev *dev);
 
 
 /* Helper functions for converting the key-table index from "firmware-format"


From jm at jm10.no-ip.com  Sat Mar 29 21:02:45 2008
From: jm at jm10.no-ip.com (jm at jm10.no-ip.com)
Date: Sat, 29 Mar 2008 21:02:45 +0100
Subject: b43: 1 second "freeze" every 2 minutes - works with bcm43xx
Message-ID: <47EEA065.9090307@jm10.no-ip.com>

Hello,

By "1s freeze", I mean that all packets are dropped for a duration of 1
second. It happens at a period of 121 seconds.

I have an Asus A6Tc-AP014H laptop running Debian/Sid/x86_64.
The wifi card is:
03:03.0 Network controller: Broadcom Corporation BCM4318 [AirForce One
54g] 802.11g Wireless LAN Controller (rev 02)

The bug is in b43 driver. I tried both 2.6.24.X and 2.6.25-rc5 with old
and new v4 firmware.
There is no freeze with bcm43xx and v3 firmware.

At the beginning, I suspected my access point so I filled a bug report
at madwifi.org: http://madwifi.org/ticket/1791
I rewrite the testcase in this email:
 * ap$ nc -u client 2000 < /dev/zero
 * client$ nc -ul 2000 > /dev/null
 * rate: 1Mbps to maximize reliability
 * I read /proc/net/dev (column: Receive/bytes) every 100ms.
I also attach the result to this mail:
 * 1 vert px = 1000 bytes
 * 1 horz px = 100 ms
 * there is a green line every second
 * and a red one every minute
 * ~ 100 ko/s almost all the time

The bug is really annoying because it breaks most media streamings.

Regards,
JM
-------------- next part --------------
A non-text attachment was scrubbed...
Name: testcase-1Mbps.png
Type: image/png
Size: 13626 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080329/a9fb4ae8/attachment.png>

From mb at bu3sch.de  Sat Mar 29 21:49:11 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 29 Mar 2008 21:49:11 +0100
Subject: [PATCH] b43: Add PIO support for PCMCIA devices
In-Reply-To: <200803292101.16696.mb@bu3sch.de>
References: <200803292101.16696.mb@bu3sch.de>
Message-ID: <200803292149.11953.mb@bu3sch.de>

On Saturday 29 March 2008, Michael Buesch wrote:
> +# Data transfers to the device via PIO
> +# This is only needed on PCMCIA devices. All others can do DMA properly.
> +config B43_PIO
> +	bool
> +	depends on B43 && (B43_PCMCIA || B43_FORCE_PIO)
> +	default y
> +
>  config B43_NPHY
>  	bool "Pre IEEE 802.11n support (BROKEN)"
>  	depends on B43 && EXPERIMENTAL

Oh, this generates a tiny fuzz here, as I locally removed the && BROKEN from B43_NPHY.
I guess that's trivial to fix for you and I don't need to rediff without
that local patch applied before. :)

>  	---help---
>  	  Support for the IEEE 802.11n draft.
>  


From Larry.Finger at lwfinger.net  Sat Mar 29 23:58:10 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 29 Mar 2008 17:58:10 -0500
Subject: b43: 1 second "freeze" every 2 minutes - works with bcm43xx
In-Reply-To: <47EEA065.9090307@jm10.no-ip.com>
References: <47EEA065.9090307@jm10.no-ip.com>
Message-ID: <47EEC982.4060602@lwfinger.net>

jm at jm10.no-ip.com wrote:
> Hello,
> 
> By "1s freeze", I mean that all packets are dropped for a duration of 1
> second. It happens at a period of 121 seconds.
> 
> I have an Asus A6Tc-AP014H laptop running Debian/Sid/x86_64.
> The wifi card is:
> 03:03.0 Network controller: Broadcom Corporation BCM4318 [AirForce One
> 54g] 802.11g Wireless LAN Controller (rev 02)
> 
> The bug is in b43 driver. I tried both 2.6.24.X and 2.6.25-rc5 with old
> and new v4 firmware.
> There is no freeze with bcm43xx and v3 firmware.
> 
> At the beginning, I suspected my access point so I filled a bug report
> at madwifi.org: http://madwifi.org/ticket/1791
> I rewrite the testcase in this email:
>  * ap$ nc -u client 2000 < /dev/zero
>  * client$ nc -ul 2000 > /dev/null
>  * rate: 1Mbps to maximize reliability
>  * I read /proc/net/dev (column: Receive/bytes) every 100ms.
> I also attach the result to this mail:
>  * 1 vert px = 1000 bytes
>  * 1 horz px = 100 ms
>  * there is a green line every second
>  * and a red one every minute
>  * ~ 100 ko/s almost all the time
> 
> The bug is really annoying because it breaks most media streamings.

The only thing that happens on a 120-second cycle is the following 
routine from drivers/net/wireless/main.c:

static void b43_periodic_every120sec(struct b43_wldev *dev)
{
         struct b43_phy *phy = &dev->phy;

         if (phy->type != B43_PHYTYPE_G || phy->rev < 2)
                 return;

         b43_mac_suspend(dev);
         b43_lo_g_measure(dev);
         b43_mac_enable(dev);
         if (b43_has_hardware_pctl(phy))
                 b43_lo_g_ctl_mark_all_unused(dev);
}

To test if this routine is the problem, replace it with a simple 
return. If that cures the problem, try commenting out the 
b43_lo_g_measure(dev) and b43_lo_g_ctl_mark_all_unused(dev) lines.

Larry


From mb at bu3sch.de  Sun Mar 30 00:10:50 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 30 Mar 2008 00:10:50 +0100
Subject: [PATCH] ssb: Turn suspend/resume upside down
Message-ID: <200803300010.51166.mb@bu3sch.de>

Turn the SSB bus suspend mechanism upside down.
Instead of deciding by an internal reference count when to suspend/resume,
let the parent bus call us in their suspend/resume routine.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is for 2.6.26


Index: wireless-testing/drivers/ssb/main.c
===================================================================
--- wireless-testing.orig/drivers/ssb/main.c	2008-03-29 20:09:09.000000000 +0100
+++ wireless-testing/drivers/ssb/main.c	2008-03-29 23:52:26.000000000 +0100
@@ -117,93 +117,80 @@ static struct ssb_device *ssb_device_get
 static void ssb_device_put(struct ssb_device *dev)
 {
 	if (dev)
 		put_device(dev->dev);
 }
 
-static int ssb_bus_resume(struct ssb_bus *bus)
-{
-	int err;
-
-	ssb_pci_xtal(bus, SSB_GPIO_XTAL | SSB_GPIO_PLL, 1);
-	err = ssb_pcmcia_init(bus);
-	if (err) {
-		/* No need to disable XTAL, as we don't have one on PCMCIA. */
-		return err;
-	}
-	ssb_chipco_resume(&bus->chipco);
-
-	return 0;
-}
-
 static int ssb_device_resume(struct device *dev)
 {
 	struct ssb_device *ssb_dev = dev_to_ssb_dev(dev);
 	struct ssb_driver *ssb_drv;
-	struct ssb_bus *bus;
 	int err = 0;
 
-	bus = ssb_dev->bus;
-	if (bus->suspend_cnt == bus->nr_devices) {
-		err = ssb_bus_resume(bus);
-		if (err)
-			return err;
-	}
-	bus->suspend_cnt--;
 	if (dev->driver) {
 		ssb_drv = drv_to_ssb_drv(dev->driver);
 		if (ssb_drv && ssb_drv->resume)
 			err = ssb_drv->resume(ssb_dev);
 		if (err)
 			goto out;
 	}
 out:
 	return err;
 }
 
-static void ssb_bus_suspend(struct ssb_bus *bus, pm_message_t state)
-{
-	ssb_chipco_suspend(&bus->chipco, state);
-	ssb_pci_xtal(bus, SSB_GPIO_XTAL | SSB_GPIO_PLL, 0);
-
-	/* Reset HW state information in memory, so that HW is
-	 * completely reinitialized on resume. */
-	bus->mapped_device = NULL;
-#ifdef CONFIG_SSB_DRIVER_PCICORE
-	bus->pcicore.setup_done = 0;
-#endif
-#ifdef CONFIG_SSB_DEBUG
-	bus->powered_up = 0;
-#endif
-}
-
 static int ssb_device_suspend(struct device *dev, pm_message_t state)
 {
 	struct ssb_device *ssb_dev = dev_to_ssb_dev(dev);
 	struct ssb_driver *ssb_drv;
-	struct ssb_bus *bus;
 	int err = 0;
 
 	if (dev->driver) {
 		ssb_drv = drv_to_ssb_drv(dev->driver);
 		if (ssb_drv && ssb_drv->suspend)
 			err = ssb_drv->suspend(ssb_dev, state);
 		if (err)
 			goto out;
 	}
+out:
+	return err;
+}
+
+int ssb_bus_resume(struct ssb_bus *bus)
+{
+	int err;
+
+	/* Reset HW state information in memory, so that HW is
+	 * completely reinitialized. */
+	bus->mapped_device = NULL;
+#ifdef CONFIG_SSB_DRIVER_PCICORE
+	bus->pcicore.setup_done = 0;
+#endif
 
-	bus = ssb_dev->bus;
-	bus->suspend_cnt++;
-	if (bus->suspend_cnt == bus->nr_devices) {
-		/* All devices suspended. Shutdown the bus. */
-		ssb_bus_suspend(bus, state);
+	err = ssb_bus_powerup(bus, 0);
+	if (err)
+		return err;
+	err = ssb_pcmcia_hardware_setup(bus);
+	if (err) {
+		ssb_bus_may_powerdown(bus);
+		return err;
 	}
+	ssb_chipco_resume(&bus->chipco);
+	ssb_bus_may_powerdown(bus);
 
-out:
-	return err;
+	return 0;
+}
+EXPORT_SYMBOL(ssb_bus_resume);
+
+int ssb_bus_suspend(struct ssb_bus *bus)
+{
+	ssb_chipco_suspend(&bus->chipco);
+	ssb_pci_xtal(bus, SSB_GPIO_XTAL | SSB_GPIO_PLL, 0);
+
+	return 0;
 }
+EXPORT_SYMBOL(ssb_bus_suspend);
 
 #ifdef CONFIG_SSB_PCIHOST
 int ssb_devices_freeze(struct ssb_bus *bus)
 {
 	struct ssb_device *dev;
 	struct ssb_driver *drv;
Index: wireless-testing/drivers/ssb/pcmcia.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pcmcia.c	2008-03-29 20:09:09.000000000 +0100
+++ wireless-testing/drivers/ssb/pcmcia.c	2008-03-29 22:37:46.000000000 +0100
@@ -681,12 +681,35 @@ static int ssb_pcmcia_cor_setup(struct s
 		return err;
 	msleep(40);
 
 	return 0;
 }
 
+/* Initialize the PCMCIA hardware. This is called on Init and Resume. */
+int ssb_pcmcia_hardware_setup(struct ssb_bus *bus)
+{
+	int err;
+
+	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
+		return 0;
+
+	/* Switch segment to a known state and sync
+	 * bus->mapped_pcmcia_seg with hardware state. */
+	ssb_pcmcia_switch_segment(bus, 0);
+	/* Init the COR register. */
+	err = ssb_pcmcia_cor_setup(bus, CISREG_COR);
+	if (err)
+		return err;
+	/* Some cards also need this register to get poked. */
+	err = ssb_pcmcia_cor_setup(bus, CISREG_COR + 0x80);
+	if (err)
+		return err;
+
+	return 0;
+}
+
 void ssb_pcmcia_exit(struct ssb_bus *bus)
 {
 	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
 		return;
 
 	device_remove_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
@@ -696,22 +719,13 @@ int ssb_pcmcia_init(struct ssb_bus *bus)
 {
 	int err;
 
 	if (bus->bustype != SSB_BUSTYPE_PCMCIA)
 		return 0;
 
-	/* Switch segment to a known state and sync
-	 * bus->mapped_pcmcia_seg with hardware state. */
-	ssb_pcmcia_switch_segment(bus, 0);
-
-	/* Init the COR register. */
-	err = ssb_pcmcia_cor_setup(bus, CISREG_COR);
-	if (err)
-		goto error;
-	/* Some cards also need this register to get poked. */
-	err = ssb_pcmcia_cor_setup(bus, CISREG_COR + 0x80);
+	err = ssb_pcmcia_hardware_setup(bus);
 	if (err)
 		goto error;
 
 	bus->sprom_size = SSB_PCMCIA_SPROM_SIZE;
 	mutex_init(&bus->sprom_mutex);
 	err = device_create_file(&bus->host_pcmcia->dev, &dev_attr_ssb_sprom);
Index: wireless-testing/drivers/ssb/ssb_private.h
===================================================================
--- wireless-testing.orig/drivers/ssb/ssb_private.h	2008-03-22 17:51:22.000000000 +0100
+++ wireless-testing/drivers/ssb/ssb_private.h	2008-03-29 22:37:20.000000000 +0100
@@ -78,12 +78,13 @@ extern int ssb_pcmcia_switch_core(struct
 extern int ssb_pcmcia_switch_coreidx(struct ssb_bus *bus,
 				     u8 coreidx);
 extern int ssb_pcmcia_switch_segment(struct ssb_bus *bus,
 				     u8 seg);
 extern int ssb_pcmcia_get_invariants(struct ssb_bus *bus,
 				     struct ssb_init_invariants *iv);
+extern int ssb_pcmcia_hardware_setup(struct ssb_bus *bus);
 extern void ssb_pcmcia_exit(struct ssb_bus *bus);
 extern int ssb_pcmcia_init(struct ssb_bus *bus);
 extern const struct ssb_bus_ops ssb_pcmcia_ops;
 #else /* CONFIG_SSB_PCMCIAHOST */
 static inline int ssb_pcmcia_switch_core(struct ssb_bus *bus,
 					 struct ssb_device *dev)
@@ -97,12 +98,16 @@ static inline int ssb_pcmcia_switch_core
 }
 static inline int ssb_pcmcia_switch_segment(struct ssb_bus *bus,
 					    u8 seg)
 {
 	return 0;
 }
+static inline int ssb_pcmcia_hardware_setup(struct ssb_bus *bus)
+{
+	return 0;
+}
 static inline void ssb_pcmcia_exit(struct ssb_bus *bus)
 {
 }
 static inline int ssb_pcmcia_init(struct ssb_bus *bus)
 {
 	return 0;
Index: wireless-testing/drivers/ssb/driver_chipcommon.c
===================================================================
--- wireless-testing.orig/drivers/ssb/driver_chipcommon.c	2008-02-29 11:56:41.000000000 +0100
+++ wireless-testing/drivers/ssb/driver_chipcommon.c	2008-03-29 23:35:29.000000000 +0100
@@ -248,13 +248,13 @@ void ssb_chipcommon_init(struct ssb_chip
 		return; /* We don't have a ChipCommon */
 	chipco_powercontrol_init(cc);
 	ssb_chipco_set_clockmode(cc, SSB_CLKMODE_FAST);
 	calc_fast_powerup_delay(cc);
 }
 
-void ssb_chipco_suspend(struct ssb_chipcommon *cc, pm_message_t state)
+void ssb_chipco_suspend(struct ssb_chipcommon *cc)
 {
 	if (!cc->dev)
 		return;
 	ssb_chipco_set_clockmode(cc, SSB_CLKMODE_SLOW);
 }
 
Index: wireless-testing/drivers/ssb/pcihost_wrapper.c
===================================================================
--- wireless-testing.orig/drivers/ssb/pcihost_wrapper.c	2008-02-15 21:39:59.000000000 +0100
+++ wireless-testing/drivers/ssb/pcihost_wrapper.c	2008-03-29 23:39:48.000000000 +0100
@@ -15,28 +15,38 @@
 #include <linux/ssb/ssb.h>
 
 
 #ifdef CONFIG_PM
 static int ssb_pcihost_suspend(struct pci_dev *dev, pm_message_t state)
 {
+	struct ssb_bus *ssb = pci_get_drvdata(dev);
+	int err;
+
+	err = ssb_bus_suspend(ssb);
+	if (err)
+		return err;
 	pci_save_state(dev);
 	pci_disable_device(dev);
 	pci_set_power_state(dev, pci_choose_state(dev, state));
 
 	return 0;
 }
 
 static int ssb_pcihost_resume(struct pci_dev *dev)
 {
+	struct ssb_bus *ssb = pci_get_drvdata(dev);
 	int err;
 
 	pci_set_power_state(dev, 0);
 	err = pci_enable_device(dev);
 	if (err)
 		return err;
 	pci_restore_state(dev);
+	err = ssb_bus_resume(ssb);
+	if (err)
+		return err;
 
 	return 0;
 }
 #else /* CONFIG_PM */
 # define ssb_pcihost_suspend	NULL
 # define ssb_pcihost_resume	NULL
Index: wireless-testing/include/linux/ssb/ssb.h
===================================================================
--- wireless-testing.orig/include/linux/ssb/ssb.h	2008-03-22 17:51:22.000000000 +0100
+++ wireless-testing/include/linux/ssb/ssb.h	2008-03-29 23:32:37.000000000 +0100
@@ -257,15 +257,12 @@ struct ssb_bus {
 	u8 chip_package;
 
 	/* List of devices (cores) on the backplane. */
 	struct ssb_device devices[SSB_MAX_NR_CORES];
 	u8 nr_devices;
 
-	/* Reference count. Number of suspended devices. */
-	u8 suspend_cnt;
-
 	/* Software ID number for this bus. */
 	unsigned int busnumber;
 
 	/* The ChipCommon device (if available). */
 	struct ssb_chipcommon chipco;
 	/* The PCI-core device (if available). */
@@ -331,12 +328,19 @@ extern int ssb_bus_pcmciabus_register(st
 				      struct pcmcia_device *pcmcia_dev,
 				      unsigned long baseaddr);
 #endif /* CONFIG_SSB_PCMCIAHOST */
 
 extern void ssb_bus_unregister(struct ssb_bus *bus);
 
+/* Suspend a SSB bus.
+ * Call this from the parent bus suspend routine. */
+extern int ssb_bus_suspend(struct ssb_bus *bus);
+/* Resume a SSB bus.
+ * Call this from the parent bus resume routine. */
+extern int ssb_bus_resume(struct ssb_bus *bus);
+
 extern u32 ssb_clockspeed(struct ssb_bus *bus);
 
 /* Is the device enabled in hardware? */
 int ssb_device_is_enabled(struct ssb_device *dev);
 /* Enable a device and pass device-specific SSB_TMSLOW flags.
  * If no device-specific flags are available, use 0. */
Index: wireless-testing/include/linux/ssb/ssb_driver_chipcommon.h
===================================================================
--- wireless-testing.orig/include/linux/ssb/ssb_driver_chipcommon.h	2008-02-29 11:56:43.000000000 +0100
+++ wireless-testing/include/linux/ssb/ssb_driver_chipcommon.h	2008-03-29 23:35:47.000000000 +0100
@@ -364,14 +364,13 @@ static inline bool ssb_chipco_available(
 {
 	return (cc->dev != NULL);
 }
 
 extern void ssb_chipcommon_init(struct ssb_chipcommon *cc);
 
-#include <linux/pm.h>
-extern void ssb_chipco_suspend(struct ssb_chipcommon *cc, pm_message_t state);
+extern void ssb_chipco_suspend(struct ssb_chipcommon *cc);
 extern void ssb_chipco_resume(struct ssb_chipcommon *cc);
 
 extern void ssb_chipco_get_clockcpu(struct ssb_chipcommon *cc,
                                     u32 *plltype, u32 *n, u32 *m);
 extern void ssb_chipco_get_clockcontrol(struct ssb_chipcommon *cc,
 					u32 *plltype, u32 *n, u32 *m);
Index: wireless-testing/drivers/net/wireless/b43/pcmcia.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/pcmcia.c	2008-03-29 20:09:09.000000000 +0100
+++ wireless-testing/drivers/net/wireless/b43/pcmcia.c	2008-03-29 23:40:58.000000000 +0100
@@ -40,20 +40,22 @@ static /*const */ struct pcmcia_device_i
 
 MODULE_DEVICE_TABLE(pcmcia, b43_pcmcia_tbl);
 
 #ifdef CONFIG_PM
 static int b43_pcmcia_suspend(struct pcmcia_device *dev)
 {
-	//TODO
-	return 0;
+	struct ssb_bus *ssb = dev->priv;
+
+	return ssb_bus_suspend(ssb);
 }
 
 static int b43_pcmcia_resume(struct pcmcia_device *dev)
 {
-	//TODO
-	return 0;
+	struct ssb_bus *ssb = dev->priv;
+
+	return ssb_bus_resume(ssb);
 }
 #else /* CONFIG_PM */
 # define b43_pcmcia_suspend		NULL
 # define b43_pcmcia_resume		NULL
 #endif /* CONFIG_PM */
 


From jm at jm10.no-ip.com  Sun Mar 30 17:10:48 2008
From: jm at jm10.no-ip.com (Julien Muchembled)
Date: Sun, 30 Mar 2008 17:10:48 +0200
Subject: b43: 1 second "freeze" every 2 minutes - works with bcm43xx
In-Reply-To: <47EEC982.4060602@lwfinger.net>
References: <47EEA065.9090307@jm10.no-ip.com> <47EEC982.4060602@lwfinger.net>
Message-ID: <47EFAD78.9090909@jm10.no-ip.com>

> The only thing that happens on a 120-second cycle is the following
> routine from drivers/net/wireless/main.c:
> 
> static void b43_periodic_every120sec(struct b43_wldev *dev)
> {
>         struct b43_phy *phy = &dev->phy;
> 
>         if (phy->type != B43_PHYTYPE_G || phy->rev < 2)
>                 return;
> 
>         b43_mac_suspend(dev);
>         b43_lo_g_measure(dev);
>         b43_mac_enable(dev);
>         if (b43_has_hardware_pctl(phy))
>                 b43_lo_g_ctl_mark_all_unused(dev);
> }
> 
> To test if this routine is the problem, replace it with a simple return.
> If that cures the problem, try commenting out the b43_lo_g_measure(dev)
> and b43_lo_g_ctl_mark_all_unused(dev) lines.

There is no more freeze with a simple return, or if I comment
b43_lo_g_measure(dev)
Commenting b43_lo_g_ctl_mark_all_unused(dev) doesn't change anything.

Oh I see a b43_periodic_every60sec below.
That could explain the small loss of packets we can see every minute on
the graph.

JM


From mb at bu3sch.de  Sun Mar 30 17:17:18 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 30 Mar 2008 17:17:18 +0200
Subject: b43: 1 second "freeze" every 2 minutes - works with bcm43xx
In-Reply-To: <47EFAD78.9090909@jm10.no-ip.com>
References: <47EEA065.9090307@jm10.no-ip.com> <47EEC982.4060602@lwfinger.net>
	<47EFAD78.9090909@jm10.no-ip.com>
Message-ID: <200803301717.18537.mb@bu3sch.de>

On Sunday 30 March 2008 17:10:48 Julien Muchembled wrote:
> > The only thing that happens on a 120-second cycle is the following
> > routine from drivers/net/wireless/main.c:
> > 
> > static void b43_periodic_every120sec(struct b43_wldev *dev)
> > {
> >         struct b43_phy *phy = &dev->phy;
> > 
> >         if (phy->type != B43_PHYTYPE_G || phy->rev < 2)
> >                 return;
> > 
> >         b43_mac_suspend(dev);
> >         b43_lo_g_measure(dev);
> >         b43_mac_enable(dev);
> >         if (b43_has_hardware_pctl(phy))
> >                 b43_lo_g_ctl_mark_all_unused(dev);
> > }
> > 
> > To test if this routine is the problem, replace it with a simple return.
> > If that cures the problem, try commenting out the b43_lo_g_measure(dev)
> > and b43_lo_g_ctl_mark_all_unused(dev) lines.
> 
> There is no more freeze with a simple return, or if I comment
> b43_lo_g_measure(dev)
> Commenting b43_lo_g_ctl_mark_all_unused(dev) doesn't change anything.
> 
> Oh I see a b43_periodic_every60sec below.
> That could explain the small loss of packets we can see every minute on
> the graph.

This is not easily fixable and caused by a fundamental design flaw
of the hardware. We must live with it for now.

-- 
Greetings Michael.


From subodh.shrivastava at gmail.com  Mon Mar 31 15:15:03 2008
From: subodh.shrivastava at gmail.com (Subodh Shrivastava)
Date: Mon, 31 Mar 2008 14:15:03 +0100
Subject: BCM4328 latest GIT driver.
In-Reply-To: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
References: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
Message-ID: <8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>

Hi,

 First of all congratulations for the good work on Broadcom chipset.
 I tried the latest GIT kernel to try out the BCM 4328 chip support.
 I remember reading some where that It loads firmware successfully.
 Please find below the results.

 uname -r = 2.6.25-rc7-custom
 uname -m = x86_64
 uname -v = #2 SMP Mon Mar 31 08:32:18 BST 2008

 Without the NPHY support card failed to initialize.

 [ 2056.792896] b43-phy1: Broadcom 4321 WLAN found
 [ 2056.834017] b43-phy1 ERROR: FOUND UNSUPPORTED PHY (Analog 5, Type
 4, Revision 1)
 [ 2056.834077] b43: probe of ssb0:0 failed with error -95

 In order to compile the driver with NPHY support I had to cheat the
 Kconfig for b43.

 Relevant dmesg:

 [ 4063.609938] ACPI: PCI Interrupt 0000:03:00.0[A] -> GSI 17 (level,
 low) -> IRQ 17
 [ 4063.609974] PCI: Setting latency timer of device 0000:03:00.0 to 64
 [ 4063.676950] ssb: Sonics Silicon Backplane found on PCI device 0000:03:00.0
 [ 4063.834714] b43-phy3: Broadcom 4321 WLAN found
 [ 4063.875625] b43-phy3 debug: Found PHY: Analog 5, Type 4, Revision 1
 [ 4063.875650] b43-phy3 debug: Found Radio: Manuf 0x17F, Version
 0x2055, Revision 4
 [ 4063.901072] phy3: Selected rate control algorithm 'pid'
 [ 4063.902174] Broadcom 43xx driver loaded [ Features: PNLR,
Firmware-ID: FW13 ]
 [ 4063.965038] input: b43-phy3 as /class/input/input25
 [ 4064.253954] b43-phy3: Loading firmware version 410.2160
(2007-05-26 15:32:10)
 [ 4064.365266] b43-phy3 ERROR: IEEE 802.11n devices are not supported, yet.
 [ 4064.365335] b43-phy3 debug: Chip initialized
 [ 4064.365610] b43-phy3 debug: 64-bit DMA initialized
 [ 4064.385619] Registered led device: b43-phy3::tx
 [ 4064.385656] Registered led device: b43-phy3::rx
 [ 4064.385698] Registered led device: b43-phy3::radio
 [ 4064.385794] b43-phy3 debug: Wireless interface started
 [ 4064.385799] b43-phy3 debug: Adding Interface type 2
 [ 4064.389937] ADDRCONF(NETDEV_UP): wlan0: link is not ready
 [ 4064.821593] b43-phy3: Radio hardware status changed to DISABLED
 [ 4121.458866] b43-phy3: Radio turned on by software
 [ 4121.458875] b43-phy3: The hardware RF-kill button still turns the
 radio physically off. Press the button to turn it on.
 [ 4332.013844] b43-phy3 debug: Using hardware based encryption for
 keyidx: 0, mac: ff:ff:ff:ff:ff:ff
 [ 4817.566647] b43-phy3 debug: Disabling hardware based encryption for
 keyidx: 0, mac: ff:ff:ff:ff:ff:ff
 [ 4817.566658] b43-phy3 debug: Removing Interface type 2
 [ 4817.637786] b43-phy3 debug: Wireless interface stopped
 [ 4817.637972] b43-phy3 debug: DMA-64 0x0200 (RX) max used slots: 0/64
 [ 4817.638041] b43-phy3 debug: DMA-64 0x0340 (TX) max used slots: 0/128
 [ 4817.642841] b43-phy3 debug: DMA-64 0x0300 (TX) max used slots: 0/128
 [ 4817.650625] b43-phy3 debug: DMA-64 0x02C0 (TX) max used slots: 0/128
 [ 4817.658629] b43-phy3 debug: DMA-64 0x0280 (TX) max used slots: 0/128
 [ 4817.667508] b43-phy3 debug: DMA-64 0x0240 (TX) max used slots: 2/128
 [ 4817.674592] b43-phy3 debug: DMA-64 0x0200 (TX) max used slots: 0/128
 [ 5131.430565] ACPI: PCI interrupt for device 0000:03:00.0 disabled.

 Card is recognized as "Broadcom 4321 WLAN found"

 Although lspci output states otherwise.

 03:00.0 Network controller: Broadcom Corporation BCM4328 802.11a/b/g/n (rev 01)
        Subsystem: Apple Computer Inc. Unknown device 0087
        Flags: bus master, fast devsel, latency 0, IRQ 17
        Memory at 48200000 (64-bit, non-prefetchable) [size=16K]
        Memory at 48000000 (64-bit, prefetchable) [size=1M]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit+
 Queue=0/0 Enable-
        Capabilities: [d0] Express Endpoint IRQ 0
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel
        Capabilities: [15c] Power Budgeting

 Also when the driver module is loaded Radio is turned off and requests
 to turn on the radio using hardware switch,
 this is an Apple iMac and I don't have any hardware switch to turn on
 the Radio. Does it require some user space utility
 or driver does not contain support for the Radio yet?

 wlan0 shows up in the system after loading the driver.

 wlan0     IEEE 802.11g  ESSID:""
          Mode:Managed  Frequency:2.412 GHz  Access Point: Not-Associated
          Tx-Power=27 dBm
          Retry min limit:7   RTS thr:off   Fragment thr=2352 B
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

 I am aware that support for this chipset is work in progress, I would
 be happy to help in testing.
 --
 Subodh


From netrolller.3d at gmail.com  Mon Mar 31 15:30:16 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 31 Mar 2008 15:30:16 +0200
Subject: Fwd: BCM4328 latest GIT driver.
In-Reply-To: <69e28c910803310627w6d522e4r625f126ac3a3b950@mail.gmail.com>
References: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
	<8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>
	<69e28c910803310627w6d522e4r625f126ac3a3b950@mail.gmail.com>
Message-ID: <69e28c910803310630j296e5e54w8f1c267b86ace2a1@mail.gmail.com>

Oops. Forgot to CC the list.

---------- Forwarded message ----------
From: Stefanik G?bor <netrolller.3d at gmail.com>
Date: Mon, Mar 31, 2008 at 3:27 PM
Subject: Re: BCM4328 latest GIT driver.
To: Subodh Shrivastava <subodh.shrivastava at gmail.com>


Try compiling without RF killswitch support, if that is possible. That might
help, although you will most likely encounter another issue. (NPHY is marked
BROKEN on purpose.) Note however that it's possible that the error message
is actually false (your radio is in fact ON and working), so you should test
if you can scan or associate. (If you manage to associate, or at least scan,
then maybe it's time to take out &&BROKEN from NPHY's Kconfig, as the code
has at least some use.)


On Mon, Mar 31, 2008 at 3:15 PM, Subodh Shrivastava <
subodh.shrivastava at gmail.com> wrote:

> Hi,
>
>  First of all congratulations for the good work on Broadcom chipset.
>  I tried the latest GIT kernel to try out the BCM 4328 chip support.
>  I remember reading some where that It loads firmware successfully.
>  Please find below the results.
>
>  uname -r = 2.6.25-rc7-custom
>  uname -m = x86_64
>  uname -v = #2 SMP Mon Mar 31 08:32:18 BST 2008
>
>  Without the NPHY support card failed to initialize.
>
>  [ 2056.792896] b43-phy1: Broadcom 4321 WLAN found
>  [ 2056.834017] b43-phy1 ERROR: FOUND UNSUPPORTED PHY (Analog 5, Type
>  4, Revision 1)
>  [ 2056.834077] b43: probe of ssb0:0 failed with error -95
>
>  In order to compile the driver with NPHY support I had to cheat the
>  Kconfig for b43.
>
>  Relevant dmesg:
>
>  [ 4063.609938] ACPI: PCI Interrupt 0000:03:00.0[A] -> GSI 17 (level,
>  low) -> IRQ 17
>  [ 4063.609974] PCI: Setting latency timer of device 0000:03:00.0 to 64
>  [ 4063.676950] ssb: Sonics Silicon Backplane found on PCI device
> 0000:03:00.0
>  [ 4063.834714] b43-phy3: Broadcom 4321 WLAN found
>  [ 4063.875625] b43-phy3 debug: Found PHY: Analog 5, Type 4, Revision 1
>  [ 4063.875650] b43-phy3 debug: Found Radio: Manuf 0x17F, Version
>  0x2055, Revision 4
>  [ 4063.901072] phy3: Selected rate control algorithm 'pid'
>  [ 4063.902174] Broadcom 43xx driver loaded [ Features: PNLR,
> Firmware-ID: FW13 ]
>  [ 4063.965038] input: b43-phy3 as /class/input/input25
>  [ 4064.253954] b43-phy3: Loading firmware version 410.2160
> (2007-05-26 15:32:10)
>  [ 4064.365266] b43-phy3 ERROR: IEEE 802.11n devices are not supported,
> yet.
>  [ 4064.365335] b43-phy3 debug: Chip initialized
>  [ 4064.365610] b43-phy3 debug: 64-bit DMA initialized
>  [ 4064.385619] Registered led device: b43-phy3::tx
>  [ 4064.385656] Registered led device: b43-phy3::rx
>  [ 4064.385698] Registered led device: b43-phy3::radio
>  [ 4064.385794] b43-phy3 debug: Wireless interface started
>  [ 4064.385799] b43-phy3 debug: Adding Interface type 2
>  [ 4064.389937] ADDRCONF(NETDEV_UP): wlan0: link is not ready
>  [ 4064.821593] b43-phy3: Radio hardware status changed to DISABLED
>  [ 4121.458866] b43-phy3: Radio turned on by software
>  [ 4121.458875] b43-phy3: The hardware RF-kill button still turns the
>  radio physically off. Press the button to turn it on.
>  [ 4332.013844] b43-phy3 debug: Using hardware based encryption for
>  keyidx: 0, mac: ff:ff:ff:ff:ff:ff
>  [ 4817.566647] b43-phy3 debug: Disabling hardware based encryption for
>  keyidx: 0, mac: ff:ff:ff:ff:ff:ff
>  [ 4817.566658] b43-phy3 debug: Removing Interface type 2
>  [ 4817.637786] b43-phy3 debug: Wireless interface stopped
>  [ 4817.637972] b43-phy3 debug: DMA-64 0x0200 (RX) max used slots: 0/64
>  [ 4817.638041] b43-phy3 debug: DMA-64 0x0340 (TX) max used slots: 0/128
>  [ 4817.642841] b43-phy3 debug: DMA-64 0x0300 (TX) max used slots: 0/128
>  [ 4817.650625] b43-phy3 debug: DMA-64 0x02C0 (TX) max used slots: 0/128
>  [ 4817.658629] b43-phy3 debug: DMA-64 0x0280 (TX) max used slots: 0/128
>  [ 4817.667508] b43-phy3 debug: DMA-64 0x0240 (TX) max used slots: 2/128
>  [ 4817.674592] b43-phy3 debug: DMA-64 0x0200 (TX) max used slots: 0/128
>  [ 5131.430565] ACPI: PCI interrupt for device 0000:03:00.0 disabled.
>
>  Card is recognized as "Broadcom 4321 WLAN found"
>
>  Although lspci output states otherwise.
>
>  03:00.0 Network controller: Broadcom Corporation BCM4328 802.11a/b/g/n
> (rev 01)
>        Subsystem: Apple Computer Inc. Unknown device 0087
>        Flags: bus master, fast devsel, latency 0, IRQ 17
>        Memory at 48200000 (64-bit, non-prefetchable) [size=16K]
>        Memory at 48000000 (64-bit, prefetchable) [size=1M]
>        Capabilities: [40] Power Management version 2
>        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit+
>  Queue=0/0 Enable-
>        Capabilities: [d0] Express Endpoint IRQ 0
>        Capabilities: [100] Advanced Error Reporting
>        Capabilities: [13c] Virtual Channel
>        Capabilities: [15c] Power Budgeting
>
>  Also when the driver module is loaded Radio is turned off and requests
>  to turn on the radio using hardware switch,
>  this is an Apple iMac and I don't have any hardware switch to turn on
>  the Radio. Does it require some user space utility
>  or driver does not contain support for the Radio yet?
>
>  wlan0 shows up in the system after loading the driver.
>
>  wlan0     IEEE 802.11g  ESSID:""
>          Mode:Managed  Frequency:2.412 GHz  Access Point: Not-Associated
>          Tx-Power=27 dBm
>          Retry min limit:7   RTS thr:off   Fragment thr=2352 B
>          Link Quality:0  Signal level:0  Noise level:0
>          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
>  I am aware that support for this chipset is work in progress, I would
>  be happy to help in testing.
>  --
>  Subodh
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080331/2addcbc4/attachment.html>

From mb at bu3sch.de  Mon Mar 31 16:09:15 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 31 Mar 2008 16:09:15 +0200
Subject: BCM4328 latest GIT driver.
In-Reply-To: <8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>
References: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
	<8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>
Message-ID: <200803311609.15660.mb@bu3sch.de>

On Monday 31 March 2008 15:15:03 Subodh Shrivastava wrote:
>  [ 2056.834017] b43-phy1 ERROR: FOUND UNSUPPORTED PHY (Analog 5, Type
>  4, Revision 1)

>  I am aware that support for this chipset is work in progress, I would
>  be happy to help in testing.

Help in reverse engineering is needed ;)

-- 
Greetings Michael.


From netrolller.3d at gmail.com  Mon Mar 31 17:39:09 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 31 Mar 2008 17:39:09 +0200
Subject: Urgent help needed: Broadcom 4318 SPROM corruption
Message-ID: <69e28c910803310839m5a5582f5qb973ad4e402b6ecb@mail.gmail.com>

I have a weird problem with my 4318: its SPROM got corrupted (power
outage, whatever, I don't know, as I haven't messed with it), and now
it appears in my LSPCI output as a "Broadcom 4218" (device ID changed
to 0x4218 from 0x4318). I can't even flash my SPROM back to the right
values, because the SSB driver doesn't pick up my card, and thus no
"ssb_sprom" file appears. My question is: what do I have to modify in
the kernel to make SSB threat my "BCM4218" as a proper BCM4318, or at
least to pick it up to the point where ssb_sprom shows up and I can
flash it back to the proper BCM4318?

Thanks in advance,
G?bor


From proski at gnu.org  Mon Mar 31 18:53:37 2008
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 31 Mar 2008 12:53:37 -0400
Subject: Urgent help needed: Broadcom 4318 SPROM corruption
In-Reply-To: <69e28c910803310839m5a5582f5qb973ad4e402b6ecb@mail.gmail.com>
References: <69e28c910803310839m5a5582f5qb973ad4e402b6ecb@mail.gmail.com>
Message-ID: <1206982417.4380.7.camel@dv>

On Mon, 2008-03-31 at 17:39 +0200, Stefanik G?bor wrote:
> I have a weird problem with my 4318: its SPROM got corrupted (power
> outage, whatever, I don't know, as I haven't messed with it), and now
> it appears in my LSPCI output as a "Broadcom 4218" (device ID changed
> to 0x4218 from 0x4318). I can't even flash my SPROM back to the right
> values, because the SSB driver doesn't pick up my card, and thus no
> "ssb_sprom" file appears. My question is: what do I have to modify in
> the kernel to make SSB threat my "BCM4218" as a proper BCM4318, or at
> least to pick it up to the point where ssb_sprom shows up and I can
> flash it back to the proper BCM4318?

Look for 4318 in drivers/ssb/b43_pci_bridge.c and add a similar value
for 4218.

-- 
Regards,
Pavel Roskin


From proski at gnu.org  Mon Mar 31 19:24:02 2008
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 31 Mar 2008 13:24:02 -0400
Subject: BCM4328 latest GIT driver.
In-Reply-To: <200803311609.15660.mb@bu3sch.de>
References: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
	<8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>
	<200803311609.15660.mb@bu3sch.de>
Message-ID: <1206984242.4380.13.camel@dv>

On Mon, 2008-03-31 at 16:09 +0200, Michael Buesch wrote:
> On Monday 31 March 2008 15:15:03 Subodh Shrivastava wrote:
> >  [ 2056.834017] b43-phy1 ERROR: FOUND UNSUPPORTED PHY (Analog 5, Type
> >  4, Revision 1)
> 
> >  I am aware that support for this chipset is work in progress, I would
> >  be happy to help in testing.
> 
> Help in reverse engineering is needed ;)

I prefer to stay on the software part of things, but I have a BCM4328 in
my laptop.  I just ordered an Intel card (iwl4965), so once I get it, I
can offer that BCM4328 for free (plus free shipping and handling :)) to
whoever is going to reverse engineer it.

Last time I did it with an Atheros card, and the result exceeded all my
expectations - we have functional ath5k now :)

-- 
Regards,
Pavel Roskin


From subodh.shrivastava at gmail.com  Mon Mar 31 19:33:14 2008
From: subodh.shrivastava at gmail.com (Subodh Shrivastava)
Date: Mon, 31 Mar 2008 18:33:14 +0100
Subject: BCM4328 latest GIT driver.
In-Reply-To: <200803311609.15660.mb@bu3sch.de>
References: <8b12046a0803310555h56a0447k8881eae380812ed1@mail.gmail.com>
	<8b12046a0803310615y2c2ff8e4p45f501e4d51e468e@mail.gmail.com>
	<200803311609.15660.mb@bu3sch.de>
Message-ID: <8b12046a0803311033w5c85b8a3y2eb7274525999917@mail.gmail.com>

On Mon, Mar 31, 2008 at 3:09 PM, Michael Buesch <mb at bu3sch.de> wrote:
> On Monday 31 March 2008 15:15:03 Subodh Shrivastava wrote:
>  >  [ 2056.834017] b43-phy1 ERROR: FOUND UNSUPPORTED PHY (Analog 5, Type
>  >  4, Revision 1)
>
>
> >  I am aware that support for this chipset is work in progress, I would
>  >  be happy to help in testing.
>
>  Help in reverse engineering is needed ;)

If I could I would. Anyway disabling the rfkill support also did not work.
Driver was loaded successfully and no rfkill messages disabling the radio,
wlan0 card showed up in the system, I was able to setup the WEP key
and  ESSID. No association though which would indicate that radio support
is not yet there in the driver.

>
>  --
>  Greetings Michael.
>



-- 
Subodh


From netrolller.3d at gmail.com  Mon Mar 31 22:22:54 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 31 Mar 2008 22:22:54 +0200
Subject: Urgent help needed: Broadcom 4318 SPROM corruption
In-Reply-To: <1206982417.4380.7.camel@dv>
References: <69e28c910803310839m5a5582f5qb973ad4e402b6ecb@mail.gmail.com>
	<1206982417.4380.7.camel@dv>
Message-ID: <69e28c910803311322m6da8d4f6se15668fbcb0ad4d@mail.gmail.com>

Thanks, now I got the ssb_sprom file in place, but it's completely
corrupt (0120FFFFFFFF...FFFFFFFFFFFF until the end, ssb-sprom says CRC
error, if I run it with --force -P, I get FFFF for all values). Could
someone upload an SPROM dump for his card (preferably a 4318 or
possibly a 4311)? Because I didn't have an SPROM backup.

On 3/31/08, Pavel Roskin <proski at gnu.org> wrote:
> On Mon, 2008-03-31 at 17:39 +0200, Stefanik G?bor wrote:
> > I have a weird problem with my 4318: its SPROM got corrupted (power
> > outage, whatever, I don't know, as I haven't messed with it), and now
> > it appears in my LSPCI output as a "Broadcom 4218" (device ID changed
> > to 0x4218 from 0x4318). I can't even flash my SPROM back to the right
> > values, because the SSB driver doesn't pick up my card, and thus no
> > "ssb_sprom" file appears. My question is: what do I have to modify in
> > the kernel to make SSB threat my "BCM4218" as a proper BCM4318, or at
> > least to pick it up to the point where ssb_sprom shows up and I can
> > flash it back to the proper BCM4318?
>
> Look for 4318 in drivers/ssb/b43_pci_bridge.c and add a similar value
> for 4218.
>
> --
> Regards,
> Pavel Roskin
>


-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


