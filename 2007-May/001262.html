<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [PATCH 1/3] fix A/G PHYs setup and init
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/bcm43xx-dev/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:bcm43xx-dev%40lists.berlios.de?Subject=Re%3A%20%5BPATCH%201/3%5D%20fix%20A/G%20PHYs%20setup%20and%20init&In-Reply-To=%3C464A760B.1090907%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001261.html">
   <LINK REL="Next"  HREF="001263.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[PATCH 1/3] fix A/G PHYs setup and init</H1>
    <B>Jory A. Pratt</B> 
    <A HREF="mailto:bcm43xx-dev%40lists.berlios.de?Subject=Re%3A%20%5BPATCH%201/3%5D%20fix%20A/G%20PHYs%20setup%20and%20init&In-Reply-To=%3C464A760B.1090907%40gmail.com%3E"
       TITLE="[PATCH 1/3] fix A/G PHYs setup and init">geekypenguin at gmail.com
       </A><BR>
    <I>Wed May 16 05:10:03 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001261.html">[PATCH 1/3] fix A/G PHYs setup and init
</A></li>
        <LI>Next message: <A HREF="001263.html">[PATCH 1/3] fix A/G PHYs setup and init
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1262">[ date ]</a>
              <a href="thread.html#1262">[ thread ]</a>
              <a href="subject.html#1262">[ subject ]</a>
              <a href="author.html#1262">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/12/07, *Michael Buesch* &lt; <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mb at bu3sch.de</A> &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mb at bu3sch.de</A>&gt;&gt; wrote:
&gt;<i>
</I>&gt;<i>         On Saturday 12 May 2007 01:07:01 Michael Buesch wrote:
</I>&gt;<i>         &gt; On Friday 11 May 2007 12:24:33 Michael Buesch wrote:
</I>&gt;<i>         &gt; &gt; On Monday 23 April 2007 20:30:41 Stefano Brivio wrote:
</I>&gt;<i>         &gt; &gt; &gt; This patch fixes A/G PHYs setup and initialization
</I>&gt;<i>         routines. Let's move
</I>&gt;<i>         &gt; &gt; &gt; the so-called workarounds in a separate file, in order
</I>&gt;<i>         to avoid clobbering
</I>&gt;<i>         &gt; &gt; &gt; bcm43xx_phy.c.
</I>&gt;<i>
</I>&gt;<i>         Here's latest version of the patch.
</I>&gt;<i>         Yet another few bugs fixed.
</I>&gt;<i>
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.c
</I>&gt;<i>         ===================================================================
</I>&gt;<i>
</I>&gt;<i>         --- /dev/null   1970-01-01 00:00:00.000000000 +0000
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.c      2007-05-12
</I>&gt;<i>         16:29:05.000000000 +0200
</I>&gt;<i>         @@ -0,0 +1,668 @@
</I>&gt;<i>         +/*
</I>&gt;<i>         +
</I>&gt;<i>         +  Broadcom BCM43xx wireless driver
</I>&gt;<i>         +
</I>&gt;<i>         +  PHY workarounds.
</I>&gt;<i>         +
</I>&gt;<i>         +  Copyright (c) 2005 Martin Langer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">martin-langer at gmx.de</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">martin-langer at gmx.de</A>&gt;&gt;,
</I>&gt;<i>         +  Copyright (c) 2005-2007 Stefano Brivio &lt; <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">st3 at riseup.net</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">st3 at riseup.net</A>&gt;&gt;
</I>&gt;<i>         +  Copyright (c) 2005-2007 Michael Buesch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mbuesch at freenet.de</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mbuesch at freenet.de</A>&gt;&gt;
</I>&gt;<i>         +  Copyright (c) 2005, 2006 Danny van Dyk &lt;
</I>&gt;<i>         <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">kugelfang at gentoo.org</A> &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">kugelfang at gentoo.org</A>&gt;&gt;
</I>&gt;<i>         +  Copyright (c) 2005, 2006 Andreas Jaggi
</I>&gt;<i>         &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">andreas.jaggi at waterwave.ch</A> &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">andreas.jaggi at waterwave.ch</A>&gt; &gt;
</I>&gt;<i>         +
</I>&gt;<i>         +  This program is free software; you can redistribute it
</I>&gt;<i>         and/or modify
</I>&gt;<i>         +  it under the terms of the GNU General Public License as
</I>&gt;<i>         published by
</I>&gt;<i>         +  the Free Software Foundation; either version 2 of the
</I>&gt;<i>         License, or
</I>&gt;<i>         +  (at your option) any later version.
</I>&gt;<i>         +
</I>&gt;<i>         +  This program is distributed in the hope that it will be
</I>&gt;<i>         useful,
</I>&gt;<i>         +  but WITHOUT ANY WARRANTY; without even the implied warranty of
</I>&gt;<i>         +  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</I>&gt;<i>         +  GNU General Public License for more details.
</I>&gt;<i>         +
</I>&gt;<i>         +  You should have received a copy of the GNU General Public
</I>&gt;<i>         License
</I>&gt;<i>         +  along with this program; see the file COPYING.  If not,
</I>&gt;<i>         write to
</I>&gt;<i>         +  the Free Software Foundation, Inc., 51 Franklin Steet,
</I>&gt;<i>         Fifth Floor,
</I>&gt;<i>         +  Boston, MA 02110-1301, USA.
</I>&gt;<i>         +
</I>&gt;<i>         +*/
</I>&gt;<i>         +
</I>&gt;<i>         +#include &quot;bcm43xx.h &quot;
</I>&gt;<i>         +#include &quot;bcm43xx_main.h&quot;
</I>&gt;<i>         +#include &quot;bcm43xx_tables.h&quot;
</I>&gt;<i>         +#include &quot;bcm43xx_phy.h&quot;
</I>&gt;<i>         +#include &quot;bcm43xx_wa.h&quot;
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_papd(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       u16 backup;
</I>&gt;<i>         +
</I>&gt;<i>         +       backup = bcm43xx_ofdmtab_read16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_PWRDYN2, 0);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_PWRDYN2,
</I>&gt;<i>         0, 7);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_APHY, 0, 0);
</I>&gt;<i>         +       bcm43xx_dummy_transmission(dev);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_PWRDYN2,
</I>&gt;<i>         0, backup);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_auxclipthr(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8E), 0x3800);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_afcdac(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x0035, 0x03FF);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x0036, 0x0400);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_txdc_offset(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DC, 0,
</I>&gt;<i>         0x0051);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +void bcm43xx_wa_initgains(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_LNAHPFCTL, 0x1FF9);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_LPFGAINCTL,
</I>&gt;<i>         +               bcm43xx_phy_read(dev, BCM43xx_PHY_LPFGAINCTL)
</I>&gt;<i>         &amp; 0xFF0F);
</I>&gt;<i>         +       if (phy-&gt;rev &lt;= 2)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_LPFGAIN, 0, 0x1FBF);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0002, 0x1FBF);
</I>&gt;<i>         +
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x0024, 0x4680);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x0020, 0x0003);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x001D, 0x0F40);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x001F, 0x1C00);
</I>&gt;<i>         +       if (phy-&gt;rev &lt;= 3)
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x002A,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev, 0x002A) &amp;
</I>&gt;<i>         0x00FF) | 0x0400);
</I>&gt;<i>         +       else if (phy-&gt;rev == 5) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x002A,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev, 0x002A) &amp;
</I>&gt;<i>         0x00FF) | 0x1A00);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x00CC, 0x2121);
</I>&gt;<i>         +       }
</I>&gt;<i>         +       if (phy-&gt;rev &gt;= 3)
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x00BA, 0x3ED5);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_divider(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x002B, bcm43xx_phy_read(dev,
</I>&gt;<i>         0x002B) &amp; ~0x0100);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x008E, 0x58C1);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_gt(struct bcm43xx_wldev *dev) /* Gain
</I>&gt;<i>         table. */
</I>&gt;<i>         +{
</I>&gt;<i>         +       if (dev-&gt;phy.rev &lt;= 2) {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN2, 0, 15);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN2, 1, 31);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN2, 2, 42);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN2, 3, 48);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN2, 4, 58);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 0, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 1, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 2, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 3, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 4, 21);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 5, 21);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 6, 25);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN1, 0, 3);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN1, 1, 3);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN1, 2, 7);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 0, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 1, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 2, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 3, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 4, 21);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 5, 21);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAIN0, 6, 25);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_rssi_lt(struct bcm43xx_wldev *dev) /*
</I>&gt;<i>         RSSI lookup table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       for (i = 0; i &lt; 8; i++)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_RSSI, i, i + 8);
</I>&gt;<i>         +       for (i = 8; i &lt; 16; i++)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_RSSI, i, i - 8);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_analog(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;analog &gt; 2) {
</I>&gt;<i>         +               if (phy-&gt;type == BCM43xx_PHYTYPE_A)
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_PWRDOWN, 0x1808);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_PWRDOWN, 0x1000);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 3, 0x1044);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 4, 0x7201);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 6, 0x0040);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_dac(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       if (dev-&gt;phy.analog == 1)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 1,
</I>&gt;<i>         +                       (bcm43xx_ofdmtab_read16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 1) &amp; ~0x0034) | 0x0008);
</I>&gt;<i>         +       else
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 1,
</I>&gt;<i>         +                       (bcm43xx_ofdmtab_read16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 1) &amp; ~0x0078) | 0x0010);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_fft(struct bcm43xx_wldev *dev) /* Fine
</I>&gt;<i>         frequency table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (dev-&gt;phy.type == BCM43xx_PHYTYPE_A)
</I>&gt;<i>         +               for (i = 0; i &lt; BCM43xx_TAB_FINEFREQA_SIZE; i++)
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DACRFPABB, i, bcm43xx_tab_finefreqa[i]);
</I>&gt;<i>         +       else
</I>&gt;<i>         +               for (i = 0; i &lt; BCM43xx_TAB_FINEFREQG_SIZE; i++)
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DACRFPABB, i, bcm43xx_tab_finefreqg[i]);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_nft(struct bcm43xx_wldev *dev) /*
</I>&gt;<i>         Noise figure table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         +               if (phy-&gt;rev == 2)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISEA2_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noisea2[i]);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISEA3_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noisea3[i]);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               if (phy-&gt;rev == 1)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISEG1_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noiseg1[i]);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISEG2_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noiseg2[i]);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_rt(struct bcm43xx_wldev *dev) /* Rotor
</I>&gt;<i>         table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       for (i = 0; i &lt; BCM43xx_TAB_ROTOR_SIZE; i++)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write32(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_ROTOR, i, bcm43xx_tab_rotor[i]);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_nst(struct bcm43xx_wldev *dev) /*
</I>&gt;<i>         Noise scale table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         +               if (phy-&gt;rev &lt;= 1)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                                       i, 0);
</I>&gt;<i>         +               else if (phy-&gt;rev == 2)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                                       i,
</I>&gt;<i>         bcm43xx_tab_noisescalea2[i]);
</I>&gt;<i>         +               else if (phy-&gt;rev == 3)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                                       i,
</I>&gt;<i>         bcm43xx_tab_noisescalea3[i]);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                                       i,
</I>&gt;<i>         bcm43xx_tab_noisescaleg3[i]);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         +                       if (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ENCORE) &amp; BCM43xx_PHY_ENCORE_EN)
</I>&gt;<i>         +                               for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                                      
</I>&gt;<i>         bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                               i,
</I>&gt;<i>         bcm43xx_tab_noisescaleg3[i]);
</I>&gt;<i>         +                       else
</I>&gt;<i>         +                               for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                                      
</I>&gt;<i>         bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                               i,
</I>&gt;<i>         bcm43xx_tab_noisescaleg2[i]);
</I>&gt;<i>         +               } else {
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_NOISESCALE_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_NOISESCALE,
</I>&gt;<i>         +                                                       i,
</I>&gt;<i>         bcm43xx_tab_noisescaleg1[i]);
</I>&gt;<i>         +               }
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_art(struct bcm43xx_wldev *dev) /* ADV
</I>&gt;<i>         retard table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       for (i = 0; i &lt; BCM43xx_TAB_RETARD_SIZE; i++)
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write32(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_ADVRETARD,
</I>&gt;<i>         +                               i, bcm43xx_tab_retard[i]);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_txlna_gain(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DC, 13,
</I>&gt;<i>         0x0000);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_crs_reset(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x002C, 0x0064);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_2060txlna_gain(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_hf_write(dev, bcm43xx_hf_read(dev) |
</I>&gt;<i>         +                        BCM43xx_HF_2060W);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_lms(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, 0x0055,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, 0x0055) &amp; 0xFFC0) |
</I>&gt;<i>         0x0004);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_mixedsignal(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 1, 3);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_msst(struct bcm43xx_wldev *dev) /* Min
</I>&gt;<i>         sigma square table */
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +       const u16 *tab;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         +               tab = bcm43xx_tab_sigmasqr1;
</I>&gt;<i>         +       } else if (phy-&gt;type == BCM43xx_PHYTYPE_G) {
</I>&gt;<i>         +               tab = bcm43xx_tab_sigmasqr2;
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               assert(0);
</I>&gt;<i>         +               return;
</I>&gt;<i>         +       }
</I>&gt;<i>         +
</I>&gt;<i>         +       for (i = 0; i &lt; BCM43xx_TAB_SIGMASQR_SIZE; i++) {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_MINSIGSQ,
</I>&gt;<i>         +                                       i, tab[i]);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_iqadc(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       if (dev-&gt;phy.analog == 4)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 0,
</I>&gt;<i>         +                       bcm43xx_ofdmtab_read16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DAC, 0) &amp; ~0xF000);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_crs_ed(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;rev == 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES1,
</I>&gt;<i>         0x4F19);
</I>&gt;<i>         +       } else if (phy-&gt;rev == 2) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_CRSTHRES1_R1, 0x1861);
</I>&gt;<i>         +               bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_CRSTHRES2_R1, 0x1861);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_ANTDWELL,
</I>&gt;<i>         +                                 bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ANTDWELL)
</I>&gt;<i>         +                                 | 0x0800);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_CRSTHRES1_R1, 0x0098);
</I>&gt;<i>         +               bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_CRSTHRES2_R1, 0x0070);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xC9),
</I>&gt;<i>         0x0080);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_ANTDWELL,
</I>&gt;<i>         +                                 bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ANTDWELL)
</I>&gt;<i>         +                                 | 0x0800);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_crs_thr(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_CRS0) &amp; ~0x03C0) | 0xD000);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_crs_blank(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x2C), 0x005A);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_cck_shiftbits(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_CCKSHIFTBITS, 0x0026);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_wrssi_offset(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       int i;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (dev-&gt;phy.rev == 1) {
</I>&gt;<i>         +               for (i = 0; i &lt; 16; i++) {
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_WRSSI_R1,
</I>&gt;<i>         +                                               i, 0x0020);
</I>&gt;<i>         +               }
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               for (i = 0; i &lt; 32; i++) {
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_WRSSI,
</I>&gt;<i>         +                                               i, 0x0820);
</I>&gt;<i>         +               }
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_txpuoff_rxpuon(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_0F, 2, 15);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_0F, 3, 20);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_altagc(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;rev == 1) {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1_R1, 0, 254);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1_R1, 1, 13);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1_R1, 2, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1_R1, 3, 25);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, 0, 0x2710);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, 1, 0x9B83);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, 2, 0x9B83);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC2, 3, 0x0F8D);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_LMS, 4);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1, 0, 254);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1, 1, 13);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1, 2, 19);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1, 3, 25);
</I>&gt;<i>         +       }
</I>&gt;<i>         +
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_CCKSHIFTBITS_WA,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_CCKSHIFTBITS_WA) &amp; ~0xFF00) | 0x5700);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1A),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1A))
</I>&gt;<i>         &amp; ~0x007F) | 0x000F);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1A),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1A))
</I>&gt;<i>         &amp; ~0x3F80) | 0x2B80);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_ANTWRSETT,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_ANTWRSETT)
</I>&gt;<i>         &amp; 0xF0FF) | 0x0300);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x7A,
</I>&gt;<i>         +               bcm43xx_radio_read16(dev, 0x7A) | 0x0008);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_N1P1GAIN,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_N1P1GAIN) &amp;
</I>&gt;<i>         ~0x000F) | 0x0008);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_P1P2GAIN,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_P1P2GAIN) &amp;
</I>&gt;<i>         ~0x0F00) | 0x0600);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_N1N2GAIN,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_N1N2GAIN) &amp;
</I>&gt;<i>         ~0x0F00) | 0x0700);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_N1P1GAIN,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_N1P1GAIN) &amp;
</I>&gt;<i>         ~0x0F00) | 0x0100);
</I>&gt;<i>         +       if (phy-&gt;rev == 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_N1N2GAIN,
</I>&gt;<i>         +                                 (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_N1N2GAIN)
</I>&gt;<i>         +                                  &amp; ~0x000F) | 0x0007);
</I>&gt;<i>         +       }
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x88),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x88))
</I>&gt;<i>         &amp; ~0x00FF) | 0x001C);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x88),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x88))
</I>&gt;<i>         &amp; ~0x3F00) | 0x0200);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x96),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x96))
</I>&gt;<i>         &amp; ~0x00FF) | 0x001C);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x89),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x89))
</I>&gt;<i>         &amp; ~0x00FF) | 0x0020);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x89),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x89))
</I>&gt;<i>         &amp; ~0x3F00) | 0x0200);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x82),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x82))
</I>&gt;<i>         &amp; ~0x00FF) | 0x002E);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x96),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x96))
</I>&gt;<i>         &amp; ~0xFF00) | 0x1A00);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x81),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x81))
</I>&gt;<i>         &amp; ~0x00FF) | 0x0028);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x81),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x81))
</I>&gt;<i>         &amp; ~0xFF00) | 0x2C00);
</I>&gt;<i>         +       if (phy-&gt;rev == 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_PEAK_COUNT,
</I>&gt;<i>         0x092B);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x1B)) &amp; ~0x001E) | 0x0002);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
</I>&gt;<i>         +                       bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x1B)) &amp; ~0x001E);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1F),
</I>&gt;<i>         0x287A);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_LPFGAINCTL,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_LPFGAINCTL) &amp; ~0x000F) | 0x0004);
</I>&gt;<i>         +               if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x22), 0x287A);
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_LPFGAINCTL,
</I>&gt;<i>         +                               (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_LPFGAINCTL) &amp; ~0xF000) | 0x3000);
</I>&gt;<i>         +               }
</I>&gt;<i>         +       }
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_DIVSRCHIDX,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_DIVSRCHIDX)
</I>&gt;<i>         &amp; 0x7F7F) | 0x7874);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8E), 0x1C00);
</I>&gt;<i>         +       if (phy-&gt;rev == 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_DIVP1P2GAIN,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_DIVP1P2GAIN) &amp; ~0x0F00) | 0x0600);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8B),
</I>&gt;<i>         0x005E);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_ANTWRSETT,
</I>&gt;<i>         +                       (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ANTWRSETT) &amp; ~0x00FF) | 0x001E);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8D),
</I>&gt;<i>         0x0002);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3_R1, 0, 0);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3_R1, 1, 7);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3_R1, 2, 16);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3_R1, 3, 28);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3, 0, 0);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3, 1, 7);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3, 2, 16);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3, 3, 28);
</I>&gt;<i>         +       }
</I>&gt;<i>         +       if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x26),
</I>&gt;<i>         +                       bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x26)) &amp; ~0x0003);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x26),
</I>&gt;<i>         +                       bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x26)) &amp; ~0x1000);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_tr_ltov(struct bcm43xx_wldev *dev) /*
</I>&gt;<i>         TR Lookup Table Original Values */
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_gtab_write(dev, BCM43xx_GTAB_ORIGTR, 0, 0xC480);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_cpll_nonpilot(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_11, 0, 0);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_11, 1, 0);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_rssi_adc(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       if (dev-&gt;phy.analog == 4)
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x00DC, 0x7454);
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_boards_a(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct ssb_bus *bus = dev-&gt;dev-&gt;bus;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (bus-&gt;board_vendor == SSB_BOARDVENDOR_BCM &amp;&amp;
</I>&gt;<i>         +           bus-&gt;board_type == SSB_BOARD_BU4306 &amp;&amp;
</I>&gt;<i>         +           bus-&gt;board_rev &lt; 0x30) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x0010, 0xE000);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x0013, 0x0140);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, 0x0014, 0x0280);
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               if (bus-&gt;board_type == SSB_BOARD_MP4318 &amp;&amp;
</I>&gt;<i>         +                   bus-&gt;board_rev &lt; 0x20) {
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0013, 0x0210);
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0014, 0x0840);
</I>&gt;<i>         +               } else {
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0013, 0x0140);
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0014, 0x0280);
</I>&gt;<i>         +               }
</I>&gt;<i>         +               if (dev-&gt;phy.rev &lt;= 4)
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0010, 0xE000);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0010, 0x2000);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_DC, 1, 0x0039);
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_UNKNOWN_APHY, 7, 0x0040);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +static void bcm43xx_wa_boards_g(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct ssb_bus *bus = dev-&gt;dev-&gt;bus;
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (bus-&gt;board_vendor != SSB_BOARDVENDOR_BCM ||
</I>&gt;<i>         +           bus-&gt;board_type != SSB_BOARD_BU4306 ||
</I>&gt;<i>         +           bus-&gt;board_rev != 0x17) {
</I>&gt;<i>         +               if (phy-&gt;rev &lt; 2) {
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX_R1, 1, 0x0002);
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX_R1, 2, 0x0001);
</I>&gt;<i>         +               } else {
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 1, 0x0002);
</I>&gt;<i>         +                       bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 2, 0x0001);
</I>&gt;<i>         +                       if ((bus-&gt; sprom.r1.boardflags_lo &amp;
</I>&gt;<i>         BCM43xx_BFL_EXTLNA) &amp;&amp;
</I>&gt;<i>         +                           (phy-&gt;rev &gt;= 7)) {
</I>&gt;<i>         +                               bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_EXTG(0x11),
</I>&gt;<i>         +                                       bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_EXTG(0x11)) &amp; 0xF7FF);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0020, 0x0001);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0021, 0x0001);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0022, 0x0001);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0023, 0x0000);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0000, 0x0000);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_GAINX, 0x0003, 0x0002);
</I>&gt;<i>         +                       }
</I>&gt;<i>         +               }
</I>&gt;<i>         +       }
</I>&gt;<i>         +       if (bus-&gt;sprom.r1.boardflags_lo &amp; BCM43xx_BFL_FEM) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_GTABCTL,
</I>&gt;<i>         0x3120);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_GTABDATA,
</I>&gt;<i>         0xC480);
</I>&gt;<i>         +       }
</I>&gt;<i>         +}
</I>&gt;<i>         +
</I>&gt;<i>         +void bcm43xx_wa_all(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +{
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +
</I>&gt;<i>         +       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         +               switch (phy-&gt;rev) {
</I>&gt;<i>         +               case 2:
</I>&gt;<i>         +                       bcm43xx_wa_papd(dev);
</I>&gt;<i>         +                       bcm43xx_wa_auxclipthr(dev);
</I>&gt;<i>         +                       bcm43xx_wa_afcdac(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txdc_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_initgains(dev);
</I>&gt;<i>         +                       bcm43xx_wa_divider(dev);
</I>&gt;<i>         +                       bcm43xx_wa_gt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_lt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_analog(dev);
</I>&gt;<i>         +                       bcm43xx_wa_dac(dev);
</I>&gt;<i>         +                       bcm43xx_wa_fft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_art(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txlna_gain(dev);
</I>&gt;<i>         +                       bcm43xx_wa_crs_reset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_2060txlna_gain(dev);
</I>&gt;<i>         +                       bcm43xx_wa_lms(dev);
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               case 3:
</I>&gt;<i>         +                       bcm43xx_wa_papd(dev);
</I>&gt;<i>         +                       bcm43xx_wa_mixedsignal(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_lt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txdc_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_initgains(dev);
</I>&gt;<i>         +                       bcm43xx_wa_dac(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_msst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_analog(dev);
</I>&gt;<i>         +                       bcm43xx_wa_gt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txpuoff_rxpuon(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txlna_gain(dev);
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               case 5:
</I>&gt;<i>         +                       bcm43xx_wa_iqadc(dev);
</I>&gt;<i>         +               case 6:
</I>&gt;<i>         +                       bcm43xx_wa_papd(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_lt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txdc_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_initgains(dev);
</I>&gt;<i>         +                       bcm43xx_wa_dac(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_msst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_analog(dev);
</I>&gt;<i>         +                       bcm43xx_wa_gt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txpuoff_rxpuon(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txlna_gain(dev);
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               case 7:
</I>&gt;<i>         +                       bcm43xx_wa_iqadc(dev);
</I>&gt;<i>         +                       bcm43xx_wa_papd(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_lt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txdc_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_initgains(dev);
</I>&gt;<i>         +                       bcm43xx_wa_dac(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_msst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_analog(dev);
</I>&gt;<i>         +                       bcm43xx_wa_gt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txpuoff_rxpuon(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txlna_gain(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_adc(dev);
</I>&gt;<i>         +               default:
</I>&gt;<i>         +                       assert(0);
</I>&gt;<i>         +               }
</I>&gt;<i>         +               bcm43xx_wa_boards_a(dev);
</I>&gt;<i>         +       } else if (phy-&gt;type == BCM43xx_PHYTYPE_G) {
</I>&gt;<i>         +               switch (phy-&gt;rev) {
</I>&gt;<i>         +               case 1://XXX review rev1
</I>&gt;<i>         +                       bcm43xx_wa_crs_ed(dev);
</I>&gt;<i>         +                       bcm43xx_wa_crs_thr(dev);
</I>&gt;<i>         +                       bcm43xx_wa_crs_blank(dev);
</I>&gt;<i>         +                       bcm43xx_wa_cck_shiftbits(dev);
</I>&gt;<i>         +                       bcm43xx_wa_fft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_art(dev);
</I>&gt;<i>         +                       bcm43xx_wa_wrssi_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_altagc(dev);
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               case 2:
</I>&gt;<i>         +               case 6:
</I>&gt;<i>         +               case 7:
</I>&gt;<i>         +               case 8:
</I>&gt;<i>         +                       bcm43xx_wa_tr_ltov(dev);
</I>&gt;<i>         +                       bcm43xx_wa_crs_ed(dev);
</I>&gt;<i>         +                       bcm43xx_wa_rssi_lt(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nft(dev);
</I>&gt;<i>         +                       bcm43xx_wa_nst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_msst(dev);
</I>&gt;<i>         +                       bcm43xx_wa_wrssi_offset(dev);
</I>&gt;<i>         +                       bcm43xx_wa_altagc(dev);
</I>&gt;<i>         +                       bcm43xx_wa_analog(dev);
</I>&gt;<i>         +                       bcm43xx_wa_txpuoff_rxpuon(dev);
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               default:
</I>&gt;<i>         +                       assert(0);
</I>&gt;<i>         +               }
</I>&gt;<i>         +               bcm43xx_wa_boards_g(dev);
</I>&gt;<i>         +       } else { /* No N PHY support so far */
</I>&gt;<i>         +               assert(0);
</I>&gt;<i>         +       }
</I>&gt;<i>         +
</I>&gt;<i>         +       bcm43xx_wa_cpll_nonpilot(dev);
</I>&gt;<i>         +}
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.h
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         --- /dev/null   1970-01-01 00:00:00.000000000 +0000
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.h      2007-05-12
</I>&gt;<i>         16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -0,0 +1,7 @@
</I>&gt;<i>         +#ifndef BCM43xx_WA_H_
</I>&gt;<i>         +#define BCM43xx_WA_H_
</I>&gt;<i>         +
</I>&gt;<i>         +void bcm43xx_wa_initgains(struct bcm43xx_wldev *dev);
</I>&gt;<i>         +void bcm43xx_wa_all(struct bcm43xx_wldev *dev);
</I>&gt;<i>         +
</I>&gt;<i>         +#endif /* BCM43xx_WA_H_ */
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c    
</I>&gt;<i>         2007-05-12 16:27: 31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c  2007-05-12
</I>&gt;<i>         16:29:05.000000000 +0200
</I>&gt;<i>         @@ -230,7 +230,7 @@ const u16 bcm43xx_tab_noisea2[] = {
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         const u16 bcm43xx_tab_noisea3[] = {
</I>&gt;<i>         -       0x4C4C, 0x4C4C, 0x4C4C, 0x2D36,
</I>&gt;<i>         +       0x5E5E, 0x5E5E, 0x5E5E, 0x3F48,
</I>&gt;<i>                 0x4C4C, 0x4C4C, 0x4C4C, 0x2D36,
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         @@ -244,6 +244,26 @@ const u16 bcm43xx_tab_noiseg2[] = {
</I>&gt;<i>                 0x0000, 0x0000, 0x0000, 0x0000,
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         +const u16 bcm43xx_tab_noisescalea2[] = {
</I>&gt;<i>         +       0x6767, 0x6767, 0x6767, 0x6767, /* 0 */
</I>&gt;<i>         +       0x6767, 0x6767, 0x6767, 0x6767,
</I>&gt;<i>         +       0x6767, 0x6767, 0x6767, 0x6767,
</I>&gt;<i>         +       0x6767, 0x6700, 0x6767, 0x6767,
</I>&gt;<i>         +       0x6767, 0x6767, 0x6767, 0x6767, /* 16 */
</I>&gt;<i>         +       0x6767, 0x6767, 0x6767, 0x6767,
</I>&gt;<i>         +       0x6767, 0x6767, 0x0067,
</I>&gt;<i>         +};
</I>&gt;<i>         +
</I>&gt;<i>         +const u16 bcm43xx_tab_noisescalea3[] = {
</I>&gt;<i>         +       0x2323, 0x2323, 0x2323, 0x2323, /* 0 */
</I>&gt;<i>         +       0x2323, 0x2323, 0x2323, 0x2323,
</I>&gt;<i>         +       0x2323, 0x2323, 0x2323, 0x2323,
</I>&gt;<i>         +       0x2323, 0x2300, 0x2323, 0x2323,
</I>&gt;<i>         +       0x2323, 0x2323, 0x2323, 0x2323, /* 16 */
</I>&gt;<i>         +       0x2323, 0x2323, 0x2323, 0x2323,
</I>&gt;<i>         +       0x2323, 0x2323, 0x0023,
</I>&gt;<i>         +};
</I>&gt;<i>         +
</I>&gt;<i>         const u16 bcm43xx_tab_noisescaleg1[] = {
</I>&gt;<i>                 0x6C77, 0x5162, 0x3B40, 0x3335, /* 0 */
</I>&gt;<i>                 0x2F2D, 0x2A2A, 0x2527, 0x1F21,
</I>&gt;<i>         @@ -255,7 +275,7 @@ const u16 bcm43xx_tab_noisescaleg1[] = {
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         const u16 bcm43xx_tab_noisescaleg2[] = {
</I>&gt;<i>         -       0xD8DD, 0xCBD4, 0xBCC0, 0XB6B7, /* 0 */
</I>&gt;<i>         +       0xD8DD, 0xCBD4, 0xBCC0, 0xB6B7, /* 0 */
</I>&gt;<i>                 0xB2B0, 0xADAD, 0xA7A9, 0x9FA1,
</I>&gt;<i>                 0x969B, 0x9195, 0x8F8F, 0x8A8A,
</I>&gt;<i>                 0x8A8A, 0x8A00, 0x8A8A, 0x8F8A,
</I>&gt;<i>         @@ -308,6 +328,27 @@ const u16 bcm43xx_tab_sigmasqr2[] = {
</I>&gt;<i>                 0x00DE,
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         +const u16 bcm43xx_tab_rssiagc1[] = {
</I>&gt;<i>         +       0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8, /* 0 */
</I>&gt;<i>         +       0xFFF8, 0xFFF9, 0xFFFC, 0xFFFE,
</I>&gt;<i>         +       0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8,
</I>&gt;<i>         +       0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8,
</I>&gt;<i>         +};
</I>&gt;<i>         +
</I>&gt;<i>         +const u16 bcm43xx_tab_rssiagc2[] = {
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0C38, /* 0 */
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0A38,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0A38, /* 16 */
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0A38,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0A38, /* 32 */
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0920, 0x0A38,
</I>&gt;<i>         +       0x0820, 0x0820, 0x0820, 0x0820,
</I>&gt;<i>         +};
</I>&gt;<i>
</I>&gt;<i>         static inline void assert_sizes(void)
</I>&gt;<i>         {
</I>&gt;<i>         @@ -319,34 +360,59 @@ static inline void assert_sizes(void)
</I>&gt;<i>                 BUILD_BUG_ON(BCM43xx_TAB_NOISEA3_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisea3));
</I>&gt;<i>                 BUILD_BUG_ON(BCM43xx_TAB_NOISEG1_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noiseg1));
</I>&gt;<i>                 BUILD_BUG_ON(BCM43xx_TAB_NOISEG2_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noiseg2));
</I>&gt;<i>         -       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg1));
</I>&gt;<i>         -       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg2));
</I>&gt;<i>         -       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg3));
</I>&gt;<i>         +       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg1));
</I>&gt;<i>         +       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg2));
</I>&gt;<i>         +       BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_noisescaleg3));
</I>&gt;<i>                 BUILD_BUG_ON(BCM43xx_TAB_SIGMASQR_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_sigmasqr1));
</I>&gt;<i>                 BUILD_BUG_ON(BCM43xx_TAB_SIGMASQR_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_sigmasqr2));
</I>&gt;<i>         +       BUILD_BUG_ON(BCM43xx_TAB_RSSIAGC1_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_rssiagc1));
</I>&gt;<i>         +       BUILD_BUG_ON(BCM43xx_TAB_RSSIAGC2_SIZE !=
</I>&gt;<i>         ARRAY_SIZE(bcm43xx_tab_rssiagc2));
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         u16 bcm43xx_ofdmtab_read16(struct bcm43xx_wldev *dev, u16
</I>&gt;<i>         table, u16 offset)
</I>&gt;<i>         {
</I>&gt;<i>         -       assert_sizes();
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       u16 addr;
</I>&gt;<i>         +
</I>&gt;<i>         +       addr = table + offset;
</I>&gt;<i>         +       if (addr - 1 != phy-&gt;ofdm_addr || phy-&gt;ofdm_valid != 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL,
</I>&gt;<i>         addr);
</I>&gt;<i>         +               phy-&gt;ofdm_valid = 1;
</I>&gt;<i>         +       }
</I>&gt;<i>         +       phy-&gt;ofdm_addr = addr;
</I>&gt;<i>
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table +
</I>&gt;<i>         offset);
</I>&gt;<i>                 return bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEI);
</I>&gt;<i>         +       assert_sizes();
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         void bcm43xx_ofdmtab_write16(struct bcm43xx_wldev *dev, u16
</I>&gt;<i>         table,
</I>&gt;<i>                                      u16 offset, u16 value)
</I>&gt;<i>         {
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table +
</I>&gt;<i>         offset);
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       u16 addr;
</I>&gt;<i>         +
</I>&gt;<i>         +       addr = table + offset;
</I>&gt;<i>         +       if (addr - 1 != phy-&gt;ofdm_addr || phy-&gt;ofdm_valid != 2) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL,
</I>&gt;<i>         addr);
</I>&gt;<i>         +               phy-&gt;ofdm_valid = 2;
</I>&gt;<i>         +       }
</I>&gt;<i>         +       phy-&gt;ofdm_addr = addr;
</I>&gt;<i>                 bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         u32 bcm43xx_ofdmtab_read32(struct bcm43xx_wldev *dev, u16
</I>&gt;<i>         table, u16 offset)
</I>&gt;<i>         {
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>                 u32 ret;
</I>&gt;<i>         +       u16 addr;
</I>&gt;<i>
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table +
</I>&gt;<i>         offset);
</I>&gt;<i>         +       addr = table + offset;
</I>&gt;<i>         +       if (addr - 1 != phy-&gt;ofdm_addr || phy-&gt;ofdm_valid != 1) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL,
</I>&gt;<i>         addr);
</I>&gt;<i>         +               phy-&gt;ofdm_valid = 1;
</I>&gt;<i>         +       }
</I>&gt;<i>         +       phy-&gt;ofdm_addr = addr;
</I>&gt;<i>                 ret = bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEQ);
</I>&gt;<i>                 ret &lt;&lt;= 16;
</I>&gt;<i>                 ret |= bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEI);
</I>&gt;<i>         @@ -357,9 +423,17 @@ u32 bcm43xx_ofdmtab_read32(struct bcm43x
</I>&gt;<i>         void bcm43xx_ofdmtab_write32(struct bcm43xx_wldev *dev, u16 table,
</I>&gt;<i>                                      u16 offset, u32 value)
</I>&gt;<i>         {
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table +
</I>&gt;<i>         offset);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
</I>&gt;<i>         +       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         +       u16 addr;
</I>&gt;<i>         +
</I>&gt;<i>         +       addr = table + offset;
</I>&gt;<i>         +       if (addr - 1 != phy-&gt;ofdm_addr || phy-&gt;ofdm_valid != 2) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL,
</I>&gt;<i>         addr);
</I>&gt;<i>         +               phy-&gt;ofdm_valid = 2;
</I>&gt;<i>         +       }
</I>&gt;<i>         +       phy-&gt;ofdm_addr = addr;
</I>&gt;<i>                 bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEQ, (value &gt;&gt;
</I>&gt;<i>         16));
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         u16 bcm43xx_gtab_read(struct bcm43xx_wldev *dev, u16 table,
</I>&gt;<i>         u16 offset)
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h    2007-05-12
</I>&gt;<i>         16:27:31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h
</I>&gt;<i>         2007-05-12 16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -591,6 +591,10 @@ struct bcm43xx_phy {
</I>&gt;<i>                 u16 lofcal;
</I>&gt;<i>
</I>&gt;<i>                 u16 initval;//FIXME rename?
</I>&gt;<i>         +
</I>&gt;<i>         +       /* OFDM address read/write caching for hardware
</I>&gt;<i>         auto-increment. */
</I>&gt;<i>         +       u16 ofdm_addr;
</I>&gt;<i>         +       u8 ofdm_valid; /* 0: invalid, 1: read, 2: write */
</I>&gt;<i>         };
</I>&gt;<i>
</I>&gt;<i>         /* Data structures for DMA transmission, per 80211 core. */
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c      
</I>&gt;<i>         2007-05-12 16:27:31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c    2007-05-12
</I>&gt;<i>         16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -3127,6 +3127,9 @@ static void setup_struct_phy_for_init(st
</I>&gt;<i>                 spin_lock_init(&amp;phy-&gt;lock);
</I>&gt;<i>                 phy-&gt;interfmode = BCM43xx_INTERFMODE_NONE;
</I>&gt;<i>                 phy-&gt;channel = 0xFF;
</I>&gt;<i>         +
</I>&gt;<i>         +       /* OFDM address caching. */
</I>&gt;<i>         +       phy-&gt;ofdm_valid = 0;
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         static void setup_struct_wldev_for_init(struct bcm43xx_wldev *dev)
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h        2007-05-12
</I>&gt;<i>         16:27:31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h    
</I>&gt;<i>         2007-05-12 16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -28,8 +28,11 @@ struct bcm43xx_wldev;
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_PWRDOWN            BCM43xx_PHY_OFDM(0x03)  /*
</I>&gt;<i>         Powerdown */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_CRSTHRES1          BCM43xx_PHY_OFDM(0x06)  /* CRS
</I>&gt;<i>         Threshold 1 */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_LNAHPFCTL          BCM43xx_PHY_OFDM(0x1C)  /*
</I>&gt;<i>         LNA/HPF control */
</I>&gt;<i>         +#define BCM43xx_PHY_LPFGAINCTL        
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x20)  /* LPF Gain control */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_ADIVRELATED                BCM43xx_PHY_OFDM(0x27)  /*
</I>&gt;<i>         FIXME rename */
</I>&gt;<i>         #define BCM43xx_PHY_CRS0               BCM43xx_PHY_OFDM(0x29)
</I>&gt;<i>         +#define  BCM43xx_PHY_CRS0_EN           0x4000
</I>&gt;<i>         +#define BCM43xx_PHY_PEAK_COUNT         BCM43xx_PHY_OFDM(0x30)
</I>&gt;<i>         #define BCM43xx_PHY_ANTDWELL          
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x2B)  /* Antenna dwell */
</I>&gt;<i>         #define  BCM43xx_PHY_ANTDWELL_AUTODIV1
</I>&gt;<i>         0x0100                  /* Automatic RX diversity start antenna */
</I>&gt;<i>         #define BCM43xx_PHY_ENCORE            
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x49)  /* &quot;Encore&quot; (RangeMax / BroadRange) */
</I>&gt;<i>         @@ -38,6 +41,7 @@ struct bcm43xx_wldev;
</I>&gt;<i>         #define BCM43xx_PHY_OFDM61            
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x61)  /* FIXME rename */
</I>&gt;<i>         #define  BCM43xx_PHY_OFDM61_10        
</I>&gt;<i>         0x0010                  /* FIXME rename */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_IQBAL              BCM43xx_PHY_OFDM(0x69)  /* I/Q
</I>&gt;<i>         balance */
</I>&gt;<i>         +#define
</I>&gt;<i>         BCM43xx_PHY_BBTXDC_BIAS                BCM43xx_PHY_OFDM(0x6B)  /*
</I>&gt;<i>         Baseband TX DC bias */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_OTABLECTL          BCM43xx_PHY_OFDM(0x72)  /* OFDM
</I>&gt;<i>         table control (see below) */
</I>&gt;<i>         #define  BCM43xx_PHY_OTABLEOFF        
</I>&gt;<i>         0x03FF                  /* OFDM table offset (see below) */
</I>&gt;<i>         #define  BCM43xx_PHY_OTABLENR          0xFC00                  /*
</I>&gt;<i>         OFDM table number (see below) */
</I>&gt;<i>         @@ -45,6 +49,9 @@ struct bcm43xx_wldev;
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_OTABLEI            BCM43xx_PHY_OFDM(0x73)  /* OFDM
</I>&gt;<i>         table data I */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_OTABLEQ            BCM43xx_PHY_OFDM(0x74)  /* OFDM
</I>&gt;<i>         table data Q */
</I>&gt;<i>         #define BCM43xx_PHY_HPWR_TSSICTL      
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x78)  /* Hardware power TSSI control */
</I>&gt;<i>         +#define BCM43xx_PHY_ADCCTL            
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x7A)  /* ADC control */
</I>&gt;<i>         +#define BCM43xx_PHY_IDLE_TSSI          BCM43xx_PHY_OFDM(0x7B)
</I>&gt;<i>         +#define BCM43xx_PHY_A_TEMP_SENSE      
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x7C)  /* A PHY temperature sense */
</I>&gt;<i>         #define BCM43xx_PHY_NRSSITHRES        
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x8A)  /* NRSSI threshold */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_ANTWRSETT          BCM43xx_PHY_OFDM(0x8C)  /*
</I>&gt;<i>         Antenna WR settle */
</I>&gt;<i>         #define  BCM43xx_PHY_ANTWRSETT_ARXDIV  0x2000                  /*
</I>&gt;<i>         Automatic RX diversity enabled */
</I>&gt;<i>         @@ -55,6 +62,8 @@ struct bcm43xx_wldev;
</I>&gt;<i>         #define BCM43xx_PHY_N1N2GAIN           BCM43xx_PHY_OFDM(0xA2)
</I>&gt;<i>         #define BCM43xx_PHY_CLIPTHRES          BCM43xx_PHY_OFDM(0xA3)
</I>&gt;<i>         #define BCM43xx_PHY_CLIPN1P2THRES      BCM43xx_PHY_OFDM(0xA4)
</I>&gt;<i>         +#define
</I>&gt;<i>         BCM43xx_PHY_CCKSHIFTBITS_WA    BCM43xx_PHY_OFDM(0xA5)  /* CCK
</I>&gt;<i>         shiftbits workaround, FIXME rename */
</I>&gt;<i>         +#define BCM43xx_PHY_CCKSHIFTBITS      
</I>&gt;<i>         BCM43xx_PHY_OFDM(0xA7)  /* FIXME rename */
</I>&gt;<i>         #define BCM43xx_PHY_DIVSRCHIDX        
</I>&gt;<i>         BCM43xx_PHY_OFDM(0xA8)  /* Divider search gain/index */
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_CLIPP2THRES                BCM43xx_PHY_OFDM(0xA9)
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_PHY_CLIPP3THRES                BCM43xx_PHY_OFDM(0xAA)
</I>&gt;<i>         @@ -128,13 +137,14 @@ struct bcm43xx_wldev;
</I>&gt;<i>         #define BCM43xx_OFDMTAB_DC             BCM43xx_OFDMTAB(0x0E, 7)
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_OFDMTAB_PWRDYN2                BCM43xx_OFDMTAB(0x0E, 12)
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_OFDMTAB_LNAGAIN                BCM43xx_OFDMTAB(0x0E, 13)
</I>&gt;<i>         -//TODO
</I>&gt;<i>         +#define BCM43xx_OFDMTAB_UNKNOWN_0F     BCM43xx_OFDMTAB(0x0F,
</I>&gt;<i>         0)        //TODO rename
</I>&gt;<i>         +#define BCM43xx_OFDMTAB_UNKNOWN_APHY   BCM43xx_OFDMTAB(0x0F,
</I>&gt;<i>         7)        //TODO rename
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_OFDMTAB_LPFGAIN                BCM43xx_OFDMTAB(0x0F, 12)
</I>&gt;<i>         #define BCM43xx_OFDMTAB_RSSI           BCM43xx_OFDMTAB(0x10, 0)
</I>&gt;<i>         -//TODO
</I>&gt;<i>         +#define BCM43xx_OFDMTAB_UNKNOWN_11     BCM43xx_OFDMTAB(0x11,
</I>&gt;<i>         4)        //TODO rename
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1_R1                BCM43xx_OFDMTAB(0x13, 0)
</I>&gt;<i>         -#define BCM43xx_OFDMTAB_GAINX_R1       BCM43xx_OFDMTAB(0x14,
</I>&gt;<i>         0)        //TODO rename
</I>&gt;<i>         -#define BCM43xx_OFDMTAB_MINSIGSQ       BCM43xx_OFDMTAB(0x14, 1)
</I>&gt;<i>         +#define BCM43xx_OFDMTAB_GAINX_R1       BCM43xx_OFDMTAB(0x14,
</I>&gt;<i>         0)        //TODO remove!
</I>&gt;<i>         +#define BCM43xx_OFDMTAB_MINSIGSQ       BCM43xx_OFDMTAB(0x14, 0)
</I>&gt;<i>         #define
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC3_R1                BCM43xx_OFDMTAB(0x15, 0)
</I>&gt;<i>         #define BCM43xx_OFDMTAB_WRSSI_R1       BCM43xx_OFDMTAB(0x15, 4)
</I>&gt;<i>         #define BCM43xx_OFDMTAB_TSSI           BCM43xx_OFDMTAB(0x15, 0)
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h    
</I>&gt;<i>         2007-05-12 16:27:31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h  2007-05-12
</I>&gt;<i>         16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -17,12 +17,18 @@ extern const u16 bcm43xx_tab_noisea3[];
</I>&gt;<i>         extern const u16 bcm43xx_tab_noiseg1[];
</I>&gt;<i>         #define BCM43xx_TAB_NOISEG2_SIZE       8
</I>&gt;<i>         extern const u16 bcm43xx_tab_noiseg2[];
</I>&gt;<i>         -#define BCM43xx_TAB_NOISESCALEG_SIZE   27
</I>&gt;<i>         +#define BCM43xx_TAB_NOISESCALE_SIZE    27
</I>&gt;<i>         +extern const u16 bcm43xx_tab_noisescalea2[];
</I>&gt;<i>         +extern const u16 bcm43xx_tab_noisescalea3[];
</I>&gt;<i>         extern const u16 bcm43xx_tab_noisescaleg1[];
</I>&gt;<i>         extern const u16 bcm43xx_tab_noisescaleg2[];
</I>&gt;<i>         extern const u16 bcm43xx_tab_noisescaleg3[];
</I>&gt;<i>         #define BCM43xx_TAB_SIGMASQR_SIZE      53
</I>&gt;<i>         extern const u16 bcm43xx_tab_sigmasqr1[];
</I>&gt;<i>         extern const u16 bcm43xx_tab_sigmasqr2[];
</I>&gt;<i>         +#define BCM43xx_TAB_RSSIAGC1_SIZE      16
</I>&gt;<i>         +extern const u16 bcm43xx_tab_rssiagc1[];
</I>&gt;<i>         +#define BCM43xx_TAB_RSSIAGC2_SIZE      48
</I>&gt;<i>         +extern const u16 bcm43xx_tab_rssiagc2[];
</I>&gt;<i>
</I>&gt;<i>         #endif /* BCM43xx_TABLES_H_ */
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
</I>&gt;<i>
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c        2007-05-12
</I>&gt;<i>         16:27:31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c    
</I>&gt;<i>         2007-05-12 16:29: 05.000000000 +0200
</I>&gt;<i>         @@ -34,6 +34,7 @@
</I>&gt;<i>         #include &quot;bcm43xx_tables.h&quot;
</I>&gt;<i>         #include &quot;bcm43xx_power.h&quot;
</I>&gt;<i>         #include &quot;bcm43xx_lo.h&quot;
</I>&gt;<i>         +#include &quot;bcm43xx_wa.h&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         static const s8 bcm43xx_tssi2dbm_b_table[] = {
</I>&gt;<i>         @@ -559,393 +560,96 @@ static void bcm43xx_phy_init_pctl(struct
</I>&gt;<i>                 bcm43xx_shm_clear_tssi(dev);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         -static void bcm43xx_phy_agcsetup(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +static void bcm43xx_phy_rssiagc(struct bcm43xx_wldev *dev, u8
</I>&gt;<i>         enable)
</I>&gt;<i>         {
</I>&gt;<i>         -       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         -       u16 offset = 0x0000;
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 1)
</I>&gt;<i>         -               offset = 0x4C00;
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 0, 0x00FE);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 1, 0x000D);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 2, 0x0013);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 3, 0x0019);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1800, 0, 0x2710);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1801, 0, 0x9B83);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1802, 0, 0x9B83);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1803, 0, 0x0F8D);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0455, 0x0004);
</I>&gt;<i>         -       }
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A5,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A5)
</I>&gt;<i>         -                          &amp; 0x00FF) | 0x5700);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x041A,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x041A)
</I>&gt;<i>         -                          &amp; 0xFF80) | 0x000F);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x041A,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x041A)
</I>&gt;<i>         -                          &amp; 0xC07F) | 0x2B80);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x048C,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x048C)
</I>&gt;<i>         -                          &amp; 0xF0FF) | 0x0300);
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_radio_write16(dev, 0x007A,
</I>&gt;<i>         -                             bcm43xx_radio_read16(dev, 0x007A)
</I>&gt;<i>         -                             | 0x0008);
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A0,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A0)
</I>&gt;<i>         -                          &amp; 0xFFF0) | 0x0008);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A1,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A1)
</I>&gt;<i>         -                          &amp; 0xF0FF) | 0x0600);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A2,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A2)
</I>&gt;<i>         -                          &amp; 0xF0FF) | 0x0700);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A0,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A0)
</I>&gt;<i>         -                          &amp; 0xF0FF) | 0x0100);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x04A2,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x04A2)
</I>&gt;<i>         -                                  &amp; 0xFFF0) | 0x0007);
</I>&gt;<i>         -       }
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0488,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0488)
</I>&gt;<i>         -                          &amp; 0xFF00) | 0x001C);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0488,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0488)
</I>&gt;<i>         -                          &amp; 0xC0FF) | 0x0200);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0496,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0496)
</I>&gt;<i>         -                          &amp; 0xFF00) | 0x001C);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0489,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0489)
</I>&gt;<i>         -                          &amp; 0xFF00) | 0x0020);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0489,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0489)
</I>&gt;<i>         -                          &amp; 0xC0FF) | 0x0200);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0482,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0482)
</I>&gt;<i>         -                          &amp; 0xFF00) | 0x002E);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0496,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0496)
</I>&gt;<i>         -                          &amp; 0x00FF) | 0x1A00);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0481,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0481)
</I>&gt;<i>         -                          &amp; 0xFF00) | 0x0028);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0481,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x0481)
</I>&gt;<i>         -                          &amp; 0x00FF) | 0x2C00);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0430, 0x092B);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x041B,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x041B)
</I>&gt;<i>         -                                  &amp; 0xFFE1) | 0x0002);
</I>&gt;<i>         -       } else {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x041B,
</I>&gt;<i>         -                                 bcm43xx_phy_read(dev, 0x041B)
</I>&gt;<i>         -                                 &amp; 0xFFE1);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x041F, 0x287A);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0420,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x0420)
</I>&gt;<i>         -                                  &amp; 0xFFF0) | 0x0004);
</I>&gt;<i>         -       }
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0422, 0x287A);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0420,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x0420)
</I>&gt;<i>         -                                  &amp; 0x0FFF) | 0x3000);
</I>&gt;<i>         -       }
</I>&gt;<i>         -
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x04A8,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev, 0x04A8)
</I>&gt;<i>         -                          &amp; 0x8080) | 0x7874);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x048E, 0x1C00);
</I>&gt;<i>         -
</I>&gt;<i>         -       offset = 0x0800;
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               offset = 0x5400;
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x04AB,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x04AB)
</I>&gt;<i>         -                                  &amp; 0xF0FF) | 0x0600);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x048B, 0x005E);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x048C,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x048C)
</I>&gt;<i>         -                                  &amp; 0xFF00) | 0x001E);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x048D, 0x0002);
</I>&gt;<i>         -       }
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 0, 0x00);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 1, 0x07);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 2, 0x10);
</I>&gt;<i>         -       bcm43xx_ofdmtab_write16(dev, offset, 3, 0x1C);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0426,
</I>&gt;<i>         -                                 bcm43xx_phy_read(dev, 0x0426)
</I>&gt;<i>         -                                 &amp; 0xFFFC);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0426,
</I>&gt;<i>         -                                 bcm43xx_phy_read(dev, 0x0426)
</I>&gt;<i>         -                                 &amp; 0xEFFF);
</I>&gt;<i>         -       }
</I>&gt;<i>         -}
</I>&gt;<i>         -
</I>&gt;<i>         -static void bcm43xx_phy_setupg(struct bcm43xx_wldev *dev)
</I>&gt;<i>         -{
</I>&gt;<i>         -       struct ssb_bus *bus = dev-&gt;dev-&gt;bus;
</I>&gt;<i>         -       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         -       u16 i;
</I>&gt;<i>         -
</I>&gt;<i>         -       assert(phy-&gt;type == BCM43xx_PHYTYPE_G);
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0406, 0x4F19);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, BCM43xx_PHY_G_CRS,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_G_CRS) &amp; 0xFC3F) | 0x0340);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x042C, 0x005A);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0427, 0x001A);
</I>&gt;<i>         -
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_FINEFREQG_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5800,
</I>&gt;<i>         i, bcm43xx_tab_finefreqg[i]);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISEG1_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1800,
</I>&gt;<i>         i, bcm43xx_tab_noiseg1[i]);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_ROTOR_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x2000,
</I>&gt;<i>         i, bcm43xx_tab_rotor[i]);
</I>&gt;<i>         -       } else {
</I>&gt;<i>         -               /* nrssi values are signed 6-bit values. Not
</I>&gt;<i>         sure why we write 0x7654 here... */
</I>&gt;<i>         -               bcm43xx_nrssi_hw_write(dev, 0xBA98, (s16)0x7654);
</I>&gt;<i>         -
</I>&gt;<i>         -               if (phy-&gt;rev == 2) {
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x04C0, 0x1861);
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x04C1, 0x0271);
</I>&gt;<i>         -               } else if (phy-&gt;rev &gt; 2) {
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x04C0, 0x0098);
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x04C1, 0x0070);
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x04C9, 0x0080);
</I>&gt;<i>         -               }
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x042B,
</I>&gt;<i>         bcm43xx_phy_read(dev, 0x042B) | 0x800);
</I>&gt;<i>         -
</I>&gt;<i>         -               for (i = 0; i &lt; 64; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x4000,
</I>&gt;<i>         i, i);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISEG2_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1800,
</I>&gt;<i>         i, bcm43xx_tab_noiseg2[i]);
</I>&gt;<i>         -       }
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev &lt;= 2)
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISESCALEG_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, bcm43xx_tab_noisescaleg1[i]);
</I>&gt;<i>         -       else if ((phy-&gt;rev &gt;= 7) &amp;&amp; (bcm43xx_phy_read(dev,
</I>&gt;<i>         0x0449) &amp; 0x0200))
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISESCALEG_SIZE;
</I>&gt;<i>         i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, bcm43xx_tab_noisescaleg3[i]);
</I>&gt;<i>         -       else
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISESCALEG_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, bcm43xx_tab_noisescaleg2[i]);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 2)
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_SIGMASQR_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5000,
</I>&gt;<i>         i, bcm43xx_tab_sigmasqr1[i]);
</I>&gt;<i>         -       else if ((phy-&gt;rev &gt; 2) &amp;&amp; (phy-&gt;rev &lt;= 8))
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_SIGMASQR_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5000,
</I>&gt;<i>         i, bcm43xx_tab_sigmasqr2[i]);
</I>&gt;<i>         -
</I>&gt;<i>         -       if (phy-&gt;rev == 1) {
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_RETARD_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write32(dev, 0x2400,
</I>&gt;<i>         i, bcm43xx_tab_retard[i]);
</I>&gt;<i>         -               for (i = 0; i &lt; 4; i++) {
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5404,
</I>&gt;<i>         i, 0x0020);
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5408,
</I>&gt;<i>         i, 0x0020);
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x540C,
</I>&gt;<i>         i, 0x0020);
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5410,
</I>&gt;<i>         i, 0x0020);
</I>&gt;<i>         -               }
</I>&gt;<i>         -               bcm43xx_phy_agcsetup(dev);
</I>&gt;<i>         -
</I>&gt;<i>         -               if ((bus-&gt;board_vendor == SSB_BOARDVENDOR_BCM) &amp;&amp;
</I>&gt;<i>         -                   (bus-&gt;board_type == SSB_BOARD_BU4306) &amp;&amp;
</I>&gt;<i>         -                   (bus-&gt;board_rev == 0x17))
</I>&gt;<i>         -                       return;
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
</I>&gt;<i>         -       } else {
</I>&gt;<i>         -               for (i = 0; i &lt;= 0x2F; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1000,
</I>&gt;<i>         i, 0x0820);
</I>&gt;<i>         -               bcm43xx_phy_agcsetup(dev);
</I>&gt;<i>         -               bcm43xx_phy_read(dev, 0x0400); /* dummy read */
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0403, 0x1000);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3C02, 0, 0x000F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3C03, 0, 0x0014);
</I>&gt;<i>         -
</I>&gt;<i>         -               if ((bus-&gt;board_vendor == SSB_BOARDVENDOR_BCM) &amp;&amp;
</I>&gt;<i>         -                   (bus-&gt;board_type == SSB_BOARD_BU4306) &amp;&amp;
</I>&gt;<i>         -                   (bus-&gt;board_rev == 0x17))
</I>&gt;<i>         -                       return;
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0401, 0, 0x0002);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0402, 0, 0x0001);
</I>&gt;<i>         -       }
</I>&gt;<i>         -}
</I>&gt;<i>         -
</I>&gt;<i>         -/* Initialize the noisescaletable for APHY */
</I>&gt;<i>         -static void bcm43xx_phy_init_noisescaletbl(struct
</I>&gt;<i>         bcm43xx_wldev *dev)
</I>&gt;<i>         -{
</I>&gt;<i>         -       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>                 int i;
</I>&gt;<i>
</I>&gt;<i>         -       for (i = 0; i &lt; 12; i++) {
</I>&gt;<i>         -               if (phy-&gt;rev == 2)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, 0x6767);
</I>&gt;<i>         +       if (dev-&gt;phy.rev &lt; 3) {
</I>&gt;<i>         +               if (enable)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_RSSIAGC1_SIZE; i++) {
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                      
</I>&gt;<i>         BCM43xx_OFDMTAB_LNAHPFGAIN1, i, 0xFFF8);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                       BCM43xx_OFDMTAB_WRSSI,
</I>&gt;<i>         i, 0xFFF8);
</I>&gt;<i>         +                       }
</I>&gt;<i>                         else
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, 0x2323);
</I>&gt;<i>         -       }
</I>&gt;<i>         -       if (phy-&gt;rev == 2)
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x6700);
</I>&gt;<i>         -       else
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x2300);
</I>&gt;<i>         -       for (i = 0; i &lt; 11; i++) {
</I>&gt;<i>         -               if (phy-&gt;rev == 2)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, 0x6767);
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_RSSIAGC1_SIZE; i++) {
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                      
</I>&gt;<i>         BCM43xx_OFDMTAB_LNAHPFGAIN1, i, bcm43xx_tab_rssiagc1[i]);
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                       BCM43xx_OFDMTAB_WRSSI,
</I>&gt;<i>         i, bcm43xx_tab_rssiagc1[i]);
</I>&gt;<i>         +                       }
</I>&gt;<i>         +       } else {
</I>&gt;<i>         +               if (enable)
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_RSSIAGC1_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                       BCM43xx_OFDMTAB_WRSSI,
</I>&gt;<i>         i, 0x0820);
</I>&gt;<i>                         else
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1400,
</I>&gt;<i>         i, 0x2323);
</I>&gt;<i>         +                       for (i = 0; i &lt;
</I>&gt;<i>         BCM43xx_TAB_RSSIAGC2_SIZE; i++)
</I>&gt;<i>         +                               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         +                                       BCM43xx_OFDMTAB_WRSSI,
</I>&gt;<i>         i, bcm43xx_tab_rssiagc2[i]);
</I>&gt;<i>                 }
</I>&gt;<i>         -       if (phy-&gt;rev == 2)
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x0067);
</I>&gt;<i>         -       else
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x0023);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         -static void bcm43xx_phy_setupa(struct bcm43xx_wldev *dev)
</I>&gt;<i>         +static void bcm43xx_phy_ww(struct bcm43xx_wldev *dev)
</I>&gt;<i>         {
</I>&gt;<i>         -       struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         -       u16 i;
</I>&gt;<i>         -
</I>&gt;<i>         -       assert(phy-&gt;type == BCM43xx_PHYTYPE_A);
</I>&gt;<i>         -       switch (phy-&gt;rev) {
</I>&gt;<i>         -       case 2:
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x008E, 0x3800);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0035, 0x03FF);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0036, 0x0400);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3807, 0, 0x0051);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001C, 0x0FF9);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0020,
</I>&gt;<i>         bcm43xx_phy_read(dev, 0x0020) &amp; 0xFF0F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3C0C, 0, 0x07BF);
</I>&gt;<i>         -               bcm43xx_radio_write16(dev, 0x0002, 0x07BF);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0024, 0x4680);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0020, 0x0003);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001D, 0x0F40);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001F, 0x1C00);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x002A,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x002A)
</I>&gt;<i>         -                                  &amp; 0x00FF) | 0x0400);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x002B,
</I>&gt;<i>         -                                 bcm43xx_phy_read(dev, 0x002B)
</I>&gt;<i>         -                                 &amp; 0xFBFF);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x008E, 0x58C1);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0803, 0, 0x000F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0804, 0, 0x001F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x002A);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x0030);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0807, 0, 0x003A);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 0, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 1, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 2, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 3, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 4, 0x0015);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 5, 0x0015);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 6, 0x0019);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0404, 0, 0x0003);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0405, 0, 0x0003);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0406, 0, 0x0007);
</I>&gt;<i>         -
</I>&gt;<i>         -               for (i = 0; i &lt; 16; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x4000,
</I>&gt;<i>         i, (0x8 + i) &amp; 0x000F);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3003, 0, 0x1044);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3004, 0, 0x7201);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3006, 0, 0x0040);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3001, 0,
</I>&gt;<i>         (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) &amp; 0x0010) | 0x0008);
</I>&gt;<i>         -
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_FINEFREQA_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5800,
</I>&gt;<i>         i, bcm43xx_tab_finefreqa[i]);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISEA2_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1800,
</I>&gt;<i>         i, bcm43xx_tab_noisea2[i]);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_ROTOR_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write32(dev, 0x2000,
</I>&gt;<i>         i, bcm43xx_tab_rotor[i]);
</I>&gt;<i>         -               bcm43xx_phy_init_noisescaletbl(dev);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_RETARD_SIZE; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write32(dev, 0x2400,
</I>&gt;<i>         i, bcm43xx_tab_retard[i]);
</I>&gt;<i>         -               break;
</I>&gt;<i>         -       case 3:
</I>&gt;<i>         -               for (i = 0; i &lt; 64; i++)
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x4000,
</I>&gt;<i>         i, i);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3807, 0, 0x0051);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001C, 0x0FF9);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0020,
</I>&gt;<i>         -                                 bcm43xx_phy_read(dev,
</I>&gt;<i>         0x0020) &amp; 0xFF0F);
</I>&gt;<i>         -               bcm43xx_radio_write16(dev, 0x0002, 0x07BF);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0024, 0x4680);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0020, 0x0003);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001D, 0x0F40);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x001F, 0x1C00);
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x002A,
</I>&gt;<i>         -                                 (bcm43xx_phy_read(dev, 0x002A)
</I>&gt;<i>         -                                  &amp; 0x00FF) | 0x0400);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3000, 1,
</I>&gt;<i>         -                                      
</I>&gt;<i>         (bcm43xx_ofdmtab_read16(dev, 0x3000, 1)
</I>&gt;<i>         -                                       &amp; 0x0010) | 0x0008);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_NOISEA3_SIZE; i++) {
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x1800, i,
</I>&gt;<i>         -                                              
</I>&gt;<i>         bcm43xx_tab_noisea3[i]);
</I>&gt;<i>         -               }
</I>&gt;<i>         -               bcm43xx_phy_init_noisescaletbl(dev);
</I>&gt;<i>         -               for (i = 0; i &lt; BCM43xx_TAB_SIGMASQR_SIZE; i++) {
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x5000, i,
</I>&gt;<i>         -                                              
</I>&gt;<i>         bcm43xx_tab_sigmasqr1[i]);
</I>&gt;<i>         -               }
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_phy_write(dev, 0x0003, 0x1808);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0803, 0, 0x000F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0804, 0, 0x001F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x002A);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x0030);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0807, 0, 0x003A);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0000, 0, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0001, 0, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0002, 0, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0003, 0, 0x0013);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0004, 0, 0x0015);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0005, 0, 0x0015);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0006, 0, 0x0019);
</I>&gt;<i>         -
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0404, 0, 0x0003);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0405, 0, 0x0003);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x0406, 0, 0x0007);
</I>&gt;<i>         +       u16 b, curr_s, best_s = 0xFFFF;
</I>&gt;<i>         +       int i;
</I>&gt;<i>
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3C02, 0, 0x000F);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3C03, 0, 0x0014);
</I>&gt;<i>         -               break;
</I>&gt;<i>         -       default:
</I>&gt;<i>         -               assert(0);
</I>&gt;<i>         -       }
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
</I>&gt;<i>         +               bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) &amp;
</I>&gt;<i>         ~BCM43xx_PHY_CRS0_EN);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
</I>&gt;<i>         +               bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1B))
</I>&gt;<i>         | 0x1000);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x82),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x82))
</I>&gt;<i>         &amp; 0xF0FF) | 0x0300);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0009,
</I>&gt;<i>         +               bcm43xx_radio_read16(dev, 0x0009) | 0x0080);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0012,
</I>&gt;<i>         +               (bcm43xx_radio_read16(dev, 0x0012) &amp; 0xFFFC) |
</I>&gt;<i>         0x0002);
</I>&gt;<i>         +       bcm43xx_wa_initgains(dev);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xBA), 0x3ED5);
</I>&gt;<i>         +       b = bcm43xx_phy_read(dev, BCM43xx_PHY_PWRDOWN);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, (b &amp;
</I>&gt;<i>         0xFFF8) | 0x0005);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0004,
</I>&gt;<i>         +               bcm43xx_radio_read16(dev, 0x0004) | 0x0004);
</I>&gt;<i>         +       for (i = 0x10; i &lt;= 0x20; i++) {
</I>&gt;<i>         +               bcm43xx_radio_write16(dev, 0x0013, i);
</I>&gt;<i>         +               curr_s = bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OTABLEQ) &amp; 0x00FF;
</I>&gt;<i>         +               if (!curr_s) {
</I>&gt;<i>         +                       best_s = 0x0000;
</I>&gt;<i>         +                       break;
</I>&gt;<i>         +               } else if (curr_s &gt;= 0x0080)
</I>&gt;<i>         +                       curr_s = 0x0100 - curr_s;
</I>&gt;<i>         +               if (curr_s &lt; best_s)
</I>&gt;<i>         +                       best_s = curr_s;
</I>&gt;<i>         +       }
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, b);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0004,
</I>&gt;<i>         +               bcm43xx_radio_read16(dev, 0x0004) &amp; 0xFFFB);
</I>&gt;<i>         +       bcm43xx_radio_write16(dev, 0x0013, best_s);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1,
</I>&gt;<i>         0, 0xFFEC);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB7), 0x1E80);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB6), 0x1C00);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB5), 0x0EC0);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB2), 0x00C0);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB9), 0x1FFF);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xBB),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0xBB))
</I>&gt;<i>         &amp; 0xF000) | 0x0053);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM61,
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM61 &amp;
</I>&gt;<i>         0xFE1F)) | 0x0120);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x13),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x13))
</I>&gt;<i>         &amp; 0x0FFF) | 0x3000);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x14),
</I>&gt;<i>         +               (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x14))
</I>&gt;<i>         &amp; 0x0FFF) | 0x3000);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 6,
</I>&gt;<i>         0x0017);
</I>&gt;<i>         +       for (i = 0; i &lt; 6; i++)
</I>&gt;<i>         +               bcm43xx_ofdmtab_write16(dev,
</I>&gt;<i>         BCM43xx_OFDMTAB_AGC1, i, 0x000F);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1,
</I>&gt;<i>         0x0D, 0x000E);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1,
</I>&gt;<i>         0x0E, 0x0011);
</I>&gt;<i>         +       bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1,
</I>&gt;<i>         0x0F, 0x0013);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x33), 0x5030);
</I>&gt;<i>         +       bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
</I>&gt;<i>         +               bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) |
</I>&gt;<i>         BCM43xx_PHY_CRS0_EN);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         /* Initialize APHY. This is also called for the GPHY in some
</I>&gt;<i>         cases. */
</I>&gt;<i>         @@ -953,60 +657,52 @@ static void bcm43xx_phy_inita(struct bcm
</I>&gt;<i>         {
</I>&gt;<i>                 struct ssb_bus *bus = dev-&gt;dev-&gt;bus;
</I>&gt;<i>                 struct bcm43xx_phy *phy = &amp;dev-&gt;phy;
</I>&gt;<i>         -       u16 tval;
</I>&gt;<i>
</I>&gt;<i>         -       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         -               bcm43xx_phy_setupa(dev);
</I>&gt;<i>         -       } else {
</I>&gt;<i>         -               bcm43xx_phy_setupg(dev);
</I>&gt;<i>         -               if (phy-&gt;gmode &amp;&amp;
</I>&gt;<i>         -                   (dev-&gt;dev-&gt;bus-&gt;sprom.r1.boardflags_lo &amp;
</I>&gt;<i>         BCM43xx_BFL_PACTRL))
</I>&gt;<i>         -                       bcm43xx_phy_write(dev, 0x046E, 0x03CF);
</I>&gt;<i>         -               return;
</I>&gt;<i>         +       if (phy-&gt;rev &gt;= 6) {
</I>&gt;<i>         +               if (phy-&gt;type == BCM43xx_PHYTYPE_A)
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x1B),
</I>&gt;<i>         +                               bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x1B)) &amp; ~0x1000);
</I>&gt;<i>         +               if (bcm43xx_phy_read(dev, BCM43xx_PHY_ENCORE)
</I>&gt;<i>         &amp; BCM43xx_PHY_ENCORE_EN)
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, BCM43xx_PHY_ENCORE,
</I>&gt;<i>         +                               bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ENCORE) | 0x0010);
</I>&gt;<i>         +               else
</I>&gt;<i>         +                       bcm43xx_phy_write(dev,
</I>&gt;<i>         BCM43xx_PHY_ENCORE,
</I>&gt;<i>         +                               bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_ENCORE) &amp; ~0x1010);
</I>&gt;<i>                 }
</I>&gt;<i>         +       bcm43xx_wa_all(dev);
</I>&gt;<i>
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_A_CRS,
</I>&gt;<i>         -                         (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_A_CRS) &amp; 0xF83C) | 0x0340);
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x0034, 0x0001);
</I>&gt;<i>         -
</I>&gt;<i>         -       TODO();//TODO: RSSI AGC
</I>&gt;<i>         -       bcm43xx_phy_write(dev, BCM43xx_PHY_A_CRS,
</I>&gt;<i>         -                         bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_A_CRS) | (1 &lt;&lt; 14));
</I>&gt;<i>         -       bcm43xx_radio_init2060(dev);
</I>&gt;<i>         +       if (phy-&gt;type == BCM43xx_PHYTYPE_A) {
</I>&gt;<i>         +               if (phy-&gt;gmode &amp;&amp;
</I>&gt;<i>         +                   (phy-&gt;rev &lt; 3))
</I>&gt;<i>         +                       bcm43xx_phy_write(dev, 0x0034,
</I>&gt;<i>         +                               bcm43xx_phy_read(dev, 0x0034)
</I>&gt;<i>         | 0x0001);
</I>&gt;<i>
</I>&gt;<i>         -       if ((bus-&gt;board_vendor == SSB_BOARDVENDOR_BCM) &amp;&amp;
</I>&gt;<i>         -           ((bus-&gt;board_type == SSB_BOARD_BU4306) ||
</I>&gt;<i>         -            (bus-&gt;board_type == SSB_BOARD_BU4309))) {
</I>&gt;<i>         -               if (phy-&gt;lofcal == 0xFFFF) {
</I>&gt;<i>         -                       TODO();//TODO: LOF Cal
</I>&gt;<i>         -                       bcm43xx_radio_set_tx_iq(dev);
</I>&gt;<i>         -               } else
</I>&gt;<i>         -                       bcm43xx_radio_write16(dev, 0x001E,
</I>&gt;<i>         phy-&gt;lofcal);
</I>&gt;<i>         -       }
</I>&gt;<i>         +               bcm43xx_phy_rssiagc(dev, 0);
</I>&gt;<i>
</I>&gt;<i>         -       bcm43xx_phy_write(dev, 0x007A, 0xF111);
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
</I>&gt;<i>         +                       bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_CRS0) | BCM43xx_PHY_CRS0_EN);
</I>&gt;<i>
</I>&gt;<i>         -       if (phy-&gt;cur_idle_tssi == 0) {
</I>&gt;<i>         -               bcm43xx_radio_write16(dev, 0x0019, 0x0000);
</I>&gt;<i>         -               bcm43xx_radio_write16(dev, 0x0017, 0x0020);
</I>&gt;<i>         +               bcm43xx_radio_init2060(dev);
</I>&gt;<i>
</I>&gt;<i>         -               tval = bcm43xx_ofdmtab_read16(dev, 0x3001, 0);
</I>&gt;<i>         -               if (phy-&gt;rev == 1) {
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x3001, 0,
</I>&gt;<i>         -                                        
</I>&gt;<i>         (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) &amp; 0xFF87)
</I>&gt;<i>         -                                         | 0x0058);
</I>&gt;<i>         -               } else {
</I>&gt;<i>         -                       bcm43xx_ofdmtab_write16(dev, 0x3001, 0,
</I>&gt;<i>         -                                        
</I>&gt;<i>         (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) &amp; 0xFFC3)
</I>&gt;<i>         -                                         | 0x002C);
</I>&gt;<i>         +               if ((bus-&gt;board_vendor == SSB_BOARDVENDOR_BCM) &amp;&amp;
</I>&gt;<i>         +                   ((bus-&gt;board_type == SSB_BOARD_BU4306) ||
</I>&gt;<i>         +                    (bus-&gt;board_type == SSB_BOARD_BU4309))) {
</I>&gt;<i>         +                       ; //TODO: A PHY LO
</I>&gt;<i>                         }
</I>&gt;<i>         -               bcm43xx_dummy_transmission(dev);
</I>&gt;<i>         -               phy-&gt;cur_idle_tssi = bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_A_PCTL);
</I>&gt;<i>         -               bcm43xx_ofdmtab_write16(dev, 0x3001, 0, tval);
</I>&gt;<i>
</I>&gt;<i>         -               bcm43xx_radio_set_txpower_a(dev, 0x0018);
</I>&gt;<i>         +               if (phy-&gt;rev &gt;= 3)
</I>&gt;<i>         +                       bcm43xx_phy_ww(dev);
</I>&gt;<i>         +
</I>&gt;<i>         +               hardware_pctl_init_aphy(dev);
</I>&gt;<i>         +
</I>&gt;<i>         +               //TODO: radar detection
</I>&gt;<i>         +       }
</I>&gt;<i>         +       if ((phy-&gt;type == BCM43xx_PHYTYPE_G) &amp;&amp;
</I>&gt;<i>         +           (dev-&gt;dev-&gt;bus-&gt;sprom.r1.boardflags_lo &amp;
</I>&gt;<i>         BCM43xx_BFL_PACTRL)) {
</I>&gt;<i>         +               bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x6E),
</I>&gt;<i>         +                                 (bcm43xx_phy_read(dev,
</I>&gt;<i>         BCM43xx_PHY_OFDM(0x6E))
</I>&gt;<i>         +                                  &amp; 0xE000) | 0x3CF);
</I>&gt;<i>                 }
</I>&gt;<i>         -       bcm43xx_shm_clear_tssi(dev);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         static void bcm43xx_phy_initb2(struct bcm43xx_wldev *dev)
</I>&gt;<i>         Index:
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/Makefile
</I>&gt;<i>         ===================================================================
</I>&gt;<i>         ---
</I>&gt;<i>         bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/Makefile    
</I>&gt;<i>         2007-05-12 16:27: 31.000000000 +0200
</I>&gt;<i>         +++
</I>&gt;<i>         bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/Makefile  2007-05-12
</I>&gt;<i>         16:29:05.000000000 +0200
</I>&gt;<i>         @@ -15,4 +15,5 @@ bcm43xx-mac80211-objs := bcm43xx_main.o
</I>&gt;<i>                                  bcm43xx_leds.o \
</I>&gt;<i>                                  bcm43xx_xmit.o \
</I>&gt;<i>                                  bcm43xx_lo.o \
</I>&gt;<i>         +                        bcm43xx_wa.o \
</I>&gt;<i>                                  $(bcm43xx-mac80211-obj-y)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         --
</I>&gt;<i>         Greetings Michael.
</I>&gt;<i>         _______________________________________________
</I>&gt;<i>
</I>This is with my 4318 so your are making progress, hopefully soon you
will have it and we can be done with softmac and v3 firmware which has
many known bugs even in the windows community.

bcm43xx_mac80211: Adding Interface type 2
bcm43xx_mac80211: Found PHY: Analog 3, Type 2, Revision 7
bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
ssb: Switching to PCI core, index 2
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: !WARNING! Idle-TSSI phy-&gt;cur_idle_tssi measuring
failed. (cur=0, tgt=62). Disabling TX power adjustment.
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac:
ff:ff:ff:ff:ff:ff
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:18:4d:8d:70:08
wlan0: RX authentication from 00:18:4d:8d:70:08 (alg=0 transaction=2
status=0)
wlan0: authenticated
wlan0: associate with AP 00:18:4d:8d:70:08
wlan0: RX AssocResp from 00:18:4d:8d:70:08 (capab=0x411 status=0 aid=1)
wlan0: associated
bcm43xx_mac80211: Removing Interface type 2
bcm43xx_mac80211: Wireless interface stopped
bcm43xx_mac80211: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx_mac80211: DMA-32 0x02A0 (TX) max used slots: 0/128
bcm43xx_mac80211: DMA-32 0x0280 (TX) max used slots: 0/128
bcm43xx_mac80211: DMA-32 0x0260 (TX) max used slots: 0/128
bcm43xx_mac80211: DMA-32 0x0240 (TX) max used slots: 0/128
bcm43xx_mac80211: DMA-32 0x0220 (TX) max used slots: 22/128
bcm43xx_mac80211: DMA-32 0x0200 (TX) max used slots: 0/128
bcm43xx_mac80211: Radio turned off
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned off

Great work and keep it moving forward as always.

-Jory

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001261.html">[PATCH 1/3] fix A/G PHYs setup and init
</A></li>
	<LI>Next message: <A HREF="001263.html">[PATCH 1/3] fix A/G PHYs setup and init
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1262">[ date ]</a>
              <a href="thread.html#1262">[ thread ]</a>
              <a href="subject.html#1262">[ subject ]</a>
              <a href="author.html#1262">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">More information about the Bcm43xx-dev
mailing list</a><br>
</body></html>
