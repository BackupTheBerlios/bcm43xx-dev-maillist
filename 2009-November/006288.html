<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> b43-phy0 ERROR: Fatal DMA error: 0x00000400
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/bcm43xx-dev/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:bcm43xx-dev%40lists.berlios.de?Subject=Re%3A%20b43-phy0%20ERROR%3A%20Fatal%20DMA%20error%3A%200x00000400&In-Reply-To=%3C200911121357.17031.mb%40bu3sch.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006287.html">
   <LINK REL="Next"  HREF="006289.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>b43-phy0 ERROR: Fatal DMA error: 0x00000400</H1>
    <B>Michael Buesch</B> 
    <A HREF="mailto:bcm43xx-dev%40lists.berlios.de?Subject=Re%3A%20b43-phy0%20ERROR%3A%20Fatal%20DMA%20error%3A%200x00000400&In-Reply-To=%3C200911121357.17031.mb%40bu3sch.de%3E"
       TITLE="b43-phy0 ERROR: Fatal DMA error: 0x00000400">mb at bu3sch.de
       </A><BR>
    <I>Thu Nov 12 13:57:15 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="006287.html">b43-phy0 ERROR: Fatal DMA error: 0x00000400
</A></li>
        <LI>Next message: <A HREF="006289.html">b43-phy0 ERROR: Fatal DMA error: 0x00000400
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6288">[ date ]</a>
              <a href="thread.html#6288">[ thread ]</a>
              <a href="subject.html#6288">[ subject ]</a>
              <a href="author.html#6288">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thursday 12 November 2009 13:16:31 Andrew Benton wrote:
&gt;<i> On 12/11/09 00:37, Larry Finger wrote:
</I>&gt;<i> &gt; Andy,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please try the patch below to see what we can learn from the DMA descriptor
</I>&gt;<i> &gt; errors. Some of this code is temporary, but there are also some statements that
</I>&gt;<i> &gt; will probably become permanent.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please post any messages that result.
</I>&gt;<i> 
</I>&gt;<i> The patch failed
</I>
Larry had an outdated tree.
This patch applies against wireless-testing:

From <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">Larry.Finger at lwfinger.net</A> Thu Nov 12 01:37:32 2009
Return-path: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-bounces at lists.berlios.de</A>&gt;
Envelope-to: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mb at bu3sch.de</A>
Delivery-date: Thu, 12 Nov 2009 00:38:24 +0000
Received: by vs166246.vserver.de with esmtp (Exim 4.69)
	id 1N8Nhg-0000zK-T1
	for <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mb at bu3sch.de</A>; Thu, 12 Nov 2009 00:38:24 +0000
Received: from bat.berlios.de (localhost [127.0.0.1])
	by mail.berlios.de (Postfix) with ESMTP id 2A1D719E79B;
	Thu, 12 Nov 2009 01:38:05 +0100 (CET)
X-Original-To: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>
Delivered-To: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>
Received: from mail-yx0-f174.google.com (mail-yx0-f174.google.com
	[209.85.210.174])
	by mail.berlios.de (Postfix) with ESMTP id 22BCAB3811
	for &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>&gt;;
	Thu, 12 Nov 2009 01:37:35 +0100 (CET)
Received: by yxe4 with SMTP id 4so1496946yxe.32
	for &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>&gt;;
	Wed, 11 Nov 2009 16:37:34 -0800 (PST)
Received: by 10.90.10.9 with SMTP id 9mr3391390agj.69.1257986254045;
	Wed, 11 Nov 2009 16:37:34 -0800 (PST)
Received: from ?192.168.2.217? ([65.28.92.235])
	by mx.google.com with ESMTPS id 4sm1044525yxd.70.2009.11.11.16.37.32
	(version=SSLv3 cipher=RC4-MD5); Wed, 11 Nov 2009 16:37:33 -0800 (PST)
Message-ID: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">4AFB58CC.6010807 at lwfinger.net</A>&gt;
Date: Wed, 11 Nov 2009 18:37:32 -0600
From: Larry Finger &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">Larry.Finger at lwfinger.net</A>&gt;
User-Agent: Mozilla/5.0 (X11; U; Linux x86_64; en-US;
	rv:1.9.1.4pre) Gecko/20090915 SUSE/3.0b4-3.6 Thunderbird/3.0b4
MIME-Version: 1.0
To: Andrew Benton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">b3nton at gmail.com</A>&gt;
Subject: Re: b43-phy0 ERROR: Fatal DMA error: 0x00000400
References: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">4AFA09C8.4060602 at gmail.com</A>&gt;
In-Reply-To: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">4AFA09C8.4060602 at gmail.com</A>&gt;
Cc: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>,
 Michael Buesch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">mb at bu3sch.de</A>&gt;
X-BeenThere: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>
X-Mailman-Version: 2.1.9
Precedence: list
List-Id: &lt;bcm43xx-dev.lists.berlios.de&gt;
List-Unsubscribe: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">https://lists.berlios.de/mailman/listinfo/bcm43xx-dev</A>&gt;,
	&lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-request at lists.berlios.de</A>?subject=unsubscribe&gt;
List-Archive: &lt;<A HREF="https://lists.berlios.de/pipermail/bcm43xx-dev">https://lists.berlios.de/pipermail/bcm43xx-dev</A>&gt;
List-Post: &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev at lists.berlios.de</A>&gt;
List-Help: &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-request at lists.berlios.de</A>?subject=help&gt;
List-Subscribe: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">https://lists.berlios.de/mailman/listinfo/bcm43xx-dev</A>&gt;,
	&lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-request at lists.berlios.de</A>?subject=subscribe&gt;
Content-Type: text/plain;
  charset=&quot;us-ascii&quot;
Content-Transfer-Encoding: 7bit
Sender: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-bounces at lists.berlios.de</A>
Errors-To: <A HREF="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">bcm43xx-dev-bounces at lists.berlios.de</A>
X-Length: 6628
X-UID: 8122

Andy,

Please try the patch below to see what we can learn from the DMA descriptor
errors. Some of this code is temporary, but there are also some statements that
will probably become permanent.

Please post any messages that result.

Larry


---
 drivers/net/wireless/b43/dma.c  |   32 ++++++++++++++++++++++++++++++++
 drivers/net/wireless/b43/dma.h  |    1 +
 drivers/net/wireless/b43/main.c |    1 +
 3 files changed, 34 insertions(+)

--- wireless-testing.orig/drivers/net/wireless/b43/dma.c
+++ wireless-testing/drivers/net/wireless/b43/dma.c
@@ -46,6 +46,8 @@
  * into separate slots. */
 #define TX_SLOTS_PER_FRAME	2
 
+int dma_point = 0;
+struct b43_dmadesc_generic dma_desc_save[20];
 
 /* 32bit DMA ops. */
 static
@@ -190,6 +192,12 @@ static void op64_fill_descriptor(struct 
 	desc-&gt;dma64.control1 = cpu_to_le32(ctl1);
 	desc-&gt;dma64.address_low = cpu_to_le32(addrlo);
 	desc-&gt;dma64.address_high = cpu_to_le32(addrhi);
+	dma_desc_save[dma_point].dma64.control0 = desc-&gt;dma64.control0;
+	dma_desc_save[dma_point].dma64.control1 = desc-&gt;dma64.control1;
+	dma_desc_save[dma_point].dma64.address_low = desc-&gt;dma64.address_low;
+	dma_desc_save[dma_point].dma64.address_high = desc-&gt;dma64.address_high;
+	if (++dma_point &gt;= 20)
+		dma_point = 0;
 }
 
 static void op64_poke_tx(struct b43_dmaring *ring, int slot)
@@ -1216,8 +1224,11 @@ static int dma_tx_fragment(struct b43_dm
 	meta-&gt;dmaaddr = map_descbuffer(ring, skb-&gt;data, skb-&gt;len, 1);
 	/* create a bounce buffer in zone_dma on mapping failure. */
 	if (b43_dma_mapping_error(ring, meta-&gt;dmaaddr, skb-&gt;len, 1)) {
+		printk(KERN_INFO &quot;b43: Using bounce buffer\n&quot;);
 		priv_info-&gt;bouncebuffer = kmalloc(skb-&gt;len, GFP_ATOMIC | GFP_DMA);
 		if (!priv_info-&gt;bouncebuffer) {
+			b43warn(ring-&gt;dev-&gt;wl, &quot;Bounce buffer allocation &quot;
+				&quot;failed\n&quot;);
 			ring-&gt;current_slot = old_top_slot;
 			ring-&gt;used_slots = old_used_slots;
 			err = -ENOMEM;
@@ -1227,6 +1238,8 @@ static int dma_tx_fragment(struct b43_dm
 
 		meta-&gt;dmaaddr = map_descbuffer(ring, priv_info-&gt;bouncebuffer, skb-&gt;len, 1);
 		if (b43_dma_mapping_error(ring, meta-&gt;dmaaddr, skb-&gt;len, 1)) {
+			b43warn(ring-&gt;dev-&gt;wl, &quot;DMA mapping error for bounce &quot;
+				&quot;buffer\n&quot;);
 			kfree(priv_info-&gt;bouncebuffer);
 			priv_info-&gt;bouncebuffer = NULL;
 			ring-&gt;current_slot = old_top_slot;
@@ -1612,6 +1625,25 @@ void b43_dma_tx_resume(struct b43_wldev 
 	b43_power_saving_ctl_bits(dev, 0);
 }
 
+void b43_dump_desc_buffer(void)
+{
+	/* dump the descriptor buffer once */
+	int i, j = dma_point;
+	static int once = 0;
+
+	if (once)
+		return;
+	printk(KERN_INFO &quot;b43: Dump of last 20 DMA descriptors\n&quot;);
+	for (i = 0; i &lt; 20; i++) {
+		if (--j &lt; 0)
+			j = 19;
+		printk(KERN_INFO &quot;b43: Descr. %2d: 0x%x 0x%X 0x%X 0x%X\n&quot;, i,
+		       dma_desc_save[j].dma64.control0, dma_desc_save[j].dma64.control1,
+		       dma_desc_save[j].dma64.address_low, dma_desc_save[j].dma64.address_high);
+	}
+	once++;
+}
+
 #ifdef CONFIG_B43_PIO
 static void direct_fifo_rx(struct b43_wldev *dev, enum b43_dmatype type,
 			   u16 mmio_base, bool enable)
--- wireless-testing.orig/drivers/net/wireless/b43/dma.h
+++ wireless-testing/drivers/net/wireless/b43/dma.h
@@ -287,4 +287,5 @@ void b43_dma_rx(struct b43_dmaring *ring
 void b43_dma_direct_fifo_rx(struct b43_wldev *dev,
 			    unsigned int engine_index, bool enable);
 
+void b43_dump_desc_buffer(void);
 #endif /* B43_DMA_H_ */
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -1785,6 +1785,7 @@ static void b43_do_interrupt_thread(stru
 			       dma_reason[2], dma_reason[3],
 			       dma_reason[4], dma_reason[5]);
 			b43_controller_restart(dev, &quot;DMA error&quot;);
+			b43_dump_desc_buffer();
 			return;
 		}
 		if (merged_dma_reason &amp; B43_DMAIRQ_NONFATALMASK) {

-- 
Greetings, Michael.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006287.html">b43-phy0 ERROR: Fatal DMA error: 0x00000400
</A></li>
	<LI>Next message: <A HREF="006289.html">b43-phy0 ERROR: Fatal DMA error: 0x00000400
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6288">[ date ]</a>
              <a href="thread.html#6288">[ thread ]</a>
              <a href="subject.html#6288">[ subject ]</a>
              <a href="author.html#6288">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/bcm43xx-dev">More information about the Bcm43xx-dev
mailing list</a><br>
</body></html>
