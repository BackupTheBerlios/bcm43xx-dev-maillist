From john at betelgeuse.us  Fri Jun  1 00:59:18 2007
From: john at betelgeuse.us (John W. M. Stevens)
Date: Thu, 31 May 2007 16:59:18 -0600
Subject: Compaq Presario F557US
In-Reply-To: <20070531131030.6db879ff@powerbook.oakcourt.dyndns.org>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>
	<20070531170237.GA23244@morningstar.betelgeuse.us>
	<20070531131030.6db879ff@powerbook.oakcourt.dyndns.org>
Message-ID: <1180652358.25555.4.camel@morningstar.betelgeuse.us>

On Thu, 2007-05-31 at 13:10 -0400, Andrew J. Barr wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
> 
> On Thu, 31 May 2007 11:02:37 -0600
> "John W. M. Stevens" <john at betelgeuse.us> wrote:
>  
> > Sorry, the input file is either wrong or not supported by
> > bcm43xx-fwcutter. This file has an unknown MD5sum
> > 162475477be5af17346b430446ebdd9d
> 
> ...
> 
> > The above message (with different md5sums) was printed out when
> > attempting to use the tool against *all* of the files extracted from
> > sp34488.exe.
> 
> You need to run it against bcmwl5.sys, if I remember correctly.

That would have been included in the set of all, I would think.  ;-)

I tried the tool on all files in the package just to avoid wasting
the lists time on questions like "Did you run the tool on the
right file?"

That said, there is no bcmwl5.sys file in the sp34488.exe

There is a bcmwl6.sys and a bcmwl664.sys file.

> How far are you from your AP?

Six inches from the lid of laptop to the antennas on the WAP.

The wireless signal detector doesn't even blip when I try to run
traffic over the link.

I'm pretty sure the transmitter power is set to such a low value,
or that that transmitter is off, that it is effectively not
tranmitting.

Receiving, yes, but not transmitting.

Thanks,
-- 
John W. M. Stevens <john at betelgeuse.us>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070531/252f6bcd/attachment.pgp>

From john at betelgeuse.us  Fri Jun  1 01:13:03 2007
From: john at betelgeuse.us (John W. M. Stevens)
Date: Thu, 31 May 2007 17:13:03 -0600
Subject: Compaq Presario F557US
In-Reply-To: <20070531172747.GA3496@tuba>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>
	<20070531170237.GA23244@morningstar.betelgeuse.us>
	<20070531131030.6db879ff@powerbook.oakcourt.dyndns.org>
	<20070531172747.GA3496@tuba>
Message-ID: <1180653183.25555.13.camel@morningstar.betelgeuse.us>

On Thu, 2007-05-31 at 19:27 +0200, Martin Langer wrote:
> On Thu, May 31, 2007 at 01:10:30PM -0400, Andrew J. Barr wrote:
> > On Thu, 31 May 2007 11:02:37 -0600
> > "John W. M. Stevens" <john at betelgeuse.us> wrote:
> >  
> > > Sorry, the input file is either wrong or not supported by
> > > bcm43xx-fwcutter. This file has an unknown MD5sum
> > > 162475477be5af17346b430446ebdd9d
> > 
> > ...
> > 
> > > The above message (with different md5sums) was printed out when
> > > attempting to use the tool against *all* of the files extracted from
> > > sp34488.exe.
> > 
> > You need to run it against bcmwl5.sys, if I remember correctly.
> 
> Nope. There it's either bcmwl6.sys or bcmwl664.sys. I think that 
> Broadcom increased it from bcmwl5.sys to bcmwl6.sys for the Vista line.
> 
> Nevertheless, the driver file is already supported by the SVN version.
> 
>   filename   :  bcmwl664.sys
>   version    :  4.102.15.61
>   MD5        :  97f98e5e6a83585e42b1e1e15716aae8
>   microcodes :  4 5 11 13
>   pcms       :  4 5

I will use svn top of trunk, then.  I was using the stable version (6).

Thanks,
-- 
John W. M. Stevens <john at betelgeuse.us>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070531/a3ec7d3a/attachment.pgp>

From mb at bu3sch.de  Fri Jun  1 01:15:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 1 Jun 2007 01:15:13 +0200
Subject: Compaq Presario F557US
In-Reply-To: <1180653183.25555.13.camel@morningstar.betelgeuse.us>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531172747.GA3496@tuba>
	<1180653183.25555.13.camel@morningstar.betelgeuse.us>
Message-ID: <200706010115.13194.mb@bu3sch.de>

On Friday 01 June 2007 01:13:03 John W. M. Stevens wrote:
> On Thu, 2007-05-31 at 19:27 +0200, Martin Langer wrote:
> > On Thu, May 31, 2007 at 01:10:30PM -0400, Andrew J. Barr wrote:
> > > On Thu, 31 May 2007 11:02:37 -0600
> > > "John W. M. Stevens" <john at betelgeuse.us> wrote:
> > >  
> > > > Sorry, the input file is either wrong or not supported by
> > > > bcm43xx-fwcutter. This file has an unknown MD5sum
> > > > 162475477be5af17346b430446ebdd9d
> > > 
> > > ...
> > > 
> > > > The above message (with different md5sums) was printed out when
> > > > attempting to use the tool against *all* of the files extracted from
> > > > sp34488.exe.
> > > 
> > > You need to run it against bcmwl5.sys, if I remember correctly.
> > 
> > Nope. There it's either bcmwl6.sys or bcmwl664.sys. I think that 
> > Broadcom increased it from bcmwl5.sys to bcmwl6.sys for the Vista line.
> > 
> > Nevertheless, the driver file is already supported by the SVN version.
> > 
> >   filename   :  bcmwl664.sys
> >   version    :  4.102.15.61
> >   MD5        :  97f98e5e6a83585e42b1e1e15716aae8
> >   microcodes :  4 5 11 13
> >   pcms       :  4 5
> 
> I will use svn top of trunk, then.  I was using the stable version (6).

Don't use any firmware not supported by the stable fwcutter releases,
as it's not supported by the driver.

-- 
Greetings Michael.


From john at betelgeuse.us  Fri Jun  1 01:16:50 2007
From: john at betelgeuse.us (John W. M. Stevens)
Date: Thu, 31 May 2007 17:16:50 -0600
Subject: Compaq Presario F557US
In-Reply-To: <465F149D.7070503@lwfinger.net>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>
	<20070531170237.GA23244@morningstar.betelgeuse.us>
	<465F149D.7070503@lwfinger.net>
Message-ID: <1180653410.25555.17.camel@morningstar.betelgeuse.us>

On Thu, 2007-05-31 at 13:31 -0500, Larry Finger wrote:
> John W. M. Stevens wrote:
> > These are all the messages from dmesg buffer containing the string: bcm43xx.
> > 
> > bcm43xx driver
> > bcm43xx: Chip ID 0x4311, rev 0x1
> > bcm43xx: Number of cores: 4
> > bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> > bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> > bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> > bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> > bcm43xx: PHY connected
> > bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
> > bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> > bcm43xx: Radio turned off
> > bcm43xx: Radio turned off
> > bcm43xx: set security called, .active_key = 0, .level = 1, .enabled = 1, .encrypt = 1
> > bcm43xx: PHY connected
> > bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> > bcm43xx: Radio turned on
> > bcm43xx: Radio enabled by hardware
> > bcm43xx: Chip initialized
> > bcm43xx: 32-bit DMA initialized
> > bcm43xx: Keys cleared
> > bcm43xx: Selected 802.11 core (phytype 2)
> > bcm43xx: Radio turned off
> > bcm43xx: DMA-32 0x0200 (RX) max used slots: 14/64
> > bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> > bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> > bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> > bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> > bcm43xx: DMA-32 0x0220 (TX) max used slots: 4/512
> > bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> > bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> > bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> > bcm43xx: Radio turned on
> > bcm43xx: Radio enabled by hardware
> > bcm43xx: Chip initialized
> > bcm43xx: 32-bit DMA initialized
> > bcm43xx: Keys cleared
> > bcm43xx: Selected 802.11 core (phytype 2)
> 
> Your card is exactly what I have. The firmware you have loaded is the very latest version that is 
> supported by the mainline version of bcm43xx. For maximum transmit strength, you should either 
> switch to kernel 2.6.22-rc3 of install the patch found in 
> ftp://lwfinger.dynalias.org/patches/combined_2.6.21.patch. The changes are important.

Will this patch be compatible with the version 4 firmware, or should I
try to dig up a package that contains version 3 firmware?  If version 3
firmware is what I should be using, can you tell me where to get the
package that contains the firmware that you are using?

Thanks,
-- 
John W. M. Stevens <john at betelgeuse.us>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070531/107d44ab/attachment.pgp>

From andrew.james.barr at gmail.com  Fri Jun  1 01:18:36 2007
From: andrew.james.barr at gmail.com (Andrew J. Barr)
Date: Thu, 31 May 2007 19:18:36 -0400
Subject: Compaq Presario F557US
In-Reply-To: <1180652358.25555.4.camel@morningstar.betelgeuse.us>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>
	<20070531170237.GA23244@morningstar.betelgeuse.us>
	<20070531131030.6db879ff@powerbook.oakcourt.dyndns.org>
	<1180652358.25555.4.camel@morningstar.betelgeuse.us>
Message-ID: <20070531191836.1a77a27f@powerbook.oakcourt.dyndns.org>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Thu, 31 May 2007 16:59:18 -0600
"John W. M. Stevens" <john at betelgeuse.us> wrote:
> > How far are you from your AP?
> 
> Six inches from the lid of laptop to the antennas on the WAP.
> 
> The wireless signal detector doesn't even blip when I try to run
> traffic over the link.

I forgot about the patches mentioned earlier in this thread. Get those
or upgrade to 2.6.22-rcX (X=3 at the moment), that will almost
certainly solve your woes.

To get the firmware from your vendor's driver you need the SVN version
of fwcutter. However, I would recommend, if you're using Debian,
allowing debconf to fetch it for you or googling for wl_apsta.o and
using that firmware. There's only two big versions out there: version 3
and version 4. Unless you are using a kernel built from wireless-dev
(hint: if you don't know then you're not) and/or using the mac80211
driver, then you almost certainly want version 3, which is available
from the wl_apsta.o object code file.

I don't know what the bcmwl6.sys Vista driver has in the way of
firmware, if I were you I'd treat that as an unknown quantity and stay
away from it.

- -- 
Andrew J. Barr
X-Mailer: Claws Mail 2.9.2 (GTK+ 2.10.12; powerpc-unknown-linux-gnu)

"The plural of anecdote is not evidence."
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFGX1fMhuM+Z62a52oRAgKvAKCn9xwhkW8XM4S1CZjp/BDBD8Hb8gCgh6r9
dZFlsjioIM5qDYJBS9CZycY=
=mKQU
-----END PGP SIGNATURE-----

From larry.finger at lwfinger.net  Fri Jun  1 02:55:43 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 31 May 2007 19:55:43 -0500
Subject: Compaq Presario F557US
In-Reply-To: <1180653410.25555.17.camel@morningstar.betelgeuse.us>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>	
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>	
	<20070531170237.GA23244@morningstar.betelgeuse.us>	
	<465F149D.7070503@lwfinger.net>
	<1180653410.25555.17.camel@morningstar.betelgeuse.us>
Message-ID: <465F6E8F.8010002@lwfinger.net>

John W. M. Stevens wrote:
> On Thu, 2007-05-31 at 13:31 -0500, Larry Finger wrote:
>> John W. M. Stevens wrote:
>>> These are all the messages from dmesg buffer containing the string: bcm43xx.
>>>
>>> bcm43xx driver
>>> bcm43xx: Chip ID 0x4311, rev 0x1
>>> bcm43xx: Number of cores: 4
>>> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
>>> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
>>> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
>>> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
>>> bcm43xx: PHY connected
>>> bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
>>> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
>>> bcm43xx: Radio turned off
>>> bcm43xx: Radio turned off
>>> bcm43xx: set security called, .active_key = 0, .level = 1, .enabled = 1, .encrypt = 1
>>> bcm43xx: PHY connected
>>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>>> bcm43xx: Radio turned on
>>> bcm43xx: Radio enabled by hardware
>>> bcm43xx: Chip initialized
>>> bcm43xx: 32-bit DMA initialized
>>> bcm43xx: Keys cleared
>>> bcm43xx: Selected 802.11 core (phytype 2)
>>> bcm43xx: Radio turned off
>>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 14/64
>>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 4/512
>>> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
>>> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
>>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>>> bcm43xx: Radio turned on
>>> bcm43xx: Radio enabled by hardware
>>> bcm43xx: Chip initialized
>>> bcm43xx: 32-bit DMA initialized
>>> bcm43xx: Keys cleared
>>> bcm43xx: Selected 802.11 core (phytype 2)
>> Your card is exactly what I have. The firmware you have loaded is the very latest version that is 
>> supported by the mainline version of bcm43xx. For maximum transmit strength, you should either 
>> switch to kernel 2.6.22-rc3 of install the patch found in 
>> ftp://lwfinger.dynalias.org/patches/combined_2.6.21.patch. The changes are important.
> 
> Will this patch be compatible with the version 4 firmware, or should I
> try to dig up a package that contains version 3 firmware?  If version 3
> firmware is what I should be using, can you tell me where to get the
> package that contains the firmware that you are using?

The in-kernel version of bcm43xx _ONLY_ works with V3 firmware. As I stated earlier, you already 
have the latest version of the firmware that works with this version of the driver. FYI, the driver 
that uses V4 firmware has worse transmit power for the 4311 than the one that you are trying to use. 
In addition, it doesn't receive as well. For example, with my BCM4311 located about 2 m from my AP, 
I routinely run at 36 Mbs with iperf rates about 12/15 Mbs for transmitting and receiving. With 
bcm43xx-mac80211 (the driver that uses V4 firmware), I get about 1-2 Mbs throughput. The automatic 
rate-changing mechanism usually runs my interface at 1 Mbs.

Larry


From john at betelgeuse.us  Fri Jun  1 00:08:56 2007
From: john at betelgeuse.us (john)
Date: Thu, 31 May 2007 16:08:56 -0600
Subject: Compaq Presario F557US
In-Reply-To: <465F6E8F.8010002@lwfinger.net>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>
	<20070531170237.GA23244@morningstar.betelgeuse.us>
	<465F149D.7070503@lwfinger.net>
	<1180653410.25555.17.camel@morningstar.betelgeuse.us>
	<465F6E8F.8010002@lwfinger.net>
Message-ID: <1180649336.4782.2.camel@rigel>

On Thu, 2007-05-31 at 19:55 -0500, Larry Finger wrote:
> The in-kernel version of bcm43xx _ONLY_ works with V3 firmware. As I stated earlier, you already 
> have the latest version of the firmware that works with this version of the driver. FYI, the driver 
> that uses V4 firmware has worse transmit power for the 4311 than the one that you are trying to use. 
> In addition, it doesn't receive as well. For example, with my BCM4311 located about 2 m from my AP, 
> I routinely run at 36 Mbs with iperf rates about 12/15 Mbs for transmitting and receiving. With 
> bcm43xx-mac80211 (the driver that uses V4 firmware), I get about 1-2 Mbs throughput. The automatic 
> rate-changing mechanism usually runs my interface at 1 Mbs.

Success!  Using linux 2.6.21 and your patch, I'm sending this email from
the laptop over the wireless link.

Many thanks for all the help and suggestions,
John S.



From larry.finger at lwfinger.net  Fri Jun  1 06:43:31 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 31 May 2007 23:43:31 -0500
Subject: Compaq Presario F557US
In-Reply-To: <1180649336.4782.2.camel@rigel>
References: <20070531155414.GA21433@morningstar.betelgeuse.us>	
	<20070531124935.3baad3db@powerbook.oakcourt.dyndns.org>	
	<20070531170237.GA23244@morningstar.betelgeuse.us>	
	<465F149D.7070503@lwfinger.net>	
	<1180653410.25555.17.camel@morningstar.betelgeuse.us>	
	<465F6E8F.8010002@lwfinger.net> <1180649336.4782.2.camel@rigel>
Message-ID: <465FA3F3.9030707@lwfinger.net>

john wrote:
> 
> Success!  Using linux 2.6.21 and your patch, I'm sending this email from
> the laptop over the wireless link.
> 
> Many thanks for all the help and suggestions,

Congratulations. The fixes added between 2.6.21 and 2.6.22 are quite important.

Larry



From Larry.Finger at lwfinger.net  Fri Jun  1 07:23:37 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 00:23:37 -0500
Subject: Curious result for bcm43xx-mac80211
Message-ID: <465FAD59.7020302@lwfinger.net>

When debugging the SIOCSIWRATE routine, I have issued numerous 'iwconfig' commands to see if my code 
is working correctly. When doing so, I noticed that the signal level is usually at -48 dBm, but that 
it would jump up to much higher values on occasion. In the automatic speed mode, these higher values 
result in faster speeds. In order to determine which parameters were affecting these values, I added 
code to dump the value of status.ssi in bcm43xx_xmit.c and a number of parameters. Because of a 
difference in scaling, the -48 from iwconfig corresponds to a value of -63 in status.ssi.

The most significant finding so far is that status.ssi is -63 whenever the so-called 'F-offset' in 
RX Status 2 is non-zero. If the F-offset is zero, status.ssi is at least -24 and may be as high as 
-9. The other parts of RX Status 2 are listed as 'LNA gain' and 'PNA gain'. They seem not to affect 
the ssi value.

I would appreciate any hints as to where the code sets values that would cause what I see, or any 
guesses as to the meaning of F-offset.

Thanks,

Larry


From yangtze31 at gmail.com  Fri Jun  1 10:05:15 2007
From: yangtze31 at gmail.com (Bin Zhang)
Date: Fri, 1 Jun 2007 10:05:15 +0200
Subject: bcm4306 mini pci trouble
In-Reply-To: <51ad2e0d0705310208w1ac73faet4c8950b717e2ff48@mail.gmail.com>
References: <20070530220729.1cd2c883@localhost>
	<200705302246.50543.mb@bu3sch.de> <465DE6F0.2040902@lwfinger.net>
	<200705302305.38803.mb@bu3sch.de> <20070531082102.58e9b958@localhost>
	<20070531094140.53552966@localhost>
	<51ad2e0d0705310208w1ac73faet4c8950b717e2ff48@mail.gmail.com>
Message-ID: <51ad2e0d0706010105x6bf16391p485a28288268d04f@mail.gmail.com>

On 5/31/07, Bin Zhang <yangtze31 at gmail.com> wrote:
> I have a 4306 card:
> 0001:10:12.0 Network controller: Broadcom Corporation BCM4306
> 802.11b/g Wireless LAN Controller (rev 03)
>
> bcm43xx_mac80211 stops working with wireless-dev git  29 May 2007.
> bcm43xx works.

With today's wireless-dev, maybe my problem is in dhcp-client.

Using dhcp, can't connect:
-------------------------------
Jun  1 09:39:12 localhost kernel: PCI: Enabling device 0001:10:12.0
(0004 -> 0006)
Jun  1 09:39:12 localhost kernel: ssb: Core 0 found: ChipCommon (cc
0x800, rev 0x04, vendor 0x4243)
Jun  1 09:39:12 localhost kernel: ssb: Core 1 found: IEEE 802.11 (cc
0x812, rev 0x05, vendor 0x4243)
Jun  1 09:39:12 localhost kernel: ssb: Core 2 found: PCMCIA (cc 0x80D,
rev 0x02, vendor 0x4243)
Jun  1 09:39:12 localhost kernel: ssb: Core 3 found: V90 (cc 0x807,
rev 0x02, vendor 0x4243)
Jun  1 09:39:12 localhost kernel: ssb: Core 4 found: PCI (cc 0x804,
rev 0x09, vendor 0x4243)
Jun  1 09:39:12 localhost kernel: ssb: Switching to ChipCommon core, index 0
Jun  1 09:39:12 localhost kernel: ssb: Switching to PCI core, index 4
Jun  1 09:39:12 localhost kernel: ssb: Sonics Silicon Backplane found
on PCI device 0001:10:12.0
Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Broadcom 4306 WLAN found
Jun  1 09:39:12 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found PHY: Analog
2, Type 2, Revision 2
Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found Radio: Manuf
0x17F, Version 0x2050, Revision 2
Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Radio turned off
Jun  1 09:39:12 localhost kernel: Device driver phy0 lacks bus and
class support for being resumed.
Jun  1 09:39:12 localhost kernel: Device driver wmaster0 lacks bus and
class support for being resumed.
Jun  1 09:39:12 localhost kernel: wmaster0: Selected rate control
algorithm 'simple'
Jun  1 09:39:12 localhost kernel: Device driver wlan0 lacks bus and
class support for being resumed.
Jun  1 09:39:13 localhost kernel: bcm43xx_mac80211: Adding Interface type 2
Jun  1 09:39:13 localhost kernel: ssb: Switching to PCI core, index 4
Jun  1 09:39:13 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
Jun  1 09:39:13 localhost kernel: Device driver ssb0:0 lacks bus and
class support for being resumed.
Jun  1 09:39:13 localhost last message repeated 3 times
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Loading firmware
version 351.126 (2006-07-29 05:54:02)
Jun  1 09:39:14 localhost kernel: ssb: Switching to ChipCommon core, index 0
Jun  1 09:39:14 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio turned on
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio enabled by hardware
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: !WARNING!
Idle-TSSI phy->cur_idle_tssi measuring failed. (cur=0, tgt=62).
Disabling TX power adjustment.
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Chip initialized
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: 30-bit DMA initialized
Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Wireless interface started
Jun  1 09:39:14 localhost kernel: ADDRCONF(NETDEV_UP): wlan0: link is not ready
Jun  1 09:39:15 localhost dhclient: Internet Systems Consortium DHCP
Client V3.0.4
Jun  1 09:39:15 localhost dhclient: Copyright 2004-2006 Internet
Systems Consortium.
Jun  1 09:39:15 localhost dhclient: All rights reserved.
Jun  1 09:39:15 localhost dhclient: For info, please visit
http://www.isc.org/sw/dhcp/
Jun  1 09:39:15 localhost dhclient:
Jun  1 09:39:15 localhost dhclient: wmaster0: unknown hardware address type 801
Jun  1 09:39:16 localhost kernel: wlan0: Initial auth_alg=0
Jun  1 09:39:16 localhost kernel: wlan0: authenticate with AP 00:11:95:36:fc:f7
Jun  1 09:39:16 localhost kernel: wlan0: RX authentication from
00:11:95:36:fc:f7 (alg=0 transaction=2 status=0)
Jun  1 09:39:16 localhost kernel: wlan0: authenticated
Jun  1 09:39:16 localhost kernel: wlan0: associate with AP 00:11:95:36:fc:f7
Jun  1 09:39:16 localhost kernel: wlan0: RX AssocResp from
00:11:95:36:fc:f7 (capab=0x471 status=0 aid=1)
Jun  1 09:39:16 localhost kernel: wlan0: associated
Jun  1 09:39:16 localhost kernel: ADDRCONF(NETDEV_CHANGE): wlan0: link
becomes ready
Jun  1 09:39:16 localhost dhclient: wmaster0: unknown hardware address type 801
Jun  1 09:39:16 localhost dhclient: Listening on LPF/wlan0/00:11:24:22:f5:04
Jun  1 09:39:16 localhost dhclient: Sending on   LPF/wlan0/00:11:24:22:f5:04
Jun  1 09:39:16 localhost dhclient: Sending on   Socket/fallback
Jun  1 09:39:16 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 5
Jun  1 09:39:21 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 5
Jun  1 09:39:26 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 8
Jun  1 09:39:26 localhost kernel: wlan0: no IPv6 routers present
Jun  1 09:39:34 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 15
Jun  1 09:39:49 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 8
Jun  1 09:39:57 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 12
Jun  1 09:40:09 localhost dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 8
Jun  1 09:40:17 localhost dhclient: No DHCPOFFERS received.
Jun  1 09:40:17 localhost dhclient: No working leases in persistent
database - sleeping.
-------------------------------------------

Using ip static, the driver works fine.
A test using http://mire.ipadsl.net/speedtest.php :
ethernet: 446.961 Ko/sec
bcm43xx: 459.84 Ko/sec
bcm43xx-mac80211: 478.147 Ko/sec


Thanks and best regards,
Bin


From markus at unixforces.net  Fri Jun  1 10:56:54 2007
From: markus at unixforces.net (Markus Rothe)
Date: Fri, 1 Jun 2007 10:56:54 +0200
Subject: bcm4306 mini pci trouble
In-Reply-To: <20070530220729.1cd2c883@localhost>
References: <20070530220729.1cd2c883@localhost>
Message-ID: <20070601105654.6374be7d@localhost>

On Wed, 30 May 2007 22:07:29 +0200,
Markus Rothe <markus at unixforces.net> wrote:
> I'm trying to use bcm43xx_mac80211 module from wireless-dev git
> (checked out today). Unfortunately I've some problems. The device is
> not recognized. I cannot "ifconfig ethx up" for example.
> 
> From dmesg:
> 
> [...]
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x04, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x05, vendor 0x4243)
> ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x02, vendor 0x4243)
> ssb: Core 3 found: V90 (cc 0x807, rev 0x02, vendor 0x4243)
> ssb: Core 4 found: PCI (cc 0x804, rev 0x09, vendor 0x4243)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to PCI core, index 4
> ssb: Sonics Silicon Backplane found on PCI device 0000:02:03.0
> bcm43xx_mac80211: Broadcom 4306 WLAN found
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_mac80211: Found PHY: Analog 2, Type 2, Revision 2
> bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> bcm43xx_mac80211: Radio turned off
> wmaster0: Failed to select rate control algorithm
> wmaster0: Failed to initialize rate control algorithm
> bcm43xx_mac80211: probe of ssb0:0 failed with error -2

For the record: I had to enable module autoload support. Then
rc80211-simple loads automatically.

Regards,

Markus Rothe


From larry.finger at lwfinger.net  Fri Jun  1 14:49:21 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 07:49:21 -0500
Subject: bcm4306 mini pci trouble
In-Reply-To: <51ad2e0d0706010105x6bf16391p485a28288268d04f@mail.gmail.com>
References: <20070530220729.1cd2c883@localhost>	<200705302246.50543.mb@bu3sch.de>
	<465DE6F0.2040902@lwfinger.net>	<200705302305.38803.mb@bu3sch.de>
	<20070531082102.58e9b958@localhost>	<20070531094140.53552966@localhost>	<51ad2e0d0705310208w1ac73faet4c8950b717e2ff48@mail.gmail.com>
	<51ad2e0d0706010105x6bf16391p485a28288268d04f@mail.gmail.com>
Message-ID: <466015D1.9090608@lwfinger.net>

Bin Zhang wrote:
> On 5/31/07, Bin Zhang <yangtze31 at gmail.com> wrote:
>> I have a 4306 card:
>> 0001:10:12.0 Network controller: Broadcom Corporation BCM4306
>> 802.11b/g Wireless LAN Controller (rev 03)
>>
>> bcm43xx_mac80211 stops working with wireless-dev git  29 May 2007.
>> bcm43xx works.
> 
> With today's wireless-dev, maybe my problem is in dhcp-client.
> 
> Using dhcp, can't connect:
> -------------------------------
> Jun  1 09:39:12 localhost kernel: PCI: Enabling device 0001:10:12.0
> (0004 -> 0006)
> Jun  1 09:39:12 localhost kernel: ssb: Core 0 found: ChipCommon (cc
> 0x800, rev 0x04, vendor 0x4243)
> Jun  1 09:39:12 localhost kernel: ssb: Core 1 found: IEEE 802.11 (cc
> 0x812, rev 0x05, vendor 0x4243)
> Jun  1 09:39:12 localhost kernel: ssb: Core 2 found: PCMCIA (cc 0x80D,
> rev 0x02, vendor 0x4243)
> Jun  1 09:39:12 localhost kernel: ssb: Core 3 found: V90 (cc 0x807,
> rev 0x02, vendor 0x4243)
> Jun  1 09:39:12 localhost kernel: ssb: Core 4 found: PCI (cc 0x804,
> rev 0x09, vendor 0x4243)
> Jun  1 09:39:12 localhost kernel: ssb: Switching to ChipCommon core, index 0
> Jun  1 09:39:12 localhost kernel: ssb: Switching to PCI core, index 4
> Jun  1 09:39:12 localhost kernel: ssb: Sonics Silicon Backplane found
> on PCI device 0001:10:12.0
> Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Broadcom 4306 WLAN found
> Jun  1 09:39:12 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found PHY: Analog
> 2, Type 2, Revision 2
> Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found Radio: Manuf
> 0x17F, Version 0x2050, Revision 2
> Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Radio turned off
> Jun  1 09:39:12 localhost kernel: Device driver phy0 lacks bus and
> class support for being resumed.
> Jun  1 09:39:12 localhost kernel: Device driver wmaster0 lacks bus and
> class support for being resumed.
> Jun  1 09:39:12 localhost kernel: wmaster0: Selected rate control
> algorithm 'simple'
> Jun  1 09:39:12 localhost kernel: Device driver wlan0 lacks bus and
> class support for being resumed.
> Jun  1 09:39:13 localhost kernel: bcm43xx_mac80211: Adding Interface type 2
> Jun  1 09:39:13 localhost kernel: ssb: Switching to PCI core, index 4
> Jun  1 09:39:13 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> Jun  1 09:39:13 localhost kernel: Device driver ssb0:0 lacks bus and
> class support for being resumed.
> Jun  1 09:39:13 localhost last message repeated 3 times
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Loading firmware
> version 351.126 (2006-07-29 05:54:02)
> Jun  1 09:39:14 localhost kernel: ssb: Switching to ChipCommon core, index 0
> Jun  1 09:39:14 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio turned on
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio enabled by hardware
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: !WARNING!
> Idle-TSSI phy->cur_idle_tssi measuring failed. (cur=0, tgt=62).
> Disabling TX power adjustment.
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Chip initialized
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: 30-bit DMA initialized
> Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Wireless interface started
> Jun  1 09:39:14 localhost kernel: ADDRCONF(NETDEV_UP): wlan0: link is not ready
> Jun  1 09:39:15 localhost dhclient: Internet Systems Consortium DHCP
> Client V3.0.4
> Jun  1 09:39:15 localhost dhclient: Copyright 2004-2006 Internet
> Systems Consortium.
> Jun  1 09:39:15 localhost dhclient: All rights reserved.
> Jun  1 09:39:15 localhost dhclient: For info, please visit
> http://www.isc.org/sw/dhcp/
> Jun  1 09:39:15 localhost dhclient:
> Jun  1 09:39:15 localhost dhclient: wmaster0: unknown hardware address type 801
> Jun  1 09:39:16 localhost kernel: wlan0: Initial auth_alg=0
> Jun  1 09:39:16 localhost kernel: wlan0: authenticate with AP 00:11:95:36:fc:f7
> Jun  1 09:39:16 localhost kernel: wlan0: RX authentication from
> 00:11:95:36:fc:f7 (alg=0 transaction=2 status=0)
> Jun  1 09:39:16 localhost kernel: wlan0: authenticated
> Jun  1 09:39:16 localhost kernel: wlan0: associate with AP 00:11:95:36:fc:f7
> Jun  1 09:39:16 localhost kernel: wlan0: RX AssocResp from
> 00:11:95:36:fc:f7 (capab=0x471 status=0 aid=1)
> Jun  1 09:39:16 localhost kernel: wlan0: associated
> Jun  1 09:39:16 localhost kernel: ADDRCONF(NETDEV_CHANGE): wlan0: link
> becomes ready
> Jun  1 09:39:16 localhost dhclient: wmaster0: unknown hardware address type 801
> Jun  1 09:39:16 localhost dhclient: Listening on LPF/wlan0/00:11:24:22:f5:04
> Jun  1 09:39:16 localhost dhclient: Sending on   LPF/wlan0/00:11:24:22:f5:04
> Jun  1 09:39:16 localhost dhclient: Sending on   Socket/fallback
> Jun  1 09:39:16 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 5
> Jun  1 09:39:21 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 5
> Jun  1 09:39:26 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 8
> Jun  1 09:39:26 localhost kernel: wlan0: no IPv6 routers present
> Jun  1 09:39:34 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 15
> Jun  1 09:39:49 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 8
> Jun  1 09:39:57 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 12
> Jun  1 09:40:09 localhost dhclient: DHCPDISCOVER on wlan0 to
> 255.255.255.255 port 67 interval 8
> Jun  1 09:40:17 localhost dhclient: No DHCPOFFERS received.
> Jun  1 09:40:17 localhost dhclient: No working leases in persistent
> database - sleeping.
> -------------------------------------------
> 
> Using ip static, the driver works fine.
> A test using http://mire.ipadsl.net/speedtest.php :
> ethernet: 446.961 Ko/sec
> bcm43xx: 459.84 Ko/sec
> bcm43xx-mac80211: 478.147 Ko/sec

You certainly do a lot better than I do with mac80211 - your interface is driving the line at full 
rate. With bcm43xx-mac80211, I get 47 Ko/sec.

Your problem is one of signal strength. The reason that a static IP works and DHCP does not is that 
mac80211 sets the initial transmit rate at 54 Mbs. Yes, it does have a rate adjustment algorithm, 
but by the time the rate gets down to 1 Mbs, DHCP has already given up.

Since no one ever goes back to read the archives of this list, I will point you at a previous 
posting that has relevance: http://lists.berlios.de/pipermail/bcm43xx-dev/2007-April/004640.html. In 
that message, you will find a patch that sets the initial rate to 1 Mbs, which will allow your 
interface to make a DHCP connection. That change will never be put into mac80211, as it will not be 
needed once the bcm43xx driver is debugged.

Larry


From yangtze31 at gmail.com  Fri Jun  1 15:45:08 2007
From: yangtze31 at gmail.com (Bin Zhang)
Date: Fri, 1 Jun 2007 15:45:08 +0200
Subject: bcm4306 mini pci trouble
In-Reply-To: <466015D1.9090608@lwfinger.net>
References: <20070530220729.1cd2c883@localhost>
	<200705302246.50543.mb@bu3sch.de> <465DE6F0.2040902@lwfinger.net>
	<200705302305.38803.mb@bu3sch.de> <20070531082102.58e9b958@localhost>
	<20070531094140.53552966@localhost>
	<51ad2e0d0705310208w1ac73faet4c8950b717e2ff48@mail.gmail.com>
	<51ad2e0d0706010105x6bf16391p485a28288268d04f@mail.gmail.com>
	<466015D1.9090608@lwfinger.net>
Message-ID: <51ad2e0d0706010645y17435723v5852d0649741be12@mail.gmail.com>

On 6/1/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Bin Zhang wrote:
> > On 5/31/07, Bin Zhang <yangtze31 at gmail.com> wrote:
> >> I have a 4306 card:
> >> 0001:10:12.0 Network controller: Broadcom Corporation BCM4306
> >> 802.11b/g Wireless LAN Controller (rev 03)
> >>
> >> bcm43xx_mac80211 stops working with wireless-dev git  29 May 2007.
> >> bcm43xx works.
> >
> > With today's wireless-dev, maybe my problem is in dhcp-client.
> >
> > Using dhcp, can't connect:
> > -------------------------------
> > Jun  1 09:39:12 localhost kernel: PCI: Enabling device 0001:10:12.0
> > (0004 -> 0006)
> > Jun  1 09:39:12 localhost kernel: ssb: Core 0 found: ChipCommon (cc
> > 0x800, rev 0x04, vendor 0x4243)
> > Jun  1 09:39:12 localhost kernel: ssb: Core 1 found: IEEE 802.11 (cc
> > 0x812, rev 0x05, vendor 0x4243)
> > Jun  1 09:39:12 localhost kernel: ssb: Core 2 found: PCMCIA (cc 0x80D,
> > rev 0x02, vendor 0x4243)
> > Jun  1 09:39:12 localhost kernel: ssb: Core 3 found: V90 (cc 0x807,
> > rev 0x02, vendor 0x4243)
> > Jun  1 09:39:12 localhost kernel: ssb: Core 4 found: PCI (cc 0x804,
> > rev 0x09, vendor 0x4243)
> > Jun  1 09:39:12 localhost kernel: ssb: Switching to ChipCommon core, index 0
> > Jun  1 09:39:12 localhost kernel: ssb: Switching to PCI core, index 4
> > Jun  1 09:39:12 localhost kernel: ssb: Sonics Silicon Backplane found
> > on PCI device 0001:10:12.0
> > Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Broadcom 4306 WLAN found
> > Jun  1 09:39:12 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> > Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found PHY: Analog
> > 2, Type 2, Revision 2
> > Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Found Radio: Manuf
> > 0x17F, Version 0x2050, Revision 2
> > Jun  1 09:39:12 localhost kernel: bcm43xx_mac80211: Radio turned off
> > Jun  1 09:39:12 localhost kernel: Device driver phy0 lacks bus and
> > class support for being resumed.
> > Jun  1 09:39:12 localhost kernel: Device driver wmaster0 lacks bus and
> > class support for being resumed.
> > Jun  1 09:39:12 localhost kernel: wmaster0: Selected rate control
> > algorithm 'simple'
> > Jun  1 09:39:12 localhost kernel: Device driver wlan0 lacks bus and
> > class support for being resumed.
> > Jun  1 09:39:13 localhost kernel: bcm43xx_mac80211: Adding Interface type 2
> > Jun  1 09:39:13 localhost kernel: ssb: Switching to PCI core, index 4
> > Jun  1 09:39:13 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> > Jun  1 09:39:13 localhost kernel: Device driver ssb0:0 lacks bus and
> > class support for being resumed.
> > Jun  1 09:39:13 localhost last message repeated 3 times
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Loading firmware
> > version 351.126 (2006-07-29 05:54:02)
> > Jun  1 09:39:14 localhost kernel: ssb: Switching to ChipCommon core, index 0
> > Jun  1 09:39:14 localhost kernel: ssb: Switching to IEEE 802.11 core, index 1
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio turned on
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Radio enabled by hardware
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: !WARNING!
> > Idle-TSSI phy->cur_idle_tssi measuring failed. (cur=0, tgt=62).
> > Disabling TX power adjustment.
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Chip initialized
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: 30-bit DMA initialized
> > Jun  1 09:39:14 localhost kernel: bcm43xx_mac80211: Wireless interface started
> > Jun  1 09:39:14 localhost kernel: ADDRCONF(NETDEV_UP): wlan0: link is not ready
> > Jun  1 09:39:15 localhost dhclient: Internet Systems Consortium DHCP
> > Client V3.0.4
> > Jun  1 09:39:15 localhost dhclient: Copyright 2004-2006 Internet
> > Systems Consortium.
> > Jun  1 09:39:15 localhost dhclient: All rights reserved.
> > Jun  1 09:39:15 localhost dhclient: For info, please visit
> > http://www.isc.org/sw/dhcp/
> > Jun  1 09:39:15 localhost dhclient:
> > Jun  1 09:39:15 localhost dhclient: wmaster0: unknown hardware address type 801
> > Jun  1 09:39:16 localhost kernel: wlan0: Initial auth_alg=0
> > Jun  1 09:39:16 localhost kernel: wlan0: authenticate with AP 00:11:95:36:fc:f7
> > Jun  1 09:39:16 localhost kernel: wlan0: RX authentication from
> > 00:11:95:36:fc:f7 (alg=0 transaction=2 status=0)
> > Jun  1 09:39:16 localhost kernel: wlan0: authenticated
> > Jun  1 09:39:16 localhost kernel: wlan0: associate with AP 00:11:95:36:fc:f7
> > Jun  1 09:39:16 localhost kernel: wlan0: RX AssocResp from
> > 00:11:95:36:fc:f7 (capab=0x471 status=0 aid=1)
> > Jun  1 09:39:16 localhost kernel: wlan0: associated
> > Jun  1 09:39:16 localhost kernel: ADDRCONF(NETDEV_CHANGE): wlan0: link
> > becomes ready
> > Jun  1 09:39:16 localhost dhclient: wmaster0: unknown hardware address type 801
> > Jun  1 09:39:16 localhost dhclient: Listening on LPF/wlan0/00:11:24:22:f5:04
> > Jun  1 09:39:16 localhost dhclient: Sending on   LPF/wlan0/00:11:24:22:f5:04
> > Jun  1 09:39:16 localhost dhclient: Sending on   Socket/fallback
> > Jun  1 09:39:16 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 5
> > Jun  1 09:39:21 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 5
> > Jun  1 09:39:26 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 8
> > Jun  1 09:39:26 localhost kernel: wlan0: no IPv6 routers present
> > Jun  1 09:39:34 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 15
> > Jun  1 09:39:49 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 8
> > Jun  1 09:39:57 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 12
> > Jun  1 09:40:09 localhost dhclient: DHCPDISCOVER on wlan0 to
> > 255.255.255.255 port 67 interval 8
> > Jun  1 09:40:17 localhost dhclient: No DHCPOFFERS received.
> > Jun  1 09:40:17 localhost dhclient: No working leases in persistent
> > database - sleeping.
> > -------------------------------------------
> >
> > Using ip static, the driver works fine.
> > A test using http://mire.ipadsl.net/speedtest.php :
> > ethernet: 446.961 Ko/sec
> > bcm43xx: 459.84 Ko/sec
> > bcm43xx-mac80211: 478.147 Ko/sec
>
> You certainly do a lot better than I do with mac80211 - your interface is driving the line at full
> rate. With bcm43xx-mac80211, I get 47 Ko/sec.
>

Yes. iwconfig gives me  Rate=54 Mb/s.
I think the driver can do better, I am limited by my adsl line.

> Your problem is one of signal strength. The reason that a static IP works and DHCP does not is that
> mac80211 sets the initial transmit rate at 54 Mbs. Yes, it does have a rate adjustment algorithm,
> but by the time the rate gets down to 1 Mbs, DHCP has already given up.
>
> Since no one ever goes back to read the archives of this list, I will point you at a previous
> posting that has relevance: http://lists.berlios.de/pipermail/bcm43xx-dev/2007-April/004640.html. In
> that message, you will find a patch that sets the initial rate to 1 Mbs, which will allow your
> interface to make a DHCP connection. That change will never be put into mac80211, as it will not be
> needed once the bcm43xx driver is debugged.
>

Thank you for the recall. I already read this message, but I forgot it.

Best regards,
Bin

> Larry
>


From Larry.Finger at lwfinger.net  Fri Jun  1 18:14:42 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 11:14:42 -0500
Subject: mac80211 initial rate: a question
Message-ID: <466045F2.6010708@lwfinger.net>

In routine rate_control_simple_rate_init in net/mac80211/rc80211_simple.c, there is a comment that says

         /* TODO: what is a good starting rate for STA? About middle? Maybe not
          * the lowest or the highest rate.. Could consider using RSSI from
          * previous packets? Need to have IEEE 802.1X auth succeed immediately
          * after assoc.. */

After that the code goes on to set the rate equal to the last one in the rate table, which might be 
the highest rate. Although that rate might be OK for most of the devices using mac80211, it 
certainly is not for bcm43xx, which does not have the ability to transmit or receive at speeds much 
above 1 Mbs. In a private patch circulated only on the bcm43xx mailing list, I changed this routine 
to set an initial rate of 1 Mbs, which certainly helps bcm43xx authenticate and communicate with the 
DHCP server.

If this low rate were to be set for all drivers, how rapidly would the rate-control algorithm 
respond? Would this cause a serious performance degradation?

Larry


From Larry.Finger at lwfinger.net  Fri Jun  1 19:55:24 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 12:55:24 -0500
Subject: Locking problem in bcm43xx-mac80211
Message-ID: <46605D8C.1030004@lwfinger.net>

When a 'modprobe -r bcm43xx-mac80211' command is given with the interface up, the following kernel 
BUG is issued:

ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned off
BUG: sleeping function called from invalid context at kernel/mutex.c:86
in_atomic():1, irqs_disabled():0
2 locks held by modprobe/6053:
  #0:  (rtnl_mutex){--..}, at: [<ffffffff803f0d63>] mutex_lock+0x2a/0x2e
  #1:  (&local->sta_lock){-+..}, at: [<ffffffff882622a5>] sta_info_flush+0x20/0x77 [mac80211]

Call Trace:
  [<ffffffff8024c830>] debug_show_held_locks+0x22/0x24
  [<ffffffff8022ab32>] __might_sleep+0xd9/0xdb
  [<ffffffff803f0d56>] mutex_lock+0x1d/0x2e
  [<ffffffff8829dc3a>] :bcm43xx_mac80211:bcm43xx_dev_set_key+0xc3/0x2e4
  [<ffffffff8028eea5>] __kmalloc+0x17e/0x18e
  [<ffffffff882621bf>] :mac80211:sta_info_free+0xec/0x1b2
  [<ffffffff882622cf>] :mac80211:sta_info_flush+0x4a/0x77
  [<ffffffff8826c5bf>] :mac80211:ieee80211_if_reinit+0x29c/0x2c7
  [<ffffffff80398de0>] unregister_netdevice+0x17e/0x201
  [<ffffffff8826bd06>] :mac80211:__ieee80211_if_del+0x1d/0x21
  [<ffffffff8825a985>] :mac80211:ieee80211_unregister_hw+0xbc/0x216
  [<ffffffff8829cf95>] :bcm43xx_mac80211:bcm43xx_remove+0x53/0x7f
  [<ffffffff8828f23b>] :ssb:ssb_device_remove+0x2b/0x39
  [<ffffffff8036cab5>] __device_release_driver+0x93/0xb3
  [<ffffffff8036d03d>] driver_detach+0xdb/0x11e
  [<ffffffff8036c529>] bus_remove_driver+0x75/0x97
  [<ffffffff8036d0b1>] driver_unregister+0x9/0xb
  [<ffffffff8828eddb>] :ssb:ssb_driver_unregister+0xd/0xf
  [<ffffffff882b0964>] :bcm43xx_mac80211:bcm43xx_exit+0x10/0x23
  [<ffffffff80257a82>] sys_delete_module+0x1b5/0x1e6
  [<ffffffff8024db6a>] trace_hardirqs_on+0x11c/0x147
  [<ffffffff803f1dcb>] trace_hardirqs_on_thunk+0x35/0x37
  [<ffffffff80209f9e>] system_call+0x7e/0x83

WARNING: at kernel/mutex.c:132 __mutex_lock_common()

Call Trace:
  [<ffffffff803f0b23>] __mutex_lock_slowpath+0x6a/0x280
  [<ffffffff8020b5f3>] dump_stack+0x15/0x17
  [<ffffffff803f0d63>] mutex_lock+0x2a/0x2e
  [<ffffffff8829dc3a>] :bcm43xx_mac80211:bcm43xx_dev_set_key+0xc3/0x2e4
  [<ffffffff8028eea5>] __kmalloc+0x17e/0x18e
  [<ffffffff882621bf>] :mac80211:sta_info_free+0xec/0x1b2
  [<ffffffff882622cf>] :mac80211:sta_info_flush+0x4a/0x77
  [<ffffffff8826c5bf>] :mac80211:ieee80211_if_reinit+0x29c/0x2c7
  [<ffffffff80398de0>] unregister_netdevice+0x17e/0x201
  [<ffffffff8826bd06>] :mac80211:__ieee80211_if_del+0x1d/0x21
  [<ffffffff8825a985>] :mac80211:ieee80211_unregister_hw+0xbc/0x216
  [<ffffffff8829cf95>] :bcm43xx_mac80211:bcm43xx_remove+0x53/0x7f
  [<ffffffff8828f23b>] :ssb:ssb_device_remove+0x2b/0x39
  [<ffffffff8036cab5>] __device_release_driver+0x93/0xb3
  [<ffffffff8036d03d>] driver_detach+0xdb/0x11e
  [<ffffffff8036c529>] bus_remove_driver+0x75/0x97
  [<ffffffff8036d0b1>] driver_unregister+0x9/0xb
  [<ffffffff8828eddb>] :ssb:ssb_driver_unregister+0xd/0xf
  [<ffffffff882b0964>] :bcm43xx_mac80211:bcm43xx_exit+0x10/0x23
  [<ffffffff80257a82>] sys_delete_module+0x1b5/0x1e6
  [<ffffffff8024db6a>] trace_hardirqs_on+0x11c/0x147
  [<ffffffff803f1dcb>] trace_hardirqs_on_thunk+0x35/0x37
  [<ffffffff80209f9e>] system_call+0x7e/0x83

ACPI: PCI interrupt for device 0000:01:00.0 disabled
ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19 (level, high) -> IRQ 19

I don't know what would happen if an 'ifdown' command were issued first, as I am using 
NetworkManager to control the interface, and it prevents usage of ifdown.

Larry



From mistamaila at gmail.com  Fri Jun  1 20:11:51 2007
From: mistamaila at gmail.com (John H.)
Date: Fri, 1 Jun 2007 13:11:51 -0500
Subject: Upgrade to f7 breaks bcm43xx module
Message-ID: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>

bcm43xx mac80211:
YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
version 4.x is unsupported. You must upgrade your firmware files.

I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.

However, I read that the error is not what it sounds like.  What is
the solution?


From larry.finger at lwfinger.net  Fri Jun  1 20:18:54 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 13:18:54 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
Message-ID: <4660630E.7040701@lwfinger.net>

John H. wrote:
> bcm43xx mac80211:
> YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> version 4.x is unsupported. You must upgrade your firmware files.
> 
> I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> 
> However, I read that the error is not what it sounds like.  What is
> the solution?

The error is _EXACTLY_ what it sounds like. With fc6, you were using bcm43xx-softmac, which uses V3 
firmware. With fc7, you switched to bcm43xx-mac80211, which needs V4 firmware - just what the error 
message said. The solution is to download a V4 driver and create the appropriate firmware.

Larry


From mistamaila at gmail.com  Fri Jun  1 20:23:44 2007
From: mistamaila at gmail.com (John H.)
Date: Fri, 1 Jun 2007 13:23:44 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <4660630E.7040701@lwfinger.net>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
	<4660630E.7040701@lwfinger.net>
Message-ID: <5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>

Thanks for the prompt response.

I have a dell e1505.  Do I need an updated fwcutter as well?  What is
the actual driver I need?  The device is broadcom 1390?


On 6/1/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> John H. wrote:
> > bcm43xx mac80211:
> > YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> > version 4.x is unsupported. You must upgrade your firmware files.
> >
> > I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> >
> > However, I read that the error is not what it sounds like.  What is
> > the solution?
>
> The error is _EXACTLY_ what it sounds like. With fc6, you were using bcm43xx-softmac, which uses V3
> firmware. With fc7, you switched to bcm43xx-mac80211, which needs V4 firmware - just what the error
> message said. The solution is to download a V4 driver and create the appropriate firmware.
>
> Larry
>


From mistamaila at gmail.com  Fri Jun  1 20:37:10 2007
From: mistamaila at gmail.com (John H.)
Date: Fri, 1 Jun 2007 13:37:10 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
	<4660630E.7040701@lwfinger.net>
	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
Message-ID: <5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>

I mean, the correct files to populate /lib/firmware(as I assume that's
what you mean).

I don't see it, or the instructions, on
http://bcm43xx.berlios.de/

On 6/1/07, John H. <mistamaila at gmail.com> wrote:
> Thanks for the prompt response.
>
> I have a dell e1505.  Do I need an updated fwcutter as well?  What is
> the actual driver I need?  The device is broadcom 1390?
>
>
> On 6/1/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > John H. wrote:
> > > bcm43xx mac80211:
> > > YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> > > version 4.x is unsupported. You must upgrade your firmware files.
> > >
> > > I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> > >
> > > However, I read that the error is not what it sounds like.  What is
> > > the solution?
> >
> > The error is _EXACTLY_ what it sounds like. With fc6, you were using bcm43xx-softmac, which uses V3
> > firmware. With fc7, you switched to bcm43xx-mac80211, which needs V4 firmware - just what the error
> > message said. The solution is to download a V4 driver and create the appropriate firmware.
> >
> > Larry
> >
>


From linville at tuxdriver.com  Fri Jun  1 20:18:38 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Fri, 1 Jun 2007 14:18:38 -0400
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
Message-ID: <20070601181838.GB5663@tuxdriver.com>

On Fri, Jun 01, 2007 at 01:11:51PM -0500, John H. wrote:
> bcm43xx mac80211:
> YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> version 4.x is unsupported. You must upgrade your firmware files.
> 
> I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> 
> However, I read that the error is not what it sounds like.  What is
> the solution?

You might start by posting on a Fedora list, lest ye draw the ire of
any other distro users on this list... :-)

In the meantime, I suggest you extract firmware[1] from the wl_apsta.o
file in this archive:

	http://downloads.openwrt.org/sources/broadcom-wl-4.80.53.0.tar.bz2

Hth!

John

[1] Using bcm43xx-fwcutter, of course.
-- 
John W. Linville
linville at tuxdriver.com


From mistamaila at gmail.com  Fri Jun  1 20:55:06 2007
From: mistamaila at gmail.com (John H.)
Date: Fri, 1 Jun 2007 13:55:06 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
	<4660630E.7040701@lwfinger.net>
	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
	<5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
Message-ID: <5b9417770706011155q50519ecftd3e4b8114102664f@mail.gmail.com>

Sorry, I got it all fixed.  The XP installation on my system had the
file.  There is a warning that says

Warning! Idle-TSSI.... Disabling TX power adjustment.

But I assume it's nothing?  Hopefully this doesn't have the speed
problems that required a patch before.

Thanks again!



On 6/1/07, John H. <mistamaila at gmail.com> wrote:
> I mean, the correct files to populate /lib/firmware(as I assume that's
> what you mean).
>
> I don't see it, or the instructions, on
> http://bcm43xx.berlios.de/
>
> On 6/1/07, John H. <mistamaila at gmail.com> wrote:
> > Thanks for the prompt response.
> >
> > I have a dell e1505.  Do I need an updated fwcutter as well?  What is
> > the actual driver I need?  The device is broadcom 1390?
> >
> >
> > On 6/1/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > > John H. wrote:
> > > > bcm43xx mac80211:
> > > > YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> > > > version 4.x is unsupported. You must upgrade your firmware files.
> > > >
> > > > I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> > > >
> > > > However, I read that the error is not what it sounds like.  What is
> > > > the solution?
> > >
> > > The error is _EXACTLY_ what it sounds like. With fc6, you were using bcm43xx-softmac, which uses V3
> > > firmware. With fc7, you switched to bcm43xx-mac80211, which needs V4 firmware - just what the error
> > > message said. The solution is to download a V4 driver and create the appropriate firmware.
> > >
> > > Larry
> > >
> >
>


From larry.finger at lwfinger.net  Fri Jun  1 20:58:00 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 13:58:00 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>	
	<4660630E.7040701@lwfinger.net>
	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
Message-ID: <46606C38.8090103@lwfinger.net>

John H. wrote:
> Thanks for the prompt response.
> 
> I have a dell e1505.  Do I need an updated fwcutter as well?  What is
> the actual driver I need?  The device is broadcom 1390?

I missed one keyword in my message - you need a V4 Windows or OS X driver. I use wl_apsta.o, but 
that driver occurs in both V3 and V4 versions. The Windows driver would be named bcmwl5.sys, but 
they usually come with a lot of other Windows software bundled in. Check the archives for a URL for 
the V4 variety of wl_apsta.o

The fc7 version of fwcutter should handle the driver.

Larry





From larry.finger at lwfinger.net  Fri Jun  1 21:24:49 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 14:24:49 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011155q50519ecftd3e4b8114102664f@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>	
	<4660630E.7040701@lwfinger.net>	
	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>	
	<5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
	<5b9417770706011155q50519ecftd3e4b8114102664f@mail.gmail.com>
Message-ID: <46607281.4060802@lwfinger.net>

John H. wrote:
> Sorry, I got it all fixed.  The XP installation on my system had the
> file.  There is a warning that says
> 
> Warning! Idle-TSSI.... Disabling TX power adjustment.
> 
> But I assume it's nothing?  Hopefully this doesn't have the speed
> problems that required a patch before.

It is not 'nothing', but there is no known fix. With the bcm43xx-mac80211 driver, I can use only a 
rate of 1 Mbs. Others do better, but there are no patches.

If you want a bcm43xx kernel that doesn't require patching, you need 2.6.22-rc3.

Larry



From johannes at sipsolutions.net  Fri Jun  1 21:30:23 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 01 Jun 2007 21:30:23 +0200
Subject: mac80211 initial rate: a question
In-Reply-To: <466045F2.6010708@lwfinger.net>
References: <466045F2.6010708@lwfinger.net>
Message-ID: <1180726223.11026.39.camel@johannes.berg>

On Fri, 2007-06-01 at 11:14 -0500, Larry Finger wrote:

>          /* TODO: what is a good starting rate for STA? About middle? Maybe not
>           * the lowest or the highest rate.. Could consider using RSSI from
>           * previous packets? Need to have IEEE 802.1X auth succeed immediately
>           * after assoc.. */
> 
> After that the code goes on to set the rate equal to the last one in the rate table, which might be 
> the highest rate. 

Yeah, I think that's very wrong.

> Although that rate might be OK for most of the devices using mac80211,

Even then, if the AP is just in range it might not receive transmissions
at 54M, depending on the fallback mechanism that might or might not be
ok.

> it 
> certainly is not for bcm43xx, which does not have the ability to transmit or receive at speeds much 
> above 1 Mbs. In a private patch circulated only on the bcm43xx mailing list, I changed this routine 
> to set an initial rate of 1 Mbs, which certainly helps bcm43xx authenticate and communicate with the 
> DHCP server.

The thing about 802.1X is that you have a handshake with a few packets
that need to go through or you need to restart, which is the wpa problem
people are seeing currently with bcm43xx, but my brother also sees with
madwifi/atheros in our living room upstairs (router is downstairs here)

> If this low rate were to be set for all drivers, how rapidly would the rate-control algorithm 
> respond? Would this cause a serious performance degradation?

This, unfortunately, I don't know. I'd think the algorithm would adjust
fast enough for it not to be an issue.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070601/36a29461/attachment.pgp>

From gene.heskett at verizon.net  Fri Jun  1 20:50:27 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 01 Jun 2007 14:50:27 -0400
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>
	<5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
Message-ID: <200706011450.27077.gene.heskett@verizon.net>

On Friday 01 June 2007, John H. wrote:
>I mean, the correct files to populate /lib/firmware(as I assume that's
>what you mean).
>
>I don't see it, or the instructions, on
>http://bcm43xx.berlios.de/

I too would be interested in seeing this updated because I'm ATM making 
backups of the goodies on an FC5 lappy, HP-dv5120us, preparatory to rebooting 
from the F7 dvd.  The radio in that lappy is a bcm-4318.

Under FC5, its operation was at best, sporadic and I usually gave up and 
plugged in a cable.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Good day to deal with people in high places; particularly lonely stewardesses.


From larry.finger at lwfinger.net  Fri Jun  1 22:28:56 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 15:28:56 -0500
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <200706011450.27077.gene.heskett@verizon.net>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>	<5b9417770706011123s3a54c43ep69257321e8102719@mail.gmail.com>	<5b9417770706011137q59962e95y6d810b236e6c0c3a@mail.gmail.com>
	<200706011450.27077.gene.heskett@verizon.net>
Message-ID: <46608188.9040108@lwfinger.net>

Gene Heskett wrote:
> 
> I too would be interested in seeing this updated because I'm ATM making 
> backups of the goodies on an FC5 lappy, HP-dv5120us, preparatory to rebooting 
> from the F7 dvd.  The radio in that lappy is a bcm-4318.
> 
> Under FC5, its operation was at best, sporadic and I usually gave up and 
> plugged in a cable.

If you hadn't patched the kernel, you will find bcm43xx-mac80211 about the same, perhaps a bit 
worse. You will likely want to keep your cable.

Larry


From mb at bu3sch.de  Fri Jun  1 22:38:14 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 1 Jun 2007 22:38:14 +0200
Subject: Locking problem in bcm43xx-mac80211
In-Reply-To: <46605D8C.1030004@lwfinger.net>
References: <46605D8C.1030004@lwfinger.net>
Message-ID: <200706012238.14678.mb@bu3sch.de>

On Friday 01 June 2007 19:55:24 Larry Finger wrote:
> When a 'modprobe -r bcm43xx-mac80211' command is given with the interface up, the following kernel 
> BUG is issued:

Known. Ignore it for now.

I sent out a patch to Jiri to fix this, but it hasn't
been acked (yet?). Jiri thinks it introduces a race. I think
it doesn't. ;)


-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Fri Jun  1 23:16:35 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 01 Jun 2007 16:16:35 -0500
Subject: [PATCH V2] bcm43xx-mac80211: Make wireless statistics yield
	reasonable values
Message-ID: <46608cb3.kcEmWfiAoSA+svnR%Larry.Finger@lwfinger.net>

The changes contained herein are needed to get reasonable numbers for wireless
statistics in bcm43xx-mac80211.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

 bcm43xx_main.c |    4 ++--
 bcm43xx_xmit.c |    4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c
===================================================================
--- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c
+++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c
@@ -517,12 +517,12 @@ void bcm43xx_rx(struct bcm43xx_wldev *de
 		}
 	}
 
-	status.signal = bcm43xx_rssi_postprocess(dev, jssi,
+	status.ssi = bcm43xx_rssi_postprocess(dev, jssi,
 					      (phystat0 & BCM43xx_RX_PHYST0_OFDM),
 					      (phystat0 & BCM43xx_RX_PHYST0_GAINCTL),
 					      (phystat3 & BCM43xx_RX_PHYST3_TRSTATE));
 	status.noise = dev->stats.link_noise;
-	status.ssi = jssi;
+	status.signal = jssi; /* this looks wrong, but is what mac80211 wants */
 	if (phystat0 & BCM43xx_RX_PHYST0_OFDM)
 		status.rate = bcm43xx_plcp_get_bitrate_ofdm(plcp);
 	else
Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
+++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
@@ -3799,8 +3799,8 @@ static int bcm43xx_wireless_init(struct 
 		    IEEE80211_HW_MONITOR_DURING_OPER |
 		    IEEE80211_HW_DEVICE_HIDES_WEP |
 		    IEEE80211_HW_WEP_INCLUDE_IV;
-	hw->max_signal = -110;
-	hw->max_rssi = BCM43xx_RX_MAX_SSI;
+	hw->max_signal = 100;
+	hw->max_rssi = -110;
 	hw->max_noise = -110;
 	hw->queues = 1;
 	SET_IEEE80211_DEV(hw, dev->dev);


From gene.heskett at verizon.net  Fri Jun  1 23:17:03 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 01 Jun 2007 17:17:03 -0400
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <46608188.9040108@lwfinger.net>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
	<200706011450.27077.gene.heskett@verizon.net>
	<46608188.9040108@lwfinger.net>
Message-ID: <200706011717.03931.gene.heskett@verizon.net>

On Friday 01 June 2007, Larry Finger wrote:
>Gene Heskett wrote:
>> I too would be interested in seeing this updated because I'm ATM making
>> backups of the goodies on an FC5 lappy, HP-dv5120us, preparatory to
>> rebooting from the F7 dvd.  The radio in that lappy is a bcm-4318.
>>
>> Under FC5, its operation was at best, sporadic and I usually gave up and
>> plugged in a cable.
>
>If you hadn't patched the kernel, you will find bcm43xx-mac80211 about the
> same, perhaps a bit worse. You will likely want to keep your cable.
>
>Larry

Chuckle, that was what I was afraid of, but that too will pass, I just hope I 
don't pass first. :)


Thanks Larry.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
The real problem with hunting elephants is carrying the decoys.


From mb at bu3sch.de  Fri Jun  1 23:36:33 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 1 Jun 2007 23:36:33 +0200
Subject: Upgrade to f7 breaks bcm43xx module
In-Reply-To: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
References: <5b9417770706011111u20f32192s960961dc8693f00e@mail.gmail.com>
Message-ID: <200706012336.33855.mb@bu3sch.de>

On Friday 01 June 2007 20:11:51 John H. wrote:
> bcm43xx mac80211:
> YOUR FIRMWARE IS TOO OLD. Firmware from binary drivers older than
> version 4.x is unsupported. You must upgrade your firmware files.
> 
> I get that now with f7 and 2.6.21 and didn't with fc6 2.6.20.
> 
> However, I read that the error is not what it sounds like.  What is
> the solution?

Well, I tried to make the error message pretty clear.
And I'm really out of additional suggestions.
But you could try to read the message again. It tells you
exactly what to do. ;)

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jun  1 23:43:23 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 1 Jun 2007 23:43:23 +0200
Subject: [PATCH V2] bcm43xx-mac80211: Make wireless statistics yield
	reasonable values
In-Reply-To: <46608cb3.kcEmWfiAoSA+svnR%Larry.Finger@lwfinger.net>
References: <46608cb3.kcEmWfiAoSA+svnR%Larry.Finger@lwfinger.net>
Message-ID: <200706012343.24225.mb@bu3sch.de>

On Friday 01 June 2007 23:16:35 Larry Finger wrote:
> The changes contained herein are needed to get reasonable numbers for wireless
> statistics in bcm43xx-mac80211.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>

If nobody else complains, go for a merge, John. :)

-- 
Greetings Michael.


From mb at bu3sch.de  Sat Jun  2 18:29:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 2 Jun 2007 18:29:42 +0200
Subject: Latest GPHY (APHY) init rewrite
Message-ID: <200706021829.43452.mb@bu3sch.de>

Here's latest version of the GPHY (APHY) init rewrite patch.
I fixed a bunch of bugs, but it's still broken.
It applies to my tree.


Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.c
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.c	2007-06-02 17:33:22.000000000 +0200
@@ -0,0 +1,668 @@
+/*
+
+  Broadcom BCM43xx wireless driver
+
+  PHY workarounds.
+
+  Copyright (c) 2005 Martin Langer <martin-langer at gmx.de>,
+  Copyright (c) 2005-2007 Stefano Brivio <st3 at riseup.net>
+  Copyright (c) 2005-2007 Michael Buesch <mb at bu3sch.de>
+  Copyright (c) 2005, 2006 Danny van Dyk <kugelfang at gentoo.org>
+  Copyright (c) 2005, 2006 Andreas Jaggi <andreas.jaggi at waterwave.ch>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; see the file COPYING.  If not, write to
+  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,
+  Boston, MA 02110-1301, USA.
+
+*/
+
+#include "bcm43xx.h"
+#include "bcm43xx_main.h"
+#include "bcm43xx_tables.h"
+#include "bcm43xx_phy.h"
+#include "bcm43xx_wa.h"
+
+static void bcm43xx_wa_papd(struct bcm43xx_wldev *dev)
+{
+	u16 backup;
+
+	backup = bcm43xx_ofdmtab_read16(dev, BCM43xx_OFDMTAB_PWRDYN2, 0);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_PWRDYN2, 0, 7);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_APHY, 0, 0);
+	bcm43xx_dummy_transmission(dev);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_PWRDYN2, 0, backup);
+}
+
+static void bcm43xx_wa_auxclipthr(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8E), 0x3800);
+}
+
+static void bcm43xx_wa_afcdac(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, 0x0035, 0x03FF);
+	bcm43xx_phy_write(dev, 0x0036, 0x0400);
+}
+
+static void bcm43xx_wa_txdc_offset(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DC, 0, 0x0051);
+}
+
+void bcm43xx_wa_initgains(struct bcm43xx_wldev *dev)
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	bcm43xx_phy_write(dev, BCM43xx_PHY_LNAHPFCTL, 0x1FF9);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_LPFGAINCTL,
+		bcm43xx_phy_read(dev, BCM43xx_PHY_LPFGAINCTL) & 0xFF0F);
+	if (phy->rev <= 2)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_LPFGAIN, 0, 0x1FBF);
+	bcm43xx_radio_write16(dev, 0x0002, 0x1FBF);
+
+	bcm43xx_phy_write(dev, 0x0024, 0x4680);
+	bcm43xx_phy_write(dev, 0x0020, 0x0003);
+	bcm43xx_phy_write(dev, 0x001D, 0x0F40);
+	bcm43xx_phy_write(dev, 0x001F, 0x1C00);
+	if (phy->rev <= 3)
+		bcm43xx_phy_write(dev, 0x002A,
+			(bcm43xx_phy_read(dev, 0x002A) & 0x00FF) | 0x0400);
+	else if (phy->rev == 5) {
+		bcm43xx_phy_write(dev, 0x002A,
+			(bcm43xx_phy_read(dev, 0x002A) & 0x00FF) | 0x1A00);
+		bcm43xx_phy_write(dev, 0x00CC, 0x2121);
+	}
+	if (phy->rev >= 3)
+		bcm43xx_phy_write(dev, 0x00BA, 0x3ED5);
+}
+
+static void bcm43xx_wa_divider(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, 0x002B, bcm43xx_phy_read(dev, 0x002B) & ~0x0100);
+	bcm43xx_phy_write(dev, 0x008E, 0x58C1);
+}
+
+static void bcm43xx_wa_gt(struct bcm43xx_wldev *dev) /* Gain table. */
+{
+	if (dev->phy.rev <= 2) {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN2, 0, 15);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN2, 1, 31);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN2, 2, 42);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN2, 3, 48);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN2, 4, 58);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 0, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 1, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 2, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 3, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 4, 21);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 5, 21);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 6, 25);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN1, 0, 3);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN1, 1, 3);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN1, 2, 7);
+	} else {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 0, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 1, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 2, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 3, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 4, 21);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 5, 21);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAIN0, 6, 25);
+	}
+}
+
+static void bcm43xx_wa_rssi_lt(struct bcm43xx_wldev *dev) /* RSSI lookup table */
+{
+	int i;
+
+	for (i = 0; i < 8; i++)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_RSSI, i, i + 8);
+	for (i = 8; i < 16; i++)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_RSSI, i, i - 8);
+}
+
+static void bcm43xx_wa_analog(struct bcm43xx_wldev *dev)
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (phy->analog > 2) {
+		if (phy->type == BCM43xx_PHYTYPE_A)
+			bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, 0x1808);
+		else
+			bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, 0x1000);
+	} else {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 3, 0x1044);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 4, 0x7201);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 6, 0x0040);
+	}
+}
+
+static void bcm43xx_wa_dac(struct bcm43xx_wldev *dev)
+{
+	if (dev->phy.analog == 1)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 1,
+			(bcm43xx_ofdmtab_read16(dev, BCM43xx_OFDMTAB_DAC, 1) & ~0x0034) | 0x0008);
+	else
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 1,
+			(bcm43xx_ofdmtab_read16(dev, BCM43xx_OFDMTAB_DAC, 1) & ~0x0078) | 0x0010);
+}
+
+static void bcm43xx_wa_fft(struct bcm43xx_wldev *dev) /* Fine frequency table */
+{
+	int i;
+
+	if (dev->phy.type == BCM43xx_PHYTYPE_A)
+		for (i = 0; i < BCM43xx_TAB_FINEFREQA_SIZE; i++)
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DACRFPABB, i, bcm43xx_tab_finefreqa[i]);
+	else
+		for (i = 0; i < BCM43xx_TAB_FINEFREQG_SIZE; i++)
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DACRFPABB, i, bcm43xx_tab_finefreqg[i]);
+}
+
+static void bcm43xx_wa_nft(struct bcm43xx_wldev *dev) /* Noise figure table */
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+	int i;
+
+	if (phy->type == BCM43xx_PHYTYPE_A) {
+		if (phy->rev == 2)
+			for (i = 0; i < BCM43xx_TAB_NOISEA2_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noisea2[i]);
+		else
+			for (i = 0; i < BCM43xx_TAB_NOISEA3_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noisea3[i]);
+	} else {
+		if (phy->rev == 1)
+			for (i = 0; i < BCM43xx_TAB_NOISEG1_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noiseg1[i]);
+		else
+			for (i = 0; i < BCM43xx_TAB_NOISEG2_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, i, bcm43xx_tab_noiseg2[i]);
+	}
+}
+
+static void bcm43xx_wa_rt(struct bcm43xx_wldev *dev) /* Rotor table */
+{
+	int i;
+
+	for (i = 0; i < BCM43xx_TAB_ROTOR_SIZE; i++)
+		bcm43xx_ofdmtab_write32(dev, BCM43xx_OFDMTAB_ROTOR, i, bcm43xx_tab_rotor[i]);
+}
+
+static void bcm43xx_wa_nst(struct bcm43xx_wldev *dev) /* Noise scale table */
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+	int i;
+
+	if (phy->type == BCM43xx_PHYTYPE_A) {
+		if (phy->rev <= 1)
+			for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+							i, 0);
+		else if (phy->rev == 2)
+			for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+							i, bcm43xx_tab_noisescalea2[i]);
+		else if (phy->rev == 3)
+			for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+							i, bcm43xx_tab_noisescalea3[i]);
+		else
+			for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+							i, bcm43xx_tab_noisescaleg3[i]);
+	} else {
+		if (phy->rev >= 6) {
+			if (bcm43xx_phy_read(dev, BCM43xx_PHY_ENCORE) & BCM43xx_PHY_ENCORE_EN)
+				for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+					bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+						i, bcm43xx_tab_noisescaleg3[i]);
+			else
+				for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+					bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+						i, bcm43xx_tab_noisescaleg2[i]);
+		} else {
+			for (i = 0; i < BCM43xx_TAB_NOISESCALE_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_NOISESCALE,
+							i, bcm43xx_tab_noisescaleg1[i]);
+		}
+	}
+}
+
+static void bcm43xx_wa_art(struct bcm43xx_wldev *dev) /* ADV retard table */
+{
+	int i;
+
+	for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
+			bcm43xx_ofdmtab_write32(dev, BCM43xx_OFDMTAB_ADVRETARD,
+				i, bcm43xx_tab_retard[i]);
+}
+
+static void bcm43xx_wa_txlna_gain(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DC, 13, 0x0000);
+}
+
+static void bcm43xx_wa_crs_reset(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, 0x002C, 0x0064);
+}
+
+static void bcm43xx_wa_2060txlna_gain(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_hf_write(dev, bcm43xx_hf_read(dev) |
+			 BCM43xx_HF_2060W);
+}
+
+static void bcm43xx_wa_lms(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, 0x0055,
+		(bcm43xx_phy_read(dev, 0x0055) & 0xFFC0) | 0x0004);
+}
+
+static void bcm43xx_wa_mixedsignal(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 1, 3);
+}
+
+static void bcm43xx_wa_msst(struct bcm43xx_wldev *dev) /* Min sigma square table */
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+	int i;
+	const u16 *tab;
+
+	if (phy->type == BCM43xx_PHYTYPE_A) {
+		tab = bcm43xx_tab_sigmasqr1;
+	} else if (phy->type == BCM43xx_PHYTYPE_G) {
+		tab = bcm43xx_tab_sigmasqr2;
+	} else {
+		assert(0);
+		return;
+	}
+
+	for (i = 0; i < BCM43xx_TAB_SIGMASQR_SIZE; i++) {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_MINSIGSQ,
+					i, tab[i]);
+	}
+}
+
+static void bcm43xx_wa_iqadc(struct bcm43xx_wldev *dev)
+{
+	if (dev->phy.analog == 4)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DAC, 0,
+			bcm43xx_ofdmtab_read16(dev, BCM43xx_OFDMTAB_DAC, 0) & ~0xF000);
+}
+
+static void bcm43xx_wa_crs_ed(struct bcm43xx_wldev *dev)
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (phy->rev == 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES1, 0x4F19);
+	} else if (phy->rev == 2) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES1_R1, 0x1861);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES2_R1, 0x1861);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_ANTDWELL,
+				  bcm43xx_phy_read(dev, BCM43xx_PHY_ANTDWELL)
+				  | 0x0800);
+	} else {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES1_R1, 0x0098);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRSTHRES2_R1, 0x0070);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xC9), 0x0080);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_ANTDWELL,
+				  bcm43xx_phy_read(dev, BCM43xx_PHY_ANTDWELL)
+				  | 0x0800);
+	}
+}
+
+static void bcm43xx_wa_crs_thr(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
+			(bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) & ~0x03C0) | 0xD000);
+}
+
+static void bcm43xx_wa_crs_blank(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x2C), 0x005A);
+}
+
+static void bcm43xx_wa_cck_shiftbits(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_phy_write(dev, BCM43xx_PHY_CCKSHIFTBITS, 0x0026);
+}
+
+static void bcm43xx_wa_wrssi_offset(struct bcm43xx_wldev *dev)
+{
+	int i;
+
+	if (dev->phy.rev == 1) {
+		for (i = 0; i < 16; i++) {
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_WRSSI_R1,
+						i, 0x0020);
+		}
+	} else {
+		for (i = 0; i < 32; i++) {
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_WRSSI,
+						i, 0x0820);
+		}
+	}
+}
+
+static void bcm43xx_wa_txpuoff_rxpuon(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_0F, 2, 15);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_0F, 3, 20);
+}
+
+static void bcm43xx_wa_altagc(struct bcm43xx_wldev *dev)
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (phy->rev == 1) {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1, 0, 254);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1, 1, 13);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1, 2, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1, 3, 25);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, 0, 0x2710);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, 1, 0x9B83);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, 2, 0x9B83);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC2, 3, 0x0F8D);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_LMS, 4);
+	} else {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 0, 254);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 1, 13);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 2, 19);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 3, 25);
+	}
+
+	bcm43xx_phy_write(dev, BCM43xx_PHY_CCKSHIFTBITS_WA,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_CCKSHIFTBITS_WA) & ~0xFF00) | 0x5700);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1A),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1A)) & ~0x007F) | 0x000F);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1A),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1A)) & ~0x3F80) | 0x2B80);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_ANTWRSETT,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_ANTWRSETT) & 0xF0FF) | 0x0300);
+	bcm43xx_radio_write16(dev, 0x7A,
+		bcm43xx_radio_read16(dev, 0x7A) | 0x0008);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_N1P1GAIN,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_N1P1GAIN) & ~0x000F) | 0x0008);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_P1P2GAIN,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_P1P2GAIN) & ~0x0F00) | 0x0600);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_N1N2GAIN,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_N1N2GAIN) & ~0x0F00) | 0x0700);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_N1P1GAIN,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_N1P1GAIN) & ~0x0F00) | 0x0100);
+	if (phy->rev == 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_N1N2GAIN,
+				  (bcm43xx_phy_read(dev, BCM43xx_PHY_N1N2GAIN)
+				   & ~0x000F) | 0x0007);
+	}
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x88),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x88)) & ~0x00FF) | 0x001C);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x88),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x88)) & ~0x3F00) | 0x0200);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x96),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x96)) & ~0x00FF) | 0x001C);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x89),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x89)) & ~0x00FF) | 0x0020);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x89),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x89)) & ~0x3F00) | 0x0200);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x82),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x82)) & ~0x00FF) | 0x002E);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x96),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x96)) & ~0xFF00) | 0x1A00);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x81),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x81)) & ~0x00FF) | 0x0028);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x81),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x81)) & ~0xFF00) | 0x2C00);
+	if (phy->rev == 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_PEAK_COUNT, 0x092B);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
+			(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1B)) & ~0x001E) | 0x0002);
+	} else {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
+			bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1B)) & ~0x001E);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1F), 0x287A);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_LPFGAINCTL,
+			(bcm43xx_phy_read(dev, BCM43xx_PHY_LPFGAINCTL) & ~0x000F) | 0x0004);
+		if (phy->rev >= 6) {
+			bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x22), 0x287A);
+			bcm43xx_phy_write(dev, BCM43xx_PHY_LPFGAINCTL,
+				(bcm43xx_phy_read(dev, BCM43xx_PHY_LPFGAINCTL) & ~0xF000) | 0x3000);
+		}
+	}
+	bcm43xx_phy_write(dev, BCM43xx_PHY_DIVSRCHIDX,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_DIVSRCHIDX) & 0x7F7F) | 0x7874);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8E), 0x1C00);
+	if (phy->rev == 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_DIVP1P2GAIN,
+			(bcm43xx_phy_read(dev, BCM43xx_PHY_DIVP1P2GAIN) & ~0x0F00) | 0x0600);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8B), 0x005E);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_ANTWRSETT,
+			(bcm43xx_phy_read(dev, BCM43xx_PHY_ANTWRSETT) & ~0x00FF) | 0x001E);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x8D), 0x0002);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3_R1, 0, 0);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3_R1, 1, 7);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3_R1, 2, 16);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3_R1, 3, 28);
+	} else {
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3, 0, 0);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3, 1, 7);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3, 2, 16);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC3, 3, 28);
+	}
+	if (phy->rev >= 6) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x26),
+			bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x26)) & ~0x0003);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x26),
+			bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x26)) & ~0x1000);
+	}
+}
+
+static void bcm43xx_wa_tr_ltov(struct bcm43xx_wldev *dev) /* TR Lookup Table Original Values */
+{
+	bcm43xx_gtab_write(dev, BCM43xx_GTAB_ORIGTR, 0, 0xC480);
+}
+
+static void bcm43xx_wa_cpll_nonpilot(struct bcm43xx_wldev *dev)
+{
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_11, 0, 0);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_11, 1, 0);
+}
+
+static void bcm43xx_wa_rssi_adc(struct bcm43xx_wldev *dev)
+{
+	if (dev->phy.analog == 4)
+		bcm43xx_phy_write(dev, 0x00DC, 0x7454);
+}
+
+static void bcm43xx_wa_boards_a(struct bcm43xx_wldev *dev)
+{
+	struct ssb_bus *bus = dev->dev->bus;
+
+	if (bus->board_vendor == SSB_BOARDVENDOR_BCM &&
+	    bus->board_type == SSB_BOARD_BU4306 &&
+	    bus->board_rev < 0x30) {
+		bcm43xx_phy_write(dev, 0x0010, 0xE000);
+		bcm43xx_phy_write(dev, 0x0013, 0x0140);
+		bcm43xx_phy_write(dev, 0x0014, 0x0280);
+	} else {
+		if (bus->board_type == SSB_BOARD_MP4318 &&
+		    bus->board_rev < 0x20) {
+			bcm43xx_phy_write(dev, 0x0013, 0x0210);
+			bcm43xx_phy_write(dev, 0x0014, 0x0840);
+		} else {
+			bcm43xx_phy_write(dev, 0x0013, 0x0140);
+			bcm43xx_phy_write(dev, 0x0014, 0x0280);
+		}
+		if (dev->phy.rev <= 4)
+			bcm43xx_phy_write(dev, 0x0010, 0xE000);
+		else
+			bcm43xx_phy_write(dev, 0x0010, 0x2000);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_DC, 1, 0x0039);
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_UNKNOWN_APHY, 7, 0x0040);
+	}
+}
+
+static void bcm43xx_wa_boards_g(struct bcm43xx_wldev *dev)
+{
+	struct ssb_bus *bus = dev->dev->bus;
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (bus->board_vendor != SSB_BOARDVENDOR_BCM ||
+	    bus->board_type != SSB_BOARD_BU4306 ||
+	    bus->board_rev != 0x17) {
+		if (phy->rev < 2) {
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX_R1, 1, 0x0002);
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX_R1, 2, 0x0001);
+		} else {
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 1, 0x0002);
+			bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 2, 0x0001);
+			if ((bus->sprom.r1.boardflags_lo & BCM43xx_BFL_EXTLNA) &&
+			    (phy->rev >= 7)) {
+				bcm43xx_phy_write(dev, BCM43xx_PHY_EXTG(0x11),
+					bcm43xx_phy_read(dev, BCM43xx_PHY_EXTG(0x11)) & 0xF7FF);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0020, 0x0001);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0021, 0x0001);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0022, 0x0001);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0023, 0x0000);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0000, 0x0000);
+				bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_GAINX, 0x0003, 0x0002);
+			}
+		}
+	}
+	if (bus->sprom.r1.boardflags_lo & BCM43xx_BFL_FEM) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_GTABCTL, 0x3120);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_GTABDATA, 0xC480);
+	}
+}
+
+void bcm43xx_wa_all(struct bcm43xx_wldev *dev)
+{
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (phy->type == BCM43xx_PHYTYPE_A) {
+		switch (phy->rev) {
+		case 2:
+			bcm43xx_wa_papd(dev);
+			bcm43xx_wa_auxclipthr(dev);
+			bcm43xx_wa_afcdac(dev);
+			bcm43xx_wa_txdc_offset(dev);
+			bcm43xx_wa_initgains(dev);
+			bcm43xx_wa_divider(dev);
+			bcm43xx_wa_gt(dev);
+			bcm43xx_wa_rssi_lt(dev);
+			bcm43xx_wa_analog(dev);
+			bcm43xx_wa_dac(dev);
+			bcm43xx_wa_fft(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_rt(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_art(dev);
+			bcm43xx_wa_txlna_gain(dev);
+			bcm43xx_wa_crs_reset(dev);
+			bcm43xx_wa_2060txlna_gain(dev);
+			bcm43xx_wa_lms(dev);
+			break;
+		case 3:
+			bcm43xx_wa_papd(dev);
+			bcm43xx_wa_mixedsignal(dev);
+			bcm43xx_wa_rssi_lt(dev);
+			bcm43xx_wa_txdc_offset(dev);
+			bcm43xx_wa_initgains(dev);
+			bcm43xx_wa_dac(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_msst(dev);
+			bcm43xx_wa_analog(dev);
+			bcm43xx_wa_gt(dev);
+			bcm43xx_wa_txpuoff_rxpuon(dev);
+			bcm43xx_wa_txlna_gain(dev);
+			break;
+		case 5:
+			bcm43xx_wa_iqadc(dev);
+		case 6:
+			bcm43xx_wa_papd(dev);
+			bcm43xx_wa_rssi_lt(dev);
+			bcm43xx_wa_txdc_offset(dev);
+			bcm43xx_wa_initgains(dev);
+			bcm43xx_wa_dac(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_msst(dev);
+			bcm43xx_wa_analog(dev);
+			bcm43xx_wa_gt(dev);
+			bcm43xx_wa_txpuoff_rxpuon(dev);
+			bcm43xx_wa_txlna_gain(dev);
+			break;
+		case 7:
+			bcm43xx_wa_iqadc(dev);
+			bcm43xx_wa_papd(dev);
+			bcm43xx_wa_rssi_lt(dev);
+			bcm43xx_wa_txdc_offset(dev);
+			bcm43xx_wa_initgains(dev);
+			bcm43xx_wa_dac(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_msst(dev);
+			bcm43xx_wa_analog(dev);
+			bcm43xx_wa_gt(dev);
+			bcm43xx_wa_txpuoff_rxpuon(dev);
+			bcm43xx_wa_txlna_gain(dev);
+			bcm43xx_wa_rssi_adc(dev);
+		default:
+			assert(0);
+		}
+		bcm43xx_wa_boards_a(dev);
+	} else if (phy->type == BCM43xx_PHYTYPE_G) {
+		switch (phy->rev) {
+		case 1://XXX review rev1
+			bcm43xx_wa_crs_ed(dev);
+			bcm43xx_wa_crs_thr(dev);
+			bcm43xx_wa_crs_blank(dev);
+			bcm43xx_wa_cck_shiftbits(dev);
+			bcm43xx_wa_fft(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_rt(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_art(dev);
+			bcm43xx_wa_wrssi_offset(dev);
+			bcm43xx_wa_altagc(dev);
+			break;
+		case 2:
+		case 6:
+		case 7:
+		case 8:
+			bcm43xx_wa_tr_ltov(dev);
+			bcm43xx_wa_crs_ed(dev);
+			bcm43xx_wa_rssi_lt(dev);
+			bcm43xx_wa_nft(dev);
+			bcm43xx_wa_nst(dev);
+			bcm43xx_wa_msst(dev);
+			bcm43xx_wa_wrssi_offset(dev);
+			bcm43xx_wa_altagc(dev);
+			bcm43xx_wa_analog(dev);
+			bcm43xx_wa_txpuoff_rxpuon(dev);
+			break;
+		default:
+			assert(0);
+		}
+		bcm43xx_wa_boards_g(dev);
+	} else { /* No N PHY support so far */
+		assert(0);
+	}
+
+	bcm43xx_wa_cpll_nonpilot(dev);
+}
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.h
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_wa.h	2007-06-02 17:33:22.000000000 +0200
@@ -0,0 +1,7 @@
+#ifndef BCM43xx_WA_H_
+#define BCM43xx_WA_H_
+
+void bcm43xx_wa_initgains(struct bcm43xx_wldev *dev);
+void bcm43xx_wa_all(struct bcm43xx_wldev *dev);
+
+#endif /* BCM43xx_WA_H_ */
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c	2007-05-24 19:38:54.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.c	2007-06-02 17:33:22.000000000 +0200
@@ -230,7 +230,7 @@ const u16 bcm43xx_tab_noisea2[] = {
 };
 
 const u16 bcm43xx_tab_noisea3[] = {
-	0x4C4C, 0x4C4C, 0x4C4C, 0x2D36,
+	0x5E5E, 0x5E5E, 0x5E5E, 0x3F48,
 	0x4C4C, 0x4C4C, 0x4C4C, 0x2D36,
 };
 
@@ -244,6 +244,26 @@ const u16 bcm43xx_tab_noiseg2[] = {
 	0x0000, 0x0000, 0x0000, 0x0000,
 };
 
+const u16 bcm43xx_tab_noisescalea2[] = {
+	0x6767, 0x6767, 0x6767, 0x6767, /* 0 */
+	0x6767, 0x6767, 0x6767, 0x6767,
+	0x6767, 0x6767, 0x6767, 0x6767,
+	0x6767, 0x6700, 0x6767, 0x6767,
+	0x6767, 0x6767, 0x6767, 0x6767, /* 16 */
+	0x6767, 0x6767, 0x6767, 0x6767,
+	0x6767, 0x6767, 0x0067,
+};
+
+const u16 bcm43xx_tab_noisescalea3[] = {
+	0x2323, 0x2323, 0x2323, 0x2323, /* 0 */
+	0x2323, 0x2323, 0x2323, 0x2323,
+	0x2323, 0x2323, 0x2323, 0x2323,
+	0x2323, 0x2300, 0x2323, 0x2323,
+	0x2323, 0x2323, 0x2323, 0x2323, /* 16 */
+	0x2323, 0x2323, 0x2323, 0x2323,
+	0x2323, 0x2323, 0x0023,
+};
+
 const u16 bcm43xx_tab_noisescaleg1[] = {
 	0x6C77, 0x5162, 0x3B40, 0x3335, /* 0 */
 	0x2F2D, 0x2A2A, 0x2527, 0x1F21,
@@ -255,7 +275,7 @@ const u16 bcm43xx_tab_noisescaleg1[] = {
 };
 
 const u16 bcm43xx_tab_noisescaleg2[] = {
-	0xD8DD, 0xCBD4, 0xBCC0, 0XB6B7, /* 0 */
+	0xD8DD, 0xCBD4, 0xBCC0, 0xB6B7, /* 0 */
 	0xB2B0, 0xADAD, 0xA7A9, 0x9FA1,
 	0x969B, 0x9195, 0x8F8F, 0x8A8A,
 	0x8A8A, 0x8A00, 0x8A8A, 0x8F8A,
@@ -308,6 +328,27 @@ const u16 bcm43xx_tab_sigmasqr2[] = {
 	0x00DE,
 };
 
+const u16 bcm43xx_tab_rssiagc1[] = {
+	0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8, /* 0 */
+	0xFFF8, 0xFFF9, 0xFFFC, 0xFFFE,
+	0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8,
+	0xFFF8, 0xFFF8, 0xFFF8, 0xFFF8,
+};
+
+const u16 bcm43xx_tab_rssiagc2[] = {
+	0x0820, 0x0820, 0x0920, 0x0C38, /* 0 */
+	0x0820, 0x0820, 0x0820, 0x0820,
+	0x0820, 0x0820, 0x0920, 0x0A38,
+	0x0820, 0x0820, 0x0820, 0x0820,
+	0x0820, 0x0820, 0x0920, 0x0A38, /* 16 */
+	0x0820, 0x0820, 0x0820, 0x0820,
+	0x0820, 0x0820, 0x0920, 0x0A38,
+	0x0820, 0x0820, 0x0820, 0x0820,
+	0x0820, 0x0820, 0x0920, 0x0A38, /* 32 */
+	0x0820, 0x0820, 0x0820, 0x0820,
+	0x0820, 0x0820, 0x0920, 0x0A38,
+	0x0820, 0x0820, 0x0820, 0x0820,
+};
 
 static inline void assert_sizes(void)
 {
@@ -319,34 +360,59 @@ static inline void assert_sizes(void)
 	BUILD_BUG_ON(BCM43xx_TAB_NOISEA3_SIZE != ARRAY_SIZE(bcm43xx_tab_noisea3));
 	BUILD_BUG_ON(BCM43xx_TAB_NOISEG1_SIZE != ARRAY_SIZE(bcm43xx_tab_noiseg1));
 	BUILD_BUG_ON(BCM43xx_TAB_NOISEG2_SIZE != ARRAY_SIZE(bcm43xx_tab_noiseg2));
-	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg1));
-	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg2));
-	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALEG_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg3));
+	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg1));
+	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg2));
+	BUILD_BUG_ON(BCM43xx_TAB_NOISESCALE_SIZE != ARRAY_SIZE(bcm43xx_tab_noisescaleg3));
 	BUILD_BUG_ON(BCM43xx_TAB_SIGMASQR_SIZE != ARRAY_SIZE(bcm43xx_tab_sigmasqr1));
 	BUILD_BUG_ON(BCM43xx_TAB_SIGMASQR_SIZE != ARRAY_SIZE(bcm43xx_tab_sigmasqr2));
+	BUILD_BUG_ON(BCM43xx_TAB_RSSIAGC1_SIZE != ARRAY_SIZE(bcm43xx_tab_rssiagc1));
+	BUILD_BUG_ON(BCM43xx_TAB_RSSIAGC2_SIZE != ARRAY_SIZE(bcm43xx_tab_rssiagc2));
 }
 
 
 u16 bcm43xx_ofdmtab_read16(struct bcm43xx_wldev *dev, u16 table, u16 offset)
 {
-	assert_sizes();
+	struct bcm43xx_phy *phy = &dev->phy;
+	u16 addr;
+
+	addr = table + offset;
+	if (addr - 1 != phy->ofdm_addr || phy->ofdm_valid != 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, addr);
+		phy->ofdm_valid = 1;
+	}
+	phy->ofdm_addr = addr;
 
-	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table + offset);
 	return bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEI);
+	assert_sizes();
 }
 
 void bcm43xx_ofdmtab_write16(struct bcm43xx_wldev *dev, u16 table,
 			     u16 offset, u16 value)
 {
-	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table + offset);
+	struct bcm43xx_phy *phy = &dev->phy;
+	u16 addr;
+
+	addr = table + offset;
+	if (addr - 1 != phy->ofdm_addr || phy->ofdm_valid != 2) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, addr);
+		phy->ofdm_valid = 2;
+	}
+	phy->ofdm_addr = addr;
 	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
 }
 
 u32 bcm43xx_ofdmtab_read32(struct bcm43xx_wldev *dev, u16 table, u16 offset)
 {
+	struct bcm43xx_phy *phy = &dev->phy;
 	u32 ret;
+	u16 addr;
 
-	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table + offset);
+	addr = table + offset;
+	if (addr - 1 != phy->ofdm_addr || phy->ofdm_valid != 1) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, addr);
+		phy->ofdm_valid = 1;
+	}
+	phy->ofdm_addr = addr;
 	ret = bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEQ);
 	ret <<= 16;
 	ret |= bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEI);
@@ -357,9 +423,17 @@ u32 bcm43xx_ofdmtab_read32(struct bcm43x
 void bcm43xx_ofdmtab_write32(struct bcm43xx_wldev *dev, u16 table,
 			     u16 offset, u32 value)
 {
-	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, table + offset);
-	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
+	struct bcm43xx_phy *phy = &dev->phy;
+	u16 addr;
+
+	addr = table + offset;
+	if (addr - 1 != phy->ofdm_addr || phy->ofdm_valid != 2) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLECTL, addr);
+		phy->ofdm_valid = 2;
+	}
+	phy->ofdm_addr = addr;
 	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEQ, (value >> 16));
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OTABLEI, value);
 }
 
 u16 bcm43xx_gtab_read(struct bcm43xx_wldev *dev, u16 table, u16 offset)
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h	2007-06-02 02:09:56.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h	2007-06-02 17:33:22.000000000 +0200
@@ -591,6 +591,10 @@ struct bcm43xx_phy {
 	u16 lofcal;
 
 	u16 initval;//FIXME rename?
+
+	/* OFDM address read/write caching for hardware auto-increment. */
+	u16 ofdm_addr;
+	u8 ofdm_valid; /* 0: invalid, 1: read, 2: write */
 };
 
 /* Data structures for DMA transmission, per 80211 core. */
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c	2007-06-02 01:56:02.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c	2007-06-02 17:33:22.000000000 +0200
@@ -3129,6 +3129,9 @@ static void setup_struct_phy_for_init(st
 	spin_lock_init(&phy->lock);
 	phy->interfmode = BCM43xx_INTERFMODE_NONE;
 	phy->channel = 0xFF;
+
+	/* OFDM address caching. */
+	phy->ofdm_valid = 0;
 }
 
 static void setup_struct_wldev_for_init(struct bcm43xx_wldev *dev)
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h	2007-05-24 19:38:54.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.h	2007-06-02 17:33:22.000000000 +0200
@@ -28,8 +28,11 @@ struct bcm43xx_wldev;
 #define BCM43xx_PHY_PWRDOWN		BCM43xx_PHY_OFDM(0x03)	/* Powerdown */
 #define BCM43xx_PHY_CRSTHRES1		BCM43xx_PHY_OFDM(0x06)	/* CRS Threshold 1 */
 #define BCM43xx_PHY_LNAHPFCTL		BCM43xx_PHY_OFDM(0x1C)	/* LNA/HPF control */
+#define BCM43xx_PHY_LPFGAINCTL		BCM43xx_PHY_OFDM(0x20)	/* LPF Gain control */
 #define BCM43xx_PHY_ADIVRELATED		BCM43xx_PHY_OFDM(0x27)	/* FIXME rename */
 #define BCM43xx_PHY_CRS0		BCM43xx_PHY_OFDM(0x29)
+#define  BCM43xx_PHY_CRS0_EN		0x4000
+#define BCM43xx_PHY_PEAK_COUNT		BCM43xx_PHY_OFDM(0x30)
 #define BCM43xx_PHY_ANTDWELL		BCM43xx_PHY_OFDM(0x2B)	/* Antenna dwell */
 #define  BCM43xx_PHY_ANTDWELL_AUTODIV1	0x0100			/* Automatic RX diversity start antenna */
 #define BCM43xx_PHY_ENCORE		BCM43xx_PHY_OFDM(0x49)	/* "Encore" (RangeMax / BroadRange) */
@@ -38,6 +41,7 @@ struct bcm43xx_wldev;
 #define BCM43xx_PHY_OFDM61		BCM43xx_PHY_OFDM(0x61)	/* FIXME rename */
 #define  BCM43xx_PHY_OFDM61_10		0x0010			/* FIXME rename */
 #define BCM43xx_PHY_IQBAL		BCM43xx_PHY_OFDM(0x69)	/* I/Q balance */
+#define BCM43xx_PHY_BBTXDC_BIAS		BCM43xx_PHY_OFDM(0x6B)	/* Baseband TX DC bias */
 #define BCM43xx_PHY_OTABLECTL		BCM43xx_PHY_OFDM(0x72)	/* OFDM table control (see below) */
 #define  BCM43xx_PHY_OTABLEOFF		0x03FF			/* OFDM table offset (see below) */
 #define  BCM43xx_PHY_OTABLENR		0xFC00			/* OFDM table number (see below) */
@@ -45,6 +49,9 @@ struct bcm43xx_wldev;
 #define BCM43xx_PHY_OTABLEI		BCM43xx_PHY_OFDM(0x73)	/* OFDM table data I */
 #define BCM43xx_PHY_OTABLEQ		BCM43xx_PHY_OFDM(0x74)	/* OFDM table data Q */
 #define BCM43xx_PHY_HPWR_TSSICTL	BCM43xx_PHY_OFDM(0x78)	/* Hardware power TSSI control */
+#define BCM43xx_PHY_ADCCTL		BCM43xx_PHY_OFDM(0x7A)	/* ADC control */
+#define BCM43xx_PHY_IDLE_TSSI		BCM43xx_PHY_OFDM(0x7B)
+#define BCM43xx_PHY_A_TEMP_SENSE	BCM43xx_PHY_OFDM(0x7C)	/* A PHY temperature sense */
 #define BCM43xx_PHY_NRSSITHRES		BCM43xx_PHY_OFDM(0x8A)	/* NRSSI threshold */
 #define BCM43xx_PHY_ANTWRSETT		BCM43xx_PHY_OFDM(0x8C)	/* Antenna WR settle */
 #define  BCM43xx_PHY_ANTWRSETT_ARXDIV	0x2000			/* Automatic RX diversity enabled */
@@ -55,6 +62,8 @@ struct bcm43xx_wldev;
 #define BCM43xx_PHY_N1N2GAIN		BCM43xx_PHY_OFDM(0xA2)
 #define BCM43xx_PHY_CLIPTHRES		BCM43xx_PHY_OFDM(0xA3)
 #define BCM43xx_PHY_CLIPN1P2THRES	BCM43xx_PHY_OFDM(0xA4)
+#define BCM43xx_PHY_CCKSHIFTBITS_WA	BCM43xx_PHY_OFDM(0xA5)	/* CCK shiftbits workaround, FIXME rename */
+#define BCM43xx_PHY_CCKSHIFTBITS	BCM43xx_PHY_OFDM(0xA7)  /* FIXME rename */
 #define BCM43xx_PHY_DIVSRCHIDX		BCM43xx_PHY_OFDM(0xA8)	/* Divider search gain/index */
 #define BCM43xx_PHY_CLIPP2THRES		BCM43xx_PHY_OFDM(0xA9)
 #define BCM43xx_PHY_CLIPP3THRES		BCM43xx_PHY_OFDM(0xAA)
@@ -128,13 +137,14 @@ struct bcm43xx_wldev;
 #define BCM43xx_OFDMTAB_DC		BCM43xx_OFDMTAB(0x0E, 7)
 #define BCM43xx_OFDMTAB_PWRDYN2		BCM43xx_OFDMTAB(0x0E, 12)
 #define BCM43xx_OFDMTAB_LNAGAIN		BCM43xx_OFDMTAB(0x0E, 13)
-//TODO
+#define BCM43xx_OFDMTAB_UNKNOWN_0F	BCM43xx_OFDMTAB(0x0F, 0)	//TODO rename
+#define BCM43xx_OFDMTAB_UNKNOWN_APHY	BCM43xx_OFDMTAB(0x0F, 7)	//TODO rename
 #define BCM43xx_OFDMTAB_LPFGAIN		BCM43xx_OFDMTAB(0x0F, 12)
 #define BCM43xx_OFDMTAB_RSSI		BCM43xx_OFDMTAB(0x10, 0)
-//TODO
+#define BCM43xx_OFDMTAB_UNKNOWN_11	BCM43xx_OFDMTAB(0x11, 4)	//TODO rename
 #define BCM43xx_OFDMTAB_AGC1_R1		BCM43xx_OFDMTAB(0x13, 0)
-#define BCM43xx_OFDMTAB_GAINX_R1	BCM43xx_OFDMTAB(0x14, 0)	//TODO rename
-#define BCM43xx_OFDMTAB_MINSIGSQ	BCM43xx_OFDMTAB(0x14, 1)
+#define BCM43xx_OFDMTAB_GAINX_R1	BCM43xx_OFDMTAB(0x14, 0)	//TODO remove!
+#define BCM43xx_OFDMTAB_MINSIGSQ	BCM43xx_OFDMTAB(0x14, 0)
 #define BCM43xx_OFDMTAB_AGC3_R1		BCM43xx_OFDMTAB(0x15, 0)
 #define BCM43xx_OFDMTAB_WRSSI_R1	BCM43xx_OFDMTAB(0x15, 4)
 #define BCM43xx_OFDMTAB_TSSI		BCM43xx_OFDMTAB(0x15, 0)
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h	2007-05-24 19:38:54.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_tables.h	2007-06-02 17:33:22.000000000 +0200
@@ -17,12 +17,18 @@ extern const u16 bcm43xx_tab_noisea3[];
 extern const u16 bcm43xx_tab_noiseg1[];
 #define BCM43xx_TAB_NOISEG2_SIZE	8
 extern const u16 bcm43xx_tab_noiseg2[];
-#define BCM43xx_TAB_NOISESCALEG_SIZE	27
+#define BCM43xx_TAB_NOISESCALE_SIZE	27
+extern const u16 bcm43xx_tab_noisescalea2[];
+extern const u16 bcm43xx_tab_noisescalea3[];
 extern const u16 bcm43xx_tab_noisescaleg1[];
 extern const u16 bcm43xx_tab_noisescaleg2[];
 extern const u16 bcm43xx_tab_noisescaleg3[];
 #define BCM43xx_TAB_SIGMASQR_SIZE	53
 extern const u16 bcm43xx_tab_sigmasqr1[];
 extern const u16 bcm43xx_tab_sigmasqr2[];
+#define BCM43xx_TAB_RSSIAGC1_SIZE	16
+extern const u16 bcm43xx_tab_rssiagc1[];
+#define BCM43xx_TAB_RSSIAGC2_SIZE	48
+extern const u16 bcm43xx_tab_rssiagc2[];
 
 #endif /* BCM43xx_TABLES_H_ */
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c	2007-06-02 12:24:49.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c	2007-06-02 17:33:22.000000000 +0200
@@ -34,6 +34,7 @@
 #include "bcm43xx_tables.h"
 #include "bcm43xx_power.h"
 #include "bcm43xx_lo.h"
+#include "bcm43xx_wa.h"
 
 
 static const s8 bcm43xx_tssi2dbm_b_table[] = {
@@ -559,393 +560,96 @@ static void bcm43xx_phy_init_pctl(struct
 	bcm43xx_shm_clear_tssi(dev);
 }
 
-static void bcm43xx_phy_agcsetup(struct bcm43xx_wldev *dev)
+static void bcm43xx_phy_rssiagc(struct bcm43xx_wldev *dev, u8 enable)
 {
-	struct bcm43xx_phy *phy = &dev->phy;
-	u16 offset = 0x0000;
-
-	if (phy->rev == 1)
-		offset = 0x4C00;
-
-	bcm43xx_ofdmtab_write16(dev, offset, 0, 0x00FE);
-	bcm43xx_ofdmtab_write16(dev, offset, 1, 0x000D);
-	bcm43xx_ofdmtab_write16(dev, offset, 2, 0x0013);
-	bcm43xx_ofdmtab_write16(dev, offset, 3, 0x0019);
-
-	if (phy->rev == 1) {
-		bcm43xx_ofdmtab_write16(dev, 0x1800, 0, 0x2710);
-		bcm43xx_ofdmtab_write16(dev, 0x1801, 0, 0x9B83);
-		bcm43xx_ofdmtab_write16(dev, 0x1802, 0, 0x9B83);
-		bcm43xx_ofdmtab_write16(dev, 0x1803, 0, 0x0F8D);
-		bcm43xx_phy_write(dev, 0x0455, 0x0004);
-	}
-
-	bcm43xx_phy_write(dev, 0x04A5,
-			  (bcm43xx_phy_read(dev, 0x04A5)
-			   & 0x00FF) | 0x5700);
-	bcm43xx_phy_write(dev, 0x041A,
-			  (bcm43xx_phy_read(dev, 0x041A)
-			   & 0xFF80) | 0x000F);
-	bcm43xx_phy_write(dev, 0x041A,
-			  (bcm43xx_phy_read(dev, 0x041A)
-			   & 0xC07F) | 0x2B80);
-	bcm43xx_phy_write(dev, 0x048C,
-			  (bcm43xx_phy_read(dev, 0x048C)
-			   & 0xF0FF) | 0x0300);
-
-	bcm43xx_radio_write16(dev, 0x007A,
-			      bcm43xx_radio_read16(dev, 0x007A)
-			      | 0x0008);
-
-	bcm43xx_phy_write(dev, 0x04A0,
-			  (bcm43xx_phy_read(dev, 0x04A0)
-			   & 0xFFF0) | 0x0008);
-	bcm43xx_phy_write(dev, 0x04A1,
-			  (bcm43xx_phy_read(dev, 0x04A1)
-			   & 0xF0FF) | 0x0600);
-	bcm43xx_phy_write(dev, 0x04A2,
-			  (bcm43xx_phy_read(dev, 0x04A2)
-			   & 0xF0FF) | 0x0700);
-	bcm43xx_phy_write(dev, 0x04A0,
-			  (bcm43xx_phy_read(dev, 0x04A0)
-			   & 0xF0FF) | 0x0100);
-
-	if (phy->rev == 1) {
-		bcm43xx_phy_write(dev, 0x04A2,
-				  (bcm43xx_phy_read(dev, 0x04A2)
-				   & 0xFFF0) | 0x0007);
-	}
-
-	bcm43xx_phy_write(dev, 0x0488,
-			  (bcm43xx_phy_read(dev, 0x0488)
-			   & 0xFF00) | 0x001C);
-	bcm43xx_phy_write(dev, 0x0488,
-			  (bcm43xx_phy_read(dev, 0x0488)
-			   & 0xC0FF) | 0x0200);
-	bcm43xx_phy_write(dev, 0x0496,
-			  (bcm43xx_phy_read(dev, 0x0496)
-			   & 0xFF00) | 0x001C);
-	bcm43xx_phy_write(dev, 0x0489,
-			  (bcm43xx_phy_read(dev, 0x0489)
-			   & 0xFF00) | 0x0020);
-	bcm43xx_phy_write(dev, 0x0489,
-			  (bcm43xx_phy_read(dev, 0x0489)
-			   & 0xC0FF) | 0x0200);
-	bcm43xx_phy_write(dev, 0x0482,
-			  (bcm43xx_phy_read(dev, 0x0482)
-			   & 0xFF00) | 0x002E);
-	bcm43xx_phy_write(dev, 0x0496,
-			  (bcm43xx_phy_read(dev, 0x0496)
-			   & 0x00FF) | 0x1A00);
-	bcm43xx_phy_write(dev, 0x0481,
-			  (bcm43xx_phy_read(dev, 0x0481)
-			   & 0xFF00) | 0x0028);
-	bcm43xx_phy_write(dev, 0x0481,
-			  (bcm43xx_phy_read(dev, 0x0481)
-			   & 0x00FF) | 0x2C00);
-
-	if (phy->rev == 1) {
-		bcm43xx_phy_write(dev, 0x0430, 0x092B);
-		bcm43xx_phy_write(dev, 0x041B,
-				  (bcm43xx_phy_read(dev, 0x041B)
-				   & 0xFFE1) | 0x0002);
-	} else {
-		bcm43xx_phy_write(dev, 0x041B,
-				  bcm43xx_phy_read(dev, 0x041B)
-				  & 0xFFE1);
-		bcm43xx_phy_write(dev, 0x041F, 0x287A);
-		bcm43xx_phy_write(dev, 0x0420,
-				  (bcm43xx_phy_read(dev, 0x0420)
-				   & 0xFFF0) | 0x0004);
-	}
-
-	if (phy->rev >= 6) {
-		bcm43xx_phy_write(dev, 0x0422, 0x287A);
-		bcm43xx_phy_write(dev, 0x0420,
-				  (bcm43xx_phy_read(dev, 0x0420)
-				   & 0x0FFF) | 0x3000);
-	}
-
-	bcm43xx_phy_write(dev, 0x04A8,
-			  (bcm43xx_phy_read(dev, 0x04A8)
-			   & 0x8080) | 0x7874);
-	bcm43xx_phy_write(dev, 0x048E, 0x1C00);
-
-	offset = 0x0800;
-	if (phy->rev == 1) {
-		offset = 0x5400;
-		bcm43xx_phy_write(dev, 0x04AB,
-				  (bcm43xx_phy_read(dev, 0x04AB)
-				   & 0xF0FF) | 0x0600);
-		bcm43xx_phy_write(dev, 0x048B, 0x005E);
-		bcm43xx_phy_write(dev, 0x048C,
-				  (bcm43xx_phy_read(dev, 0x048C)
-				   & 0xFF00) | 0x001E);
-		bcm43xx_phy_write(dev, 0x048D, 0x0002);
-	}
-	bcm43xx_ofdmtab_write16(dev, offset, 0, 0x00);
-	bcm43xx_ofdmtab_write16(dev, offset, 1, 0x07);
-	bcm43xx_ofdmtab_write16(dev, offset, 2, 0x10);
-	bcm43xx_ofdmtab_write16(dev, offset, 3, 0x1C);
-
-	if (phy->rev >= 6) {
-		bcm43xx_phy_write(dev, 0x0426,
-				  bcm43xx_phy_read(dev, 0x0426)
-				  & 0xFFFC);
-		bcm43xx_phy_write(dev, 0x0426,
-				  bcm43xx_phy_read(dev, 0x0426)
-				  & 0xEFFF);
-	}
-}
-
-static void bcm43xx_phy_setupg(struct bcm43xx_wldev *dev)
-{
-	struct ssb_bus *bus = dev->dev->bus;
-	struct bcm43xx_phy *phy = &dev->phy;
-	u16 i;
-
-	assert(phy->type == BCM43xx_PHYTYPE_G);
-	if (phy->rev == 1) {
-		bcm43xx_phy_write(dev, 0x0406, 0x4F19);
-		bcm43xx_phy_write(dev, BCM43xx_PHY_G_CRS,
-				  (bcm43xx_phy_read(dev, BCM43xx_PHY_G_CRS) & 0xFC3F) | 0x0340);
-		bcm43xx_phy_write(dev, 0x042C, 0x005A);
-		bcm43xx_phy_write(dev, 0x0427, 0x001A);
-
-		for (i = 0; i < BCM43xx_TAB_FINEFREQG_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x5800, i, bcm43xx_tab_finefreqg[i]);
-		for (i = 0; i < BCM43xx_TAB_NOISEG1_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1800, i, bcm43xx_tab_noiseg1[i]);
-		for (i = 0; i < BCM43xx_TAB_ROTOR_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x2000, i, bcm43xx_tab_rotor[i]);
-	} else {
-		/* nrssi values are signed 6-bit values. Not sure why we write 0x7654 here... */
-		bcm43xx_nrssi_hw_write(dev, 0xBA98, (s16)0x7654);
-
-		if (phy->rev == 2) {
-			bcm43xx_phy_write(dev, 0x04C0, 0x1861);
-			bcm43xx_phy_write(dev, 0x04C1, 0x0271);
-		} else if (phy->rev > 2) {
-			bcm43xx_phy_write(dev, 0x04C0, 0x0098);
-			bcm43xx_phy_write(dev, 0x04C1, 0x0070);
-			bcm43xx_phy_write(dev, 0x04C9, 0x0080);
-		}
-		bcm43xx_phy_write(dev, 0x042B, bcm43xx_phy_read(dev, 0x042B) | 0x800);
-
-		for (i = 0; i < 64; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x4000, i, i);
-		for (i = 0; i < BCM43xx_TAB_NOISEG2_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1800, i, bcm43xx_tab_noiseg2[i]);
-	}
-
-	if (phy->rev <= 2)
-		for (i = 0; i < BCM43xx_TAB_NOISESCALEG_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, bcm43xx_tab_noisescaleg1[i]);
-	else if ((phy->rev >= 7) && (bcm43xx_phy_read(dev, 0x0449) & 0x0200))
-		for (i = 0; i < BCM43xx_TAB_NOISESCALEG_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, bcm43xx_tab_noisescaleg3[i]);
-	else
-		for (i = 0; i < BCM43xx_TAB_NOISESCALEG_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, bcm43xx_tab_noisescaleg2[i]);
-
-	if (phy->rev == 2)
-		for (i = 0; i < BCM43xx_TAB_SIGMASQR_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x5000, i, bcm43xx_tab_sigmasqr1[i]);
-	else if ((phy->rev > 2) && (phy->rev <= 8))
-		for (i = 0; i < BCM43xx_TAB_SIGMASQR_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x5000, i, bcm43xx_tab_sigmasqr2[i]);
-
-	if (phy->rev == 1) {
-		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
-			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
-		for (i = 0; i < 4; i++) {
-			bcm43xx_ofdmtab_write16(dev, 0x5404, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x5408, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x540C, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x5410, i, 0x0020);
-		}
-		bcm43xx_phy_agcsetup(dev);
-
-		if ((bus->board_vendor == SSB_BOARDVENDOR_BCM) &&
-		    (bus->board_type == SSB_BOARD_BU4306) &&
-		    (bus->board_rev == 0x17))
-			return;
-
-		bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
-		bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
-	} else {
-		for (i = 0; i <= 0x2F; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1000, i, 0x0820);
-		bcm43xx_phy_agcsetup(dev);
-		bcm43xx_phy_read(dev, 0x0400); /* dummy read */
-		bcm43xx_phy_write(dev, 0x0403, 0x1000);
-		bcm43xx_ofdmtab_write16(dev, 0x3C02, 0, 0x000F);
-		bcm43xx_ofdmtab_write16(dev, 0x3C03, 0, 0x0014);
-
-		if ((bus->board_vendor == SSB_BOARDVENDOR_BCM) &&
-		    (bus->board_type == SSB_BOARD_BU4306) &&
-		    (bus->board_rev == 0x17))
-			return;
-
-		bcm43xx_ofdmtab_write16(dev, 0x0401, 0, 0x0002);
-		bcm43xx_ofdmtab_write16(dev, 0x0402, 0, 0x0001);
-	}
-}
-
-/* Initialize the noisescaletable for APHY */
-static void bcm43xx_phy_init_noisescaletbl(struct bcm43xx_wldev *dev)
-{
-	struct bcm43xx_phy *phy = &dev->phy;
 	int i;
 
-	for (i = 0; i < 12; i++) {
-		if (phy->rev == 2)
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x6767);
+	if (dev->phy.rev < 3) {
+		if (enable)
+			for (i = 0; i < BCM43xx_TAB_RSSIAGC1_SIZE; i++) {
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_LNAHPFGAIN1, i, 0xFFF8);
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_WRSSI, i, 0xFFF8);
+			}
 		else
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x2323);
-	}
-	if (phy->rev == 2)
-		bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x6700);
-	else
-		bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x2300);
-	for (i = 0; i < 11; i++) {
-		if (phy->rev == 2)
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x6767);
+			for (i = 0; i < BCM43xx_TAB_RSSIAGC1_SIZE; i++) {
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_LNAHPFGAIN1, i, bcm43xx_tab_rssiagc1[i]);
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_WRSSI, i, bcm43xx_tab_rssiagc1[i]);
+			}
+	} else {
+		if (enable)
+			for (i = 0; i < BCM43xx_TAB_RSSIAGC1_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_WRSSI, i, 0x0820);
 		else
-			bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x2323);
+			for (i = 0; i < BCM43xx_TAB_RSSIAGC2_SIZE; i++)
+				bcm43xx_ofdmtab_write16(dev,
+					BCM43xx_OFDMTAB_WRSSI, i, bcm43xx_tab_rssiagc2[i]);
 	}
-	if (phy->rev == 2)
-		bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x0067);
-	else
-		bcm43xx_ofdmtab_write16(dev, 0x1400, i, 0x0023);
 }
 
-static void bcm43xx_phy_setupa(struct bcm43xx_wldev *dev)
+static void bcm43xx_phy_ww(struct bcm43xx_wldev *dev)
 {
-	struct bcm43xx_phy *phy = &dev->phy;
-	u16 i;
-
-	assert(phy->type == BCM43xx_PHYTYPE_A);
-	switch (phy->rev) {
-	case 2:
-		bcm43xx_phy_write(dev, 0x008E, 0x3800);
-		bcm43xx_phy_write(dev, 0x0035, 0x03FF);
-		bcm43xx_phy_write(dev, 0x0036, 0x0400);
-
-		bcm43xx_ofdmtab_write16(dev, 0x3807, 0, 0x0051);
-
-		bcm43xx_phy_write(dev, 0x001C, 0x0FF9);
-		bcm43xx_phy_write(dev, 0x0020, bcm43xx_phy_read(dev, 0x0020) & 0xFF0F);
-		bcm43xx_ofdmtab_write16(dev, 0x3C0C, 0, 0x07BF);
-		bcm43xx_radio_write16(dev, 0x0002, 0x07BF);
-
-		bcm43xx_phy_write(dev, 0x0024, 0x4680);
-		bcm43xx_phy_write(dev, 0x0020, 0x0003);
-		bcm43xx_phy_write(dev, 0x001D, 0x0F40);
-		bcm43xx_phy_write(dev, 0x001F, 0x1C00);
-
-		bcm43xx_phy_write(dev, 0x002A,
-				  (bcm43xx_phy_read(dev, 0x002A)
-				   & 0x00FF) | 0x0400);
-		bcm43xx_phy_write(dev, 0x002B,
-				  bcm43xx_phy_read(dev, 0x002B)
-				  & 0xFBFF);
-		bcm43xx_phy_write(dev, 0x008E, 0x58C1);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0803, 0, 0x000F);
-		bcm43xx_ofdmtab_write16(dev, 0x0804, 0, 0x001F);
-		bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x002A);
-		bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x0030);
-		bcm43xx_ofdmtab_write16(dev, 0x0807, 0, 0x003A);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 0, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 1, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 2, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 3, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 4, 0x0015);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 5, 0x0015);
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 6, 0x0019);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0404, 0, 0x0003);
-		bcm43xx_ofdmtab_write16(dev, 0x0405, 0, 0x0003);
-		bcm43xx_ofdmtab_write16(dev, 0x0406, 0, 0x0007);
-
-		for (i = 0; i < 16; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x4000, i, (0x8 + i) & 0x000F);
-
-		bcm43xx_ofdmtab_write16(dev, 0x3003, 0, 0x1044);
-		bcm43xx_ofdmtab_write16(dev, 0x3004, 0, 0x7201);
-		bcm43xx_ofdmtab_write16(dev, 0x3006, 0, 0x0040);
-		bcm43xx_ofdmtab_write16(dev, 0x3001, 0, (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) & 0x0010) | 0x0008);
-
-		for (i = 0; i < BCM43xx_TAB_FINEFREQA_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x5800, i, bcm43xx_tab_finefreqa[i]);
-		for (i = 0; i < BCM43xx_TAB_NOISEA2_SIZE; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x1800, i, bcm43xx_tab_noisea2[i]);
-		for (i = 0; i < BCM43xx_TAB_ROTOR_SIZE; i++)
-			bcm43xx_ofdmtab_write32(dev, 0x2000, i, bcm43xx_tab_rotor[i]);
-		bcm43xx_phy_init_noisescaletbl(dev);
-		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
-			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
-		break;
-	case 3:
-		for (i = 0; i < 64; i++)
-			bcm43xx_ofdmtab_write16(dev, 0x4000, i, i);
-
-		bcm43xx_ofdmtab_write16(dev, 0x3807, 0, 0x0051);
-
-		bcm43xx_phy_write(dev, 0x001C, 0x0FF9);
-		bcm43xx_phy_write(dev, 0x0020,
-				  bcm43xx_phy_read(dev, 0x0020) & 0xFF0F);
-		bcm43xx_radio_write16(dev, 0x0002, 0x07BF);
-
-		bcm43xx_phy_write(dev, 0x0024, 0x4680);
-		bcm43xx_phy_write(dev, 0x0020, 0x0003);
-		bcm43xx_phy_write(dev, 0x001D, 0x0F40);
-		bcm43xx_phy_write(dev, 0x001F, 0x1C00);
-		bcm43xx_phy_write(dev, 0x002A,
-				  (bcm43xx_phy_read(dev, 0x002A)
-				   & 0x00FF) | 0x0400);
-
-		bcm43xx_ofdmtab_write16(dev, 0x3000, 1,
-				        (bcm43xx_ofdmtab_read16(dev, 0x3000, 1)
-				        & 0x0010) | 0x0008);
-		for (i = 0; i < BCM43xx_TAB_NOISEA3_SIZE; i++) {
-			bcm43xx_ofdmtab_write16(dev, 0x1800, i,
-						bcm43xx_tab_noisea3[i]);
-		}
-		bcm43xx_phy_init_noisescaletbl(dev);
-		for (i = 0; i < BCM43xx_TAB_SIGMASQR_SIZE; i++) {
-			bcm43xx_ofdmtab_write16(dev, 0x5000, i,
-						bcm43xx_tab_sigmasqr1[i]);
-		}
-
-		bcm43xx_phy_write(dev, 0x0003, 0x1808);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0803, 0, 0x000F);
-		bcm43xx_ofdmtab_write16(dev, 0x0804, 0, 0x001F);
-		bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x002A);
-		bcm43xx_ofdmtab_write16(dev, 0x0805, 0, 0x0030);
-		bcm43xx_ofdmtab_write16(dev, 0x0807, 0, 0x003A);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0000, 0, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0001, 0, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0002, 0, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0003, 0, 0x0013);
-		bcm43xx_ofdmtab_write16(dev, 0x0004, 0, 0x0015);
-		bcm43xx_ofdmtab_write16(dev, 0x0005, 0, 0x0015);
-		bcm43xx_ofdmtab_write16(dev, 0x0006, 0, 0x0019);
-
-		bcm43xx_ofdmtab_write16(dev, 0x0404, 0, 0x0003);
-		bcm43xx_ofdmtab_write16(dev, 0x0405, 0, 0x0003);
-		bcm43xx_ofdmtab_write16(dev, 0x0406, 0, 0x0007);
+	u16 b, curr_s, best_s = 0xFFFF;
+	int i;
 
-		bcm43xx_ofdmtab_write16(dev, 0x3C02, 0, 0x000F);
-		bcm43xx_ofdmtab_write16(dev, 0x3C03, 0, 0x0014);
-		break;
-	default:
-		assert(0);
-	}
+	bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
+		bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) & ~BCM43xx_PHY_CRS0_EN);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
+		bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1B)) | 0x1000);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x82),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x82)) & 0xF0FF) | 0x0300);
+	bcm43xx_radio_write16(dev, 0x0009,
+		bcm43xx_radio_read16(dev, 0x0009) | 0x0080);
+	bcm43xx_radio_write16(dev, 0x0012,
+		(bcm43xx_radio_read16(dev, 0x0012) & 0xFFFC) | 0x0002);
+	bcm43xx_wa_initgains(dev);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xBA), 0x3ED5);
+	b = bcm43xx_phy_read(dev, BCM43xx_PHY_PWRDOWN);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, (b & 0xFFF8) | 0x0005);
+	bcm43xx_radio_write16(dev, 0x0004,
+		bcm43xx_radio_read16(dev, 0x0004) | 0x0004);
+	for (i = 0x10; i <= 0x20; i++) {
+		bcm43xx_radio_write16(dev, 0x0013, i);
+		curr_s = bcm43xx_phy_read(dev, BCM43xx_PHY_OTABLEQ) & 0x00FF;
+		if (!curr_s) {
+			best_s = 0x0000;
+			break;
+		} else if (curr_s >= 0x0080)
+			curr_s = 0x0100 - curr_s;
+		if (curr_s < best_s)
+			best_s = curr_s;
+	}
+	bcm43xx_phy_write(dev, BCM43xx_PHY_PWRDOWN, b);
+	bcm43xx_radio_write16(dev, 0x0004,
+		bcm43xx_radio_read16(dev, 0x0004) & 0xFFFB);
+	bcm43xx_radio_write16(dev, 0x0013, best_s);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1_R1, 0, 0xFFEC);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB7), 0x1E80);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB6), 0x1C00);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB5), 0x0EC0);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB2), 0x00C0);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xB9), 0x1FFF);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0xBB),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0xBB)) & 0xF000) | 0x0053);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM61,
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM61 & 0xFE1F)) | 0x0120);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x13),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x13)) & 0x0FFF) | 0x3000);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x14),
+		(bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x14)) & 0x0FFF) | 0x3000);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 6, 0x0017);
+	for (i = 0; i < 6; i++)
+		bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, i, 0x000F);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 0x0D, 0x000E);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 0x0E, 0x0011);
+	bcm43xx_ofdmtab_write16(dev, BCM43xx_OFDMTAB_AGC1, 0x0F, 0x0013);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x33), 0x5030);
+	bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
+		bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) | BCM43xx_PHY_CRS0_EN);
 }
 
 /* Initialize APHY. This is also called for the GPHY in some cases. */
@@ -953,60 +657,52 @@ static void bcm43xx_phy_inita(struct bcm
 {
 	struct ssb_bus *bus = dev->dev->bus;
 	struct bcm43xx_phy *phy = &dev->phy;
-	u16 tval;
 
-	if (phy->type == BCM43xx_PHYTYPE_A) {
-		bcm43xx_phy_setupa(dev);
-	} else {
-		bcm43xx_phy_setupg(dev);
-		if (phy->gmode &&
-		    (dev->dev->bus->sprom.r1.boardflags_lo & BCM43xx_BFL_PACTRL))
-			bcm43xx_phy_write(dev, 0x046E, 0x03CF);
-		return;
+	if (phy->rev >= 6) {
+		if (phy->type == BCM43xx_PHYTYPE_A)
+			bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x1B),
+				bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x1B)) & ~0x1000);
+		if (bcm43xx_phy_read(dev, BCM43xx_PHY_ENCORE) & BCM43xx_PHY_ENCORE_EN)
+			bcm43xx_phy_write(dev, BCM43xx_PHY_ENCORE,
+				bcm43xx_phy_read(dev, BCM43xx_PHY_ENCORE) | 0x0010);
+		else
+			bcm43xx_phy_write(dev, BCM43xx_PHY_ENCORE,
+				bcm43xx_phy_read(dev, BCM43xx_PHY_ENCORE) & ~0x1010);
 	}
+	bcm43xx_wa_all(dev);
 
-	bcm43xx_phy_write(dev, BCM43xx_PHY_A_CRS,
-	                  (bcm43xx_phy_read(dev, BCM43xx_PHY_A_CRS) & 0xF83C) | 0x0340);
-	bcm43xx_phy_write(dev, 0x0034, 0x0001);
-
-	TODO();//TODO: RSSI AGC
-	bcm43xx_phy_write(dev, BCM43xx_PHY_A_CRS,
-	                  bcm43xx_phy_read(dev, BCM43xx_PHY_A_CRS) | (1 << 14));
-	bcm43xx_radio_init2060(dev);
+	if (phy->type == BCM43xx_PHYTYPE_A) {
+		if (phy->gmode &&
+		    (phy->rev < 3))
+			bcm43xx_phy_write(dev, 0x0034,
+				bcm43xx_phy_read(dev, 0x0034) | 0x0001);
 
-	if ((bus->board_vendor == SSB_BOARDVENDOR_BCM) &&
-	    ((bus->board_type == SSB_BOARD_BU4306) ||
-	     (bus->board_type == SSB_BOARD_BU4309))) {
-		if (phy->lofcal == 0xFFFF) {
-			TODO();//TODO: LOF Cal
-			bcm43xx_radio_set_tx_iq(dev);
-		} else
-			bcm43xx_radio_write16(dev, 0x001E, phy->lofcal);
-	}
+		bcm43xx_phy_rssiagc(dev, 0);
 
-	bcm43xx_phy_write(dev, 0x007A, 0xF111);
+		bcm43xx_phy_write(dev, BCM43xx_PHY_CRS0,
+			bcm43xx_phy_read(dev, BCM43xx_PHY_CRS0) | BCM43xx_PHY_CRS0_EN);
 
-	if (phy->cur_idle_tssi == 0) {
-		bcm43xx_radio_write16(dev, 0x0019, 0x0000);
-		bcm43xx_radio_write16(dev, 0x0017, 0x0020);
+		bcm43xx_radio_init2060(dev);
 
-		tval = bcm43xx_ofdmtab_read16(dev, 0x3001, 0);
-		if (phy->rev == 1) {
-			bcm43xx_ofdmtab_write16(dev, 0x3001, 0,
-					  (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) & 0xFF87)
-					  | 0x0058);
-		} else {
-			bcm43xx_ofdmtab_write16(dev, 0x3001, 0,
-					  (bcm43xx_ofdmtab_read16(dev, 0x3001, 0) & 0xFFC3)
-					  | 0x002C);
+		if ((bus->board_vendor == SSB_BOARDVENDOR_BCM) &&
+		    ((bus->board_type == SSB_BOARD_BU4306) ||
+		     (bus->board_type == SSB_BOARD_BU4309))) {
+		     	; //TODO: A PHY LO
 		}
-		bcm43xx_dummy_transmission(dev);
-		phy->cur_idle_tssi = bcm43xx_phy_read(dev, BCM43xx_PHY_A_PCTL);
-		bcm43xx_ofdmtab_write16(dev, 0x3001, 0, tval);
 
-		bcm43xx_radio_set_txpower_a(dev, 0x0018);
+		if (phy->rev >= 3)
+			bcm43xx_phy_ww(dev);
+
+		hardware_pctl_init_aphy(dev);
+
+		//TODO: radar detection
+	}
+	if ((phy->type == BCM43xx_PHYTYPE_G) &&
+	    (dev->dev->bus->sprom.r1.boardflags_lo & BCM43xx_BFL_PACTRL)) {
+		bcm43xx_phy_write(dev, BCM43xx_PHY_OFDM(0x6E),
+				  (bcm43xx_phy_read(dev, BCM43xx_PHY_OFDM(0x6E))
+				   & 0xE000) | 0x3CF);
 	}
-	bcm43xx_shm_clear_tssi(dev);
 }
 
 static void bcm43xx_phy_initb2(struct bcm43xx_wldev *dev)
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/Makefile
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/Makefile	2007-05-24 19:38:54.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/Makefile	2007-06-02 17:33:22.000000000 +0200
@@ -15,4 +15,5 @@ bcm43xx-mac80211-objs := bcm43xx_main.o 
 		         bcm43xx_leds.o \
 		         bcm43xx_xmit.o \
 		         bcm43xx_lo.o \
+		         bcm43xx_wa.o \
 		         $(bcm43xx-mac80211-obj-y)

-- 
Greetings Michael.


From gene.heskett at verizon.net  Sat Jun  2 19:15:25 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 02 Jun 2007 13:15:25 -0400
Subject: bcm4318 in an HP dv5120us lappy
Message-ID: <200706021315.25988.gene.heskett@verizon.net>

Greetings;

Fresh F7 install on that lappy.  Kernel is 2.6.21.1, i686 version, on a 
powernow-k8 64 bitter.

Whats the procedure to get this working?

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
"Bite off, dirtball."
Richard Sexton, richard at gryphon.COM


From gene.heskett at verizon.net  Sat Jun  2 20:04:38 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 02 Jun 2007 14:04:38 -0400
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <200706021315.25988.gene.heskett@verizon.net>
References: <200706021315.25988.gene.heskett@verizon.net>
Message-ID: <200706021404.38335.gene.heskett@verizon.net>

On Saturday 02 June 2007, Gene Heskett wrote:
>Greetings;
>
>Fresh F7 install on that lappy.  Kernel is 2.6.21.1, i686 version, on a
>powernow-k8 64 bitter.
>
>Whats the procedure to get this working?

Addendum:

Installing bcm43xx-fwcutter, following the instructions on berlios.de, I have 
managed to get the radio turned on.  dmesg now reports:

ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)
ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)
ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to PCI core, index 2
ssb: Sonics Silicon Backplane found on PCI device 0000:06:02.0
bcm43xx_mac80211: Broadcom 4318 WLAN found
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Found PHY: Analog 3, Type 2, Revision 7
bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
bcm43xx_mac80211: Radio turned off
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_mac80211: Adding Interface type 2
ssb: Switching to PCI core, index 2
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Loading firmware version 319.102 (2005-10-15 22:46:19)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: !WARNING! Idle-TSSI phy->cur_idle_tssi measuring failed. 
(cur=0, tgt=62). Disabling TX power adjustment.
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
ADDRCONF(NETDEV_UP): wlan0: link is not ready

However, it appears that neither my access point, a wap-11, or the radio in 
the lappy is actually making any rf noise as I have a sniffer that reports 
nothing.

Also, when system-config-network is executed after this has been achieved, 
there is still no wlan0 available in the device or hardware list.

So whats next folks?

Thanks for any help anyone can offer.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Boycott meat -- suck your thumb.


From larry.finger at lwfinger.net  Sat Jun  2 20:39:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 02 Jun 2007 13:39:25 -0500
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <200706021404.38335.gene.heskett@verizon.net>
References: <200706021315.25988.gene.heskett@verizon.net>
	<200706021404.38335.gene.heskett@verizon.net>
Message-ID: <4661B95D.4090808@lwfinger.net>

Gene Heskett wrote:
> On Saturday 02 June 2007, Gene Heskett wrote:
>> Greetings;
>>
>> Fresh F7 install on that lappy.  Kernel is 2.6.21.1, i686 version, on a
>> powernow-k8 64 bitter.
>>
>> Whats the procedure to get this working?
> 
> Addendum:
> 
> Installing bcm43xx-fwcutter, following the instructions on berlios.de, I have 
> managed to get the radio turned on.  dmesg now reports:
> 
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)
> ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)
> ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to PCI core, index 2
> ssb: Sonics Silicon Backplane found on PCI device 0000:06:02.0
> bcm43xx_mac80211: Broadcom 4318 WLAN found
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_mac80211: Found PHY: Analog 3, Type 2, Revision 7
> bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
> bcm43xx_mac80211: Radio turned off
> wmaster0: Selected rate control algorithm 'simple'
> bcm43xx_mac80211: Adding Interface type 2
> ssb: Switching to PCI core, index 2
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_mac80211: Loading firmware version 319.102 (2005-10-15 22:46:19)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_mac80211: Radio turned on
> bcm43xx_mac80211: Radio enabled by hardware
> bcm43xx_mac80211: !WARNING! Idle-TSSI phy->cur_idle_tssi measuring failed. 
> (cur=0, tgt=62). Disabling TX power adjustment.
> bcm43xx_mac80211: Chip initialized
> bcm43xx_mac80211: 32-bit DMA initialized
> bcm43xx_mac80211: Wireless interface started
> ADDRCONF(NETDEV_UP): wlan0: link is not ready
> 
> However, it appears that neither my access point, a wap-11, or the radio in 
> the lappy is actually making any rf noise as I have a sniffer that reports 
> nothing.
> 
> Also, when system-config-network is executed after this has been achieved, 
> there is still no wlan0 available in the device or hardware list.

I was ignoring your request until you got the firmware installed and loaded! That is very well 
documented.

I have no idea what to expect from system-config-network. Questions regarding Fedora-specific 
utilities belong on a Fedora mailing list. You should use (as root) the iwconfig and 'iwlist scan' 
commands to see if your interface shows up, and if it is seeing any signals.

If your sniffer doesn't show any output from the AP, then either (a) your sniffer is broken, (b) the 
wireless in your AP is turned off, or (c) the SSID of your AP is hidden. If you have chosen (c) for 
security reasons, turn it back on - there is no real advantage.

I can only guess at why FC 7 uses the mac80211 driver. Be aware that the probability of it working 
"out of the box" is slim to none. If you are willing to patch the driver, you might get some limited 
success.

Larry


From larry.finger at lwfinger.net  Sun Jun  3 00:58:42 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 02 Jun 2007 17:58:42 -0500
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <200706021733.01970.gene.heskett@verizon.net>
References: <200706021315.25988.gene.heskett@verizon.net>
	<200706021404.38335.gene.heskett@verizon.net>
	<4661B95D.4090808@lwfinger.net>
	<200706021733.01970.gene.heskett@verizon.net>
Message-ID: <4661F622.6030500@lwfinger.net>

Gene Heskett wrote:
> On Saturday 02 June 2007, Larry Finger wrote:
> 
> wlan0     IEEE 802.11g  ESSID:"ICECAP4NIGHTCAP"
>           Mode:Managed  Frequency:2.442 GHz  Access Point: 00:12:0E:12:68:D5
>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
>           Encryption key:off
>           Link Quality:0  Signal level:0  Noise level:0
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0

The MAC address is the address of the AP that it associated with. It is Cell 02 below.

> But that AP mac address is NOT the wap11.  It should be, unless that's the mac 
> of the broadcom in this lappy, 00:05:5D:F8:8D:68
> 
>> and 'iwlist scan' commands to see if your 
>> interface shows up, and if it is seeing any signals.
> 
> [root at diablo network-scripts]# iwlist wlan0 scan
> wlan0     Scan completed :
>           Cell 01 - Address: 00:12:0E:5A:41:ED
>                     ESSID:"06B411926284"
>                     Mode:Master
>                     Channel:6
>                     Frequency:2.437 GHz
>                     Quality=174/146  Signal level=-239 dBm  Noise level=-71 
> dBm
>                     Encryption key:on
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 22 Mb/s
>                               6 Mb/s; 9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s
>                               36 Mb/s; 48 Mb/s; 54 Mb/s
>                     Extra:tsf=000000122f23a1c2
>           Cell 02 - Address: 00:12:0E:12:68:D5
>                     ESSID:"05B408826277"
>                     Mode:Master
>                     Channel:6
>                     Frequency:2.437 GHz
>                     Quality=171/146  Signal level=-241 dBm  Noise level=-71 
> dBm
>                     Encryption key:off
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 22 Mb/s
>                               6 Mb/s; 9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s
>                               36 Mb/s; 48 Mb/s; 54 Mb/s
>                     Extra:tsf=000000981721c122
>           Cell 03 - Address: 00:0F:B5:FA:9C:54
>                     ESSID:"dd-wrt"
>                     Mode:Master
>                     Channel:1
>                     Frequency:2.412 GHz
>                     Quality=213/146  Signal level=-216 dBm  Noise level=-71 
> dBm
>                     Encryption key:off
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 6 Mb/s
>                               9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>                               48 Mb/s; 54 Mb/s
>                     Extra:tsf=000000010a2e4181
>           Cell 04 - Address: 00:05:5D:F8:8D:68
>                     ESSID:"ICECAP4NIGHTCAP"
>                     Mode:Master
>                     Channel:7
>                     Frequency:2.442 GHz
>                     Quality=210/146  Signal level=-218 dBm  Noise level=-71 
> dBm
>                     Encryption key:on
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s
>                     Extra:tsf=000000002e48723f
> 
> Cell 04 is my wap11.  And that mac address is correct.
> 
> I've brought the wap11 back to life with a powerdown reset.  And I've used the 
> linux version of wap11gui to refresh the keys in the wap11.
> 
> I copied the old /etc/dir to a usb drive before I installed, and just went and 
> got the KEYS-wlan0 file from there and installed it, copied ufcfg-eth0 to 
> ifcfg-wlan0 and modified it to set the channel, ESSID, mac address, so it now 
> looks like this:
> ========
> # broadcom bcm4318 radio
> #
> DEVICE=wlan0
> BOOTPROTO=dhcp
> HWADDR=00:12:0E:12:68:D5
> ONBOOT=yes
> #TYPE=Ethernet
> TYPE=wireless
> ESSID="ICECAP4NIGHTCAP"
> CHANNEL="7"
> ========
> 
> Then I copied ifup-wireless to ifup-wlan0, got brave and did an 
> "ifdown wlan0;ifup wlan0"
> It fussed about the mac address not matching, but worked!  I can now ping 
> yahoo with the cat5 unplugged.
> 
> So, go fix the mac address, wash rinse repeat.  When it works, it works great, 
> but its dead for minutes at a time.

Yes, but you are using your neighbor's AP (ESSID:"05B408826277"), which is not encrypted. You need 
to specify the encryption key, which will keep it from connecting to the neighbor's unit.

Channel 7 is not a good choice for your AP, given the 2 neighboring AP's that use channel 6. The 
spectrum is more than +/- 2 channels away from the center; therefore the only non-interference is 
when channels 1, 6 and 11 are used. BTW, a patch was posted yesterday that will fix the quality and 
signal level numbers in iwscan and iwconfig.

Larry


From s0238762 at sms.ed.ac.uk  Sun Jun  3 00:28:19 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Sat, 02 Jun 2007 23:28:19 +0100
Subject: debug option
Message-ID: <4661EF03.8010804@sms.ed.ac.uk>

hello,

does the driver have a 'run-time' option/parameter to enable printing of 
debug information or at least be more verbose ?

basically I can't get it to work and it doesn't report any warning/error 
messages. The only information I have is the following:

I'm using Fedora's 7 2.6.21 kernel on a Dell D800 laptop. I extracted 
the firmware from this file (using bcm43xx-fwcutter): 
http://boredklink.googlepages.com/wl_apsta.o

modprobe reports this:
$ sudo /sbin/modprobe -v bcm43xx
insmod 
/lib/modules/2.6.21-1.3194.fc7/kernel/net/ieee80211/ieee80211_crypt.ko
insmod /lib/modules/2.6.21-1.3194.fc7/kernel/net/ieee80211/ieee80211.ko
insmod 
/lib/modules/2.6.21-1.3194.fc7/kernel/net/ieee80211/softmac/ieee80211softmac.ko 

insmod 
/lib/modules/2.6.21-1.3194.fc7/kernel/drivers/net/wireless/bcm43xx/bcm43xx.ko 


dmesg reports this:
$ dmesg | tail
ieee80211_crypt: registered algorithm 'NULL'
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation 
<jketreno at linux.intel.com>
bcm43xx driver

disabling and enabling the device again reports this (that's using the 
<Fn>-F2 key):
usb 1-2: USB disconnect, address 4
atkbd.c: Unknown key pressed (translated set 2, code 0x88 on 
isa0060/serio0).
atkbd.c: Use 'setkeycodes e008 <keycode>' to make it known.
usb 1-2: new full speed USB device using uhci_hcd and address 5
usb 1-2: configuration #1 chosen from 1 choice

i.e. I make sure the device is enabled (I can see it in hal device 
manager properly identified), but iwconfig says:
$ /sbin/iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

I also have a modprobe configuration file named 'modprobe.bcm43xx' with 
the following contents:
$ cat /etc/modprobe.d/modprobe.bcm43xx
alias pci:v000014E4d0x00004301sv*sd*bc*sc*i* bcm43xx
alias pci:v000014E4d0x00004307sv*sd*bc*sc*i* bcm43xx
alias pci:v000014E4d0x00004318sv*sd*bc*sc*i* bcm43xx
alias pci:v000014E4d0x00004320sv*sd*bc*sc*i* bcm43xx
alias pci:v000014E4d0x00004324sv*sd*bc*sc*i* bcm43xx
alias pci:v000014E4d0x00004325sv*sd*bc*sc*i* bcm43xx

mine has the 4324 id:
$ /sbin/lspci -nn | grep -i bcm43
02:03.0 Network controller [0280]: Broadcom Corporation BCM4309 
802.11a/b/g [14e4:4324] (rev 02)


thank you

-Ioannis


PS: I used to have it working with ndiswrapper when I had Fedora Core 6, 
but I'd like to use the native driver now. I made sure the bcm43xx 
driver is not in modprobe's blacklist any more.



From larry.finger at lwfinger.net  Sun Jun  3 01:14:53 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 02 Jun 2007 18:14:53 -0500
Subject: debug option
In-Reply-To: <4661EF03.8010804@sms.ed.ac.uk>
References: <4661EF03.8010804@sms.ed.ac.uk>
Message-ID: <4661F9ED.1020905@lwfinger.net>

Ioannis Nousias wrote:
> hello,
> 
> does the driver have a 'run-time' option/parameter to enable printing of 
> debug information or at least be more verbose ?
> 
> basically I can't get it to work and it doesn't report any warning/error 
> messages. The only information I have is the following:

The debug option needs to be specified at compile time, not at run time.

Larry


From will.dyson at gmail.com  Sun Jun  3 21:34:17 2007
From: will.dyson at gmail.com (Will Dyson)
Date: Sun, 3 Jun 2007 15:34:17 -0400
Subject: BUG: at net/mac80211/ieee80211.c:1280 ieee80211_tx()
In-Reply-To: <8e6f94720705260851k34c3d1fam16ab96c13375b11d@mail.gmail.com>
References: <8e6f94720705251637o71a13d71w70199a3057048592@mail.gmail.com>
	<200705251805.25696.flamingice@sourmilk.net>
	<8e6f94720705252110k46be0397v5f446aabdf34fe3f@mail.gmail.com>
	<200705252224.18457.flamingice@sourmilk.net>
	<8e6f94720705260851k34c3d1fam16ab96c13375b11d@mail.gmail.com>
Message-ID: <8e6f94720706031234y77761bb8m8abeda67d48f9dd5@mail.gmail.com>

On 5/26/07, Will Dyson <will.dyson at gmail.com> wrote:
> On 5/26/07, Michael Wu <flamingice at sourmilk.net> wrote:
> > On Friday 25 May 2007 21:10, Will Dyson wrote:
> > > On 5/25/07, Michael Wu <flamingice at sourmilk.net> wrote:
> > > > On Friday 25 May 2007 16:37, Will Dyson wrote:
> > > > > But I've got ton's of these in my log:
> > > > >
> > > > >  BUG: at net/mac80211/ieee80211.c:1280 ieee80211_tx()
> > > >
> > > > Do you have CONFIG_NET_SCHED on?
> > >
> > > I do not have it set in this kernel. Should I?
> > It may help. mac80211 didn't work correctly without it before and I'm not
> > entirely sure if it works correctly now without that.
>
> Ok. I'll try it.
>
> For what it's worth, I can no-longer reproduce this error (although it
> was reproducible across several reboots yesterday).

Followup:

The warning did eventually show up again in the kernel without
CONFIG_NET_SCHED. Runing a week with CONFIG_NET_SCHED without a
recurrence. So that seems to have solved it.

If mac80211 needs CONFIG_NET_SCHED, shouldn't mac80211 select or depend on it?

-- 
Will Dyson


From linville at tuxdriver.com  Sun Jun  3 23:43:58 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Sun, 3 Jun 2007 17:43:58 -0400
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <4661B95D.4090808@lwfinger.net>
References: <200706021315.25988.gene.heskett@verizon.net>
	<200706021404.38335.gene.heskett@verizon.net>
	<4661B95D.4090808@lwfinger.net>
Message-ID: <20070603214358.GC4272@tuxdriver.com>

On Sat, Jun 02, 2007 at 01:39:25PM -0500, Larry Finger wrote:

> I can only guess at why FC 7 uses the mac80211 driver.

To wean people off of softmac's teat...

-- 
John W. Linville
linville at tuxdriver.com


From larry.finger at lwfinger.net  Mon Jun  4 00:04:18 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 03 Jun 2007 17:04:18 -0500
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <20070603214358.GC4272@tuxdriver.com>
References: <200706021315.25988.gene.heskett@verizon.net>
	<200706021404.38335.gene.heskett@verizon.net>
	<4661B95D.4090808@lwfinger.net>
	<20070603214358.GC4272@tuxdriver.com>
Message-ID: <46633AE2.8000500@lwfinger.net>

John W. Linville wrote:
> On Sat, Jun 02, 2007 at 01:39:25PM -0500, Larry Finger wrote:
> 
>> I can only guess at why FC 7 uses the mac80211 driver.
> 
> To wean people off of softmac's teat...
> 

That was my guess...

Larry



From john.j35 at gmail.com  Mon Jun  4 06:32:23 2007
From: john.j35 at gmail.com (John Pierce)
Date: Sun, 3 Jun 2007 23:32:23 -0500
Subject: wlan 1390, broadcom bcm4311
Message-ID: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>

Hello and greetings to the list members.

I have been using opensuse 10.2 with the ndiswrapper on a 2.6.18
kernel and this worked.  I just recently converted this laptop to
fedora 7 with a 2.6.21 kernel.

I have found that ndiswrapper will not drive the card because of the
4k stacks.  I have been trying to figure out the bcm43xx_mac80211 and
I keep coming up short.

Here is what I have tried and some of the responses;

I have read that I need the ver 4 firmware so I downloaded it from here,

http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.

and when I modprobe the driver I find this line in the dmesg output

 bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)

Does this look like the correct firmware version?  I am not sure!

Here is the interesting part, if I bring up wlan0 and do a iwlist
scanning I see my cell along with about 6 others in the neighborhood,
but I keep getting these messages in the dmesg output:

bcm43xx_mac80211: Adding Interface type 2
bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: !WARNING! Idle-TSSI phy->cur_idle_tssi measuring
failed. (cur=26, tgt=62). Disabling TX power adjustment.
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
ADDRCONF(NETDEV_UP): wlan0: link is not ready
bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac:
ff:ff:ff:ff:ff:ff
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:11:95:2c:26:02
wlan0: RX authentication from 00:11:95:2c:26:02 (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:11:95:2c:26:02
wlan0: RX ReassocResp from 00:11:95:2c:26:02 (capab=0x431 status=0 aid=3)
wlan0: associated
ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
wlan0: no IPv6 routers present
wlan0: No ProbeResp from current AP 00:11:95:2c:26:02 - assume out of range
wlan0: No STA entry for own AP 00:11:95:2c:26:02
wlan0: No STA entry for own AP 00:11:95:2c:26:02
wlan0: No STA entry for own AP 00:11:95:2c:26:02
wlan0: No STA entry for own AP 00:11:95:2c:26:02

Also, when I bring up the link I get the following messages from the
ifup command:

Error for wireless request "Set Mode" (8B06) :
    SET failed on device wlan0 ; Invalid argument.
Error for wireless request "Set Bit Rate" (8B20) :
    SET failed on device wlan0 ; Operation not supported.

This is the output of lspci -vn

03:00.0 0280: 14e4:4311 (rev 01)
        Subsystem: 103c:1363
        Flags: fast devsel, IRQ 21
        Memory at b8000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit-
Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0

I know that I am close, I can get a scanning of the cells around my
area.  Just not quite there yet.

Oh, I tried the router with encryption off and the system wide open,
as well as my usual wep encryption.  Still no joy.

The system is an HP Pavillion DV9208NR and the pcie card is listed a
dell wlan 1390.

Any thoughts, suggestions, or hints would be greatly appreciated.

If I can supply any further information I will be glad to.

I am also will to help with the debugging and correction of any
potential problems.  It would not be the first time I have torn down
and put back together a system.

-- 
John
Registered Linux User 263680, get counted at
http://counter.li.org


From gavron at Wetwork.Net  Mon Jun  4 06:37:22 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Sun, 03 Jun 2007 21:37:22 -0700
Subject: wlan 1390, broadcom bcm4311
In-Reply-To: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>
References: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>
Message-ID: <46639702.3090903@Wetwork.Net>

Ndiswrapper works fine, ignore the 4k stacks warning.


Your firmware seems fine. Here's my 4311 (Dell 1390): bcm43xx_mac80211: 
Loading firmware version 371.1061 (2006-10-04 21:02:04)
The fact that you see APs in the scan means it works.


You didn't include the iwlist, so we can't tell if it's a weak reception 
under bcm43xx_mac80211 (but I suspect it is) that's causing the 
dissassociation.


As for the "Mode" and the "Rate" remove the extraneous parameters from 
your /etc/sysconfig/network-scripts/ifup-eth1.cfg


Ehud




John Pierce wrote:
> Hello and greetings to the list members.
>
> I have been using opensuse 10.2 with the ndiswrapper on a 2.6.18
> kernel and this worked.  I just recently converted this laptop to
> fedora 7 with a 2.6.21 kernel.
>
> I have found that ndiswrapper will not drive the card because of the
> 4k stacks.  I have been trying to figure out the bcm43xx_mac80211 and
> I keep coming up short.
>
> Here is what I have tried and some of the responses;
>
> I have read that I need the ver 4 firmware so I downloaded it from here,
>
> http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.
>
> and when I modprobe the driver I find this line in the dmesg output
>
>  bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
>
> Does this look like the correct firmware version?  I am not sure!
>
> Here is the interesting part, if I bring up wlan0 and do a iwlist
> scanning I see my cell along with about 6 others in the neighborhood,
> but I keep getting these messages in the dmesg output:
>
> bcm43xx_mac80211: Adding Interface type 2
> bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_mac80211: Radio turned on
> bcm43xx_mac80211: Radio enabled by hardware
> bcm43xx_mac80211: !WARNING! Idle-TSSI phy->cur_idle_tssi measuring
> failed. (cur=26, tgt=62). Disabling TX power adjustment.
> bcm43xx_mac80211: Chip initialized
> bcm43xx_mac80211: 32-bit DMA initialized
> bcm43xx_mac80211: Wireless interface started
> ADDRCONF(NETDEV_UP): wlan0: link is not ready
> bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac:
> ff:ff:ff:ff:ff:ff
> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:11:95:2c:26:02
> wlan0: RX authentication from 00:11:95:2c:26:02 (alg=0 transaction=2 status=0)
> wlan0: authenticated
> wlan0: associate with AP 00:11:95:2c:26:02
> wlan0: RX ReassocResp from 00:11:95:2c:26:02 (capab=0x431 status=0 aid=3)
> wlan0: associated
> ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
> wlan0: no IPv6 routers present
> wlan0: No ProbeResp from current AP 00:11:95:2c:26:02 - assume out of range
> wlan0: No STA entry for own AP 00:11:95:2c:26:02
> wlan0: No STA entry for own AP 00:11:95:2c:26:02
> wlan0: No STA entry for own AP 00:11:95:2c:26:02
> wlan0: No STA entry for own AP 00:11:95:2c:26:02
>
> Also, when I bring up the link I get the following messages from the
> ifup command:
>
> Error for wireless request "Set Mode" (8B06) :
>     SET failed on device wlan0 ; Invalid argument.
> Error for wireless request "Set Bit Rate" (8B20) :
>     SET failed on device wlan0 ; Operation not supported.
>
> This is the output of lspci -vn
>
> 03:00.0 0280: 14e4:4311 (rev 01)
>         Subsystem: 103c:1363
>         Flags: fast devsel, IRQ 21
>         Memory at b8000000 (32-bit, non-prefetchable) [size=16K]
>         Capabilities: [40] Power Management version 2
>         Capabilities: [58] Message Signalled Interrupts: Mask- 64bit-
> Queue=0/0 Enable-
>         Capabilities: [d0] Express Legacy Endpoint IRQ 0
>
> I know that I am close, I can get a scanning of the cells around my
> area.  Just not quite there yet.
>
> Oh, I tried the router with encryption off and the system wide open,
> as well as my usual wep encryption.  Still no joy.
>
> The system is an HP Pavillion DV9208NR and the pcie card is listed a
> dell wlan 1390.
>
> Any thoughts, suggestions, or hints would be greatly appreciated.
>
> If I can supply any further information I will be glad to.
>
> I am also will to help with the debugging and correction of any
> potential problems.  It would not be the first time I have torn down
> and put back together a system.
>
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070603/14ef47b0/attachment.bin>

From john.j35 at gmail.com  Mon Jun  4 07:15:33 2007
From: john.j35 at gmail.com (John Pierce)
Date: Mon, 4 Jun 2007 00:15:33 -0500
Subject: wlan 1390, broadcom bcm4311
In-Reply-To: <aa73b9a0706032147j2784f4f0p89262d7fe6765c81@mail.gmail.com>
References: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>
	<46639702.3090903@Wetwork.Net>
	<aa73b9a0706032147j2784f4f0p89262d7fe6765c81@mail.gmail.com>
Message-ID: <aa73b9a0706032215x1f219246j4ebaf82f2f3dddfd@mail.gmail.com>

Ok, I spoke to soon.  The system slowed down to a crawl and then
finally the connection was lost.

I will continue to try and capture pertinent information.  I will post
back when I find something that may be useful.

-- 
John
Registered Linux User 263680, get counted at
http://counter.li.org


From gavron at Wetwork.Net  Mon Jun  4 07:34:18 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Sun, 03 Jun 2007 22:34:18 -0700
Subject: wlan 1390, broadcom bcm4311
In-Reply-To: <aa73b9a0706032215x1f219246j4ebaf82f2f3dddfd@mail.gmail.com>
References: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>
	<46639702.3090903@Wetwork.Net>
	<aa73b9a0706032147j2784f4f0p89262d7fe6765c81@mail.gmail.com>
	<aa73b9a0706032215x1f219246j4ebaf82f2f3dddfd@mail.gmail.com>
Message-ID: <4663A45A.3080803@Wetwork.Net>

In your private reply you show great progress (but you didn't CC the 
list on that one so make reference to it only).

Since I didn't know where you were going (ndiswrapper or bcm43xx) I also 
didn't mention that you are running the F7 2.6.21 kernel... and that 
kernel needs patching from Larry's stuff at 
ftp://lwfinger.dynalias.org/patches/. 

You might try downloading the kernel source RPM... patching it... and 
then building that.  It IS a pain (and no I haven't done it for this 
one).  I did try 2.6.22-rc3 but it lacks the bcm43xx_mac80211 out of the 
box and I didn't want to revert to softmac.

Ehud

John Pierce wrote:
> Ok, I spoke to soon.  The system slowed down to a crawl and then
> finally the connection was lost.
>
> I will continue to try and capture pertinent information.  I will post
> back when I find something that may be useful.
>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070603/aa9bcf00/attachment.bin>

From john.j35 at gmail.com  Mon Jun  4 08:19:48 2007
From: john.j35 at gmail.com (John Pierce)
Date: Mon, 4 Jun 2007 01:19:48 -0500
Subject: wlan 1390, broadcom bcm4311
In-Reply-To: <4663A45A.3080803@Wetwork.Net>
References: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>
	<46639702.3090903@Wetwork.Net>
	<aa73b9a0706032147j2784f4f0p89262d7fe6765c81@mail.gmail.com>
	<aa73b9a0706032215x1f219246j4ebaf82f2f3dddfd@mail.gmail.com>
	<4663A45A.3080803@Wetwork.Net>
Message-ID: <aa73b9a0706032319o45fd68e2kfbf6e97c2d1ffecb@mail.gmail.com>

On 6/4/07, Ehud Gavron <gavron at wetwork.net> wrote:
> In your private reply you show great progress (but you didn't CC the
> list on that one so make reference to it only).
>
> Since I didn't know where you were going (ndiswrapper or bcm43xx) I also
> didn't mention that you are running the F7 2.6.21 kernel... and that
> kernel needs patching from Larry's stuff at
> ftp://lwfinger.dynalias.org/patches/.
>
> You might try downloading the kernel source RPM... patching it... and
> then building that.  It IS a pain (and no I haven't done it for this
> one).  I did try 2.6.22-rc3 but it lacks the bcm43xx_mac80211 out of the
> box and I didn't want to revert to softmac.
>
> Ehud
I have the source package installed already, as I have built my nvidia
drivers.  I will read up on the patching that you reference.

I am going to give it a rest tonight, 32 hours working this weekend
and I out of it.

-- 
John
Registered Linux User 263680, get counted at
http://counter.li.org


From scott-lists1 at dunedain289.com  Mon Jun  4 08:47:48 2007
From: scott-lists1 at dunedain289.com (scott-lists1 at dunedain289.com)
Date: Mon, 4 Jun 2007 06:47:48 +0000
Subject: HW to donate
Message-ID: <20070604064748.GB4636@mail.dunedain289.com>

To all:

2 years ago, I bought a Dell laptop with a Broadcom-chipset wireless
card (bcm4318 to be exact).  I then replaced that miniPCI card with an
Intel card for better Linux compatibility.  I still have the Broadcom
card and was wondering if any developers need it for testing/development
purposes.  I would love to get this cards into the hands of someone that
will use it - it's been sitting on my desk for too long.  

-Scott Petersen


From johannes at sipsolutions.net  Mon Jun  4 13:03:33 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 04 Jun 2007 13:03:33 +0200
Subject: BUG: at net/mac80211/ieee80211.c:1280 ieee80211_tx()
In-Reply-To: <8e6f94720706031234y77761bb8m8abeda67d48f9dd5@mail.gmail.com>
References: <8e6f94720705251637o71a13d71w70199a3057048592@mail.gmail.com>
	<200705251805.25696.flamingice@sourmilk.net>
	<8e6f94720705252110k46be0397v5f446aabdf34fe3f@mail.gmail.com>
	<200705252224.18457.flamingice@sourmilk.net>
	<8e6f94720705260851k34c3d1fam16ab96c13375b11d@mail.gmail.com>
	<8e6f94720706031234y77761bb8m8abeda67d48f9dd5@mail.gmail.com>
Message-ID: <1180955014.11026.56.camel@johannes.berg>

On Sun, 2007-06-03 at 15:34 -0400, Will Dyson wrote:

> The warning did eventually show up again in the kernel without
> CONFIG_NET_SCHED. Runing a week with CONFIG_NET_SCHED without a
> recurrence. So that seems to have solved it.
> 
> If mac80211 needs CONFIG_NET_SCHED, shouldn't mac80211 select or depend on it?

It's supposed to not need it ;)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070604/f1c64ff4/attachment.pgp>

From larry.finger at lwfinger.net  Mon Jun  4 15:04:24 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 04 Jun 2007 08:04:24 -0500
Subject: wlan 1390, broadcom bcm4311
In-Reply-To: <4663A45A.3080803@Wetwork.Net>
References: <aa73b9a0706032132h418efd43o29b31abfa52ecca1@mail.gmail.com>	<46639702.3090903@Wetwork.Net>	<aa73b9a0706032147j2784f4f0p89262d7fe6765c81@mail.gmail.com>	<aa73b9a0706032215x1f219246j4ebaf82f2f3dddfd@mail.gmail.com>
	<4663A45A.3080803@Wetwork.Net>
Message-ID: <46640DD8.3010805@lwfinger.net>

Ehud Gavron wrote:
> In your private reply you show great progress (but you didn't CC the 
> list on that one so make reference to it only).
> 
> Since I didn't know where you were going (ndiswrapper or bcm43xx) I also 
> didn't mention that you are running the F7 2.6.21 kernel... and that 
> kernel needs patching from Larry's stuff at 
> ftp://lwfinger.dynalias.org/patches/.
> You might try downloading the kernel source RPM... patching it... and 
> then building that.  It IS a pain (and no I haven't done it for this 
> one).  I did try 2.6.22-rc3 but it lacks the bcm43xx_mac80211 out of the 
> box and I didn't want to revert to softmac.

To prevent any misconceptions, my stuff is only for softmac. If you want mac80211, I have no fixes.

Larry


From linville at tuxdriver.com  Mon Jun  4 15:39:41 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Mon, 4 Jun 2007 09:39:41 -0400
Subject: bcm4318 in an HP dv5120us lappy
In-Reply-To: <46633AE2.8000500@lwfinger.net>
References: <200706021315.25988.gene.heskett@verizon.net>
	<200706021404.38335.gene.heskett@verizon.net>
	<4661B95D.4090808@lwfinger.net>
	<20070603214358.GC4272@tuxdriver.com>
	<46633AE2.8000500@lwfinger.net>
Message-ID: <20070604133941.GE3332@tuxdriver.com>

On Sun, Jun 03, 2007 at 05:04:18PM -0500, Larry Finger wrote:
> John W. Linville wrote:
> >On Sat, Jun 02, 2007 at 01:39:25PM -0500, Larry Finger wrote:
> >
> >>I can only guess at why FC 7 uses the mac80211 driver.
> >
> >To wean people off of softmac's teat...
> >
> 
> That was my guess...

I just posted this to fedora-list:

	https://www.redhat.com/archives/fedora-list/2007-June/msg01009.html

Hopefully that will help -- please let me know if there is anything
wrong or unclear about the info there.

Thanks,

John
-- 
John W. Linville
linville at tuxdriver.com


From marc.pignat at hevs.ch  Mon Jun  4 15:39:40 2007
From: marc.pignat at hevs.ch (Marc Pignat)
Date: Mon, 4 Jun 2007 15:39:40 +0200
Subject: [PATCH] mac80211-bcm43xx : Fix long delays
Message-ID: <200706041539.41043.marc.pignat@hevs.ch>

from: Marc Pignat <marc.pignat at hevs.ch>

Replace long udelay by mdelay (long udelay are not supported on all arch).

Signed-off-by: Marc Pignat <marc.pignat at hevs.ch>

---

The file drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c doesn't compile for
 ARM architecture (and possibly others).

Here is the patch for replacing long (>1000) udelay by corresponding mdelay.

Regards

Marc

--- drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c.orig	2007-06-04 14:49:39.000000000 +0200
+++ drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c	2007-06-04 14:52:26.000000000 +0200
@@ -3860,7 +3860,7 @@ void bcm43xx_radio_init2060(struct bcm43

 	err = bcm43xx_radio_selectchannel(dev, BCM43xx_DEFAULT_CHANNEL_A, 0);
 	assert(err == 0);
-	udelay(1000);
+	mdelay(1);
 }

 static inline
@@ -3997,7 +3997,7 @@ int bcm43xx_radio_selectchannel(struct b
 	phy->channel = channel;
 	//XXX: Using the longer of 2 timeouts (8000 vs 2000 usecs). Specs states
 	//     that 2000 usecs might suffice.
-	udelay(8000);
+	mdelay(8);

 	return 0;
 }


From mb at bu3sch.de  Mon Jun  4 17:11:51 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 4 Jun 2007 17:11:51 +0200
Subject: [PATCH] mac80211-bcm43xx : Fix long delays
In-Reply-To: <200706041539.41043.marc.pignat@hevs.ch>
References: <200706041539.41043.marc.pignat@hevs.ch>
Message-ID: <200706041711.51654.mb@bu3sch.de>

On Monday 04 June 2007 15:39:40 Marc Pignat wrote:
> from: Marc Pignat <marc.pignat at hevs.ch>
> 
> Replace long udelay by mdelay (long udelay are not supported on all arch).
> 
> Signed-off-by: Marc Pignat <marc.pignat at hevs.ch>
> 
> ---
> 
> The file drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c doesn't compile for
>  ARM architecture (and possibly others).
> 
> Here is the patch for replacing long (>1000) udelay by corresponding mdelay.
> 
> Regards
> 
> Marc
> 
> --- drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c.orig	2007-06-04 14:49:39.000000000 +0200
> +++ drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c	2007-06-04 14:52:26.000000000 +0200
> @@ -3860,7 +3860,7 @@ void bcm43xx_radio_init2060(struct bcm43
> 
>  	err = bcm43xx_radio_selectchannel(dev, BCM43xx_DEFAULT_CHANNEL_A, 0);
>  	assert(err == 0);
> -	udelay(1000);
> +	mdelay(1);
>  }
> 
>  static inline
> @@ -3997,7 +3997,7 @@ int bcm43xx_radio_selectchannel(struct b
>  	phy->channel = channel;
>  	//XXX: Using the longer of 2 timeouts (8000 vs 2000 usecs). Specs states
>  	//     that 2000 usecs might suffice.
> -	udelay(8000);
> +	mdelay(8);
> 

Let's not apply this patch.
This replaces something idiotic with something braindead. ;)
Better make it possible to use msleep.

-- 
Greetings Michael.


From vindex+lists-bcm43xx-dev at apartia.org  Tue Jun  5 09:05:53 2007
From: vindex+lists-bcm43xx-dev at apartia.org (Louis-David Mitterrand)
Date: Tue, 5 Jun 2007 09:05:53 +0200
Subject: firmware loading problems
Message-ID: <20070605070552.GA11398@apartia.fr>

Hi,

Using kernel 2.6.21.2 on a debian unstable system I have this error when 
"ifup wlan0":

	Jun  3 09:21:13 styx kernel: bcm43xx: PHY connected
	Jun  3 09:21:13 styx kernel: firmware_loading_store: unexpected value (0)
	Jun  3 09:21:13 styx kernel: firmware_loading_store: unexpected value (0)
	Jun  3 09:21:13 styx kernel: bcm43xx: Error: InitVals "bcm43xx_initval06.fw" not available or load failed.

However if I "rmmod bcm43xx" then "modprobe bcm43xx" and retry bringing 
up the wlan0 interface then it works fine.

What should I do?

Thanks,


From marc.pignat at hevs.ch  Tue Jun  5 10:13:28 2007
From: marc.pignat at hevs.ch (Marc Pignat)
Date: Tue, 5 Jun 2007 10:13:28 +0200
Subject: [PATCH] mac80211-bcm43xx : Fix long delays
In-Reply-To: <200706041711.51654.mb@bu3sch.de>
References: <200706041539.41043.marc.pignat@hevs.ch>
	<200706041711.51654.mb@bu3sch.de>
Message-ID: <200706051013.28676.marc.pignat@hevs.ch>

On Monday 04 June 2007 17:11, Michael Buesch wrote:
> Let's not apply this patch.
> This replaces something idiotic with something braindead. ;)
I agree, but it does the same and compiles on ARM arch.
> Better make it possible to use msleep.
> 
Sure


From larry.finger at lwfinger.net  Tue Jun  5 14:49:03 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 05 Jun 2007 07:49:03 -0500
Subject: firmware loading problems
In-Reply-To: <20070605070552.GA11398@apartia.fr>
References: <20070605070552.GA11398@apartia.fr>
Message-ID: <46655BBF.9090404@lwfinger.net>

Louis-David Mitterrand wrote:
> Hi,
> 
> Using kernel 2.6.21.2 on a debian unstable system I have this error when 
> "ifup wlan0":
> 
> 	Jun  3 09:21:13 styx kernel: bcm43xx: PHY connected
> 	Jun  3 09:21:13 styx kernel: firmware_loading_store: unexpected value (0)
> 	Jun  3 09:21:13 styx kernel: firmware_loading_store: unexpected value (0)
> 	Jun  3 09:21:13 styx kernel: bcm43xx: Error: InitVals "bcm43xx_initval06.fw" not available or load failed.
> 
> However if I "rmmod bcm43xx" then "modprobe bcm43xx" and retry bringing 
> up the wlan0 interface then it works fine.

There can be a firmware loading problem with certain versions of hotplug and udev. See 
http://bugs.gentoo.org/show_bug.cgi?id=147006 for a work-around.

Larry


From johannes at sipsolutions.net  Wed Jun  6 00:10:27 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 06 Jun 2007 00:10:27 +0200
Subject: initial value extraction
In-Reply-To: <20070330165002.GA3582@tuba>
References: <1175166566.8807.42.camel@johannes.berg>
	<20070329190613.GA3394@tuba> <1175251541.19085.14.camel@johannes.berg>
	<20070330165002.GA3582@tuba>
Message-ID: <1181081427.8274.39.camel@johannes.berg>

Martin,

> Look at the comment there. The 
> numbering is probably the same order you are using:
> 
>         /* core rev 0x2, 0x4 initval numbers: 1, 2, 3, 4 */
>         /* core rev 0x5 initval numbers: 5, 6, 7, 8, 9, 10 */
>         /* core rev 0x9 initval numbers: 11, 12, 13, 14, 15, 16 */
>         /* core rev 0xb initval numbers: 17, 18 */
>         /* core rev 0xd initval numbers: 19, 20 */

Alright, I decided that this is too confusing for me ;) I'm updating the
specs on this and I'll use Broadcom's names, leaving it to you/Michael
to decide on the numbers, maybe you can post a table.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070606/20fffe9d/attachment.pgp>

From ecwh73 at gmail.com  Wed Jun  6 21:12:19 2007
From: ecwh73 at gmail.com (Chris Hotte)
Date: Wed, 06 Jun 2007 15:12:19 -0400
Subject: Fixed MAC in monitor mode
Message-ID: <1181157139.16526.13.camel@laptop>

/* 
Hello, I've been lurking for a bit and finally decided to break cover. I
really hate to disturb the list for this question as my understanding
might be less than full when it comes to expected functionality. 

I've been trying to do some network analysis using my 4318. When the
card is put into monitor mode however, the Link Encap for eth1 goes to
UNSPEC and the Mac address is displayed as a 16 byte value separated by
dashes ie:

Managed vs Monitor mode. 
eth1      Link encap:Ethernet  HWaddr AA:BB:CC:DD:EE:FF 
eth1      Link encap:UNSPEC  HWaddr
AA-BB-CC-DD-EE-FF-00-00-00-00-00-00-00-00-00-00  
 

This breaks my ability to assign an arbitrary 6 byte MAC address while
in monitor mode. I need to be able to do this.   

I poked around in the code and found the following in
bcm43x_set_iwmode()

*/
        if (iw_mode == IW_MODE_MONITOR)
                net_dev->type = ARPHRD_IEEE80211;
        else
                net_dev->type = ARPHRD_ETHER;



/* 

but... this value apparently isn't the source of this behaviour, as I
tried forcing the net_dev->type value to remain statically set to
ARPHRD_ETHER;

Is there a way around this? According to the notes in the source version
that I'm using (2.6.20-16-generic - ubuntu), the card is always in
promisc anyhow. Can someone point me to a line to patch? I'd like to see
the card remain in promisc and simply have the mode flag set to
'Monitor'. 

-C
*/




From mb at bu3sch.de  Wed Jun  6 21:15:05 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 6 Jun 2007 21:15:05 +0200
Subject: Fixed MAC in monitor mode
In-Reply-To: <1181157139.16526.13.camel@laptop>
References: <1181157139.16526.13.camel@laptop>
Message-ID: <200706062115.05863.mb@bu3sch.de>

On Wednesday 06 June 2007 21:12:19 Chris Hotte wrote:
> /* 
> Hello, I've been lurking for a bit and finally decided to break cover. I
> really hate to disturb the list for this question as my understanding
> might be less than full when it comes to expected functionality. 
> 
> I've been trying to do some network analysis using my 4318. When the
> card is put into monitor mode however, the Link Encap for eth1 goes to
> UNSPEC and the Mac address is displayed as a 16 byte value separated by
> dashes ie:
> 
> Managed vs Monitor mode. 
> eth1      Link encap:Ethernet  HWaddr AA:BB:CC:DD:EE:FF 
> eth1      Link encap:UNSPEC  HWaddr
> AA-BB-CC-DD-EE-FF-00-00-00-00-00-00-00-00-00-00  

I'd say this is all expected bahaviour.

> 
> This breaks my ability to assign an arbitrary 6 byte MAC address while
> in monitor mode. I need to be able to do this.   

Why on earth would you need to assign some MAC to an
interface in monitor mode?

-- 
Greetings Michael.


From ecwh73 at gmail.com  Wed Jun  6 21:45:38 2007
From: ecwh73 at gmail.com (Chris Hotte)
Date: Wed, 06 Jun 2007 15:45:38 -0400
Subject: Fixed MAC in monitor mode
In-Reply-To: <200706062115.05863.mb@bu3sch.de>
References: <1181157139.16526.13.camel@laptop>
	<200706062115.05863.mb@bu3sch.de>
Message-ID: <1181159138.16526.38.camel@laptop>


> Why on earth would you need to assign some MAC to an
> interface in monitor mode.

Well, as everyone knows the WEP security algorithm is broken. Currently
some of our software still depends on it so were stuck with it. For the
time being I'm doing everything I can do monitor for weakness using
tools like aircrack-ng. http://www.aircrack-ng.org

So far I've only been able to test my network passively using this 4813
card due to this behaviour. The packet injection patch currently applies
and works, but has several slowdown issues. However for my purposes this
is fine. I'm not war driving ;-) 

I've watched demonstrations of wlan cards accepting 6 byte MAC
assignments while in monitor mode without complaint on the site above.
If this is contrary to expected behaviour, then I'm thinking they must
be using additional mods. 

- Chris.



From mb at bu3sch.de  Thu Jun  7 10:36:23 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 7 Jun 2007 10:36:23 +0200
Subject: Fixed MAC in monitor mode
In-Reply-To: <1181159138.16526.38.camel@laptop>
References: <1181157139.16526.13.camel@laptop>
	<200706062115.05863.mb@bu3sch.de>
	<1181159138.16526.38.camel@laptop>
Message-ID: <200706071036.24215.mb@bu3sch.de>

On Wednesday 06 June 2007 21:45:38 Chris Hotte wrote:
> 
> > Why on earth would you need to assign some MAC to an
> > interface in monitor mode.
> 
> Well, as everyone knows the WEP security algorithm is broken. Currently
> some of our software still depends on it so were stuck with it. For the
> time being I'm doing everything I can do monitor for weakness using
> tools like aircrack-ng. http://www.aircrack-ng.org
> 
> So far I've only been able to test my network passively using this 4813
> card due to this behaviour. The packet injection patch currently applies
> and works, but has several slowdown issues. However for my purposes this
> is fine. I'm not war driving ;-) 
> 
> I've watched demonstrations of wlan cards accepting 6 byte MAC
> assignments while in monitor mode without complaint on the site above.
> If this is contrary to expected behaviour, then I'm thinking they must
> be using additional mods. 

Eh, so? You still didn't say why you need to assign
some MAC address to the card then.
In monitor mode the card is promisc. That means the MAC filter
is bypassed.

-- 
Greetings Michael.


From comphappy at gmail.com  Sun Jun 10 07:23:47 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Sat, 9 Jun 2007 22:23:47 -0700
Subject: bcm4311 very unstable in kernel 2.6.21.4
Message-ID: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>

My bcm4311 has become very unsable in the new 2.6.21.4 kernel. It frequently
has core crashes, and recently when i modprobed, caused the system to crash.
 bcm43xx: ASSERTION FAILED (!err) at:
drivers/net/wireless/bcm43xx/bcm43xx_main.c :4095:bcm43xx_net_stop()

rmmod bcm43xx

never finshed running command.
The patch that i have been using is this one

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -1225,7 +1225,7 @@ static void bcm43xx_phy_initg(struct bcm
 	}
 	if (phy->rev < 3 && phy->connected)
 		bcm43xx_phy_write(bcm, 0x047E, 0x0078);
-	if (phy->rev >= 6 && phy->rev <= 8) {
+	if (phy->rev >= 6 && phy->rev < 8) {
 		bcm43xx_phy_write(bcm, 0x0801, bcm43xx_phy_read(bcm, 0x0801) | 0x0080);
 		bcm43xx_phy_write(bcm, 0x043E, bcm43xx_phy_read(bcm, 0x043E) | 0x0004);
 	}

But after going from the 2.6.20.3 kernel to 2.6.21.4 kernel, i could not use
the patch.  Looking at the kernel change log, this might be because of the
change in 2.6.20.7? But that is just a guess.

dmesg listing:
[root at mainserv ~]# dmesg | grep bcm43xx
bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0xf5, pl 0x5a (2003-12-22  20:11:25)
bcm43xx: Radio turned on
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .level = 2, .enabled = 1,
.encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1

lspci listing

[root at mainserv ~]# lspci | grep Broadcom
03:00.0 Network controller: Broadcom Corporation Dell Wireless 1390 WLAN
Mini-PCI Card (rev 01)

This card is a bcm4311

-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070609/b020978f/attachment.html>

From mb at bu3sch.de  Sun Jun 10 11:11:46 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 10 Jun 2007 11:11:46 +0200
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
Message-ID: <200706101111.46398.mb@bu3sch.de>

On Sunday 10 June 2007 07:23:47 Brennan Ashton wrote:
> My bcm4311 has become very unsable in the new 2.6.21.4 kernel. It frequently
> has core crashes, and recently when i modprobed, caused the system to crash.

What is a core crash?

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jun 10 19:13:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 10 Jun 2007 19:13:42 +0200
Subject: TX power stuff confusion
Message-ID: <200706101913.42966.mb@bu3sch.de>

I implemented the new stuff for the TX power adjustment and
it seems to work fine. Good work on the specs! :)

There's one thing left I'm confused about. That's the LO
rf-attenuation bb-attenuation tables.
So in LO calibration we calculate tables for the
attenuation values in these tables
http://bcm-v4.sipsolutions.net/802.11/LO/Tables
note that these tables have "gaps" and don't include
all possible attenuation values a device can be tuned to
in the txpower adjustment.
So, the LO adjustment with the recalculated attenuation values
is part of the TXpower adjustment (last step). If I
recalculated the attenuation values, there is a good
chance I hit some for which we did not precalibrate
the LO tables (the gaps). Of course the LO code complains.

I have no idea how this is possible to work.
The head of
http://bcm-v4.sipsolutions.net/802.11/LO/GPHY/BuildingTheTable
says:
"The I and Q values are kept for each possible attenuation
 value and are indexed by RF Attenuation and Baseband Attenuation."
But that's not what's described on the same page in the
algorithm description. There we do calculate
the LO values _just_ for the values in the tables from
http://bcm-v4.sipsolutions.net/802.11/LO/Tables
which do _not_ include all possible attenuation values.

If you want example code, look into my development tree. All
my development patches are applied there.
The code there spews lots of LO warnings (after waiting some
time until power recalibration hits in).

-- 
Greetings Michael.


From andrew.james.barr at gmail.com  Sun Jun 10 21:59:19 2007
From: andrew.james.barr at gmail.com (Andrew J. Barr)
Date: Sun, 10 Jun 2007 15:59:19 -0400
Subject: TX power stuff confusion
In-Reply-To: <200706101913.42966.mb@bu3sch.de>
References: <200706101913.42966.mb@bu3sch.de>
Message-ID: <20070610155919.17747dd4@powerbook.oakcourt.dyndns.org>

On Sun, 10 Jun 2007 19:13:42 +0200
Michael Buesch <mb at bu3sch.de> wrote:

> I implemented the new stuff for the TX power adjustment and
> it seems to work fine. Good work on the specs! :)

Where can I find this code? It doesn't seem to be in wireless-dev... :-/


From martin-langer at gmx.de  Sun Jun 10 22:23:34 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Sun, 10 Jun 2007 22:23:34 +0200
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
Message-ID: <20070610202334.GA4877@tuba>

On Sat, Jun 09, 2007 at 10:23:47PM -0700, Brennan Ashton wrote:

> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0xf5, pl 0x5a (2003-12-22  20:11:25)

Did you already tried newer firmware files?
e.g. http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o

Martin


From comphappy at gmail.com  Mon Jun 11 02:25:24 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Sun, 10 Jun 2007 17:25:24 -0700
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <20070610202334.GA4877@tuba>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
	<20070610202334.GA4877@tuba>
Message-ID: <b2d05de20706101725o7493928cr936e4e1bfbcbb6c0@mail.gmail.com>

I applied the new firmware with similar results, failed within 5min this
time. The console if filled with this message hundreds of times.

bcm43xx: ASSERTION FAILED (!ring->suspended) at:
drivers/net/wireless/bcm43xx/bcm43xx_dma.c:71:request_slot()

Then i lose connection altogether (networkmanager locks up).  I go to the
console and see this message:
bcm43xx: Controller RESET (TX timeout) ...
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
bcm43xx: Controller restart failed

When i go to do a rmmod bcm43xx i get this:
rmmod bcm43xx
bcm43xx: ASSERTION FAILED (!err) at:
drivers/net/wireless/bcm43xx/bcm43xx_main.c:4095:bcm43xx_net_stop()

and rmmod never completes execution, system then becomes very unstable.

Also wifi speeds seem to be less when it is actually running then in kernel
2.6.20.3, with the earlier patch.  The kernel is currently vanilla, are
there any other patches that i should try?  This patch seemed relaited, but
looks like it may have already been upstreamed
http://lists.berlios.de/pipermail/bcm43xx-dev/2006-November/003223.html?





On 6/10/07, Martin Langer <martin-langer at gmx.de> wrote:
>
> On Sat, Jun 09, 2007 at 10:23:47PM -0700, Brennan Ashton wrote:
>
> > bcm43xx: Chip ID 0x4311, rev 0x1
> > bcm43xx: Number of cores: 4
> > bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> > bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> > bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> > bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> > bcm43xx: PHY connected
> > bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> > bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> > bcm43xx: Radio turned off
> > bcm43xx: Radio turned off
> > bcm43xx: PHY connected
> > bcm43xx: Microcode rev 0xf5, pl 0x5a (2003-12-22  20:11:25)
>
> Did you already tried newer firmware files?
> e.g. http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
>
> Martin
>



-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070610/11dddd7e/attachment.html>

From larry.finger at lwfinger.net  Mon Jun 11 04:56:52 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 10 Jun 2007 21:56:52 -0500
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
Message-ID: <466CB9F4.5060207@lwfinger.net>

Brennan Ashton wrote:
> My bcm4311 has become very unsable in the new 2.6.21.4 <http://2.6.21.4> 
> kernel. It frequently has core crashes, and recently when i modprobed, 
> caused the system to crash.
>  bcm43xx: ASSERTION FAILED (!err) at: 
> drivers/net/wireless/bcm43xx/bcm43xx_main.c :4095:bcm43xx_net_stop()
> 
> rmmod bcm43xx
> 
> never finshed running command.
> The patch that i have been using is this one
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> ===================================================================
> 
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> @@ -1225,7 +1225,7 @@ static void bcm43xx_phy_initg(struct bcm
>  	}
>  	if (phy->rev < 3 && phy->connected)
> 
>  		bcm43xx_phy_write(bcm, 0x047E, 0x0078);
> -	if (phy->rev >= 6 && phy->rev <= 8) {
> +	if (phy->rev >= 6 && phy->rev < 8) {
>  		bcm43xx_phy_write(bcm, 0x0801, bcm43xx_phy_read(bcm, 0x0801) | 0x0080);
> 
>  		bcm43xx_phy_write(bcm, 0x043E, bcm43xx_phy_read(bcm, 0x043E) | 0x0004);
>  	}
> 

Where did you get this patch? It alone will ruin the performance of the BCM4311, which has phy->rev 
== 8!! For any 2.6.21.Y, you need to get and apply 
ftp://lwfinger.dynalias.org/patches/combined_2.6.21.patch. Alternatively, you can download 
2.6.22-rc4, which has all the patches for 2.6.21 built in.

Larry



From comphappy at gmail.com  Mon Jun 11 05:36:37 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Sun, 10 Jun 2007 20:36:37 -0700
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <466CB9F4.5060207@lwfinger.net>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
	<466CB9F4.5060207@lwfinger.net>
Message-ID: <b2d05de20706102036g2405fe5dja4bb8014797803c0@mail.gmail.com>

I got it off of the mailing list see
https://lists.berlios.de/pipermail/bcm43xx-dev/2007-February/003819.html
This patch took my sub 1Mb peformace and brought it up to full speed. This
was on the 2.6.20.3 kernel. The patch no longer works in the
2.6.21.4kernel. Read my first mailing. I have downloaded the new
kernel and am
patching it with 2.6.44-rc4 now.
On 6/10/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> Where did you get this patch? It alone will ruin the performance of the
> BCM4311, which has phy->rev
> == 8!! For any 2.6.21.Y, you need to get and apply
> ftp://lwfinger.dynalias.org/patches/combined_2.6.21.patch. Alternatively,
> you can download
> 2.6.22-rc4, which has all the patches for 2.6.21 built in.
>
> Larry
>
>


-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070610/30ba3c5d/attachment.html>

From proski at gnu.org  Mon Jun 11 07:59:06 2007
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 11 Jun 2007 01:59:06 -0400
Subject: TX power stuff confusion
In-Reply-To: <200706101913.42966.mb@bu3sch.de>
References: <200706101913.42966.mb@bu3sch.de>
Message-ID: <1181541546.4951.24.camel@dl>

On Sun, 2007-06-10 at 19:13 +0200, Michael Buesch wrote:
> I implemented the new stuff for the TX power adjustment and
> it seems to work fine. Good work on the specs! :)

I'm very glad about it!

I checked out the current code http://bu3sch.de/git/wireless-dev.git and
compiled it.  First time the kernel would not even boot (Fedora is "too
smart" to load all modules on startup), but I saw debugfs in the stck
track.  CONFIG_DEBUG_FS was disabled, so I enabled it.

This time I could boot, but I saw some stack traces and messages you may
want to see.  This is the part of the kernel log starting with wireless
initialization.

It's going to be a busy week for me, so I don't expect to participate in
debugging much, but I'm ready to send more information if needed.

This is Fedora 7 x86_64 on Dell D-520 laptop with PCIe BCM4311.

Thanks to everybody involved!  Even if it's not working for me now, I'm
sure it will work really soon.

-- 
Regards,
Pavel Roskin
-------------- next part --------------
A non-text attachment was scrubbed...
Name: bcm.log
Type: text/x-log
Size: 8872 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070611/575765c0/attachment.bin>

From comphappy at gmail.com  Mon Jun 11 09:13:30 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Mon, 11 Jun 2007 00:13:30 -0700
Subject: TX power stuff confusion
In-Reply-To: <1181541546.4951.24.camel@dl>
References: <200706101913.42966.mb@bu3sch.de> <1181541546.4951.24.camel@dl>
Message-ID: <b2d05de20706110013r23eb89a5i1c1b2e0f861cada5@mail.gmail.com>

I have the same card (on fedora), it is working great now that i used the
new kernel and firmware code. kernel 2.6.22-rc4, dont use the
2.6.21.4kernel.  When you update, make shure you go in menuconfig and
select to
install as a module, it's placement has changed and will not load with your
old config file (third time compiling tonight).  Hope you get that card
working.

On 6/10/07, Pavel Roskin <proski at gnu.org> wrote:
>
> On Sun, 2007-06-10 at 19:13 +0200, Michael Buesch wrote:
> > I implemented the new stuff for the TX power adjustment and
> > it seems to work fine. Good work on the specs! :)
>
> I'm very glad about it!
>
> I checked out the current code http://bu3sch.de/git/wireless-dev.git and
> compiled it.  First time the kernel would not even boot (Fedora is "too
> smart" to load all modules on startup), but I saw debugfs in the stck
> track.  CONFIG_DEBUG_FS was disabled, so I enabled it.
>
> This time I could boot, but I saw some stack traces and messages you may
> want to see.  This is the part of the kernel log starting with wireless
> initialization.
>
> It's going to be a busy week for me, so I don't expect to participate in
> debugging much, but I'm ready to send more information if needed.
>
> This is Fedora 7 x86_64 on Dell D-520 laptop with PCIe BCM4311.
>
> Thanks to everybody involved!  Even if it's not working for me now, I'm
> sure it will work really soon.
>
> --
> Regards,
> Pavel Roskin
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
>


-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070611/6873411e/attachment.html>

From comphappy at gmail.com  Mon Jun 11 09:14:44 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Mon, 11 Jun 2007 00:14:44 -0700
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <b2d05de20706102036g2405fe5dja4bb8014797803c0@mail.gmail.com>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>
	<466CB9F4.5060207@lwfinger.net>
	<b2d05de20706102036g2405fe5dja4bb8014797803c0@mail.gmail.com>
Message-ID: <b2d05de20706110014u38da84c2ha7ca52c4381c4795@mail.gmail.com>

2.6.22-rc4 fixed it

On 6/10/07, Brennan Ashton <comphappy at gmail.com> wrote:
>
> I got it off of the mailing list see
> https://lists.berlios.de/pipermail/bcm43xx-dev/2007-February/003819.html
> This patch took my sub 1Mb peformace and brought it up to full speed. This
> was on the 2.6.20.3 kernel. The patch no longer works in the 2.6.21.4kernel. Read my first mailing. I have downloaded the new kernel and am
> patching it with 2.6.44-rc4 now.
> On 6/10/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> >
> > Where did you get this patch? It alone will ruin the performance of the
> > BCM4311, which has phy->rev
> > == 8!! For any 2.6.21.Y, you need to get and apply
> > ftp://lwfinger.dynalias.org/patches/combined_2.6.21.patch.
> > Alternatively, you can download
> > 2.6.22-rc4, which has all the patches for 2.6.21 built in.
> >
> > Larry
> >
> >
>
>
> --
> Brennan Ashton
> Bellingham, Washington
>
> "The box said, 'Requires Windows 98 or better'. So I installed Linux"
>



-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070611/03556217/attachment.html>

From proski at gnu.org  Mon Jun 11 13:04:36 2007
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 11 Jun 2007 07:04:36 -0400
Subject: TX power stuff confusion
In-Reply-To: <b2d05de20706110013r23eb89a5i1c1b2e0f861cada5@mail.gmail.com>
References: <200706101913.42966.mb@bu3sch.de> <1181541546.4951.24.camel@dl>
	<b2d05de20706110013r23eb89a5i1c1b2e0f861cada5@mail.gmail.com>
Message-ID: <466D2C44.5070505@gnu.org>

Hello Brennan,

Brennan Ashton wrote:
> I have the same card (on fedora), it is working great now that i used the
> new kernel and firmware code. kernel 2.6.22-rc4, dont use the
> 2.6.21.4kernel.

It's the version from git, which should be newer than 2.6.22-rc4 and 
should include the new TX power adjustment code.

> When you update, make shure you go in menuconfig and
> select to
> install as a module, it's placement has changed and will not load with your
> old config file (third time compiling tonight).

It is a module.  And it's bcm43xx_mac80211, it case I was unclear.

> Hope you get that card
> working.

It is working with bcm43xx.  It was also working with bcm43xx_mac80211 
is older kernels, but only with some APs and only with patches limiting 
the Tx rate.

> On 6/10/07, Pavel Roskin <proski at gnu.org> wrote:
>>
>> On Sun, 2007-06-10 at 19:13 +0200, Michael Buesch wrote:
>> > I implemented the new stuff for the TX power adjustment and
>> > it seems to work fine. Good work on the specs! :)

Please don't top post.  If you put the original message to the bottom, 
it makes you miss important points.  I was testing the new TX power 
adjustment, and my point was that the new code was emitting some messages.

-- 
Regards,
Pavel Roskin


From mb at bu3sch.de  Mon Jun 11 14:42:03 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 11 Jun 2007 14:42:03 +0200
Subject: TX power stuff confusion
In-Reply-To: <1181541546.4951.24.camel@dl>
References: <200706101913.42966.mb@bu3sch.de> <1181541546.4951.24.camel@dl>
Message-ID: <200706111442.04108.mb@bu3sch.de>

On Monday 11 June 2007 07:59:06 Pavel Roskin wrote:
> I saw some stack traces and messages

That's what this mail was about, in the first place. ;)

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Jun 11 16:22:59 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 11 Jun 2007 09:22:59 -0500
Subject: bcm4311 very unstable in kernel 2.6.21.4
In-Reply-To: <b2d05de20706110014u38da84c2ha7ca52c4381c4795@mail.gmail.com>
References: <b2d05de20706092223j46109ac9y2cf7aff6399eee2f@mail.gmail.com>	<466CB9F4.5060207@lwfinger.net>	<b2d05de20706102036g2405fe5dja4bb8014797803c0@mail.gmail.com>
	<b2d05de20706110014u38da84c2ha7ca52c4381c4795@mail.gmail.com>
Message-ID: <466D5AC3.3070108@lwfinger.net>

Brennan Ashton wrote:
> 2.6.22-rc4 fixed it

Good. I was pretty sure it wouls. Your wireless hardware is just like mine, which works very well. 
with bcm43xx-softmac.

Larry



From larry.finger at lwfinger.net  Mon Jun 11 16:34:24 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 11 Jun 2007 09:34:24 -0500
Subject: TX power stuff confusion
In-Reply-To: <b2d05de20706110013r23eb89a5i1c1b2e0f861cada5@mail.gmail.com>
References: <200706101913.42966.mb@bu3sch.de> <1181541546.4951.24.camel@dl>
	<b2d05de20706110013r23eb89a5i1c1b2e0f861cada5@mail.gmail.com>
Message-ID: <466D5D70.9030803@lwfinger.net>

Brennan Ashton wrote:
> I have the same card (on fedora), it is working great now that i used 
> the new kernel and firmware code. kernel 2.6.22-rc4, dont use the 
> 2.6.21.4 <http://2.6.21.4> kernel.  When you update, make shure you go 
> in menuconfig and select to install as a module, it's placement has 
> changed and will not load with your old config file (third time 
> compiling tonight).  Hope you get that card working.

As someone else said, it is extremely rude to top post.

One other point to make here is that your comments have no relationship to the question at hand in 
this thread. There are two different bcm43xx drivers at the moment. The one you are using is 
bcm43xx-softmac, which is in the mainstream kernel and uses the SoftMAC package for its MAC layer. 
SoftMAC is buggy and very limited, thus it will be removed from the kernel in favor of the mac80211 
MAC layer as soon as all the drivers have been ported. Unfortunately, bcm43xx-mac80211, which is the 
driver being discussed in this thread, has severe transmit power difficulties that have been 
difficult to correct.

Larry


From larry.finger at lwfinger.net  Mon Jun 11 18:17:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 11 Jun 2007 11:17:41 -0500
Subject: TX power stuff confusion
In-Reply-To: <200706111442.04108.mb@bu3sch.de>
References: <200706101913.42966.mb@bu3sch.de> <1181541546.4951.24.camel@dl>
	<200706111442.04108.mb@bu3sch.de>
Message-ID: <466D75A5.4090007@lwfinger.net>

Michael Buesch wrote:
> On Monday 11 June 2007 07:59:06 Pavel Roskin wrote:
>> I saw some stack traces and messages
> 
> That's what this mail was about, in the first place. ;)
> 

Besides the messages about invalid LO control pairs and invalid bband_att values, my BCM4311 also
got a kernel general protection fault in bcm43xx_lo_g_measure as follows:

general protection fault: 0000 [1] SMP
CPU 1
Modules linked in: nfs lockd nfs_acl sunrpc vboxdrv af_packet snd_pcm_oss snd_mixer_oss snd_seq
snd_seq_device cpufreq_conservative cpufreq_ondemand cpufreq_userspace cpufreq_powersave powernow_k8
freq_table button battery ac loop dm_mod sdhci ide_cd mmc_core cdrom arc4 ohci1394 ecb blkcipher
rc80211_simple ieee1394 forcedeth snd_hda_intel snd_pcm snd_timer snd soundcore snd_page_alloc
bcm43xx_mac80211 firmware_class mac80211 ohci_hcd cfg80211 ehci_hcd usbcore i2c_nforce2 ext3 mbcache
jbd sg edd fan sata_nv libata amd74xx thermal processor sd_mod scsi_mod ide_disk ide_core
Pid: 1998, comm: bcm43xx_mac8021 Not tainted 2.6.22-rc4-mb-g54e4d056-dirty #3
RIP: 0010:[<ffffffff8819a071>]  [<ffffffff8819a071>] :bcm43xx_mac80211:bcm43xx_lo_g_measure+0x9fd/0x10f7
RSP: 0018:ffff8100597efcc0  EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff81005b624158 RCX: ffff8100591923e0
RDX: ff01ffff8819fedf RSI: 0000000000000043 RDI: 0000000000000000
RBP: ffff8100597efe20 R08: ffff8100591923c8 R09: ffff81005ab4a500
R10: 0000000000000000 R11: 0000000000000000 R12: ffff8100591923c8
R13: ffff8100591923e0 R14: ffff81005b624158 R15: 0000000000000000
FS:  00002af64db2cb00(0000) GS:ffff810037c32430(0000) knlGS:00000000f32ffb90
CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
CR2: 00002aaaab61610c CR3: 000000003e6b0000 CR4: 00000000000006e0
Process bcm43xx_mac8021 (pid: 1998, threadinfo ffff8100597ee000, task ffff81005afb4040)
Stack:  0000000000000000 0000000000000046 ffff81005b624158 ffff8100591933f8
  0000000000000000 0000000000000000 00008100597efd40 0000000000520000
  ffff81005afb4040 ffff81005b624158 0000000000000000 ffff8100597efd48
Call Trace:
  [<ffffffff8024c398>] mark_held_locks+0x4a/0x6a
  [<ffffffff803e0c84>] trace_hardirqs_on_thunk+0x35/0x37
  [<ffffffff88188a9e>] :bcm43xx_mac80211:bcm43xx_shm_read32+0xe8/0xf1
  [<ffffffff8020a53c>] restore_args+0x0/0x30
  [<ffffffff8818a46e>] :bcm43xx_mac80211:do_periodic_work+0x44/0x1b3
  [<ffffffff88189b66>] :bcm43xx_mac80211:bcm43xx_synchronize_irq+0x26/0x2a
  [<ffffffff8818a6e0>] :bcm43xx_mac80211:bcm43xx_periodic_work_handler+0x103/0x191
  [<ffffffff8024c582>] trace_hardirqs_on+0x11c/0x147
  [<ffffffff8818a5dd>] :bcm43xx_mac80211:bcm43xx_periodic_work_handler+0x0/0x191
  [<ffffffff80241436>] run_workqueue+0x97/0x16a
  [<ffffffff80241d25>] worker_thread+0x0/0xea
  [<ffffffff80241e04>] worker_thread+0xdf/0xea
  [<ffffffff8024504f>] autoremove_wake_function+0x0/0x38
  [<ffffffff80244f40>] kthread+0x49/0x79
  [<ffffffff8020ae28>] child_rip+0xa/0x12
  [<ffffffff8020a53c>] restore_args+0x0/0x30
  [<ffffffff80244ef7>] kthread+0x0/0x79
  [<ffffffff8020ae1e>] child_rip+0x0/0x12


Code: 66 0f b6 14 3a 4c 89 e7 09 c2 0f b7 d2 e8 55 39 ff ff 0f b7
RIP  [<ffffffff8819a071>] :bcm43xx_mac80211:bcm43xx_lo_g_measure+0x9fd/0x10f7
  RSP <ffff8100597efcc0>


Larry




From jmiahman at gmail.com  Tue Jun 12 19:09:56 2007
From: jmiahman at gmail.com (Jeremiah Summers)
Date: Tue, 12 Jun 2007 10:09:56 -0700
Subject: Donations
Message-ID: <3b613dbe0706121009y51bc1414v7a0aacd5171d8985@mail.gmail.com>

Hello All,
              My name is Jeremiah I run a hardware database for a Linux
distribution called PCLinuxOS. I have been watching and reading your mailing
lists for a while. I've even gotten your drivers to work on my 4306s.
There's still a lot of users using ndiswrapper for their cards, I think this
is because some issues with the 4318s and different caveats they have ran
into using the bcm43xx. It is my hope that someday soon ndiswrapper won't be
needed for the Broadcom 43xx cards. I really like your project so I've
decided that for the next few weeks any donations that go to my website I
will give to you guys, no strings attached or anything. The drive ends on
the 27th at which time I will donate through paypal. Now don't get your
hopes up high as I don't receive that many donations but I'm sure every
little bit counts and it's the least I can do. Thanks a ton for all of your
hard work.

Jmiahman
(Jeremiah Summers)
http://PCLinuxOSHWDB.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070612/6b99216d/attachment.html>

From gnawux at gmail.com  Thu Jun 14 03:48:21 2007
From: gnawux at gmail.com (Wang Xu)
Date: Thu, 14 Jun 2007 09:48:21 +0800
Subject: bcm43xx-mac80211: invalid bband_att
Message-ID: <da8464b10706131848y739cb8d9v3d6fefe178ec3892@mail.gmail.com>

Hi all,

I got a broadcom bcm4318 mini pci card this week and managed make it
work with ndiswrapper. Then I  git  linville's wireless-dev tree and pull
http://bu3sch.de/git/wireless-dev.git master

Having built new kernel and reboot, I got such an error:
     bcm43xx_mac80211: ERROR: invalid bband_att: 11
what is this mean?

PS: the module has been loaded and I can saw the card info with iwconfig.
I cannot test whether it is able to work since there is not an AP present today.

The following is the context in my dmesg:

bcm43xx_mac80211: Adding Interface type 2
ssb: Switching to PCI core, index 2
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: ERROR: invalid bband_att: 11
 [<e0522cfb>] bcm43xx_get_lo_g_ctl+0x51/0x85 [bcm43xx_mac80211]
 [<e0522d61>] bcm43xx_lo_g_ctl_current+0x32/0x35 [bcm43xx_mac80211]
 [<e0522e49>] bcm43xx_lo_g_adjust+0x8/0x12 [bcm43xx_mac80211]
 [<e051d9f7>] bcm43xx_phy_init_pctl+0x2ee/0x607 [bcm43xx_mac80211]
 [<e051867a>] bcm43xx_phy_write+0x5e/0x66 [bcm43xx_mac80211]
 [<e05209d4>] bcm43xx_phy_initg+0xbf7/0xc59 [bcm43xx_mac80211]
 [<c01193be>] vprintk+0x28f/0x2aa
 [<e0521146>] bcm43xx_phy_init+0x514/0x530 [bcm43xx_mac80211]
 [<e05145a3>] bcm43xx_chip_init+0x62b/0x8f4 [bcm43xx_mac80211]
 [<e051544c>] bcm43xx_wireless_core_init+0x225/0x7b4 [bcm43xx_mac80211]
 [<c014065f>] __generic_file_aio_write_nolock+0x488/0x4e4
 [<e0517bff>] bcm43xx_add_interface+0x53/0xe5 [bcm43xx_mac80211]
 [<e04b0889>] ieee80211_open+0x23f/0x375 [mac80211]
 [<c0140719>] generic_file_aio_write+0x5e/0xb3
 [<c0283493>] dev_open+0x2d/0x66
 [<c02820e2>] dev_change_flags+0x4d/0xfd
 [<c02bcff9>] devinet_ioctl+0x259/0x576
 [<c0283171>] dev_ifsioc+0x113/0x399
 [<c0282ccf>] dev_load+0x18/0x57
 [<c02787e4>] sock_ioctl+0x0/0x1be
 [<c0278983>] sock_ioctl+0x19f/0x1be
 [<c02787e4>] sock_ioctl+0x0/0x1be
 [<c01635a1>] do_ioctl+0x21/0x9f
 [<c016384a>] vfs_ioctl+0x22b/0x23e
 [<c027a25c>] sys_socketcall+0x5d/0x242
 [<c01638a9>] sys_ioctl+0x4c/0x67
 [<c0103bda>] sysenter_past_esp+0x5f/0x85
 =======================
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
HW CONFIG: channel=1 freq=2412 phymode=3

-- 
Wang Xu


From mb at bu3sch.de  Sat Jun 16 13:28:53 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 16 Jun 2007 13:28:53 +0200
Subject: [RFC PATCH] bcm43xx QoS support
Message-ID: <200706161328.53726.mb@bu3sch.de>

This incomplete patch tries to implement QoS support in
the bcm43xx driver.
It's incomplete, because we don't upload the QoS parameters
to the hardware, yet.
http://bcm-v4.sipsolutions.net/802.11/QoS
We might need some stack support to implement this (I'm not
entirely sure, as I didn't read the whole ieee 802.11e, yet).
Does some stack support for QoS exist? We need to upload
some TX-opportunity, Interframe-space and some other values
to the firmware. Not sure where to get them from, yet (didn't
completely read 802.11e, yet :) ).

The bcm43xx device has 6 DMA rings, but I think only 4
are usable for 802.11e QoS. The other two seem to be useful
for APs, though.

This patch also implements per-DMAring-locking. So this
(theoretically) enables the stack to simultaneously transmit
on two (or more) rings. Though, I'm not sure the stack exploits this
behaviour, yet.


Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.c	2007-06-02 23:14:46.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.c	2007-06-16 00:38:59.000000000 +0200
@@ -290,6 +290,50 @@ void return_slot(struct bcm43xx_dmaring 
 	ring->used_slots--;
 }
 
+/* Mac80211-queue to bcm43xx-ring mapping */
+static struct bcm43xx_dmaring * priority_to_txring(struct bcm43xx_wldev *dev,
+						   int queue_priority)
+{
+	struct bcm43xx_dmaring *ring;
+
+	/* 0 = highest priority */
+	switch (queue_priority) {
+	default:
+		assert(0);
+		/* fallthrough */
+	case 0:
+		ring = dev->dma.tx_ring3;
+		break;
+	case 1:
+		ring = dev->dma.tx_ring2;
+		break;
+	case 2:
+		ring = dev->dma.tx_ring1;
+		break;
+	case 3:
+		ring = dev->dma.tx_ring0;
+		break;
+	case 4:
+		ring = dev->dma.tx_ring4;
+		break;
+	case 5:
+		ring = dev->dma.tx_ring5;
+		break;
+	}
+
+	return ring;
+}
+
+/* Bcm43xx-ring to mac80211-queue mapping */
+static inline int txring_to_priority(struct bcm43xx_dmaring *ring)
+{
+	static const u8 idx_to_prio[] =
+		{ 3, 2, 1, 0, 4, 5, };
+
+	return idx_to_prio[ring->index];
+}
+
+
 u16 bcm43xx_dmacontroller_base(int dma64bit, int controller_idx)
 {
 	static const u16 map64[] = {
@@ -816,6 +860,7 @@ struct bcm43xx_dmaring * bcm43xx_setup_d
 		} else
 			assert(0);
 	}
+	spin_lock_init(&ring->lock);
 #ifdef CONFIG_BCM43XX_MAC80211_DEBUG
 	ring->last_injected_overflow = jiffies;
 #endif
@@ -1171,37 +1216,39 @@ int bcm43xx_dma_tx(struct bcm43xx_wldev 
 		   struct sk_buff *skb,
 		   struct ieee80211_tx_control *ctl)
 {
-	struct bcm43xx_dmaring *ring = dev->dma.tx_ring1;
+	struct bcm43xx_dmaring *ring;
 	int err = 0;
+	unsigned long flags;
 
+	ring = priority_to_txring(dev, ctl->queue);
+	spin_lock_irqsave(&ring->lock, flags);
 	assert(ring->tx);
 	if (unlikely(free_slots(ring) < SLOTS_PER_PACKET)) {
-		/* This should never trigger, as we call
-		 * ieee80211_stop_queue() when it's full.
-		 */
 		printkl(KERN_ERR PFX "DMA queue overflow\n");
-		return NETDEV_TX_BUSY;
+		err = -ENOSPC;
+		goto out_unlock;
 	}
 	/* Check if the queue was stopped in mac80211,
-	 * but we got called nevertheless. */
+	 * but we got called nevertheless.
+	 * That would be a mac80211 bug. */
 	assert(!ring->stopped);
 
 	err = dma_tx_fragment(ring, skb, ctl);
 	if (unlikely(err)) {
 		printkl(KERN_ERR PFX "DMA tx mapping failure\n");
-		return NETDEV_TX_BUSY;
+		goto out_unlock;
 	}
-
 	ring->nr_tx_packets++;
 	if ((free_slots(ring) < SLOTS_PER_PACKET) ||
 	    should_inject_overflow(ring)) {
 		/* This TX ring is full. */
-		/* FIXME: we currently only have one queue, so hardcode queue 0 here. */
-		ieee80211_stop_queue(dev->wl->hw, 0);
+		ieee80211_stop_queue(dev->wl->hw, txring_to_priority(ring));
 		ring->stopped = 1;
 	}
+out_unlock:
+	spin_unlock_irqrestore(&ring->lock, flags);
 
-	return 0;
+	return err;
 }
 
 void bcm43xx_dma_handle_txstatus(struct bcm43xx_wldev *dev,
@@ -1216,6 +1263,9 @@ void bcm43xx_dma_handle_txstatus(struct 
 	ring = parse_cookie(dev, status->cookie, &slot);
 	if (unlikely(!ring))
 		return;
+	assert(irqs_disabled());
+	spin_lock(&ring->lock);
+
 	assert(ring->tx);
 	ops = ring->ops;
 	while (1) {
@@ -1257,24 +1307,32 @@ void bcm43xx_dma_handle_txstatus(struct 
 	dev->stats.last_tx = jiffies;
 	if (ring->stopped) {
 		assert(free_slots(ring) >= SLOTS_PER_PACKET);
-		/* FIXME: we currently only have one queue, co hardcode queue 0 here. */
-		ieee80211_wake_queue(dev->wl->hw, 0);
+		ieee80211_wake_queue(dev->wl->hw, txring_to_priority(ring));
 		ring->stopped = 0;
 	}
+
+	spin_unlock(&ring->lock);
 }
 
 void bcm43xx_dma_get_tx_stats(struct bcm43xx_wldev *dev,
 			      struct ieee80211_tx_queue_stats *stats)
 {
-	struct bcm43xx_dma *dma = &dev->dma;
+	const int nr_queues = dev->wl->hw->queues;
 	struct bcm43xx_dmaring *ring;
 	struct ieee80211_tx_queue_stats_data *data;
+	unsigned long flags;
+	int i;
 
-	ring = dma->tx_ring1;
-	data = &(stats->data[0]);
-	data->len = ring->used_slots / SLOTS_PER_PACKET;
-	data->limit = ring->nr_slots / SLOTS_PER_PACKET;
-	data->count = ring->nr_tx_packets;
+	for (i = 0; i < nr_queues; i++) {
+		data = &(stats->data[i]);
+		ring = priority_to_txring(dev, i);
+
+		spin_lock_irqsave(&ring->lock, flags);
+		data->len = ring->used_slots / SLOTS_PER_PACKET;
+		data->limit = ring->nr_slots / SLOTS_PER_PACKET;
+		data->count = ring->nr_tx_packets;
+		spin_unlock_irqrestore(&ring->lock, flags);
+	}
 }
 
 static void dma_rx(struct bcm43xx_dmaring *ring,
@@ -1397,16 +1455,24 @@ void bcm43xx_dma_rx(struct bcm43xx_dmari
 	ring->current_slot = slot;
 }
 
-static inline void bcm43xx_dma_tx_suspend_ring(struct bcm43xx_dmaring *ring)
+static void bcm43xx_dma_tx_suspend_ring(struct bcm43xx_dmaring *ring)
 {
+	unsigned long flags;
+
+	spin_lock_irqsave(&ring->lock, flags);
 	assert(ring->tx);
 	ring->ops->tx_suspend(ring);
+	spin_unlock_irqrestore(&ring->lock, flags);
 }
 
-static inline void bcm43xx_dma_tx_resume_ring(struct bcm43xx_dmaring *ring)
+static void bcm43xx_dma_tx_resume_ring(struct bcm43xx_dmaring *ring)
 {
+	unsigned long flags;
+
+	spin_lock_irqsave(&ring->lock, flags);
 	assert(ring->tx);
 	ring->ops->tx_resume(ring);
+	spin_unlock_irqrestore(&ring->lock, flags);
 }
 
 void bcm43xx_dma_tx_suspend(struct bcm43xx_wldev *dev)
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.h
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.h	2007-06-02 22:54:41.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_dma.h	2007-06-16 00:43:40.000000000 +0200
@@ -252,6 +252,8 @@ struct bcm43xx_dmaring {
 	u8 dma64;
 	/* Boolean. Is this ring stopped at ieee80211 level? */
 	u8 stopped;
+	/* Lock, only used for TX. */
+	spinlock_t lock;
 	struct bcm43xx_wldev *dev;
 #ifdef CONFIG_BCM43XX_MAC80211_DEBUG
 	/* Maximum number of used slots. */
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c	2007-06-14 16:05:09.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_main.c	2007-06-16 00:50:26.000000000 +0200
@@ -2448,16 +2448,17 @@ static int bcm43xx_tx(struct ieee80211_h
 	int err = -ENODEV;
 	unsigned long flags;
 
+	/* DMA-TX is done without a global lock. */
 	if (unlikely(!dev))
 		goto out;
-	spin_lock_irqsave(&wl->irq_lock, flags);
-	if (likely(bcm43xx_status(dev) == BCM43xx_STAT_INITIALIZED)) {
-		if (bcm43xx_using_pio(dev))
-			err = bcm43xx_pio_tx(dev, skb, ctl);
-		else
-			err = bcm43xx_dma_tx(dev, skb, ctl);
-	}
-	spin_unlock_irqrestore(&wl->irq_lock, flags);
+	assert(bcm43xx_status(dev) == BCM43xx_STAT_INITIALIZED);
+	assert(dev->started);
+	if (bcm43xx_using_pio(dev)) {
+		spin_lock_irqsave(&wl->irq_lock, flags);
+		err = bcm43xx_pio_tx(dev, skb, ctl);
+		spin_unlock_irqrestore(&wl->irq_lock, flags);
+	} else
+		err = bcm43xx_dma_tx(dev, skb, ctl);
 out:
 	if (unlikely(err))
 		return NETDEV_TX_BUSY;
@@ -3313,10 +3314,13 @@ static int bcm43xx_wireless_core_init(st
 	bcm43xx_write_mac_bssid_templates(dev);
 
 	do {
-		if (bcm43xx_using_pio(dev))
+		if (bcm43xx_using_pio(dev)) {
 			err = bcm43xx_pio_init(dev);
-		else
+		} else {
 			err = bcm43xx_dma_init(dev);
+			if (!err)
+				bcm43xx_qos_init(dev);
+		}
 	} while (err == -EAGAIN);
 	if (err)
 		goto err_chip_exit;
@@ -3798,7 +3802,7 @@ static int bcm43xx_wireless_init(struct 
 	hw->max_signal = 100;
 	hw->max_rssi = -110;
 	hw->max_noise = -110;
-	hw->queues = 1;
+	hw->queues = 4;
 	SET_IEEE80211_DEV(hw, dev->dev);
 	if (is_valid_ether_addr(sprom->r1.et1mac))
 		SET_IEEE80211_PERM_ADDR(hw, sprom->r1.et1mac);
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c	2007-06-10 14:37:06.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c	2007-06-16 13:14:30.000000000 +0200
@@ -619,3 +619,28 @@ void bcm43xx_tx_resume(struct bcm43xx_wl
 	else
 		bcm43xx_dma_tx_resume(dev);
 }
+
+static void upload_qos_parms(struct bcm43xx_wldev *dev,
+			     const u16 *parms,
+			     u16 offset)
+{
+	int i;
+
+	for (i = 0; i < BCM43xx_NR_QOSPARMS; i++) {
+		bcm43xx_shm_write16(dev, BCM43xx_SHM_SHARED,
+				    offset + i, parms[i]);
+	}
+}
+
+/* Initialize the QoS parameters */
+void bcm43xx_qos_init(struct bcm43xx_wldev *dev)
+{
+	//TODO
+	bcm43xx_hf_write(dev, bcm43xx_hf_read(dev) | BCM43xx_HF_EDCF);
+	//FIXME kill magic
+	bcm43xx_write16(dev, 0x688,
+			bcm43xx_read16(dev, 0x688) | 0x4);
+
+
+	/*TODO: We might need some stack support here to get the values. */
+}
Index: bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h
===================================================================
--- bu3sch-wireless-dev.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h	2007-06-01 01:14:02.000000000 +0200
+++ bu3sch-wireless-dev/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h	2007-06-16 01:09:03.000000000 +0200
@@ -215,6 +215,21 @@ void bcm43xx_handle_hwtxstatus(struct bc
 void bcm43xx_tx_suspend(struct bcm43xx_wldev *dev);
 void bcm43xx_tx_resume(struct bcm43xx_wldev *dev);
 
+
+#define BCM43xx_NR_QOSPARMS		21
+enum {
+	BCM43xx_QOSPARM_TXOP = 0,
+	BCM43xx_QOSPARM_CWMIN,
+	BCM43xx_QOSPARM_CWMAX,
+	BCM43xx_QOSPARM_CWCUR,
+	BCM43xx_QOSPARM_AIFS,
+	BCM43xx_QOSPARM_BSLOTS,
+	BCM43xx_QOSPARM_REGGAP,
+	BCM43xx_QOSPARM_STATUS,
+};
+void bcm43xx_qos_init(struct bcm43xx_wldev *dev);
+
+
 /* Helper functions for converting the key-table index from "firmware-format"
  * to "raw-format" and back. The firmware API changed for this at some revision.
  * We need to account for that here. */

-- 
Greetings Michael.


From mb at bu3sch.de  Sat Jun 16 20:17:47 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 16 Jun 2007 20:17:47 +0200
Subject: Please pull latest and greatest bcm43xx
Message-ID: <200706162017.47516.mb@bu3sch.de>

John,

Please pull for-linville branch of my tree.
It contains a lot of bugfixes and makes a _big_ step towards
mergability for mainline.
It's not 100% ready for a merge, yet, but we are making good progress.
The transmission power problems on the 4306, that were one of the big
merge blockers, seem almost all fixed. I get good performance now.
I also added lots of txpower debugging stuff so one can actually
see what's going on and how it's scaling.
Together with Michael Wu's sta-locking rewrite patch for
mac80211 we have the most critical merge blockers resolved now.

I'd like people to test this code.
It will spew a big assertion failure and a stacktrace on loading.
Ignore that for now. It's known and considered nonfatal for now.



The following changes since commit 9181e959da76d85d688d8ec763702ed2f3b4edf9:
  John W. Linville:
        rt2x00firmware.c: include delay.h to avoid build error on ppc64

are found in the git repository at:

  http://bu3sch.de/git/wireless-dev.git/ for-linville

Michael Buesch:
      bcm43xx-mac80211: Don't stop the mac80211 software queues in pwork.
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      bcm43xx-mac80211: Use the mac80211 provided workqueue
      bcm43xx-mac80211: Fix mutex leakage in pwork.
      bcm43xx-mac80211: Flush the workqueue to make sure periodic work has finished.
      bcm43xx-mac80211: Implement runtime debugging mechanism.
      bcm43xx-mac80211: Code to inject TX ring overflows.
      bcm43xx-mac80211: Rewrite the attenuation adjustment.
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      ssb: Fix maxpwr and itssi read.
      bcm43xx-mac80211: Add more txpower debugging.
      bcm43xx-mac80211: add debugfs file to manually control txpower
      bcm43xx-mac80211: Some LO cleanups
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      bcm43xx-mac80211: Use the dynamic min/max values for adjusting the attenuation.

 drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h    |   29 +
 .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.c    |  210 +++++++++
 .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.h    |   21 +
 .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.c    |   63 +++
 .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.h    |   10 
 drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.c |  107 ++--
 drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.h |    6 
 .../net/wireless/mac80211/bcm43xx/bcm43xx_main.c   |   64 +--
 .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.c    |  515 ++++++++++++-----------
 .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.h    |   23 +
 .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c   |   18 +
 .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h   |    2 
 drivers/ssb/pci.c                                  |   12 
 include/linux/ssb/ssb_regs.h                       |   12 
 14 files changed, 693 insertions(+), 399 deletions(-)

-- 
Greetings Michael.


From andrew.james.barr at gmail.com  Sat Jun 16 21:13:34 2007
From: andrew.james.barr at gmail.com (Andrew J. Barr)
Date: Sat, 16 Jun 2007 15:13:34 -0400
Subject: Please pull latest and greatest bcm43xx
In-Reply-To: <200706162017.47516.mb@bu3sch.de>
References: <200706162017.47516.mb@bu3sch.de>
Message-ID: <20070616151334.03fcee13@powerbook.oakcourt.dyndns.org>

On Sat, 16 Jun 2007 20:17:47 +0200
Michael Buesch <mb at bu3sch.de> wrote:

> John,
> 
> Please pull for-linville branch of my tree.
> It contains a lot of bugfixes and makes a _big_ step towards
> mergability for mainline.
> It's not 100% ready for a merge, yet, but we are making good progress.
> The transmission power problems on the 4306, that were one of the big
> merge blockers, seem almost all fixed. I get good performance now.
> I also added lots of txpower debugging stuff so one can actually
> see what's going on and how it's scaling.
> Together with Michael Wu's sta-locking rewrite patch for
> mac80211 we have the most critical merge blockers resolved now.
 
> I'd like people to test this code.
> It will spew a big assertion failure and a stacktrace on loading.
> Ignore that for now. It's known and considered nonfatal for now.

Hi,

I'd like to try this, but it does seem that for a number of things, the
2.6.18-4-powerpc kernel that ships with Etch is very stable and
bug-free on my Powerbook G4 17". Is there any hope of backporting just
the mac80211 and bcm43xx stuff to that kernel? The appletouch driver
and (oddly enough) some aspects of bcm43xx (e.g. connecting at long
distances) seem to work better on the Etch official kernel than on
upstream kernel.org sources or branches of that.

Regards,
Andrew Barr


From johannes at sipsolutions.net  Sun Jun 17 00:17:37 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 17 Jun 2007 00:17:37 +0200
Subject: [RFC PATCH] bcm43xx QoS support
In-Reply-To: <1ba2fa240706161438lfd629e4j7317bb62340c82a3@mail.gmail.com>
References: <200706161328.53726.mb@bu3sch.de>
	<1ba2fa240706161438lfd629e4j7317bb62340c82a3@mail.gmail.com>
Message-ID: <1182032257.23681.1.camel@johannes.berg>

On Sun, 2007-06-17 at 00:38 +0300, Tomas Winkler wrote:
> iwlwifi supports QoS. It has queues 4 hw for WMM access categories 2
> hw queus for HCCA.

But it too can't ever create QoS-data frames or negotiate TXOPs afaict,
unless it does more than we want in hardware.

> There is also a discussion about supporting hardware queues in qdisc
> in netdev.

Which isn't really a concern to the driver since only mac80211 will need
to be changed for that.

I suppose the question is: what are we missing in mac80211 now? It seems
that we have no way of sending out QoS-data frames and that seems weird.
Nor do we parse TXOP information etc. Possibly this is because we
support WME and that's based on an early 802.11e draft?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070617/2da3ca4e/attachment.pgp>

From johannes at sipsolutions.net  Sun Jun 17 11:10:44 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 17 Jun 2007 11:10:44 +0200
Subject: [RFC PATCH] bcm43xx QoS support
In-Reply-To: <1ba2fa240706161630r1fdb2ac1m87039a088c7d6bfd@mail.gmail.com>
References: <200706161328.53726.mb@bu3sch.de>
	<1ba2fa240706161438lfd629e4j7317bb62340c82a3@mail.gmail.com>
	<1182032257.23681.1.camel@johannes.berg>
	<1ba2fa240706161630r1fdb2ac1m87039a088c7d6bfd@mail.gmail.com>
Message-ID: <1182071444.23681.14.camel@johannes.berg>

On Sun, 2007-06-17 at 02:30 +0300, Tomas Winkler wrote:

> > > There is also a discussion about supporting hardware queues in qdisc
> > > in netdev.
> >
> > Which isn't really a concern to the driver since only mac80211 will need
> > to be changed for that.
> >
> I'm not sure it's only mac80211 problem as driver is responsible for
> stopping and waking up the queues. Only driver knows whether hw queue
> is full or not.

Of course, but we already have that API in mac80211, hence well-written
drivers already tell mac80211 about it so all we'd need to do is change
mac80211 to tell the net layer :)

> > I suppose the question is: what are we missing in mac80211 now? It seems
> > that we have no way of sending out QoS-data frames and that seems weird.
> 
> QoS frame are send just fine by mac80211 (at least under iwlwifi),
> only the sequence numbers has to be overwritten in driver since the
> current handler doesn't advance them per TID.

Oh, you're right, I missed that wme_qdiscop_enqueue does that.

> > Nor do we parse TXOP information etc. Possibly this is because we
> > support WME and that's based on an early 802.11e draft?
> 
> I addition wme.c qdisc scheduler is rather naive one, it only
> statically assign priorities, it wouldn't pass WMM certification I
> guess.

I have no idea what WMM certification contains. All I've been trying to
say is that this area really needs some work to be useful.

For the problem at hand, namely some QoS support in bcm43xx, we'll just
have to hardcode some QoS parameters for now, I'd think, but I don't
know what those would be.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070617/b15fb508/attachment.pgp>

From zajec5polish at gmail.com  Sun Jun 17 14:06:19 2007
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Sun, 17 Jun 2007 14:06:19 +0200
Subject: [4318] Problem with connecting
Message-ID: <14b026160706170506o52a8a475gfc14d04bd5372a7c@mail.gmail.com>

After a few hours of using notebook+bcm43xx I was disconnected and was
not able to connect again. Even reloading bcm43xx module didn't help.
I had to reboot my notebook. It was quite weird because I usually
don't have any problems connecting to this network.

Before rebooting I made some logs of /var/log/messages and
/var/log/NetworkManager. It contains logs of two operations:

1) As root: rmmod bcm43xx && modprobe bcm43xx
2) As user using KNetoworkManager I clicked on "zajec_linksys" which
is my network

After that I was not connected and what's more I was not able to use
"iwlist scan" anymore:


# iwlist wlan0 scan
Warning: Driver for device wlan0 has been compiled with version 22
of Wireless Extension, while this program supports up to version 21.
Some things may be broken...

wlan0     Interface doesn't support scanning : No such device


-- 
Rafa? Mi?ecki
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: messages.txt
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070617/232feaf1/attachment.txt>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: NetworkManager.txt
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070617/232feaf1/attachment-0001.txt>

From geekypenguin at gmail.com  Sun Jun 17 17:48:52 2007
From: geekypenguin at gmail.com (Jory A. Pratt)
Date: Sun, 17 Jun 2007 10:48:52 -0500
Subject: Please pull latest and greatest bcm43xx
In-Reply-To: <200706162017.47516.mb@bu3sch.de>
References: <200706162017.47516.mb@bu3sch.de>
Message-ID: <467557E4.7050509@gmail.com>

Michael Buesch wrote:
> John,
>
> Please pull for-linville branch of my tree.
> It contains a lot of bugfixes and makes a _big_ step towards
> mergability for mainline.
> It's not 100% ready for a merge, yet, but we are making good progress.
> The transmission power problems on the 4306, that were one of the big
> merge blockers, seem almost all fixed. I get good performance now.
> I also added lots of txpower debugging stuff so one can actually
> see what's going on and how it's scaling.
> Together with Michael Wu's sta-locking rewrite patch for
> mac80211 we have the most critical merge blockers resolved now.
>
> I'd like people to test this code.
> It will spew a big assertion failure and a stacktrace on loading.
> Ignore that for now. It's known and considered nonfatal for now.
>
>
>
> The following changes since commit 9181e959da76d85d688d8ec763702ed2f3b4edf9:
>   John W. Linville:
>         rt2x00firmware.c: include delay.h to avoid build error on ppc64
>
> are found in the git repository at:
>
>   http://bu3sch.de/git/wireless-dev.git/ for-linville
>
> Michael Buesch:
>       bcm43xx-mac80211: Don't stop the mac80211 software queues in pwork.
>       Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
>       bcm43xx-mac80211: Use the mac80211 provided workqueue
>       bcm43xx-mac80211: Fix mutex leakage in pwork.
>       bcm43xx-mac80211: Flush the workqueue to make sure periodic work has finished.
>       bcm43xx-mac80211: Implement runtime debugging mechanism.
>       bcm43xx-mac80211: Code to inject TX ring overflows.
>       bcm43xx-mac80211: Rewrite the attenuation adjustment.
>       Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
>       ssb: Fix maxpwr and itssi read.
>       bcm43xx-mac80211: Add more txpower debugging.
>       bcm43xx-mac80211: add debugfs file to manually control txpower
>       bcm43xx-mac80211: Some LO cleanups
>       Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
>       bcm43xx-mac80211: Use the dynamic min/max values for adjusting the attenuation.
>
>  drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h    |   29 +
>  .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.c    |  210 +++++++++
>  .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.h    |   21 +
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.c    |   63 +++
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.h    |   10 
>  drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.c |  107 ++--
>  drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.h |    6 
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_main.c   |   64 +--
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.c    |  515 ++++++++++++-----------
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.h    |   23 +
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c   |   18 +
>  .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h   |    2 
>  drivers/ssb/pci.c                                  |   12 
>  include/linux/ssb/ssb_regs.h                       |   12 
>  14 files changed, 693 insertions(+), 399 deletions(-)
>
>   
I am pleased with the performance on my pcmcia 4306 by all means now :) 
great work in that department. I test my bcm4318 as well it worked, but 
very unusable bit rate fluxuates so bad that you can not do anything 
consistent. Just want to make sure you know the code has been tested on 
both cards and were it stands ... Once again great work Michael.


From badmuthahubbard at gmail.com  Mon Jun 18 20:22:38 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Mon, 18 Jun 2007 14:22:38 -0400
Subject: [bcm-users]
Message-ID: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>

Hi.
I have a 4311 on a Gateway MX6447.  I am running 64studio, an offshoot of
Debian.  I downloaded kernel 2.6.21 and patched it to 2.6.22-rc4 (for my
soundcard), copied the configuration, and made sure all the bcm43xx options
were selected.  I compiled the kernel, installed bcm43xx-fwcutter, and ran
it on wl_apsta.o from http://boredklink.googlepages.com/wl_apsta.o

I entered my wep code and was online for a while.  I had added Debian
unstable to my repositories, and did an update/upgrade, and immediately
after it finished the wireless went down.  However, I doublechecked that
bcm43xx and /lib/firmware weren't involved in any of the upgraded packages,
and the kernel is still my custom kernel.  The network dialog still shows
eth1 active, still shows the list of APs, and still has the passcode;
"iwlist eth1 scan" still shows a list of APs, including mine.  The access
point was showing as invalid, but after I turned the radio LED off and on,
it showed as an address.  I've rebooted the system a few times, rechecked
everything.  Still no errors, still shows as connected, but nothing
received.  I did try "modprobe bcm43xx" just in case, no difference.

I did try re-cutting the firmware, and now "bcm43xx-fwcutter /lib/firmware
./wl_apsta.o" says that wl_apsta.o has an invalid checksum; however, when I
checked the sum under Windows, it told me a different number than what
fwcutter said.

Can anyone help me?
-Chuckk

-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070618/f3a3e029/attachment.html>

From gavron at wetwork.net  Mon Jun 18 20:26:50 2007
From: gavron at wetwork.net (Ehud Gavron)
Date: Mon, 18 Jun 2007 11:26:50 -0700
Subject: [bcm-users]
In-Reply-To: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
References: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
Message-ID: <4676CE6A.700@wetwork.net>

Is it possible your update killed fwcutter?  I would try this
1. download a known good fwcutter
2. download a known good firmware
3. modprobe -r bcm43xx
4. modprobe -r bcm43xx_mac80211
5. modproble bcm43xx
6. dmesg and make sure it loaded the firmware, saw the cores, activated, 
etc.
7. resume normal life.

If  that doesn't work, I would also go back to the 2.6.22-rc4 tree and 
do  make modules_install

Ehud

Chuckk Hubbard wrote:
> Hi.
> I have a 4311 on a Gateway MX6447.  I am running 64studio, an offshoot 
> of Debian.  I downloaded kernel 2.6.21 and patched it to 2.6.22-rc4 
> (for my soundcard), copied the configuration, and made sure all the 
> bcm43xx options were selected.  I compiled the kernel, installed 
> bcm43xx-fwcutter, and ran it on wl_apsta.o from 
> http://boredklink.googlepages.com/wl_apsta.o
>
> I entered my wep code and was online for a while.  I had added Debian 
> unstable to my repositories, and did an update/upgrade, and 
> immediately after it finished the wireless went down.  However, I 
> doublechecked that bcm43xx and /lib/firmware weren't involved in any 
> of the upgraded packages, and the kernel is still my custom kernel.  
> The network dialog still shows eth1 active, still shows the list of 
> APs, and still has the passcode; "iwlist eth1 scan" still shows a list 
> of APs, including mine.  The access point was showing as invalid, but 
> after I turned the radio LED off and on, it showed as an address.  
> I've rebooted the system a few times, rechecked everything.  Still no 
> errors, still shows as connected, but nothing received.  I did try 
> "modprobe bcm43xx" just in case, no difference.
>
> I did try re-cutting the firmware, and now "bcm43xx-fwcutter 
> /lib/firmware ./wl_apsta.o" says that wl_apsta.o has an invalid 
> checksum; however, when I checked the sum under Windows, it told me a 
> different number than what fwcutter said.
>
> Can anyone help me?
> -Chuckk
>
> -- 
> http://www.badmuthahubbard.com
> ------------------------------------------------------------------------
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070618/31df13fe/attachment.bin>

From badmuthahubbard at gmail.com  Mon Jun 18 20:42:08 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Mon, 18 Jun 2007 14:42:08 -0400
Subject: [bcm-users]
In-Reply-To: <4676CE6A.700@wetwork.net>
References: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
	<4676CE6A.700@wetwork.net>
Message-ID: <8200bab70706181142y51382822ue2c3aee4b36620a5@mail.gmail.com>

Thanks Ehud, I will try this.  Just a note, though, the update was after I
had extracted the firmware with fwcutter (I could only do the update after
the wireless was working); would it still have an effect on it?

-Chuckk

On 6/18/07, Ehud Gavron <gavron at wetwork.net> wrote:
>
> Is it possible your update killed fwcutter?  I would try this
> 1. download a known good fwcutter
> 2. download a known good firmware
> 3. modprobe -r bcm43xx
> 4. modprobe -r bcm43xx_mac80211
> 5. modproble bcm43xx
> 6. dmesg and make sure it loaded the firmware, saw the cores, activated,
> etc.
> 7. resume normal life.
>
> If  that doesn't work, I would also go back to the 2.6.22-rc4 tree and
> do  make modules_install
>
> Ehud
>
> Chuckk Hubbard wrote:
> > Hi.
> > I have a 4311 on a Gateway MX6447.  I am running 64studio, an offshoot
> > of Debian.  I downloaded kernel 2.6.21 and patched it to 2.6.22-rc4
> > (for my soundcard), copied the configuration, and made sure all the
> > bcm43xx options were selected.  I compiled the kernel, installed
> > bcm43xx-fwcutter, and ran it on wl_apsta.o from
> > http://boredklink.googlepages.com/wl_apsta.o
> >
> > I entered my wep code and was online for a while.  I had added Debian
> > unstable to my repositories, and did an update/upgrade, and
> > immediately after it finished the wireless went down.  However, I
> > doublechecked that bcm43xx and /lib/firmware weren't involved in any
> > of the upgraded packages, and the kernel is still my custom kernel.
> > The network dialog still shows eth1 active, still shows the list of
> > APs, and still has the passcode; "iwlist eth1 scan" still shows a list
> > of APs, including mine.  The access point was showing as invalid, but
> > after I turned the radio LED off and on, it showed as an address.
> > I've rebooted the system a few times, rechecked everything.  Still no
> > errors, still shows as connected, but nothing received.  I did try
> > "modprobe bcm43xx" just in case, no difference.
> >
> > I did try re-cutting the firmware, and now "bcm43xx-fwcutter
> > /lib/firmware ./wl_apsta.o" says that wl_apsta.o has an invalid
> > checksum; however, when I checked the sum under Windows, it told me a
> > different number than what fwcutter said.
> >
> > Can anyone help me?
> > -Chuckk
> >
> > --
> > http://www.badmuthahubbard.com
> > ------------------------------------------------------------------------
> >
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
>
>


-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070618/1e41bbdd/attachment.html>

From comphappy at gmail.com  Mon Jun 18 21:26:32 2007
From: comphappy at gmail.com (Brennan Ashton)
Date: Mon, 18 Jun 2007 12:26:32 -0700
Subject: [bcm-users]
In-Reply-To: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
References: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
Message-ID: <b2d05de20706181226tc5da0b6xb862600fe76fcfaf@mail.gmail.com>

On 6/18/07, Chuckk Hubbard <badmuthahubbard at gmail.com > wrote:
>
> Hi.
> I have a 4311 on a Gateway MX6447.  I am running 64studio, an offshoot of
> Debian.  I downloaded kernel 2.6.21 and patched it to 2.6.22-rc4 (for my
> soundcard), copied the configuration, and made sure all the bcm43xx options
> were selected.  I compiled the kernel, installed bcm43xx-fwcutter, and ran
> it on wl_apsta.o from http://boredklink.googlepages.com/wl_apsta.o
>
> I did try re-cutting the firmware, and now "bcm43xx-fwcutter /lib/firmware
> ./wl_apsta.o" says that wl_apsta.o has an invalid checksum; however, when I
> checked the sum under Windows, it told me a different number than what
> fwcutter said.
>

I think that that is an old firmware, try the one here
http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
-- 
Brennan Ashton
Bellingham, Washington

"The box said, 'Requires Windows 98 or better'. So I installed Linux"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070618/5c4988c5/attachment.html>

From badmuthahubbard at gmail.com  Mon Jun 18 22:33:42 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Mon, 18 Jun 2007 16:33:42 -0400
Subject: [bcm-users]
In-Reply-To: <b2d05de20706181226tc5da0b6xb862600fe76fcfaf@mail.gmail.com>
References: <8200bab70706181122x31523ce7oc15d5a863aa2a886@mail.gmail.com>
	<b2d05de20706181226tc5da0b6xb862600fe76fcfaf@mail.gmail.com>
Message-ID: <8200bab70706181333v136aa89eu7927f5ec61665c3e@mail.gmail.com>

On 6/18/07, Brennan Ashton <comphappy at gmail.com> wrote:
>
>
> On 6/18/07, Chuckk Hubbard <badmuthahubbard at gmail.com > wrote:
> >
> > Hi.
> > I have a 4311 on a Gateway MX6447.  I am running 64studio, an offshoot
> > of Debian.  I downloaded kernel 2.6.21 and patched it to 2.6.22-rc4 (for
> > my soundcard), copied the configuration, and made sure all the bcm43xx
> > options were selected.  I compiled the kernel, installed bcm43xx-fwcutter,
> > and ran it on wl_apsta.o from
> > http://boredklink.googlepages.com/wl_apsta.o
> >
> > I did try re-cutting the firmware, and now "bcm43xx-fwcutter
> > /lib/firmware ./wl_apsta.o" says that wl_apsta.o has an invalid checksum;
> > however, when I checked the sum under Windows, it told me a different number
> > than what fwcutter said.
> >
>
> I think that that is an old firmware, try the one here
> http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o



Thanks Brennan.  Alas, no luck.  "dmesg" gives me:

ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation <
jketreno at linux.intel.com>
bcm43xx driver
ACPI: PCI Interrupt 0000:05:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:05:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
ADDRCONF(NETDEV_UP): eth1: link is not ready
bcm43xx: set security called, .active_key = 0, .level = 1, .enabled = 1,
.encrypt = 1
SoftMAC: Open Authentication completed with 00:0e:a6:71:de:05
ADDRCONF(NETDEV_CHANGE): eth1: link becomes ready
eth1: no IPv6 routers present


I believe the last bit was after I ran 'iwconfig'.  Linux still recognizes
the list of AP's, and still says that it is connected to one, and I still
get nothing.
Any ideas?

-Chuckk

-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070618/2a57370d/attachment.html>

From mb at bu3sch.de  Wed Jun 20 00:22:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 20 Jun 2007 00:22:01 +0200
Subject: [PATCH] mac80211-bcm43xx : Fix long delays
In-Reply-To: <200706041539.41043.marc.pignat@hevs.ch>
References: <200706041539.41043.marc.pignat@hevs.ch>
Message-ID: <200706200022.01818.mb@bu3sch.de>

On Monday 04 June 2007 15:39:40 Marc Pignat wrote:
> from: Marc Pignat <marc.pignat at hevs.ch>
> 
> Replace long udelay by mdelay (long udelay are not supported on all arch).
> 
> Signed-off-by: Marc Pignat <marc.pignat at hevs.ch>
> 
> ---
> 
> The file drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c doesn't compile for
>  ARM architecture (and possibly others).
> 
> Here is the patch for replacing long (>1000) udelay by corresponding mdelay.
> 
> Regards

I committed a better fix for this:
http://bu3sch.de/gitweb?p=wireless-dev.git;a=commitdiff;h=818425d293e07f2e7aa84428bf466d1cf9b803b1

-- 
Greetings Michael.


From nospam001-lists at jankoh.dyndns.org  Wed Jun 20 17:00:29 2007
From: nospam001-lists at jankoh.dyndns.org (Jan Kohnert)
Date: Wed, 20 Jun 2007 17:00:29 +0200
Subject: Firmware loading problem
Message-ID: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>

Hello Folks,

First of all, sorry to bother you with that users-question, but the forum is 
down for at least one week now...

I have a problem with my bcm4311 card.

As far as I read, it is now (2.6.21) fully compatible with the driver you 
write.

I'm using Gentoo x86_64 and have set up the card using your docs. I also 
downloaded the firmware and used fwcutter to put it into /lib/firmware 
and /lib64/firmware. These directories are correct, as I have a TV card, 
also, which loads its firmware from that directory.

But the bcm43xx module does not load any firmware and the card is not 
correctly set up.

jankoh at kohni-mobil ~ $ /usr/sbin/lspci -n | grep 43
03:00.0 0280: 14e4:4311 (rev 01)
jankoh at kohni-mobil ~ $ /usr/sbin/lspci | grep 03:00
03:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan mini-PCI 
(rev 01)
jankoh at kohni-mobil ~ $

I use the firmware in 80211g.zip (BCMWL564.SYS) which is for 64bit, but I also 
tried SP23107.exe (bcmwl5.sys) as source file. I hope this is correct.

What am I doing wrong? I will attach the trace of 'modprobe bcm43xx'.

Thanks in advance!

-- 
MfG Jan
-------------- next part --------------
execve("/sbin/modprobe", ["modprobe", "bcm43xx"], [/* 44 vars */]) = 0
brk(0)                                  = 0x508000
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec4f000
uname({sys="Linux", node="kohni-mobil", ...}) = 0
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=154579, ...}) = 0
mmap(NULL, 154579, PROT_READ, MAP_PRIVATE, 3, 0) = 0x2ab1aec50000
close(3)                                = 0
open("/lib/libz.so.1", O_RDONLY)        = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0 \35\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=89696, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec76000
mmap(NULL, 1135880, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x2ab1aed51000
mprotect(0x2ab1aed66000, 1048576, PROT_NONE) = 0
mmap(0x2ab1aee66000, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x15000) = 0x2ab1aee66000
close(3)                                = 0
open("/lib/libc.so.6", O_RDONLY)        = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0p\324\1\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=1314928, ...}) = 0
mmap(NULL, 2334920, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x2ab1aee67000
mprotect(0x2ab1aef99000, 1044480, PROT_NONE) = 0
mmap(0x2ab1af098000, 20480, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x131000) = 0x2ab1af098000
mmap(0x2ab1af09d000, 16584, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x2ab1af09d000
close(3)                                = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1af0a2000
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1af0a3000
arch_prctl(ARCH_SET_FS, 0x2ab1af0a2ae0) = 0
mprotect(0x2ab1af098000, 12288, PROT_READ) = 0
mprotect(0x2ab1aed4f000, 4096, PROT_READ) = 0
munmap(0x2ab1aec50000, 154579)          = 0
create_module(NULL, 0)                  = -1 ENOSYS (Function not implemented)
uname({sys="Linux", node="kohni-mobil", ...}) = 0
fstat(2, {st_mode=S_IFCHR|0600, st_rdev=makedev(4, 1), ...}) = 0
brk(0)                                  = 0x508000
brk(0x529000)                           = 0x529000
open("/etc/modprobe.conf", O_RDONLY|O_NONBLOCK|O_DIRECTORY) = -1 ENOTDIR (Not a directory)
open("/etc/modprobe.conf", O_RDONLY)    = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=5917, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec50000
read(3, "### This file is automatically g"..., 4096) = 4096
read(3, "unl0 ipip\nalias cipcb0 cipcb\nali"..., 4096) = 1821
read(3, "", 4096)                       = 0
close(3)                                = 0
munmap(0x2ab1aec50000, 4096)            = 0
open("/lib/modules/2.6.21-gentoo-r3/modules.dep", O_RDONLY) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=191416, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec50000
read(3, "/lib/modules/2.6.21-gentoo-r3/ke"..., 4096) = 4096
read(3, "l/net/ipv6/netfilter/ip6_tables."..., 4096) = 4096
read(3, "lter/xt_string.ko: /lib/modules/"..., 4096) = 4096
read(3, "/net/netfilter/xt_NFQUEUE.ko: /l"..., 4096) = 4096
read(3, "el/net/ipx/ipx.ko: /lib/modules/"..., 4096) = 4096
read(3, "dules/2.6.21-gentoo-r3/kernel/ne"..., 4096) = 4096
read(3, "l/net/netfilter/nf_conntrack.ko "..., 4096) = 4096
read(3, "ules/2.6.21-gentoo-r3/kernel/net"..., 4096) = 4096
read(3, "les/2.6.21-gentoo-r3/kernel/driv"..., 4096) = 4096
read(3, "drivers/media/dvb/frontends/cx24"..., 4096) = 4096
read(3, ".6.21-gentoo-r3/kernel/drivers/m"..., 4096) = 4096
read(3, "edia/dvb/frontends/bcm3510.ko /l"..., 4096) = 4096
read(3, "ia/dvb/frontends/lgdt330x.ko /li"..., 4096) = 4096
read(3, "3/kernel/drivers/media/dvb/front"..., 4096) = 4096
read(3, "kernel/drivers/media/dvb/dvb-cor"..., 4096) = 4096
read(3, "gentoo-r3/kernel/drivers/media/r"..., 4096) = 4096
read(3, "media/video/video-buf.ko /lib/mo"..., 4096) = 4096
read(3, "ib/modules/2.6.21-gentoo-r3/kern"..., 4096) = 4096
read(3, "ko /lib/modules/2.6.21-gentoo-r3"..., 4096) = 4096
read(3, "o/ovcamchip/ovcamchip.ko:\n/lib/m"..., 4096) = 4096
read(3, "nel/drivers/media/video/dabusb.k"..., 4096) = 4096
read(3, "b/modules/2.6.21-gentoo-r3/kerne"..., 4096) = 4096
read(3, "rs/net/irda/w83977af_ir.ko: /lib"..., 4096) = 4096
read(3, "entoo-r3/kernel/drivers/net/pcmc"..., 4096) = 4096
close(3)                                = 0
munmap(0x2ab1aec50000, 4096)            = 0
open("/lib/modules/2.6.21-gentoo-r3/kernel/net/ieee80211/ieee80211_crypt.ko", O_RDWR) = 3
fcntl(3, F_SETLKW, {type=F_WRLCK, whence=SEEK_SET, start=0, len=1}) = 0
open("/proc/modules", O_RDONLY)         = 4
fstat(4, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec50000
read(4, "xfs 475656 1 - Live 0xffffffff88"..., 1024) = 1024
read(4, "0 1 k8temp, Live 0xffffffff88056"..., 1024) = 335
read(4, "", 1024)                       = 0
close(4)                                = 0
munmap(0x2ab1aec50000, 4096)            = 0
fcntl(3, F_GETFL)                       = 0x8002 (flags O_RDWR|O_LARGEFILE)
fstat(3, {st_mode=S_IFREG|0644, st_size=11422, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec50000
lseek(3, 0, SEEK_CUR)                   = 0
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\1\0>\0\1\0\0\0\0\0\0\0"..., 16384) = 11422
read(3, "", 4096)                       = 0
read(3, "", 4096)                       = 0
read(3, "", 4096)                       = 0
init_module(0x50f670, 11422, "")        = 0
close(3)                                = 0
open("/lib/modules/2.6.21-gentoo-r3/kernel/net/ieee80211/ieee80211.ko", O_RDWR) = 3
fcntl(3, F_SETLKW, {type=F_WRLCK, whence=SEEK_SET, start=0, len=1}) = 0
open("/proc/modules", O_RDONLY)         = 4
fstat(4, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec51000
read(4, "ieee80211_crypt 7424 0 - Live 0x"..., 1024) = 1024
read(4, "k8temp 7360 0 - Live 0xffffffff8"..., 1024) = 384
read(4, "", 1024)                       = 0
close(4)                                = 0
munmap(0x2ab1aec51000, 4096)            = 0
fcntl(3, F_GETFL)                       = 0x8002 (flags O_RDWR|O_LARGEFILE)
fstat(3, {st_mode=S_IFREG|0644, st_size=64476, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec51000
lseek(3, 0, SEEK_CUR)                   = 0
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\1\0>\0\1\0\0\0\0\0\0\0"..., 16384) = 16384
read(3, "\17\225\300\"D$>\210D$?\17\204\257\1\0\0H\203|$x\0\17\204"..., 16384) = 16384
read(3, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 32768) = 31708
read(3, "", 4096)                       = 0
read(3, "", 4096)                       = 0
init_module(0x515e20, 64476, "")        = 0
close(3)                                = 0
open("/lib/modules/2.6.21-gentoo-r3/kernel/net/ieee80211/softmac/ieee80211softmac.ko", O_RDWR) = 3
fcntl(3, F_SETLKW, {type=F_WRLCK, whence=SEEK_SET, start=0, len=1}) = 0
open("/proc/modules", O_RDONLY)         = 4
fstat(4, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec52000
read(4, "ieee80211 45492 0 - Live 0xfffff"..., 1024) = 1024
read(4, "000 (P)\ni2c_nforce2 7424 0 - Liv"..., 1024) = 437
read(4, "", 1024)                       = 0
close(4)                                = 0
munmap(0x2ab1aec52000, 4096)            = 0
fcntl(3, F_GETFL)                       = 0x8002 (flags O_RDWR|O_LARGEFILE)
fstat(3, {st_mode=S_IFREG|0644, st_size=45569, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec52000
lseek(3, 0, SEEK_CUR)                   = 0
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\1\0>\0\1\0\0\0\0\0\0\0"..., 16384) = 16384
read(3, "e80211/softmac/ieee80211softmac_"..., 16384) = 16384
brk(0x555000)                           = 0x555000
brk(0x54d000)                           = 0x54d000
read(3, "\2\0\0\0v\0\0\0\374\377\377\377\377\377\377\377m.\0\0\0"..., 32768) = 12801
read(3, "", 16384)                      = 0
read(3, "", 16384)                      = 0
init_module(0x51c5d0, 45569, "")        = 0
brk(0x53d000)                           = 0x53d000
close(3)                                = 0
open("/lib/modules/2.6.21-gentoo-r3/kernel/drivers/net/wireless/bcm43xx/bcm43xx.ko", O_RDWR) = 3
fcntl(3, F_SETLKW, {type=F_WRLCK, whence=SEEK_SET, start=0, len=1}) = 0
open("/proc/modules", O_RDONLY)         = 4
fstat(4, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec53000
read(4, "ieee80211softmac 31168 0 - Live "..., 1024) = 1024
read(4, "0 - Live 0xffffffff887cd000\nnvid"..., 1024) = 504
read(4, "", 1024)                       = 0
close(4)                                = 0
munmap(0x2ab1aec53000, 4096)            = 0
fcntl(3, F_GETFL)                       = 0x8002 (flags O_RDWR|O_LARGEFILE)
fstat(3, {st_mode=S_IFREG|0644, st_size=287531, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec53000
lseek(3, 0, SEEK_CUR)                   = 0
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\1\0>\0\1\0\0\0\0\0\0\0"..., 16384) = 16384
read(3, "\0\272\24\4\0\0\276\1\0\0\0\350\0\0\0\0H\213\205\10\2\0"..., 16384) = 16384
read(3, "\3\0\0\350\0\0\0\0001\322\276&\0\0\0H\211\337\350\0\0\0"..., 32768) = 32768
mmap(NULL, 135168, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2ab1aec54000
read(3, "f\211D$\2\350\0\0\0\0\276C\0\0\0H\211\337f\211D$&\350\0"..., 65536) = 65536
mremap(0x2ab1aec54000, 135168, 266240, MREMAP_MAYMOVE) = 0x2ab1aec77000
read(3, "description=Broadcom BCM43xx wir"..., 131072) = 131072
mremap(0x2ab1aec77000, 266240, 528384, MREMAP_MAYMOVE) = 0x2ab1aec77000
read(3, "\\\2\0\0\1\0\7\0\20\4\0\0\0\0\0\0\24\0\0\0\0\0\0\0k\2\0"..., 262144) = 25387
read(3, "", 233472)                     = 0
read(3, "", 233472)                     = 0
init_module(0x2ab1aec77010, 287531, "") = 0
munmap(0x2ab1aec77000, 528384)          = 0
close(3)                                = 0
exit_group(0)                           = ?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070620/1359cdae/attachment.pgp>

From larry.finger at lwfinger.net  Wed Jun 20 18:09:37 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 20 Jun 2007 11:09:37 -0500
Subject: Firmware loading problem
In-Reply-To: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>
References: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>
Message-ID: <46795141.9070707@lwfinger.net>

Jan Kohnert wrote:
> Hello Folks,
> 
> First of all, sorry to bother you with that users-question, but the forum is 
> down for at least one week now...
> 
> I have a problem with my bcm4311 card.
> 
> As far as I read, it is now (2.6.21) fully compatible with the driver you 
> write.

Yes, that is true.

> I'm using Gentoo x86_64 and have set up the card using your docs. I also 
> downloaded the firmware and used fwcutter to put it into /lib/firmware 
> and /lib64/firmware. These directories are correct, as I have a TV card, 
> also, which loads its firmware from that directory.
> 
> But the bcm43xx module does not load any firmware and the card is not 
> correctly set up.

There is no difference between the firmware in a 32- or 64-bit driver. The difference only matters 
when the original Windows or OS X driver is being used, as with ndiswrapper. There are, however, two 
different versions of the firmware. V3 is used with the softmac version of bcm43xx, which is the 
version you are using, and V4 is used with the mac80211 version. Please check the output of 'dmesg | 
grep bcm43xx'. I think it will say that your firmware is too new. You need to get a copy of a V3 
driver and extract its firmware.

Larry


From nospam001-lists at jankoh.dyndns.org  Wed Jun 20 18:29:27 2007
From: nospam001-lists at jankoh.dyndns.org (Jan Kohnert)
Date: Wed, 20 Jun 2007 18:29:27 +0200
Subject: Firmware loading problem
In-Reply-To: <46795141.9070707@lwfinger.net>
References: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>
	<46795141.9070707@lwfinger.net>
Message-ID: <200706201829.35684.nospam001-lists@jankoh.dyndns.org>

Thanks for the quick response!

Larry Finger schrieb:
> Jan Kohnert wrote:
> > But the bcm43xx module does not load any firmware and the card is not
> > correctly set up.
>
> There is no difference between the firmware in a 32- or 64-bit driver. The
> difference only matters when the original Windows or OS X driver is being
> used, as with ndiswrapper. There are, however, two different versions of
> the firmware. V3 is used with the softmac version of bcm43xx, which is the
> version you are using, and V4 is used with the mac80211 version. Please
> check the output of 'dmesg | grep bcm43xx'. I think it will say that your
> firmware is too new. You need to get a copy of a V3 driver and extract its
> firmware.

Here is the output, but however, I cannot see, anything would be loaded...
kohni-mobil ~ # dmesg | grep bcm43xx
bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
kohni-mobil ~ #

Anyway, I will try to find V3, download, test and report.

> Larry

-- 
MfG Jan
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070620/3ab0d5cf/attachment.pgp>

From nospam001-lists at jankoh.dyndns.org  Wed Jun 20 19:00:33 2007
From: nospam001-lists at jankoh.dyndns.org (Jan Kohnert)
Date: Wed, 20 Jun 2007 19:00:33 +0200
Subject: Firmware loading problem
In-Reply-To: <200706201829.35684.nospam001-lists@jankoh.dyndns.org>
References: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>
	<46795141.9070707@lwfinger.net>
	<200706201829.35684.nospam001-lists@jankoh.dyndns.org>
Message-ID: <200706201900.39366.nospam001-lists@jankoh.dyndns.org>

Jan Kohnert schrieb:
> Anyway, I will try to find V3, download, test and report.

I just downloaded
http://boredklink.googlepages.com/wl_apsta.o
but the result is exactly the same.

-- 
MfG Jan
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070620/924015bc/attachment.pgp>

From larry.finger at lwfinger.net  Wed Jun 20 19:36:34 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 20 Jun 2007 12:36:34 -0500
Subject: Firmware loading problem
In-Reply-To: <200706201829.35684.nospam001-lists@jankoh.dyndns.org>
References: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>	<46795141.9070707@lwfinger.net>
	<200706201829.35684.nospam001-lists@jankoh.dyndns.org>
Message-ID: <467965A2.80609@lwfinger.net>

Jan Kohnert wrote:
> Thanks for the quick response!
>
> Here is the output, but however, I cannot see, anything would be loaded...
> kohni-mobil ~ # dmesg | grep bcm43xx
> bcm43xx driver
> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> kohni-mobil ~ #
> 
> Anyway, I will try to find V3, download, test and report.

The set of messages from my interface are as follows:

bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Analog: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized

You are missing the last 5 lines. Did you do an 'ifup eth1', or the equivalent? Those lines are 
generated after the interface is brought up. If it had tried to load V4 firmware, there would have 
been a different message.

One other thing to check - if you do an 'lsmod | grep firmware' command, do you see 
'firmware_class'? Perhaps your system is not autoloading the firmware, but I think that also 
generates an error.

Larry





From nospam001-lists at jankoh.dyndns.org  Wed Jun 20 19:49:13 2007
From: nospam001-lists at jankoh.dyndns.org (Jan Kohnert)
Date: Wed, 20 Jun 2007 19:49:13 +0200
Subject: Firmware loading problem [SOLVED]
In-Reply-To: <467965A2.80609@lwfinger.net>
References: <200706201700.33886.nospam001-lists@jankoh.dyndns.org>
	<200706201829.35684.nospam001-lists@jankoh.dyndns.org>
	<467965A2.80609@lwfinger.net>
Message-ID: <200706201949.26923.nospam001-lists@jankoh.dyndns.org>

Larry Finger schrieb:
> You are missing the last 5 lines. Did you do an 'ifup eth1', or the
> equivalent? Those lines are generated after the interface is brought up.

Doh! I did not.

Now it reads:
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio hardware status changed to enabled

It works! After all I think, the main problem was, that I did not install the 
firmware to /lib64/firmware, when I tried first (at that time, I also tried 
to bring the interface up, which failed), and after that I never tried to 
bring the interface up again...

Sorry for the noise and much thanks for your patient help.

> Larry

-- 
MfG Jan
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070620/e702e88b/attachment.pgp>

From s0238762 at sms.ed.ac.uk  Wed Jun 20 21:40:35 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Wed, 20 Jun 2007 20:40:35 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
Message-ID: <467982B3.9020800@sms.ed.ac.uk>

hi,

does bcm43xx-mac80211 support WPA for the BCM4309 chipset ? It seems 
that the driver detects and initialised the card, but I can't connect to 
my router. I'm using NetworkManager and it does see my router, but 
doesn't connect to it. Not to mention that after a while the driver 
causes a system freeze. I'm using WPA PSK-TKIP

I've also tried with the bcm43xx (and a V3 firmware), but that doesn't 
seem to recognise the card at all. 'dmesg' reports only this:
ieee80211_crypt: unregistered algorithm 'NULL'
ieee80211_crypt: registered algorithm 'NULL'
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation 
<jketreno at linux.intel.com>
bcm43xx driver

and I don't get an interface associated to the card.

thanks

-Ioannis



From larry.finger at lwfinger.net  Wed Jun 20 22:01:06 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 20 Jun 2007 15:01:06 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467982B3.9020800@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk>
Message-ID: <46798782.4050307@lwfinger.net>

Ioannis Nousias wrote:
> hi,
> 
> does bcm43xx-mac80211 support WPA for the BCM4309 chipset ? It seems 
> that the driver detects and initialised the card, but I can't connect to 
> my router. I'm using NetworkManager and it does see my router, but 
> doesn't connect to it. Not to mention that after a while the driver 
> causes a system freeze. I'm using WPA PSK-TKIP

Yes, bcm43xx-mac80211 supports WPA. I don't know about the system freeze, but most problems in 
associating and authenticating with mac80211 are due to low signal strengths. The driver is 
improving, but still has problems.

> I've also tried with the bcm43xx (and a V3 firmware), but that doesn't 
> seem to recognise the card at all. 'dmesg' reports only this:
> ieee80211_crypt: unregistered algorithm 'NULL'
> ieee80211_crypt: registered algorithm 'NULL'
> ieee80211: 802.11 data/management/control stack, git-1.1.13
> ieee80211: Copyright (C) 2004-2005 Intel Corporation 
> <jketreno at linux.intel.com>

I do not think that you selected "IEEE802.11i TKIP encryption" under the "Generic IEEE802.11 stack" 
when you configured your system. The message here is "ieee80211_crypt: registered algorithm 'TKIP'". 
I am assuming that wpa_supplicant is available and started by NetworkManager. That is what happens 
on my system.

Larry


From s0238762 at sms.ed.ac.uk  Wed Jun 20 22:26:18 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Wed, 20 Jun 2007 21:26:18 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <46798782.4050307@lwfinger.net>
References: <467982B3.9020800@sms.ed.ac.uk> <46798782.4050307@lwfinger.net>
Message-ID: <46798D6A.8020102@sms.ed.ac.uk>


Larry Finger wrote:
> Ioannis Nousias wrote:
>> hi,
>>
>> does bcm43xx-mac80211 support WPA for the BCM4309 chipset ? It seems 
>> that the driver detects and initialised the card, but I can't connect 
>> to my router. I'm using NetworkManager and it does see my router, but 
>> doesn't connect to it. Not to mention that after a while the driver 
>> causes a system freeze. I'm using WPA PSK-TKIP
>
> Yes, bcm43xx-mac80211 supports WPA. I don't know about the system 
> freeze, but most problems in associating and authenticating with 
> mac80211 are due to low signal strengths. The driver is improving, but 
> still has problems.
ok I see. I do get transmission errors (PHY).
>
>> I've also tried with the bcm43xx (and a V3 firmware), but that 
>> doesn't seem to recognise the card at all. 'dmesg' reports only this:
>> ieee80211_crypt: unregistered algorithm 'NULL'
>> ieee80211_crypt: registered algorithm 'NULL'
>> ieee80211: 802.11 data/management/control stack, git-1.1.13
>> ieee80211: Copyright (C) 2004-2005 Intel Corporation 
>> <jketreno at linux.intel.com>
>
> I do not think that you selected "IEEE802.11i TKIP encryption" under 
> the "Generic IEEE802.11 stack" when you configured your system. The 
> message here is "ieee80211_crypt: registered algorithm 'TKIP'". I am 
> assuming that wpa_supplicant is available and started by 
> NetworkManager. That is what happens on my system.
>
> Larry
>
in the bcm43xx case, NetworkManager doesn't detect a wireless card at 
all. Its menu shows only 'Wired Network'. As I said, the card doesn't 
seem to be recognised.

I was thinking to compile the latest version, but if I'm not mistaken, 
this: 
'git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git' 
is the entire kernel source. Can I compile  somehow the bcm43xx or 
bcm43xx-mac80211 only for my current kernel ?

thanks





From larry.finger at lwfinger.net  Wed Jun 20 22:49:03 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 20 Jun 2007 15:49:03 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <46798D6A.8020102@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk> <46798782.4050307@lwfinger.net>
	<46798D6A.8020102@sms.ed.ac.uk>
Message-ID: <467992BF.70405@lwfinger.net>

Ioannis Nousias wrote:
> 
> in the bcm43xx case, NetworkManager doesn't detect a wireless card at 
> all. Its menu shows only 'Wired Network'. As I said, the card doesn't 
> seem to be recognised.

What is the result of the command 'dmesg | grep bcm43xx'?

> I was thinking to compile the latest version, but if I'm not mistaken, 
> this: 
> 'git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git' 
> is the entire kernel source. Can I compile  somehow the bcm43xx or 
> bcm43xx-mac80211 only for my current kernel ?

Yes, that is the complete source. What is your current kernel? Do you have kernel sources on your 
machine?

Larry


From s0238762 at sms.ed.ac.uk  Wed Jun 20 22:56:50 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Wed, 20 Jun 2007 21:56:50 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467992BF.70405@lwfinger.net>
References: <467982B3.9020800@sms.ed.ac.uk> <46798782.4050307@lwfinger.net>
	<46798D6A.8020102@sms.ed.ac.uk> <467992BF.70405@lwfinger.net>
Message-ID: <46799492.1060508@sms.ed.ac.uk>

Larry Finger wrote:
> Ioannis Nousias wrote:
>>
>> in the bcm43xx case, NetworkManager doesn't detect a wireless card at 
>> all. Its menu shows only 'Wired Network'. As I said, the card doesn't 
>> seem to be recognised.
>
> What is the result of the command 'dmesg | grep bcm43xx'?

bcm43xx driver

nothing else

>
>> I was thinking to compile the latest version, but if I'm not 
>> mistaken, this: 
>> 'git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git' 
>> is the entire kernel source. Can I compile  somehow the bcm43xx or 
>> bcm43xx-mac80211 only for my current kernel ?
>
> Yes, that is the complete source. What is your current kernel? Do you 
> have kernel sources on your machine?
>
> Larry
I'm using 2.6.21-1.3228.fc7 (that's Fedora 7) and I only heave the 
development package for my kernel, which is not a complete kernel 
source, but is enough to compile some kernel modules against it (I've 
tried with uvc-linux for instance)






From larry.finger at lwfinger.net  Thu Jun 21 04:45:23 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 20 Jun 2007 21:45:23 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <46799492.1060508@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
Message-ID: <4679E643.3060903@lwfinger.net>

Ioannis Nousias wrote:
> I'm using 2.6.21-1.3228.fc7 (that's Fedora 7) and I only heave the 
> development package for my kernel, which is not a complete kernel 
> source, but is enough to compile some kernel modules against it (I've 
> tried with uvc-linux for instance)

You can try the stand-alone version of bcm43xx, ieee80211 and softmac from 
ftp://lwfinger.dynalias.org/patches/bcm43xx-softmac-sa.tar.bz2. If that doesn't work, you will need 
to get the full sources for 2.6.21.5 from kernel.org.

Larry




From s0238762 at sms.ed.ac.uk  Thu Jun 21 19:44:32 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Thu, 21 Jun 2007 18:44:32 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <4679E643.3060903@lwfinger.net>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net>
Message-ID: <467AB900.6000506@sms.ed.ac.uk>

Larry Finger wrote:
> Ioannis Nousias wrote:
>> I'm using 2.6.21-1.3228.fc7 (that's Fedora 7) and I only heave the 
>> development package for my kernel, which is not a complete kernel 
>> source, but is enough to compile some kernel modules against it (I've 
>> tried with uvc-linux for instance)
>
> You can try the stand-alone version of bcm43xx, ieee80211 and softmac 
> from ftp://lwfinger.dynalias.org/patches/bcm43xx-softmac-sa.tar.bz2. 
> If that doesn't work, you will need to get the full sources for 
> 2.6.21.5 from kernel.org.
>
> Larry
>
>
>
yes, that's a lot better. Still unable to connect, but at least the card
is initialised.

this is what I get now in dmesg:

SoftMAC: Scanning finished: scanned 13 channels starting with channel 1
ieee80211_crypt: registered algorithm 'TKIP'
bcm43xx: set security called, .active_key = 0, .level = 2, .enabled = 1,
.encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1
eth1: no IPv6 routers present
SoftMAC: sent association request!
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0260 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 65/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: PHY disconnected
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 30-bit DMA initialized
bcm43xx: TODO: Incomplete code in keymac_write() at
/home/s0238762/Desktop/bcm43xx-softmac-sa/bcm43xx/bcm43xx_m
ain.c:1144
...
bcm43xx: TODO: Incomplete code in keymac_write() at
/home/s0238762/Desktop/bcm43xx-softmac-sa/bcm43xx/bcm43xx_m
ain.c:1146
...
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
ADDRCONF(NETDEV_UP): eth1: link is not ready


I'm sitting 5meters apart from the router. The signal indication in
NetworkManager is nearly full strength.

at least we are getting there. Thanks


Ioannis



PS: This standalone one is from April. Are there any recent ones?
PS2: once loaded the module can not be removed. rmmod (or modprobe -r)
do nothing on it.





From larry.finger at lwfinger.net  Thu Jun 21 21:50:36 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 21 Jun 2007 14:50:36 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467AB900.6000506@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net> <467AB900.6000506@sms.ed.ac.uk>
Message-ID: <467AD68C.5020600@lwfinger.net>

Ioannis Nousias wrote:
> this is what I get now in dmesg:
> 
> SoftMAC: Scanning finished: scanned 13 channels starting with channel 1
> ieee80211_crypt: registered algorithm 'TKIP'
> bcm43xx: set security called, .active_key = 0, .level = 2, .enabled = 1,
> .encrypt = 1
> bcm43xx: set security called, .enabled = 1, .encrypt = 1
> eth1: no IPv6 routers present
> SoftMAC: sent association request!
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0260 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 65/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> bcm43xx: PHY disconnected
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio enabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 30-bit DMA initialized
> bcm43xx: TODO: Incomplete code in keymac_write() at
> /home/s0238762/Desktop/bcm43xx-softmac-sa/bcm43xx/bcm43xx_m
> ain.c:1144

These messages can be ignored.

> bcm43xx: TODO: Incomplete code in keymac_write() at
> /home/s0238762/Desktop/bcm43xx-softmac-sa/bcm43xx/bcm43xx_m
> ain.c:1146
> ...
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> ADDRCONF(NETDEV_UP): eth1: link is not ready
> 
> 
> I'm sitting 5meters apart from the router. The signal indication in
> NetworkManager is nearly full strength.
> 
> at least we are getting there. Thanks

The fact that you are seeing signal in NetworkManager means that scanning is working. Please send 
the output of the ifconfig and iwconfig commands once NM has tried to connect. What percentage does 
NM reach before it stops trying? Are you using any encryption?

> PS: This standalone one is from April. Are there any recent ones?

No - there have not been any changes since 2.6.21-rc1.

> PS2: once loaded the module can not be removed. rmmod (or modprobe -r)
> do nothing on it.

I have not seen this problem before. Are there any messages in the logs or on the console?

Larry

> 
> 
> 
> 



From mb at bu3sch.de  Fri Jun 22 00:44:48 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jun 2007 00:44:48 +0200
Subject: New debugging framework in bcm43xx-mac80211
Message-ID: <200706220044.48540.mb@bu3sch.de>

Hi Larry,

I just wanted to notify you that I am building
up a new dynamic debugging framework in bcm43xx-mac80211.
Debugging in the driver is a mess, because you don't
get enough useful information out of the driver.

My approach is to add boolean debugfs files to dynamically
enable verbose (and/or expensive) debugging techniques at
runtime, so one can easily track down problems without
modifying kernel code.

Currently my framework includes debugging features to debug
the DMA-ring-overflow, the TX power adjustment and some
periodic work debugging.
The periodic work and TXpower debugging is probably also
useful to you. The pwork debugging allows you do completely
stop pwork or to run it faster (every 50msec, instead of
every 1sec). This should help in tracking down races or
things like that. We had that in the past...

Here's the patch which adds the pwork debugging, so you
get a clue what I'm talking about. The main new function
is bcm43xx_debug(), which is used to check if a debugging
feature is enabled. Compiles to 0 for nondebug-builds.
http://bu3sch.de/gitweb?p=wireless-dev.git;a=commitdiff;h=402e3940d5e4d4f715ff434197c6b911e09317fc

If you have an idea for a place where we should add a
dynamic debugging feature, please tell me (and/or submit
a patch).
Adding a new dyndebug-feature is easy. Just add it to the enum
in bcm43xx_debug.h and use the add_dyn_dbg() macro in
bcm43xx_debug.c to create the file. (the file is removed
automagically). And of course check for the flag somewhere
in the code with bcm43xx_debug() ;) .

Have fun.

-- 
Greetings Michael.


From s0238762 at sms.ed.ac.uk  Fri Jun 22 01:40:26 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Fri, 22 Jun 2007 00:40:26 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467AD68C.5020600@lwfinger.net>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net> <467AB900.6000506@sms.ed.ac.uk>
	<467AD68C.5020600@lwfinger.net>
Message-ID: <467B0C6A.8070907@sms.ed.ac.uk>

Larry Finger wrote:
>
>> bcm43xx: TODO: Incomplete code in keymac_write() at
>> /home/s0238762/Desktop/bcm43xx-softmac-sa/bcm43xx/bcm43xx_m
>> ain.c:1146
>> ...
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>> ADDRCONF(NETDEV_UP): eth1: link is not ready
>>
>>
>> I'm sitting 5meters apart from the router. The signal indication in
>> NetworkManager is nearly full strength.
>>
>> at least we are getting there. Thanks
>
> The fact that you are seeing signal in NetworkManager means that 
> scanning is working. Please send the output of the ifconfig and 
> iwconfig commands once NM has tried to connect.
during the time NM tries to connect


ifconfig:
eth1      Link encap:Ethernet  HWaddr <my MAC here>
          inet6 addr: fe80::290:4bff:fe71:e8f5/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:8 errors:0 dropped:1 overruns:0 frame:0
          TX packets:559 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:676 (676.0 b)  TX bytes:28690 (28.0 KiB)
          Interrupt:11 Base address:0x8000



iwconfig:
eth1      IEEE 802.11b/g  ESSID:"<My ESSID here>"  Nickname:"Broadcom 4306"
          Mode:Managed  Frequency=2.432 GHz  Access Point: <my router's 
MAC here> 
          Bit Rate=24 Mb/s   Tx-Power=14 dBm  
          RTS thr:off   Fragment thr:off
          Link Quality=66/100  Signal level=-61 dBm  Noise level=-66 dBm
          Rx invalid nwid:0  Rx invalid crypt:1  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


> What percentage does NM reach before it stops trying? 
I'm not sure. Is there a log? nm-tool reports this:

NetworkManager Tool

State: connecting

- Device: eth1 
----------------------------------------------------------------
  NM Path:           /org/freedesktop/NetworkManager/Devices/eth1
  Type:              802.11 Wireless
  Driver:            bcm43xx
  Active:            yes
  HW Address:        <my MAC>

  Capabilities:
    Supported:       yes
    Speed:           24 Mb/s

  Wireless Settings
    Scanning:        yes
    WEP Encryption:  yes
    WPA Encryption:  yes
    WPA2 Encryption: yes

  Wireless Networks (* = Current Network)
    some neighbour's ESSID:        Infrastructure Mode, Freq 0.000 MHz, 
Rate 62 Mb/s, Strength 77%, Encrypted (WEP)
    *My ESSID:  Infrastructure Mode, Freq 0.000 MHz, Rate 62 Mb/s, 
Strength 89%, Encrypted (WPA)
    some other neighbour ESSID: Infrastructure Mode, Freq 0.000 MHz, 
Rate 62 Mb/s, Strength 74%

  IP Settings:
    IP Address:      0.0.0.0
    Subnet Mask:     0.0.0.0
    Broadcast:       0.0.0.0
    Gateway:         0.0.0.0
    Primary DNS:     0.0.0.0
    Secondary DNS:   0.0.0.0

> Are you using any encryption?
WPA-PSK with TKIP

>> PS2: once loaded the module can not be removed. rmmod (or modprobe -r)
>> do nothing on it.
>
> I have not seen this problem before. Are there any messages in the 
> logs or on the console?
>
$ sudo /sbin/modprobe -rv bcm43xx
rmmod /lib/modules/2.6.21-1.3228.fc7/extra/bcm43xx/bcm43xx.ko
rmmod 
/lib/modules/2.6.21-1.3228.fc7/extra/ieee80211/softmac/ieee80211softmac.ko
rmmod /lib/modules/2.6.21-1.3228.fc7/extra/ieee80211/ieee80211.ko

$ /sbin/lsmod | grep bcm43
bcm43xx               437384  0
ieee80211softmac       39168  1 bcm43xx
ieee80211              38344  2 bcm43xx,ieee80211softmac

But, I think it reloads itself. In fact I can see it in dmesg. Is it 
possible that NM causes it to reload the module ?


thanks for you help

-Ioannis



From larry.finger at lwfinger.net  Fri Jun 22 03:40:59 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 21 Jun 2007 20:40:59 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467B0C6A.8070907@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net> <467AB900.6000506@sms.ed.ac.uk>
	<467AD68C.5020600@lwfinger.net> <467B0C6A.8070907@sms.ed.ac.uk>
Message-ID: <467B28AB.1000609@lwfinger.net>

Ioannis Nousias wrote:
> iwconfig:
> eth1      IEEE 802.11b/g  ESSID:"<My ESSID here>"  Nickname:"Broadcom 4306"
>          Mode:Managed  Frequency=2.432 GHz  Access Point: <my router's 
> MAC here>          Bit Rate=24 Mb/s   Tx-Power=14 dBm           RTS 
> thr:off   Fragment thr:off

Your interface has not authenticated. If it had, there would be an encryption key here.

>          Link Quality=66/100  Signal level=-61 dBm  Noise level=-66 dBm

This is a low signal/noise. Attached is a patch that will cut the rate from 24M to 11M to see if 
that helps get you connected.

>          Rx invalid nwid:0  Rx invalid crypt:1  Rx invalid frag:0
>          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> 
> I'm not sure. Is there a log? nm-tool reports this:

In the panel kicker applet used with NM on KDE, I get a progression bar. I guess it isn't universal.

> 
> But, I think it reloads itself. In fact I can see it in dmesg. Is it 
> possible that NM causes it to reload the module ?

I don't think NM is doing it by itself. At least it doesn't do that on my system. When I unload the 
module, I have to manually reload it, and then reconnect.

Larry

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: rate
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070621/8dab331e/attachment.ksh>

From badmuthahubbard at gmail.com  Fri Jun 22 06:54:30 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Fri, 22 Jun 2007 00:54:30 -0400
Subject: [bcm43xx-users] 4311 still not receiving
Message-ID: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>

Hi.
I worked through some things with Ehud, but it was inconclusive.  I just
recompiled using the advice at
http://forums.gentoo.org/viewtopic-t-547687.html as far as kernel options,
and I did this with the 2.6.22-rc4 patched kernel, and uname -r indeed tells
me 2.6.22-rc4_etc.
eth1 will scan, picking up several APs, and the command "iwconfig eth1 essid
"frank" key blahblahbl", after doing it twice, does cause a valid access
point in the output of "ifconfig eth1".  The network GUI dialog shows the
available ap's, several of them, and shows eth1 as being active and the WEP
key is in and everything.  Yet the command 'dhclient eth1' still tells me
the network is down, and I still cannot access the internet.

Previously I had eth1 up and running, and as soon as I did some stuff with
Synaptic (GUI for apt-get), it went down and wouldn't come back.  Then I
tried sitting next to the box, plugging in to check Ehud's replies and
unplugging to test eth1, and after I installed a chess program - nothing
else - with Synaptic, then suddenly the ethernet wouldn't work either.
I since compiled the kernel with more of the options from the link above,
and still nothing.

Can anyone help me?

Thanks.
-Chuckk


-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070622/264f5976/attachment.html>

From larry.finger at lwfinger.net  Fri Jun 22 07:18:20 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 00:18:20 -0500
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
Message-ID: <467B5B9C.5010706@lwfinger.net>

Chuckk Hubbard wrote:
> Hi.
> I worked through some things with Ehud, but it was inconclusive.  I just 
> recompiled using the advice at 
> http://forums.gentoo.org/viewtopic-t-547687.html as far as kernel 
> options, and I did this with the 2.6.22-rc4 patched kernel, and uname -r 
> indeed tells me 2.6.22-rc4_etc.
> eth1 will scan, picking up several APs, and the command "iwconfig eth1 
> essid "frank" key blahblahbl", after doing it twice, does cause a valid 
> access point in the output of "ifconfig eth1".  The network GUI dialog 
> shows the available ap's, several of them, and shows eth1 as being 
> active and the WEP key is in and everything.  Yet the command 'dhclient 
> eth1' still tells me the network is down, and I still cannot access the 
> internet.
> 
> Previously I had eth1 up and running, and as soon as I did some stuff 
> with Synaptic (GUI for apt-get), it went down and wouldn't come back.  
> Then I tried sitting next to the box, plugging in to check Ehud's 
> replies and unplugging to test eth1, and after I installed a chess 
> program - nothing else - with Synaptic, then suddenly the ethernet 
> wouldn't work either.
> I since compiled the kernel with more of the options from the link 
> above, and still nothing.
> 
> Can anyone help me?

This is likely a problem with Gentoo. I use openSUSE with NetworkManager with a BCM4311 and WPA-PSK 
TKIP encryption, but I have also used it with WEP. When I boot, it connects automatically at least 
90% of the time. For the others, I only have to click on the NM applet to connect.

Are you sure the WEP key has been entered correctly? WEP has the unpleasant habit of not informing 
anyone that the key was wrong. You need to get the hex key that your AP is expecting (not a 
passphrase) and enter it.

Larry


From badmuthahubbard at gmail.com  Fri Jun 22 07:41:12 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Fri, 22 Jun 2007 01:41:12 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467B5B9C.5010706@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<467B5B9C.5010706@lwfinger.net>
Message-ID: <8200bab70706212241x7ed2062bga619c3de1f3cb6e@mail.gmail.com>

On 6/22/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
>
> This is likely a problem with Gentoo. I use openSUSE with NetworkManager
> with a BCM4311 and WPA-PSK
> TKIP encryption, but I have also used it with WEP. When I boot, it
> connects automatically at least
> 90% of the time. For the others, I only have to click on the NM applet to
> connect.
>
> Are you sure the WEP key has been entered correctly? WEP has the
> unpleasant habit of not informing
> anyone that the key was wrong. You need to get the hex key that your AP is
> expecting (not a
> passphrase) and enter it.
>
> Larry
>


Hi Larry.
I forgot to mention that I am using 64studio, an offshoot of Debian, I just
happened to see the kernel config options on that page.  You may be right
about the WEP key; I'll see what else I can try.  I tried it both with and
without dashes like ****-****-**.  I'm pretty sure the key I have is hex-
it's alphanumeric, 10 characters, and I used it under the Windows wireless
dialog.
But that would explain why it can scan, and why the RX count isn't zero, but
is very low.
I'll try a few ways of entering it, but do you have any ideas how it should
go in?  I also tried running "iwconfig eth1 essid "frank"" and "iwconfig
eth1 key hex-code" as separate commands...

Thanks for your help.
-Chuckk

-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070622/e7d45374/attachment.html>

From proski at gnu.org  Fri Jun 22 08:18:06 2007
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 22 Jun 2007 02:18:06 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
Message-ID: <1182493086.24958.61.camel@dv>

On Fri, 2007-06-22 at 00:54 -0400, Chuckk Hubbard wrote:

> I worked through some things with Ehud, but it was inconclusive.  I
> just recompiled using the advice at
> http://forums.gentoo.org/viewtopic-t-547687.html as far as kernel
> options, and I did this with the 2.6.22-rc4 patched kernel, and uname
> -r indeed tells me 2.6.22-rc4_etc.
> eth1 will scan, picking up several APs, and the command "iwconfig eth1
> essid "frank" key blahblahbl", after doing it twice, does cause a
> valid access point in the output of "ifconfig eth1".  The network GUI
> dialog shows the available ap's, several of them, and shows eth1 as
> being active and the WEP key is in and everything.  Yet the command
> 'dhclient eth1' still tells me the network is down, and I still cannot
> access the internet. 

I remember that I had to specify "open" when setting the WEP key to
force open system authentication.  Even though the algorithm was already
shown as "open", setting it would probably fix something in softmac.

-- 
Regards,
Pavel Roskin



From s0238762 at sms.ed.ac.uk  Fri Jun 22 09:50:06 2007
From: s0238762 at sms.ed.ac.uk (Ioannis Nousias)
Date: Fri, 22 Jun 2007 08:50:06 +0100
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467B28AB.1000609@lwfinger.net>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net> <467AB900.6000506@sms.ed.ac.uk>
	<467AD68C.5020600@lwfinger.net> <467B0C6A.8070907@sms.ed.ac.uk>
	<467B28AB.1000609@lwfinger.net>
Message-ID: <467B7F2E.7080005@sms.ed.ac.uk>

Larry Finger wrote:
> Ioannis Nousias wrote:
>> iwconfig:
>> eth1      IEEE 802.11b/g  ESSID:"<My ESSID here>"  Nickname:"Broadcom 
>> 4306"
>>          Mode:Managed  Frequency=2.432 GHz  Access Point: <my 
>> router's MAC here>          Bit Rate=24 Mb/s   Tx-Power=14 
>> dBm           RTS thr:off   Fragment thr:off
>
> Your interface has not authenticated. If it had, there would be an 
> encryption key here.
>
>>          Link Quality=66/100  Signal level=-61 dBm  Noise level=-66 dBm
>
> This is a low signal/noise. Attached is a patch that will cut the rate 
> from 24M to 11M to see if that helps get you connected.
>
>>          Rx invalid nwid:0  Rx invalid crypt:1  Rx invalid frag:0
>>          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>>
>>
>> I'm not sure. Is there a log? nm-tool reports this:
>
> In the panel kicker applet used with NM on KDE, I get a progression 
> bar. I guess it isn't universal.
>
>>
>> But, I think it reloads itself. In fact I can see it in dmesg. Is it 
>> possible that NM causes it to reload the module ?
>
> I don't think NM is doing it by itself. At least it doesn't do that on 
> my system. When I unload the module, I have to manually reload it, and 
> then reconnect.
>
> Larry
>

Thanks, but no luck. I even tried with 1Mbps and still can't connect.

with 11Mbps:
 Link Quality=58/100  Signal level=-64 dBm  Noise level=-67 dBm

with 1Mbps:
 Link Quality=68/100  Signal level=-59 dBm  Noise level=-65 dBm


-Ioannis



PS: I can see wpa_supplicants being invoked by NM, so that part should 
be ok.

root      5202  0.0  0.1   4948  1388 ?        S    08:46   0:00 
/usr/sbin/wpa_supplicant -g /var/run/wpa_supplicant-global


From badmuthahubbard at gmail.com  Fri Jun 22 10:06:35 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Fri, 22 Jun 2007 04:06:35 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <1182493086.24958.61.camel@dv>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
Message-ID: <8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>

Thanks for the suggestion; I tried several times in a row, it didn't change
anything.

I went ahead and copied a bunch of commands, the dmesg output afterwards,
and the results of ifconfig and iwconfig... Did I miss something (also plz
tell me if I just published all someone needs to hack into my comp!):


#: ifconfig eth1 down
#: ifconfig eth1 up
#: iwconfig eth1 essid "frank"
#: iwconfig eth1 key open
#: iwconfig eth1 key 74b571f1c9


bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Canceling existing associate request!
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Scanning finished: scanned 13 channels starting with channel 1
SoftMAC: Queueing Authentication Request to 00:0e:a6:71:de:05
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:a6:71:de:05.
SoftMAC: Open Authentication completed with 00:0e:a6:71:de:05
SoftMAC: sent association request!
SoftMAC: associated!
eth1: no IPv6 routers present
bcm43xx: set security called, .level = 1, .enabled = 1, .encrypt = 1,
.auth_mode = 0
bcm43xx: set security called, .active_key = 0, .level = 1, .enabled = 1,
.encrypt = 1



64studio:/home/chuckk# ifconfig eth1
eth1      Link encap:Ethernet  HWaddr 00:14:A5:D0:1C:7A
          inet6 addr: fe80::214:a5ff:fed0:1c7a/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:33 errors:0 dropped:3762 overruns:0 frame:0
          TX packets:114 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:3916 (3.8 KiB)  TX bytes:7512 (7.3 KiB)
          Interrupt:11

64studio:/home/chuckk# iwconfig eth1
eth1      IEEE 802.11b/g  ESSID:"frank"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.462 GHz  Access Point:
00:0E:A6:71:DE:05
          Bit Rate=24 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:74B5-71F1-C9   Security mode:open
          Link Quality=85/100  Signal level=-49 dBm  Noise level=-69 dBm
          Rx invalid nwid:0  Rx invalid crypt:3764  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070622/4dccac29/attachment.html>

From mb at bu3sch.de  Fri Jun 22 12:13:21 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jun 2007 12:13:21 +0200
Subject: Please pull bcm43xx-mac80211
Message-ID: <200706221213.21855.mb@bu3sch.de>

It's growing..., better pull it :P
This log includes all the stuff from the last pull request, too.


The following changes since commit 9181e959da76d85d688d8ec763702ed2f3b4edf9:
  John W. Linville:
        rt2x00firmware.c: include delay.h to avoid build error on ppc64

are found in the git repository at:

  http://bu3sch.de/git/wireless-dev.git/ for-linville

Johannes Berg:
      bcm43xx: honour promisc bit even in monitor mode

Michael Buesch:
      bcm43xx-mac80211: Don't stop the mac80211 software queues in pwork.
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      bcm43xx-mac80211: Use the mac80211 provided workqueue
      bcm43xx-mac80211: Fix mutex leakage in pwork.
      bcm43xx-mac80211: Flush the workqueue to make sure periodic work has finished.
      bcm43xx-mac80211: Implement runtime debugging mechanism.
      bcm43xx-mac80211: Code to inject TX ring overflows.
      bcm43xx-mac80211: Rewrite the attenuation adjustment.
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      ssb: Fix maxpwr and itssi read.
      bcm43xx-mac80211: Add more txpower debugging.
      bcm43xx-mac80211: add debugfs file to manually control txpower
      bcm43xx-mac80211: Some LO cleanups
      Merge branch 'master' of git://git.kernel.org/.../linville/wireless-dev
      bcm43xx-mac80211: Use the dynamic min/max values for adjusting the attenuation.
      ssb: b44 sprom workaround; avoid warning message
      ssb: Rewrite invariants fetching code.
      ssb: Replace ceildiv() by DIV_ROUND_UP()
      bcm43xx-mac80211: Kill all huge udelay()s.
      bcm43xx-mac80211: Add cond_resched() into LO calibration.
      bcm43xx-mac80211: Fix rate memory init for A-PHY.
      bcm43xx-mac80211: Fix MAC address upload.
      bcm43xx-mac80211: Also write BSSID macfilter.
      bcm43xx-mac80211: Add pwork debugging.
      bcm43xx-mac80211: Run TX without taking the global spinlock.

 drivers/net/wireless/mac80211/bcm43xx/bcm43xx.h    |   39 +
 .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.c    |  216 ++++++++-
 .../wireless/mac80211/bcm43xx/bcm43xx_debugfs.h    |   23 +
 .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.c    |  189 ++++++--
 .../net/wireless/mac80211/bcm43xx/bcm43xx_dma.h    |   12 
 .../net/wireless/mac80211/bcm43xx/bcm43xx_leds.c   |    4 
 drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.c |  117 ++--
 drivers/net/wireless/mac80211/bcm43xx/bcm43xx_lo.h |    6 
 .../net/wireless/mac80211/bcm43xx/bcm43xx_main.c   |  202 ++++----
 .../net/wireless/mac80211/bcm43xx/bcm43xx_pcmcia.c |    7 
 .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.c    |  565 ++++++++++++-----------
 .../net/wireless/mac80211/bcm43xx/bcm43xx_phy.h    |   23 -
 .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.c   |   48 ++
 .../net/wireless/mac80211/bcm43xx/bcm43xx_xmit.h   |   17 +
 drivers/ssb/driver_chipcommon.c                    |   20 -
 drivers/ssb/main.c                                 |   49 +-
 drivers/ssb/pci.c                                  |   76 ++-
 drivers/ssb/pcmcia.c                               |    7 
 drivers/ssb/ssb_private.h                          |   22 -
 include/linux/ssb/ssb.h                            |   41 +
 include/linux/ssb/ssb_regs.h                       |   12 
 21 files changed, 1085 insertions(+), 610 deletions(-)

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Jun 22 16:26:37 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 09:26:37 -0500
Subject: BCM4309 with bcm43xx-mac80211 and WPA
In-Reply-To: <467B7F2E.7080005@sms.ed.ac.uk>
References: <467982B3.9020800@sms.ed.ac.uk>
	<46798782.4050307@lwfinger.net>	<46798D6A.8020102@sms.ed.ac.uk>
	<467992BF.70405@lwfinger.net> <46799492.1060508@sms.ed.ac.uk>
	<4679E643.3060903@lwfinger.net> <467AB900.6000506@sms.ed.ac.uk>
	<467AD68C.5020600@lwfinger.net> <467B0C6A.8070907@sms.ed.ac.uk>
	<467B28AB.1000609@lwfinger.net> <467B7F2E.7080005@sms.ed.ac.uk>
Message-ID: <467BDC1D.2040006@lwfinger.net>

Ioannis Nousias wrote:
> 
> 
> 
> PS: I can see wpa_supplicants being invoked by NM, so that part should 
> be ok.
> 
> root      5202  0.0  0.1   4948  1388 ?        S    08:46   0:00 
> /usr/sbin/wpa_supplicant -g /var/run/wpa_supplicant-global

The next step is to see what wpa_supplicant has to say. Prepare /etc/wpa_supplicant.conf with the 
following contents:

ctrl_interface=/var/run/wpa_supplicant
network={
   scan_ssid=1
   ssid="<your ssid>"
   key_mgmt=WPA-PSK
   psk="<your psk secret>"
}

As root, kill the existing wpa_supplicant process and issue the following command:

'wpa_supplicant -ieth1 -c/etc/wpa_supplicant.conf -ddd'

Please send me the output that results. There shouldn't be anything sensitive, but if you are 
worried, send it to me privately.

Larry



From larry.finger at lwfinger.net  Fri Jun 22 16:50:12 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 09:50:12 -0500
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
Message-ID: <467BE1A4.2080406@lwfinger.net>

Chuckk Hubbard wrote:
> 64studio:/home/chuckk# ifconfig eth1
> eth1      Link encap:Ethernet  HWaddr 00:14:A5:D0:1C:7A 
>           inet6 addr: fe80::214:a5ff:fed0:1c7a/64 Scope:Link
>           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
>           RX packets:33 errors:0 dropped:3762 overruns:0 frame:0
>           TX packets:114 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000
>           RX bytes:3916 (3.8 KiB)  TX bytes:7512 ( 7.3 KiB)
>           Interrupt:11
> 
> 64studio:/home/chuckk# iwconfig eth1
> eth1      IEEE 802.11b/g  ESSID:"frank"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.462 GHz  Access Point: 
> 00:0E:A6:71:DE:05  
>           Bit Rate=24 Mb/s   Tx-Power=18 dBm  
>           RTS thr:off   Fragment thr:off
>           Encryption key:74B5-71F1-C9   Security mode:open
>           Link Quality=85/100  Signal level=-49 dBm  Noise level=-69 dBm
>           Rx invalid nwid:0  Rx invalid crypt:3764  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0

If the encryption key shown above is the correct one, everything seems OK except for having a valid 
IPV4 address. Are you planning on using static or dynamic addresses? If dynamic, you need to issue a 
dhclient command. When I on't use NetworkManager, mine is automatic based on the information in 
/etc/sysconfig/network/ifcfg-eth1, but I think 'dhclient -d eth1' should be sufficient.

Once this is working, you should change your encryption key. It isn't quite all that is needed to 
hack your computer, but it is enough to listen to your wireless transmissions. I strongly recommend 
switching to WPA-PSK. If your PSK secret is longer than 20 characters and not found in a dictionary, 
it is essentially uncrackable. Your 64-bit WEP encryption can be cracked in as little as 1 minute.

Larry


From Larry.Finger at lwfinger.net  Fri Jun 22 19:09:41 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 12:09:41 -0500
Subject: Status for bcm43xx-mac80211 on BCM4311
Message-ID: <467C0255.4030409@lwfinger.net>

Michael,

I have now gotten some fairly reproducible iperf results with the latest version from your tree 
using my BCM4311. In general, the transmission rate is higher than the receive rate. In addition, it 
is much more consistent. While receiving, I might get a rate of 2 Mbs, but the next several are 
likely to be 50 Kbs, or less. The other thing I note is that I get no throughput for speeds that use 
OFDM.

Using my code for setting and fixing the rate, I get the following transmission rates:

Rate Set	Iperf Rate

1 Mbs		1.24 Mbs
2 		2.01
5.5 		4.13
11		6.58

My tx_power settings are as follows:

larrylap:~ # cat /sys/kernel/debug/bcm43xx_mac80211/phy0/tx_power_g
Control:               AUTOMATIC
Baseband attenuation:  0
Radio attenuation:     3
TX Mixer Gain:         OFF
PA Gain 2dB:           OFF
PA Gain 3dB:           OFF

I get the following with tx_power debugging turned on:

bcm43xx_mac80211: Current TX power output: 19.0 dBm, Desired TX power output: 18.50 dBm
bcm43xx_mac80211: Tuning TX-power to bbatt(0), rfatt(3), tx_control(0x00), tx_bias(0x00), tx_magn(0x00)

Are there any specific settings for tx_power_g that you would like me to try?

Larry


From proski at gnu.org  Fri Jun 22 21:39:04 2007
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 22 Jun 2007 15:39:04 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
Message-ID: <1182541144.17825.11.camel@dv>

On Fri, 2007-06-22 at 04:06 -0400, Chuckk Hubbard wrote:
> Thanks for the suggestion; I tried several times in a row, it didn't
> change anything.
> 
> I went ahead and copied a bunch of commands, the dmesg output
> afterwards, and the results of ifconfig and iwconfig... Did I miss
> something (also plz tell me if I just published all someone needs to
> hack into my comp!): 
> 
> 
> #: ifconfig eth1 down
> #: ifconfig eth1 up
> #: iwconfig eth1 essid "frank"
> #: iwconfig eth1 key open
> #: iwconfig eth1 key 74b571f1c9

My situation is that I don't use "iwconfig eth1 key open" initially.
The interface goes up and works enough time for dhclinet to get an
address.  Then it's stops working, although iwconfig still shows the
association.  And then "iwconfig eth1 key open" restores the connection
permanently.

It's one of those little irritating bugs in softmac.  Other little bugs
are incorrect display of ESSID when the interface is down and duplicate
packets when pinging another station connected to the same AP.

Oh, another one is that the code becomes confused when it re-associates.
It sends packets to the new AP through the old AP.  Maybe you have an
open AP around?  Then I suggest that you set ESSID before bringing the
interface up to avoid reassociation.  And please don't be surprised if
ESSID looks a bit too short before the interface is up.

Anyway. maybe you have something different.

It's quite frustrating to have two drivers for the hardware, one of
which is pretty bad with the 802.11 implementation, and the other cannot
setup the hardware (although I need to give bcm43xx_mac80211 another
try).  Both should be fixable.  I just need to get some other stuff off
my plate first.

-- 
Regards,
Pavel Roskin



From Larry.Finger at lwfinger.net  Fri Jun 22 21:43:43 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 14:43:43 -0500
Subject: [PATCH] bcm43xx-mac80211: Fix deviations from OFDM table specs
Message-ID: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>

This patch fixes some differences between the specs in
http://bcm-v4.sipsolutions.net/802.11/PHY/G/workarounds/WRSSI_offset and
the bcm43xx-mac80211 code.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
+++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
@@ -961,12 +961,8 @@ static void bcm43xx_phy_setupg(struct bc
 	if (phy->rev == 1) {
 		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
 			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
-		for (i = 0; i < 4; i++) {
-			bcm43xx_ofdmtab_write16(dev, 0x5404, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x5408, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x540C, i, 0x0020);
-			bcm43xx_ofdmtab_write16(dev, 0x5410, i, 0x0020);
-		}
+		for (i = 4; i < 20; i++)
+			bcm43xx_ofdmtab_write16(dev, 0x5400, i, 0x0020);
 		bcm43xx_phy_agcsetup(dev);
 
 		if ((bus->boardinfo.vendor == SSB_BOARDVENDOR_BCM) &&
@@ -977,7 +973,7 @@ static void bcm43xx_phy_setupg(struct bc
 		bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
 		bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
 	} else {
-		for (i = 0; i <= 0x2F; i++)
+		for (i = 0; i < 0x20; i++)
 			bcm43xx_ofdmtab_write16(dev, 0x1000, i, 0x0820);
 		bcm43xx_phy_agcsetup(dev);
 		bcm43xx_phy_read(dev, 0x0400); /* dummy read */


From larry.finger at lwfinger.net  Fri Jun 22 21:53:27 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 14:53:27 -0500
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <1182541144.17825.11.camel@dv>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>	<1182493086.24958.61.camel@dv>	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<1182541144.17825.11.camel@dv>
Message-ID: <467C28B7.5000100@lwfinger.net>

Pavel Roskin wrote:
> 
> It's quite frustrating to have two drivers for the hardware, one of
> which is pretty bad with the 802.11 implementation, and the other cannot
> setup the hardware (although I need to give bcm43xx_mac80211 another
> try).  Both should be fixable.  I just need to get some other stuff off
> my plate first.

It is also frustrating to have put as much effort into a project as we have and then get the kind of 
backbiting that you are exhibiting!!

The only two fixes that will have any future are (1) get bcm43xx-softmac switched over to mac80211 
(which I am working on) or (2) fix bcm43xx-mac80211. We are not spending any time on SoftMAC. It is 
gone as soon as either of the steps above are working well enough.

Don't give me that SH*T about how much you have on your plate. In the past, I have dropped 
everything to help you get bcm43xx working. Obviously, that was a bad decision on my part. I should 
have just let you use ndiswrapper!!!

Larry





From proski at gnu.org  Fri Jun 22 22:11:28 2007
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 22 Jun 2007 16:11:28 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467C28B7.5000100@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<1182541144.17825.11.camel@dv>  <467C28B7.5000100@lwfinger.net>
Message-ID: <1182543088.17825.29.camel@dv>

On Fri, 2007-06-22 at 14:53 -0500, Larry Finger wrote:
> Pavel Roskin wrote:
> > 
> > It's quite frustrating to have two drivers for the hardware, one of
> > which is pretty bad with the 802.11 implementation, and the other cannot
> > setup the hardware (although I need to give bcm43xx_mac80211 another
> > try).  Both should be fixable.  I just need to get some other stuff off
> > my plate first.
> 
> It is also frustrating to have put as much effort into a project as we have and then get the kind of 
> backbiting that you are exhibiting!!

Larry, it must be a misunderstanding.  I realize that softmac is not
your code.  You are doing a great job.  I only regret that I don't have
time to make patches for softmac, so that your driver can work better.

> The only two fixes that will have any future are (1) get bcm43xx-softmac switched over to mac80211 
> (which I am working on) or (2) fix bcm43xx-mac80211. We are not spending any time on SoftMAC. It is 
> gone as soon as either of the steps above are working well enough.

That's all great, and I don't want to discourage you from that.  I was
just trying to help somebody who is using the driver with softmac now.
Maybe it was just a coincidence that I started hitting various softmac
bugs as I saw that e-mail.

> Don't give me that SH*T about how much you have on your plate. In the past, I have dropped 
> everything to help you get bcm43xx working. Obviously, that was a bad decision on my part. I should 
> have just let you use ndiswrapper!!!

I only mean I regret that I cannot accompany my complains with patches
right now.  Although I think I should.

I do appreciate your help.  I absolutely didn't mean anything bad
towards you or the approach you are taking.

Perhaps I should keep my frustrations to myself.  Sorry if I offended
you.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Fri Jun 22 22:58:02 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jun 2007 22:58:02 +0200
Subject: Status for bcm43xx-mac80211 on BCM4311
In-Reply-To: <467C0255.4030409@lwfinger.net>
References: <467C0255.4030409@lwfinger.net>
Message-ID: <200706222258.02570.mb@bu3sch.de>

On Friday 22 June 2007 19:09:41 Larry Finger wrote:
> Michael,
> 
> I have now gotten some fairly reproducible iperf results with the latest version from your tree 
> using my BCM4311. In general, the transmission rate is higher than the receive rate. In addition, it 
> is much more consistent. While receiving, I might get a rate of 2 Mbs, but the next several are 
> likely to be 50 Kbs, or less. The other thing I note is that I get no throughput for speeds that use 
> OFDM.
> 
> Using my code for setting and fixing the rate, I get the following transmission rates:
> 
> Rate Set	Iperf Rate
> 
> 1 Mbs		1.24 Mbs
> 2 		2.01
> 5.5 		4.13
> 11		6.58
> 
> My tx_power settings are as follows:
> 
> larrylap:~ # cat /sys/kernel/debug/bcm43xx_mac80211/phy0/tx_power_g
> Control:               AUTOMATIC
> Baseband attenuation:  0
> Radio attenuation:     3
> TX Mixer Gain:         OFF
> PA Gain 2dB:           OFF
> PA Gain 3dB:           OFF
> 
> I get the following with tx_power debugging turned on:
> 
> bcm43xx_mac80211: Current TX power output: 19.0 dBm, Desired TX power output: 18.50 dBm
> bcm43xx_mac80211: Tuning TX-power to bbatt(0), rfatt(3), tx_control(0x00), tx_bias(0x00), tx_magn(0x00)
> 
> Are there any specific settings for tx_power_g that you would like me to try?

Nothing specific. Just play around with it a little bit.
Try setting maximum and minimum attenuation settings. Try to enable/disable
the various gains, etc...
Maximum is set by simply setting some big value such as 99. It will clamp
that into range then.
Also try the UDP mode of iperf. As with TCP mode TX might bias the RX results.

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jun 22 22:59:21 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 22 Jun 2007 22:59:21 +0200
Subject: [PATCH] bcm43xx-mac80211: Fix deviations from OFDM table specs
In-Reply-To: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>
References: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>
Message-ID: <200706222259.21622.mb@bu3sch.de>

On Friday 22 June 2007 21:43:43 Larry Finger wrote:
> This patch fixes some differences between the specs in
> http://bcm-v4.sipsolutions.net/802.11/PHY/G/workarounds/WRSSI_offset and
> the bcm43xx-mac80211 code.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> ===================================================================
> --- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> +++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> @@ -961,12 +961,8 @@ static void bcm43xx_phy_setupg(struct bc
>  	if (phy->rev == 1) {
>  		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
>  			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
> -		for (i = 0; i < 4; i++) {
> -			bcm43xx_ofdmtab_write16(dev, 0x5404, i, 0x0020);
> -			bcm43xx_ofdmtab_write16(dev, 0x5408, i, 0x0020);
> -			bcm43xx_ofdmtab_write16(dev, 0x540C, i, 0x0020);
> -			bcm43xx_ofdmtab_write16(dev, 0x5410, i, 0x0020);
> -		}
> +		for (i = 4; i < 20; i++)
> +			bcm43xx_ofdmtab_write16(dev, 0x5400, i, 0x0020);
>  		bcm43xx_phy_agcsetup(dev);
>  
>  		if ((bus->boardinfo.vendor == SSB_BOARDVENDOR_BCM) &&
> @@ -977,7 +973,7 @@ static void bcm43xx_phy_setupg(struct bc
>  		bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
>  		bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
>  	} else {
> -		for (i = 0; i <= 0x2F; i++)
> +		for (i = 0; i < 0x20; i++)
>  			bcm43xx_ofdmtab_write16(dev, 0x1000, i, 0x0820);
>  		bcm43xx_phy_agcsetup(dev);
>  		bcm43xx_phy_read(dev, 0x0400); /* dummy read */
> 
> 

Stefano's big patch is supposed to fix this. Though, it doesn't work, yet.
I'll give your patch a try and apply it, if it works fine. Did you test it?
On which devices?

-- 
Greetings Michael.


From badmuthahubbard at gmail.com  Sat Jun 23 00:07:23 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Fri, 22 Jun 2007 18:07:23 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467BE1A4.2080406@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<467BE1A4.2080406@lwfinger.net>
Message-ID: <8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>

On 6/22/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> Chuckk Hubbard wrote:
> > 64studio:/home/chuckk# ifconfig eth1
> > eth1      Link encap:Ethernet  HWaddr 00:14:A5:D0:1C:7A
> >           inet6 addr: fe80::214:a5ff:fed0:1c7a/64 Scope:Link
> >           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
> >           RX packets:33 errors:0 dropped:3762 overruns:0 frame:0
> >           TX packets:114 errors:0 dropped:0 overruns:0 carrier:0
> >           collisions:0 txqueuelen:1000
> >           RX bytes:3916 (3.8 KiB)  TX bytes:7512 ( 7.3 KiB)
> >           Interrupt:11
> >
> > 64studio:/home/chuckk# iwconfig eth1
> > eth1      IEEE 802.11b/g  ESSID:"frank"  Nickname:"Broadcom 4311"
> >           Mode:Managed  Frequency=2.462 GHz  Access Point:
> > 00:0E:A6:71:DE:05
> >           Bit Rate=24 Mb/s   Tx-Power=18 dBm
> >           RTS thr:off   Fragment thr:off
> >           Encryption key:74B5-71F1-C9   Security mode:open
> >           Link Quality=85/100  Signal level=-49 dBm  Noise level=-69 dBm
> >           Rx invalid nwid:0  Rx invalid crypt:3764  Rx invalid frag:0
> >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
> If the encryption key shown above is the correct one, everything seems OK
> except for having a valid
> IPV4 address. Are you planning on using static or dynamic addresses? If
> dynamic, you need to issue a
> dhclient command. When I on't use NetworkManager, mine is automatic based
> on the information in
> /etc/sysconfig/network/ifcfg-eth1, but I think 'dhclient -d eth1' should
> be sufficient.
>
> Once this is working, you should change your encryption key. It isn't
> quite all that is needed to
> hack your computer, but it is enough to listen to your wireless
> transmissions. I strongly recommend
> switching to WPA-PSK. If your PSK secret is longer than 20 characters and
> not found in a dictionary,
> it is essentially uncrackable. Your 64-bit WEP encryption can be cracked
> in as little as 1 minute.
>
> Larry
>

I'm planning on dhcp.  But 'dhclient -d eth1' gives:

Listening on LPF/eth1/00:14:a5:d0:1c:7a
Sending on   LPF/eth1/00:14:a5:d0:1c:7a
Sending on   Socket/fallback/fallback-net
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 7
receive_packet failed on eth1: Network is down
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 9
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 19
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 15
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 11
No DHCPOFFERS received.
No working leases in persistent database.

Sleeping.



and then hangs.  I noticed at one point that ifconfig was telling me "frank"
but the network dialog didn't update, it still showed another ap I tried.  I
don't understand how the two interact, but I do know that just using the
dialog doesn't seem to do it.

Damn those Broadcom people.  And damn me for not checking before I bought.

-Chuckk
-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070622/c75e9b70/attachment.html>

From larry.finger at lwfinger.net  Sat Jun 23 04:26:42 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 21:26:42 -0500
Subject: [PATCH] bcm43xx-mac80211: Fix deviations from OFDM table specs
In-Reply-To: <200706222259.21622.mb@bu3sch.de>
References: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>
	<200706222259.21622.mb@bu3sch.de>
Message-ID: <467C84E2.7040107@lwfinger.net>

Michael Buesch wrote:
> On Friday 22 June 2007 21:43:43 Larry Finger wrote:
>> This patch fixes some differences between the specs in
>> http://bcm-v4.sipsolutions.net/802.11/PHY/G/workarounds/WRSSI_offset and
>> the bcm43xx-mac80211 code.
>>
>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>> ---
>>
>> Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
>> ===================================================================
>> --- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
>> +++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
>> @@ -961,12 +961,8 @@ static void bcm43xx_phy_setupg(struct bc
>>  	if (phy->rev == 1) {
>>  		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
>>  			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
>> -		for (i = 0; i < 4; i++) {
>> -			bcm43xx_ofdmtab_write16(dev, 0x5404, i, 0x0020);
>> -			bcm43xx_ofdmtab_write16(dev, 0x5408, i, 0x0020);
>> -			bcm43xx_ofdmtab_write16(dev, 0x540C, i, 0x0020);
>> -			bcm43xx_ofdmtab_write16(dev, 0x5410, i, 0x0020);
>> -		}
>> +		for (i = 4; i < 20; i++)
>> +			bcm43xx_ofdmtab_write16(dev, 0x5400, i, 0x0020);
>>  		bcm43xx_phy_agcsetup(dev);
>>  
>>  		if ((bus->boardinfo.vendor == SSB_BOARDVENDOR_BCM) &&
>> @@ -977,7 +973,7 @@ static void bcm43xx_phy_setupg(struct bc
>>  		bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
>>  		bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
>>  	} else {
>> -		for (i = 0; i <= 0x2F; i++)
>> +		for (i = 0; i < 0x20; i++)
>>  			bcm43xx_ofdmtab_write16(dev, 0x1000, i, 0x0820);
>>  		bcm43xx_phy_agcsetup(dev);
>>  		bcm43xx_phy_read(dev, 0x0400); /* dummy read */
>>
>>
> 
> Stefano's big patch is supposed to fix this. Though, it doesn't work, yet.
> I'll give your patch a try and apply it, if it works fine. Did you test it?
> On which devices?

It has been tested on the BCM4311, where it didn't make much difference. I'll be testing it next on 
a phy->rev == 1 BCM4306.

Larry


From larry.finger at lwfinger.net  Sat Jun 23 04:47:48 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 22 Jun 2007 21:47:48 -0500
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>	
	<1182493086.24958.61.camel@dv>	
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>	
	<467BE1A4.2080406@lwfinger.net>
	<8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>
Message-ID: <467C89D4.60603@lwfinger.net>

Chuckk Hubbard wrote:
> On 6/22/07, *Larry Finger* <larry.finger at lwfinger.net 
> <mailto:larry.finger at lwfinger.net>> wrote:
> 
>     Chuckk Hubbard wrote:
>      > 64studio:/home/chuckk# ifconfig eth1
>      > eth1      Link encap:Ethernet  HWaddr 00:14:A5:D0:1C:7A
>      >           inet6 addr: fe80::214:a5ff:fed0:1c7a/64 Scope:Link
>      >           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
>      >           RX packets:33 errors:0 dropped:3762 overruns:0 frame:0
>      >           TX packets:114 errors:0 dropped:0 overruns:0 carrier:0
>      >           collisions:0 txqueuelen:1000
>      >           RX bytes:3916 ( 3.8 KiB)  TX bytes:7512 ( 7.3 KiB)
>      >           Interrupt:11
>      >
>      > 64studio:/home/chuckk# iwconfig eth1
>      > eth1      IEEE 802.11b/g  ESSID:"frank"  Nickname:"Broadcom 4311"
>      >           Mode:Managed  Frequency= 2.462 GHz  Access Point:
>      > 00:0E:A6:71:DE:05
>      >           Bit Rate=24 Mb/s   Tx-Power=18 dBm
>      >           RTS thr:off   Fragment thr:off
>      >           Encryption key:74B5-71F1-C9   Security mode:open
>      >           Link Quality=85/100  Signal level=-49 dBm  Noise
>     level=-69 dBm
>      >           Rx invalid nwid:0  Rx invalid crypt:3764  Rx invalid frag:0

I do not think you have the correct WEP key. Otherwise you wouldn't get all these invalid crypt 
packets. I missed that before.

>      >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> I'm planning on dhcp.  But 'dhclient -d eth1' gives:

It doesn't work if encryption is wrong. Can you turn encryption off as a temporary measure to get 
communications working, then turn it on after we know that we can communicate?


Larry


From badmuthahubbard at gmail.com  Sat Jun 23 17:12:29 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Sat, 23 Jun 2007 11:12:29 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467C89D4.60603@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<467BE1A4.2080406@lwfinger.net>
	<8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>
	<467C89D4.60603@lwfinger.net>
Message-ID: <8200bab70706230812o5646d0a1h262f6d221b9a5818@mail.gmail.com>

On 6/22/07, Larry Finger <larry.finger at lwfinger.net> wrote:


> I do not think you have the correct WEP key. Otherwise you wouldn't get
> all these invalid crypt
> packets. I missed that before.
>
> >      >           Tx excessive retries:0  Invalid misc:0   Missed
> beacon:0
> >
> > I'm planning on dhcp.  But 'dhclient -d eth1' gives:
>
> It doesn't work if encryption is wrong. Can you turn encryption off as a
> temporary measure to get
> communications working, then turn it on after we know that we can
> communicate?
>
>
> Larry
>


:-/  Darn.  It's the correct key in Windows, and in OSX using my wife's
comp.  Unfortunately, it's my landlord's router; I may be able to figure out
how to turn off/on encryption without resetting everything, but as of now I
have no idea.  I'll be out of town for the weekend, so I'll see if I can
figure it out when I return (or at a free wireless cafe).  What still throws
me is that it worked until I ran Synaptic, and the ethernet stopped working
when I ran Synaptic as well, even though all I did was install a chess
program.
At any rate, hopefully you won't hear from me again except to say thanks!
Thanks!
-Chuckk

-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070623/1a3b9c5b/attachment.html>

From badmuthahubbard at gmail.com  Sat Jun 23 17:18:11 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Sat, 23 Jun 2007 11:18:11 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467C89D4.60603@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<467BE1A4.2080406@lwfinger.net>
	<8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>
	<467C89D4.60603@lwfinger.net>
Message-ID: <8200bab70706230818m4fa5da0ax6186d9e40e970a00@mail.gmail.com>

Larry, I think I forgot to mention something... might the fact that it's a
64-bit machine and a 64-bit distro possibly make it not work?
-Chuckk

On 6/22/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> Chuckk Hubbard wrote:
> > On 6/22/07, *Larry Finger* <larry.finger at lwfinger.net
> > <mailto:larry.finger at lwfinger.net>> wrote:
> >
> >     Chuckk Hubbard wrote:
> >      > 64studio:/home/chuckk# ifconfig eth1
> >      > eth1      Link encap:Ethernet  HWaddr 00:14:A5:D0:1C:7A
> >      >           inet6 addr: fe80::214:a5ff:fed0:1c7a/64 Scope:Link
> >      >           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
> >      >           RX packets:33 errors:0 dropped:3762 overruns:0 frame:0
> >      >           TX packets:114 errors:0 dropped:0 overruns:0 carrier:0
> >      >           collisions:0 txqueuelen:1000
> >      >           RX bytes:3916 ( 3.8 KiB)  TX bytes:7512 ( 7.3 KiB)
> >      >           Interrupt:11
> >      >
> >      > 64studio:/home/chuckk# iwconfig eth1
> >      > eth1      IEEE 802.11b/g  ESSID:"frank"  Nickname:"Broadcom 4311"
> >      >           Mode:Managed  Frequency= 2.462 GHz  Access Point:
> >      > 00:0E:A6:71:DE:05
> >      >           Bit Rate=24 Mb/s   Tx-Power=18 dBm
> >      >           RTS thr:off   Fragment thr:off
> >      >           Encryption key:74B5-71F1-C9   Security mode:open
> >      >           Link Quality=85/100  Signal level=-49 dBm  Noise
> >     level=-69 dBm
> >      >           Rx invalid nwid:0  Rx invalid crypt:3764  Rx invalid
> frag:0
>
> I do not think you have the correct WEP key. Otherwise you wouldn't get
> all these invalid crypt
> packets. I missed that before.
>
> >      >           Tx excessive retries:0  Invalid misc:0   Missed
> beacon:0
> >
> > I'm planning on dhcp.  But 'dhclient -d eth1' gives:
>
> It doesn't work if encryption is wrong. Can you turn encryption off as a
> temporary measure to get
> communications working, then turn it on after we know that we can
> communicate?
>
>
> Larry
>



-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070623/667d68e3/attachment.html>

From larry.finger at lwfinger.net  Sat Jun 23 18:18:06 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 23 Jun 2007 11:18:06 -0500
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <8200bab70706230818m4fa5da0ax6186d9e40e970a00@mail.gmail.com>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>	
	<1182493086.24958.61.camel@dv>	
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>	
	<467BE1A4.2080406@lwfinger.net>	
	<8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>	
	<467C89D4.60603@lwfinger.net>
	<8200bab70706230818m4fa5da0ax6186d9e40e970a00@mail.gmail.com>
Message-ID: <467D47BE.6010209@lwfinger.net>

Chuckk Hubbard wrote:
> Larry, I think I forgot to mention something... might the fact that it's 
> a 64-bit machine and a 64-bit distro possibly make it not work?

No, it shouldn't matter. I use a 64-bit distro on an AMD 64 X2 cpu.

I just looked to see what Synaptic is. As it messed up your wired network as well as wireless, 
something must have gotten destroyed in the networking section. Does your distro have a "repair" 
option? If so, try it.

Larry


From zajec5polish at gmail.com  Sat Jun 23 19:08:45 2007
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Sat, 23 Jun 2007 19:08:45 +0200
Subject: [4318] Problem with connecting
In-Reply-To: <14b026160706170506o52a8a475gfc14d04bd5372a7c@mail.gmail.com>
References: <14b026160706170506o52a8a475gfc14d04bd5372a7c@mail.gmail.com>
Message-ID: <14b026160706231008v4611468fi2b4ab8b8345f1a1d@mail.gmail.com>

2007/6/17, Rafa? Mi?ecki <zajec5polish at gmail.com>:
> After that I was not connected and what's more I was not able to use
> "iwlist scan" anymore:

Any chance for fixing this? It doesn't happen often but it's annoying
to reboot machine in these cases anyway.

-- 
Rafa? Mi?ecki

From wltjr at gentoo.org  Sat Jun 23 21:26:51 2007
From: wltjr at gentoo.org (William L. Thomson Jr.)
Date: Sat, 23 Jun 2007 15:26:51 -0400
Subject: [4318] Problem with connecting
In-Reply-To: <14b026160706231008v4611468fi2b4ab8b8345f1a1d@mail.gmail.com>
References: <14b026160706170506o52a8a475gfc14d04bd5372a7c@mail.gmail.com>
	<14b026160706231008v4611468fi2b4ab8b8345f1a1d@mail.gmail.com>
Message-ID: <1182626811.6946.18.camel@wlt.obsidian-studios.com>

On Sat, 2007-06-23 at 19:08 +0200, Rafa? Mi?ecki wrote:
> 2007/6/17, Rafa? Mi?ecki <zajec5polish at gmail.com>:
> > After that I was not connected and what's more I was not able to use
> > "iwlist scan" anymore:
> 
> Any chance for fixing this? It doesn't happen often but it's annoying
> to reboot machine in these cases anyway.

I have problems like that with my 4319. Been meaning to debug and
provide output. Although I believe it's party or entirely due to my use
of softmac still. Which seems to be deprecated in favor of an
alternative these days.

Anytime my laptop is up an running. If I lose wireless for what ever
reason. I have to rmmod and modprobe usually a few times to get my card
to properly reset and come back up. Every now and then a reboot, and I
can always get it to come back on reboot. But who has time for a reboot
much less it not being the cool thing now days ;)

It makes connecting to a new wap, or say finding/using an open one a
complete PITA. One of my longest standing gripes. However considering a
year ago it knew nothing about my driver. And for the first few months i
had to modify stuff so it would see and active my card with mac and all.
So just been pleased for it to be working at all over the past year.

But running at 11mbps is getting old. Finally got that up to 22mbs, but
nothing beyond. Much less the driver issues with restarting that network
interface or etc and having to unload/load the driver repeatedly.

Will see if I can debug a bit this week and provide more useful info.
Other than confirmation from another of a similar or related problem :)

-- 
William L. Thomson Jr.
Gentoo/Java
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070623/16387558/attachment.pgp>

From mb at bu3sch.de  Sun Jun 24 20:41:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 24 Jun 2007 20:41:20 +0200
Subject: [PATCH] bcm43xx-mac80211: Fix deviations from OFDM table specs
In-Reply-To: <467C84E2.7040107@lwfinger.net>
References: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>
	<200706222259.21622.mb@bu3sch.de> <467C84E2.7040107@lwfinger.net>
Message-ID: <200706242041.20362.mb@bu3sch.de>

On Saturday 23 June 2007 04:26:42 Larry Finger wrote:
> Michael Buesch wrote:
> > On Friday 22 June 2007 21:43:43 Larry Finger wrote:
> >> This patch fixes some differences between the specs in
> >> http://bcm-v4.sipsolutions.net/802.11/PHY/G/workarounds/WRSSI_offset and
> >> the bcm43xx-mac80211 code.
> >>
> >> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> >> ---
> >>
> >> Index: wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> >> ===================================================================
> >> --- wireless-mb.orig/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> >> +++ wireless-mb/drivers/net/wireless/mac80211/bcm43xx/bcm43xx_phy.c
> >> @@ -961,12 +961,8 @@ static void bcm43xx_phy_setupg(struct bc
> >>  	if (phy->rev == 1) {
> >>  		for (i = 0; i < BCM43xx_TAB_RETARD_SIZE; i++)
> >>  			bcm43xx_ofdmtab_write32(dev, 0x2400, i, bcm43xx_tab_retard[i]);
> >> -		for (i = 0; i < 4; i++) {
> >> -			bcm43xx_ofdmtab_write16(dev, 0x5404, i, 0x0020);
> >> -			bcm43xx_ofdmtab_write16(dev, 0x5408, i, 0x0020);
> >> -			bcm43xx_ofdmtab_write16(dev, 0x540C, i, 0x0020);
> >> -			bcm43xx_ofdmtab_write16(dev, 0x5410, i, 0x0020);
> >> -		}
> >> +		for (i = 4; i < 20; i++)
> >> +			bcm43xx_ofdmtab_write16(dev, 0x5400, i, 0x0020);
> >>  		bcm43xx_phy_agcsetup(dev);
> >>  
> >>  		if ((bus->boardinfo.vendor == SSB_BOARDVENDOR_BCM) &&
> >> @@ -977,7 +973,7 @@ static void bcm43xx_phy_setupg(struct bc
> >>  		bcm43xx_ofdmtab_write16(dev, 0x5001, 0, 0x0002);
> >>  		bcm43xx_ofdmtab_write16(dev, 0x5002, 0, 0x0001);
> >>  	} else {
> >> -		for (i = 0; i <= 0x2F; i++)
> >> +		for (i = 0; i < 0x20; i++)
> >>  			bcm43xx_ofdmtab_write16(dev, 0x1000, i, 0x0820);
> >>  		bcm43xx_phy_agcsetup(dev);
> >>  		bcm43xx_phy_read(dev, 0x0400); /* dummy read */
> >>
> >>
> > 
> > Stefano's big patch is supposed to fix this. Though, it doesn't work, yet.
> > I'll give your patch a try and apply it, if it works fine. Did you test it?
> > On which devices?
> 
> It has been tested on the BCM4311, where it didn't make much difference. I'll be testing it next on 
> a phy->rev == 1 BCM4306.

I applied this, but please still test it on your rev1 4306.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Jun 24 21:00:12 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 24 Jun 2007 14:00:12 -0500
Subject: [PATCH] bcm43xx-mac80211: Fix deviations from OFDM table specs
In-Reply-To: <200706242041.20362.mb@bu3sch.de>
References: <467c266f.C1GUA7z3yDsbEeC8%Larry.Finger@lwfinger.net>
	<200706222259.21622.mb@bu3sch.de> <467C84E2.7040107@lwfinger.net>
	<200706242041.20362.mb@bu3sch.de>
Message-ID: <467EBF3C.4050309@lwfinger.net>

Michael Buesch wrote:
> 
> I applied this, but please still test it on your rev1 4306.
> 

I will try; however, nothing works here at OFDM rates.

Larry


From badmuthahubbard at gmail.com  Sun Jun 24 22:39:16 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Sun, 24 Jun 2007 16:39:16 -0400
Subject: [bcm43xx-users] 4311 still not receiving
In-Reply-To: <467C89D4.60603@lwfinger.net>
References: <8200bab70706212154j35430a5fyf9b822042d5c98e3@mail.gmail.com>
	<1182493086.24958.61.camel@dv>
	<8200bab70706220106w54fe05d3wa9224c57016628b3@mail.gmail.com>
	<467BE1A4.2080406@lwfinger.net>
	<8200bab70706221507m4a8c9aa1rfa6306e40ea03aa1@mail.gmail.com>
	<467C89D4.60603@lwfinger.net>
Message-ID: <8200bab70706241339n62d5214q49a80a3be7244cc6@mail.gmail.com>

On 6/22/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> I do not think you have the correct WEP key. Otherwise you wouldn't get
> all these invalid crypt
> packets. I missed that before.
>
> >      >           Tx excessive retries:0  Invalid misc:0   Missed
> beacon:0
> >
> > I'm planning on dhcp.  But 'dhclient -d eth1' gives:
>
> It doesn't work if encryption is wrong. Can you turn encryption off as a
> temporary measure to get
> communications working, then turn it on after we know that we can
> communicate?
>
>
> Larry
>

I just tried from a cafe with free unencrypted wireless, and cannot connect,
although again, it can scan.
I'm not sure if 64studio has a repair option; at any rate I can't get to an
ethernet cable until at least Tuesday, but I'll see what I can do then.
Thanks for your help with this.
-Chuckk

-- 
http://www.badmuthahubbard.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070624/1c50d846/attachment.html>

From gavron at Wetwork.Net  Wed Jun 27 03:58:59 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Tue, 26 Jun 2007 18:58:59 -0700
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
Message-ID: <4681C463.1080109@Wetwork.Net>

I've been alternately switching between 2.6.22-rc3 (Linville git tree) 
and 2.5.22-rc6 (Linville git tree as of today), henceforth rc3 and rc6 
respectively.

I've been alternately switching between bcm43xx and bcm43xx_mac80211, 
henceforth soft and hard respectively.

About the only thing I've found "strange" that I hope someone else can 
confirm, is that running a tcpdump simultaneously with the DHCP client 
causes more success than failure.

Oh yeah, here's another aside.  My DHCP server is actually an Adtran 
Netvanta 1224STR, so it is kind enough to supply debugging messages.

When running rc3 hard, here's what I see
dhclient -> reports it's asking for an address
tcpdump -> shows the bootpc request
router -> shows it received the request and sent back a reply
otherpc-running-tcpdump -> shows the reply coming back
tcpdump -> never shows the reply coming back!!!
tcpdump -> shows 802.1d and other frames coming from the router
dhclient -> times out

So clearly the router and the laptop ARE successfully exchanging 
traffic, but yet for some reason the laptop is not seeing the bootps 
reply on the initial request under rc3 hard.

If I had to do a matrix it would look like this:
rc6 hard - works but stuck at 1Mbps
rc6 soft - works
rc6 hard - unable to communicate, but associates fine
rc6 soft - works

More data follows.  I hope some of this rings a bell in someone's mind.  
If anyone wants me to do testing, I'm in that mood again, and I've got 
2.6.21 (F7), 2.6.22-rc3(linville) and 2.6.22-rc6(linville) all ready to go.

OH YEAH for full disclosure... my kernel is tainted by the Nvidia module...

Ehud



rc6 and hard works but not very well.  the rate is stuck at 1Mbps, and 
dhcp client only works if I simultaneously open a tcpdump session on 
that interface. 
eth1      IEEE 802.11g  ESSID:"wetwork" 
          Mode:Managed  Frequency:2.437 GHz  Access Point: 
00:0D:0B:11:5C:1B  
          Bit Rate=1 Mb/s  
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B  
          Encryption key:896A-0055-AE77-5E80-ED86-4E38-3A
          Link Quality=55/100  Signal level=-36 dBm  Noise level=-84 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

that's hard mac 1 meter away from the access point.

Note that the driver will not allow me to set the rate... says that's 
unsupported.

Here's what the kernel spit out:
bcm43xx_mac80211: Broadcom 4311 WLAN found
bcm43xx_mac80211: Found PHY: Analog 4, Type 2, Revision 8
bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
bcm43xx_mac80211: Radio turned off
bcm43xx driver
bcm43xx_mac80211: Adding Interface type 2
bcm43xx_mac80211: Loading firmware version 371.1061 (2006-10-04 21:02:04)
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: !WARNING! Idle-TSSI phy->cur_idle_tssi measuring 
failed. (cur=
30, tgt=62). Disabling TX power adjustment.
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac: 
ff:ff:ff:f
f:ff:ff
bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac: 
ff:ff:ff:f
f:ff:ff


rc3 hard does not work at all in the sense that both dhcp fails, and 
setting a hard address fails to successfully communicate.
eth1      IEEE 802.11g  ESSID:"wetwork" 
          Mode:Managed  Frequency:2.437 GHz  Access Point: 
00:0D:0B:11:5C:1B  
          Bit Rate=48 Mb/s  
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B  
          Encryption key:896A-0055-AE77-5E80-ED86-4E38-3A
          Link Quality=219/146  Signal level=-201 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


rc3 soft works tho:
eth1      IEEE 802.11b/g  ESSID:"wetwork"  Nickname:"egdell.wetwork.net"
          Mode:Managed  Frequency=2.437 GHz  Access Point: 
00:0D:0B:11:5C:1B  
          Bit Rate=24 Mb/s   Tx-Power=18 dBm  
          RTS thr:off   Fragment thr:off
          Encryption key:896A-0055-AE77-5E80-FD86-4E38-6B   Security 
mode:open
          Link Quality=86/100  Signal level=-48 dBm  Noise level=-70 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

NOTE: the softmac driver will allow me to change rates.


-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070626/c05e5dd4/attachment.bin>

From proski at gnu.org  Wed Jun 27 06:05:22 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 27 Jun 2007 00:05:22 -0400
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
In-Reply-To: <4681C463.1080109@Wetwork.Net>
References: <4681C463.1080109@Wetwork.Net>
Message-ID: <1182917122.6439.12.camel@dv>

Hello!

On Tue, 2007-06-26 at 18:58 -0700, Ehud Gavron wrote: 
> I've been alternately switching between 2.6.22-rc3 (Linville git tree) 
> and 2.5.22-rc6 (Linville git tree as of today), henceforth rc3 and rc6 
> respectively.

There have been significant changes in bcm43xx_mac80211 in its own git
repository (http://bu3sch.de/git/wireless-dev.git), which improved
things a lot.  As far as I know, the changes are not in 2.6.22-rc6 yet,
or you would have seen a backtrace.

> I've been alternately switching between bcm43xx and bcm43xx_mac80211, 
> henceforth soft and hard respectively.

There is nothing specifically "hard" in mac80211.  You may need to use
another convention.

> About the only thing I've found "strange" that I hope someone else can 
> confirm, is that running a tcpdump simultaneously with the DHCP client 
> causes more success than failure.

I understand you mean tcpdump on the same machine as the driver.  I
think I may have seen it.  Perhaps the promiscuous mode would speed up
recalibration, or something like that.  Anyway, the current git version
of bcm43xx_mac80211 is working much better and should not need such
tricks.

> If I had to do a matrix it would look like this:
> rc6 hard - works but stuck at 1Mbps
> rc6 soft - works
> rc6 hard - unable to communicate, but associates fine
> rc6 soft - works

You may want to use another convention for kernel versions as well.
They look too similar to me.

>           Encryption key:896A-0055-AE77-5E80-ED86-4E38-3A

I hope you understand you cannot reuse this key after having exposed it
in a public forum.  On the other hand, WEP is considered generally
unsafe these days, so it's more an polite request to leave your network
alone than actual security.

-- 
Regards,
Pavel Roskin



From gavron at Wetwork.Net  Wed Jun 27 06:12:08 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Tue, 26 Jun 2007 21:12:08 -0700
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
In-Reply-To: <1182917122.6439.12.camel@dv>
References: <4681C463.1080109@Wetwork.Net> <1182917122.6439.12.camel@dv>
Message-ID: <4681E398.7010508@Wetwork.Net>

Pavel, thank you for your note:)

Please let me know which kernel you recommend I try, and I will happily 
download and try it.

FYI while I have left the SSID unchanged (WHY do people munge that???) I 
did munge the keys, so you can safely ignore that.

ON the other hand should you ever be anywhere near my house in Tucson 
Arizona USA, please do let me know, and I'll happily provide you the 
real credentials for authenticating on the network.

*cheers*

Ehud
PS Ok, I thought bcm43xx vs bcm43xx_mac80211 was "soft" because it used 
softmac and bcm43xx_mac80211 used the old devicescape-stack which is 
alternately the "non-soft" (or hard) stack.  If there's a better 
terminology, I look forward to being educated.

In reference, I used 2.6.22-rc3 (linville git tree) 2.6.22-rc6 (linville 
git tree) and not included but previously tested 2.6.21-1.3228.fc7 
Fedora kernel.  All built from source and ready for changes if need be. 

Pavel Roskin wrote:
> Hello!
>
> On Tue, 2007-06-26 at 18:58 -0700, Ehud Gavron wrote: 
>   
>> I've been alternately switching between 2.6.22-rc3 (Linville git tree) 
>> and 2.5.22-rc6 (Linville git tree as of today), henceforth rc3 and rc6 
>> respectively.
>>     
>
> There have been significant changes in bcm43xx_mac80211 in its own git
> repository (http://bu3sch.de/git/wireless-dev.git), which improved
> things a lot.  As far as I know, the changes are not in 2.6.22-rc6 yet,
> or you would have seen a backtrace.
>
>   
>> I've been alternately switching between bcm43xx and bcm43xx_mac80211, 
>> henceforth soft and hard respectively.
>>     
>
> There is nothing specifically "hard" in mac80211.  You may need to use
> another convention.
>
>   
>> About the only thing I've found "strange" that I hope someone else can 
>> confirm, is that running a tcpdump simultaneously with the DHCP client 
>> causes more success than failure.
>>     
>
> I understand you mean tcpdump on the same machine as the driver.  I
> think I may have seen it.  Perhaps the promiscuous mode would speed up
> recalibration, or something like that.  Anyway, the current git version
> of bcm43xx_mac80211 is working much better and should not need such
> tricks.
>
>   
>> If I had to do a matrix it would look like this:
>> rc6 hard - works but stuck at 1Mbps
>> rc6 soft - works
>> rc6 hard - unable to communicate, but associates fine
>> rc6 soft - works
>>     
>
> You may want to use another convention for kernel versions as well.
> They look too similar to me.
>
>   
>>           Encryption key:896A-0055-AE77-5E80-ED86-4E38-3A
>>     
>
> I hope you understand you cannot reuse this key after having exposed it
> in a public forum.  On the other hand, WEP is considered generally
> unsafe these days, so it's more an polite request to leave your network
> alone than actual security.
>
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070626/22d39fe0/attachment.bin>

From geekypenguin at gmail.com  Wed Jun 27 06:26:48 2007
From: geekypenguin at gmail.com (Jory A. Pratt)
Date: Tue, 26 Jun 2007 23:26:48 -0500
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
In-Reply-To: <1182917122.6439.12.camel@dv>
References: <4681C463.1080109@Wetwork.Net> <1182917122.6439.12.camel@dv>
Message-ID: <4681E708.6060407@gmail.com>

Pavel Roskin wrote:
> Hello!
>
> On Tue, 2007-06-26 at 18:58 -0700, Ehud Gavron wrote: 
>   
>> I've been alternately switching between 2.6.22-rc3 (Linville git tree) 
>> and 2.5.22-rc6 (Linville git tree as of today), henceforth rc3 and rc6 
>> respectively.
>>     
>
> There have been significant changes in bcm43xx_mac80211 in its own git
> repository (http://bu3sch.de/git/wireless-dev.git), which improved
> things a lot.  As far as I know, the changes are not in 2.6.22-rc6 yet,
> or you would have seen a backtrace.
>
>   
These changes do nothing for the 4311 nor the 4318 in current state. You 
are stuck waiting like the rest of the community.
You can always use softmac which is what mainline is still using by default.

The bcm4306 only throws a backtrace with certain revisions, not every 
user will see a backtrace, be glad if your one of them users.

-Jory


From mb at bu3sch.de  Wed Jun 27 15:17:31 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 27 Jun 2007 15:17:31 +0200
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
In-Reply-To: <4681E398.7010508@Wetwork.Net>
References: <4681C463.1080109@Wetwork.Net> <1182917122.6439.12.camel@dv>
	<4681E398.7010508@Wetwork.Net>
Message-ID: <200706271517.31585.mb@bu3sch.de>

On Wednesday 27 June 2007 06:12:08 Ehud Gavron wrote:
> Ehud
> PS Ok, I thought bcm43xx vs bcm43xx_mac80211 was "soft" because it used 
> softmac and bcm43xx_mac80211 used the old devicescape-stack which is 
> alternately the "non-soft" (or hard) stack.  If there's a better 
> terminology, I look forward to being educated.

Ehm... "soft" as in "software", not as in "soft pillow" ;)

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Jun 27 15:24:44 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 27 Jun 2007 15:24:44 +0200
Subject: 2.6.22-rc6, dhcp, promiscuous mode, and other things
In-Reply-To: <200706271517.31585.mb@bu3sch.de>
References: <4681C463.1080109@Wetwork.Net> <4681E398.7010508@Wetwork.Net>
	<200706271517.31585.mb@bu3sch.de>
Message-ID: <200706271524.44413.mb@bu3sch.de>

On Wednesday 27 June 2007 15:17:31 Michael Buesch wrote:
> On Wednesday 27 June 2007 06:12:08 Ehud Gavron wrote:
> > Ehud
> > PS Ok, I thought bcm43xx vs bcm43xx_mac80211 was "soft" because it used 
> > softmac and bcm43xx_mac80211 used the old devicescape-stack which is 
> > alternately the "non-soft" (or hard) stack.  If there's a better 
> > terminology, I look forward to being educated.
> 
> Ehm... "soft" as in "software", not as in "soft pillow" ;)

I should probably explain it, though :)

"softmac" is a general abbreviation for
"Software-based Medium Access Control", Where the medium is
the "air" (no, not the air, but the vacuum of the universe, but...).
So it's a software based control layer for what's going on in
the "air". In contrast to that there are wireless cards that
implement a hardware-mac, so the kernel basically just sees
the usual network packets, as they come from wired network, too.

It's cheaper to create a softmac based card, as you have to
do less in silicon or firmware. So it reduces the bare silicon
and development costs of the device. The downside is that the
CPU in the machine is a little bit busier when transmitting
stuff.

-- 
Greetings Michael.


From Eyes-Killer at gmx.de  Thu Jun 28 19:25:35 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Thu, 28 Jun 2007 19:25:35 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
Message-ID: <20070628172535.96320@gmx.net>

Hi, I'm using notebook Acer Aspire 5022 with builtin WLAN Broadcom 4318.
>>>
[root at Turion ~]# lspci -v
[snip]

06:05.0 Network controller: Broadcom Corporation BCM4318 [AirForce One 54g]
802.11g Wireless LAN Controller (rev 02)
        Subsystem: AMBIT Microsystem Corp. Aspire 3022WLMi, 5024WLMi, 5020
        Flags: bus master, fast devsel, latency 64, IRQ 21
        Memory at c0204000 (32-bit, non-prefetchable) [size=8K]
[snip]
<<<
My wlan worked well until I upgraded from fedora core 6 to fedora 7. Then
bcm43xx-Driver complaints about old firmware version, so I have to get
newer driver. I downloaded broadcom-wl-4.80.53.0.tar.bz2 from
http://downloads.openwrt.org/sources/ and then use bcm43xx-fwcutter which
has following version:
>>>
[root at Turion bcm43xx]# rpm -q bcm43xx-fwcutter
bcm43xx-fwcutter-006-1.fc7.x86_64
<<<
Until here it seems to be ok, but the fwcutter warns me, because I use the
new driver (4.xx). I think its ok.

Following command shows you, what dmesg says after booting (the modules
seems to be loaded automatically):
>>>
[root at Turion ~]# dmesg | grep bcm
bcm43xx_mac80211: Broadcom 4318 WLAN found
bcm43xx_mac80211: Found PHY: Analog 3, Type 2, Revision 7
bcm43xx_mac80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
bcm43xx_mac80211: Radio turned off

[root at Turion ~]# lsmod | grep bcm
bcm43xx_mac80211      415137  0
ssb                    43589  1 bcm43xx_mac80211
mac80211              164297  2 rc80211_simple,bcm43xx_mac80211
<<<

Now let try to use wlan. First I have to turn on wlan since the wlan-button
isn't working under linux:
>>>
[root at Turion ~]# modprobe acer_acpi
[root at Turion ~]# echo "enabled : 1" > /proc/acpi/acer/wireless
[root at Turion ~]# dmesg
[snip]
acer_acpi: Acer Laptop ACPI Extras version 0.5
acer_acpi: Wireless value 0
acer_acpi: Wireless value 1
<<<
After enabling wlan with the command 'echo > wireless' the last line in
dmesg appears.

First I check if there is a device wlan0:
>>>
[root at Turion ~]# iwconfig wlan0
wlan0     IEEE 802.11g  ESSID:""
          Mode:Managed  Channel:0  Access Point: Not-Associated
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
<<<

Now try to get up wlan0 and try to get ip-through dhcp (I already tried with
fixed IP at home, but no success :( ):
>>>
[root at Turion ~]# ifup wlan0

Determining IP information for wlan0... failed.
<<<
At least the wlan-LED was blinking slowly. now let look into dmesg again:
>>>
[root at Turion ~]# dmesg
[snip]
bcm43xx_mac80211: Adding Interface type 2
bcm43xx_mac80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_mac80211: Radio turned on
bcm43xx_mac80211: Radio enabled by hardware
bcm43xx_mac80211: Chip initialized
bcm43xx_mac80211: 32-bit DMA initialized
bcm43xx_mac80211: Wireless interface started
ADDRCONF(NETDEV_UP): wlan0: link is not ready
bridge-wlan0: enabling the bridge
bridge-wlan0: up
bcm43xx_mac80211: Using hardware based encryption for keyidx: 0, mac:
ff:ff:ff:ff:ff:ff
wlan0: Initial auth_alg=0
wlan0: authenticate with AP XX:XX:XX:XX:XX:XX
wlan0: RX authentication from XX:XX:XX:XX:XX:XX (alg=0 transaction=2
status=0)
wlan0: authenticated
wlan0: associate with AP XX:XX:XX:XX:XX:XX
wlan0: RX ReassocResp from XX:XX:XX:XX:XX:XX (capab=0x431 status=0 aid=20)
wlan0: associated
ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
wlan0: no IPv6 routers present
<<<
There is a warning line, which may be the cause of nonworking. :(

If I look into iwconfig it shows Link-Quality, Signal- and Noise-level. Does
it sound good?
>>>
[root at Turion ~]# iwconfig
lo        no wireless extensions.

wmaster0  no wireless extensions.

wlan0     IEEE 802.11g  ESSID:"Guest Access"
          Mode:Managed  Frequency:2.462 GHz  Access Point: XX:XX:XX:XX:XX:XX
          Bit Rate=18 Mb/s
          Retry min limit:7   RTS thr:off   Fragment thr=2346 B
          Encryption key:XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XX
          Link Quality=193/146  Signal level=-238 dBm  Noise level=-73 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

eth0      no wireless extensions.

vmnet8    no wireless extensions.
<<<
But wait, what the hell is wmaster0? In FC6 there was no wmaster0! Whatever.

Now look again into ifconfig. You can see that some bytes was sent/received
(I think it's from trying getting IP-Adress from dhcp-server):
>>>
[root at Turion ~]# ifconfig wlan0
wlan0     Link encap:Ethernet  HWaddr XX:XX:XX:XX:XX:XX
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:1 errors:0 dropped:0 overruns:0 frame:0
          TX packets:29 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:346 (346.0 b)  TX bytes:8657 (8.4 KiB)
<<<

If I try with 'iwlist scan' the AccessPoints are shown in wlan0 which looks
very good. So where is a problem? I hope someone of you could help me.
Please!

cu Floh
PS: With the newer version of bcm43xx there is no need to 'modprobe bcm43xx'
(I mean 'bcm43xx' not 'bcm43xx_mac80211'), am I right?
PS2: I've tried with Windows-Vista-driver for broadcom-chip, but
unfortunatelly it's too new for fwcutter. :(
-- 
GMX FreeMail: 1 GB Postfach, 5 E-Mail-Adressen, 10 Free SMS.
Alle Infos und kostenlose Anmeldung: http://www.gmx.net/de/go/freemail


From larry.finger at lwfinger.net  Thu Jun 28 19:42:14 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 28 Jun 2007 12:42:14 -0500
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070628172535.96320@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net>
Message-ID: <4683F2F6.1010006@lwfinger.net>

Florian Erfurth wrote:
> Hi, I'm using notebook Acer Aspire 5022 with builtin WLAN Broadcom 4318.
> [root at Turion ~]# lspci -v
> [snip]
> 
> 06:05.0 Network controller: Broadcom Corporation BCM4318 [AirForce One 54g]
> 802.11g Wireless LAN Controller (rev 02)
>         Subsystem: AMBIT Microsystem Corp. Aspire 3022WLMi, 5024WLMi, 5020
>         Flags: bus master, fast devsel, latency 64, IRQ 21
>         Memory at c0204000 (32-bit, non-prefetchable) [size=8K]
> [snip]
> <<<
> My wlan worked well until I upgraded from fedora core 6 to fedora 7. Then
> bcm43xx-Driver complaints about old firmware version, so I have to get
--snip--

> There is a warning line, which may be the cause of nonworking. :(

It is a symptom of the cause.

> If I look into iwconfig it shows Link-Quality, Signal- and Noise-level. Does
> it sound good?

Those values are completely bogus. In the official bcm43xx-mac80211 trees, the code gives more 
realistic values, but those patches are not in FC7.

> [root at Turion ~]# iwconfig
> lo        no wireless extensions.
> 
> wmaster0  no wireless extensions.
> 
> wlan0     IEEE 802.11g  ESSID:"Guest Access"
>           Mode:Managed  Frequency:2.462 GHz  Access Point: XX:XX:XX:XX:XX:XX
>           Bit Rate=18 Mb/s
>           Retry min limit:7   RTS thr:off   Fragment thr=2346 B
>           Encryption key:XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XX
>           Link Quality=193/146  Signal level=-238 dBm  Noise level=-73 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> eth0      no wireless extensions.
> 
> vmnet8    no wireless extensions.
> <<<
> But wait, what the hell is wmaster0? In FC6 there was no wmaster0! Whatever.

That is a feature of mac80211. It supports multiple devices, whereas bcm43xx-softmac (the old one) 
does not.

> Now look again into ifconfig. You can see that some bytes was sent/received
> (I think it's from trying getting IP-Adress from dhcp-server):
> [root at Turion ~]# ifconfig wlan0
> wlan0     Link encap:Ethernet  HWaddr XX:XX:XX:XX:XX:XX
>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:1 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:29 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000
>           RX bytes:346 (346.0 b)  TX bytes:8657 (8.4 KiB)
> <<<
> 
> If I try with 'iwlist scan' the AccessPoints are shown in wlan0 which looks
> very good. So where is a problem? I hope someone of you could help me.
> Please!

The problem is one of signal strength/maximum transmission rate with bcm43xx_mac80211. The current 
state in Michael Beusch's git tree is better than that of FC7, but only a little better. One change 
is that the driver initializes to 1 Mbs rather than 54 Mbs, which greatly aids the 
authentication/association process.

> cu Floh
> PS: With the newer version of bcm43xx there is no need to 'modprobe bcm43xx'
> (I mean 'bcm43xx' not 'bcm43xx_mac80211'), am I right?

Yes.

> PS2: I've tried with Windows-Vista-driver for broadcom-chip, but
> unfortunatelly it's too new for fwcutter. :(

Your firmware is not the problem and should be OK.

Larry


From Eyes-Killer at gmx.de  Thu Jun 28 20:16:36 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Thu, 28 Jun 2007 20:16:36 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <4683F2F6.1010006@lwfinger.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
Message-ID: <20070628181636.282160@gmx.net>


-------- Original-Nachricht --------
Datum: Thu, 28 Jun 2007 12:42:14 -0500
Von: Larry Finger <larry.finger at lwfinger.net>
An: Florian Erfurth <Eyes-Killer at gmx.de>
CC: bcm43xx-dev at lists.berlios.de
Betreff: Re: Broadcom 4318 with newer bcm43xx&firmware doesn\'t works

> Florian Erfurth wrote:
> --snip--
> 
> > There is a warning line, which may be the cause of nonworking. :(
> 
> It is a symptom of the cause.
> 
> > If I look into iwconfig it shows Link-Quality, Signal- and Noise-level.
> Does
> > it sound good?
> 
> Those values are completely bogus. In the official bcm43xx-mac80211 trees,
> the code gives more 
> realistic values, but those patches are not in FC7.
So do anyone of you know when will this patches applied into kernel/F7-kernel?

> > But wait, what the hell is wmaster0? In FC6 there was no wmaster0!
> Whatever.
> 
> That is a feature of mac80211. It supports multiple devices, whereas
> bcm43xx-softmac (the old one) 
> does not.
Hm... for what is a multiple device support good? O_o

> > [snip]
> The problem is one of signal strength/maximum transmission rate with
> bcm43xx_mac80211. The current 
> state in Michael Beusch's git tree is better than that of FC7, but only a
> little better. One change 
> is that the driver initializes to 1 Mbs rather than 54 Mbs, which greatly
> aids the 
> authentication/association process.
Thank you for your information. So what do you suggest? Should I wait until the next kernel-version? Or should I build my own bcm43xx_mac80211-module?
May I delete the bcm43xx_mac80211.ko, which came with rpm from f7d and replace this with the newer ones from tree?

> > cu Floh
> > PS: With the newer version of bcm43xx there is no need to 'modprobe
> bcm43xx'
> > (I mean 'bcm43xx' not 'bcm43xx_mac80211'), am I right?
> 
> Yes.
So why is there bcm43xx? Or is this module for older firmware (3.x)? If yes, then I could use bcm43xx instead (with previously used firmware) until Fedora applied the needed patches?

> > PS2: I've tried with Windows-Vista-driver for broadcom-chip, but
> > unfortunatelly it's too new for fwcutter. :(
> 
> Your firmware is not the problem and should be OK.
Good to know.

cu Floh
-- 
Der GMX SmartSurfer hilft bis zu 70% Ihrer Onlinekosten zu sparen! 
Ideal f?r Modem und ISDN: http://www.gmx.net/de/go/smartsurfer


From larry.finger at lwfinger.net  Thu Jun 28 20:31:05 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 28 Jun 2007 13:31:05 -0500
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070628181636.282160@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net>
Message-ID: <4683FE69.6080902@lwfinger.net>

Florian Erfurth wrote:
> -------- Original-Nachricht --------
> Datum: Thu, 28 Jun 2007 12:42:14 -0500
> Von: Larry Finger <larry.finger at lwfinger.net>
> An: Florian Erfurth <Eyes-Killer at gmx.de>
> CC: bcm43xx-dev at lists.berlios.de
> Betreff: Re: Broadcom 4318 with newer bcm43xx&firmware doesn\'t works
> 
>> Florian Erfurth wrote:
>> --snip--
>>> If I look into iwconfig it shows Link-Quality, Signal- and Noise-level.
>> Does
>>> it sound good?
>> Those values are completely bogus. In the official bcm43xx-mac80211 trees,
>> the code gives more 
>> realistic values, but those patches are not in FC7.
> So do anyone of you know when will this patches applied into kernel/F7-kernel?

You would have to ask the people that control FC.

> Thank you for your information. So what do you suggest? Should I wait until the next kernel-version? 
 > Or should I build my own bcm43xx_mac80211-module?
> May I delete the bcm43xx_mac80211.ko, which came with rpm from f7d and replace this with 
 >the newer ones from tree?

You could build a new version of bcm43xx-mac80211 from the tree, but I suggest building and/or using 
the softmac version of bcm43xx (the one that uses V3 firmware) as long as you have the kernel 
sources. With 2.6.21 or later, no patches are required.

> So why is there bcm43xx? Or is this module for older firmware (3.x)? If yes, 
 >then I could use bcm43xx instead (with previously used firmware) until Fedora applied the needed 
patches?

Yes, bcm43xx is for the V3 firmware, and uses SoftMAC for its MAC layer. Does your current kernel 
have bcm43xx already built? If so, just use it.

Larry


From Eyes-Killer at gmx.de  Thu Jun 28 20:46:28 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Thu, 28 Jun 2007 20:46:28 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <4683FE69.6080902@lwfinger.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
Message-ID: <20070628184628.125850@gmx.net>

Hi Larry, thank you very much!

Von: Larry Finger <larry.finger at lwfinger.net>
> Florian Erfurth wrote:
> > Von: Larry Finger <larry.finger at lwfinger.net>
> >> Those values are completely bogus. In the official bcm43xx-mac80211
> >> trees, the code gives more 
> >> realistic values, but those patches are not in FC7.
> > So do anyone of you know when will this patches applied into
> kernel/F7-kernel?
> 
> You would have to ask the people that control FC.
Ok, I'll do that.

> > Thank you for your information. So what do you suggest? Should I wait
> until the next kernel-version? 
>  > Or should I build my own bcm43xx_mac80211-module?
> > May I delete the bcm43xx_mac80211.ko, which came with rpm from f7d and
> replace this with 
>  >the newer ones from tree?
> 
> You could build a new version of bcm43xx-mac80211 from the tree, but I
> suggest building and/or using 
> the softmac version of bcm43xx (the one that uses V3 firmware) as long as
> you have the kernel 
> sources. With 2.6.21 or later, no patches are required.
Umm... I'm using 2.6.21 (sorry, I forgot to mention that):
>>>
[root at Turion ~]# uname -a
Linux Turion 2.6.21-1.3228.fc7 #1 SMP Tue Jun 12 14:56:37 EDT 2007 x86_64 x86_64 x86_64 GNU/Linux
<<<

> > So why is there bcm43xx? Or is this module for older firmware (3.x)? If
> yes, 
>  >then I could use bcm43xx instead (with previously used firmware) until
> Fedora applied the needed 
> patches?
> 
> Yes, bcm43xx is for the V3 firmware, and uses SoftMAC for its MAC layer.
> Does your current kernel 
> have bcm43xx already built? If so, just use it.
After modprobing bcm43xx no wlan0 appears in iwconfig. See below:
>>>
[root at Turion ~]# lsmod | grep bcm43
bcm43xx_mac80211      415137  0
ssb                    43589  1 bcm43xx_mac80211
mac80211              164297  2 rc80211_simple,bcm43xx_mac80211
[root at Turion ~]# rmmod bcm43xx_mac80211
[root at Turion ~]# rmmod rc80211_simple
[root at Turion ~]# lsmod | grep mac80211
mac80211              164297  0
cfg80211               17745  1 mac80211
[root at Turion ~]# rmmod mac80211
[root at Turion ~]# rmmod cfg80211
[root at Turion ~]# rmmod ssb
[root at Turion ~]# iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

vmnet8    no wireless extensions.

[root at Turion ~]# modprobe bcm43xx
[root at Turion ~]# iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

vmnet8    no wireless extensions.

[root at Turion ~]# dmesg
[snip]
bcm43xx driver
<<<
Hm... what could be wrong? Did I forgot somewhat?

cu Floh
-- 
Der GMX SmartSurfer hilft bis zu 70% Ihrer Onlinekosten zu sparen! 
Ideal f?r Modem und ISDN: http://www.gmx.net/de/go/smartsurfer


From larry.finger at lwfinger.net  Thu Jun 28 21:06:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 28 Jun 2007 14:06:41 -0500
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070628184628.125850@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net>
Message-ID: <468406C1.8080806@lwfinger.net>

Florian Erfurth wrote:
> Hi Larry, thank you very much!
> 
> Von: Larry Finger <larry.finger at lwfinger.net>
>> Florian Erfurth wrote:
>>> Von: Larry Finger <larry.finger at lwfinger.net>
>>>> Those values are completely bogus. In the official bcm43xx-mac80211
>>>> trees, the code gives more 
>>>> realistic values, but those patches are not in FC7.
>>> So do anyone of you know when will this patches applied into
>> kernel/F7-kernel?
>>
>> You would have to ask the people that control FC.
> Ok, I'll do that.
> 
>>> Thank you for your information. So what do you suggest? Should I wait
>> until the next kernel-version? 
>>  > Or should I build my own bcm43xx_mac80211-module?
>>> May I delete the bcm43xx_mac80211.ko, which came with rpm from f7d and
>> replace this with 
>>  >the newer ones from tree?
>>
>> You could build a new version of bcm43xx-mac80211 from the tree, but I
>> suggest building and/or using 
>> the softmac version of bcm43xx (the one that uses V3 firmware) as long as
>> you have the kernel 
>> sources. With 2.6.21 or later, no patches are required.
> Umm... I'm using 2.6.21 (sorry, I forgot to mention that):
> [root at Turion ~]# uname -a
> Linux Turion 2.6.21-1.3228.fc7 #1 SMP Tue Jun 12 14:56:37 EDT 2007 x86_64 x86_64 x86_64 GNU/Linux
> <<<
> 
>>> So why is there bcm43xx? Or is this module for older firmware (3.x)? If
>> yes, 
>>  >then I could use bcm43xx instead (with previously used firmware) until
>> Fedora applied the needed 
>> patches?
>>
>> Yes, bcm43xx is for the V3 firmware, and uses SoftMAC for its MAC layer.
>> Does your current kernel 
>> have bcm43xx already built? If so, just use it.
> After modprobing bcm43xx no wlan0 appears in iwconfig. See below:
> [root at Turion ~]# lsmod | grep bcm43
> bcm43xx_mac80211      415137  0
> ssb                    43589  1 bcm43xx_mac80211
> mac80211              164297  2 rc80211_simple,bcm43xx_mac80211
> [root at Turion ~]# rmmod bcm43xx_mac80211
> [root at Turion ~]# rmmod rc80211_simple
> [root at Turion ~]# lsmod | grep mac80211
> mac80211              164297  0
> cfg80211               17745  1 mac80211
> [root at Turion ~]# rmmod mac80211
> [root at Turion ~]# rmmod cfg80211
> [root at Turion ~]# rmmod ssb
> [root at Turion ~]# iwconfig
> lo        no wireless extensions.
> 
> eth0      no wireless extensions.
> 
> vmnet8    no wireless extensions.
> 
> [root at Turion ~]# modprobe bcm43xx
> [root at Turion ~]# iwconfig
> lo        no wireless extensions.
> 
> eth0      no wireless extensions.
> 
> vmnet8    no wireless extensions.
> 
> [root at Turion ~]# dmesg
> [snip]
> bcm43xx driver
> <<<
> Hm... what could be wrong? Did I forgot somewhat?

Did you switch back to V3 firmware? Check dmesg for any diagnostic messages.

Larry


From Eyes-Killer at gmx.de  Thu Jun 28 21:39:02 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Thu, 28 Jun 2007 21:39:02 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <468406C1.8080806@lwfinger.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
Message-ID: <20070628193902.40970@gmx.net>


Von: Larry Finger <larry.finger at lwfinger.net>
> Florian Erfurth wrote:
> > [root at Turion ~]# dmesg
> > [snip]
> > bcm43xx driver
> > <<<
> > Hm... what could be wrong? Did I forgot somewhat?
> 
> Did you switch back to V3 firmware? Check dmesg for any diagnostic
> messages.
Yes, I switched back to V3 firmware. In dmesg only 'bcm43xx driver' appears. O_o Ok, I should try to reboot, but I can't do that now. I'll try rebooting later (maybe tommorow in the morning).

Thank you for your great help.
cu Floh
-- 
Psssst! Schon vom neuen GMX MultiMessenger geh?rt?
Der kanns mit allen: http://www.gmx.net/de/go/multimessenger


From andrew.james.barr at gmail.com  Thu Jun 28 22:06:56 2007
From: andrew.james.barr at gmail.com (Andrew J. Barr)
Date: Thu, 28 Jun 2007 16:06:56 -0400
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070628193902.40970@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<20070628193902.40970@gmx.net>
Message-ID: <20070628160656.36222076@conroe.oakcourt.dyndns.org>

"Florian Erfurth" <Eyes-Killer at gmx.de> wrote:

> 
> Von: Larry Finger <larry.finger at lwfinger.net>
> > Florian Erfurth wrote:
> > > [root at Turion ~]# dmesg
> > > [snip]
> > > bcm43xx driver
> > > <<<
> > > Hm... what could be wrong? Did I forgot somewhat?
> > 
> > Did you switch back to V3 firmware? Check dmesg for any diagnostic
> > messages.
> Yes, I switched back to V3 firmware. In dmesg only 'bcm43xx driver'
> appears. O_o Ok, I should try to reboot, but I can't do that now.
> I'll try rebooting later (maybe tommorow in the morning).

You need to up your interface. Use the distro tools or "ifconfig (iface)
up"

> Thank you for your great help.
> cu Floh


-- 
Andrew J. Barr

Woke up in my clothes again this morning,
don't know exactly where I am...


From gavron at wetwork.net  Thu Jun 28 22:30:09 2007
From: gavron at wetwork.net (Ehud Gavron)
Date: Thu, 28 Jun 2007 13:30:09 -0700
Subject: F7 with newer kernel
In-Reply-To: <20070628193902.40970@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<20070628193902.40970@gmx.net>
Message-ID: <46841A51.9070502@wetwork.net>

I use F7, and having had the same disappointing results upgraded my kernel.
IF YOU USE NVIDIA VIDEO DRIVERS DO THIS ONLY AFTER FOLLOWING THE 
PROCEDURE BELOW MY SIGNATURE

Building the latest Larry Linville kernel on F7 systems:

# cd /usr/src
# git clone 
git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git
# ln wireless-dev linux
# cd /usr/src/linux
# cp /usr/src/kernels/2.6.21-1.3228.fc7-x86_64/.config ./.config
# make clean
# make oldconfig
(Answer the questions any way you like... hitting enter a bunch of times 
works.)
# grep -i bcm43xx .config (mine is included below)
# time nice make bzImage                (mine takes 9 min)
# time nice make modules                (mine takes 44 min)
# time nice make modules_install  (mine takes 1 min)
# time nice make install                    (mine takes 1 min)
# sed -i -e "s/default=1/default=0/g" /etc/grub.conf

Note that in the future you'll want to do yum update --exclude=kernel 
--exclude=kmod-nvidia --exclude=xorg-x11-drv-nvidia until F7 releases a 
kernel which postdates 2.6.22-rc6 (likely that would be 2.6.22 ;-)

Then reboot... your new kernel will work much better with your wireless 
driver.
If you're using a proprietary driver for your graphics card, see the 
note below.

Ehud

Here's my .config section, and for future searches  F7 .config for 
kernel 2.6.22-rc6 wireless-dev
# grep -i bcm43xx .config
CONFIG_BCM43XX=m
CONFIG_BCM43XX_DEBUG=y
CONFIG_BCM43XX_DMA=y
CONFIG_BCM43XX_PIO=y
CONFIG_BCM43XX_DMA_AND_PIO_MODE=y
# CONFIG_BCM43XX_DMA_MODE is not set
# CONFIG_BCM43XX_PIO_MODE is not set
CONFIG_BCM43XX_MAC80211=m
CONFIG_BCM43XX_MAC80211_PCI=y
CONFIG_BCM43XX_MAC80211_PCMCIA=y
CONFIG_BCM43XX_MAC80211_DEBUG=y
CONFIG_BCM43XX_MAC80211_DMA=y
CONFIG_BCM43XX_MAC80211_PIO=y
CONFIG_BCM43XX_MAC80211_DMA_AND_PIO_MODE=y
# CONFIG_BCM43XX_MAC80211_DMA_MODE is not set
# CONFIG_BCM43XX_MAC80211_PIO_MODE is not set


Note on proprietary graphics card drivers and F7.... the Livna and the 
AT people are really nice about packaging these for the specific F7 
releases.  However, when you switch off to your own kernel you need to 
build those packages from source.  Unfortunately the packages from the 
vendors (mine's Nvidia) put files in different places than the livna 
ones.  So what I had to do was...

Nvidia Drivers on F7 with alternate kernel, hard work the first time, 
only one script to run after future kernel upgrades.
1. rpm -e kmod-nvidia
2. bring in the nvidia stuff and put it somewhere (I chose 
/usr/local/src/nvidia)
3. the first time run the whole thing and let it install its version of 
libraries, build a kernel module, etc.  (Answer "no" to precompiled 
module and answer "no" to search website for precompiled module.)
4. make sure X works, and if you had "Desktop Effects" (compiz) enabled, 
check to make sure that works.  The problems I encountered were on my 
64-bit system the Nvidia installer wants to place the files in 
/usr/lib64/X11R6.... but the Xorg stuff wants it in 
/usr/lib64/xorg/modules... 
5. make sure that the whole "Nvidia" startup in /etc/rc.d/init.d is 
gone.  It will munge your /etc/X11/xorg.conf every boot.
6. ONCE YOU GET VIDEO WORKING JUST FINE, AND SURVIVING A REBOOT, only 
then do the procedure above to upgrade your kernel.
7. Once you reboot with the new kernel, you'll want to run this script:
#/bin/sh
# If the kernel version has changed, rebuild the Nvidia package...
NVDIR=/usr/local/src/nvidia
#
if [ ! -f "$NVDIR/kernel_version.txt" ]; then
   echo "No previous kernel configured" > $NVDIR/kernel_version.txt
fi

oldkern=`cat $NVDIR/kernel_version.txt"
newkern=`uname -r`
if [ "$oldkern" != "$newkern" ]; then
   # The kernels differ ... build a new one...
   arch=`arch`
   file=`ls -C1 $NVDIR/*$arch*.run | tail -1`
   $NVDIR/$file -sKN >$NVDIR/build.out 2>&1
   uname -r > $NVDIR/kernel_version.txt
fi

#end
Florian Erfurth wrote:
> Von: Larry Finger <larry.finger at lwfinger.net>
>   
>> Florian Erfurth wrote:
>>     
>>> [root at Turion ~]# dmesg
>>> [snip]
>>> bcm43xx driver
>>> <<<
>>> Hm... what could be wrong? Did I forgot somewhat?
>>>       
>> Did you switch back to V3 firmware? Check dmesg for any diagnostic
>> messages.
>>     
> Yes, I switched back to V3 firmware. In dmesg only 'bcm43xx driver' appears. O_o Ok, I should try to reboot, but I can't do that now. I'll try rebooting later (maybe tommorow in the morning).
>
> Thank you for your great help.
> cu Floh
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070628/277a0f7e/attachment.bin>

From gavron at wetwork.net  Thu Jun 28 23:08:48 2007
From: gavron at wetwork.net (Ehud Gavron)
Date: Thu, 28 Jun 2007 14:08:48 -0700
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <468406C1.8080806@lwfinger.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
Message-ID: <46842360.3090601@wetwork.net>

One of the things I did is put the v3 firmware in /lib/firmware only I 
renamed the files from *.fw to *.fw3.fw
I then can do modprobe bcm43xx fwpostfix=".fw3"   to load the bcm43xx 
module with the old firmware.

put all v3 firmware files in /lib/firmware/v3
# cd /lib/firmware/v3
# ls -C1 *.fw | awk -F\. '{print $1}' | xargs -i$ cp $.fw $.fw3.fw
# mv *.fw3.fw /lib/firmware/

Ehud

Larry Finger wrote:
> Did you switch back to V3 firmware? Check dmesg for any diagnostic messages.
>
> Larry
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070628/86af9475/attachment.bin>

From johannes at sipsolutions.net  Thu Jun 28 23:44:13 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 28 Jun 2007 23:44:13 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <4683FE69.6080902@lwfinger.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net>  <4683FE69.6080902@lwfinger.net>
Message-ID: <1183067053.4089.4.camel@johannes.berg>

On Thu, 2007-06-28 at 13:31 -0500, Larry Finger wrote:

> Yes, bcm43xx is for the V3 firmware, and uses SoftMAC for its MAC layer. Does your current kernel 
> have bcm43xx already built? If so, just use it.

bcm43xx is built on fc7 but has no PCI IDs, you have to add those
manually. John Linville posted a description somewhere

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070628/f00816f0/attachment.pgp>

From Eyes-Killer at gmx.de  Fri Jun 29 08:33:45 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Fri, 29 Jun 2007 08:33:45 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070628160656.36222076@conroe.oakcourt.dyndns.org>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net>	<4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net>	<4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net>	<468406C1.8080806@lwfinger.net>
	<20070628193902.40970@gmx.net>
	<20070628160656.36222076@conroe.oakcourt.dyndns.org>
Message-ID: <20070629063345.218810@gmx.net>


Von: "Andrew J. Barr" <andrew.james.barr at gmail.com>
> "Florian Erfurth" <Eyes-Killer at gmx.de> wrote:
>
> [snip] 
> You need to up your interface. Use the distro tools or "ifconfig (iface)
> up"
Did I write, there is no wlan0 in "ifconfig"? I mean, there is no wlan0 in "iwconfig". If there is no wlan0 in iwconfig, ifconfig wont work because of missing device.

cu Floh
-- 
GMX FreeMail: 1 GB Postfach, 5 E-Mail-Adressen, 10 Free SMS.
Alle Infos und kostenlose Anmeldung: http://www.gmx.net/de/go/freemail


From Eyes-Killer at gmx.de  Fri Jun 29 08:41:02 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Fri, 29 Jun 2007 08:41:02 +0200
Subject: F7 with newer kernel
In-Reply-To: <46841A51.9070502@wetwork.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<20070628193902.40970@gmx.net> <46841A51.9070502@wetwork.net>
Message-ID: <20070629064102.218810@gmx.net>

Von: Ehud Gavron <gavron at wetwork.net>
> I use F7, and having had the same disappointing results upgraded my
> kernel.
> IF YOU USE NVIDIA VIDEO DRIVERS DO THIS ONLY AFTER FOLLOWING THE 
> PROCEDURE BELOW MY SIGNATURE
I'm using ati with opensource-driver radeon. :)

> Building the latest Larry Linville kernel on F7 systems:
I want to avoid building/using custom kernel. Not that I don't know how to do that, but I often built custom kernels. I want to use the default-kernel and add only needed modules (like acer_acpi).
I would prefer to build own bcm43xx_mac80211 and then replace the original files from f7-kernel by this one.
But I'll try the other suggested way first: Adding PCI ID.

Thank you very much for very detailed instructions. :)
cu Floh
-- 
Der GMX SmartSurfer hilft bis zu 70% Ihrer Onlinekosten zu sparen! 
Ideal f?r Modem und ISDN: http://www.gmx.net/de/go/smartsurfer


From Eyes-Killer at gmx.de  Fri Jun 29 08:44:39 2007
From: Eyes-Killer at gmx.de (Florian Erfurth)
Date: Fri, 29 Jun 2007 08:44:39 +0200
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <46842360.3090601@wetwork.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<46842360.3090601@wetwork.net>
Message-ID: <20070629064439.218800@gmx.net>


Von: Ehud Gavron <gavron at wetwork.net>
> One of the things I did is put the v3 firmware in /lib/firmware only I 
> renamed the files from *.fw to *.fw3.fw
> I then can do modprobe bcm43xx fwpostfix=".fw3"   to load the bcm43xx 
> module with the old firmware.
If I modprobe without parameters, then the *.fw files are loaded. Am I right? If yes, then I don't need to do that, because I already replaced the V4 firmware by V3 ones. And in the future (if bcm4318 works well with V4) I'll switch back to V4.

Thank you!
Floh
-- 
Psssst! Schon vom neuen GMX MultiMessenger geh?rt?
Der kanns mit allen: http://www.gmx.net/de/go/multimessenger


From gavron at Wetwork.Net  Fri Jun 29 08:45:56 2007
From: gavron at Wetwork.Net (Ehud Gavron)
Date: Thu, 28 Jun 2007 23:45:56 -0700
Subject: Broadcom 4318 with newer bcm43xx&firmware doesn't works
In-Reply-To: <20070629064439.218800@gmx.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<46842360.3090601@wetwork.net> <20070629064439.218800@gmx.net>
Message-ID: <4684AAA4.5020209@Wetwork.Net>

Right.
E

Florian Erfurth wrote:
> Von: Ehud Gavron <gavron at wetwork.net>
>   
>> One of the things I did is put the v3 firmware in /lib/firmware only I 
>> renamed the files from *.fw to *.fw3.fw
>> I then can do modprobe bcm43xx fwpostfix=".fw3"   to load the bcm43xx 
>> module with the old firmware.
>>     
> If I modprobe without parameters, then the *.fw files are loaded. Am I right? If yes, then I don't need to do that, because I already replaced the V4 firmware by V3 ones. And in the future (if bcm4318 works well with V4) I'll switch back to V4.
>
> Thank you!
> Floh
>   
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 3283 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070628/603d2dfc/attachment.bin>

From dwmw2 at infradead.org  Fri Jun 29 13:19:55 2007
From: dwmw2 at infradead.org (David Woodhouse)
Date: Fri, 29 Jun 2007 12:19:55 +0100
Subject: F7 with newer kernel
In-Reply-To: <46841A51.9070502@wetwork.net>
References: <mailman.0.1183051358.13600.bcm43xx-dev@lists.berlios.de>
	<20070628172535.96320@gmx.net> <4683F2F6.1010006@lwfinger.net>
	<20070628181636.282160@gmx.net> <4683FE69.6080902@lwfinger.net>
	<20070628184628.125850@gmx.net> <468406C1.8080806@lwfinger.net>
	<20070628193902.40970@gmx.net>  <46841A51.9070502@wetwork.net>
Message-ID: <1183115995.1170.294.camel@pmac.infradead.org>

On Thu, 2007-06-28 at 13:30 -0700, Ehud Gavron wrote:
> # cd /usr/src
> # git clone 
> git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git
> # ln wireless-dev linux
> # cd /usr/src/linux
> # cp /usr/src/kernels/2.6.21-1.3228.fc7-x86_64/.config ./.config
> # make clean
> # make oldconfig
> (Answer the questions any way you like... hitting enter a bunch of times 
> works.)
> # grep -i bcm43xx .config (mine is included below)
> # time nice make bzImage                (mine takes 9 min)
> # time nice make modules                (mine takes 44 min)
> # time nice make modules_install  (mine takes 1 min)
> # time nice make install                    (mine takes 1 min)
> # sed -i -e "s/default=1/default=0/g" /etc/grub.conf 

You shouldn't need to rebuild the whole kernel. Just make sure
kernel-devel is installed and build the drivers you want.

sudo yum install kernel-devel
cd
git-clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-dev.git
cd wireless-dev/drivers/net/wireless/mac80211/bcm43xx
make -C /lib/modules/`uname -r`/build SUBDIRS=`pwd` modules
sudo rmmod bcm43xx-mac80211 \; insmod ./bcm43xx-mac80211.ko

-- 
dwmw2



From livinglatexkali at gmail.com  Sat Jun 30 13:23:36 2007
From: livinglatexkali at gmail.com (Quinn Storm)
Date: Sat, 30 Jun 2007 07:23:36 -0400
Subject: Basic success report
Message-ID: <200706300723.36744.livinglatexkali@gmail.com>

I figured I'd mention that a card in my HP laptop actually does work, despite 
it not being listed.  Its a 4311 card, fairly obviously, and while it can be 
a little flakey (sometimes it will get into a state where it refuses to 
associate, but also claims it is associated), it basically works, with decent 
(though not phenomenal) transmit power, and proper full speed.  This is with 
a firmware of provenance I have forgotten after many trial-and-errors back 
when the 4311 support was just starting to mature, and with the ubuntu stock 
kernel & driver (well, ubuntu gutsy, which is still a work-in-progress)

quinn at berylinabox:~/v4l-dvb-experimental$ ( dmesg | egrep 'bcm43xx: (Chip|
Core|Detected)' ; lspci -vn | grep -i 14e4:43 -A1 )
03:00.0 0280: 14e4:4311 (rev 01)
        Subsystem: 103c:1363
quinn at berylinabox:~/v4l-dvb-experimental$ uname -r
2.6.22-7-generic


--Quinn


