From fgaliegue at gmail.com  Thu May  1 03:01:55 2008
From: fgaliegue at gmail.com (Francis Galiegue)
Date: Thu, 1 May 2008 03:01:55 +0200
Subject: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<1209380820.4002.10.camel@dv>
	<ac542ca00804280415p2b169915u5b56832d7bd378ed@mail.gmail.com>
	<ac542ca00804281106o26a4bcd3h7ac1d66bba8ba28e@mail.gmail.com>
	<1209407773.29025.23.camel@johannes.berg>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
Message-ID: <ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>

>
> >
>  > No, "you only need *-allow-ap-vlan-modes.patch for current hostapd git", as
>  > SERIES says. I think that would be
>  > http://johannes.sipsolutions.net/patches/kernel/all/LATEST/026-allow-ap-vlan-modes.patch.
>  >
>
>  OK, it's starting to get a little more clear now.
>
>  I've git-pulled the whole wireless-testing, applied this patch and am
>  right now in the process of compiling the kernel.
>
>  After this, time for hostapd...
>

With the following patch applied, plus libnl 1.1, and git hostapd...

unencrypted AP --> success;
WAP --> segfault

A quick strace shows that the segfault appears some time after
receiving a message from the netlink socket.

More strange though: in case the wlan interface is within a bridge
interface (knowing that the "primary" interface of the bridge is not
the wlan interface itself, but another Ethernet card on the same
machine), the segfault does NOT occur. Instead, I get this ad vitam
aeternam in hostapd's stdout output:

----
209603485.139742: Failed to set CTS protect in kernel driver
1209603485.139869: Failed to set Short Slot Time option in kernel driver
1209603485.139909: Could not set preamble for kernel driver
1209603485.478903: wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: authenticated
1209603485.480120: Failed to set CTS protect in kernel driver
1209603485.480169: Failed to set Short Slot Time option in kernel driver
1209603485.480328: Could not set preamble for kernel driver
1209603485.482510: wlan0: STA 00:15:00:35:12:e0 IEEE 802.11:
associated (aid 1, accounting session 48191554-00000009)
Could not set station 00:15:00:35:12:e0 flags for kernel driver (errno=22).
Could not set station 00:15:00:35:12:e0 flags for kernel driver (errno=22).
1209603488.491854: wlan0: STA 00:15:00:35:12:e0 IEEE 802.11:
deauthenticated due to local deauth request
[then loop back to the first message after barely a second]
----

-- 
Francis Galiegue, fgaliegue at gmail.com
"It seems obvious [...] that at least some 'business intelligence'
tools invest so much intelligence on the business side that they have
nothing left for generating SQL queries" (St?phane Faroult, in "The
Art of SQL", ISBN 0-596-00894-5)


From johannes at sipsolutions.net  Thu May  1 03:43:45 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 01 May 2008 03:43:45 +0200
Subject: BCM4308 rev 3 owner, willing to help (want to make an access
	point)
In-Reply-To: <ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	(sfid-20080501_030402_356523_12337CF1)
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<1209380820.4002.10.camel@dv>
	<ac542ca00804280415p2b169915u5b56832d7bd378ed@mail.gmail.com>
	<ac542ca00804281106o26a4bcd3h7ac1d66bba8ba28e@mail.gmail.com>
	<1209407773.29025.23.camel@johannes.berg>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	(sfid-20080501_030402_356523_12337CF1)
Message-ID: <1209606225.7173.15.camel@johannes.berg>

On Thu, 2008-05-01 at 03:01 +0200, Francis Galiegue wrote:
> >
> > >
> >  > No, "you only need *-allow-ap-vlan-modes.patch for current hostapd git", as
> >  > SERIES says. I think that would be
> >  > http://johannes.sipsolutions.net/patches/kernel/all/LATEST/026-allow-ap-vlan-modes.patch.
> >  >
> >
> >  OK, it's starting to get a little more clear now.
> >
> >  I've git-pulled the whole wireless-testing, applied this patch and am
> >  right now in the process of compiling the kernel.
> >
> >  After this, time for hostapd...
> >
> 
> With the following patch applied, plus libnl 1.1, and git hostapd...
> 
> unencrypted AP --> success;
> WAP --> segfault

http://johannes.sipsolutions.net/patches/kernel/all/2008-05-01-00:32/023-mac80211-fix-debugfs-key.patch

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080501/5c524660/attachment.pgp>

From mb at bu3sch.de  Thu May  1 12:08:10 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 12:08:10 +0200
Subject: [PATCH] b43: Fix some TX/RX locking issues
In-Reply-To: <200804251929.09301.mb@bu3sch.de>
References: <200804251929.09301.mb@bu3sch.de>
Message-ID: <200805011208.10533.mb@bu3sch.de>

John, did you drop this patch? I can't see it in git and your latest push,
while a patch submitted later is in there.

On Friday 25 April 2008, Michael Buesch wrote:
> This fixes some TX/RX related locking issues.
> With this patch applied, some of the PHY transmission errors are fixed.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> 
> ---
> 
> John, this is for 2.6.26.
> 
> 
> Index: wireless-testing/drivers/net/wireless/b43/b43.h
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-04-24 19:42:55.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-04-25 19:28:42.000000000 +0200
> @@ -688,12 +688,16 @@ struct b43_wl {
>  	struct b43_wldev *current_dev;
>  	/* Pointer to the ieee80211 hardware data structure */
>  	struct ieee80211_hw *hw;
>  
>  	struct mutex mutex;
>  	spinlock_t irq_lock;
> +	/* R/W lock for data transmission.
> +	 * Transmissions on 2+ queues can run concurrently, but somebody else
> +	 * might sync with TX by write_lock_irqsave()'ing. */
> +	rwlock_t tx_lock;
>  	/* Lock for LEDs access. */
>  	spinlock_t leds_lock;
>  	/* Lock for SHM access. */
>  	spinlock_t shm_lock;
>  
>  	/* We can only have one operating interface (802.11 core)
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-04-24 19:42:55.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/main.c	2008-04-25 18:47:08.000000000 +0200
> @@ -726,12 +726,13 @@ static void b43_synchronize_irq(struct b
>  
>  /* DummyTransmission function, as documented on
>   * http://bcm-specs.sipsolutions.net/DummyTransmission
>   */
>  void b43_dummy_transmission(struct b43_wldev *dev)
>  {
> +	struct b43_wl *wl = dev->wl;
>  	struct b43_phy *phy = &dev->phy;
>  	unsigned int i, max_loop;
>  	u16 value;
>  	u32 buffer[5] = {
>  		0x00000000,
>  		0x00D40000,
> @@ -752,12 +753,15 @@ void b43_dummy_transmission(struct b43_w
>  		break;
>  	default:
>  		B43_WARN_ON(1);
>  		return;
>  	}
>  
> +	spin_lock_irq(&wl->irq_lock);
> +	write_lock(&wl->tx_lock);
> +
>  	for (i = 0; i < 5; i++)
>  		b43_ram_write(dev, i * 4, buffer[i]);
>  
>  	/* Commit writes */
>  	b43_read32(dev, B43_MMIO_MACCTL);
>  
> @@ -792,12 +796,15 @@ void b43_dummy_transmission(struct b43_w
>  		if (!(value & 0x0100))
>  			break;
>  		udelay(10);
>  	}
>  	if (phy->radio_ver == 0x2050 && phy->radio_rev <= 0x5)
>  		b43_radio_write16(dev, 0x0051, 0x0037);
> +
> +	write_unlock(&wl->tx_lock);
> +	spin_unlock_irq(&wl->irq_lock);
>  }
>  
>  static void key_write(struct b43_wldev *dev,
>  		      u8 index, u8 algorithm, const u8 * key)
>  {
>  	unsigned int i;
> @@ -2821,30 +2828,37 @@ static int b43_rng_init(struct b43_wl *w
>  static int b43_op_tx(struct ieee80211_hw *hw,
>  		     struct sk_buff *skb,
>  		     struct ieee80211_tx_control *ctl)
>  {
>  	struct b43_wl *wl = hw_to_b43_wl(hw);
>  	struct b43_wldev *dev = wl->current_dev;
> -	int err = -ENODEV;
> +	unsigned long flags;
> +	int err;
>  
>  	if (unlikely(skb->len < 2 + 2 + 6)) {
>  		/* Too short, this can't be a valid frame. */
> -		return -EINVAL;
> +		dev_kfree_skb_any(skb);
> +		return NETDEV_TX_OK;
>  	}
>  	B43_WARN_ON(skb_shinfo(skb)->nr_frags);
> -
>  	if (unlikely(!dev))
> -		goto out;
> -	if (unlikely(b43_status(dev) < B43_STAT_STARTED))
> -		goto out;
> -	/* TX is done without a global lock. */
> -	if (b43_using_pio_transfers(dev))
> -		err = b43_pio_tx(dev, skb, ctl);
> -	else
> -		err = b43_dma_tx(dev, skb, ctl);
> -out:
> +		return NETDEV_TX_BUSY;
> +
> +	/* Transmissions on seperate queues can run concurrently. */
> +	read_lock_irqsave(&wl->tx_lock, flags);
> +
> +	err = -ENODEV;
> +	if (likely(b43_status(dev) >= B43_STAT_STARTED)) {
> +		if (b43_using_pio_transfers(dev))
> +			err = b43_pio_tx(dev, skb, ctl);
> +		else
> +			err = b43_dma_tx(dev, skb, ctl);
> +	}
> +
> +	read_unlock_irqrestore(&wl->tx_lock, flags);
> +
>  	if (unlikely(err))
>  		return NETDEV_TX_BUSY;
>  	return NETDEV_TX_OK;
>  }
>  
>  /* Locking: wl->irq_lock */
> @@ -3457,23 +3471,23 @@ static void b43_wireless_core_stop(struc
>  	spin_lock_irqsave(&wl->irq_lock, flags);
>  	dev->irq_savedstate = b43_interrupt_disable(dev, B43_IRQ_ALL);
>  	b43_read32(dev, B43_MMIO_GEN_IRQ_MASK);	/* flush */
>  	spin_unlock_irqrestore(&wl->irq_lock, flags);
>  	b43_synchronize_irq(dev);
>  
> +	write_lock_irqsave(&wl->tx_lock, flags);
>  	b43_set_status(dev, B43_STAT_INITIALIZED);
> +	write_unlock_irqrestore(&wl->tx_lock, flags);
>  
>  	b43_pio_stop(dev);
>  	mutex_unlock(&wl->mutex);
>  	/* Must unlock as it would otherwise deadlock. No races here.
>  	 * Cancel the possibly running self-rearming periodic work. */
>  	cancel_delayed_work_sync(&dev->periodic_work);
>  	mutex_lock(&wl->mutex);
>  
> -	ieee80211_stop_queues(wl->hw);	//FIXME this could cause a deadlock, as mac80211 seems buggy.
> -
>  	b43_mac_suspend(dev);
>  	free_irq(dev->dev->irq, dev);
>  	b43dbg(wl, "Wireless interface stopped\n");
>  }
>  
>  /* Locking: wl->mutex */
> @@ -4471,12 +4485,13 @@ static int b43_wireless_init(struct ssb_
>  
>  	/* Get and initialize struct b43_wl */
>  	wl = hw_to_b43_wl(hw);
>  	memset(wl, 0, sizeof(*wl));
>  	wl->hw = hw;
>  	spin_lock_init(&wl->irq_lock);
> +	rwlock_init(&wl->tx_lock);
>  	spin_lock_init(&wl->leds_lock);
>  	spin_lock_init(&wl->shm_lock);
>  	mutex_init(&wl->mutex);
>  	INIT_LIST_HEAD(&wl->devlist);
>  	INIT_WORK(&wl->qos_update_work, b43_qos_update_work);
>  	INIT_WORK(&wl->beacon_update_trigger, b43_beacon_update_trigger_work);
> 




From mb at bu3sch.de  Thu May  1 12:31:44 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 12:31:44 +0200
Subject: [PATCH stable] b43: Fix dual-PHY devices
Message-ID: <200805011231.44784.mb@bu3sch.de>

This fixes operation of dual-PHY (A/B/G) devices.
Do not anounce the A-PHY to mac80211, as that's not supported, yet.

This patch is in wireless-testing.git, commit
123082c124276b5e30b6a87ebe544a776c0ead7b

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: linux-2.6.25/drivers/net/wireless/b43/main.c
===================================================================
--- linux-2.6.25.orig/drivers/net/wireless/b43/main.c	2008-05-01 12:29:44.000000000 +0200
+++ linux-2.6.25/drivers/net/wireless/b43/main.c	2008-05-01 12:29:47.000000000 +0200
@@ -3909,12 +3909,20 @@ static int b43_wireless_core_attach(stru
 	if (dev->phy.type == B43_PHYTYPE_A) {
 		/* FIXME */
 		b43err(wl, "IEEE 802.11a devices are unsupported\n");
 		err = -EOPNOTSUPP;
 		goto err_powerdown;
 	}
+	if (1 /* disable A-PHY */) {
+		/* FIXME: For now we disable the A-PHY on multi-PHY devices. */
+		if (dev->phy.type != B43_PHYTYPE_N) {
+			have_2ghz_phy = 1;
+			have_5ghz_phy = 0;
+		}
+	}
+
 	dev->phy.gmode = have_2ghz_phy;
 	tmp = dev->phy.gmode ? B43_TMSLOW_GMODE : 0;
 	b43_wireless_core_reset(dev, tmp);
 
 	err = b43_validate_chipaccess(dev);
 	if (err)


From fgaliegue at gmail.com  Thu May  1 13:36:20 2008
From: fgaliegue at gmail.com (Francis Galiegue)
Date: Thu, 1 May 2008 13:36:20 +0200
Subject: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <1209606225.7173.15.camel@johannes.berg>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<ac542ca00804280415p2b169915u5b56832d7bd378ed@mail.gmail.com>
	<ac542ca00804281106o26a4bcd3h7ac1d66bba8ba28e@mail.gmail.com>
	<1209407773.29025.23.camel@johannes.berg>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	<1209606225.7173.15.camel@johannes.berg>
Message-ID: <ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>

2008/5/1 Johannes Berg <johannes at sipsolutions.net>:

>  >
>  > unencrypted AP --> success;
>  > [WPA] --> segfault
>
>  http://johannes.sipsolutions.net/patches/kernel/all/2008-05-01-00:32/023-mac80211-fix-debugfs-key.patch
>

Better, but not there yet... At least now it doesn't segfault.

I ran again hostapd with -d this time. Here is what I get...

----
WPA: group state machine entering state SETKEYSDONE (VLAN-ID 0)
Failed to set CTS protect in kernel driver
Failed to set Short Slot Time option in kernel driver
Could not set preamble for kernel driver
wlan0: Setup of interface done.
Wireless event: cmd=0x8b04 len=12
Wireless event: cmd=0x8b1a len=15
<NOTE: all mgmt::proberesp and "MGMT (TX" messages DROPPED from what follows>
<START>
mgmt::auth
authentication: STA=00:15:00:35:12:e0 auth_alg=0 auth_transaction=1
status_code=0 wep=0
  New STA
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: authentication OK (open system)
wlan0: STA 00:15:00:35:12:e0 MLME:
MLME-AUTHENTICATE.indication(00:15:00:35:12:e0, OPEN_SYSTEM)
wlan0: STA 00:15:00:35:12:e0 MLME: MLME-DELETEKEYS.request(00:15:00:35:12:e0)
authentication reply: STA=00:15:00:35:12:e0 auth_alg=0
auth_transaction=2 resp=0 (IE len=0)
mgmt::auth cb
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: authenticated
mgmt::assoc_req
association request: STA=00:15:00:35:12:e0 capab_info=0x411 listen_interval=10
Failed to set CTS protect in kernel driver
Failed to set Short Slot Time option in kernel driver
Could not set preamble for kernel driver
  new AID 1
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: association OK (aid 1)
mgmt::assoc_resp cb
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: associated (aid 1,
accounting session 4819A816-00000000)
wlan0: STA 00:15:00:35:12:e0 MLME: MLME-ASSOCIATE.indication(00:15:00:35:12:e0)
wlan0: STA 00:15:00:35:12:e0 MLME: MLME-DELETEKEYS.request(00:15:00:35:12:e0)
wlan0: STA 00:15:00:35:12:e0 WPA: event 1 notification
wlan0: STA 00:15:00:35:12:e0 WPA: start authentication
WPA: 00:15:00:35:12:e0 WPA_PTK entering state INITIALIZE
wlan0: STA 00:15:00:35:12:e0 IEEE 802.1X: unauthorizing port
Could not set station 00:15:00:35:12:e0 flags for kernel driver (errno=22).
WPA: 00:15:00:35:12:e0 WPA_PTK_GROUP entering state IDLE
WPA: 00:15:00:35:12:e0 WPA_PTK entering state AUTHENTICATION
WPA: 00:15:00:35:12:e0 WPA_PTK entering state AUTHENTICATION2
WPA: 00:15:00:35:12:e0 WPA_PTK entering state INITPSK
WPA: 00:15:00:35:12:e0 WPA_PTK entering state PTKSTART
wlan0: STA 00:15:00:35:12:e0 WPA: sending 1/4 msg of 4-Way Handshake
WPA: Send EAPOL(version=1 secure=0 mic=0 ack=1 install=0 pairwise=8
kde_len=0 keyidx=0 encr=0)
IEEE 802.1X: 123 bytes from 00:15:00:35:12:e0
   IEEE 802.1X: version=1 type=3 length=119
wlan0: STA 00:15:00:35:12:e0 WPA: received EAPOL-Key frame (2/4 Pairwise)
WPA: 00:15:00:35:12:e0 WPA_PTK entering state PTKCALCNEGOTIATING
WPA: PTK derivation - A1=00:0c:41:63:9f:a3 A2=00:15:00:35:12:e0
WPA: PMK - hexdump(len=32): 95 5f af d8 0c bf e2 e1 02 7e 13 2a 7b 08
bd ea 52 84 2d a0 d0 ef 10 86 91 d4 e5 8e a4 0e 7e 78
WPA: PTK - hexdump(len=64): 8a 51 b4 9b 0c 1e 4a c7 b6 c1 5d 27 c8 b3
c8 8c 82 0d 1e 97 24 d7 1b 7b 27 8b 4e 4e 3c 30 77 81 04 21 a3 0b 8e
d8 5b 7e 60 be a9 da 78 40 04 e6 17 92 34 e8 c0 5f fd c0 d7 f8 5e 4c
28 b6 e4 47
WPA: 00:15:00:35:12:e0 WPA_PTK entering state PTKCALCNEGOTIATING2
WPA: 00:15:00:35:12:e0 WPA_PTK entering state PTKINITNEGOTIATING
wlan0: STA 00:15:00:35:12:e0 WPA: sending 3/4 msg of 4-Way Handshake
WPA: Send EAPOL(version=1 secure=0 mic=1 ack=1 install=1 pairwise=8
kde_len=24 keyidx=0 encr=0)
IEEE 802.1X: 99 bytes from 00:15:00:35:12:e0
   IEEE 802.1X: version=1 type=3 length=95
wlan0: STA 00:15:00:35:12:e0 WPA: received EAPOL-Key frame (4/4 Pairwise)
WPA: 00:15:00:35:12:e0 WPA_PTK entering state PTKINITDONE
wlan0: STA 00:15:00:35:12:e0 IEEE 802.1X: authorizing port
wlan0: STA 00:15:00:35:12:e0 WPA: pairwise key handshake completed (WPA)
WPA: 00:15:00:35:12:e0 WPA_PTK_GROUP entering state REKEYNEGOTIATING
wlan0: STA 00:15:00:35:12:e0 WPA: sending 1/2 msg of Group Key Handshake
WPA: Send EAPOL(version=1 secure=1 mic=1 ack=1 install=0 pairwise=0
kde_len=32 keyidx=1 encr=1)
Plaintext EAPOL-Key Key Data - hexdump(len=32): 30 96 19 8d ca 89 da
62 6b f2 a5 c1 a6 e6 da a9 42 05 b0 ef f3 92 b7 ae 75 14 e7 1e b7 e6
37 29
IEEE 802.1X: 99 bytes from 00:15:00:35:12:e0
   IEEE 802.1X: version=1 type=3 length=95
wlan0: STA 00:15:00:35:12:e0 WPA: received EAPOL-Key frame (2/2 Group)
WPA: 00:15:00:35:12:e0 WPA_PTK_GROUP entering state REKEYESTABLISHED
wlan0: STA 00:15:00:35:12:e0 WPA: group key handshake completed (WPA)
WPA: 00:15:00:35:12:e0 WPA_PTK_GROUP entering state IDLE
mgmt::disassoc
disassocation: STA=00:15:00:35:12:e0 reason_code=1
wlan0: STA 00:15:00:35:12:e0 WPA: event 2 notification
WPA: 00:15:00:35:12:e0 WPA_PTK entering state DISCONNECTED
WPA: 00:15:00:35:12:e0 WPA_PTK entering state INITIALIZE
wlan0: STA 00:15:00:35:12:e0 IEEE 802.1X: unauthorizing port
Could not set station 00:15:00:35:12:e0 flags for kernel driver (errno=22).
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: disassociated
wlan0: STA 00:15:00:35:12:e0 MLME:
MLME-DISASSOCIATE.indication(00:15:00:35:12:e0, 1)
wlan0: STA 00:15:00:35:12:e0 MLME: MLME-DELETEKEYS.request(00:15:00:35:12:e0)
Sending deauthentication info to STA 00:15:00:35:12:e0
wlan0: STA 00:15:00:35:12:e0 IEEE 802.11: deauthenticated due to inactivity
wlan0: STA 00:15:00:35:12:e0 MLME:
MLME-DEAUTHENTICATE.indication(00:15:00:35:12:e0, 2)
wlan0: STA 00:15:00:35:12:e0 MLME: MLME-DELETEKEYS.request(00:15:00:35:12:e0)
Failed to set CTS protect in kernel driver
Failed to set Short Slot Time option in kernel driver
Could not set preamble for kernel driver
<goto START>
----

The WPA negotiation is a success but then the association suddenly
drops, for whatever reason :/


-- 
Francis Galiegue, fgaliegue at gmail.com
"It seems obvious [...] that at least some 'business intelligence'
tools invest so much intelligence on the business side that they have
nothing left for generating SQL queries" (St?phane Faroult, in "The
Art of SQL", ISBN 0-596-00894-5)


From mb at bu3sch.de  Thu May  1 16:38:15 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 16:38:15 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
Message-ID: <200805011638.15910.mb@bu3sch.de>

This patchset adds API and one user for a "weak" dma_set_mask().
Weak means that it will fallback to smaller masks in case the
DMA subsystem rejects a big mask.
Currently such rejection may happen if the driver requests a 64bit
mask on a VIA machine, for example. dma_set_mask_weak() will fallback
to 32bit, in that case, and tell the caller about it by modifying the
passed mask.

I'm not sure how we should merge this patchset.
I'd suggest we merge it all through John Linville for 2.6.27, as the
only current user of the API is the b43 wireless driver.
We could split it and push the nonwireless parts to somebody else's tree,
but I'm not sure it's worth the trouble.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 16:43:08 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 16:43:08 +0200
Subject: [PATCH 3/3] b43: Use the new weak DMA-mask API
In-Reply-To: <200805011638.15910.mb@bu3sch.de>
References: <200805011638.15910.mb@bu3sch.de>
Message-ID: <200805011643.08605.mb@bu3sch.de>

This adds a user for the new weak DMA mask API.
This removes the b43 DMA mask probe loop.

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: linux-2.6/drivers/net/wireless/b43/dma.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/b43/dma.c	2008-05-01 13:19:51.000000000 +0200
+++ linux-2.6/drivers/net/wireless/b43/dma.c	2008-05-01 14:45:52.000000000 +0200
@@ -980,37 +980,27 @@ void b43_dma_free(struct b43_wldev *dev)
 	destroy_ring(dma, tx_ring_mcast);
 }
 
+static inline unsigned int mask_to_bit(u64 dma_mask)
+{
+	return fls64(dma_mask);
+}
+
 static int b43_dma_set_mask(struct b43_wldev *dev, u64 mask)
 {
 	u64 orig_mask = mask;
-	bool fallback = 0;
 	int err;
 
-	/* Try to set the DMA mask. If it fails, try falling back to a
-	 * lower mask, as we can always also support a lower one. */
-	while (1) {
-		err = ssb_dma_set_mask(dev->dev, mask);
-		if (!err)
-			break;
-		if (mask == DMA_64BIT_MASK) {
-			mask = DMA_32BIT_MASK;
-			fallback = 1;
-			continue;
-		}
-		if (mask == DMA_32BIT_MASK) {
-			mask = DMA_30BIT_MASK;
-			fallback = 1;
-			continue;
-		}
+	err = ssb_dma_set_mask_weak(dev->dev, &mask);
+	if (err) {
 		b43err(dev->wl, "The machine/kernel does not support "
 		       "the required %u-bit DMA mask\n",
-		       (unsigned int)dma_mask_to_engine_type(orig_mask));
+		       mask_to_bit(orig_mask));
 		return -EOPNOTSUPP;
 	}
-	if (fallback) {
+	if (mask != orig_mask) {
 		b43info(dev->wl, "DMA mask fallback from %u-bit to %u-bit\n",
-			(unsigned int)dma_mask_to_engine_type(orig_mask),
-			(unsigned int)dma_mask_to_engine_type(mask));
+			mask_to_bit(orig_mask),
+			mask_to_bit(mask));
 	}
 
 	return 0;


-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 16:40:16 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 16:40:16 +0200
Subject: [PATCH 1/3] Add dma_set_mask_weak() API
In-Reply-To: <200805011638.15910.mb@bu3sch.de>
References: <200805011638.15910.mb@bu3sch.de>
Message-ID: <200805011640.17281.mb@bu3sch.de>

This adds a new DMA subsystem API call for "weak" setting
of the DMA mask.
Weak means that it will fallback to smaller masks in case the
DMA subsystem rejects a big mask.
Currently such rejection may happen if the driver requests a 64bit
mask on a VIA machine, for example. dma_set_mask_weak() will fallback
to 32bit, in that case, and tell the caller about it by modifying the
passed mask.

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: wireless-testing/drivers/base/dma-mapping.c
===================================================================
--- wireless-testing.orig/drivers/base/dma-mapping.c	2008-04-28 23:34:19.000000000 +0200
+++ wireless-testing/drivers/base/dma-mapping.c	2008-04-28 23:46:25.000000000 +0200
@@ -216,3 +216,38 @@ void dmam_release_declared_memory(struct
 EXPORT_SYMBOL(dmam_release_declared_memory);
 
 #endif
+
+/**
+ * dma_set_mask_weak - Set the DMA mask. Retry with smaller masks.
+ * @dev: Device to set the mask on.
+ * @mask: Pointer to the mask that you want to set. The function will
+ * 	modify the mask and set it to the actually used mask, in case
+ * 	it had to fall back to a smaller mask.
+ *
+ * Set the DMA mask and allow falling back to smaller masks in
+ * case of an error.
+ *
+ * RETURNS:
+ * 0 on success, -errno on failure.
+ */
+int dma_set_mask_weak(struct device *dev, u64 *mask)
+{
+	u64 m = *mask;
+	int err;
+
+	if (m < DMA_MIN_FALLBACK_MASK)
+		return -EINVAL;
+	while (1) {
+		err = dma_set_mask(dev, m);
+		if (!err)
+			break;
+		/* Did not like this one. Try a smaller one. */
+		m >>= 1;
+		if (m < DMA_MIN_FALLBACK_MASK)
+			return err;
+	}
+	*mask = m;
+
+	return 0;
+}
+EXPORT_SYMBOL(dma_set_mask_weak);
Index: wireless-testing/include/linux/dma-mapping.h
===================================================================
--- wireless-testing.orig/include/linux/dma-mapping.h	2008-04-28 23:34:19.000000000 +0200
+++ wireless-testing/include/linux/dma-mapping.h	2008-04-28 23:35:35.000000000 +0200
@@ -60,6 +60,11 @@ static inline int is_device_dma_capable(
 
 extern u64 dma_get_required_mask(struct device *dev);
 
+extern int dma_set_mask_weak(struct device *dev, u64 *mask);
+/* Smallest mask fallback used by dma_set_mask_weak(). */
+#define DMA_MIN_FALLBACK_MASK	DMA_BIT_MASK(24) /* 16 MB */
+
+
 static inline unsigned int dma_get_max_seg_size(struct device *dev)
 {
 	return dev->dma_parms ? dev->dma_parms->max_segment_size : 65536;


-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 16:41:27 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 16:41:27 +0200
Subject: [PATCH 2/3] ssb: Add weak DMA-mask API
In-Reply-To: <200805011638.15910.mb@bu3sch.de>
References: <200805011638.15910.mb@bu3sch.de>
Message-ID: <200805011641.28135.mb@bu3sch.de>

This adds a "weak" variant of ssb_dma_set_mask().

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: linux-2.6/drivers/ssb/main.c
===================================================================
--- linux-2.6.orig/drivers/ssb/main.c	2008-05-01 13:19:53.000000000 +0200
+++ linux-2.6/drivers/ssb/main.c	2008-05-01 13:47:29.000000000 +0200
@@ -1165,6 +1165,12 @@ u32 ssb_dma_translation(struct ssb_devic
 }
 EXPORT_SYMBOL(ssb_dma_translation);
 
+static void do_set_dma_mask(struct device *dma_dev, u64 mask)
+{
+	dma_dev->coherent_dma_mask = mask;
+	dma_dev->dma_mask = &dma_dev->coherent_dma_mask;
+}
+
 int ssb_dma_set_mask(struct ssb_device *ssb_dev, u64 mask)
 {
 	struct device *dma_dev = ssb_dev->dma_dev;
@@ -1173,13 +1179,26 @@ int ssb_dma_set_mask(struct ssb_device *
 	if (ssb_dev->bus->bustype == SSB_BUSTYPE_PCI)
 		return dma_set_mask(dma_dev, mask);
 #endif
-	dma_dev->coherent_dma_mask = mask;
-	dma_dev->dma_mask = &dma_dev->coherent_dma_mask;
+	do_set_dma_mask(dma_dev, mask);
 
 	return 0;
 }
 EXPORT_SYMBOL(ssb_dma_set_mask);
 
+int ssb_dma_set_mask_weak(struct ssb_device *ssb_dev, u64 *mask)
+{
+	struct device *dma_dev = ssb_dev->dma_dev;
+
+#ifdef CONFIG_SSB_PCIHOST
+	if (ssb_dev->bus->bustype == SSB_BUSTYPE_PCI)
+		return dma_set_mask_weak(dma_dev, mask);
+#endif
+	do_set_dma_mask(dma_dev, *mask);
+
+	return 0;
+}
+EXPORT_SYMBOL(ssb_dma_set_mask_weak);
+
 int ssb_bus_may_powerdown(struct ssb_bus *bus)
 {
 	struct ssb_chipcommon *cc;
Index: linux-2.6/include/linux/ssb/ssb.h
===================================================================
--- linux-2.6.orig/include/linux/ssb/ssb.h	2008-05-01 13:19:59.000000000 +0200
+++ linux-2.6/include/linux/ssb/ssb.h	2008-05-01 13:43:17.000000000 +0200
@@ -406,6 +406,7 @@ extern u32 ssb_dma_translation(struct ss
 #define SSB_DMA_TRANSLATION_SHIFT	30
 
 extern int ssb_dma_set_mask(struct ssb_device *ssb_dev, u64 mask);
+extern int ssb_dma_set_mask_weak(struct ssb_device *ssb_dev, u64 *mask);
 
 
 #ifdef CONFIG_SSB_PCIHOST

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 17:42:04 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 17:42:04 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <20080501153618.GA470@infradead.org>
References: <200805011638.15910.mb@bu3sch.de>
	<20080501153618.GA470@infradead.org>
Message-ID: <200805011742.05302.mb@bu3sch.de>

On Thursday 01 May 2008 17:36:18 Christoph Hellwig wrote:
> On Thu, May 01, 2008 at 04:38:15PM +0200, Michael Buesch wrote:
> > This patchset adds API and one user for a "weak" dma_set_mask().
> > Weak means that it will fallback to smaller masks in case the
> > DMA subsystem rejects a big mask.
> > Currently such rejection may happen if the driver requests a 64bit
> > mask on a VIA machine, for example. dma_set_mask_weak() will fallback
> > to 32bit, in that case, and tell the caller about it by modifying the
> > passed mask.
> 
> Why do we need it?  Is the call to set the 32bit mask when it fails
> a too big burden for the driver author?

Yeah. because it has to be done in every driver.
So we put the implementation into a central place, instead of
reimplementing the wheel over and over again. This way we avoid bugs,
like the "b43 broken on VIA boards" in the first place.
Currently every driver requesting a >32bit mask and not retrying with
a lower mask is broken on VIA hardware. I dunno how many of the current
drivers that are, but everybody can easily see that is not a b43-specific
problem that we should solve for b43 only.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 17:47:26 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 17:47:26 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <20080501154358.GA3318@infradead.org>
References: <200805011638.15910.mb@bu3sch.de> <200805011742.05302.mb@bu3sch.de>
	<20080501154358.GA3318@infradead.org>
Message-ID: <200805011747.27469.mb@bu3sch.de>

On Thursday 01 May 2008 17:43:58 Christoph Hellwig wrote:
> On Thu, May 01, 2008 at 05:42:04PM +0200, Michael Buesch wrote:
> > Yeah. because it has to be done in every driver.
> > So we put the implementation into a central place, instead of
> > reimplementing the wheel over and over again. This way we avoid bugs,
> > like the "b43 broken on VIA boards" in the first place.
> > Currently every driver requesting a >32bit mask and not retrying with
> > a lower mask is broken on VIA hardware. I dunno how many of the current
> > drivers that are, but everybody can easily see that is not a b43-specific
> > problem that we should solve for b43 only.
> 
> Yeah.  Personally I'd rather let set_dma_mask fall back silently,

We've discussed that and this behaviour is not acceptable, as the driver
must know about a possible fallback in case it can do 32bit DMA
more efficiently than 64bit DMA, for example.

So here we go. People rejected that approach, that I also suggested.
Here's what people want.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 18:07:25 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 18:07:25 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <20080501155826.GA11188@infradead.org>
References: <200805011638.15910.mb@bu3sch.de> <200805011747.27469.mb@bu3sch.de>
	<20080501155826.GA11188@infradead.org>
Message-ID: <200805011807.26036.mb@bu3sch.de>

On Thursday 01 May 2008 17:58:26 Christoph Hellwig wrote:
> On Thu, May 01, 2008 at 05:47:26PM +0200, Michael Buesch wrote:
> > We've discussed that and this behaviour is not acceptable, as the driver
> > must know about a possible fallback in case it can do 32bit DMA
> > more efficiently than 64bit DMA, for example.
> 
> That's what we have dma_get_required_mask() for.  See
> Documentation/DMA-API.txt.

So well. I'm still unsure about the advantage of having some opencoded
probe loop in the driver, instead of implementing it in a common place
and doing all of it with a single API call.
We can still call dma_get_required_mask() and adjust the mask to that
in dma_set_mask_weak(). That can _additionally_ be done there.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 19:11:40 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 19:11:40 +0200
Subject: [PATCH 1/3] Add dma_set_mask_weak() API
In-Reply-To: <20080501172045.35686f43@core>
References: <200805011638.15910.mb@bu3sch.de> <200805011640.17281.mb@bu3sch.de>
	<20080501172045.35686f43@core>
Message-ID: <200805011911.41388.mb@bu3sch.de>

On Thursday 01 May 2008 18:20:45 Alan Cox wrote:
> On Thu, 1 May 2008 16:40:16 +0200
> Michael Buesch <mb at bu3sch.de> wrote:
> 
> > This adds a new DMA subsystem API call for "weak" setting
> > of the DMA mask
> 
> weak is an odd term - and we use weak for things like weak symbols so it
> might be confusing. dma_request_mask() ?

Yeah, as a non-native english speaker I couldn't come up with a good
name for it. But request seems pretty good to me.


-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 19:16:06 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 19:16:06 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <200805010930.04799.jbarnes@virtuousgeek.org>
References: <200805011638.15910.mb@bu3sch.de> <200805011807.26036.mb@bu3sch.de>
	<200805010930.04799.jbarnes@virtuousgeek.org>
Message-ID: <200805011916.07340.mb@bu3sch.de>

On Thursday 01 May 2008 18:30:04 Jesse Barnes wrote:
> On Thursday, May 01, 2008 9:07 am Michael Buesch wrote:
> > On Thursday 01 May 2008 17:58:26 Christoph Hellwig wrote:
> > > On Thu, May 01, 2008 at 05:47:26PM +0200, Michael Buesch wrote:
> > > > We've discussed that and this behaviour is not acceptable, as the
> > > > driver must know about a possible fallback in case it can do 32bit DMA
> > > > more efficiently than 64bit DMA, for example.
> > >
> > > That's what we have dma_get_required_mask() for.  See
> > > Documentation/DMA-API.txt.
> >
> > So well. I'm still unsure about the advantage of having some opencoded
> > probe loop in the driver, instead of implementing it in a common place
> > and doing all of it with a single API call.
> > We can still call dma_get_required_mask() and adjust the mask to that
> > in dma_set_mask_weak(). That can _additionally_ be done there.
> 
> So I think we're agreed that we want some core function to fall back to 
> different mask values, but yeah, making it take dma_get_required_mask into 
> account would also be good.

Ok, will redo the patches with that added and the name changed.

> Most drivers just do the fallback themselves, right?

Right.

> So it makes sense to  
> just update the current code to fallback, and update drivers wanting specific 
> mask values to check afterwards.  I hate to inflict that kind of driver wide 
> update on Michael though... :)

Well, that's a lot of work and I'm not sure it's worth it.
I could live with having dma_set_mask as an API that fails on bad masks
and dma_request_mask as an API above that which retries. I think that's
just fine. Drivers can be migrated over time to the new API (or not. That
can be the driver maintainer's choice).

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 19:25:45 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 19:25:45 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <200805011022.55390.jbarnes@virtuousgeek.org>
References: <200805011638.15910.mb@bu3sch.de> <200805011916.07340.mb@bu3sch.de>
	<200805011022.55390.jbarnes@virtuousgeek.org>
Message-ID: <200805011925.46200.mb@bu3sch.de>

On Thursday 01 May 2008 19:22:55 Jesse Barnes wrote:
> On Thursday, May 01, 2008 10:16 am Michael Buesch wrote:
> > Ok, will redo the patches with that added and the name changed.
> >
> > > Most drivers just do the fallback themselves, right?
> >
> > Right.
> >
> > > So it makes sense to
> > > just update the current code to fallback, and update drivers wanting
> > > specific mask values to check afterwards.  I hate to inflict that kind of
> > > driver wide update on Michael though... :)
> >
> > Well, that's a lot of work and I'm not sure it's worth it.
> > I could live with having dma_set_mask as an API that fails on bad masks
> > and dma_request_mask as an API above that which retries. I think that's
> > just fine. Drivers can be migrated over time to the new API (or not. That
> > can be the driver maintainer's choice).
> 
> Can you also update the docs with the new call, indicating that it should 
> probably used in all but special cases?

Yeah sure. Forgot that.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu May  1 19:33:08 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 May 2008 19:33:08 +0200
Subject: [PATCH 0/3] Add API for weak DMA masks
In-Reply-To: <200805011027.36252.jbarnes@virtuousgeek.org>
References: <200805011638.15910.mb@bu3sch.de> <200805011916.07340.mb@bu3sch.de>
	<200805011027.36252.jbarnes@virtuousgeek.org>
Message-ID: <200805011933.09061.mb@bu3sch.de>

On Thursday 01 May 2008 19:27:35 Jesse Barnes wrote:
> On Thursday, May 01, 2008 10:16 am Michael Buesch wrote:
> > > So it makes sense to
> > > just update the current code to fallback, and update drivers wanting
> > > specific mask values to check afterwards.  I hate to inflict that kind of
> > > driver wide update on Michael though... :)
> >
> > Well, that's a lot of work and I'm not sure it's worth it.
> > I could live with having dma_set_mask as an API that fails on bad masks
> > and dma_request_mask as an API above that which retries. I think that's
> > just fine. Drivers can be migrated over time to the new API (or not. That
> > can be the driver maintainer's choice).
> 
> Oh and for dma_set_mask specifically I don't see that many callers, so 
> updating the tree appears doable (meye, aic7xxx, lasai700, qla2xxx, 
> sni_53c710, ssb & ehci in my quick look). pci_set_dma_mask otoh is used in 
> lots more places (and iirc some platforms implement pci_set_dma_mask in terms 
> of dma_set_mask, so small updates would be needed there).

I was thinking about also adding a "request" call to the PCI DMA API,
as we have the same retry-issue there.

-- 
Greetings Michael.


From abel00z at users.berlios.de  Thu May  1 19:40:26 2008
From: abel00z at users.berlios.de (Abel Camarillo Ojeda)
Date: Thu, 1 May 2008 12:40:26 -0500
Subject: b43 generates an excesive amount of log
In-Reply-To: <1209470257.3960.27.camel@johannes.berg>
References: <b5d093e0804290006i7a6a7337ifd92191f4dbbe013@mail.gmail.com>
	<200804291037.59759.mb@bu3sch.de>
	<1209470257.3960.27.camel@johannes.berg>
Message-ID: <b5d093e0805011040y7e3f559bo993963334cd52b4f@mail.gmail.com>

Yea it was mac80211 debugging.

I disabled it at the Kconfig and rebuild the module.

Very thanks.

On Tue, Apr 29, 2008 at 6:57 AM, Johannes Berg
<johannes at sipsolutions.net> wrote:
>
>  > > Apr 29 01:13:17 lambda kernel: b 9c 13 c7 42 a5 ca 5c 3f e5 f0 e8 98
>  > > 81 10 d0 ed 6b
>
>
> > That is certainly not coming from b43.
>  > Try to turn off mac80211 debugging.
>
>  Yeah that looks like verbose TX debugging. Uhum. Do you read Kconfig
>  entries of things you enable?
>
>  johannes
>
> _______________________________________________
>  Bcm43xx-dev mailing list
>  Bcm43xx-dev at lists.berlios.de
>  https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>



-- 
atte: ??z
Registered Linux User #393616

From linville at tuxdriver.com  Thu May  1 22:02:31 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Thu, 1 May 2008 16:02:31 -0400
Subject: [PATCH] b43: Fix some TX/RX locking issues
In-Reply-To: <200805011208.10533.mb@bu3sch.de>
References: <200804251929.09301.mb@bu3sch.de> <200805011208.10533.mb@bu3sch.de>
Message-ID: <20080501200231.GA21387@tuxdriver.com>

On Thu, May 01, 2008 at 12:08:10PM +0200, Michael Buesch wrote:
> John, did you drop this patch? I can't see it in git and your latest push,
> while a patch submitted later is in there.

No, I'm sorry.  I fat-fingered my patches.  I've still got it, and
it will go in the next round.

John

> On Friday 25 April 2008, Michael Buesch wrote:
> > This fixes some TX/RX related locking issues.
> > With this patch applied, some of the PHY transmission errors are fixed.
> > 
> > Signed-off-by: Michael Buesch <mb at bu3sch.de>
> > 
> > ---
> > 
> > John, this is for 2.6.26.
-- 
John W. Linville
linville at tuxdriver.com


From fgaliegue at gmail.com  Thu May  1 23:05:33 2008
From: fgaliegue at gmail.com (Francis Galiegue)
Date: Thu, 1 May 2008 23:05:33 +0200
Subject: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<ac542ca00804281106o26a4bcd3h7ac1d66bba8ba28e@mail.gmail.com>
	<1209407773.29025.23.camel@johannes.berg>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	<1209606225.7173.15.camel@johannes.berg>
	<ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>
Message-ID: <ac542ca00805011405i693e033dx24912f1c4bbfd947@mail.gmail.com>

2008/5/1 Francis Galiegue <fgaliegue at gmail.com>:
> 2008/5/1 Johannes Berg <johannes at sipsolutions.net>:
>
>  >  >
>  >  > unencrypted AP --> success;
>  >  > [WPA] --> segfault
>
> >
>  >  http://johannes.sipsolutions.net/patches/kernel/all/2008-05-01-00:32/023-mac80211-fix-debugfs-key.patch
>  >
>
>  Better, but not there yet... At least now it doesn't segfault.
>
>  I ran again hostapd with -d this time. Here is what I get...
>
[...]

Well now it runs!

It appears that hostapd definitely does NOT like bridge interfaces.
There is a bridge_interface option though, but the config file says it
has no effect apart from using it with the ath and hostap drivers...

-- 
Francis Galiegue, fgaliegue at gmail.com
"It seems obvious [...] that at least some 'business intelligence'
tools invest so much intelligence on the business side that they have
nothing left for generating SQL queries" (St?phane Faroult, in "The
Art of SQL", ISBN 0-596-00894-5)


From netrolller.3d at gmail.com  Thu May  1 23:54:57 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Thu, 1 May 2008 23:54:57 +0200
Subject: Fwd: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <69e28c910805011428h636ef3d3g43055f3d92e0dbe4@mail.gmail.com>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	<1209606225.7173.15.camel@johannes.berg>
	<ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>
	<ac542ca00805011405i693e033dx24912f1c4bbfd947@mail.gmail.com>
	<69e28c910805011428h636ef3d3g43055f3d92e0dbe4@mail.gmail.com>
Message-ID: <69e28c910805011454g6abca4c8hd55817ecaf24f663@mail.gmail.com>

On Thu, May 1, 2008 at 11:05 PM, Francis Galiegue <fgaliegue at gmail.com> wrote:
 > 2008/5/1 Francis Galiegue <fgaliegue at gmail.com>:
 >
 > > 2008/5/1 Johannes Berg <johannes at sipsolutions.net>:
 > >
 > >  >  >
 > >  >  > unencrypted AP --> success;
 > >  >  > [WPA] --> segfault
 > >
 > > >
 > >  >  http://johannes.sipsolutions.net/patches/kernel/all/2008-05-01-00:32/023-mac80211-fix-debugfs-key.patch
 > >  >
 > >
 > >  Better, but not there yet... At least now it doesn't segfault.
 > >
 > >  I ran again hostapd with -d this time. Here is what I get...
 > >
 > [...]
 >
 > Well now it runs!
 >
 > It appears that hostapd definitely does NOT like bridge interfaces.
 > There is a bridge_interface option though, but the config file says it
 > has no effect apart from using it with the ath and hostap drivers...
 >
 >
 >
 >
 > --
 > Francis Galiegue, fgaliegue at gmail.com
 > "It seems obvious [...] that at least some 'business intelligence'
 > tools invest so much intelligence on the business side that they have
 > nothing left for generating SQL queries" (St?phane Faroult, in "The
 > Art of SQL", ISBN 0-596-00894-5)
 > _______________________________________________
 > Bcm43xx-dev mailing list
 > Bcm43xx-dev at lists.berlios.de
 > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
 >

 Possibly it would also be required for nl80211 for proper bridge
 interface handling. But that needs to be implemented in
 {mac|cfg|nl}80211 first. (Maybe that's why AP mode is not enabled by
 default...)
(This message is a resend of a mail for which I forgot to CC the list.)



 --
 Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From francesco.gringoli at ing.unibs.it  Fri May  2 01:55:02 2008
From: francesco.gringoli at ing.unibs.it (Francesco Gringoli)
Date: Fri, 2 May 2008 01:55:02 +0200
Subject: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <ac542ca00805011405i693e033dx24912f1c4bbfd947@mail.gmail.com>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<ac542ca00804281106o26a4bcd3h7ac1d66bba8ba28e@mail.gmail.com>
	<1209407773.29025.23.camel@johannes.berg>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	<1209606225.7173.15.camel@johannes.berg>
	<ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>
	<ac542ca00805011405i693e033dx24912f1c4bbfd947@mail.gmail.com>
Message-ID: <94ADC07F-0649-411E-B370-17C1826E4750@ing.unibs.it>

Just a question (for Francis): how does the AP work? Have you tried  
very stressing tests with traffic crossing the AP? We do have problems  
when the channel is saturated, it seems that the BCM device acting as  
AP stops sending beacons and the BSS goes down, we need to reconfigure  
everything when this happens (I mean, stop and restart hostapd and  
reset ifaces on STAs). The configuration we are trying is built  
exclusively on BCM+b43 devices running wireless git, one is configured  
as AP using the patch from Johannes Berg.

I remember a post (from Johannes) where he stated that there are still  
"problems with beaconing". Is this still true?

Regards,
FG

On May 1, 2008, at 11:05 PM, Francis Galiegue wrote:

> 2008/5/1 Francis Galiegue <fgaliegue at gmail.com>:
>> 2008/5/1 Johannes Berg <johannes at sipsolutions.net>:
>>
>>>>
>>>> unencrypted AP --> success;
>>>> [WPA] --> segfault
>>
>>>
>>> http://johannes.sipsolutions.net/patches/kernel/all/2008-05-01-00:32/023-mac80211-fix-debugfs-key.patch
>>>
>>
>> Better, but not there yet... At least now it doesn't segfault.
>>
>> I ran again hostapd with -d this time. Here is what I get...
>>
> [...]
>
> Well now it runs!
>
> It appears that hostapd definitely does NOT like bridge interfaces.
> There is a bridge_interface option though, but the config file says it
> has no effect apart from using it with the ath and hostap drivers...
>
> -- 
> Francis Galiegue, fgaliegue at gmail.com
> "It seems obvious [...] that at least some 'business intelligence'
> tools invest so much intelligence on the business side that they have
> nothing left for generating SQL queries" (St?phane Faroult, in "The
> Art of SQL", ISBN 0-596-00894-5)
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev



From fgaliegue at gmail.com  Fri May  2 09:17:35 2008
From: fgaliegue at gmail.com (Francis Galiegue)
Date: Fri, 2 May 2008 09:17:35 +0200
Subject: BCM4308 rev 3 owner,
	willing to help (want to make an access point)
In-Reply-To: <94ADC07F-0649-411E-B370-17C1826E4750@ing.unibs.it>
References: <ac542ca00804280250t5661248v8b519ea8f2d1a762@mail.gmail.com>
	<ac542ca00804281155n32eae696m8021c0276a68fa5@mail.gmail.com>
	<ac542ca00804281240g1b92b1b9q6379077b5c8a220a@mail.gmail.com>
	<69e28c910804281256n2b4d1d2i2d4979da0b4a65b8@mail.gmail.com>
	<ac542ca00804290255j101b9c30q440982aa39bfada3@mail.gmail.com>
	<ac542ca00804301801w6d637a34t979faef9214c6ed5@mail.gmail.com>
	<1209606225.7173.15.camel@johannes.berg>
	<ac542ca00805010436r39003330ge566261568016769@mail.gmail.com>
	<ac542ca00805011405i693e033dx24912f1c4bbfd947@mail.gmail.com>
	<94ADC07F-0649-411E-B370-17C1826E4750@ing.unibs.it>
Message-ID: <ac542ca00805020017t1d599e8bla8b63b4318b16d17@mail.gmail.com>

2008/5/2 Francesco Gringoli <francesco.gringoli at ing.unibs.it>:
> Just a question (for Francis): how does the AP work? Have you tried very
> stressing tests with traffic crossing the AP?

The AP works fine for now. When it has just started up, though, the
first association sometimes drops immediately and has to be redone.
Not sure whether this bug is related to the b43 driver or hostapd.

I haven't tried stress testing via the AP though, since I only have
one client for now. A second is to come later today. What I've tried
is, from the client:

dd if=/dev/zero |ssh the.ap cat '>'/dev/null

for a good hour. The AP didn't seem to mind. I even did casual
Internet browsing while doing this and it went fine (no interactivity
problems).

When I have the second client online, I'll try this command from the
first client to the second.

> We do have problems when the
> channel is saturated, it seems that the BCM device acting as AP stops
> sending beacons and the BSS goes down, we need to reconfigure everything
> when this happens (I mean, stop and restart hostapd and reset ifaces on
> STAs). The configuration we are trying is built exclusively on BCM+b43
> devices running wireless git, one is configured as AP using the patch from
> Johannes Berg.
>

Not the case here: the first client uses ipw2200, the second one will
have a Netgear WG311 v2, (acx111 chipset). Both clients run vanilla
Ubuntu 8.04, I didn't even change the kernel and I don't plan to,
either (unless this can be of some interest to you).

>  I remember a post (from Johannes) where he stated that there are still
> "problems with beaconing". Is this still true?
>

Honestly, I have no idea. What should I look for in the logs? I run
the b43 driver in debug mode.

Have fun,
-- 
Francis Galiegue, fgaliegue at gmail.com
"It seems obvious [...] that at least some 'business intelligence'
tools invest so much intelligence on the business side that they have
nothing left for generating SQL queries" (St?phane Faroult, in "The
Art of SQL", ISBN 0-596-00894-5)


From mb at bu3sch.de  Fri May  2 12:19:57 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 2 May 2008 12:19:57 +0200
Subject: [PATCH stable] b43: Fix some TX/RX locking issues
Message-ID: <200805021219.58153.mb@bu3sch.de>

This fixes some TX/RX related locking issues.
With this patch applied, some of the PHY transmission errors are fixed.

This patch is in wireless-testing.git, commit
c83d30b31aebdf652f78f4f6898959e44fd67ca3

Signed-off-by: Michael Buesch <mb at bu3sch.de>


Index: linux-2.6.25/drivers/net/wireless/b43/b43.h
===================================================================
--- linux-2.6.25.orig/drivers/net/wireless/b43/b43.h	2008-05-01 12:29:34.000000000 +0200
+++ linux-2.6.25/drivers/net/wireless/b43/b43.h	2008-05-01 12:29:51.000000000 +0200
@@ -625,12 +625,16 @@ struct b43_wl {
 	struct b43_wldev *current_dev;
 	/* Pointer to the ieee80211 hardware data structure */
 	struct ieee80211_hw *hw;
 
 	struct mutex mutex;
 	spinlock_t irq_lock;
+	/* R/W lock for data transmission.
+	 * Transmissions on 2+ queues can run concurrently, but somebody else
+	 * might sync with TX by write_lock_irqsave()'ing. */
+	rwlock_t tx_lock;
 	/* Lock for LEDs access. */
 	spinlock_t leds_lock;
 	/* Lock for SHM access. */
 	spinlock_t shm_lock;
 
 	/* We can only have one operating interface (802.11 core)
Index: linux-2.6.25/drivers/net/wireless/b43/main.c
===================================================================
--- linux-2.6.25.orig/drivers/net/wireless/b43/main.c	2008-05-01 12:29:47.000000000 +0200
+++ linux-2.6.25/drivers/net/wireless/b43/main.c	2008-05-01 12:29:51.000000000 +0200
@@ -619,12 +619,13 @@ static void b43_synchronize_irq(struct b
 
 /* DummyTransmission function, as documented on
  * http://bcm-specs.sipsolutions.net/DummyTransmission
  */
 void b43_dummy_transmission(struct b43_wldev *dev)
 {
+	struct b43_wl *wl = dev->wl;
 	struct b43_phy *phy = &dev->phy;
 	unsigned int i, max_loop;
 	u16 value;
 	u32 buffer[5] = {
 		0x00000000,
 		0x00D40000,
@@ -645,12 +646,15 @@ void b43_dummy_transmission(struct b43_w
 		break;
 	default:
 		B43_WARN_ON(1);
 		return;
 	}
 
+	spin_lock_irq(&wl->irq_lock);
+	write_lock(&wl->tx_lock);
+
 	for (i = 0; i < 5; i++)
 		b43_ram_write(dev, i * 4, buffer[i]);
 
 	/* Commit writes */
 	b43_read32(dev, B43_MMIO_MACCTL);
 
@@ -685,12 +689,15 @@ void b43_dummy_transmission(struct b43_w
 		if (!(value & 0x0100))
 			break;
 		udelay(10);
 	}
 	if (phy->radio_ver == 0x2050 && phy->radio_rev <= 0x5)
 		b43_radio_write16(dev, 0x0051, 0x0037);
+
+	write_unlock(&wl->tx_lock);
+	spin_unlock_irq(&wl->irq_lock);
 }
 
 static void key_write(struct b43_wldev *dev,
 		      u8 index, u8 algorithm, const u8 * key)
 {
 	unsigned int i;
@@ -2589,21 +2596,27 @@ static int b43_rng_init(struct b43_wl *w
 static int b43_op_tx(struct ieee80211_hw *hw,
 		     struct sk_buff *skb,
 		     struct ieee80211_tx_control *ctl)
 {
 	struct b43_wl *wl = hw_to_b43_wl(hw);
 	struct b43_wldev *dev = wl->current_dev;
-	int err = -ENODEV;
+	unsigned long flags;
+	int err;
 
 	if (unlikely(!dev))
-		goto out;
-	if (unlikely(b43_status(dev) < B43_STAT_STARTED))
-		goto out;
-	/* DMA-TX is done without a global lock. */
-	err = b43_dma_tx(dev, skb, ctl);
-out:
+		return NETDEV_TX_BUSY;
+
+	/* Transmissions on seperate queues can run concurrently. */
+	read_lock_irqsave(&wl->tx_lock, flags);
+
+	err = -ENODEV;
+	if (likely(b43_status(dev) >= B43_STAT_STARTED))
+		err = b43_dma_tx(dev, skb, ctl);
+
+	read_unlock_irqrestore(&wl->tx_lock, flags);
+
 	if (unlikely(err))
 		return NETDEV_TX_BUSY;
 	return NETDEV_TX_OK;
 }
 
 static int b43_op_conf_tx(struct ieee80211_hw *hw,
@@ -3106,22 +3119,22 @@ static void b43_wireless_core_stop(struc
 	spin_lock_irqsave(&wl->irq_lock, flags);
 	dev->irq_savedstate = b43_interrupt_disable(dev, B43_IRQ_ALL);
 	b43_read32(dev, B43_MMIO_GEN_IRQ_MASK);	/* flush */
 	spin_unlock_irqrestore(&wl->irq_lock, flags);
 	b43_synchronize_irq(dev);
 
+	write_lock_irqsave(&wl->tx_lock, flags);
 	b43_set_status(dev, B43_STAT_INITIALIZED);
+	write_unlock_irqrestore(&wl->tx_lock, flags);
 
 	mutex_unlock(&wl->mutex);
 	/* Must unlock as it would otherwise deadlock. No races here.
 	 * Cancel the possibly running self-rearming periodic work. */
 	cancel_delayed_work_sync(&dev->periodic_work);
 	mutex_lock(&wl->mutex);
 
-	ieee80211_stop_queues(wl->hw);	//FIXME this could cause a deadlock, as mac80211 seems buggy.
-
 	b43_mac_suspend(dev);
 	free_irq(dev->dev->irq, dev);
 	b43dbg(wl, "Wireless interface stopped\n");
 }
 
 /* Locking: wl->mutex */
@@ -4081,12 +4094,13 @@ static int b43_wireless_init(struct ssb_
 
 	/* Get and initialize struct b43_wl */
 	wl = hw_to_b43_wl(hw);
 	memset(wl, 0, sizeof(*wl));
 	wl->hw = hw;
 	spin_lock_init(&wl->irq_lock);
+	rwlock_init(&wl->tx_lock);
 	spin_lock_init(&wl->leds_lock);
 	spin_lock_init(&wl->shm_lock);
 	mutex_init(&wl->mutex);
 	INIT_LIST_HEAD(&wl->devlist);
 
 	ssb_set_devtypedata(dev, wl);


From racook03 at gmail.com  Sat May  3 22:59:25 2008
From: racook03 at gmail.com (Bob)
Date: Sat, 03 May 2008 13:59:25 -0700
Subject: (no subject)
Message-ID: <481CD22D.5060405@gmail.com>




From myheadblewoff at hotmail.com  Tue May  6 16:49:59 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Wed, 7 May 2008 00:49:59 +1000
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
Message-ID: <BAY107-W21E0339C948C32991D41A7A0D60@phx.gbl>


Greets,

             Apologies for previous noise about 2.6.24 ooopsing.  It wasn't relevant..

As queried, I grabbed the (then) latest wireless-testing tree, and that compiled &
loaded modules without the noted errors. The asus card worked, although in this
case the rx/tx LED remains off the entire time. The performance was a bit hap-
hazard, and dmesg would contain passages like ;

May  5 19:31:39 sfs64 kernel: b43-phy0 ERROR: MAC suspend failed
May  5 20:58:44 sfs64 kernel: b43-phy0 ERROR: MAC suspend failed
May  5 21:18:57 sfs64 kernel: wlan0: No ProbeResp from current AP 00:18:4d:2c:57:5e - assume out of range

...and most of the time I found I had to manually reassociate with the AP using
iwconfig to re-establish the link. Typically what I'll try to do to test the link, is
use mythtv to stream hdtv content across it -- this simply would not happen,
and if it could be got running the dropped packet count made viewing the
stream most annoying. No file transfers ever seemed corrupted, just real time
streaming was so affected.

As of today May 06 and an update of the wireless-testing tree, the new
kernel build seems to be working much better, and dmesg chatter has stopped
altogether as per above. Nor does the link association drop-out any more as
per above. Thruput is much improved, and..eg; mythtv streaming now almost
works perfectly - there's still a replay 'stutter' I have to get to the bottom of
that coincides with sporadic packet drop, however things are -much- better
than previously experienced here. For the record...;

ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)
ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)
ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)
ssb: SPROM revision 2 detected.
ssb: Sonics Silicon Backplane found on PCI device 0000:01:07.0

b43-phy0: Broadcom 4318 WLAN found
b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7
b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
phy0: Selected rate control algorithm 'pid'
Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]

b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy0 debug: Chip initialized
b43-phy0 debug: 32-bit DMA initialized
b43-phy0 debug: Wireless interface started
b43-phy0 debug: Adding Interface type 2
b43-phy0 debug: Using hardware based encryption for keyidx: 0, mac: ff:ff:ff:ff:ff:ff
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:18:4d:2c:57:5e
ADDRCONF(NETDEV_UP): wlan0: link is not ready
wlan0: RX authentication from 00:18:4d:2c:57:5e (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:18:4d:2c:57:5e
wlan0: RX AssocResp from 00:18:4d:2c:57:5e (capab=0x411 status=0 aid=1)
wlan0: associated
ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
wlan0: switched to short barker preamble (BSSID=00:18:4d:2c:57:5e)
wlan0: no IPv6 routers present

This is just using WEP and with kernel 2.6.25wl IOMMU=on. This level of
debug has been otherwise quiet since init...20hours ago. (previously I'd
become used to the above error occurring every 2-3hours or so). I should
add I haven't seen this happening on the 32bit box at all (I haven't yet
upgraded it's tree to current 'cos it hasn't demonstrated the same problem).


I'm a tad confused about the rx/tx LED behaviour - although I do understand
what was previously said regarding this. My confusion stems from the fact
that b43 & 2.6.24 on 32bit with the asus 138gv2 card flashed with the sprom
image Stefanik provided, got the card working initially - it also got the rx/tx
LED working 'as it should'. Now...stupid me thought this would merely be a
case of looking at the sprom values between the two different sprom images,
to deduce what the values should be...however, if we're talking about these bits here -;

SPROM(0x64, LED 0 behaviour) = 0xFF
SPROM(0x65, LED 1 behaviour) = 0xFF
SPROM(0x66, LED 2 behaviour) = 0xFF
SPROM(0x67, LED 3 behaviour) = 0xFF

....then they're actually the -same- in both sprom image varients.

Apparently there's more than just these bits in the sprom controlling the LED
behaviour? Does anyone know what that might be?


   Kind Regards,

                     Donald








________________________________
> Date: Fri, 18 Apr 2008 18:17:23 +0200
> From: netrolller.3d at gmail.com
> To: mb at bu3sch.de
> Subject: Re: ASUS WL-138G v2 working with different sprom values
> CC: johannes at sipsolutions.net; myheadblewoff at hotmail.com; bcm43xx-dev at lists.berlios.de
>
> According to the README of the Vista driver, the card supports Afterburner, but not SpeedBooster. SpeedBooster is only supported by WL-138gE. However, the page on asus.com about the card no longer talks about Afterburner support (it did, previously). So, the right overrides are 0x0048 for 14E4:4318:1043:100F, and 0x0248 for the WL-138gE version (14E4:4318:1043:120F if I remember correctly). (This message is a repost because I forgot to CC the list, as usual.)
>
> On Fri, Apr 18, 2008 at 6:00 PM, Michael Buesch <mb at bu3sch.de> wrote:
> On Friday 18 April 2008 17:51:29 Stefanik G?bor wrote:
>> Bisection complete!
>> After testing numerous settings for BoardFlags, I found that the only ones
>> to have a benefical effect on the card is 0x4049/0x4249 and 0x0048/0x0248,
>> which differs from the original 0x0049 only in the BFL_BTCMOD bit, which is
>> 0 by default, but 1 in this configuration. Not only that, setting BoardFlags
>> to 0x4049 and leaving everything else as is in the original Asus SPROM fixes
>> BOTH the "No TX" and the "ping time cycle" bugs! Even
>> monitoring/packetspamming while operating works perfectly. The setting
>> 0x4249 produces the same (perfectly-working) result, only with Afterburner
>> marked as supported. (Not sure if it actually gets enabled, though.) Setting
>
> The afterburner bit is not used in the driver.
>
>> BFL_FEM to 1 (0x4849 or 0x4A49) introduces the "ping cycle" bug, most likely
>> because the card doesn't actually support the Front-End Module. BFL_HGPA=1
>> (0x6049/0x6249) causes ping packet loss /duplicate count to increase
>> somewhat, likely because the card doesn't have a high-gain PA. 0x0048 and
>> 0x0248 also work fine, although this setting disables Bluetooth coexistence
>> (BFL_BTCOEXIST).
>
> As the card doesn't have a BT chip, this is the correct thing to do.
>
>> So, it looks like BoardFlags was intended to be 0x4249, but
>
> I'm not too sure on the afterburner bit. The packaging box of my card
> does not tell anything about supported rates beyond 54MBit. So it most
> likely does not support afterburner.
>
>> Asus incorrectly sets it to 0x0049, which completely breaks transmission in
>> b43.
>>
>
>> "0x0001: BFL_BTCOEXIST: Board implements Bluetooth coexistance[sic]". I
>> don't know if "coexistance" is a misspelling or if it's the correct spelling
>> in British, but if it's unintended, then it should be fixed. (Just
>> nit-picking, sorry.)
>
> That bit is most likey what is actually the wrong one.
>
> --
> Greetings Michael.
>
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)

_________________________________________________________________
Search for local singles online @ Lavalife - Click here
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Flavalife9%2Eninemsn%2Ecom%2Eau%2Fclickthru%2Fclickthru%2Eact%3Fid%3Dninemsn%26context%3Dan99%26locale%3Den%5FAU%26a%3D30290&_t=764581033&_r=email_taglines_Search_OCT07&_m=EXT

From Larry.Finger at lwfinger.net  Tue May  6 21:05:17 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 May 2008 14:05:17 -0500
Subject: V2: A workaround for b43 trouble with Ubuntu 8.04
Message-ID: <4820ABED.6000207@lwfinger.net>

This is the second version. I got a directory wrong in the first one.

I have been able to duplicate the problems that each of you has with a
PCI-based BCM43xx card, where the card worked in Gutsy Gibbon using bcm43xx,
but can only receive in Hardy Heron using driver b43. I still don't have the
"final" fix, but I have a work-around that will let you use the card now.

1. Edit /etc/modprobe.d/blacklist and find the line that mentions bcm43xx.
Comment it out by putting a # at the beginning.

2. Underneath the above line, add a new line containing ssb, which will
prevent the loading of b43. If you have a b44 ethernet device, its module
will have to be loaded manually once this change is made.

3. Install the bcm43xx firmware as described at
http://wireless.kernel.org/en/users/Drivers/b43#firmwareinstallation, or get
it from the Ubuntu site. I haven't bothered to look up the reference for
that. Of course, if you used bcm43xx with Gutsy Gibbon and upgraded, the
firmware may still be installed.

If this doesn't work, please let me know.

Larry





From netrolller.3d at gmail.com  Tue May  6 21:23:14 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 6 May 2008 21:23:14 +0200
Subject: V2: A workaround for b43 trouble with Ubuntu 8.04
In-Reply-To: <4820ABED.6000207@lwfinger.net>
References: <4820ABED.6000207@lwfinger.net>
Message-ID: <69e28c910805061223i2f6f2ffdr1a6bbcdce6fba421@mail.gmail.com>

On Tue, May 6, 2008 at 9:05 PM, Larry Finger <Larry.Finger at lwfinger.net>
wrote:

> This is the second version. I got a directory wrong in the first one.
>
> I have been able to duplicate the problems that each of you has with a
> PCI-based BCM43xx card, where the card worked in Gutsy Gibbon using
> bcm43xx,
> but can only receive in Hardy Heron using driver b43.


Hmm, that looks like another bluetooth coexistence boardflags bug... did it
happen on a WL-138G V2? Maybe we should send a 2.6.24-ified version of the
b43 boardflags patch to Ubuntu.

I still don't have the
> "final" fix, but I have a work-around that will let you use the card now.
>
> 1. Edit /etc/modprobe.d/blacklist and find the line that mentions bcm43xx.
> Comment it out by putting a # at the beginning.
>
> 2. Underneath the above line, add a new line containing ssb, which will
> prevent the loading of b43. If you have a b44 ethernet device, its module
> will have to be loaded manually once this change is made.
>
> 3. Install the bcm43xx firmware as described at
> http://wireless.kernel.org/en/users/Drivers/b43#firmwareinstallation, or
> get
> it from the Ubuntu site. I haven't bothered to look up the reference for
> that. Of course, if you used bcm43xx with Gutsy Gibbon and upgraded, the
> firmware may still be installed.
>
> If this doesn't work, please let me know.
>
> Larry
>
>
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080506/4fbaff97/attachment.html>

From Larry.Finger at lwfinger.net  Tue May  6 22:30:12 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 May 2008 15:30:12 -0500
Subject: V2: A workaround for b43 trouble with Ubuntu 8.04
In-Reply-To: <69e28c910805061223i2f6f2ffdr1a6bbcdce6fba421@mail.gmail.com>
References: <4820ABED.6000207@lwfinger.net>
	<69e28c910805061223i2f6f2ffdr1a6bbcdce6fba421@mail.gmail.com>
Message-ID: <4820BFD4.1050302@lwfinger.net>

Stefanik G?bor wrote:
> On Tue, May 6, 2008 at 9:05 PM, Larry Finger <Larry.Finger at lwfinger.net 
> <mailto:Larry.Finger at lwfinger.net>> wrote:
> 
>     This is the second version. I got a directory wrong in the first one.
> 
>     I have been able to duplicate the problems that each of you has with a
>     PCI-based BCM43xx card, where the card worked in Gutsy Gibbon using
>     bcm43xx,
>     but can only receive in Hardy Heron using driver b43.
> 
> 
> Hmm, that looks like another bluetooth coexistence boardflags bug... did 
> it happen on a WL-138G V2? Maybe we should send a 2.6.24-ified version 
> of the b43 boardflags patch to Ubuntu.

No it was not that problem. It was on a WL-138G V2 card, but I had changed 
the SPROM to get rid of the bluetooth coexistence bit. However, Ubuntu should 
probably get that patch.

It gets curiouser and curiouser. I downloaded the Ubuntu source last night 
and rebuilt their kernel today. When I installed the one that I had just 
built and rebooted, the card worked OK with b43. I then got notice that 
Ubuntu had a new kernel to be downloaded. Same version as I had just built - 
2.6.24-16-generic. After installing and rebooting, then it worked OK. It 
seems that the kernel source has been altered so as to fix this problem. I 
need to see if I can find out what changed.

Larry



From Larry.Finger at lwfinger.net  Wed May  7 05:33:52 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 May 2008 22:33:52 -0500
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <BAY107-W21E0339C948C32991D41A7A0D60@phx.gbl>
References: <BAY107-W21E0339C948C32991D41A7A0D60@phx.gbl>
Message-ID: <48212320.1020708@lwfinger.net>

kala mazoo wrote:
> Greets,
> 
>              Apologies for previous noise about 2.6.24 ooopsing.  It wasn't relevant..
> 
> As queried, I grabbed the (then) latest wireless-testing tree, and that compiled &
> loaded modules without the noted errors. The asus card worked, although in this
> case the rx/tx LED remains off the entire time. The performance was a bit hap-
> hazard, and dmesg would contain passages like ;
> 
> May  5 19:31:39 sfs64 kernel: b43-phy0 ERROR: MAC suspend failed
> May  5 20:58:44 sfs64 kernel: b43-phy0 ERROR: MAC suspend failed
> May  5 21:18:57 sfs64 kernel: wlan0: No ProbeResp from current AP 00:18:4d:2c:57:5e - assume out of range
> 
> ...and most of the time I found I had to manually reassociate with the AP using
> iwconfig to re-establish the link. Typically what I'll try to do to test the link, is
> use mythtv to stream hdtv content across it -- this simply would not happen,
> and if it could be got running the dropped packet count made viewing the
> stream most annoying. No file transfers ever seemed corrupted, just real time
> streaming was so affected.
> 
> As of today May 06 and an update of the wireless-testing tree, the new
> kernel build seems to be working much better, and dmesg chatter has stopped
> altogether as per above. Nor does the link association drop-out any more as
> per above. Thruput is much improved, and..eg; mythtv streaming now almost
> works perfectly - there's still a replay 'stutter' I have to get to the bottom of
> that coincides with sporadic packet drop, however things are -much- better
> than previously experienced here. For the record...;
> 
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)
> ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)
> ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)
> ssb: SPROM revision 2 detected.
> ssb: Sonics Silicon Backplane found on PCI device 0000:01:07.0
> 
> b43-phy0: Broadcom 4318 WLAN found
> b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7
> b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 8
> phy0: Selected rate control algorithm 'pid'
> Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
> 
> b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
> b43-phy0 debug: Chip initialized
> b43-phy0 debug: 32-bit DMA initialized
> b43-phy0 debug: Wireless interface started
> b43-phy0 debug: Adding Interface type 2
> b43-phy0 debug: Using hardware based encryption for keyidx: 0, mac: ff:ff:ff:ff:ff:ff
> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:18:4d:2c:57:5e
> ADDRCONF(NETDEV_UP): wlan0: link is not ready
> wlan0: RX authentication from 00:18:4d:2c:57:5e (alg=0 transaction=2 status=0)
> wlan0: authenticated
> wlan0: associate with AP 00:18:4d:2c:57:5e
> wlan0: RX AssocResp from 00:18:4d:2c:57:5e (capab=0x411 status=0 aid=1)
> wlan0: associated
> ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
> wlan0: switched to short barker preamble (BSSID=00:18:4d:2c:57:5e)
> wlan0: no IPv6 routers present
> 
> This is just using WEP and with kernel 2.6.25wl IOMMU=on. This level of
> debug has been otherwise quiet since init...20hours ago. (previously I'd
> become used to the above error occurring every 2-3hours or so). I should
> add I haven't seen this happening on the 32bit box at all (I haven't yet
> upgraded it's tree to current 'cos it hasn't demonstrated the same problem).
> 
> 
> I'm a tad confused about the rx/tx LED behaviour - although I do understand
> what was previously said regarding this. My confusion stems from the fact
> that b43 & 2.6.24 on 32bit with the asus 138gv2 card flashed with the sprom
> image Stefanik provided, got the card working initially - it also got the rx/tx
> LED working 'as it should'. Now...stupid me thought this would merely be a
> case of looking at the sprom values between the two different sprom images,
> to deduce what the values should be...however, if we're talking about these bits here -;
> 
> SPROM(0x64, LED 0 behaviour) = 0xFF
> SPROM(0x65, LED 1 behaviour) = 0xFF
> SPROM(0x66, LED 2 behaviour) = 0xFF
> SPROM(0x67, LED 3 behaviour) = 0xFF
> 
> ....then they're actually the -same- in both sprom image varients.
> 
> Apparently there's more than just these bits in the sprom controlling the LED
> behaviour? Does anyone know what that might be?

I'm not sure what you should expect from the 0xFF values; however, you have 
not enabled the LED select stuff in your kernel. If you had, you would see 
lines like

b43-phy0 debug: 64-bit DMA initialized
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::radio

Larry


From myheadblewoff at hotmail.com  Wed May  7 16:05:02 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Thu, 8 May 2008 00:05:02 +1000
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
Message-ID: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>


Greets,

----------------------------------------
> Date: Tue, 6 May 2008 22:33:52 -0500
> From: Larry.Finger at lwfinger.net
> To: myheadblewoff at hotmail.com
> CC: bcm43xx-dev at lists.berlios.de
> Subject: Re: ASUS WL-138G v2 / 64bit x86 / b43 working much better
>
>
<>
>
>> SPROM(0x64, LED 0 behaviour) = 0xFF
>> SPROM(0x65, LED 1 behaviour) = 0xFF
>> SPROM(0x66, LED 2 behaviour) = 0xFF
>> SPROM(0x67, LED 3 behaviour) = 0xFF
>>
>> ....then they're actually the -same- in both sprom image varients.
>>
>> Apparently there's more than just these bits in the sprom controlling the LED
>> behaviour? Does anyone know what that might be?
>
> I'm not sure what you should expect from the 0xFF values; however, you have
> not enabled the LED select stuff in your kernel. If you had, you would see
> lines like
>
> b43-phy0 debug: 64-bit DMA initialized

....if it's supposed to say '64bit' , it doesn't here...

> Registered led device: b43-phy0::tx
> Registered led device: b43-phy0::rx
> Registered led device: b43-phy0::radio
>
> Larry

...weird. I went back to check the config, and the LED stuff was
actually enabled, albeit with led-class as a module. Then I noticed
'LED trigger' support wasn't enabled in networking-->wireless. I
now know how this happens (aside from stupid human error).

Using kernel menuconfig, one will typically configure networking-->wireless
before they get to  device drivers-->LED support. This is unfortunate if one
has started the kernel configuration with devices drivers-->led support-->led trigger support
unset, as led trigger support isn't displayed in networking-->wireless with this option unset.

Still stupid human error, I know, but that's how a person gets led into it.

Anyhow, thanks for pointing that out, now I get ;

b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy0 debug: Chip initialized
b43-phy0 debug: 32-bit DMA initialized
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::assoc
b43-phy0 debug: Wireless interface started
b43-phy0 debug: Adding Interface type 2
.......

The rx/tx LED behaviour is working as expected with the 0xFF sprom values
that come with this asus card type....afaict.

kind regards,
                     Donald




_________________________________________________________________
Are you paid what you're worth? Find out: SEEK Salary Centre
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fninemsn%2Eseek%2Ecom%2Eau%2Fcareer%2Dresources%2Fsalary%2Dcentre%2F%3Ftracking%3Dsk%3Ahet%3Asc%3Anine%3A0%3Ahot%3Atext&_t=764565661&_r=OCT07_endtext_salary&_m=EXT

From Larry.Finger at lwfinger.net  Wed May  7 20:35:16 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 07 May 2008 13:35:16 -0500
Subject: Funny attempted load of b44
Message-ID: <4821F664.9020600@lwfinger.net>

Michael,

On the current Ubuntu kernel (2.6.24), trying to load b43legacy causes a
kernel hang with BCM4301 and BCM4303 devices. In trying to debug this, I have
b43legacy blacklisted and I am trying to get useful information on the hang
from netconsole.

Before getting started on the above, I have noticed the following in the
dmesg output:



ssb: Core 0 found: IEEE 802.11 (cc 0x812, rev 0x02, vendor 0x4243)
ssb: Core 1 found: PCMCIA (cc 0x80D, rev 0x00, vendor 0x4243)
ssb: Core 2 found: Fast Ethernet (cc 0x806, rev 0x02, vendor 0x4243)
ssb: Core 3 found: V90 (cc 0x807, rev 0x01, vendor 0x4243)
ssb: Core 4 found: PCI (cc 0x804, rev 0x03, vendor 0x4243)
ssb: Sonics Silicon Backplane found on PCI device 0000:00:0b.0

--- snip ---

b44.c:v2.0
b44: Invalid MAC address found in EEPROM
b44 ssb0:1: Problem fetching invariants of chip, aborting.
b44: probe of ssb0:1 failed with error -22

The ssb core listing is exactly what I expected; however, the attempt to load 
b44 is not. The only device with vendor code 0x14e4 is the BCM4301. In 
addition, b44 is not being forced to load by /etc/modules.

The loading of b44 is not the cause of the problem, but I would like to 
understand it. Can you explain what I see? Are there any other places to look 
for forced loading of modules?

Thanks,

Larry


From mb at bu3sch.de  Wed May  7 21:00:17 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 7 May 2008 21:00:17 +0200
Subject: Funny attempted load of b44
In-Reply-To: <4821F664.9020600@lwfinger.net>
References: <4821F664.9020600@lwfinger.net>
Message-ID: <200805072100.17270.mb@bu3sch.de>

On Wednesday 07 May 2008 20:35:16 Larry Finger wrote:
> Michael,
> 
> On the current Ubuntu kernel (2.6.24), trying to load b43legacy causes a
> kernel hang with BCM4301 and BCM4303 devices. In trying to debug this, I have
> b43legacy blacklisted and I am trying to get useful information on the hang
> from netconsole.
> 
> Before getting started on the above, I have noticed the following in the
> dmesg output:
> 
> 
> 
> ssb: Core 0 found: IEEE 802.11 (cc 0x812, rev 0x02, vendor 0x4243)
> ssb: Core 1 found: PCMCIA (cc 0x80D, rev 0x00, vendor 0x4243)
> ssb: Core 2 found: Fast Ethernet (cc 0x806, rev 0x02, vendor 0x4243)
> ssb: Core 3 found: V90 (cc 0x807, rev 0x01, vendor 0x4243)
> ssb: Core 4 found: PCI (cc 0x804, rev 0x03, vendor 0x4243)
> ssb: Sonics Silicon Backplane found on PCI device 0000:00:0b.0
> 
> --- snip ---
> 
> b44.c:v2.0
> b44: Invalid MAC address found in EEPROM
> b44 ssb0:1: Problem fetching invariants of chip, aborting.
> b44: probe of ssb0:1 failed with error -22
> 
> The ssb core listing is exactly what I expected; however, the attempt to load 
> b44 is not. The only device with vendor code 0x14e4 is the BCM4301. In 
> addition, b44 is not being forced to load by /etc/modules.
> 
> The loading of b44 is not the cause of the problem, but I would like to 
> understand it. Can you explain what I see? Are there any other places to look 
> for forced loading of modules?

Well, we got an ethernet core and ssb loads the driver for it.
Broadcom should get kicked ass for designing this chip ;).
I'd probably simply ignore this. We can put a workaround for it into
ssb, but I'm not sure it's worth it. b44 probes and failes as the core
is a dead core. We're fine.

-- 
Greetings Michael.


From fbicknel at nc.rr.com  Wed May  7 22:33:23 2008
From: fbicknel at nc.rr.com (fbicknel at nc.rr.com)
Date: Wed, 7 May 2008 16:33:23 -0400
Subject: bcm 4315
Message-ID: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>

My apologies if I'm spamming the wrong list; please reply privately and I'll take this elsewhere if so.

I have a Bcm 4315 (not 18, not 03....) and it seems that this model is not listed anywhere in any references I can find; not even Broadcom's site.  Is it an OEM version of some other model by chance?

Anyone hear of lspci returning 4315?

02:00.0 0280: 14e4:4315 (rev 01) 

The laptop is an HP Pavilion dv6835-nr, if that's of any help.

I have tried several times to load the drivers, but though my Gentoo kernel seems to support 43xx and the module indicates that it load, ifconfig -a doesn't show any additional network devices afterwards.  No errors in dmesg, and there's a short notification on successfully loading the bcm43xx driver.  A 'modprobe b43' returns no failure, but dmesg doesn't acknowledge it, either.

Thanks in advance.


From zappacky.lists at gmail.com  Thu May  8 01:15:48 2008
From: zappacky.lists at gmail.com (Zappacky)
Date: Wed, 07 May 2008 19:15:48 -0400
Subject: bcm 4315
In-Reply-To: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
Message-ID: <48223824.7010402@gmail.com>

I'm not going to pretend to know anything about this card, but I've 
never known HP to use any sort of OEM wireless card. Both of the HP 
laptops I've owned have been standard models, 4311 and, recently, a 
4328. On all of the other HP laptops, more of the same.

Possibly some new card? I'm not sure though. Just thought I'd insert 
what little I did know.

-Andrew/Zappacky

fbicknel at nc.rr.com wrote:
> My apologies if I'm spamming the wrong list; please reply privately and I'll take this elsewhere if so.
> 
> I have a Bcm 4315 (not 18, not 03....) and it seems that this model is not listed anywhere in any references I can find; not even Broadcom's site.  Is it an OEM version of some other model by chance?
> 
> Anyone hear of lspci returning 4315?
> 
> 02:00.0 0280: 14e4:4315 (rev 01) 
> 
> The laptop is an HP Pavilion dv6835-nr, if that's of any help.
> 
> I have tried several times to load the drivers, but though my Gentoo kernel seems to support 43xx and the module indicates that it load, ifconfig -a doesn't show any additional network devices afterwards.  No errors in dmesg, and there's a short notification on successfully loading the bcm43xx driver.  A 'modprobe b43' returns no failure, but dmesg doesn't acknowledge it, either.
> 
> Thanks in advance.
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 


From wauhugo at yahoo.com  Thu May  8 03:41:55 2008
From: wauhugo at yahoo.com (Hugo Wau)
Date: Wed, 7 May 2008 18:41:55 -0700 (PDT)
Subject: bcm 4315
Message-ID: <703324.9732.qm@web52504.mail.re2.yahoo.com>

fbicknel at nc.rr.com wrote:
> My apologies if I'm spamming the wrong list; please
reply privately and I'll take this elsewhere if so.
>
> I have a Bcm 4315 (not 18, not 03....) and it seems
that this model is not listed anywhere in any
references I can find; not even Broadcom's site.  Is
it an OEM version of some other model by chance?
>
> Anyone hear of lspci returning 4315?
>
> 02:00.0 0280: 14e4:4315 (rev 01) 
>
> The laptop is an HP Pavilion dv6835-nr, if that's of
any help.
>
> I have tried several times to load the drivers, but
though my Gentoo kernel seems to support 43xx and the
module indicates that it load, ifconfig -a doesn't
show any additional network devices afterwards.  No
errors in dmesg, and there's a short notification on
successfully loading the bcm43xx driver.  A 'modprobe
b43' returns no failure, but dmesg doesn't acknowledge
it, either.
>
> Thanks in advance.
>
>   
http://h10025.www1.hp.com/ewfrf/wc/softwareDownloadIndex?softwareitem=ob-58904-1&lc=en&cc=us&dlc=en&product=3686699&os=2100&lang=en

<http://h10025.www1.hp.com/ewfrf/wc/softwareDownloadIndex?softwareitem=ob-58904-1&lc=en&cc=us&dlc=en&product=3686699&os=2100&lang=en>
says:
Broadcom Wireless LAN Driver for Microsoft Windows
Vista
HP Pavilion dv6835nr Notebook PC
[...]
Supported Devices and Features
Broadcom 802.11 a/b/g WLAN Broadcom 802.11 b/g WLAN
Broadcom 4321AG 
802.11a/b/g/draft-n Wi-Fi Adapter Broadcom 4322AG
802.11a/b/g/draft-n 
Wi-Fi Adapter

Hugo







      ____________________________________________________________________________________
Be a better friend, newshound, and 
know-it-all with Yahoo! Mobile.  Try it now.  http://mobile.yahoo.com/;_ylt=Ahu06i62sR8HDtDypao8Wcj9tAcJ


From Larry.Finger at lwfinger.net  Thu May  8 05:18:32 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 07 May 2008 22:18:32 -0500
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
References: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
Message-ID: <48227108.7040908@lwfinger.net>

kala mazoo wrote:
> Greets,
> 
> ----------------------------------------
>> Date: Tue, 6 May 2008 22:33:52 -0500
>> From: Larry.Finger at lwfinger.net
>> To: myheadblewoff at hotmail.com
>> CC: bcm43xx-dev at lists.berlios.de
>> Subject: Re: ASUS WL-138G v2 / 64bit x86 / b43 working much better
>>
>>
> <>
>>> SPROM(0x64, LED 0 behaviour) = 0xFF
>>> SPROM(0x65, LED 1 behaviour) = 0xFF
>>> SPROM(0x66, LED 2 behaviour) = 0xFF
>>> SPROM(0x67, LED 3 behaviour) = 0xFF
>>>
>>> ....then they're actually the -same- in both sprom image varients.
>>>
>>> Apparently there's more than just these bits in the sprom controlling the LED
>>> behaviour? Does anyone know what that might be?
>> I'm not sure what you should expect from the 0xFF values; however, you have
>> not enabled the LED select stuff in your kernel. If you had, you would see
>> lines like
>>
>> b43-phy0 debug: 64-bit DMA initialized
> 
> ....if it's supposed to say '64bit' , it doesn't here...

That is a function of your card, not your OS. Mine is 64-bit, yours is 
32-bit, and others are 30-bit.

>> Registered led device: b43-phy0::tx
>> Registered led device: b43-phy0::rx
>> Registered led device: b43-phy0::radio
>>
>> Larry
> 
> ...weird. I went back to check the config, and the LED stuff was
> actually enabled, albeit with led-class as a module. Then I noticed
> 'LED trigger' support wasn't enabled in networking-->wireless. I
> now know how this happens (aside from stupid human error).
> 
> Using kernel menuconfig, one will typically configure networking-->wireless
> before they get to  device drivers-->LED support. This is unfortunate if one
> has started the kernel configuration with devices drivers-->led support-->led trigger support
> unset, as led trigger support isn't displayed in networking-->wireless with this option unset.

Yes, configuration is not a straight-line process. In LKML, they are 
currently discussing changes that would gray out those options that do not 
have their prerequisites met.

> Still stupid human error, I know, but that's how a person gets led into it.
> 
> Anyhow, thanks for pointing that out, now I get ;
> 
> b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
> b43-phy0 debug: Chip initialized
> b43-phy0 debug: 32-bit DMA initialized
> Registered led device: b43-phy0::tx
> Registered led device: b43-phy0::rx
> Registered led device: b43-phy0::assoc
> b43-phy0 debug: Wireless interface started
> b43-phy0 debug: Adding Interface type 2
> .......
> 
> The rx/tx LED behaviour is working as expected with the 0xFF sprom values
> that come with this asus card type....afaict.

Glad to be able to fix a problem quickly. Lately, it has been taking a long 
time. Perhaps the bugs are getting more subtle.

Once again, thanks for the ASUS PCI card. I didn't do very much toward fixing 
the problem, but I was able to confirm that there was really a problem, and 
your difficulties weren't due to your spelling of behavior, the sun being in 
the north, or any other geographic factors.

I'm particularly sensitive to the differences between British and American 
spelling. I once co-authored a book with another American. It was published 
by Wiley and Sons out of their UK office. The text went in with US spelling, 
but the galley proofs had UK spelling. We dutifully changed them all, but 
that had no effect. In the final version of the book, color was spelled 
colour, etc.

Larry



From myheadblewoff at hotmail.com  Thu May  8 07:56:23 2008
From: myheadblewoff at hotmail.com (kala mazoo)
Date: Thu, 8 May 2008 15:56:23 +1000
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <48227108.7040908@lwfinger.net>
References: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
	<48227108.7040908@lwfinger.net>
Message-ID: <BAY107-W55FBE8BC049F90696C2B68A0D00@phx.gbl>



----------------------------------------
> Date: Wed, 7 May 2008 22:18:32 -0500
> From: Larry.Finger at lwfinger.net

<>

>>>> Apparently there's more than just these bits in the sprom controlling the LED
>>>> behaviour? Does anyone know what that might be?
>>> I'm not sure what you should expect from the 0xFF values; however, you have
>>> not enabled the LED select stuff in your kernel. If you had, you would see
>>> lines like
>>>
>>> b43-phy0 debug: 64-bit DMA initialized
>> 
>> ....if it's supposed to say '64bit' , it doesn't here...
> 
> That is a function of your card, not your OS. Mine is 64-bit, yours is 
> 32-bit, and others are 30-bit.
> 

....i see...

><>

>> Using kernel menuconfig, one will typically configure networking-->wireless
>> before they get to  device drivers-->LED support. This is unfortunate if one
>> has started the kernel configuration with devices drivers-->led support-->led trigger support
>> unset, as led trigger support isn't displayed in networking-->wireless with this option unset.
> 
> Yes, configuration is not a straight-line process. In LKML, they are 
> currently discussing changes that would gray out those options that do not 
> have their prerequisites met.
> 

....well, that might help...provided the  option still works on a gray option,
and tells the user what the prerequisite actually is that's currently unset. Otherwise,
a torrent of "what does it mean when an option is grayed out? How do I fix this?"
questions are likely to be observed....


>> Still stupid human error, I know, but that's how a person gets led into it.
>> 
>> Anyhow, thanks for pointing that out, now I get ;
>> 
>> b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
>> b43-phy0 debug: Chip initialized
>> b43-phy0 debug: 32-bit DMA initialized
>> Registered led device: b43-phy0::tx
>> Registered led device: b43-phy0::rx
>> Registered led device: b43-phy0::assoc
>> b43-phy0 debug: Wireless interface started
>> b43-phy0 debug: Adding Interface type 2
>> .......
>> 
>> The rx/tx LED behaviour is working as expected with the 0xFF sprom values
>> that come with this asus card type....afaict.
> 
> Glad to be able to fix a problem quickly. Lately, it has been taking a long 
> time. Perhaps the bugs are getting more subtle.
> 
> Once again, thanks for the ASUS PCI card. I didn't do very much toward fixing 
> the problem, but I was able to confirm that there was really a problem, and 
> your difficulties weren't due to your spelling of behavior, the sun being in 
> the north, or any other geographic factors.
> 

Not a problem, if only to confirm the problem existed, it was worth it. As to
the speed finding & fixing the issue, I personally thought things happened
pretty fast to arrive at the eventual resolution. I think Stefanik deserves an
extra cookie of credit here for having the idea to substitute sprom images.
Everyone who helped out gets cookies as well for outstanding effort. (;

..next, I can move onto my original notion of using one of these cards in AP mode...

> I'm particularly sensitive to the differences between British and American 
> spelling. I once co-authored a book with another American. It was published 
> by Wiley and Sons out of their UK office. The text went in with US spelling, 
> but the galley proofs had UK spelling. We dutifully changed them all, but 
> that had no effect. In the final version of the book, color was spelled 
> colour, etc.
> 
> Larry
> 

That is a disappointing outcome -- I'd understand you feeling you're like the victim
of some form of nationalistic prejudice in such circumstance...ie; if I'd written a book
adhering to the spelling examples contained in the Australian Macquarie lexicon, I 
would expect what was published still to be in that original form. I'm typically
ambivalent of/to the spelling differences you speak of, so I am truly apologetic
if that stance has upset/affronted you or anyone else on this list.

Regards,

            Donald

_________________________________________________________________
It's simple! Sell your car for just $30 at CarPoint.com.au
http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fsecure%2Dau%2Eimrworldwide%2Ecom%2Fcgi%2Dbin%2Fa%2Fci%5F450304%2Fet%5F2%2Fcg%5F801459%2Fpi%5F1004813%2Fai%5F859641&_t=762955845&_r=tig_OCT07&_m=EXT

From gavron at wetwork.net  Thu May  8 08:11:43 2008
From: gavron at wetwork.net (Ehud Gavron)
Date: Wed, 07 May 2008 23:11:43 -0700
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <BAY107-W55FBE8BC049F90696C2B68A0D00@phx.gbl>
References: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
	<48227108.7040908@lwfinger.net>
	<BAY107-W55FBE8BC049F90696C2B68A0D00@phx.gbl>
Message-ID: <4822999F.3060003@wetwork.net>



kala mazoo wrote:
> ----------------------------------------
>   
>> Date: Wed, 7 May 2008 22:18:32 -0500
>> From: Larry.Finger at lwfinger.net
>>     
>
> <>
>
>   
>>>>> Apparently there's more than just these bits in the sprom controlling the LED
>>>>> behaviour? Does anyone know what that might be?
>>>>>           
>>>> I'm not sure what you should expect from the 0xFF values; however, you have
>>>> not enabled the LED select stuff in your kernel. If you had, you would see
>>>> lines like
>>>>
>>>> b43-phy0 debug: 64-bit DMA initialized
>>>>         
>>> ....if it's supposed to say '64bit' , it doesn't here...
>>>       
>> That is a function of your card, not your OS. Mine is 64-bit, yours is 
>> 32-bit, and others are 30-bit.
>>
>>     
>
> ....i see...
>
>   
>> <>
>>     
>
>   
>>> Using kernel menuconfig, one will typically configure networking-->wireless
>>> before they get to  device drivers-->LED support. This is unfortunate if one
>>> has started the kernel configuration with devices drivers-->led support-->led trigger support
>>> unset, as led trigger support isn't displayed in networking-->wireless with this option unset.
>>>       
>> Yes, configuration is not a straight-line process. In LKML, they are 
>> currently discussing changes that would gray out those options that do not 
>> have their prerequisites met.
>>
>>     
>
> ....well, that might help...provided the  option still works on a gray option,
> and tells the user what the prerequisite actually is that's currently unset. Otherwise,
> a torrent of "what does it mean when an option is grayed out? How do I fix this?"
> questions are likely to be observed....
>
>
>   
>>> Still stupid human error, I know, but that's how a person gets led into it.
>>>
>>> Anyhow, thanks for pointing that out, now I get ;
>>>
>>> b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
>>> b43-phy0 debug: Chip initialized
>>> b43-phy0 debug: 32-bit DMA initialized
>>> Registered led device: b43-phy0::tx
>>> Registered led device: b43-phy0::rx
>>> Registered led device: b43-phy0::assoc
>>> b43-phy0 debug: Wireless interface started
>>> b43-phy0 debug: Adding Interface type 2
>>> .......
>>>
>>> The rx/tx LED behaviour is working as expected with the 0xFF sprom values
>>> that come with this asus card type....afaict.
>>>       
>> Glad to be able to fix a problem quickly. Lately, it has been taking a long 
>> time. Perhaps the bugs are getting more subtle.
>>
>> Once again, thanks for the ASUS PCI card. I didn't do very much toward fixing 
>> the problem, but I was able to confirm that there was really a problem, and 
>> your difficulties weren't due to your spelling of behavior, the sun being in 
>> the north, or any other geographic factors.
>>
>>     
>
> Not a problem, if only to confirm the problem existed, it was worth it. As to
> the speed finding & fixing the issue, I personally thought things happened
> pretty fast to arrive at the eventual resolution. I think Stefanik deserves an
> extra cookie of credit here for having the idea to substitute sprom images.
> Everyone who helped out gets cookies as well for outstanding effort. (;
>
> ..next, I can move onto my original notion of using one of these cards in AP mode...
>
>   
>> I'm particularly sensitive to the differences between British and American 
>> spelling. I once co-authored a book with another American. It was published 
>> by Wiley and Sons out of their UK office. The text went in with US spelling, 
>> but the galley proofs had UK spelling. We dutifully changed them all, but 
>> that had no effect. In the final version of the book, color was spelled 
>> colour, etc.
>>
>> Larry
>>
>>     
>
> That is a disappointing outcome -- I'd understand you feeling you're like the victim
> of some form of nationalistic prejudice in such circumstance...ie; if I'd written a book
> adhering to the spelling examples contained in the Australian Macquarie lexicon, I 
> would expect what was published still to be in that original form. I'm typically
> ambivalent of/to the spelling differences you speak of, so I am truly apologetic
> if that stance has upset/affronted you or anyone else on this list.
>
> Regards,
>
>             Donald
>
> _________________________________________________________________
> It's simple! Sell your car for just $30 at CarPoint.com.au
> http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fsecure%2Dau%2Eimrworldwide%2Ecom%2Fcgi%2Dbin%2Fa%2Fci%5F450304%2Fet%5F2%2Fcg%5F801459%2Fpi%5F1004813%2Fai%5F859641&_t=762955845&_r=tig_OCT07&_m=EXT
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   
What if.... the disappointment is that you're an idiot, and your name 
"kalamzoo" is an nonexistent place in Michigan, and your input thus far 
on this list has led to more false diagnostics than anyone else, and 
you're an idiot?

So when you say:
 > If I'd written a book
you're illiterate


 > I would expect
Your expectations clearly are tantamount to garbage.


 > Glad to be able to fix a problem quickly. 
Well I did't do it.  You didn't do it.  There should be no "glad" smile 
off our face.


As for your last paragraph, "donald"/ 
"kalamazoo"/"Ichikaboo/bibbitybobbityboo" you should maybe consider 
lessons in how not to be an ass, or... .how to be more human.

Best,

Ehud

PS "My head blew off @ hotmail.com" --- how about "I'm a freakin' idiot 
who has contributed nothing and is not only illiterate but can't figure 
out what to do."  Sucks to be you.  Kalamazoo.  Your rhyme.   Your zoo.


From mb at bu3sch.de  Thu May  8 14:56:50 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 8 May 2008 14:56:50 +0200
Subject: bcm 4315
In-Reply-To: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
Message-ID: <200805081456.50924.mb@bu3sch.de>

On Wednesday 07 May 2008 22:33:23 fbicknel at nc.rr.com wrote:
> My apologies if I'm spamming the wrong list; please reply privately and I'll take this elsewhere if so.
> 
> I have a Bcm 4315 (not 18, not 03....) and it seems that this model is not listed anywhere in any references I can find; not even Broadcom's site.  Is it an OEM version of some other model by chance?
> 
> Anyone hear of lspci returning 4315?
> 
> 02:00.0 0280: 14e4:4315 (rev 01) 

Please apply the following patch and enable "Sonics Silicon Backplane Debugging"
and "b43 debugging". Then send me the dmesg output.

Index: wireless-testing/drivers/ssb/b43_pci_bridge.c
===================================================================
--- wireless-testing.orig/drivers/ssb/b43_pci_bridge.c	2008-02-16 19:08:13.000000000 +0100
+++ wireless-testing/drivers/ssb/b43_pci_bridge.c	2008-05-08 14:55:38.000000000 +0200
@@ -21,6 +21,7 @@ static const struct pci_device_id b43_pc
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4307) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4311) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4312) },
+	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4315) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4318) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4319) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4320) },



-- 
Greetings Michael.


From netrolller.3d at gmail.com  Thu May  8 15:49:18 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Thu, 8 May 2008 15:49:18 +0200
Subject: bcm 4315
In-Reply-To: <200805081456.50924.mb@bu3sch.de>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
	<200805081456.50924.mb@bu3sch.de>
Message-ID: <69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>

On Thu, May 8, 2008 at 2:56 PM, Michael Buesch <mb at bu3sch.de> wrote:

> On Wednesday 07 May 2008 22:33:23 fbicknel at nc.rr.com wrote:
> > My apologies if I'm spamming the wrong list; please reply privately and
> I'll take this elsewhere if so.
> >
> > I have a Bcm 4315 (not 18, not 03....) and it seems that this model is
> not listed anywhere in any references I can find; not even Broadcom's site.
>  Is it an OEM version of some other model by chance?
> >
> > Anyone hear of lspci returning 4315?
> >
> > 02:00.0 0280: 14e4:4315 (rev 01)
>
> Please apply the following patch and enable "Sonics Silicon Backplane
> Debugging"
> and "b43 debugging". Then send me the dmesg output.
>
> Index: wireless-testing/drivers/ssb/b43_pci_bridge.c
> ===================================================================
> --- wireless-testing.orig/drivers/ssb/b43_pci_bridge.c  2008-02-16
> 19:08:13.000000000 +0100
> +++ wireless-testing/drivers/ssb/b43_pci_bridge.c       2008-05-08
> 14:55:38.000000000 +0200
> @@ -21,6 +21,7 @@ static const struct pci_device_id b43_pc
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4307) },
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4311) },
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4312) },
> +       { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4315) },
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4318) },
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4319) },
>        { PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4320) },
>
>
>
> --
> Greetings Michael.
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

AFAIK this is an LP PHY card. Larry said he is working on them. CCing Larry.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080508/ee35126f/attachment.html>

From netrolller.3d at gmail.com  Thu May  8 15:55:40 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Thu, 8 May 2008 15:55:40 +0200
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <4822999F.3060003@wetwork.net>
References: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
	<48227108.7040908@lwfinger.net>
	<BAY107-W55FBE8BC049F90696C2B68A0D00@phx.gbl>
	<4822999F.3060003@wetwork.net>
Message-ID: <69e28c910805080655k38016057jc3f9f2a27f2931f5@mail.gmail.com>

On Thu, May 8, 2008 at 8:11 AM, Ehud Gavron <gavron at wetwork.net> wrote:

>
>
> kala mazoo wrote:
> > ----------------------------------------
> >
> >> Date: Wed, 7 May 2008 22:18:32 -0500
> >> From: Larry.Finger at lwfinger.net
> >>
> >
> > <>
> >
> >
> >>>>> Apparently there's more than just these bits in the sprom controlling
> the LED
> >>>>> behaviour? Does anyone know what that might be?
> >>>>>
> >>>> I'm not sure what you should expect from the 0xFF values; however, you
> have
> >>>> not enabled the LED select stuff in your kernel. If you had, you would
> see
> >>>> lines like
> >>>>
> >>>> b43-phy0 debug: 64-bit DMA initialized
> >>>>
> >>> ....if it's supposed to say '64bit' , it doesn't here...
> >>>
> >> That is a function of your card, not your OS. Mine is 64-bit, yours is
> >> 32-bit, and others are 30-bit.
> >>
> >>
> >
> > ....i see...
> >
> >
> >> <>
> >>
> >
> >
> >>> Using kernel menuconfig, one will typically configure
> networking-->wireless
> >>> before they get to  device drivers-->LED support. This is unfortunate
> if one
> >>> has started the kernel configuration with devices drivers-->led
> support-->led trigger support
> >>> unset, as led trigger support isn't displayed in networking-->wireless
> with this option unset.
> >>>
> >> Yes, configuration is not a straight-line process. In LKML, they are
> >> currently discussing changes that would gray out those options that do
> not
> >> have their prerequisites met.
> >>
> >>
> >
> > ....well, that might help...provided the  option still works on a gray
> option,
> > and tells the user what the prerequisite actually is that's currently
> unset. Otherwise,
> > a torrent of "what does it mean when an option is grayed out? How do I
> fix this?"
> > questions are likely to be observed....
> >
> >
> >
> >>> Still stupid human error, I know, but that's how a person gets led into
> it.
> >>>
> >>> Anyhow, thanks for pointing that out, now I get ;
> >>>
> >>> b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
> >>> b43-phy0 debug: Chip initialized
> >>> b43-phy0 debug: 32-bit DMA initialized
> >>> Registered led device: b43-phy0::tx
> >>> Registered led device: b43-phy0::rx
> >>> Registered led device: b43-phy0::assoc
> >>> b43-phy0 debug: Wireless interface started
> >>> b43-phy0 debug: Adding Interface type 2
> >>> .......
> >>>
> >>> The rx/tx LED behaviour is working as expected with the 0xFF sprom
> values
> >>> that come with this asus card type....afaict.
> >>>
> >> Glad to be able to fix a problem quickly. Lately, it has been taking a
> long
> >> time. Perhaps the bugs are getting more subtle.
> >>
> >> Once again, thanks for the ASUS PCI card. I didn't do very much toward
> fixing
> >> the problem, but I was able to confirm that there was really a problem,
> and
> >> your difficulties weren't due to your spelling of behavior, the sun
> being in
> >> the north, or any other geographic factors.
> >>
> >>
> >
> > Not a problem, if only to confirm the problem existed, it was worth it.
> As to
> > the speed finding & fixing the issue, I personally thought things
> happened
> > pretty fast to arrive at the eventual resolution. I think Stefanik
> deserves an
> > extra cookie of credit here for having the idea to substitute sprom
> images.
> > Everyone who helped out gets cookies as well for outstanding effort. (;
> >
> > ..next, I can move onto my original notion of using one of these cards in
> AP mode...
> >
> >
> >> I'm particularly sensitive to the differences between British and
> American
> >> spelling. I once co-authored a book with another American. It was
> published
> >> by Wiley and Sons out of their UK office. The text went in with US
> spelling,
> >> but the galley proofs had UK spelling. We dutifully changed them all,
> but
> >> that had no effect. In the final version of the book, color was spelled
> >> colour, etc.
> >>
> >> Larry
> >>
> >>
> >
> > That is a disappointing outcome -- I'd understand you feeling you're like
> the victim
> > of some form of nationalistic prejudice in such circumstance...ie; if I'd
> written a book
> > adhering to the spelling examples contained in the Australian Macquarie
> lexicon, I
> > would expect what was published still to be in that original form. I'm
> typically
> > ambivalent of/to the spelling differences you speak of, so I am truly
> apologetic
> > if that stance has upset/affronted you or anyone else on this list.
> >
> > Regards,
> >
> >             Donald
> >
> > _________________________________________________________________
> > It's simple! Sell your car for just $30 at CarPoint.com.au
> >
> http://a.ninemsn.com.au/b.aspx?URL=http%3A%2F%2Fsecure%2Dau%2Eimrworldwide%2Ecom%2Fcgi%2Dbin%2Fa%2Fci%5F450304%2Fet%5F2%2Fcg%5F801459%2Fpi%5F1004813%2Fai%5F859641&_t=762955845&_r=tig_OCT07&_m=EXT
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
> What if.... the disappointment is that you're an idiot, and your name
> "kalamzoo" is an nonexistent place in Michigan, and your input thus far
> on this list has led to more false diagnostics than anyone else, and
> you're an idiot?
>
> So when you say:
>  > If I'd written a book
> you're illiterate
>
>
>  > I would expect
> Your expectations clearly are tantamount to garbage.
>
>
>  > Glad to be able to fix a problem quickly.
> Well I did't do it.  You didn't do it.  There should be no "glad" smile
> off our face.
>
>
> As for your last paragraph, "donald"/
> "kalamazoo"/"Ichikaboo/bibbitybobbityboo" you should maybe consider
> lessons in how not to be an ass, or... .how to be more human.
>
> Best,
>
> Ehud
>
> PS "My head blew off @ hotmail.com" --- how about "I'm a freakin' idiot
> who has contributed nothing and is not only illiterate but can't figure
> out what to do."  Sucks to be you.  Kalamazoo.  Your rhyme.   Your zoo.
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

Ehud & Gavron: are you sure this discussion belongs to bcm43xx-dev?! AFAIK
the microcode doesn't really care about American vs. British spellings.

Also, a good rule of thumb about which spelling to use: if you are writing
about US subjects, use US English. If you are writing about British
subjects, use UK English. In general, use the most relevant spelling rules.
(This is what I call "Wikipedia English".)

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080508/0cba1183/attachment.html>

From mark.sf.net at huijgen.tk  Thu May  8 16:01:57 2008
From: mark.sf.net at huijgen.tk (Mark Huijgen)
Date: Thu, 08 May 2008 16:01:57 +0200
Subject: bcm 4315
In-Reply-To: <69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>	<200805081456.50924.mb@bu3sch.de>
	<69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>
Message-ID: <482307D5.1040805@huijgen.tk>

Stefanik G?bor wrote:
> On Thu, May 8, 2008 at 2:56 PM, Michael Buesch <mb at bu3sch.de 
> <mailto:mb at bu3sch.de>> wrote:
>
>     On Wednesday 07 May 2008 22:33:23 fbicknel at nc.rr.com
>     <mailto:fbicknel at nc.rr.com> wrote:
>     > My apologies if I'm spamming the wrong list; please reply
>     privately and I'll take this elsewhere if so.
>     >
>     > I have a Bcm 4315 (not 18, not 03....) and it seems that this
>     model is not listed anywhere in any references I can find; not
>     even Broadcom's site.  Is it an OEM version of some other model by
>     chance?
>     >
>     > Anyone hear of lspci returning 4315?
>     >
>     > 02:00.0 0280: 14e4:4315 (rev 01)
>
>
> AFAIK this is an LP PHY card. Larry said he is working on them. CCing 
> Larry.
This is indeed an LPPHY card, I have one of those too.
Larry and me are working on reverse engineering the broadcom driver to 
write specs for this type of PHY.

Mark


From gavron at wetwork.net  Thu May  8 16:33:20 2008
From: gavron at wetwork.net (Ehud Gavron)
Date: Thu, 08 May 2008 07:33:20 -0700
Subject: ASUS WL-138G v2 / 64bit x86 / b43 working much better
In-Reply-To: <69e28c910805080655k38016057jc3f9f2a27f2931f5@mail.gmail.com>
References: <BAY107-W10BA27301F951F84C413AEA0D10@phx.gbl>
	<48227108.7040908@lwfinger.net>
	<BAY107-W55FBE8BC049F90696C2B68A0D00@phx.gbl>
	<4822999F.3060003@wetwork.net>
	<69e28c910805080655k38016057jc3f9f2a27f2931f5@mail.gmail.com>
Message-ID: <48230F30.6080104@wetwork.net>



Stefanik G?bor wrote:
> ...
> Ehud & Gavron: are you sure this discussion belongs to bcm43xx-dev?! 
> AFAIK the microcode doesn't really care about American vs. British 
> spellings.
>
> Also, a good rule of thumb about which spelling to use: if you are 
> writing about US subjects, use US English. If you are writing about 
> British subjects, use UK English. In general, use the most relevant 
> spelling rules. (This is what I call "Wikipedia English".)
>
> -- 
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-) 

Stefanik, you are right, this does not belong on the list :)

Ehud


From zajec5polish at gmail.com  Thu May  8 21:05:09 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Thu, 8 May 2008 21:05:09 +0200
Subject: bcm 4315
In-Reply-To: <482307D5.1040805@huijgen.tk>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
	<200805081456.50924.mb@bu3sch.de>
	<69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>
	<482307D5.1040805@huijgen.tk>
Message-ID: <14b026160805081205x548814bapc67fe7627cceda28@mail.gmail.com>

2008/5/8, Mark Huijgen <mark.sf.net at huijgen.tk>:
> This is indeed an LPPHY card, I have one of those too.
>  Larry and me are working on reverse engineering the broadcom driver to
>  write specs for this type of PHY.

Could some owner of 4315 post simple

lspci | grep 4315

here for me, please?

-- 
Rafa? Mi?ecki

From linville at tuxdriver.com  Thu May  8 21:38:03 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Thu, 8 May 2008 15:38:03 -0400
Subject: [patch 08/16] b43: Fix dual-PHY devices
In-Reply-To: <20080508174214.GI855@suse.de>
References: <20080508173436.454278564@mini.kroah.org>
	<20080508174214.GI855@suse.de>
Message-ID: <20080508193803.GB9176@tuxdriver.com>

On Thu, May 08, 2008 at 10:42:14AM -0700, Greg KH wrote:
> 2.6.25-stable review patch.  If anyone has any objections, please let us
> know.
> 
> ------------------
> From: Michael Buesch <mb at bu3sch.de>
> 
> commit 2e35af143a1380173ba292e48e9b4913ef16b4ee upstream
> 
> This fixes operation of dual-PHY (A/B/G) devices.
> Do not anounce the A-PHY to mac80211, as that's not supported, yet.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> Signed-off-by: John W. Linville <linville at tuxdriver.com>
> Signed-off-by: Greg Kroah-Hartman <gregkh at suse.de>

ACK

-- 
John W. Linville
linville at tuxdriver.com


From linville at tuxdriver.com  Thu May  8 22:04:34 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Thu, 8 May 2008 16:04:34 -0400
Subject: [patch 11/16] b43: Fix some TX/RX locking issues
In-Reply-To: <20080508174221.GL855@suse.de>
References: <20080508173436.454278564@mini.kroah.org>
	<20080508174221.GL855@suse.de>
Message-ID: <20080508200434.GC9176@tuxdriver.com>

On Thu, May 08, 2008 at 10:42:21AM -0700, Greg KH wrote:
> 2.6.25-stable review patch.  If anyone has any objections, please let us
> know.
> 
> ------------------
> From: Michael Buesch <mb at bu3sch.de>
> 
> commit 21a75d7788f4e29b6c6d28e08f9f0310c4de828d upstream.
> 
> This fixes some TX/RX related locking issues.
> With this patch applied, some of the PHY transmission errors are fixed.

ACK

-- 
John W. Linville
linville at tuxdriver.com


From mark.sf.net at huijgen.tk  Fri May  9 09:01:04 2008
From: mark.sf.net at huijgen.tk (Mark Huijgen)
Date: Fri, 09 May 2008 09:01:04 +0200
Subject: bcm 4315
In-Reply-To: <14b026160805081205x548814bapc67fe7627cceda28@mail.gmail.com>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>	
	<200805081456.50924.mb@bu3sch.de>	
	<69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>	
	<482307D5.1040805@huijgen.tk>
	<14b026160805081205x548814bapc67fe7627cceda28@mail.gmail.com>
Message-ID: <4823F6B0.4090505@huijgen.tk>

Rafa? Mi?ecki wrote:
> 2008/5/8, Mark Huijgen <mark.sf.net at huijgen.tk>:
>   
>> This is indeed an LPPHY card, I have one of those too.
>>  Larry and me are working on reverse engineering the broadcom driver to
>>  write specs for this type of PHY.
>>     
>
> Could some owner of 4315 post simple
>
> lspci | grep 4315
>
> here for me, please?
>
>   
lspci -v for the card:
10:00.0 Network controller: Broadcom Corporation BCM4310 USB Controller 
(rev 01)
        Subsystem: Hewlett-Packard Company Unknown device 137d
        Flags: bus master, fast devsel, latency 0, IRQ 10
        Memory at f0000000 (64-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 3
        Capabilities: [58] Vendor Specific Information
        Capabilities: [e8] Message Signalled Interrupts: 64bit+ 
Queue=0/0 Enable-
        Capabilities: [d0] Express Endpoint IRQ

Relevant part of lspci -vn:
10:00.0 0280: 14e4:4315 (rev 01)
        Subsystem: 103c:137d

It seems my pci.id file has incorrect data for the product ID 4315. Its 
a mini pci-express card, label on it says:

BCM94312MCG rev GP3 P207 WMIB265G V00 EU 1BD7LBD


Mark


From zajec5polish at gmail.com  Fri May  9 09:59:07 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Fri, 9 May 2008 09:59:07 +0200
Subject: bcm 4315
In-Reply-To: <4823F6B0.4090505@huijgen.tk>
References: <26020496.57281210192403222.JavaMail.root@cdptpa-web24-z02>
	<200805081456.50924.mb@bu3sch.de>
	<69e28c910805080649ic5893a6gb361086bfef4e355@mail.gmail.com>
	<482307D5.1040805@huijgen.tk>
	<14b026160805081205x548814bapc67fe7627cceda28@mail.gmail.com>
	<4823F6B0.4090505@huijgen.tk>
Message-ID: <14b026160805090059v4011f38y2dbc850592b1a39d@mail.gmail.com>

2008/5/9, Mark Huijgen <mark.sf.net at huijgen.tk>:
> Rafa? Mi?ecki wrote:
> > Could some owner of 4315 post simple
> >
> > lspci | grep 4315
> >
> > here for me, please?
> >
> >
> >
>  lspci -v for the card:
>  10:00.0 Network controller: Broadcom Corporation BCM4310 USB Controller
> (rev 01)
>        Subsystem: Hewlett-Packard Company Unknown device 137d
>        Flags: bus master, fast devsel, latency 0, IRQ 10
>        Memory at f0000000 (64-bit, non-prefetchable) [size=16K]
>        Capabilities: [40] Power Management version 3
>        Capabilities: [58] Vendor Specific Information
>        Capabilities: [e8] Message Signalled Interrupts: 64bit+ Queue=0/0
> Enable-
>        Capabilities: [d0] Express Endpoint IRQ
>
>  Relevant part of lspci -vn:
>  10:00.0 0280: 14e4:4315 (rev 01)
>        Subsystem: 103c:137d
>
>  It seems my pci.id file has incorrect data for the product ID 4315. Its a
> mini pci-express card, label on it says:

It seems so. According to http://pci-ids.ucw.cz/iii/?i=14e44315
someone created some time ago invalid entry for 14e4:4315. Currently
this invalid entry waits for deletion by moderator.

I am confused about this pci-ids project. Last mail on pciids-commits@
is from 2007-05-04, list pciids-devel@ is totally spammed and there is
also a lot of changes waiting for moderation (acceptance). It this
project still alive?


-- 
Rafa? Mi?ecki

From bud3030 at gmail.com  Fri May  9 22:04:31 2008
From: bud3030 at gmail.com (Bubba Siggler)
Date: Fri, 9 May 2008 16:04:31 -0400
Subject: rt61
Message-ID: <f6a36b9c0805091304x7ed29228p380f8e1c2c72cec9@mail.gmail.com>

Hi all,
I have a notebook with a rt2561wireless what seem to be is the
wireless card switch is off.  Having it dual boot with Vista Premium
an  the switch has to be on.


Thanks in Advance


Bubba


From netrolller.3d at gmail.com  Fri May  9 22:38:36 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Fri, 9 May 2008 22:38:36 +0200
Subject: rt61
In-Reply-To: <f6a36b9c0805091304x7ed29228p380f8e1c2c72cec9@mail.gmail.com>
References: <f6a36b9c0805091304x7ed29228p380f8e1c2c72cec9@mail.gmail.com>
Message-ID: <69e28c910805091338s3d5e9a0ck258fe4c90bdd0397@mail.gmail.com>

On Fri, May 9, 2008 at 10:04 PM, Bubba Siggler <bud3030 at gmail.com> wrote:

> Hi all,
> I have a notebook with a rt2561wireless what seem to be is the
> wireless card switch is off.  Having it dual boot with Vista Premium
> an  the switch has to be on.
>
>
> Thanks in Advance
>
>
> Bubba
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

Bubba, this is not the rt2x00 mailing list, but the b43 one. Ask on
rt2x00.serialmonkey.com instead.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080509/7c511694/attachment.html>

From ruiandreferreira at gmail.com  Sat May 10 00:56:02 2008
From: ruiandreferreira at gmail.com (Rui Ferreira)
Date: Fri, 9 May 2008 23:56:02 +0100
Subject: BCM4328
Message-ID: <d6d00f870805091556l4f30c86fk4fd4a7be89940c2c@mail.gmail.com>

Hi,

I would like to know how work is going with support for BCM4328. Is
anyone working on it?

I've searched the list and there isn't much information, other than
that, currently, draft n is not supported. So, what I would like to
know is:

- what's the current status of development?
- has someone reverse engineered the specs? is that information available?
- are we stuck in some problem that we can jump over?
- would it be less work to support "just" the b standard?
- where can I help?

thanks,

Rui

--------------------------------
Rui Ferreira
ruiandreferreira at gmail.com
http://ruiaf.org


From netrolller.3d at gmail.com  Sat May 10 10:47:09 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 10 May 2008 10:47:09 +0200
Subject: BCM4328
In-Reply-To: <d6d00f870805091556l4f30c86fk4fd4a7be89940c2c@mail.gmail.com>
References: <d6d00f870805091556l4f30c86fk4fd4a7be89940c2c@mail.gmail.com>
Message-ID: <69e28c910805100147q3fa2db8ex5c8e06205b8f4554@mail.gmail.com>

On Sat, May 10, 2008 at 12:56 AM, Rui Ferreira <ruiandreferreira at gmail.com>
wrote:

> Hi,
>
> I would like to know how work is going with support for BCM4328. Is
> anyone working on it?
>
> I've searched the list and there isn't much information, other than
> that, currently, draft n is not supported. So, what I would like to
> know is:
>
> - what's the current status of development?
> - has someone reverse engineered the specs? is that information available?
> - are we stuck in some problem that we can jump over?
> - would it be less work to support "just" the b standard?
> - where can I help?
>
> thanks,
>
> Rui
>
> --------------------------------
> Rui Ferreira
> ruiandreferreira at gmail.com
> http://ruiaf.org
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

Rui: BCM4328 is an N-PHY. N-PHYs can't be supported using the current PHY
code, not even 802.11b-only. However, support for N-PHYs is under
development, just it's hidden from view in the wireless-testing kernel.
Apply the patch @
http://bu3sch.de/patches/wireless-testing/LATEST/patches/001-b43-remove-nphy-kconfig-broken-dep.patchto
make it visible. Beware however, that AFAIK only the PHY itself works,
not the radio. MIMO radios are not yet implemented.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080510/b5a65e5e/attachment.html>

From mb at bu3sch.de  Sat May 10 11:12:31 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 May 2008 11:12:31 +0200
Subject: [PATCH] b43: nphy.c remove duplicated include
Message-ID: <200805101112.31609.mb@bu3sch.de>

From: Huang Weiyi <weiyi.huang at gmail.com>

Remove duplicated include <linux/delay.h> in 
drivers/net/wireless/b43/nphy.c

Signed-off-by: Huang Weiyi <weiyi.huang at gmail.com>
Signed-off-by: Michael Buesch <mb at bu3sch.de>

--- a/drivers/net/wireless/b43/nphy.c   2008-05-10 08:46:36.000000000 +0800
+++ b/drivers/net/wireless/b43/nphy.c   2008-05-10 08:47:02.000000000 +0800
@@ -29,8 +29,6 @@
 #include "nphy.h"
 #include "tables_nphy.h"

-#include <linux/delay.h>
-

 void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
 {//TODO


-- 
Greetings Michael.


From mb at bu3sch.de  Sat May 10 11:13:55 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 May 2008 11:13:55 +0200
Subject: BCM4328
In-Reply-To: <69e28c910805100147q3fa2db8ex5c8e06205b8f4554@mail.gmail.com>
References: <d6d00f870805091556l4f30c86fk4fd4a7be89940c2c@mail.gmail.com>
	<69e28c910805100147q3fa2db8ex5c8e06205b8f4554@mail.gmail.com>
Message-ID: <200805101113.56015.mb@bu3sch.de>

On Saturday 10 May 2008 10:47:09 Stefanik G?bor wrote:
> Rui: BCM4328 is an N-PHY. N-PHYs can't be supported using the current PHY
> code, not even 802.11b-only. However, support for N-PHYs is under
> development, just it's hidden from view in the wireless-testing kernel.
> Apply the patch @
> http://bu3sch.de/patches/wireless-testing/LATEST/patches/001-b43-remove-nphy-kconfig-broken-dep.patchto

Please don't distribute or apply that patch. It's of _no_
use to non-developers.

> make it visible. Beware however, that AFAIK only the PHY itself works,
> not the radio. MIMO radios are not yet implemented.

Nothing works.

People for reverse engineering the stuff are missing.

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Sun May 11 04:38:26 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 10 May 2008 21:38:26 -0500
Subject: Ubuntu systems
Message-ID: <48265C22.9080803@lwfinger.net>

The newest Ubuntu release called Hardy Heron has a 2.6.24 kernel with bcm43xx 
blacklisted, resulting in a lot of users for b43 and b43legacy. Based on some 
of the queries that had hit our list, I decided to configure Ubuntu 
partitions on both my x86_64 laptop and my i386 desktop machine. I then went 
to their active bug list and tackled those that seemed to be real problems 
with our drivers.

The short version of my results is that patches have been submitted and 
accepted to fix all known problems with b43legacy when using 802.11b devices. 
I also submitted the patches needed for implementation of 4311/2 and 4312/2 
cards including the disabling of A-PHY's on 802.11a/b/g units. The 4311/2 
patch had been in trial versions of the Hardy kernel and reportedly caused a 
regression for a 4312/1 user. I don't understand that problem. If anyone 
reading this list knows of a similar problem, please let me know. Because of 
this history, they are being careful with the 4311/2 changes.

Of particular importance to this list, a patch to turn on ssb and b43 
debugging in their default configurations was accepted. Strangely, debugging 
for b43legacy and bcm43xx was already included. It should be easier to make 
sense of their problems once these changes are included in their kernels.

<mini-rant>
This has been my first experience with Debian-based systems. The philosophy 
seems to be "make it as difficult as possible for the user to modify the 
kernel". When testing changes in a module under openSUSE 10.3, I can compile, 
install the new module, unload the old one, and test the new one in less than 
5 minutes on most of my machines. With Ubuntu, that took at least 30 minutes. 
For one of the bugs, I discovered that the problem had been fixed in current 
mainline, so I used openSUSE to bisect between 2.6.25 and 2.6.24 to find the 
problem. It was much faster that way.
</mini-rant>

Larry


From proski at gnu.org  Sun May 11 06:24:12 2008
From: proski at gnu.org (Pavel Roskin)
Date: Sun, 11 May 2008 00:24:12 -0400
Subject: Ubuntu systems
In-Reply-To: <48265C22.9080803@lwfinger.net>
References: <48265C22.9080803@lwfinger.net>
Message-ID: <1210479852.31198.18.camel@dv>

On Sat, 2008-05-10 at 21:38 -0500, Larry Finger wrote:

> The short version of my results is that patches have been submitted and 
> accepted to fix all known problems with b43legacy when using 802.11b devices. 
> I also submitted the patches needed for implementation of 4311/2 and 4312/2 
> cards including the disabling of A-PHY's on 802.11a/b/g units. The 4311/2 
> patch had been in trial versions of the Hardy kernel and reportedly caused a 
> regression for a 4312/1 user. I don't understand that problem. If anyone 
> reading this list knows of a similar problem, please let me know. Because of 
> this history, they are being careful with the 4311/2 changes.

Sorry for getting this thread in a slightly different direction, but it
seems to me that 4311/4312 don't get as much testing as 4306/4318 among
the core developers, which is unfortunate, as the former are used in
more modern systems.

I think we need to get developers a laptop with PCI Express Mini Card
support.  A modern Dell Inspiron would be fine.  I know that it can be
opened relatively easy to replace the card.  I did it twice - first to
change bcm4328 to iwl4965, and then to bcm4311 (without 802.11a support,
so I cannot test this case).  In fact, there is another empty slot in my
Dell Inspiron 1420, reserved for WAN, so it should be possible to put
the second card there.  I'm actually going to try it.  Dell Vostro
shouldn't be much different.

I contributed my part to the funds (no idea why it's not shown, I
forwarded my receipt to Stefano), and there is more than enough for a
minimal Dell Inspiron or Vostro.

Vostro 1000 with 64-bit AMD CPU and bcm4312 (1490) is $434 now in the US
(plus shipping and tax).

-- 
Regards,
Pavel Roskin


From Larry.Finger at lwfinger.net  Sun May 11 06:43:13 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 10 May 2008 23:43:13 -0500
Subject: Ubuntu systems
In-Reply-To: <30c8a83c0805102007t3e56f802n80ffc83d0916207b@mail.gmail.com>
References: <48265C22.9080803@lwfinger.net>
	<30c8a83c0805102007t3e56f802n80ffc83d0916207b@mail.gmail.com>
Message-ID: <48267961.5050101@lwfinger.net>

Buran Ayuthia wrote:
> I am not for sure if I can be much help, but I have a 4311 rev 01 card
> and was using Hardy during the alpha phase.  From what I recall, when
> they ran the patch through, it fixed the 4311/2 rev 02 owners but for
> me (and apparently a lot of the other Broadcom users) it made our
> cards not connect as easily.  I recall that I was still able to
> connect, but I had to be pretty close to the router in order to
> connect.  Once they backed out the patch, I was able to connect 30-40
> feet away through a couple of layers of cinder block.  I have been
> waiting for a fix, but I have not seen one yet.
> 
> Right now, I know that there has been a lot of posts in the Ubuntu
> forums from Broadcom owners trying to get their wireless to work so I
> am sure that the developers are probably cautious of releasing a fix.

I certainly understand the Ubuntu developers having some hesitancy over this 
issue, and I have no quarrel with that. What I don't understand is how this 
patch had any possible effect on the 4311/1 devices. I was the author of the 
patch, which consists of 9 hunks. Of these, one corrects a typo in a comment, 
four fix problems with 64-bit DMA, one adds the new 802.11 revision number, 
and two handle the recognition of the new PHY revision. As the 4311/1 uses 
32-bit DMA, none of these have any effect on those devices. If you do the 
count, there is one hunk remaining. It increases the number of receive DMA 
slots and should have no effect on performance.

Larry


From Larry.Finger at lwfinger.net  Sun May 11 06:58:15 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 10 May 2008 23:58:15 -0500
Subject: Ubuntu systems
In-Reply-To: <1210479852.31198.18.camel@dv>
References: <48265C22.9080803@lwfinger.net> <1210479852.31198.18.camel@dv>
Message-ID: <48267CE7.1060103@lwfinger.net>

Pavel Roskin wrote:
> On Sat, 2008-05-10 at 21:38 -0500, Larry Finger wrote:
> 
> Sorry for getting this thread in a slightly different direction, but it
> seems to me that 4311/4312 don't get as much testing as 4306/4318 among
> the core developers, which is unfortunate, as the former are used in
> more modern systems.
> 
> I think we need to get developers a laptop with PCI Express Mini Card
> support.  A modern Dell Inspiron would be fine.  I know that it can be
> opened relatively easy to replace the card.  I did it twice - first to
> change bcm4328 to iwl4965, and then to bcm4311 (without 802.11a support,
> so I cannot test this case).  In fact, there is another empty slot in my
> Dell Inspiron 1420, reserved for WAN, so it should be possible to put
> the second card there.  I'm actually going to try it.  Dell Vostro
> shouldn't be much different.
> 
> I contributed my part to the funds (no idea why it's not shown, I
> forwarded my receipt to Stefano), and there is more than enough for a
> minimal Dell Inspiron or Vostro.
> 
> Vostro 1000 with 64-bit AMD CPU and bcm4312 (1490) is $434 now in the US
> (plus shipping and tax).

At present, I have a BCM4311 rev 2 in my laptop so that device gets lots of 
testing. I used to have a 4311/1, but that laptop was recalled and replaced. 
To help debug this particular issue, I just bought a D1490 on E-bay. I also 
have a BCM4310, which has an LP-PHY and is the reason I'm working on the RE 
for that device.

If the developers feel that a new laptop would be desirable, I certainly 
would not object; however, we do have coverage for these devices.

Larry







From proski at gnu.org  Sun May 11 07:00:54 2008
From: proski at gnu.org (Pavel Roskin)
Date: Sun, 11 May 2008 01:00:54 -0400
Subject: Ubuntu systems
In-Reply-To: <48267CE7.1060103@lwfinger.net>
References: <48265C22.9080803@lwfinger.net> <1210479852.31198.18.camel@dv>
	<48267CE7.1060103@lwfinger.net>
Message-ID: <1210482054.31198.32.camel@dv>

On Sat, 2008-05-10 at 23:58 -0500, Larry Finger wrote:

> At present, I have a BCM4311 rev 2 in my laptop so that device gets lots of 
> testing. I used to have a 4311/1, but that laptop was recalled and replaced. 
> To help debug this particular issue, I just bought a D1490 on E-bay. I also 
> have a BCM4310, which has an LP-PHY and is the reason I'm working on the RE 
> for that device.
> 
> If the developers feel that a new laptop would be desirable, I certainly 
> would not object; however, we do have coverage for these devices.

I see, good to know.

-- 
Regards,
Pavel Roskin


From charlesschaefer at gmail.com  Sun May 11 17:56:51 2008
From: charlesschaefer at gmail.com (Charles Schaefer)
Date: Sun, 11 May 2008 12:56:51 -0300
Subject: Ubuntu systems
Message-ID: <fe0b8b0c0805110856h17573405t7edd385ff4cfacf4@mail.gmail.com>

I don't know if this would be so useful, but I'm using Ubuntu 8.04
(kernel 2.6.24) with my Dell Vostro 1000, that has a 4311/1 wlan card.
I was experiencing troubles when very far of the AP. So I've
downloaded the latest version of the driver (in the linux wireless
site) and compiled in my machine and it is working very well in the 32
bits version. I've not tested in the 64 bits yet.

I don't know C sufficient to help fixing the driver, but i can test it
when new bugs are fixed and features added. I'll follow the threads
here to know when to download and recompile the drivers to be tested.

cheers,

-- 
Charles Schaefer - Web Developer
Email: charlesschaefer at gmail.com
Tels.: +55 31 9317-2862
       +55 31 2526-4096

ATEN??O: N?o imprima este e-mail. A natureza agradece. E seu bolso tamb?m.
WARNING: Don't print this e-mail. The nature is thankful. And your money too


From hvontres at gmail.com  Mon May 12 07:41:57 2008
From: hvontres at gmail.com (Hans Henry von Tresckow)
Date: Sun, 11 May 2008 22:41:57 -0700
Subject: Fwd: Ubuntu systems
In-Reply-To: <a7f8874a0805112237h7e163953ocd99738ff3e255cc@mail.gmail.com>
References: <48265C22.9080803@lwfinger.net>
	<a7f8874a0805112237h7e163953ocd99738ff3e255cc@mail.gmail.com>
Message-ID: <a7f8874a0805112241p797da946ne26a6d8551bd0674@mail.gmail.com>

---------- Forwarded message ----------
From: Hans Henry von Tresckow <hvontres at gmail.com>
Date: Sun, May 11, 2008 at 10:37 PM
Subject: Re: Ubuntu systems
To: Larry Finger <Larry.Finger at lwfinger.net>




On Sat, May 10, 2008 at 7:38 PM, Larry Finger <Larry.Finger at lwfinger.net>
wrote:

> The newest Ubuntu release called Hardy Heron has a 2.6.24 kernel with
> bcm43xx
> blacklisted, resulting in a lot of users for b43 and b43legacy. Based on
> some
> of the queries that had hit our list, I decided to configure Ubuntu
> partitions on both my x86_64 laptop and my i386 desktop machine. I then
> went
> to their active bug list and tackled those that seemed to be real problems
> with our drivers.


Here is the result on my machine (hp dv2416us with 4311 rev 2) :

henry at FozzieBear:~/compat-wireless-2008-05-07$ uname -a
Linux FozzieBear 2.6.24-17-generic #1 SMP Thu May 1 13:57:17 UTC 2008 x86_64
GNU/Linux

lspci output:
henry at FozzieBear:~/compat-wireless-2008-05-07$ sudo lspci -v -s 01:00.0
01:00.0 Network controller: Broadcom Corporation BCM4312 802.11a/b/g (rev
02)
        Subsystem: Hewlett-Packard Company Unknown device 1370
        Flags: bus master, fast devsel, latency 0, IRQ 19
        Memory at b3000000 (64-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 3
        Capabilities: [58] Vendor Specific Information
        Capabilities: [e8] Message Signalled Interrupts: Mask- 64bit+
Queue=0/0 Enable-
        Capabilities: [d0] Express Endpoint IRQ 0


dmesg output:
237.004508] ACPI: PCI interrupt for device 0000:01:00.0 disabled
[  243.322995] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19
(level, high) -> IRQ 19
[  243.323011] PCI: Setting latency timer of device 0000:01:00.0 to 64
[  243.388751] WARNING: at /build/buildd/linux-2.6.24/drivers/ssb/main.c:883
ssb_tmslow_reject_bitmask()
[  243.388761] Pid: 7093, comm: modprobe Tainted: P        2.6.24-17-generic
#1
[  243.388765]
[  243.388766] Call Trace:
[  243.388804]  [<ffffffff881cd8ca>]
:ssb:ssb_tmslow_reject_bitmask+0x4a/0x60
[  243.388813]  [<ffffffff881ce316>] :ssb:ssb_device_is_enabled+0x16/0x50
[  243.388822]  [<ffffffff881d0731>] :ssb:ssb_pcicore_init+0x21/0x70
[  243.388831]  [<ffffffff881cd656>]
:ssb:ssb_attach_queued_buses+0x106/0x2d0
[  243.388846]  [<ffffffff881cf250>] :ssb:ssb_pci_get_invariants+0x0/0x2d0
[  243.388853]  [<ffffffff881cdd0e>] :ssb:ssb_bus_register+0x17e/0x200
[  243.388880]  [<ffffffff881cde22>] :ssb:ssb_bus_pcibus_register+0x32/0x60
[  243.388889]  [<ffffffff881cfcdd>] :ssb:ssb_pcihost_probe+0x7d/0xc0
[  243.388899]  [<ffffffff8035e118>] pci_device_probe+0xf8/0x170
[  243.388912]  [<ffffffff803bf7ac>] driver_probe_device+0x9c/0x1b0
[  243.388921]  [<ffffffff803bfa79>] __driver_attach+0xc9/0xd0
[  243.388928]  [<ffffffff803bf9b0>] __driver_attach+0x0/0xd0
[  243.388933]  [<ffffffff803be9ed>] bus_for_each_dev+0x4d/0x80
[  243.388946]  [<ffffffff803bedfc>] bus_add_driver+0xac/0x220
[  243.388954]  [<ffffffff8035e399>] __pci_register_driver+0x69/0xb0
[  243.388963]  [<ffffffff880aa052>] :ssb:ssb_modinit+0x52/0x80
[  243.388972]  [<ffffffff80263c5e>] sys_init_module+0x18e/0x1a90
[  243.389003]  [<ffffffff803bf020>] bus_register+0x0/0x270
[  243.389019]  [<ffffffff8020c37e>] system_call+0x7e/0x83
[  243.389036]
[  243.389099] ssb: Sonics Silicon Backplane found on PCI device
0000:01:00.0


Card work fine with compat-wireless-2008-05-07 installed

I hope this helps

-- 
Henry von Tresckow (hvontres)



-- 
Henry von Tresckow (hvontres)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080511/e59e5da1/attachment.html>

From Larry.Finger at lwfinger.net  Mon May 12 07:51:11 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 12 May 2008 00:51:11 -0500
Subject: Fwd: Ubuntu systems
In-Reply-To: <a7f8874a0805112241p797da946ne26a6d8551bd0674@mail.gmail.com>
References: <48265C22.9080803@lwfinger.net>	<a7f8874a0805112237h7e163953ocd99738ff3e255cc@mail.gmail.com>
	<a7f8874a0805112241p797da946ne26a6d8551bd0674@mail.gmail.com>
Message-ID: <4827DACF.2030200@lwfinger.net>

Hans Henry von Tresckow wrote:
> 
> 
> ---------- Forwarded message ----------
> From: *Hans Henry von Tresckow* <hvontres at gmail.com 
> <mailto:hvontres at gmail.com>>
> Date: Sun, May 11, 2008 at 10:37 PM
> Subject: Re: Ubuntu systems
> To: Larry Finger <Larry.Finger at lwfinger.net 
> <mailto:Larry.Finger at lwfinger.net>>
> 
> 
> 
> 
> On Sat, May 10, 2008 at 7:38 PM, Larry Finger <Larry.Finger at lwfinger.net 
> <mailto:Larry.Finger at lwfinger.net>> wrote:
> 
>     The newest Ubuntu release called Hardy Heron has a 2.6.24 kernel
>     with bcm43xx
>     blacklisted, resulting in a lot of users for b43 and b43legacy.
>     Based on some
>     of the queries that had hit our list, I decided to configure Ubuntu
>     partitions on both my x86_64 laptop and my i386 desktop machine. I
>     then went
>     to their active bug list and tackled those that seemed to be real
>     problems
>     with our drivers.
> 
> 
> Here is the result on my machine (hp dv2416us with 4311 rev 2) :
> 
> henry at FozzieBear:~/compat-wireless-2008-05-07$ uname -a
> Linux FozzieBear 2.6.24-17-generic #1 SMP Thu May 1 13:57:17 UTC 2008 
> x86_64 GNU/Linux
> 
> lspci output:
> henry at FozzieBear:~/compat-wireless-2008-05-07$ sudo lspci -v -s 01:00.0
> 01:00.0 Network controller: Broadcom Corporation BCM4312 802.11a/b/g 
> (rev 02)
>         Subsystem: Hewlett-Packard Company Unknown device 1370
>         Flags: bus master, fast devsel, latency 0, IRQ 19
>         Memory at b3000000 (64-bit, non-prefetchable) [size=16K]
>         Capabilities: [40] Power Management version 3
>         Capabilities: [58] Vendor Specific Information
>         Capabilities: [e8] Message Signalled Interrupts: Mask- 64bit+ 
> Queue=0/0 Enable-
>         Capabilities: [d0] Express Endpoint IRQ 0
> 
> 
> dmesg output:
> 237.004508] ACPI: PCI interrupt for device 0000:01:00.0 disabled
> [  243.322995] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 
> 19 (level, high) -> IRQ 19
> [  243.323011] PCI: Setting latency timer of device 0000:01:00.0 to 64
> [  243.388751] WARNING: at 
> /build/buildd/linux-2.6.24/drivers/ssb/main.c:883 
> ssb_tmslow_reject_bitmask()
> [  243.388761] Pid: 7093, comm: modprobe Tainted: P        
> 2.6.24-17-generic #1
> [  243.388765]
> [  243.388766] Call Trace:
> [  243.388804]  [<ffffffff881cd8ca>] 
> :ssb:ssb_tmslow_reject_bitmask+0x4a/0x60
> [  243.388813]  [<ffffffff881ce316>] :ssb:ssb_device_is_enabled+0x16/0x50
> [  243.388822]  [<ffffffff881d0731>] :ssb:ssb_pcicore_init+0x21/0x70
> [  243.388831]  [<ffffffff881cd656>] 
> :ssb:ssb_attach_queued_buses+0x106/0x2d0
> [  243.388846]  [<ffffffff881cf250>] :ssb:ssb_pci_get_invariants+0x0/0x2d0
> [  243.388853]  [<ffffffff881cdd0e>] :ssb:ssb_bus_register+0x17e/0x200
> [  243.388880]  [<ffffffff881cde22>] :ssb:ssb_bus_pcibus_register+0x32/0x60
> [  243.388889]  [<ffffffff881cfcdd>] :ssb:ssb_pcihost_probe+0x7d/0xc0
> [  243.388899]  [<ffffffff8035e118>] pci_device_probe+0xf8/0x170
> [  243.388912]  [<ffffffff803bf7ac>] driver_probe_device+0x9c/0x1b0
> [  243.388921]  [<ffffffff803bfa79>] __driver_attach+0xc9/0xd0
> [  243.388928]  [<ffffffff803bf9b0>] __driver_attach+0x0/0xd0
> [  243.388933]  [<ffffffff803be9ed>] bus_for_each_dev+0x4d/0x80
> [  243.388946]  [<ffffffff803bedfc>] bus_add_driver+0xac/0x220
> [  243.388954]  [<ffffffff8035e399>] __pci_register_driver+0x69/0xb0
> [  243.388963]  [<ffffffff880aa052>] :ssb:ssb_modinit+0x52/0x80
> [  243.388972]  [<ffffffff80263c5e>] sys_init_module+0x18e/0x1a90
> [  243.389003]  [<ffffffff803bf020>] bus_register+0x0/0x270
> [  243.389019]  [<ffffffff8020c37e>] system_call+0x7e/0x83
> [  243.389036]
> [  243.389099] ssb: Sonics Silicon Backplane found on PCI device 
> 0000:01:00.0
>  
> 
> Card work fine with compat-wireless-2008-05-07 installed
> 
> I hope this helps

The patches for bcm4311/2 have been sent to Ubuntu but are not yet installed.

Thanks for your results, which are what is expected until the patches are 
added. I use the mainline 2.6.25-rc1 and wireless-testing kernels with my 
4311/2 and it works perfectly.

Larry



From postfix at au-79.de  Mon May 12 13:33:05 2008
From: postfix at au-79.de (postfix at au-79.de)
Date: Mon, 12 May 2008 13:33:05 +0200
Subject: sucess with HP-laptop dv6057ea
Message-ID: <48282AF1.2050105@au-79.de>

Hi,

after a long time I tryed again wlan with my dv6057ea laptop, and it 
works perfect (but only with ssb and B43 as a module). If you are 
interessted in further tests, please let me know.

actual configuration:

kernel: 2.6.25
module: b43
firmwareID: FW13


Thanks a lot for your great work.

All the best

Robert


From zajec5polish at gmail.com  Mon May 12 13:42:48 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Mon, 12 May 2008 13:42:48 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <48282AF1.2050105@au-79.de>
References: <48282AF1.2050105@au-79.de>
Message-ID: <14b026160805120442p7c14b56eh32dfd2053de218ea@mail.gmail.com>

2008/5/12, postfix at au-79.de <postfix at au-79.de>:
>  after a long time I tryed again wlan with my dv6057ea laptop, and it
>  works perfect (but only with ssb and B43 as a module). If you are
>  interessted in further tests, please let me know.
>
>  actual configuration:
>
>  kernel: 2.6.25
>  module: b43
>  firmwareID: FW13

Really, "HP-laptop dv6057ea" doesn't mean much for every one. It would
be nice to post proper part of
lspci -nnv
which shows what card are you using.

-- 
Rafa? Mi?ecki

From gavron at wetwork.net  Mon May 12 17:11:29 2008
From: gavron at wetwork.net (Ehud Gavron)
Date: Mon, 12 May 2008 08:11:29 -0700
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <48282AF1.2050105@au-79.de>
References: <48282AF1.2050105@au-79.de>
Message-ID: <48285E21.7010000@wetwork.net>

Rafal Milecki wrote:
> Really, "HP-laptop dv6057ea" doesn't mean much for every one. It would
> be nice to post proper part of
> lspci -nnv
Others have written:
Please include dmesg

Still others have said:
It doesn't help anyone when you say "I have a problem" without giving us 
any information to allow us to help you.
WORSE YET if the problem is fixed and you don't tell us how it was fixed 
or what you did, we can
A) Not fix the software
and
B) Not tell new people with the same hardware how to fix the problem 
because we

C) Still don't know what what the harware is and

D) Don't know what was wrong and

E) Don't know what was done to fix it.

Don't look at me.  I'm just an end-user with a good cut&paste key.

Ehud

postfix at au-79.de wrote:
> Hi,
>
> after a long time I tryed again wlan with my dv6057ea laptop, and it 
> works perfect (but only with ssb and B43 as a module). If you are 
> interessted in further tests, please let me know.
>
> actual configuration:
>
> kernel: 2.6.25
> module: b43
> firmwareID: FW13
>
>
> Thanks a lot for your great work.
>
> All the best
>
> Robert
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   


From richie at coderworld.net  Mon May 12 18:06:51 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Mon, 12 May 2008 18:06:51 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <48285E21.7010000@wetwork.net>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
Message-ID: <48286B1B.3060803@coderworld.net>

Ehud Gavron skrev:
> Rafal Milecki wrote:
>> Really, "HP-laptop dv6057ea" doesn't mean much for every one. It would
>> be nice to post proper part of
>> lspci -nnv
> Others have written:
> Please include dmesg
> 
> Still others have said:
> It doesn't help anyone when you say "I have a problem" without giving us 
> any information to allow us to help you.
> WORSE YET if the problem is fixed and you don't tell us how it was fixed 
> or what you did, we can
> A) Not fix the software
> and
> B) Not tell new people with the same hardware how to fix the problem 
> because we
> 
> C) Still don't know what what the harware is and
> 
> D) Don't know what was wrong and
> 
> E) Don't know what was done to fix it.
> 
> Don't look at me.  I'm just an end-user with a good cut&paste key.
> 
> Ehud
> 
Still others have said to please don't toppost because the threads 
become hard to read...

Anyway, some constructive proposals:

A) Start a mailing list bcm43xx-users with a nicer and more forgiving 
tone that doesn't scare away bug reporters and testers.

B) If it's not already done, on linux-wireless / b43 site: Tell how to 
report bugs, with directions on what info is relevant.

C) Set up a bug report form on linux-wireless/b43 site that force needed 
info to be included.

Testers is one of the most needed resource in software development, why 
throw it all away with hostility. I've seen a lot of that on this list, 
which in comparison to lkml is a nightmare for someone who god forbids 
don't magically know what kind of info a dev might need.

To be fair I know exactly how frustrating it is to get incomplete 
reports over and over again. Maybe I'm naive to think it can be worked 
around and minimized.

And oh, I'm not picking specifically on this thread, but the list as a 
whole.

regards / Richard


From mb at bu3sch.de  Mon May 12 18:30:54 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 12 May 2008 18:30:54 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <48286B1B.3060803@coderworld.net>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
	<48286B1B.3060803@coderworld.net>
Message-ID: <200805121830.54979.mb@bu3sch.de>

On Monday 12 May 2008 18:06:51 Richard Jonsson wrote:
> Ehud Gavron skrev:
> > Rafal Milecki wrote:
> >> Really, "HP-laptop dv6057ea" doesn't mean much for every one. It would
> >> be nice to post proper part of
> >> lspci -nnv
> > Others have written:
> > Please include dmesg
> > 
> > Still others have said:
> > It doesn't help anyone when you say "I have a problem" without giving us 
> > any information to allow us to help you.
> > WORSE YET if the problem is fixed and you don't tell us how it was fixed 
> > or what you did, we can
> > A) Not fix the software
> > and
> > B) Not tell new people with the same hardware how to fix the problem 
> > because we
> > 
> > C) Still don't know what what the harware is and
> > 
> > D) Don't know what was wrong and
> > 
> > E) Don't know what was done to fix it.
> > 
> > Don't look at me.  I'm just an end-user with a good cut&paste key.
> > 
> > Ehud

I'm really unsure on what your actual problem is, Ehud.
Is there some bug to be solved? If yes, please provide some debugging
information, instead of whining.

> > 
> Still others have said to please don't toppost because the threads 
> become hard to read...
> 
> Anyway, some constructive proposals:
> 
> A) Start a mailing list bcm43xx-users with a nicer and more forgiving 
> tone that doesn't scare away bug reporters and testers.

Creating a new mainlinglist won't help anyone.
It will just split up developers and users to seperate lists.
That's the opposite of what you want.

> B) If it's not already done, on linux-wireless / b43 site: Tell how to 
> report bugs, with directions on what info is relevant.

Feel free to write a bug-report HOWTO.

> C) Set up a bug report form on linux-wireless/b43 site that force needed 
> info to be included.

Cool. Please implement that.

> Testers is one of the most needed resource in software development, why 
> throw it all away with hostility. I've seen a lot of that on this list, 
> which in comparison to lkml is a nightmare

No wait. LKML is the actual nightmare. It's one of the best examples
for the worst mailinglist ever. ;)

> To be fair I know exactly how frustrating it is to get incomplete 
> reports over and over again. Maybe I'm naive to think it can be worked 
> around and minimized.

Yeah well. People should read the list archives or use google before
asking questions. The traffic could be reduced by 50%.
The signal/noise ratio is very bad on this list.

-- 
Greetings Michael.


From alan at clueserver.org  Mon May 12 18:44:23 2008
From: alan at clueserver.org (Alan)
Date: Mon, 12 May 2008 09:44:23 -0700 (PDT)
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <200805121830.54979.mb@bu3sch.de>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
	<48286B1B.3060803@coderworld.net> <200805121830.54979.mb@bu3sch.de>
Message-ID: <52473.75.164.221.130.1210610663.squirrel@clueserver.org>

> On Monday 12 May 2008 18:06:51 Richard Jonsson wrote:
>> Ehud Gavron skrev:
>> > Rafal Milecki wrote:
>> >> Really, "HP-laptop dv6057ea" doesn't mean much for every one. It
>> would
>> >> be nice to post proper part of
>> >> lspci -nnv
>> > Others have written:
>> > Please include dmesg
>> >
>> > Still others have said:
>> > It doesn't help anyone when you say "I have a problem" without giving
>> us
>> > any information to allow us to help you.
>> > WORSE YET if the problem is fixed and you don't tell us how it was
>> fixed

[snip]

What wireless chipset is used depends on how it was built at the factory. 
(You have a selection of 3-4 options.)

I have a HP dv6000 that was custom built.  It has a "Broadcom Corporation
BCM4328 802.11a/b/g/n (rev 03)".  This is a b43xx chipset, but does not
work correctly with the b43 driver (as far as I know).  To get it to work
I had to use the ndiswrapper hack.

It is pretty nice laptop.  I have been very happy with mine.

As for the hardwaree, here is the lspci output for those the are interested:

00:00.0 RAM memory: nVidia Corporation MCP65 Memory Controller (rev a3)
00:01.0 ISA bridge: nVidia Corporation MCP65 LPC Bridge (rev a3)
00:01.1 SMBus: nVidia Corporation MCP65 SMBus (rev a1)
00:01.3 Co-processor: nVidia Corporation MCP65 SMU (rev a1)
00:02.0 USB Controller: nVidia Corporation MCP65 USB Controller (rev a3)
00:02.1 USB Controller: nVidia Corporation MCP65 USB Controller (rev a3)
00:06.0 Ethernet controller: nVidia Corporation MCP65 Ethernet (rev a3)
00:07.0 Audio device: nVidia Corporation MCP65 High Definition Audio (rev a1)
00:08.0 PCI bridge: nVidia Corporation MCP65 PCI bridge (rev a1)
00:09.0 IDE interface: nVidia Corporation MCP65 IDE (rev a1)
00:0a.0 IDE interface: nVidia Corporation MCP65 SATA Controller (rev a3)
00:0b.0 PCI bridge: nVidia Corporation Unknown device 045b (rev a1)
00:0c.0 PCI bridge: nVidia Corporation MCP65 PCI Express bridge (rev a1)
00:0d.0 PCI bridge: nVidia Corporation MCP65 PCI Express bridge (rev a1)
00:0e.0 PCI bridge: nVidia Corporation MCP65 PCI Express bridge (rev a1)
00:18.0 Host bridge: Advanced Micro Devices [AMD] K8 [Athlon64/Opteron]
HyperTransport Technology Configuration
00:18.1 Host bridge: Advanced Micro Devices [AMD] K8 [Athlon64/Opteron]
Address Map
00:18.2 Host bridge: Advanced Micro Devices [AMD] K8 [Athlon64/Opteron]
DRAM Controller
00:18.3 Host bridge: Advanced Micro Devices [AMD] K8 [Athlon64/Opteron]
Miscellaneous Control
03:00.0 Network controller: Broadcom Corporation BCM4328 802.11a/b/g/n
(rev 03)
05:00.0 VGA compatible controller: nVidia Corporation GeForce 8400M GS
(rev a1)
07:05.0 FireWire (IEEE 1394): Ricoh Co Ltd R5C832 IEEE 1394 Controller
(rev 05)
07:05.1 SD Host controller: Ricoh Co Ltd R5C822 SD/SDIO/MMC/MS/MSPro Host
Adapter (rev 22)
07:05.2 System peripheral: Ricoh Co Ltd R5C843 MMC Host Controller (rev 12)
07:05.3 System peripheral: Ricoh Co Ltd R5C592 Memory Stick Bus Host
Adapter (rev 12)
07:05.4 System peripheral: Ricoh Co Ltd xD-Picture Card Controller (rev ff)




From richie at coderworld.net  Mon May 12 20:32:00 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Mon, 12 May 2008 20:32:00 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <200805121830.54979.mb@bu3sch.de>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
	<48286B1B.3060803@coderworld.net> <200805121830.54979.mb@bu3sch.de>
Message-ID: <48288D20.3050608@coderworld.net>

Michael Buesch skrev:
> On Monday 12 May 2008 18:06:51 Richard Jonsson wrote:
>> A) Start a mailing list bcm43xx-users with a nicer and more forgiving 
>> tone that doesn't scare away bug reporters and testers.
> 
> Creating a new mainlinglist won't help anyone.
> It will just split up developers and users to seperate lists.
> That's the opposite of what you want.
> 
Agreed

>> B) If it's not already done, on linux-wireless / b43 site: Tell how to 
>> report bugs, with directions on what info is relevant.
> 
> Feel free to write a bug-report HOWTO.
> 
I'm not sure I am the right person for this task, as I can't file a 
proper report myself :)

Something like this?

In q&a section:
Q: I found a bug in the driver, now what?

A: See <link to topic "Bug reporting">
-------------------
topic "Bug reporting":

Bug reporting

You should send a message to the b43/b43legacy mailinglist at 
bcm43xx-dev at berlios.de containing ALL of the following:

A description of the problem at hand:
* When does it happen.
* How to reproduce
* If performance is poor; What environment is your wlan in, walls, 
distance etc.

uname -a
lspci -vvn|grep 43 -A7
dmesg

wlan configuration, authentication/encryption type

In addition this may be of interest to the developers:

If you have built the kernel from git:
   Tell which tree, and the output of "git describe"

If the bug is a regression, ie the driver worked with earlier kernels, 
but stopped working, a bisection is of great value.

(I probably missed a few relevant points)

>> C) Set up a bug report form on linux-wireless/b43 site that force needed 
>> info to be included.
> 
> Cool. Please implement that.
> 
Was afraid of that answer, don't have the resources atm, maybe later, no 
promises. Also I don't know what drives that site. And maintenance != me

>> Testers is one of the most needed resource in software development, why 
>> throw it all away with hostility. I've seen a lot of that on this list, 
>> which in comparison to lkml is a nightmare
> 
> No wait. LKML is the actual nightmare. It's one of the best examples
> for the worst mailinglist ever. ;)
> 
On LKML I find no question is to stupid to be answered in a polite 
manner. OTOH it's a nightmare traffic wise.

>> To be fair I know exactly how frustrating it is to get incomplete 
>> reports over and over again. Maybe I'm naive to think it can be worked 
>> around and minimized.
> 
> Yeah well. People should read the list archives or use google before
> asking questions. The traffic could be reduced by 50%.
> The signal/noise ratio is very bad on this list.
> 
Maybe I'm the only person in the world finding it more or less 
impossible to find anything in mailing list archives, unless you find it 
through a search engine. Besides most messages on a ML get obsolete very 
quickly.


From mb at bu3sch.de  Mon May 12 20:45:27 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 12 May 2008 20:45:27 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <48288D20.3050608@coderworld.net>
References: <48282AF1.2050105@au-79.de> <200805121830.54979.mb@bu3sch.de>
	<48288D20.3050608@coderworld.net>
Message-ID: <200805122045.27458.mb@bu3sch.de>

On Monday 12 May 2008 20:32:00 Richard Jonsson wrote:
> * If performance is poor; What environment is your wlan in, walls, 
> distance etc.

I wish these weren't reported at all.
First fact is we can't do anything about them anyway.
Second fact is that we already know about possible performance problems.
So I consider "I only get poor performance of 11MBit/s" as noise on the list.

> If the bug is a regression, ie the driver worked with earlier kernels, 
> but stopped working, a bisection is of great value.

I'd remove the word "regression" here.
People use it way too often, even if it's their fault that the device stopped
working. The bad thing about the word is that it attracts upstream people
like a magnet, as upstream maintainers don't like _real_ regressions, of course.
So it wastes a lot of peoples' times.
I'd rather have people report bugs as usual and let the _maintainers_ (like me)
put attributes like "regression" to it. A "regression" is a showstopper.
What most people report are minor bugs in the global view.

The rest of the text looks pretty good.

> >> C) Set up a bug report form on linux-wireless/b43 site that force needed 
> >> info to be included.
> > 
> > Cool. Please implement that.
> > 
> Was afraid of that answer, don't have the resources atm, maybe later, no 
> promises. Also I don't know what drives that site. And maintenance != me

it's moinmoin based. You can contact Johannes Berg, if you are interested in
implementing such a thing.

> >> Testers is one of the most needed resource in software development, why 
> >> throw it all away with hostility. I've seen a lot of that on this list, 
> >> which in comparison to lkml is a nightmare
> > 
> > No wait. LKML is the actual nightmare. It's one of the best examples
> > for the worst mailinglist ever. ;)
> > 
> On LKML I find no question is to stupid to be answered in a polite 
> manner.

Hahahaha. You're only subscribed since two or three weeks, right? :)

-- 
Greetings Michael.


From proski at gnu.org  Mon May 12 21:01:49 2008
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 12 May 2008 15:01:49 -0400
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <52473.75.164.221.130.1210610663.squirrel@clueserver.org>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
	<48286B1B.3060803@coderworld.net> <200805121830.54979.mb@bu3sch.de>
	<52473.75.164.221.130.1210610663.squirrel@clueserver.org>
Message-ID: <1210618909.6396.4.camel@dv>

On Mon, 2008-05-12 at 09:44 -0700, Alan wrote:

> I have a HP dv6000 that was custom built.  It has a "Broadcom Corporation
> BCM4328 802.11a/b/g/n (rev 03)".  This is a b43xx chipset, but does not
> work correctly with the b43 driver (as far as I know).  To get it to work
> I had to use the ndiswrapper hack.

bcm4328 is not supported and is not expected to be supported soon unless
more people help with reverse engineering efforts.

The driver page mentions that bcm4328 is not supported:
http://linuxwireless.org/en/users/Drivers/b43

-- 
Regards,
Pavel Roskin


From richie at coderworld.net  Mon May 12 22:25:50 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Mon, 12 May 2008 22:25:50 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <200805122045.27458.mb@bu3sch.de>
References: <48282AF1.2050105@au-79.de> <200805121830.54979.mb@bu3sch.de>
	<48288D20.3050608@coderworld.net> <200805122045.27458.mb@bu3sch.de>
Message-ID: <4828A7CE.6070605@coderworld.net>

Michael Buesch skrev:
> On Monday 12 May 2008 20:32:00 Richard Jonsson wrote:
>> * If performance is poor; What environment is your wlan in, walls, 
>> distance etc.
> 
> I wish these weren't reported at all.
> First fact is we can't do anything about them anyway.
> Second fact is that we already know about possible performance problems.
> So I consider "I only get poor performance of 11MBit/s" as noise on the list.
> 
bullet removed
>> If the bug is a regression, ie the driver worked with earlier kernels, 
>> but stopped working, a bisection is of great value.
> 
> I'd remove the word "regression" here.
> People use it way too often, even if it's their fault that the device stopped
> working. The bad thing about the word is that it attracts upstream people
> like a magnet, as upstream maintainers don't like _real_ regressions, of course.
> So it wastes a lot of peoples' times.
> I'd rather have people report bugs as usual and let the _maintainers_ (like me)
> put attributes like "regression" to it. A "regression" is a showstopper.
> What most people report are minor bugs in the global view.
> 
I was not really aware of the meaning of the word regression I guess..

> The rest of the text looks pretty good.
> 
>>>> C) Set up a bug report form on linux-wireless/b43 site that force needed 
>>>> info to be included.
>>> Cool. Please implement that.
>>>
>> Was afraid of that answer, don't have the resources atm, maybe later, no 
>> promises. Also I don't know what drives that site. And maintenance != me
> 
> it's moinmoin based. You can contact Johannes Berg, if you are interested in
> implementing such a thing.
>
OK, maybe later
>>>> Testers is one of the most needed resource in software development, why 
>>>> throw it all away with hostility. I've seen a lot of that on this list, 
>>>> which in comparison to lkml is a nightmare
>>> No wait. LKML is the actual nightmare. It's one of the best examples
>>> for the worst mailinglist ever. ;)
>>>
>> On LKML I find no question is to stupid to be answered in a polite 
>> manner.
> 
> Hahahaha. You're only subscribed since two or three weeks, right? :)
> 
Since 5-6 months. Granted, I don't read everything, and sure, there are 
flames, but seldom uncalled for imho. Maybe my subconcious detect those 
threads and move on to the interesting stuff.

-----------

The whole thing in 1 piece, take two:

In q&a section:
Q: I found a bug in the driver, now what?

A: See <link to topic "Bug reporting">
-------------------
topic "Bug reporting":

Bug reporting

You should send a message to the b43/b43legacy mailinglist at 
bcm43xx-dev at berlios.de containing ALL of the following:

A description of the problem at hand:
* When does it happen.
* How to reproduce

uname -a
lspci -vvn|grep 43 -A7
dmesg

wlan configuration, authentication/encryption type

In addition this may be of interest to the developers:

If you have built the kernel from git:
    Tell which tree, and the output of "git describe"

If the bug worked with earlier kernels, but has since stopped working, a 
bisection is of great value.


From alan at clueserver.org  Mon May 12 22:29:31 2008
From: alan at clueserver.org (Alan)
Date: Mon, 12 May 2008 13:29:31 -0700 (PDT)
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <1210618909.6396.4.camel@dv>
References: <48282AF1.2050105@au-79.de> <48285E21.7010000@wetwork.net>
	<48286B1B.3060803@coderworld.net> <200805121830.54979.mb@bu3sch.de>
	<52473.75.164.221.130.1210610663.squirrel@clueserver.org>
	<1210618909.6396.4.camel@dv>
Message-ID: <55015.75.164.221.130.1210624171.squirrel@clueserver.org>

> On Mon, 2008-05-12 at 09:44 -0700, Alan wrote:
>
>> I have a HP dv6000 that was custom built.  It has a "Broadcom
>> Corporation
>> BCM4328 802.11a/b/g/n (rev 03)".  This is a b43xx chipset, but does not
>> work correctly with the b43 driver (as far as I know).  To get it to
>> work
>> I had to use the ndiswrapper hack.
>
> bcm4328 is not supported and is not expected to be supported soon unless
> more people help with reverse engineering efforts.
>
> The driver page mentions that bcm4328 is not supported:
> http://linuxwireless.org/en/users/Drivers/b43

That is why I used the ndiswrapper hack.  I knew that work was being done
on it.  The mailing list had a bit more information than the web page, but
not by much.

If I had time, I would work on it.  I don't at the moment.


From mb at bu3sch.de  Mon May 12 22:36:32 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 12 May 2008 22:36:32 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <4828A7CE.6070605@coderworld.net>
References: <48282AF1.2050105@au-79.de> <200805122045.27458.mb@bu3sch.de>
	<4828A7CE.6070605@coderworld.net>
Message-ID: <200805122236.32662.mb@bu3sch.de>

On Monday 12 May 2008 22:25:50 Richard Jonsson wrote:
> If the bug worked with earlier kernels, but has since stopped working, a 
> bisection is of great value.

"If the _driver_ worked with earlier..."

Probably :)
Maybe somebody might also complain about a bug that stopped working :P

-- 
Greetings Michael.


From richie at coderworld.net  Mon May 12 22:42:51 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Mon, 12 May 2008 22:42:51 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <200805122236.32662.mb@bu3sch.de>
References: <48282AF1.2050105@au-79.de> <200805122045.27458.mb@bu3sch.de>
	<4828A7CE.6070605@coderworld.net> <200805122236.32662.mb@bu3sch.de>
Message-ID: <4828ABCB.4030204@coderworld.net>

Michael Buesch skrev:
> On Monday 12 May 2008 22:25:50 Richard Jonsson wrote:
>> If the bug worked with earlier kernels, but has since stopped working, a 
>> bisection is of great value.
> 
> "If the _driver_ worked with earlier..."
> 
> Probably :)
> Maybe somebody might also complain about a bug that stopped working :P
> 
Oops, well, that's for tomorrow. I'll see if I can get it up on 
linuxwireless.org, or if I need to ask someone to add it for me.


From mb at bu3sch.de  Mon May 12 23:02:40 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 12 May 2008 23:02:40 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <4828ABCB.4030204@coderworld.net>
References: <48282AF1.2050105@au-79.de> <200805122236.32662.mb@bu3sch.de>
	<4828ABCB.4030204@coderworld.net>
Message-ID: <200805122302.41053.mb@bu3sch.de>

On Monday 12 May 2008 22:42:51 Richard Jonsson wrote:
> Michael Buesch skrev:
> > On Monday 12 May 2008 22:25:50 Richard Jonsson wrote:
> >> If the bug worked with earlier kernels, but has since stopped working, a 
> >> bisection is of great value.
> > 
> > "If the _driver_ worked with earlier..."
> > 
> > Probably :)
> > Maybe somebody might also complain about a bug that stopped working :P
> > 
> Oops, well, that's for tomorrow. I'll see if I can get it up on 
> linuxwireless.org, or if I need to ask someone to add it for me.

It's a wiki. Just register and add it.

-- 
Greetings Michael.


From dan at f-box.org  Tue May 13 10:19:23 2008
From: dan at f-box.org (Daniel)
Date: Tue, 13 May 2008 09:19:23 +0100
Subject: 4311 v2 Bail - 2.6.26-rc2
Message-ID: <48294F0B.4040908@f-box.org>

Hello All,

Apologies if this has been fixed in a newer version. I was just 
wondering if anyone has seen this bug before:

b43-phy1: Broadcom 4311 WLAN found
b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 9
b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
b43-phy1 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
phy1: Selected rate control algorithm 'pid'
Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
firmware: requesting b43/ucode13.fw
firmware: requesting b43/lp0initvals13.fw
b43-phy1: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy1 debug: Chip initialized
b43-phy1 debug: 64-bit DMA initialized
b43-phy1 ERROR: PHY transmission error
b43-phy1 debug: Wireless interface started
b43-phy1 debug: Adding Interface type 2
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:90:d0:f4:18:d4
wlan0: RX authentication from 00:90:d0:f4:18:d4 (alg=0 transaction=2 
status=0)
wlan0: authenticated
wlan0: associate with AP 00:90:d0:f4:18:d4
wlan0: RX AssocResp from 00:90:d0:f4:18:d4 (capab=0x411 status=0 aid=1)
wlan0: associated
wlan0: switched to short barker preamble (BSSID=00:90:d0:f4:18:d4)
b43-phy1 debug: Using hardware based encryption for keyidx: 0, mac: 
00:90:d0:f4:18:d4
b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
ff:ff:ff:ff:ff:ff
wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
buffer size<7>wlan0: wrong buffer size
b43-phy1 debug: Disabling hardware based encryption for keyidx: 1, mac: 
ff:ff:ff:ff:ff:ff
b43-phy1 debug: Removing Interface type 2
b43-phy1 debug: Wireless interface stopped
b43-phy1 debug: DMA-64 rx_ring: Used slots 3/64, Failed frames 0/0 = 
0.0%, Average tries 0.00
b43-phy1 debug: DMA-64 tx_ring_AC_BK: Used slots 0/128, Failed frames 
0/0 = 0.0%, Average tries 0.00
b43-phy1 debug: DMA-64 tx_ring_AC_BE: Used slots 0/128, Failed frames 
0/0 = 0.0%, Average tries 0.00
b43-phy1 debug: DMA-64 tx_ring_AC_VI: Used slots 0/128, Failed frames 
0/0 = 0.0%, Average tries 0.00
b43-phy1 debug: DMA-64 tx_ring_AC_VO: Used slots 128/128, Failed frames 
106/17766 = 0.5%, Average tries 1
b43-phy1 debug: DMA-64 tx_ring_mcast: Used slots 0/128, Failed frames 
0/0 = 0.0%, Average tries 0.00
wlan0: deauthenticate(reason=3)


Cheers,

Dan.


From mb at bu3sch.de  Tue May 13 11:19:09 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 May 2008 11:19:09 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <48294F0B.4040908@f-box.org>
References: <48294F0B.4040908@f-box.org>
Message-ID: <200805131119.09964.mb@bu3sch.de>

On Tuesday 13 May 2008 10:19:23 Daniel wrote:
> Hello All,
> 
> Apologies if this has been fixed in a newer version. I was just 
> wondering if anyone has seen this bug before:


Could you _please_ be so kind an explain your actual problem??
My magic crystalball is broken today.

> b43-phy1: Broadcom 4311 WLAN found
> b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 9
> b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> b43-phy1 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> phy1: Selected rate control algorithm 'pid'
> Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
> firmware: requesting b43/ucode13.fw
> firmware: requesting b43/lp0initvals13.fw
> b43-phy1: Loading firmware version 410.2160 (2007-05-26 15:32:10)
> b43-phy1 debug: Chip initialized
> b43-phy1 debug: 64-bit DMA initialized
> b43-phy1 ERROR: PHY transmission error
> b43-phy1 debug: Wireless interface started
> b43-phy1 debug: Adding Interface type 2
> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:90:d0:f4:18:d4
> wlan0: RX authentication from 00:90:d0:f4:18:d4 (alg=0 transaction=2 
> status=0)
> wlan0: authenticated
> wlan0: associate with AP 00:90:d0:f4:18:d4
> wlan0: RX AssocResp from 00:90:d0:f4:18:d4 (capab=0x411 status=0 aid=1)
> wlan0: associated
> wlan0: switched to short barker preamble (BSSID=00:90:d0:f4:18:d4)
> b43-phy1 debug: Using hardware based encryption for keyidx: 0, mac: 
> 00:90:d0:f4:18:d4
> b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
> ff:ff:ff:ff:ff:ff
> wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
> buffer size<7>wlan0: wrong buffer size
> b43-phy1 debug: Disabling hardware based encryption for keyidx: 1, mac: 
> ff:ff:ff:ff:ff:ff
> b43-phy1 debug: Removing Interface type 2
> b43-phy1 debug: Wireless interface stopped
> b43-phy1 debug: DMA-64 rx_ring: Used slots 3/64, Failed frames 0/0 = 
> 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_BK: Used slots 0/128, Failed frames 
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_BE: Used slots 0/128, Failed frames 
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_VI: Used slots 0/128, Failed frames 
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_VO: Used slots 128/128, Failed frames 
> 106/17766 = 0.5%, Average tries 1
> b43-phy1 debug: DMA-64 tx_ring_mcast: Used slots 0/128, Failed frames 
> 0/0 = 0.0%, Average tries 0.00
> wlan0: deauthenticate(reason=3)

-- 
Greetings Michael.


From richie at coderworld.net  Tue May 13 20:34:58 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Tue, 13 May 2008 20:34:58 +0200
Subject: sucess with HP-laptop dv6057ea
In-Reply-To: <200805122302.41053.mb@bu3sch.de>
References: <48282AF1.2050105@au-79.de> <200805122236.32662.mb@bu3sch.de>
	<4828ABCB.4030204@coderworld.net> <200805122302.41053.mb@bu3sch.de>
Message-ID: <4829DF52.9090209@coderworld.net>

Michael Buesch skrev:
> On Monday 12 May 2008 22:42:51 Richard Jonsson wrote:
>> Michael Buesch skrev:
>>> On Monday 12 May 2008 22:25:50 Richard Jonsson wrote:
>>>> If the bug worked with earlier kernels, but has since stopped working, a 
>>>> bisection is of great value.
>>> "If the _driver_ worked with earlier..."
>>>
>>> Probably :)
>>> Maybe somebody might also complain about a bug that stopped working :P
>>>
>> Oops, well, that's for tomorrow. I'll see if I can get it up on 
>> linuxwireless.org, or if I need to ask someone to add it for me.
> 
> It's a wiki. Just register and add it.
> 
It's added now. I changed it slightly, maybe someone should see if the 
text makes sense.

http://linuxwireless.org/en/users/Drivers/b43#bugreporting
http://linuxwireless.org/en/users/Drivers/b43/faq#Q.3AIfoundabuginthedriver.2Cnowwhat.3F


From proski at gnu.org  Tue May 13 21:17:33 2008
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 13 May 2008 15:17:33 -0400
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <48294F0B.4040908@f-box.org>
References: <48294F0B.4040908@f-box.org>
Message-ID: <1210706253.4573.6.camel@dv>

On Tue, 2008-05-13 at 09:19 +0100, Daniel wrote:

> buffer size<7>wlan0: wrong buffer size

The missing newlines are fixed in today's wireless-testing repository.

-- 
Regards,
Pavel Roskin


From dan at f-box.org  Tue May 13 23:31:17 2008
From: dan at f-box.org (Daniel)
Date: Tue, 13 May 2008 22:31:17 +0100
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <200805131119.09964.mb@bu3sch.de>
References: <48294F0B.4040908@f-box.org> <200805131119.09964.mb@bu3sch.de>
Message-ID: <482A08A5.3000204@f-box.org>

Hello,

Michael Buesch wrote:
> Could you _please_ be so kind an explain your actual problem??
> My magic crystalball is broken today.

Sorry, it's the problem where after X minutes the device seems to loose 
the ability to communicate. It seems to be on a high number of 
connections/sec scenario.

It seems to occur at the 2nd or 3rd issue of the "wrong buffer size" 
message.


Cheers,

Dan.


From mb at bu3sch.de  Wed May 14 01:27:22 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 May 2008 01:27:22 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <482A08A5.3000204@f-box.org>
References: <48294F0B.4040908@f-box.org> <200805131119.09964.mb@bu3sch.de>
	<482A08A5.3000204@f-box.org>
Message-ID: <200805140127.22302.mb@bu3sch.de>

On Tuesday 13 May 2008 23:31:17 Daniel wrote:
> Hello,
> 
> Michael Buesch wrote:
> > Could you _please_ be so kind an explain your actual problem??
> > My magic crystalball is broken today.
> 
> Sorry, it's the problem where after X minutes the device seems to loose 
> the ability to communicate. It seems to be on a high number of 
> connections/sec scenario.
> 
> It seems to occur at the 2nd or 3rd issue of the "wrong buffer size" 
> message.

Where does this "wrong buffer size" message come from, and what does it mean?

> b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
> ff:ff:ff:ff:ff:ff
> wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
> buffer size<7>wlan0: wrong buffer size
> b43-phy1 debug: Disabling hardware based encryption for keyidx: 1, mac: 
> ff:ff:ff:ff:ff:ff

-- 
Greetings Michael.


From johannes at sipsolutions.net  Wed May 14 01:33:23 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 May 2008 01:33:23 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <200805140127.22302.mb@bu3sch.de>
	(sfid-20080514_012747_829356_A0E41B5F)
References: <48294F0B.4040908@f-box.org> <200805131119.09964.mb@bu3sch.de>
	<482A08A5.3000204@f-box.org>  <200805140127.22302.mb@bu3sch.de>
	(sfid-20080514_012747_829356_A0E41B5F)
Message-ID: <1210721604.4279.40.camel@johannes.berg>


> Where does this "wrong buffer size" message come from, and what does it mean?
> 
> > b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
> > ff:ff:ff:ff:ff:ff
> > wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
> > buffer size<7>wlan0: wrong buffer size

It comes from mac80211 when the AP is sending invalid A-MSDU frames.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080514/a4831b64/attachment.pgp>

From johannes at sipsolutions.net  Wed May 14 01:36:04 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 May 2008 01:36:04 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <1210721604.4279.40.camel@johannes.berg>
	(sfid-20080514_013420_793116_3CAFC237)
References: <48294F0B.4040908@f-box.org> <200805131119.09964.mb@bu3sch.de>
	<482A08A5.3000204@f-box.org>  <200805140127.22302.mb@bu3sch.de>
	(sfid-20080514_012747_829356_A0E41B5F)
	<1210721604.4279.40.camel@johannes.berg>
	(sfid-20080514_013420_793116_3CAFC237)
Message-ID: <1210721764.4279.41.camel@johannes.berg>

On Wed, 2008-05-14 at 01:33 +0200, Johannes Berg wrote:
> > Where does this "wrong buffer size" message come from, and what does it mean?
> > 
> > > b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
> > > ff:ff:ff:ff:ff:ff
> > > wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
> > > buffer size<7>wlan0: wrong buffer size
> 
> It comes from mac80211 when the AP is sending invalid A-MSDU frames.

Wait. If this is with b43, why the hell is it sending A-MSDU frames in
the first place? Or maybe it's receiving totally corrupt data. A monitor
mode trace would help.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080514/dbd2bab7/attachment.pgp>

From mb at bu3sch.de  Wed May 14 01:46:06 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 May 2008 01:46:06 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <1210721764.4279.41.camel@johannes.berg>
References: <48294F0B.4040908@f-box.org>
	<1210721604.4279.40.camel@johannes.berg>
	<1210721764.4279.41.camel@johannes.berg>
Message-ID: <200805140146.06910.mb@bu3sch.de>

On Wednesday 14 May 2008 01:36:04 Johannes Berg wrote:
> On Wed, 2008-05-14 at 01:33 +0200, Johannes Berg wrote:
> > > Where does this "wrong buffer size" message come from, and what does it mean?
> > > 
> > > > b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac: 
> > > > ff:ff:ff:ff:ff:ff
> > > > wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong 
> > > > buffer size<7>wlan0: wrong buffer size
> > 
> > It comes from mac80211 when the AP is sending invalid A-MSDU frames.
> 
> Wait. If this is with b43, why the hell is it sending A-MSDU frames in
> the first place? Or maybe it's receiving totally corrupt data. A monitor
> mode trace would help.


Here's the full dmesg.
Also notice "tx_ring_AC_VO: Used slots 128/128" after about 17000 successfull
frames. Weird.

> b43-phy1: Broadcom 4311 WLAN found
> b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 9
> b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> b43-phy1 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> phy1: Selected rate control algorithm 'pid'
> Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
> firmware: requesting b43/ucode13.fw
> firmware: requesting b43/lp0initvals13.fw
> b43-phy1: Loading firmware version 410.2160 (2007-05-26 15:32:10)
> b43-phy1 debug: Chip initialized
> b43-phy1 debug: 64-bit DMA initialized
> b43-phy1 ERROR: PHY transmission error
> b43-phy1 debug: Wireless interface started
> b43-phy1 debug: Adding Interface type 2
> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:90:d0:f4:18:d4
> wlan0: RX authentication from 00:90:d0:f4:18:d4 (alg=0 transaction=2
> status=0)
> wlan0: authenticated
> wlan0: associate with AP 00:90:d0:f4:18:d4
> wlan0: RX AssocResp from 00:90:d0:f4:18:d4 (capab=0x411 status=0 aid=1)
> wlan0: associated
> wlan0: switched to short barker preamble (BSSID=00:90:d0:f4:18:d4)
> b43-phy1 debug: Using hardware based encryption for keyidx: 0, mac:
> 00:90:d0:f4:18:d4
> b43-phy1 debug: Using hardware based encryption for keyidx: 1, mac:
> ff:ff:ff:ff:ff:ff
> wlan0: wrong buffer size<7>wlan0: wrong buffer size<7>wlan0: wrong
> buffer size<7>wlan0: wrong buffer size
> b43-phy1 debug: Disabling hardware based encryption for keyidx: 1, mac:
> ff:ff:ff:ff:ff:ff
> b43-phy1 debug: Removing Interface type 2
> b43-phy1 debug: Wireless interface stopped
> b43-phy1 debug: DMA-64 rx_ring: Used slots 3/64, Failed frames 0/0 =
> 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_BK: Used slots 0/128, Failed frames
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_BE: Used slots 0/128, Failed frames
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_VI: Used slots 0/128, Failed frames
> 0/0 = 0.0%, Average tries 0.00
> b43-phy1 debug: DMA-64 tx_ring_AC_VO: Used slots 128/128, Failed frames
> 106/17766 = 0.5%, Average tries 1
> b43-phy1 debug: DMA-64 tx_ring_mcast: Used slots 0/128, Failed frames
> 0/0 = 0.0%, Average tries 0.00
> wlan0: deauthenticate(reason=3)


-- 
Greetings Michael.


From johannes at sipsolutions.net  Wed May 14 01:48:57 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 May 2008 01:48:57 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <200805140146.06910.mb@bu3sch.de>
References: <48294F0B.4040908@f-box.org>
	<1210721604.4279.40.camel@johannes.berg>
	<1210721764.4279.41.camel@johannes.berg>
	<200805140146.06910.mb@bu3sch.de>
Message-ID: <1210722537.4279.43.camel@johannes.berg>


> > b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 9
> > b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> > b43-phy1 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> > phy1: Selected rate control algorithm 'pid'
> > Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
> > firmware: requesting b43/ucode13.fw
> > firmware: requesting b43/lp0initvals13.fw

Huh? lp0initvals?!

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080514/e58ee3f9/attachment.pgp>

From johannes at sipsolutions.net  Wed May 14 01:52:11 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 May 2008 01:52:11 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <1210722537.4279.43.camel@johannes.berg>
	(sfid-20080514_014950_992691_D85478C3)
References: <48294F0B.4040908@f-box.org>
	<1210721604.4279.40.camel@johannes.berg>
	<1210721764.4279.41.camel@johannes.berg>
	<200805140146.06910.mb@bu3sch.de>
	<1210722537.4279.43.camel@johannes.berg>
	(sfid-20080514_014950_992691_D85478C3)
Message-ID: <1210722731.4279.45.camel@johannes.berg>

On Wed, 2008-05-14 at 01:48 +0200, Johannes Berg wrote:
> > > b43-phy1 debug: Found PHY: Analog 4, Type 2, Revision 9
> > > b43-phy1 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> > > b43-phy1 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
> > > phy1: Selected rate control algorithm 'pid'
> > > Broadcom 43xx driver loaded [ Features: P, Firmware-ID: FW13 ]
> > > firmware: requesting b43/ucode13.fw
> > > firmware: requesting b43/lp0initvals13.fw
> 
> Huh? lp0initvals?!

Hmm. specs bug? But probably unrelated anyway since, well, it works for
other people.

We really need a raw monitor frame capture.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080514/d0b32c62/attachment.pgp>

From proski at gnu.org  Wed May 14 06:46:40 2008
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 14 May 2008 00:46:40 -0400
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <200805140127.22302.mb@bu3sch.de>
References: <48294F0B.4040908@f-box.org> <200805131119.09964.mb@bu3sch.de>
	<482A08A5.3000204@f-box.org>  <200805140127.22302.mb@bu3sch.de>
Message-ID: <1210740400.2721.56.camel@rd>

On Wed, 2008-05-14 at 01:27 +0200, Michael Buesch wrote:

> Where does this "wrong buffer size" message come from, and what does it mean?

net/mac80211/rx.c

There are two instances of that message, both in ieee80211_rx_h_amsdu(),
and both in the code path that returns RX_DROP_UNUSABLE.

I guess the code complains about some invalid frames and drops them.
Somebody with a better knowledge of the code should write better
descriptions and make the messages different.

-- 
Regards,
Pavel Roskin


From zajec5polish at gmail.com  Wed May 14 09:53:34 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Wed, 14 May 2008 09:53:34 +0200
Subject: b43 sometimes hangs on 4318 with nice conditions
Message-ID: <14b026160805140053w653ab27eo471c14e5489f227a@mail.gmail.com>

I use my notebook 1m from access point and I don't download or upload
a lot. Last time it happened when I was away from computer and I only
left GMail + 2 irc channels open. My problem is that my card gets
disconnected from AP and scanning doesn't show networks (I should
detect about 6).


# uname -a
Linux linux 2.6.25-rc9-17-default #1 SMP 2008-04-15 22:54:53 +0200
i686 athlon i386 GNU/Linux


# lspci
06:05.0 Network controller: Broadcom Corporation BCM4318 [AirForce One
54g] 802.11g Wireless LAN Controller (rev 02)


# iwconfig wlan0
wlan0     IEEE 802.11g  ESSID:""
          Mode:Managed  Frequency:2.447 GHz  Access Point: 00:14:BF:77:9A:C2
          Tx-Power=27 dBm
          Retry min limit:7   RTS thr:off   Fragment thr=2352 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


# iwlist wlan0 scan
wlan0     No scan results


# dmesg | grep b43
b43-phy0: Broadcom 4318 WLAN found
input: b43-phy0 as /devices/virtual/input/input10
b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::radio
b43-phy0: Radio hardware status changed to DISABLED
b43-phy0: Radio turned on by software
b43-phy0: The hardware RF-kill button still turns the radio physically
off. Press the button to turn it on.
b43-phy0: Radio hardware status changed to ENABLED
input: b43-phy0 as /devices/virtual/input/input13
b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::radio
input: b43-phy0 as /devices/virtual/input/input16
b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::radio


# tail /var/log/messages
May 14 09:29:25 linux klogd: wlan0: No ProbeResp from current AP
00:14:bf:77:9a:c2 - assume out of range
May 14 09:29:26 linux klogd: wlan0: Initial auth_alg=0
May 14 09:29:26 linux klogd: wlan0: authenticate with AP 00:14:bf:77:9a:c2
May 14 09:29:26 linux klogd: wlan0: Initial auth_alg=0
May 14 09:29:26 linux klogd: wlan0: authenticate with AP 00:14:bf:77:9a:c2
May 14 09:29:26 linux klogd: wlan0: Initial auth_alg=0
May 14 09:29:26 linux klogd: wlan0: authenticate with AP 00:14:bf:77:9a:c2
May 14 09:29:27 linux syslog-ng[1772]: last message repeated 2 times
May 14 09:29:27 linux klogd: wlan0: authentication with AP
00:14:bf:77:9a:c2 timed out
May 14 09:29:40 linux dhclient: caught deadly SIGTERM
May 14 09:29:40 linux dhclient: could not restore resolv.conf: No such
file or directory


Is this possible for you to guess what may be a reason seeing that
logs? Or should I provide something more?

-- 
Rafa? Mi?ecki

From zajec5polish at gmail.com  Wed May 14 09:57:32 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Wed, 14 May 2008 09:57:32 +0200
Subject: b43 sometimes hangs on 4318 with nice conditions
In-Reply-To: <14b026160805140053w653ab27eo471c14e5489f227a@mail.gmail.com>
References: <14b026160805140053w653ab27eo471c14e5489f227a@mail.gmail.com>
Message-ID: <14b026160805140057i843712auac01591e51fc2845@mail.gmail.com>

2008/5/14, Rafa? Mi?ecki <zajec5polish at gmail.com>:
>  My problem is that my card gets
>  disconnected from AP and scanning doesn't show networks (I should
>  detect about 6).

When I reload b43 module everything is fine again. However it still
would be nice to detect reason of this problem and fix if possible.
What happens after reloading module:


# dmesg | grep b43 | tail
b43-phy1: Broadcom 4318 WLAN found
input: b43-phy1 as /devices/virtual/input/input17
b43-phy1: Loading firmware version 410.2160 (2007-05-26 15:32:10)
Registered led device: b43-phy1::tx
Registered led device: b43-phy1::rx
Registered led device: b43-phy1::radio


# tail /var/log/messages
May 14 09:39:39 linux ifdown: Network interface is managed from NetworkManager
May 14 09:39:39 linux ifdown: NetworkManager cannot be advised to take
down an interface.
May 14 09:39:39 linux ifdown: Set up another interface instead.
May 14 09:39:39 linux ifdown:     wmaster0
May 14 09:39:39 linux ifdown: Interface not available and no
configuration found.
May 14 09:39:44 linux klogd: b43-phy1: Broadcom 4318 WLAN found
May 14 09:39:44 linux klogd: phy1: Selected rate control algorithm 'pid'
May 14 09:39:44 linux klogd: Broadcom 43xx driver loaded [ Features:
PMLR, Firmware-ID: FW13 ]
May 14 09:39:44 linux ifup: interface 'wmaster0' is a wlan helper
interface. Exiting.
May 14 09:39:44 linux ifup: Network interface is managed from NetworkManager
May 14 09:39:44 linux ifup: NetworkManager will be advised to set up wlan0
May 14 09:39:44 linux ifup: but it cannot be assured from here.
May 14 09:39:48 linux klogd: input: b43-phy1 as /devices/virtual/input/input17
May 14 09:39:49 linux klogd: b43-phy1: Loading firmware version
410.2160 (2007-05-26 15:32:10)
May 14 09:39:50 linux klogd: Registered led device: b43-phy1::tx
May 14 09:39:50 linux klogd: Registered led device: b43-phy1::rx
May 14 09:39:50 linux klogd: Registered led device: b43-phy1::radio
May 14 09:39:50 linux klogd: ADDRCONF(NETDEV_UP): wlan0: link is not ready
May 14 09:39:51 linux klogd: wlan0: Initial auth_alg=0
May 14 09:39:51 linux klogd: wlan0: authenticate with AP 00:15:e9:06:04:ea
May 14 09:39:52 linux syslog-ng[1772]: last message repeated 2 times
May 14 09:39:52 linux klogd: wlan0: authentication with AP
00:15:e9:06:04:ea timed out
May 14 09:39:59 linux klogd: wlan0: Initial auth_alg=0
May 14 09:39:59 linux klogd: wlan0: authenticate with AP 00:14:bf:77:9a:c2
May 14 09:39:59 linux klogd: wlan0: RX authentication from
00:14:bf:77:9a:c2 (alg=0 transaction=2 status=0)
May 14 09:39:59 linux klogd: wlan0: authenticated
May 14 09:39:59 linux klogd: wlan0: associate with AP 00:14:bf:77:9a:c2
May 14 09:39:59 linux klogd: wlan0: RX AssocResp from
00:14:bf:77:9a:c2 (capab=0x431 status=0 aid=1)
May 14 09:39:59 linux klogd: wlan0: associated
May 14 09:39:59 linux klogd: wlan0: switched to short barker preamble
(BSSID=00:14:bf:77:9a:c2)
May 14 09:39:59 linux klogd: ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
May 14 09:39:59 linux dhclient: Internet Systems Consortium DHCP Client V3.0.6
May 14 09:39:59 linux dhclient: Copyright 2004-2007 Internet Systems Consortium.
May 14 09:39:59 linux dhclient: All rights reserved.
May 14 09:39:59 linux dhclient: For info, please visit
http://www.isc.org/sw/dhcp/
May 14 09:39:59 linux dhclient:
May 14 09:39:59 linux dhclient: wmaster0: unknown hardware address type 801
May 14 09:39:59 linux dhclient: wmaster0: unknown hardware address type 801
May 14 09:39:59 linux dhclient: Listening on LPF/wlan0/00:0e:9b:c4:b0:42
May 14 09:39:59 linux dhclient: Sending on   LPF/wlan0/00:0e:9b:c4:b0:42
May 14 09:39:59 linux dhclient: Sending on   Socket/fallback
May 14 09:40:00 linux dhclient: DHCPDISCOVER on wlan0 to
255.255.255.255 port 67 interval 6
May 14 09:40:01 linux klogd: martian source 255.255.255.255 from
192.168.0.1, on dev wlan0
May 14 09:40:01 linux klogd: ll header:
ff:ff:ff:ff:ff:ff:00:14:bf:77:9a:c0:08:00
May 14 09:40:01 linux dhclient: DHCPOFFER from 192.168.0.1
May 14 09:40:01 linux dhclient: DHCPREQUEST on wlan0 to 255.255.255.255 port 67
May 14 09:40:01 linux klogd: martian source 255.255.255.255 from
192.168.0.1, on dev wlan0
May 14 09:40:01 linux klogd: ll header:
ff:ff:ff:ff:ff:ff:00:14:bf:77:9a:c0:08:00
May 14 09:40:01 linux dhclient: DHCPACK from 192.168.0.1
May 14 09:40:01 linux dhclient: bound to 192.168.0.2 -- renewal in
33154 seconds.
May 14 09:40:01 linux /usr/sbin/cron[9828]: (root) CMD (chown -R
zajec:users /home/zajec/shared/)
May 14 09:40:02 linux if-up.d/21-dhcpcd-hook-samba: No dhcpcd info nor
dhclient leases file found for wlan0.


-- 
Rafa? Mi?ecki

From fbicknel at nc.rr.com  Thu May 15 00:43:05 2008
From: fbicknel at nc.rr.com (fbicknel at nc.rr.com)
Date: Wed, 14 May 2008 18:43:05 -0400
Subject: bcm 4315
Message-ID: <2263254.125251210804985234.JavaMail.root@cdptpa-web09-z02>

Here are what seem to be the pertinent portions of dmesg output.  Let me know if you want the whole thing and I'll send it directly.

I don't know what all that corrupt SPROM CRC stuff is all about.  I followed the directions to extract the firmware to /lib/firmware using b43-fwcutter.  Not sure if that's the same thing, though.

Linux version 2.6.24-gentoo-r4 (root at tink) (gcc version 4.1.2 (Gentoo 4.1.2 p1.1)) #1 SMP Wed May 14 18:11:04 EDT 2008
[snip]
PCI: Setting latency timer of device 0000:02:00.0 to 64
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x16, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0F, vendor 0x4243)
ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x0A, vendor 0x4243)
ssb: Core 3 found: PCI-E (cc 0x820, rev 0x09, vendor 0x4243)
ssb: WARNING: Invalid SPROM CRC (corrupt SPROM)
ssb: Unsupported SPROM revision 255 detected. Will extract v1
WARNING: at drivers/ssb/main.c:883 ssb_tmslow_reject_bitmask()
Pid: 5404, comm: modprobe Not tainted 2.6.24-gentoo-r4 #1
 [<f96423a5>]  [<f9643293>]  [<f9645381>]  [<f9642981>]  [<f96446a5>]  [<f964420f>]  [<f9642e63>]  [<f9643f7c>]  [<f9642f67>]  [<c0339d7d>]  [<f96447cd>]  [<c033b853>]  [<c0398838>]  [<c0468689>]  [<c0398948>]  [<c039898e>]  [<c0397e4b>]  [<c039869f>]  [<c0398948>]  [<c03980f6>]  [<c033b990>]  [<f90c9040>]  [<c013717c>]  [<c013fded>]  [<f967c914>]  [<c03982a1>]  [<c0103dc2>]  =======================
ssb: Sonics Silicon Backplane found on PCI device 0000:02:00.0
[snip]

lspci -nnv output (for completeness)

02:00.0 Network controller [0280]: Broadcom Corporation BCM4310 USB Controller [14e4:4315] (rev 01)
	Subsystem: Hewlett-Packard Company Unknown device [103c:137c]
	Flags: bus master, fast devsel, latency 0, IRQ 17
	Memory at f4000000 (64-bit, non-prefetchable) [size=16K]
	Capabilities: [40] Power Management version 3
	Capabilities: [58] Vendor Specific Information <?>
	Capabilities: [e8] Message Signalled Interrupts: Mask- 64bit+ Queue=0/0 Enable-
	Capabilities: [d0] Express Endpoint, MSI 00
	Capabilities: [100] Advanced Error Reporting <?>
	Capabilities: [13c] Virtual Channel <?>
	Capabilities: [160] Device Serial Number 21-00-04-ff-ff-00-76-37
	Capabilities: [16c] Power Budgeting <?>
	Kernel driver in use: b43-pci-bridge
	Kernel modules: ssb

Here's what happens when I load b43:

fbicknel at tink ~ $ sudo b43load b43
Disabling bcm43xx ...	[OK]	Module disabled:
/lib/modules/2.6.24-gentoo-r4/kernel/drivers/net/wireless/bcm43xx/bcm43xx.ko
b43 loaded successfully
b43legacy loaded successfully
fbicknel at tink ~ $ 

modprobe -r b43 and modprobe -r b43legacy, then b43load b43 will add the following in dmesg, but this looks to be the same as before:

PCI: Setting latency timer of device 0000:02:00.0 to 64
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x16, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0F, vendor 0x4243)
ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x0A, vendor 0x4243)
ssb: Core 3 found: PCI-E (cc 0x820, rev 0x09, vendor 0x4243)
ssb: WARNING: Invalid SPROM CRC (corrupt SPROM)
ssb: Unsupported SPROM revision 255 detected. Will extract v1
WARNING: at drivers/ssb/main.c:883 ssb_tmslow_reject_bitmask()
Pid: 8904, comm: modprobe Not tainted 2.6.24-gentoo-r4 #1
 [<f96423a5>]  [<f9643293>]  [<f9645381>]  [<f9642981>]  [<f96446a5>]  [<f964420f>]  [<f9642e63>]  [<f9643f7c>]  [<f9642f67>]  [<c0339d7d>]  [<f96447cd>]  [<c033b853>]  [<c0398838>]  [<c0468689>]  [<c0398948>]  [<c039898e>]  [<c0397e4b>]  [<c039869f>]  [<c0398948>]  [<c03980f6>]  [<c033b990>]  [<f8926040>]  [<c013717c>]  [<c013fded>]  [<c03982a1>]  [<c0103dc2>]  =======================
ssb: Sonics Silicon Backplane found on PCI device 0000:02:00.0


Thanks in advance.

---- Michael Buesch <mb at bu3sch.de> wrote: 
> On Wednesday 07 May 2008 22:33:23 fbicknel at nc.rr.com wrote:
> > My apologies if I'm spamming the wrong list; please reply privately and I'll take this elsewhere if so.
> > 
> > I have a Bcm 4315 (not 18, not 03....) and it seems that this model is not listed anywhere in any references I can find; not even Broadcom's site.  Is it an OEM version of some other model by chance?
> > 
> > Anyone hear of lspci returning 4315?
> > 
> > 02:00.0 0280: 14e4:4315 (rev 01) 
> 
> Please apply the following patch and enable "Sonics Silicon Backplane Debugging"
> and "b43 debugging". Then send me the dmesg output.
> 
> Index: wireless-testing/drivers/ssb/b43_pci_bridge.c
> ===================================================================
> --- wireless-testing.orig/drivers/ssb/b43_pci_bridge.c	2008-02-16 19:08:13.000000000 +0100
> +++ wireless-testing/drivers/ssb/b43_pci_bridge.c	2008-05-08 14:55:38.000000000 +0200
> @@ -21,6 +21,7 @@ static const struct pci_device_id b43_pc
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4307) },
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4311) },
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4312) },
> +	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4315) },
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4318) },
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4319) },
>  	{ PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, 0x4320) },
> 
> 
> 
> -- 
> Greetings Michael.



From Larry.Finger at lwfinger.net  Thu May 15 15:34:47 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 15 May 2008 08:34:47 -0500
Subject: bcm 4315
In-Reply-To: <2263254.125251210804985234.JavaMail.root@cdptpa-web09-z02>
References: <2263254.125251210804985234.JavaMail.root@cdptpa-web09-z02>
Message-ID: <482C3BF7.90602@lwfinger.net>

fbicknel at nc.rr.com wrote:
> Here are what seem to be the pertinent portions of dmesg output.  Let me know if you want the whole thing and I'll send it directly.
> 
> I don't know what all that corrupt SPROM CRC stuff is all about.  I followed the directions to extract the firmware to /lib/firmware using b43-fwcutter.  Not sure if that's the same thing, though.
> 
> Linux version 2.6.24-gentoo-r4 (root at tink) (gcc version 4.1.2 (Gentoo 4.1.2 p1.1)) #1 SMP Wed May 14 18:11:04 EDT 2008
> [snip]
> PCI: Setting latency timer of device 0000:02:00.0 to 64
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x16, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0F, vendor 0x4243)
> ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x0A, vendor 0x4243)
> ssb: Core 3 found: PCI-E (cc 0x820, rev 0x09, vendor 0x4243)
> ssb: WARNING: Invalid SPROM CRC (corrupt SPROM)
> ssb: Unsupported SPROM revision 255 detected. Will extract v1
> WARNING: at drivers/ssb/main.c:883 ssb_tmslow_reject_bitmask()
> Pid: 5404, comm: modprobe Not tainted 2.6.24-gentoo-r4 #1
>  [<f96423a5>]  [<f9643293>]  [<f9645381>]  [<f9642981>]  [<f96446a5>]  [<f964420f>]  [<f9642e63>]  [<f9643f7c>]  [<f9642f67>]  [<c0339d7d>]  [<f96447cd>]  [<c033b853>]  [<c0398838>]  [<c0468689>]  [<c0398948>]  [<c039898e>]  [<c0397e4b>]  [<c039869f>]  [<c0398948>]  [<c03980f6>]  [<c033b990>]  [<f90c9040>]  [<c013717c>]  [<c013fded>]  [<f967c914>]  [<c03982a1>]  [<c0103dc2>]  =======================
> ssb: Sonics Silicon Backplane found on PCI device 0000:02:00.0
> [snip]
> 
> lspci -nnv output (for completeness)
> 
> 02:00.0 Network controller [0280]: Broadcom Corporation BCM4310 USB Controller [14e4:4315] (rev 01)

I also have one of these devices that are reported as a BCM4310 USB. It has
an LP-PHY, and is not supported by any current driver. It also has a rev 8
SPROM and we do not know where the information is stored in the PROM. In
fact, I am working on the reverse engineering in order to write the
specifications so that the driver can be modified.

As much as I hate to make this recommendation, your only recourse is to use
ndiswrapper and the Windows driver. I was fortunate enough to have a
BCM4311/2 on the shelf, which I used to replace the BCM4310 - at least for
the moment.

Larry





From dan at f-box.org  Thu May 15 17:13:16 2008
From: dan at f-box.org (Daniel)
Date: Thu, 15 May 2008 16:13:16 +0100
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <1210722731.4279.45.camel@johannes.berg>
References: <48294F0B.4040908@f-box.org>	<1210721604.4279.40.camel@johannes.berg>	<1210721764.4279.41.camel@johannes.berg>	<200805140146.06910.mb@bu3sch.de>	<1210722537.4279.43.camel@johannes.berg>	(sfid-20080514_014950_992691_D85478C3)
	<1210722731.4279.45.camel@johannes.berg>
Message-ID: <482C530C.8060101@f-box.org>

Hello,

Johannes Berg wrote:
> We really need a raw monitor frame capture.

Not sure how I go about that one?

I have an external RTL8187 device I can stick into monitor mode? But 
then it wouldn't be associated/encryption keys...

Tips anyone?



Cheers,

Dan.


From johannes at sipsolutions.net  Thu May 15 18:18:23 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 May 2008 18:18:23 +0200
Subject: 4311 v2 Bail - 2.6.26-rc2
In-Reply-To: <482C530C.8060101@f-box.org>
References: <48294F0B.4040908@f-box.org>
	<1210721604.4279.40.camel@johannes.berg>
	<1210721764.4279.41.camel@johannes.berg>	<200805140146.06910.mb@bu3sch.de>
	<1210722537.4279.43.camel@johannes.berg>
	(sfid-20080514_014950_992691_D85478C3)
	<1210722731.4279.45.camel@johannes.berg>
	<482C530C.8060101@f-box.org>
Message-ID: <1210868303.3900.11.camel@johannes.berg>


> > We really need a raw monitor frame capture.
> 
> Not sure how I go about that one?
> 
> I have an external RTL8187 device I can stick into monitor mode? But 
> then it wouldn't be associated/encryption keys...
> 
> Tips anyone?

In this case, adding a monitor interface to your local b43 machine (with
iw: http://wireless.kernel.org/en/users/Documentation/iw) might be
preferable.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080515/eca1f630/attachment.pgp>

From Larry.Finger at lwfinger.net  Thu May 15 21:07:36 2008
From: Larry.Finger at lwfinger.net (Larry.Finger at lwfinger.net)
Date: Thu, 15 May 2008 14:07:36 -0500
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores with rev
	13
Message-ID: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>

When the patch for the BCM4311 rev 2 was prepared, I misread the specs
and coded the wrong file name for the initvals firmware.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
seems to have zero effect on the performance of the device and can
be delayed.

Larry

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -1960,7 +1960,7 @@ static int b43_request_firmware(struct b
 		if ((rev >= 5) && (rev <= 10))
 			filename = "b0g0initvals5";
 		else if (rev >= 13)
-			filename = "lp0initvals13";
+			filename = "b0g0initvals13";
 		else
 			goto err_no_initvals;
 		break;


From mb at bu3sch.de  Thu May 15 21:39:04 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 May 2008 21:39:04 +0200
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores with
	rev 13
In-Reply-To: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
References: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
Message-ID: <200805152139.05081.mb@bu3sch.de>

On Thursday 15 May 2008 21:07:36 Larry.Finger at lwfinger.net wrote:
> When the patch for the BCM4311 rev 2 was prepared, I misread the specs
> and coded the wrong file name for the initvals firmware.

You didn't misread it. The specs changed recently.
And I think the bsinitvals also have to be rechecked.
I'll do the right patch later, which also takes care of
the LP-PHY

> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
> seems to have zero effect on the performance of the device and can
> be delayed.

Exactly. That's why I decided to delay it :P

> Larry
> 
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c
> +++ wireless-testing/drivers/net/wireless/b43/main.c
> @@ -1960,7 +1960,7 @@ static int b43_request_firmware(struct b
>  		if ((rev >= 5) && (rev <= 10))
>  			filename = "b0g0initvals5";
>  		else if (rev >= 13)
> -			filename = "lp0initvals13";
> +			filename = "b0g0initvals13";
>  		else
>  			goto err_no_initvals;
>  		break;
> 
> 



-- 
Greetings Michael.


From proski at gnu.org  Thu May 15 21:53:48 2008
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 15 May 2008 15:53:48 -0400
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores
	with rev 13
In-Reply-To: <200805152139.05081.mb@bu3sch.de>
References: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
	<200805152139.05081.mb@bu3sch.de>
Message-ID: <1210881228.15053.4.camel@dv>

On Thu, 2008-05-15 at 21:39 +0200, Michael Buesch wrote:

> > This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
> > seems to have zero effect on the performance of the device and can
> > be delayed.
> 
> Exactly. That's why I decided to delay it :P

Actually, it it's a bug and there is a simple fix unlikely to break
anything, it should go to 2.6.26.  The whole point of having release
candidates is fixing bugs.  If nothing else, the fix should be applied
out of respect to the users of 2.6.26 who will be wondering where to get
"lp0initvals13".

It's just a suggestion, I'm not trying to start a flamewar :-)

-- 
Regards,
Pavel Roskin


From mb at bu3sch.de  Thu May 15 22:10:55 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 May 2008 22:10:55 +0200
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores with
	rev 13
In-Reply-To: <1210881228.15053.4.camel@dv>
References: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
	<200805152139.05081.mb@bu3sch.de> <1210881228.15053.4.camel@dv>
Message-ID: <200805152210.55836.mb@bu3sch.de>

On Thursday 15 May 2008 21:53:48 Pavel Roskin wrote:
> On Thu, 2008-05-15 at 21:39 +0200, Michael Buesch wrote:
> 
> > > This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
> > > seems to have zero effect on the performance of the device and can
> > > be delayed.
> > 
> > Exactly. That's why I decided to delay it :P
> 
> Actually, it it's a bug and there is a simple fix unlikely to break

Oh well. "unlikely to break" is it in your opinion, only.
One fact is that current code does work fine. Another one is that the
right initvals, which would be used after the fix, are obviously untested.

-- 
Greetings Michael.


From linville at tuxdriver.com  Thu May 15 21:46:24 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Thu, 15 May 2008 15:46:24 -0400
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores
	with rev 13
In-Reply-To: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
References: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
Message-ID: <20080515194624.GA25905@tuxdriver.com>

On Thu, May 15, 2008 at 02:07:36PM -0500, Larry.Finger at lwfinger.net wrote:
> When the patch for the BCM4311 rev 2 was prepared, I misread the specs
> and coded the wrong file name for the initvals firmware.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
> seems to have zero effect on the performance of the device and can
> be delayed.

Would you prefer to have it in 2.6.26 "just in case"?  Or might that
cause a problem somehow?

John
-- 
John W. Linville
linville at tuxdriver.com


From Larry.Finger at lwfinger.net  Fri May 16 03:39:19 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 15 May 2008 20:39:19 -0500
Subject: [PATCH] b43: Fix typo in firmware file name for 802.11 cores
	with rev 13
In-Reply-To: <200805152210.55836.mb@bu3sch.de>
References: <482c89f8.atvjHdrfvDUg0wyK%Larry.Finger@lwfinger.net>
	<200805152139.05081.mb@bu3sch.de> <1210881228.15053.4.camel@dv>
	<200805152210.55836.mb@bu3sch.de>
Message-ID: <482CE5C7.6040802@lwfinger.net>

Michael Buesch wrote:
> On Thursday 15 May 2008 21:53:48 Pavel Roskin wrote:
>> On Thu, 2008-05-15 at 21:39 +0200, Michael Buesch wrote:
>>
>>>> This is 2.6.27 material. Although it is a bug in 2.6.25 and .26, it
>>>> seems to have zero effect on the performance of the device and can
>>>> be delayed.
>>> Exactly. That's why I decided to delay it :P
>> Actually, it it's a bug and there is a simple fix unlikely to break
> 
> Oh well. "unlikely to break" is it in your opinion, only.
> One fact is that current code does work fine. Another one is that the
> right initvals, which would be used after the fix, are obviously untested.
> 

Not exactly untested. I've been running for 2 days with this patch in and 
have seen no bad effects. My 4311/2 and the G part of 4312/2 are the only 
cards that will be affected.

Larry



From mb at bu3sch.de  Sat May 17 22:44:35 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 May 2008 22:44:35 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
Message-ID: <200805172244.35966.mb@bu3sch.de>

This patch adds some hooks for firmware debugging.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is for 2.6.27


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-15 23:31:37.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-17 20:22:56.000000000 +0200
@@ -419,12 +419,18 @@ enum {
 					 B43_IRQ_TXFIFO_FLUSH_OK | \
 					 B43_IRQ_NOISESAMPLE_OK | \
 					 B43_IRQ_UCODE_DEBUG | \
 					 B43_IRQ_RFKILL | \
 					 B43_IRQ_TX_OK)
 
+/* Debug-IRQ reasons. */
+#define B43_DEBUGIRQ_PANIC		0	/* The firmware panic'ed */
+#define B43_DEBUGIRQ_DUMP_SHM		1	/* Dump shared SHM */
+#define B43_DEBUGIRQ_DUMP_REGS		2	/* Dump the microcode registers */
+#define B43_DEBUGIRQ_ACK		0xFFFF	/* The host writes that to ACK the IRQ */
+
 /* Device specific rate values.
  * The actual values defined here are (rate_in_mbps * 2).
  * Some code depends on this. Don't change it. */
 #define B43_CCK_RATE_1MB		0x02
 #define B43_CCK_RATE_2MB		0x04
 #define B43_CCK_RATE_5MB		0x0B
@@ -763,12 +769,15 @@ struct b43_firmware {
 	struct b43_firmware_file initvals_band;
 
 	/* Firmware revision */
 	u16 rev;
 	/* Firmware patchlevel */
 	u16 patch;
+
+	/* Set to true, if we are using an opensource firmware. */
+	bool opensource;
 };
 
 /* Device (802.11 core) initialization status. */
 enum {
 	B43_STAT_UNINIT = 0,	/* Uninitialized. */
 	B43_STAT_INITIALIZED = 1,	/* Initialized, but not started, yet. */
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-15 23:31:37.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-17 22:35:00.000000000 +0200
@@ -1663,13 +1663,70 @@ static void b43_set_beacon_int(struct b4
 	b43_time_unlock(dev);
 	b43dbg(dev->wl, "Set beacon interval to %u\n", beacon_int);
 }
 
 static void handle_irq_ucode_debug(struct b43_wldev *dev)
 {
-	//TODO
+	unsigned int i, cnt;
+	u16 reason;
+	__le16 *buf;
+
+	/* The proprietary firmware doesn't have this IRQ. */
+	if (!dev->fw.opensource)
+		return;
+
+	/* Microcode register 63 contains the debug-IRQ reason. */
+	reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 63);
+	switch (reason) {
+	case B43_DEBUGIRQ_PANIC:
+		/* The reason for the panic is in register 3. */
+		reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 3);
+		b43err(dev->wl, "Whoopsy, the microcode panic'ed! Reason: %u\n",
+		       reason);
+		b43_controller_restart(dev, "Microcode panic");
+		break;
+	case B43_DEBUGIRQ_DUMP_SHM:
+		if (!B43_DEBUG)
+			break; /* Only with driver debugging enabled. */
+		buf = kmalloc(4096, GFP_ATOMIC);
+		if (!buf) {
+			b43dbg(dev->wl, "SHM-dump: Failed to allocate memory\n");
+			goto out;
+		}
+		for (i = 0; i < 4096; i += 2) {
+			u16 tmp = b43_shm_read16(dev, B43_SHM_SHARED, i);
+			buf[i / 2] = cpu_to_le16(tmp);
+		}
+		b43info(dev->wl, "Shared memory dump:\n");
+		print_hex_dump(KERN_INFO, "", DUMP_PREFIX_OFFSET,
+			       16, 2, buf, 4096, 1);
+		kfree(buf);
+		break;
+	case B43_DEBUGIRQ_DUMP_REGS:
+		if (!B43_DEBUG)
+			break; /* Only with driver debugging enabled. */
+		b43info(dev->wl, "Microcode register dump:\n");
+		for (i = 0, cnt = 0; i < 64; i++) {
+			u16 tmp = b43_shm_read16(dev, B43_SHM_SCRATCH, i);
+			if (cnt == 0)
+				printk(KERN_INFO);
+			printk("r%02u: 0x%04X  ", i, tmp);
+			cnt++;
+			if (cnt == 6) {
+				printk("\n");
+				cnt = 0;
+			}
+		}
+		printk("\n");
+		break;
+	default:
+		b43dbg(dev->wl, "Debug-IRQ triggered for unknown reason: %u\n",
+		       reason);
+	}
+out:
+	b43_shm_write16(dev, B43_SHM_SCRATCH, 63, B43_DEBUGIRQ_ACK);
 }
 
 /* Interrupt handler bottom-half */
 static void b43_interrupt_tasklet(struct b43_wldev *dev)
 {
 	u32 reason;
@@ -2121,20 +2178,28 @@ static int b43_upload_microcode(struct b
 		       "binary drivers older than version 4.x is unsupported. "
 		       "You must upgrade your firmware files.\n");
 		b43_print_fw_helptext(dev->wl, 1);
 		err = -EOPNOTSUPP;
 		goto error;
 	}
-	b43info(dev->wl, "Loading firmware version %u.%u "
-		"(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)\n",
-		fwrev, fwpatch,
-		(fwdate >> 12) & 0xF, (fwdate >> 8) & 0xF, fwdate & 0xFF,
-		(fwtime >> 11) & 0x1F, (fwtime >> 5) & 0x3F, fwtime & 0x1F);
-
 	dev->fw.rev = fwrev;
 	dev->fw.patch = fwpatch;
+	dev->fw.opensource = (fwdate == 0xFFFF);
+
+	if (dev->fw.opensource) {
+		/* Patchlevel info is encoded in the "time" field. */
+		dev->fw.patch = fwtime;
+		b43info(dev->wl, "Loading OpenSource firmware version %u.%u\n",
+			dev->fw.rev, dev->fw.patch);
+	} else {
+		b43info(dev->wl, "Loading firmware version %u.%u "
+			"(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)\n",
+			fwrev, fwpatch,
+			(fwdate >> 12) & 0xF, (fwdate >> 8) & 0xF, fwdate & 0xFF,
+			(fwtime >> 11) & 0x1F, (fwtime >> 5) & 0x3F, fwtime & 0x1F);
+	}
 
 	if (b43_is_old_txhdr_format(dev)) {
 		b43warn(dev->wl, "You are using an old firmware image. "
 			"Support for old firmware will be removed in July 2008.\n");
 		b43_print_fw_helptext(dev->wl, 0);
 	}


From netrolller.3d at gmail.com  Sat May 17 23:21:22 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 17 May 2008 23:21:22 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <200805172244.35966.mb@bu3sch.de>
References: <200805172244.35966.mb@bu3sch.de>
Message-ID: <69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>

On Sat, May 17, 2008 at 10:44 PM, Michael Buesch <mb at bu3sch.de> wrote:
> This patch adds some hooks for firmware debugging.
>
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
>
> ---
>
> John, this is for 2.6.27
>
>
> Index: wireless-testing/drivers/net/wireless/b43/b43.h
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/b43.h        2008-05-15 23:31:37.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/b43.h     2008-05-17 20:22:56.000000000 +0200
> @@ -419,12 +419,18 @@ enum {
>                                         B43_IRQ_TXFIFO_FLUSH_OK | \
>                                         B43_IRQ_NOISESAMPLE_OK | \
>                                         B43_IRQ_UCODE_DEBUG | \
>                                         B43_IRQ_RFKILL | \
>                                         B43_IRQ_TX_OK)
>
> +/* Debug-IRQ reasons. */
> +#define B43_DEBUGIRQ_PANIC             0       /* The firmware panic'ed */
> +#define B43_DEBUGIRQ_DUMP_SHM          1       /* Dump shared SHM */
> +#define B43_DEBUGIRQ_DUMP_REGS         2       /* Dump the microcode registers */
> +#define B43_DEBUGIRQ_ACK               0xFFFF  /* The host writes that to ACK the IRQ */
> +
>  /* Device specific rate values.
>  * The actual values defined here are (rate_in_mbps * 2).
>  * Some code depends on this. Don't change it. */
>  #define B43_CCK_RATE_1MB               0x02
>  #define B43_CCK_RATE_2MB               0x04
>  #define B43_CCK_RATE_5MB               0x0B
> @@ -763,12 +769,15 @@ struct b43_firmware {
>        struct b43_firmware_file initvals_band;
>
>        /* Firmware revision */
>        u16 rev;
>        /* Firmware patchlevel */
>        u16 patch;
> +
> +       /* Set to true, if we are using an opensource firmware. */
> +       bool opensource;
>  };
>
>  /* Device (802.11 core) initialization status. */
>  enum {
>        B43_STAT_UNINIT = 0,    /* Uninitialized. */
>        B43_STAT_INITIALIZED = 1,       /* Initialized, but not started, yet. */
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c       2008-05-15 23:31:37.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/main.c    2008-05-17 22:35:00.000000000 +0200
> @@ -1663,13 +1663,70 @@ static void b43_set_beacon_int(struct b4
>        b43_time_unlock(dev);
>        b43dbg(dev->wl, "Set beacon interval to %u\n", beacon_int);
>  }
>
>  static void handle_irq_ucode_debug(struct b43_wldev *dev)
>  {
> -       //TODO
> +       unsigned int i, cnt;
> +       u16 reason;
> +       __le16 *buf;
> +
> +       /* The proprietary firmware doesn't have this IRQ. */
> +       if (!dev->fw.opensource)
> +               return;
> +
> +       /* Microcode register 63 contains the debug-IRQ reason. */
> +       reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 63);
> +       switch (reason) {
> +       case B43_DEBUGIRQ_PANIC:
> +               /* The reason for the panic is in register 3. */
> +               reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 3);
> +               b43err(dev->wl, "Whoopsy, the microcode panic'ed! Reason: %u\n",
> +                      reason);
> +               b43_controller_restart(dev, "Microcode panic");
> +               break;
> +       case B43_DEBUGIRQ_DUMP_SHM:
> +               if (!B43_DEBUG)
> +                       break; /* Only with driver debugging enabled. */
> +               buf = kmalloc(4096, GFP_ATOMIC);
> +               if (!buf) {
> +                       b43dbg(dev->wl, "SHM-dump: Failed to allocate memory\n");
> +                       goto out;
> +               }
> +               for (i = 0; i < 4096; i += 2) {
> +                       u16 tmp = b43_shm_read16(dev, B43_SHM_SHARED, i);
> +                       buf[i / 2] = cpu_to_le16(tmp);
> +               }
> +               b43info(dev->wl, "Shared memory dump:\n");
> +               print_hex_dump(KERN_INFO, "", DUMP_PREFIX_OFFSET,
> +                              16, 2, buf, 4096, 1);
> +               kfree(buf);
> +               break;
> +       case B43_DEBUGIRQ_DUMP_REGS:
> +               if (!B43_DEBUG)
> +                       break; /* Only with driver debugging enabled. */
> +               b43info(dev->wl, "Microcode register dump:\n");
> +               for (i = 0, cnt = 0; i < 64; i++) {
> +                       u16 tmp = b43_shm_read16(dev, B43_SHM_SCRATCH, i);
> +                       if (cnt == 0)
> +                               printk(KERN_INFO);
> +                       printk("r%02u: 0x%04X  ", i, tmp);
> +                       cnt++;
> +                       if (cnt == 6) {
> +                               printk("\n");
> +                               cnt = 0;
> +                       }
> +               }
> +               printk("\n");
> +               break;
> +       default:
> +               b43dbg(dev->wl, "Debug-IRQ triggered for unknown reason: %u\n",
> +                      reason);
> +       }
> +out:
> +       b43_shm_write16(dev, B43_SHM_SCRATCH, 63, B43_DEBUGIRQ_ACK);
>  }
>
>  /* Interrupt handler bottom-half */
>  static void b43_interrupt_tasklet(struct b43_wldev *dev)
>  {
>        u32 reason;
> @@ -2121,20 +2178,28 @@ static int b43_upload_microcode(struct b
>                       "binary drivers older than version 4.x is unsupported. "
>                       "You must upgrade your firmware files.\n");
>                b43_print_fw_helptext(dev->wl, 1);
>                err = -EOPNOTSUPP;
>                goto error;
>        }
> -       b43info(dev->wl, "Loading firmware version %u.%u "
> -               "(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)\n",
> -               fwrev, fwpatch,
> -               (fwdate >> 12) & 0xF, (fwdate >> 8) & 0xF, fwdate & 0xFF,
> -               (fwtime >> 11) & 0x1F, (fwtime >> 5) & 0x3F, fwtime & 0x1F);
> -
>        dev->fw.rev = fwrev;
>        dev->fw.patch = fwpatch;
> +       dev->fw.opensource = (fwdate == 0xFFFF);
> +
> +       if (dev->fw.opensource) {
> +               /* Patchlevel info is encoded in the "time" field. */
> +               dev->fw.patch = fwtime;
> +               b43info(dev->wl, "Loading OpenSource firmware version %u.%u\n",
> +                       dev->fw.rev, dev->fw.patch);
> +       } else {
> +               b43info(dev->wl, "Loading firmware version %u.%u "
> +                       "(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)\n",
> +                       fwrev, fwpatch,
> +                       (fwdate >> 12) & 0xF, (fwdate >> 8) & 0xF, fwdate & 0xFF,
> +                       (fwtime >> 11) & 0x1F, (fwtime >> 5) & 0x3F, fwtime & 0x1F);
> +       }
>
>        if (b43_is_old_txhdr_format(dev)) {
>                b43warn(dev->wl, "You are using an old firmware image. "
>                        "Support for old firmware will be removed in July 2008.\n");
>                b43_print_fw_helptext(dev->wl, 0);
>        }
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

Hmm... what's this? Are we planning something along the lines of
prism54's FreeMAC?

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sat May 17 23:24:13 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 May 2008 23:24:13 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>
References: <200805172244.35966.mb@bu3sch.de>
	<69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>
Message-ID: <200805172324.13818.mb@bu3sch.de>

On Saturday 17 May 2008 23:21:22 Stefanik G?bor wrote:
> Hmm... what's this? Are we planning something along the lines of
> prism54's FreeMAC?

http://bu3sch.de/gitweb?p=b43-ucode.git;a=summary

Doesn't work, yet. So you don't need to try. ;)

-- 
Greetings Michael.


From zajec5polish at gmail.com  Sat May 17 23:31:02 2008
From: zajec5polish at gmail.com (=?UTF-8?Q?Rafa=C5=82_Mi=C5=82ecki?=)
Date: Sat, 17 May 2008 23:31:02 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <200805172324.13818.mb@bu3sch.de>
References: <200805172244.35966.mb@bu3sch.de>
	<69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>
	<200805172324.13818.mb@bu3sch.de>
Message-ID: <14b026160805171431y7e758ef2tf8c9c85408e20aa5@mail.gmail.com>

2008/5/17, Michael Buesch <mb at bu3sch.de>:
> On Saturday 17 May 2008 23:21:22 Stefanik G?bor wrote:
>  > Hmm... what's this? Are we planning something along the lines of
>  > prism54's FreeMAC?
>
>
> http://bu3sch.de/gitweb?p=b43-ucode.git;a=summary
>
>  Doesn't work, yet. So you don't need to try. ;)

Oh man, open source fw? That's so nice to hear that! I extremly hope
you will able to make this working!

Open fw could be included in any distro, right?

-- 
Rafa? Mi?ecki

From mb at bu3sch.de  Sat May 17 23:43:57 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 May 2008 23:43:57 +0200
Subject: [PATCH] b43: Allow running without PCM firmware
Message-ID: <200805172343.57558.mb@bu3sch.de>

This patch adds code to allow running the device without PCM firmware loaded.
Without PCM firmware we don't have hardware accelerated crypto on
devices with a core rev <= 10.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is for 2.6.27


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-17 20:22:56.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-17 23:09:09.000000000 +0200
@@ -772,12 +772,16 @@ struct b43_firmware {
 	u16 rev;
 	/* Firmware patchlevel */
 	u16 patch;
 
 	/* Set to true, if we are using an opensource firmware. */
 	bool opensource;
+	/* Set to true, if the core needs a PCM firmware, but
+	 * we failed to load one. This is always false for
+	 * core rev > 10, as these don't need PCM firmware. */
+	bool pcm_request_failed;
 };
 
 /* Device (802.11 core) initialization status. */
 enum {
 	B43_STAT_UNINIT = 0,	/* Uninitialized. */
 	B43_STAT_INITIALIZED = 1,	/* Initialized, but not started, yet. */
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-17 22:35:00.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-17 23:33:15.000000000 +0200
@@ -1907,13 +1907,14 @@ static void b43_print_fw_helptext(struct
 	else
 		b43warn(wl, text);
 }
 
 static int do_request_fw(struct b43_wldev *dev,
 			 const char *name,
-			 struct b43_firmware_file *fw)
+			 struct b43_firmware_file *fw,
+			 bool silent)
 {
 	char path[sizeof(modparam_fwpostfix) + 32];
 	const struct firmware *blob;
 	struct b43_fw_header *hdr;
 	u32 size;
 	int err;
@@ -1931,15 +1932,21 @@ static int do_request_fw(struct b43_wlde
 	}
 
 	snprintf(path, ARRAY_SIZE(path),
 		 "b43%s/%s.fw",
 		 modparam_fwpostfix, name);
 	err = request_firmware(&blob, path, dev->dev->dev);
-	if (err) {
-		b43err(dev->wl, "Firmware file \"%s\" not found "
-		       "or load failed.\n", path);
+	if (err == -ENOENT) {
+		if (!silent) {
+			b43err(dev->wl, "Firmware file \"%s\" not found\n",
+			       path);
+		}
+		return err;
+	} else if (err) {
+		b43err(dev->wl, "Firmware file \"%s\" request failed (err=%d)\n",
+		       path, err);
 		return err;
 	}
 	if (blob->size < sizeof(struct b43_fw_header))
 		goto err_format;
 	hdr = (struct b43_fw_header *)(blob->data);
 	switch (hdr->type) {
@@ -1984,25 +1991,30 @@ static int b43_request_firmware(struct b
 	else if ((rev >= 11) && (rev <= 12))
 		filename = "ucode11";
 	else if (rev >= 13)
 		filename = "ucode13";
 	else
 		goto err_no_ucode;
-	err = do_request_fw(dev, filename, &fw->ucode);
+	err = do_request_fw(dev, filename, &fw->ucode, 0);
 	if (err)
 		goto err_load;
 
 	/* Get PCM code */
 	if ((rev >= 5) && (rev <= 10))
 		filename = "pcm5";
 	else if (rev >= 11)
 		filename = NULL;
 	else
 		goto err_no_pcm;
-	err = do_request_fw(dev, filename, &fw->pcm);
-	if (err)
+	fw->pcm_request_failed = 0;
+	err = do_request_fw(dev, filename, &fw->pcm, 1);
+	if (err == -ENOENT) {
+		/* We did not find a PCM file? Not fatal, but
+		 * core rev <= 10 must do without hwcrypto then. */
+		fw->pcm_request_failed = 1;
+	} else if (err)
 		goto err_load;
 
 	/* Get initvals */
 	switch (dev->phy.type) {
 	case B43_PHYTYPE_A:
 		if ((rev >= 5) && (rev <= 10)) {
@@ -2027,13 +2039,13 @@ static int b43_request_firmware(struct b
 		else
 			goto err_no_initvals;
 		break;
 	default:
 		goto err_no_initvals;
 	}
-	err = do_request_fw(dev, filename, &fw->initvals);
+	err = do_request_fw(dev, filename, &fw->initvals, 0);
 	if (err)
 		goto err_load;
 
 	/* Get bandswitch initvals */
 	switch (dev->phy.type) {
 	case B43_PHYTYPE_A:
@@ -2061,13 +2073,13 @@ static int b43_request_firmware(struct b
 		else
 			goto err_no_initvals;
 		break;
 	default:
 		goto err_no_initvals;
 	}
-	err = do_request_fw(dev, filename, &fw->initvals_band);
+	err = do_request_fw(dev, filename, &fw->initvals_band, 0);
 	if (err)
 		goto err_load;
 
 	return 0;
 
 err_load:
@@ -2185,20 +2197,26 @@ static int b43_upload_microcode(struct b
 	dev->fw.patch = fwpatch;
 	dev->fw.opensource = (fwdate == 0xFFFF);
 
 	if (dev->fw.opensource) {
 		/* Patchlevel info is encoded in the "time" field. */
 		dev->fw.patch = fwtime;
-		b43info(dev->wl, "Loading OpenSource firmware version %u.%u\n",
-			dev->fw.rev, dev->fw.patch);
+		b43info(dev->wl, "Loading OpenSource firmware version %u.%u%s\n",
+			dev->fw.rev, dev->fw.patch,
+			dev->fw.pcm_request_failed ? " (Hardware crypto not supported)" : "");
 	} else {
 		b43info(dev->wl, "Loading firmware version %u.%u "
 			"(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)\n",
 			fwrev, fwpatch,
 			(fwdate >> 12) & 0xF, (fwdate >> 8) & 0xF, fwdate & 0xFF,
 			(fwtime >> 11) & 0x1F, (fwtime >> 5) & 0x3F, fwtime & 0x1F);
+		if (dev->fw.pcm_request_failed) {
+			b43warn(dev->wl, "No \"pcm5.fw\" firmware file found. "
+				"Hardware accelerated cryptography is disabled.\n");
+			b43_print_fw_helptext(dev->wl, 0);
+		}
 	}
 
 	if (b43_is_old_txhdr_format(dev)) {
 		b43warn(dev->wl, "You are using an old firmware image. "
 			"Support for old firmware will be removed in July 2008.\n");
 		b43_print_fw_helptext(dev->wl, 0);
@@ -3358,12 +3376,19 @@ static int b43_op_set_key(struct ieee802
 
 	dev = wl->current_dev;
 	err = -ENODEV;
 	if (!dev || b43_status(dev) < B43_STAT_INITIALIZED)
 		goto out_unlock;
 
+	if (dev->fw.pcm_request_failed) {
+		/* We don't have firmware for the crypto engine.
+		 * Must use software-crypto. */
+		err = -EOPNOTSUPP;
+		goto out_unlock;
+	}
+
 	err = -EINVAL;
 	switch (key->alg) {
 	case ALG_WEP:
 		if (key->keylen == 5)
 			algorithm = B43_SEC_ALGO_WEP40;
 		else


From netrolller.3d at gmail.com  Sun May 18 00:27:49 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sun, 18 May 2008 00:27:49 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <200805172324.13818.mb@bu3sch.de>
References: <200805172244.35966.mb@bu3sch.de>
	<69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>
	<200805172324.13818.mb@bu3sch.de>
Message-ID: <69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>

On Sat, May 17, 2008 at 11:24 PM, Michael Buesch <mb at bu3sch.de> wrote:
> On Saturday 17 May 2008 23:21:22 Stefanik G?bor wrote:
>> Hmm... what's this? Are we planning something along the lines of
>> prism54's FreeMAC?
>
> http://bu3sch.de/gitweb?p=b43-ucode.git;a=summary
>
> Doesn't work, yet. So you don't need to try. ;)
>
> --
> Greetings Michael.
>

Hmm, are we calling this "Broadcom BCM43xx Microcode" instead of
"Broadcom AirForce One Microcode" for licensing/trademark reasons? The
official name of these cards is AirForce One.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sun May 18 00:35:04 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 18 May 2008 00:35:04 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
References: <200805172244.35966.mb@bu3sch.de> <200805172324.13818.mb@bu3sch.de>
	<69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
Message-ID: <200805180035.04341.mb@bu3sch.de>

On Sunday 18 May 2008 00:27:49 Stefanik G?bor wrote:
> On Sat, May 17, 2008 at 11:24 PM, Michael Buesch <mb at bu3sch.de> wrote:
> > On Saturday 17 May 2008 23:21:22 Stefanik G?bor wrote:
> >> Hmm... what's this? Are we planning something along the lines of
> >> prism54's FreeMAC?
> >
> > http://bu3sch.de/gitweb?p=b43-ucode.git;a=summary
> >
> > Doesn't work, yet. So you don't need to try. ;)
> >
> > --
> > Greetings Michael.
> >
> 
> Hmm, are we calling this "Broadcom BCM43xx Microcode" instead of
> "Broadcom AirForce One Microcode" for licensing/trademark reasons? The
> official name of these cards is AirForce One.

That's the first time I hear that, so it's most likely not _that_ official. ;)

And quite honestly, I don't care at all playing bullshit-bingo with buzzwords.
The device has the product number 43XX, so we identify it that way.

-- 
Greetings Michael.


From netrolller.3d at gmail.com  Sun May 18 00:43:00 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sun, 18 May 2008 00:43:00 +0200
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <200805180035.04341.mb@bu3sch.de>
References: <200805172244.35966.mb@bu3sch.de> <200805172324.13818.mb@bu3sch.de>
	<69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
	<200805180035.04341.mb@bu3sch.de>
Message-ID: <69e28c910805171543u27a542b0nf2ab86e5702660e@mail.gmail.com>

On Sun, May 18, 2008 at 12:35 AM, Michael Buesch <mb at bu3sch.de> wrote:
> On Sunday 18 May 2008 00:27:49 Stefanik G?bor wrote:
>> On Sat, May 17, 2008 at 11:24 PM, Michael Buesch <mb at bu3sch.de> wrote:
>> Hmm, are we calling this "Broadcom BCM43xx Microcode" instead of
>> "Broadcom AirForce One Microcode" for licensing/trademark reasons? The
>> official name of these cards is AirForce One.
>
> That's the first time I hear that, so it's most likely not _that_ official. ;)
>
> And quite honestly, I don't care at all playing bullshit-bingo with buzzwords.
> The device has the product number 43XX, so we identify it that way.
>
> --
> Greetings Michael.
>

Another question: is this legal in the US? AFAIK this might conflict
with FCC regulations. (Not sure about EU.)

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Sun May 18 01:33:55 2008
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 17 May 2008 18:33:55 -0500
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
References: <200805172244.35966.mb@bu3sch.de>	<69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>	<200805172324.13818.mb@bu3sch.de>
	<69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
Message-ID: <482F6B63.9080706@lwfinger.net>

Stefanik G?bor wrote:
> 
> Hmm, are we calling this "Broadcom BCM43xx Microcode" instead of
> "Broadcom AirForce One Microcode" for licensing/trademark reasons? The
> official name of these cards is AirForce One.
> 

Some of these cards may be called AirForce One; however, I have 7 different 
cards of varying form factor, and none of them have that name!

Larry




From zappacky.lists at gmail.com  Sun May 18 13:29:17 2008
From: zappacky.lists at gmail.com (Zappacky)
Date: Sun, 18 May 2008 07:29:17 -0400
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <69e28c910805171543u27a542b0nf2ab86e5702660e@mail.gmail.com>
References: <200805172244.35966.mb@bu3sch.de>
	<200805172324.13818.mb@bu3sch.de>	<69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>	<200805180035.04341.mb@bu3sch.de>
	<69e28c910805171543u27a542b0nf2ab86e5702660e@mail.gmail.com>
Message-ID: <4830130D.6020401@gmail.com>

Stefanik G?bor wrote:
> 
> Another question: is this legal in the US? AFAIK this might conflict
> with FCC regulations. (Not sure about EU.)
> 


Although I don't claim to be a lawyer, I found this information from 
http://www.softwarefreedom.org/resources/2007/fcc-sdr-whitepaper.html, 
which is a translation of the FCC's rules regarding software defined 
radios (including 802.11 chips).

Snippet 1:

The rules require any manufacturer certifying a device under the new 
process to take steps to prevent ?unauthorized? changes to the software 
on the device that might alter its radio frequency and power parameters 
in a way that takes it out of compliance with the regulations known as 
FCC Part 15 regulations.2 The specific technology implemented to 
accomplish this task is left to the manufacturers seeking certification, 
although the FCC suggests several possible mechanisms that can serve as 
such ?security measures.?3

Snippet 2:

Since software is a representation of a mathematical algorithm, it is 
not a ?device?, ?home electronic equipment? or a ?home electronic ... 
system.?17 Further, there is no precedent for applying the device 
certification rules to software except as installed as a component of a 
specific hardware device. Indeed, the FCC has explicitly limited the 
certification requirements to ?hardware-based device[s].?18 Both of 
these facts make it clear that the FCC rules do not apply to software by 
itself, but only to hardware-based devices.


What I get out of this, and out of poking in the legal babble, is that 
as long as our firmware doesn't cause the hardware itself to violate FCC 
specs, we're in the clear. According to Snippet 1, it shouldn't even be 
possible to violate the specifications, but we all know how good 
manufacturers are at stuff like that ;P.

-Andrew/Zappacky

(IANAL, Proceed at your own risk, etc)


From bud3030 at gmail.com  Mon May 19 01:16:30 2008
From: bud3030 at gmail.com (Bubba Siggler)
Date: Sun, 18 May 2008 19:16:30 -0400
Subject: unsubscribed
Message-ID: <f6a36b9c0805181616x64c7360fs87fcb63f73a52b98@mail.gmail.com>

way to much mail.


From mb at bu3sch.de  Mon May 19 02:05:38 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 19 May 2008 02:05:38 +0200
Subject: unsubscribed
In-Reply-To: <f6a36b9c0805181616x64c7360fs87fcb63f73a52b98@mail.gmail.com>
References: <f6a36b9c0805181616x64c7360fs87fcb63f73a52b98@mail.gmail.com>
Message-ID: <200805190205.38373.mb@bu3sch.de>

On Monday 19 May 2008 01:16:30 Bubba Siggler wrote:
> way to much mail.

Hahaha :D That's a good one.

You should consider subscribing the linux-kernel-mailinglist.
That has about 500 mails per day. :)

> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
You need to use this link to unsubscribe

-- 
Greetings Michael.


From netrolller.3d at gmail.com  Mon May 19 02:11:01 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Mon, 19 May 2008 02:11:01 +0200
Subject: unsubscribed
In-Reply-To: <200805190205.38373.mb@bu3sch.de>
References: <f6a36b9c0805181616x64c7360fs87fcb63f73a52b98@mail.gmail.com>
	<200805190205.38373.mb@bu3sch.de>
Message-ID: <69e28c910805181711n188a20f0h2872ecfad60ddd9a@mail.gmail.com>

On Mon, May 19, 2008 at 2:05 AM, Michael Buesch <mb at bu3sch.de> wrote:
> Hahaha :D That's a good one.
>
> You should consider subscribing the linux-kernel-mailinglist.
> That has about 500 mails per day. :)

500 mails? Well, I guess that's unmaintainable even using Gmail labels...

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Mon May 19 23:51:37 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 19 May 2008 23:51:37 +0200
Subject: [PATCH] b43: Add panic reason code that doesn't trigger restart
Message-ID: <200805192351.38219.mb@bu3sch.de>

Add a firmware panic reason code that doesn't trigger a restart.
This is useful for firmware debugging and avoiding endless
restart loops. We can use FWPANIC_DIE to halt the firmware at a
well defined point.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is for 2.6.27


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-17 23:09:09.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-18 23:57:16.000000000 +0200
@@ -419,18 +419,27 @@ enum {
 					 B43_IRQ_TXFIFO_FLUSH_OK | \
 					 B43_IRQ_NOISESAMPLE_OK | \
 					 B43_IRQ_UCODE_DEBUG | \
 					 B43_IRQ_RFKILL | \
 					 B43_IRQ_TX_OK)
 
+/* The firmware register to fetch the debug-IRQ reason from. */
+#define B43_DEBUGIRQ_REASON_REG		63
 /* Debug-IRQ reasons. */
 #define B43_DEBUGIRQ_PANIC		0	/* The firmware panic'ed */
 #define B43_DEBUGIRQ_DUMP_SHM		1	/* Dump shared SHM */
 #define B43_DEBUGIRQ_DUMP_REGS		2	/* Dump the microcode registers */
 #define B43_DEBUGIRQ_ACK		0xFFFF	/* The host writes that to ACK the IRQ */
 
+/* The firmware register to fetch the panic reason from. */
+#define B43_FWPANIC_REASON_REG		3
+/* Firmware panic reason codes */
+#define B43_FWPANIC_DIE			0 /* Firmware died. Don't auto-restart it. */
+#define B43_FWPANIC_RESTART		1 /* Firmware died. Schedule a controller reset. */
+
+
 /* Device specific rate values.
  * The actual values defined here are (rate_in_mbps * 2).
  * Some code depends on this. Don't change it. */
 #define B43_CCK_RATE_1MB		0x02
 #define B43_CCK_RATE_2MB		0x04
 #define B43_CCK_RATE_5MB		0x0B
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-17 23:33:15.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-19 00:02:01.000000000 +0200
@@ -1661,31 +1661,52 @@ static void b43_set_beacon_int(struct b4
 		b43_write16(dev, 0x610, beacon_int);
 	}
 	b43_time_unlock(dev);
 	b43dbg(dev->wl, "Set beacon interval to %u\n", beacon_int);
 }
 
+static void b43_handle_firmware_panic(struct b43_wldev *dev)
+{
+	u16 reason;
+
+	/* Read the register that contains the reason code for the panic. */
+	reason = b43_shm_read16(dev, B43_SHM_SCRATCH, B43_FWPANIC_REASON_REG);
+	b43err(dev->wl, "Whoopsy, firmware panic! Reason: %u\n", reason);
+
+	switch (reason) {
+	default:
+		b43dbg(dev->wl, "The panic reason is unknown.\n");
+		/* fallthrough */
+	case B43_FWPANIC_DIE:
+		/* Do not restart the controller or firmware.
+		 * The device is nonfunctional from now on.
+		 * Restarting would result in this panic to trigger again,
+		 * so we avoid that recursion. */
+		break;
+	case B43_FWPANIC_RESTART:
+		b43_controller_restart(dev, "Microcode panic");
+		break;
+	}
+}
+
 static void handle_irq_ucode_debug(struct b43_wldev *dev)
 {
 	unsigned int i, cnt;
 	u16 reason;
 	__le16 *buf;
 
 	/* The proprietary firmware doesn't have this IRQ. */
 	if (!dev->fw.opensource)
 		return;
 
-	/* Microcode register 63 contains the debug-IRQ reason. */
-	reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 63);
+	/* Read the register that contains the reason code for this IRQ. */
+	reason = b43_shm_read16(dev, B43_SHM_SCRATCH, B43_DEBUGIRQ_REASON_REG);
+
 	switch (reason) {
 	case B43_DEBUGIRQ_PANIC:
-		/* The reason for the panic is in register 3. */
-		reason = b43_shm_read16(dev, B43_SHM_SCRATCH, 3);
-		b43err(dev->wl, "Whoopsy, the microcode panic'ed! Reason: %u\n",
-		       reason);
-		b43_controller_restart(dev, "Microcode panic");
+		b43_handle_firmware_panic(dev);
 		break;
 	case B43_DEBUGIRQ_DUMP_SHM:
 		if (!B43_DEBUG)
 			break; /* Only with driver debugging enabled. */
 		buf = kmalloc(4096, GFP_ATOMIC);
 		if (!buf) {
@@ -1720,13 +1741,15 @@ static void handle_irq_ucode_debug(struc
 		break;
 	default:
 		b43dbg(dev->wl, "Debug-IRQ triggered for unknown reason: %u\n",
 		       reason);
 	}
 out:
-	b43_shm_write16(dev, B43_SHM_SCRATCH, 63, B43_DEBUGIRQ_ACK);
+	/* Acknowledge the debug-IRQ, so the firmware can continue. */
+	b43_shm_write16(dev, B43_SHM_SCRATCH,
+			B43_DEBUGIRQ_REASON_REG, B43_DEBUGIRQ_ACK);
 }
 
 /* Interrupt handler bottom-half */
 static void b43_interrupt_tasklet(struct b43_wldev *dev)
 {
 	u32 reason;


From mb at bu3sch.de  Tue May 20 00:24:36 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 20 May 2008 00:24:36 +0200
Subject: [PATCH] b43: Add firmware markers support
Message-ID: <200805200024.36914.mb@bu3sch.de>

This adds support for firmware markers.
With firmware markers it's easily possible to check whether the
firmware runs some codepath or not. The driver will throw a message
when the firmware executes a MARKER(x).

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is for 2.6.27


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-18 23:57:16.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-20 00:16:27.000000000 +0200
@@ -425,14 +425,19 @@ enum {
 /* The firmware register to fetch the debug-IRQ reason from. */
 #define B43_DEBUGIRQ_REASON_REG		63
 /* Debug-IRQ reasons. */
 #define B43_DEBUGIRQ_PANIC		0	/* The firmware panic'ed */
 #define B43_DEBUGIRQ_DUMP_SHM		1	/* Dump shared SHM */
 #define B43_DEBUGIRQ_DUMP_REGS		2	/* Dump the microcode registers */
+#define B43_DEBUGIRQ_MARKER		3	/* A "marker" was thrown by the firmware. */
 #define B43_DEBUGIRQ_ACK		0xFFFF	/* The host writes that to ACK the IRQ */
 
+/* The firmware register that contains the "marker" line. */
+#define B43_MARKER_ID_REG		2
+#define B43_MARKER_LINE_REG		3
+
 /* The firmware register to fetch the panic reason from. */
 #define B43_FWPANIC_REASON_REG		3
 /* Firmware panic reason codes */
 #define B43_FWPANIC_DIE			0 /* Firmware died. Don't auto-restart it. */
 #define B43_FWPANIC_RESTART		1 /* Firmware died. Schedule a controller reset. */
 
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-19 00:02:01.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-20 00:18:53.000000000 +0200
@@ -1688,13 +1688,13 @@ static void b43_handle_firmware_panic(st
 	}
 }
 
 static void handle_irq_ucode_debug(struct b43_wldev *dev)
 {
 	unsigned int i, cnt;
-	u16 reason;
+	u16 reason, marker_id, marker_line;
 	__le16 *buf;
 
 	/* The proprietary firmware doesn't have this IRQ. */
 	if (!dev->fw.opensource)
 		return;
 
@@ -1736,12 +1736,23 @@ static void handle_irq_ucode_debug(struc
 				printk("\n");
 				cnt = 0;
 			}
 		}
 		printk("\n");
 		break;
+	case B43_DEBUGIRQ_MARKER:
+		if (!B43_DEBUG)
+			break; /* Only with driver debugging enabled. */
+		marker_id = b43_shm_read16(dev, B43_SHM_SCRATCH,
+					   B43_MARKER_ID_REG);
+		marker_line = b43_shm_read16(dev, B43_SHM_SCRATCH,
+					     B43_MARKER_LINE_REG);
+		b43info(dev->wl, "The firmware just executed the MARKER(%u) "
+			"at line number %u\n",
+			marker_id, marker_line);
+		break;
 	default:
 		b43dbg(dev->wl, "Debug-IRQ triggered for unknown reason: %u\n",
 		       reason);
 	}
 out:
 	/* Acknowledge the debug-IRQ, so the firmware can continue. */


From mb at bu3sch.de  Tue May 20 01:08:13 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 20 May 2008 01:08:13 +0200
Subject: [PATCH RFC] b43: Upload both beacon templates on initial load
Message-ID: <200805200108.13922.mb@bu3sch.de>

Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-20 00:16:27.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-20 00:54:16.000000000 +0200
@@ -753,12 +753,13 @@ struct b43_wl {
 	/* The beacon we are currently using (AP or IBSS mode).
 	 * This beacon stuff is protected by the irq_lock. */
 	struct sk_buff *current_beacon;
 	struct ieee80211_tx_control beacon_txctl;
 	bool beacon0_uploaded;
 	bool beacon1_uploaded;
+	bool beacon_templates_virgin; /* Never wrote the templates? */
 	struct work_struct beacon_update_trigger;
 
 	/* The current QOS parameters for the 4 queues.
 	 * This is protected by the irq_lock. */
 	struct b43_qos_params qos_params[4];
 	/* Workqueue for updating QOS parameters in hardware. */
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-20 00:18:53.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-20 01:05:04.000000000 +0200
@@ -1541,12 +1541,36 @@ static void b43_write_probe_resp_templat
 	b43_write_template_common(dev, probe_resp_data,
 				  size, ram_offset, shm_size_offset,
 				  rate->hw_value);
 	kfree(probe_resp_data);
 }
 
+static void b43_upload_beacon0(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+
+	if (wl->beacon0_uploaded)
+		return;
+	b43_write_beacon_template(dev, 0x68, 0x18);
+	/* FIXME: Probe resp upload doesn't really belong here,
+	 *        but we don't use that feature anyway. */
+	b43_write_probe_resp_template(dev, 0x268, 0x4A,
+				      &__b43_ratetable[3]);
+	wl->beacon0_uploaded = 1;
+}
+
+static void b43_upload_beacon1(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+
+	if (wl->beacon1_uploaded)
+		return;
+	b43_write_beacon_template(dev, 0x468, 0x1A);
+	wl->beacon1_uploaded = 1;
+}
+
 static void handle_irq_beacon(struct b43_wldev *dev)
 {
 	struct b43_wl *wl = dev->wl;
 	u32 cmd, beacon0_valid, beacon1_valid;
 
 	if (!b43_is_mode(wl, IEEE80211_IF_TYPE_AP))
@@ -1565,30 +1589,33 @@ static void handle_irq_beacon(struct b43
 	if (beacon0_valid && beacon1_valid) {
 		b43_write32(dev, B43_MMIO_GEN_IRQ_REASON, B43_IRQ_BEACON);
 		dev->irq_savedstate |= B43_IRQ_BEACON;
 		return;
 	}
 
-	if (!beacon0_valid) {
-		if (!wl->beacon0_uploaded) {
-			b43_write_beacon_template(dev, 0x68, 0x18);
-			b43_write_probe_resp_template(dev, 0x268, 0x4A,
-						      &__b43_ratetable[3]);
-			wl->beacon0_uploaded = 1;
-		}
+	if (unlikely(wl->beacon_templates_virgin)) {
+		/* We never uploaded a beacon before.
+		 * Upload both templates now, but only mark one valid. */
+		wl->beacon_templates_virgin = 0;
+		b43_upload_beacon0(dev);
+		b43_upload_beacon1(dev);
 		cmd = b43_read32(dev, B43_MMIO_MACCMD);
 		cmd |= B43_MACCMD_BEACON0_VALID;
 		b43_write32(dev, B43_MMIO_MACCMD, cmd);
-	} else if (!beacon1_valid) {
-		if (!wl->beacon1_uploaded) {
-			b43_write_beacon_template(dev, 0x468, 0x1A);
-			wl->beacon1_uploaded = 1;
+	} else {
+		if (!beacon0_valid) {
+			b43_upload_beacon0(dev);
+			cmd = b43_read32(dev, B43_MMIO_MACCMD);
+			cmd |= B43_MACCMD_BEACON0_VALID;
+			b43_write32(dev, B43_MMIO_MACCMD, cmd);
+		} else if (!beacon1_valid) {
+			b43_upload_beacon1(dev);
+			cmd = b43_read32(dev, B43_MMIO_MACCMD);
+			cmd |= B43_MACCMD_BEACON1_VALID;
+			b43_write32(dev, B43_MMIO_MACCMD, cmd);
 		}
-		cmd = b43_read32(dev, B43_MMIO_MACCMD);
-		cmd |= B43_MACCMD_BEACON1_VALID;
-		b43_write32(dev, B43_MMIO_MACCMD, cmd);
 	}
 }
 
 static void b43_beacon_update_trigger_work(struct work_struct *work)
 {
 	struct b43_wl *wl = container_of(work, struct b43_wl,
@@ -4164,12 +4191,15 @@ static int b43_op_start(struct ieee80211
 	 * and mac80211 reconfiguring it. */
 	memset(wl->bssid, 0, ETH_ALEN);
 	memset(wl->mac_addr, 0, ETH_ALEN);
 	wl->filter_flags = 0;
 	wl->radiotap_enabled = 0;
 	b43_qos_clear(wl);
+	wl->beacon0_uploaded = 0;
+	wl->beacon1_uploaded = 0;
+	wl->beacon_templates_virgin = 1;
 
 	/* First register RFkill.
 	 * LEDs that are registered later depend on it. */
 	b43_rfkill_init(dev);
 
 	mutex_lock(&wl->mutex);


From alan at clueserver.org  Tue May 20 08:03:09 2008
From: alan at clueserver.org (Alan)
Date: Mon, 19 May 2008 23:03:09 -0700
Subject: unsubscribed
In-Reply-To: <69e28c910805181711n188a20f0h2872ecfad60ddd9a@mail.gmail.com>
References: <f6a36b9c0805181616x64c7360fs87fcb63f73a52b98@mail.gmail.com>
	<200805190205.38373.mb@bu3sch.de>
	<69e28c910805181711n188a20f0h2872ecfad60ddd9a@mail.gmail.com>
Message-ID: <1211263389.12034.2.camel@kratos.fnordora.org>


On Mon, 2008-05-19 at 02:11 +0200, Stefanik G?bor wrote:
> On Mon, May 19, 2008 at 2:05 AM, Michael Buesch <mb at bu3sch.de> wrote:
> > Hahaha :D That's a good one.
> >
> > You should consider subscribing the linux-kernel-mailinglist.
> > That has about 500 mails per day. :)
> 
> 500 mails? Well, I guess that's unmaintainable even using Gmail labels...

Back when I ran mailing lists, I would get 1500 messages an hour!  And
it was uphill both ways!  And we were grateful!

Now get off my lawn!

[Actually when I ran perl5-porters and the rest of the mailing lists on
perl.org, I got pretty close to that.  Most of it was bounce messages.
(It was before the days of automatic bounce handling.)]

500 is nothing.




From mb at bu3sch.de  Tue May 20 12:16:28 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 20 May 2008 12:16:28 +0200
Subject: [PATCH] b43: Upload both beacon templates on initial load
Message-ID: <200805201216.29134.mb@bu3sch.de>

This updates the beacon template code to upload both templates,
if we never uploaded one before.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, we can apply that to 2.6.26, but I guess it's not too important
there, as that doesn't support AP, IBSS or Mesh anyway.


Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-20 00:16:27.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-20 00:54:16.000000000 +0200
@@ -753,12 +753,13 @@ struct b43_wl {
 	/* The beacon we are currently using (AP or IBSS mode).
 	 * This beacon stuff is protected by the irq_lock. */
 	struct sk_buff *current_beacon;
 	struct ieee80211_tx_control beacon_txctl;
 	bool beacon0_uploaded;
 	bool beacon1_uploaded;
+	bool beacon_templates_virgin; /* Never wrote the templates? */
 	struct work_struct beacon_update_trigger;
 
 	/* The current QOS parameters for the 4 queues.
 	 * This is protected by the irq_lock. */
 	struct b43_qos_params qos_params[4];
 	/* Workqueue for updating QOS parameters in hardware. */
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-20 00:18:53.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-20 01:05:04.000000000 +0200
@@ -1541,12 +1541,36 @@ static void b43_write_probe_resp_templat
 	b43_write_template_common(dev, probe_resp_data,
 				  size, ram_offset, shm_size_offset,
 				  rate->hw_value);
 	kfree(probe_resp_data);
 }
 
+static void b43_upload_beacon0(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+
+	if (wl->beacon0_uploaded)
+		return;
+	b43_write_beacon_template(dev, 0x68, 0x18);
+	/* FIXME: Probe resp upload doesn't really belong here,
+	 *        but we don't use that feature anyway. */
+	b43_write_probe_resp_template(dev, 0x268, 0x4A,
+				      &__b43_ratetable[3]);
+	wl->beacon0_uploaded = 1;
+}
+
+static void b43_upload_beacon1(struct b43_wldev *dev)
+{
+	struct b43_wl *wl = dev->wl;
+
+	if (wl->beacon1_uploaded)
+		return;
+	b43_write_beacon_template(dev, 0x468, 0x1A);
+	wl->beacon1_uploaded = 1;
+}
+
 static void handle_irq_beacon(struct b43_wldev *dev)
 {
 	struct b43_wl *wl = dev->wl;
 	u32 cmd, beacon0_valid, beacon1_valid;
 
 	if (!b43_is_mode(wl, IEEE80211_IF_TYPE_AP))
@@ -1565,30 +1589,33 @@ static void handle_irq_beacon(struct b43
 	if (beacon0_valid && beacon1_valid) {
 		b43_write32(dev, B43_MMIO_GEN_IRQ_REASON, B43_IRQ_BEACON);
 		dev->irq_savedstate |= B43_IRQ_BEACON;
 		return;
 	}
 
-	if (!beacon0_valid) {
-		if (!wl->beacon0_uploaded) {
-			b43_write_beacon_template(dev, 0x68, 0x18);
-			b43_write_probe_resp_template(dev, 0x268, 0x4A,
-						      &__b43_ratetable[3]);
-			wl->beacon0_uploaded = 1;
-		}
+	if (unlikely(wl->beacon_templates_virgin)) {
+		/* We never uploaded a beacon before.
+		 * Upload both templates now, but only mark one valid. */
+		wl->beacon_templates_virgin = 0;
+		b43_upload_beacon0(dev);
+		b43_upload_beacon1(dev);
 		cmd = b43_read32(dev, B43_MMIO_MACCMD);
 		cmd |= B43_MACCMD_BEACON0_VALID;
 		b43_write32(dev, B43_MMIO_MACCMD, cmd);
-	} else if (!beacon1_valid) {
-		if (!wl->beacon1_uploaded) {
-			b43_write_beacon_template(dev, 0x468, 0x1A);
-			wl->beacon1_uploaded = 1;
+	} else {
+		if (!beacon0_valid) {
+			b43_upload_beacon0(dev);
+			cmd = b43_read32(dev, B43_MMIO_MACCMD);
+			cmd |= B43_MACCMD_BEACON0_VALID;
+			b43_write32(dev, B43_MMIO_MACCMD, cmd);
+		} else if (!beacon1_valid) {
+			b43_upload_beacon1(dev);
+			cmd = b43_read32(dev, B43_MMIO_MACCMD);
+			cmd |= B43_MACCMD_BEACON1_VALID;
+			b43_write32(dev, B43_MMIO_MACCMD, cmd);
 		}
-		cmd = b43_read32(dev, B43_MMIO_MACCMD);
-		cmd |= B43_MACCMD_BEACON1_VALID;
-		b43_write32(dev, B43_MMIO_MACCMD, cmd);
 	}
 }
 
 static void b43_beacon_update_trigger_work(struct work_struct *work)
 {
 	struct b43_wl *wl = container_of(work, struct b43_wl,
@@ -4164,12 +4191,15 @@ static int b43_op_start(struct ieee80211
 	 * and mac80211 reconfiguring it. */
 	memset(wl->bssid, 0, ETH_ALEN);
 	memset(wl->mac_addr, 0, ETH_ALEN);
 	wl->filter_flags = 0;
 	wl->radiotap_enabled = 0;
 	b43_qos_clear(wl);
+	wl->beacon0_uploaded = 0;
+	wl->beacon1_uploaded = 0;
+	wl->beacon_templates_virgin = 1;
 
 	/* First register RFkill.
 	 * LEDs that are registered later depend on it. */
 	b43_rfkill_init(dev);
 
 	mutex_lock(&wl->mutex);

-- 
Greetings Michael.


From netrolller.3d at gmail.com  Tue May 20 18:24:42 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Tue, 20 May 2008 12:24:42 -0400
Subject: Monitor-while-operating bug in b43: WEP-encrypted packets are
	received in decrypted form on the monitor interface
Message-ID: <69e28c910805200924k56f19058n5f7f4e10a4031669@mail.gmail.com>

Hi all,

One day I was testing monitor-while-operating, with "wlan0" as the
managed interface and "rtap0" as the monitor one, and found an
interesting bug: when I am associated with an AP on wlan0, and try to
receive the same AP's packets through the monitor interface, the
packets arrive in decrypted form, but with the WEP bit still set. This
appears to be a HW-crypto-related bug, though I haven't tested with HW
crypto off. What can cause such a bug?

Thanks,
G?bor

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From proski at gnu.org  Wed May 21 01:29:35 2008
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 20 May 2008 19:29:35 -0400
Subject: [PATCH] b43: Upload both beacon templates on initial load
In-Reply-To: <200805201216.29134.mb@bu3sch.de>
References: <200805201216.29134.mb@bu3sch.de>
Message-ID: <1211326175.21859.10.camel@dv>

On Tue, 2008-05-20 at 12:16 +0200, Michael Buesch wrote:
> This updates the beacon template code to upload both templates,
> if we never uploaded one before.
...
> +	bool beacon_templates_virgin; /* Never wrote the templates? */
...
> @@ -4164,12 +4191,15 @@ static int b43_op_start(struct ieee80211
>  	 * and mac80211 reconfiguring it. */
>  	memset(wl->bssid, 0, ETH_ALEN);
>  	memset(wl->mac_addr, 0, ETH_ALEN);
>  	wl->filter_flags = 0;
>  	wl->radiotap_enabled = 0;
>  	b43_qos_clear(wl);
> +	wl->beacon0_uploaded = 0;
> +	wl->beacon1_uploaded = 0;
> +	wl->beacon_templates_virgin = 1;

?Just a hint.  You may want to revert the logic, so that you start with
0 and set the variable to 1 as something substantial happens.  You can
introduce more states later if required, or count the upload events.

This way, it would be beacon_templates_loaded or
beacon_templates_touched.

The human brain is better at understanding positive meanings.  "virgin"
means that something did _not_ happen, and it's not like it's very
valuable per se, at least for beacon templates :-)

I worked on code full of things like HAVE_NO_CURSES_H and DISABLE_COLOR,
and it wasn't fun.

-- 
Regards,
Pavel Roskin


From mb at bu3sch.de  Wed May 21 12:00:54 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 May 2008 12:00:54 +0200
Subject: [PATCH] b43: Upload both beacon templates on initial load
In-Reply-To: <200805201216.29134.mb@bu3sch.de>
References: <200805201216.29134.mb@bu3sch.de>
Message-ID: <200805211200.54484.mb@bu3sch.de>

On Tuesday 20 May 2008 12:16:28 Michael Buesch wrote:
> This updates the beacon template code to upload both templates,
> if we never uploaded one before.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> 
> ---
> 
> John, we can apply that to 2.6.26, but I guess it's not too important
> there, as that doesn't support AP, IBSS or Mesh anyway.

Please try to merge this for 2.6.26, as most AP code actually is merged.

> 
> Index: wireless-testing/drivers/net/wireless/b43/b43.h
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/b43.h	2008-05-20 00:16:27.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/b43.h	2008-05-20 00:54:16.000000000 +0200
> @@ -753,12 +753,13 @@ struct b43_wl {
>  	/* The beacon we are currently using (AP or IBSS mode).
>  	 * This beacon stuff is protected by the irq_lock. */
>  	struct sk_buff *current_beacon;
>  	struct ieee80211_tx_control beacon_txctl;
>  	bool beacon0_uploaded;
>  	bool beacon1_uploaded;
> +	bool beacon_templates_virgin; /* Never wrote the templates? */
>  	struct work_struct beacon_update_trigger;
>  
>  	/* The current QOS parameters for the 4 queues.
>  	 * This is protected by the irq_lock. */
>  	struct b43_qos_params qos_params[4];
>  	/* Workqueue for updating QOS parameters in hardware. */
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-20 00:18:53.000000000 +0200
> +++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-20 01:05:04.000000000 +0200
> @@ -1541,12 +1541,36 @@ static void b43_write_probe_resp_templat
>  	b43_write_template_common(dev, probe_resp_data,
>  				  size, ram_offset, shm_size_offset,
>  				  rate->hw_value);
>  	kfree(probe_resp_data);
>  }
>  
> +static void b43_upload_beacon0(struct b43_wldev *dev)
> +{
> +	struct b43_wl *wl = dev->wl;
> +
> +	if (wl->beacon0_uploaded)
> +		return;
> +	b43_write_beacon_template(dev, 0x68, 0x18);
> +	/* FIXME: Probe resp upload doesn't really belong here,
> +	 *        but we don't use that feature anyway. */
> +	b43_write_probe_resp_template(dev, 0x268, 0x4A,
> +				      &__b43_ratetable[3]);
> +	wl->beacon0_uploaded = 1;
> +}
> +
> +static void b43_upload_beacon1(struct b43_wldev *dev)
> +{
> +	struct b43_wl *wl = dev->wl;
> +
> +	if (wl->beacon1_uploaded)
> +		return;
> +	b43_write_beacon_template(dev, 0x468, 0x1A);
> +	wl->beacon1_uploaded = 1;
> +}
> +
>  static void handle_irq_beacon(struct b43_wldev *dev)
>  {
>  	struct b43_wl *wl = dev->wl;
>  	u32 cmd, beacon0_valid, beacon1_valid;
>  
>  	if (!b43_is_mode(wl, IEEE80211_IF_TYPE_AP))
> @@ -1565,30 +1589,33 @@ static void handle_irq_beacon(struct b43
>  	if (beacon0_valid && beacon1_valid) {
>  		b43_write32(dev, B43_MMIO_GEN_IRQ_REASON, B43_IRQ_BEACON);
>  		dev->irq_savedstate |= B43_IRQ_BEACON;
>  		return;
>  	}
>  
> -	if (!beacon0_valid) {
> -		if (!wl->beacon0_uploaded) {
> -			b43_write_beacon_template(dev, 0x68, 0x18);
> -			b43_write_probe_resp_template(dev, 0x268, 0x4A,
> -						      &__b43_ratetable[3]);
> -			wl->beacon0_uploaded = 1;
> -		}
> +	if (unlikely(wl->beacon_templates_virgin)) {
> +		/* We never uploaded a beacon before.
> +		 * Upload both templates now, but only mark one valid. */
> +		wl->beacon_templates_virgin = 0;
> +		b43_upload_beacon0(dev);
> +		b43_upload_beacon1(dev);
>  		cmd = b43_read32(dev, B43_MMIO_MACCMD);
>  		cmd |= B43_MACCMD_BEACON0_VALID;
>  		b43_write32(dev, B43_MMIO_MACCMD, cmd);
> -	} else if (!beacon1_valid) {
> -		if (!wl->beacon1_uploaded) {
> -			b43_write_beacon_template(dev, 0x468, 0x1A);
> -			wl->beacon1_uploaded = 1;
> +	} else {
> +		if (!beacon0_valid) {
> +			b43_upload_beacon0(dev);
> +			cmd = b43_read32(dev, B43_MMIO_MACCMD);
> +			cmd |= B43_MACCMD_BEACON0_VALID;
> +			b43_write32(dev, B43_MMIO_MACCMD, cmd);
> +		} else if (!beacon1_valid) {
> +			b43_upload_beacon1(dev);
> +			cmd = b43_read32(dev, B43_MMIO_MACCMD);
> +			cmd |= B43_MACCMD_BEACON1_VALID;
> +			b43_write32(dev, B43_MMIO_MACCMD, cmd);
>  		}
> -		cmd = b43_read32(dev, B43_MMIO_MACCMD);
> -		cmd |= B43_MACCMD_BEACON1_VALID;
> -		b43_write32(dev, B43_MMIO_MACCMD, cmd);
>  	}
>  }
>  
>  static void b43_beacon_update_trigger_work(struct work_struct *work)
>  {
>  	struct b43_wl *wl = container_of(work, struct b43_wl,
> @@ -4164,12 +4191,15 @@ static int b43_op_start(struct ieee80211
>  	 * and mac80211 reconfiguring it. */
>  	memset(wl->bssid, 0, ETH_ALEN);
>  	memset(wl->mac_addr, 0, ETH_ALEN);
>  	wl->filter_flags = 0;
>  	wl->radiotap_enabled = 0;
>  	b43_qos_clear(wl);
> +	wl->beacon0_uploaded = 0;
> +	wl->beacon1_uploaded = 0;
> +	wl->beacon_templates_virgin = 1;
>  
>  	/* First register RFkill.
>  	 * LEDs that are registered later depend on it. */
>  	b43_rfkill_init(dev);
>  
>  	mutex_lock(&wl->mutex);
> 



-- 
Greetings Michael.


From netrolller.3d at gmail.com  Wed May 21 13:16:41 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Wed, 21 May 2008 13:16:41 +0200
Subject: Monitor-while-operating bug in b43: WEP-encrypted packets are
	received in decrypted form on the monitor interface
In-Reply-To: <69e28c910805200924k56f19058n5f7f4e10a4031669@mail.gmail.com>
References: <69e28c910805200924k56f19058n5f7f4e10a4031669@mail.gmail.com>
Message-ID: <69e28c910805210416l4cfa5ad9q33dc218864a902b2@mail.gmail.com>

On Tue, May 20, 2008 at 6:24 PM, Stefanik G?bor <netrolller.3d at gmail.com> wrote:
> Hi all,
>
> One day I was testing monitor-while-operating, with "wlan0" as the
> managed interface and "rtap0" as the monitor one, and found an
> interesting bug: when I am associated with an AP on wlan0, and try to
> receive the same AP's packets through the monitor interface, the
> packets arrive in decrypted form, but with the WEP bit still set. This
> appears to be a HW-crypto-related bug, though I haven't tested with HW
> crypto off. What can cause such a bug?
>
> Thanks,
> G?bor

Any hints?

Thanks!

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From shannemann at gmail.com  Wed May 21 20:11:52 2008
From: shannemann at gmail.com (Sandro Hannemann)
Date: Wed, 21 May 2008 20:11:52 +0200
Subject: "no scan results" BCM94311MCG
Message-ID: <ac5231fe0805211111y475af2a9oe3c2b296bf44cf39@mail.gmail.com>

Dear list members,

yesterday I wasted quite some time trying to get the wireless to work
without success.
The situation is:

linux-2.6.24-gentoo-r7  (gentoo flavoured linux kernel).
lspci gives:
 0b:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan
mini-PCI (rev 01)
I used b43-fwcutter-011 to install firmware version
broadcom-wl-4.80.53.0 into /lib/firmware.

"iwlist wlan0 scan" yields only "wlan0     No scan results".

I googled around only finding either outdated information or the
procedure described above.
After that unsuccessful try, I also applied the
"patch_2.6.24_for_4311_2". Unfortunately, it didn't help either.

I append the dmesg output following modprobe b43 at the end of this email.

I appreciate any help.
Thanks in advance.

Cheers,
Sandro

b43-phy0 debug: DMA-32 0x0200 (RX) max used slots: 0/64
b43-phy0 debug: DMA-32 0x02A0 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0280 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0260 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0240 (TX) max used slots: 0/128
b43-phy0 debug: DMA-32 0x0220 (TX) max used slots: 2/128
b43-phy0 debug: DMA-32 0x0200 (TX) max used slots: 0/128
b43-phy0: Broadcom 4311 WLAN found
b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 8
b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
b43-phy0 debug: DebugFS (CONFIG_DEBUG_FS) not enabled in kernel config
phy0: Selected rate control algorithm 'simple'
b43-phy0 debug: Loading firmware version 351.126 (2006-07-29 05:54:02)
b43-phy0 debug: Chip initialized
b43-phy0 debug: 32-bit DMA initialized
b43-phy0 debug: Wireless interface started
HW CONFIG: channel=1 freq=2412 phymode=2
b43-phy0 debug: Adding Interface type 2
HW CONFIG: channel=1 freq=2412 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=2 freq=2417 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=3 freq=2422 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=4 freq=2427 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=5 freq=2432 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=6 freq=2437 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=7 freq=2442 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=8 freq=2447 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=9 freq=2452 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=10 freq=2457 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=11 freq=2462 phymode=2
phy0: TX to low-level driver (len=42) FC=0x0040 DUR=0x0000
A1=ff:ff:ff:ff:ff:ff A2=00:16:ce:61:aa:c6 A3=ff:ff:ff:ff:ff:ff
HW CONFIG: channel=1 freq=2412 phymode=2


From proski at gnu.org  Wed May 21 22:46:34 2008
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 May 2008 16:46:34 -0400
Subject: "no scan results" BCM94311MCG
In-Reply-To: <ac5231fe0805211111y475af2a9oe3c2b296bf44cf39@mail.gmail.com>
References: <ac5231fe0805211111y475af2a9oe3c2b296bf44cf39@mail.gmail.com>
Message-ID: <1211402794.3366.6.camel@dv>

On Wed, 2008-05-21 at 20:11 +0200, Sandro Hannemann wrote:
> Dear list members,
> 
> yesterday I wasted quite some time trying to get the wireless to work
> without success.
> The situation is:
> 
> linux-2.6.24-gentoo-r7  (gentoo flavoured linux kernel).
> lspci gives:
>  0b:00.0 Network controller: Broadcom Corporation BCM94311MCG wlan
> mini-PCI (rev 01)
> I used b43-fwcutter-011 to install firmware version
> broadcom-wl-4.80.53.0 into /lib/firmware.
> 
> "iwlist wlan0 scan" yields only "wlan0     No scan results".

As far as I can tell, you installed the firmware correctly.  But it's
possible that the driver you are using doesn't have some fixes needed
for your hardware.  I suggest that you try the driver from
compat-wireless, which is the latest driver backported to the recent
kernels: http://linuxwireless.org/en/users/Download

If it doesn't help, check the antenna connectors on the card if they are
accessible.  Also try ndiswrapper to rule out problems unrelated to the
b43 driver.

-- 
Regards,
Pavel Roskin


From shannemann at gmail.com  Thu May 22 01:25:08 2008
From: shannemann at gmail.com (Sandro Hannemann)
Date: Thu, 22 May 2008 01:25:08 +0200
Subject: "no scan results" BCM94311MCG
In-Reply-To: <1211402794.3366.6.camel@dv>
References: <ac5231fe0805211111y475af2a9oe3c2b296bf44cf39@mail.gmail.com>
	<1211402794.3366.6.camel@dv>
Message-ID: <ac5231fe0805211625o6e83b087q37ca2e539e610802@mail.gmail.com>

First, thanks for your reply.

> I suggest that you try the driver from
> compat-wireless, which is the latest driver backported to the recent
> kernels: http://linuxwireless.org/en/users/Download

I did that. The thing is only, I get compile issues, which wouldn't
bother me too much, as long as b43 would be working fine...
The reaction on modprobe:
# modprobe -f b43
WARNING: Error inserting ssb
(/lib/modules/2.6.24-gentoo-r7/kernel/drivers/ssb/ssb.ko): Invalid
module format
FATAL: Error inserting b43
(/lib/modules/2.6.24-gentoo-r7/updates/drivers/net/wireless/b43/b43.ko):
Unknown symbol in module, or unknown parameter (see dmesg)

The dmesg says:
ssb: no version magic, tainting kernel.
ssb: exports duplicate symbol ssb_admatch_size (owned by kernel)
ssb: no version magic, tainting kernel.
ssb: exports duplicate symbol ssb_admatch_size (owned by kernel)
b43: no version magic, tainting kernel.
b43: Unknown symbol pcmcia_disable_device
b43: Unknown symbol pcmcia_unregister_driver
b43: Unknown symbol pcmcia_map_mem_page
b43: Unknown symbol ssb_bus_suspend
b43: Unknown symbol led_classdev_unregister
b43: Unknown symbol ssb_bus_resume
b43: Unknown symbol pccard_get_first_tuple
b43: Unknown symbol pcmcia_request_window
b43: Unknown symbol pcmcia_request_configuration
b43: Unknown symbol ssb_bus_pcmciabus_register
b43: Unknown symbol pccard_get_tuple_data
b43: Unknown symbol pcmcia_register_driver
b43: Unknown symbol led_classdev_register
b43: Unknown symbol pccard_parse_tuple
b43: Unknown symbol pcmcia_request_irq

Well, I don't have pcmcia in my kernel config, because I don't need it.
Is there a certain kernel setting requirement that I miss? I tried
dis/enabling module-version support ( Don't ask me why! ???)
Do I really have to enable that pccard and pcmcia stuff there?

Then I found a command "b43load" somewhere in the "wireless-compat" tree, but
b43load complains about the same error as above and eventually loads
the module b43legacy... well... which doesn't work...

> If it doesn't help, check the antenna connectors on the card if they are
> accessible.
It's a laptop from my work. I am not planning to open it and fiddle
around with any connectors. Let's say, it is built-in and just not
accessable.

>  Also try ndiswrapper to rule out problems unrelated to the
> b43 driver.

ndiswrapper acts weired as well. I installed version 1.52.
I did blacklist these guys: b43, b43legacy, ccb.
I downloaded the windows driver and installed it. ndiswrapper seems to be happy:
# ndiswrapper -l
bcmwl5 : driver installed
       device (14E4:4311) present (alternate driver: ssb)

however, iwconfig says:
# iwconfig
lo        no wireless extensions.
eth0      no wireless extensions.

basically, no wireless device showing up here (also the LED stays off).

Summary:
The wifi here did work some time ago. It is only recently that it
rendered that broken. I used to use ndiswrapper one year ago, at some
point I switched to b43. I mean, it's not real fun to go through those
changes in the wifi infrastructure every half a year...
But I do it, it's alright to tinker with all that stuff ;-), but
this... I don't know. It's getting tedious, isn't it?

If you would need/want more details, just post it, I'll provide it,
I'd really get it running again.
Just one restriction: I'd like to stick to 2.6.24 for the time being,
as the vmware-modules don't compile against 2.6.25 kernels yet.

Cheers,
Sandro


From proski at gnu.org  Thu May 22 02:01:05 2008
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 May 2008 20:01:05 -0400
Subject: "no scan results" BCM94311MCG
In-Reply-To: <ac5231fe0805211625o6e83b087q37ca2e539e610802@mail.gmail.com>
References: <ac5231fe0805211111y475af2a9oe3c2b296bf44cf39@mail.gmail.com>
	<1211402794.3366.6.camel@dv>
	<ac5231fe0805211625o6e83b087q37ca2e539e610802@mail.gmail.com>
Message-ID: <1211414465.5913.47.camel@dv>

On Thu, 2008-05-22 at 01:25 +0200, Sandro Hannemann wrote:
> First, thanks for your reply.
> 
> > I suggest that you try the driver from
> > compat-wireless, which is the latest driver backported to the recent
> > kernels: http://linuxwireless.org/en/users/Download
> 
> I did that. The thing is only, I get compile issues, which wouldn't
> bother me too much, as long as b43 would be working fine...

Still, you may want to report it to linux-wireless at vger.kernel.org

> The reaction on modprobe:
> # modprobe -f b43
> WARNING: Error inserting ssb
> (/lib/modules/2.6.24-gentoo-r7/kernel/drivers/ssb/ssb.ko): Invalid
> module format

It means the replacement ssb module failed to install.  It would be
under "updates" instead of "kernel".

> Well, I don't have pcmcia in my kernel config, because I don't need it.
> Is there a certain kernel setting requirement that I miss?

I believe there is no such requirement (although I haven't tried that).
If such requirement exists, the build system should report it.

I only see one reference to PCMCIA on the download page:

"Additionally, the kernel you're building for needs a valid ".config"
file, if it isn't present compat will assume you have PCI, USB and
PCMCIA built into your kernel and if not, fail building."

So, maybe your .config file wasn't found.

> Then I found a command "b43load" somewhere in the "wireless-compat" tree, but
> b43load complains about the same error as above and eventually loads
> the module b43legacy... well... which doesn't work...

It confirms that the installation was incomplete.

> > If it doesn't help, check the antenna connectors on the card if they are
> > accessible.
> It's a laptop from my work. I am not planning to open it and fiddle
> around with any connectors. Let's say, it is built-in and just not
> accessable.

OK, chances are it's OK if you didn't touch it.

> >  Also try ndiswrapper to rule out problems unrelated to the
> > b43 driver.
> 
> ndiswrapper acts weired as well. I installed version 1.52.
> I did blacklist these guys: b43, b43legacy, ccb.
> I downloaded the windows driver and installed it. ndiswrapper seems to be happy:
> # ndiswrapper -l
> bcmwl5 : driver installed
>        device (14E4:4311) present (alternate driver: ssb)
> 
> however, iwconfig says:
> # iwconfig
> lo        no wireless extensions.
> eth0      no wireless extensions.
> 
> basically, no wireless device showing up here (also the LED stays off).

modprobe ndiswrapper

> Summary:
> The wifi here did work some time ago. It is only recently that it
> rendered that broken. I used to use ndiswrapper one year ago, at some
> point I switched to b43.

So, I guess b43 stopped working one day?

> Just one restriction: I'd like to stick to 2.6.24 for the time being,
> as the vmware-modules don't compile against 2.6.25 kernels yet.

compat-wireless supports 2.6.22 and newer.

-- 
Regards,
Pavel Roskin


From netrolller.3d at gmail.com  Thu May 22 12:49:46 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Thu, 22 May 2008 12:49:46 +0200
Subject: Monitor-while-operating bug in b43: WEP-encrypted packets are
	received in decrypted form on the monitor interface
In-Reply-To: <-3309777657511333665@unknownmsgid>
References: <69e28c910805200924k56f19058n5f7f4e10a4031669@mail.gmail.com>
	<-3309777657511333665@unknownmsgid>
Message-ID: <69e28c910805220349u31c32dablef6c55b284643739@mail.gmail.com>

Hello,

1. I don't know if MACTIME gets set or not. How do I check that?
2. ACKs and beacons are received perfectly, yes. Not sure about
RTS/CTS, although I do remember seeing RTS packets in a pcap file I
made with the card.
3. The locally-sent packets arrive back correctly, both those that
have been generated by the system on wlan0, and those that are
injected through Radiotap.

Also, disabling HW crypto fixes the problem.

My proposal: We should automatically disable HW crypto when the card
is operating in multiple-interfaces mode, or if there is a monitor
interface present.

Sincerely,
G?bor Stefanik

P.S. Please CC the b43 development mailing list next time.


On Thu, May 22, 2008 at 8:28 AM, Christian Hoene
<christian.hoene at gmx.net> wrote:
> Hello Stefanik G?bor,
>
> I have some question regarding the monitor-while-operating mode.
> 1 Do you know whether the MACTIME stamp is set for normal packets?
> 2 Do you received the ACK and RTS/CTS packets, too?
> 3 Do you receive in the monitor interface also locally sent packets?
>
> Thank you very much for your help.
>
>  With best regards,
>
>  Christian Hoene
>
>> -----Original Message-----
>> From: bcm43xx-dev-bounces at lists.berlios.de [mailto:bcm43xx-dev-
>> bounces at lists.berlios.de] On Behalf Of Stefanik G?bor
>> Sent: Tuesday, May 20, 2008 6:25 PM
>> To: bcm43xx-dev at lists.berlios.de
>> Subject: Monitor-while-operating bug in b43: WEP-encrypted packets are
>> received in decrypted form on the monitor interface
>>
>> Hi all,
>>
>> One day I was testing monitor-while-operating, with "wlan0" as the
>> managed interface and "rtap0" as the monitor one, and found an
>> interesting bug: when I am associated with an AP on wlan0, and try to
>> receive the same AP's packets through the monitor interface, the
>> packets arrive in decrypted form, but with the WEP bit still set. This
>> appears to be a HW-crypto-related bug, though I haven't tested with HW
>> crypto off. What can cause such a bug?
>>
>> Thanks,
>> G?bor
>>
>> --
>> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>> _______________________________________________
>> Bcm43xx-dev mailing list
>> Bcm43xx-dev at lists.berlios.de
>> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Thu May 22 16:32:16 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 May 2008 16:32:16 +0200
Subject: [PATCH] b43: Fix controller restart crash
Message-ID: <200805221632.17243.mb@bu3sch.de>

This fixes a kernel crash on rmmod, in the case where the controller
was restarted before doing the rmmod.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

John, this is a bugfix for 2.6.26


Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c	2008-05-20 01:05:04.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43/main.c	2008-05-22 16:23:03.000000000 +0200
@@ -4362,13 +4362,15 @@ static void b43_chip_reset(struct work_s
 		err = b43_wireless_core_start(dev);
 		if (err) {
 			b43_wireless_core_exit(dev);
 			goto out;
 		}
 	}
-      out:
+out:
+	if (err)
+		wl->current_dev = NULL; /* Failed to init the dev. */
 	mutex_unlock(&wl->mutex);
 	if (err)
 		b43err(wl, "Controller restart FAILED\n");
 	else
 		b43info(wl, "Controller restarted\n");
 }
@@ -4503,15 +4505,17 @@ err_powerdown:
 
 static void b43_one_core_detach(struct ssb_device *dev)
 {
 	struct b43_wldev *wldev;
 	struct b43_wl *wl;
 
+	/* Do not cancel ieee80211-workqueue based work here.
+	 * See comment in b43_remove(). */
+
 	wldev = ssb_get_drvdata(dev);
 	wl = wldev->wl;
-	cancel_work_sync(&wldev->restart_work);
 	b43_debugfs_remove_device(wldev);
 	b43_wireless_core_detach(wldev);
 	list_del(&wldev->list);
 	wl->nr_devs--;
 	ssb_set_drvdata(dev, NULL);
 	kfree(wldev);
@@ -4690,12 +4694,16 @@ static int b43_probe(struct ssb_device *
 
 static void b43_remove(struct ssb_device *dev)
 {
 	struct b43_wl *wl = ssb_get_devtypedata(dev);
 	struct b43_wldev *wldev = ssb_get_drvdata(dev);
 
+	/* We must cancel any work here before unregistering from ieee80211,
+	 * as the ieee80211 unreg will destroy the workqueue. */
+	cancel_work_sync(&wldev->restart_work);
+
 	B43_WARN_ON(!wl);
 	if (wl->current_dev == wldev)
 		ieee80211_unregister_hw(wl->hw);
 
 	b43_one_core_detach(dev);
 


From mb at bu3sch.de  Thu May 22 17:06:36 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 May 2008 17:06:36 +0200
Subject: [PATCH] b43legacy: Fix controller restart crash
Message-ID: <200805221706.37185.mb@bu3sch.de>

This fixes a kernel crash on rmmod, in the case where the controller
was restarted before doing the rmmod.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

---

Stefano, this is untested. Please test by doing
echo -n 1 >/debug/b43legacy/phy*/restart
rmmod b43legacy
It should not crash anymore at the rmmod (actually the restart should
also hang in b43legacy, as it has a deadlock, which this patch also fixes).

Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c	2008-05-15 23:31:37.000000000 +0200
+++ wireless-testing/drivers/net/wireless/b43legacy/main.c	2008-05-22 17:02:59.000000000 +0200
@@ -3035,13 +3035,12 @@ static void b43legacy_set_pretbtt(struct
 }
 
 /* Shutdown a wireless core */
 /* Locking: wl->mutex */
 static void b43legacy_wireless_core_exit(struct b43legacy_wldev *dev)
 {
-	struct b43legacy_wl *wl = dev->wl;
 	struct b43legacy_phy *phy = &dev->phy;
 	u32 macctl;
 
 	B43legacy_WARN_ON(b43legacy_status(dev) > B43legacy_STAT_INITIALIZED);
 	if (b43legacy_status(dev) != B43legacy_STAT_INITIALIZED)
 		return;
@@ -3050,18 +3049,12 @@ static void b43legacy_wireless_core_exit
 	/* Stop the microcode PSM. */
 	macctl = b43legacy_read32(dev, B43legacy_MMIO_MACCTL);
 	macctl &= ~B43legacy_MACCTL_PSM_RUN;
 	macctl |= B43legacy_MACCTL_PSM_JMP0;
 	b43legacy_write32(dev, B43legacy_MMIO_MACCTL, macctl);
 
-	mutex_unlock(&wl->mutex);
-	/* Must unlock as it would otherwise deadlock. No races here.
-	 * Cancel possibly pending workqueues. */
-	cancel_work_sync(&dev->restart_work);
-	mutex_lock(&wl->mutex);
-
 	b43legacy_leds_exit(dev);
 	b43legacy_rng_exit(dev->wl);
 	b43legacy_pio_free(dev);
 	b43legacy_dma_free(dev);
 	b43legacy_chip_exit(dev);
 	b43legacy_radio_turn_off(dev, 1);
@@ -3482,12 +3475,14 @@ static void b43legacy_chip_reset(struct 
 		if (err) {
 			b43legacy_wireless_core_exit(dev);
 			goto out;
 		}
 	}
 out:
+	if (err)
+		wl->current_dev = NULL; /* Failed to init the dev. */
 	mutex_unlock(&wl->mutex);
 	if (err)
 		b43legacyerr(wl, "Controller restart FAILED\n");
 	else
 		b43legacyinfo(wl, "Controller restarted\n");
 }
@@ -3614,15 +3609,17 @@ err_powerdown:
 
 static void b43legacy_one_core_detach(struct ssb_device *dev)
 {
 	struct b43legacy_wldev *wldev;
 	struct b43legacy_wl *wl;
 
+	/* Do not cancel ieee80211-workqueue based work here.
+	 * See comment in b43legacy_remove(). */
+
 	wldev = ssb_get_drvdata(dev);
 	wl = wldev->wl;
-	cancel_work_sync(&wldev->restart_work);
 	b43legacy_debugfs_remove_device(wldev);
 	b43legacy_wireless_core_detach(wldev);
 	list_del(&wldev->list);
 	wl->nr_devs--;
 	ssb_set_drvdata(dev, NULL);
 	kfree(wldev);
@@ -3784,12 +3781,16 @@ err_wireless_exit:
 
 static void b43legacy_remove(struct ssb_device *dev)
 {
 	struct b43legacy_wl *wl = ssb_get_devtypedata(dev);
 	struct b43legacy_wldev *wldev = ssb_get_drvdata(dev);
 
+	/* We must cancel any work here before unregistering from ieee80211,
+	 * as the ieee80211 unreg will destroy the workqueue. */
+	cancel_work_sync(&wldev->restart_work);
+
 	B43legacy_WARN_ON(!wl);
 	if (wl->current_dev == wldev)
 		ieee80211_unregister_hw(wl->hw);
 
 	b43legacy_one_core_detach(dev);
 


From seandarcy2 at gmail.com  Sat May 24 22:10:49 2008
From: seandarcy2 at gmail.com (sean darcy)
Date: Sat, 24 May 2008 16:10:49 -0400
Subject: 4311(rev1): syslog full of PHY and too short errors
Message-ID: <c195ebf70805241310v506531b1h198cc408b51ff4cd@mail.gmail.com>

On Fedora 9:
uname -a
Linux notebook 2.6.25.3-18.fc9.i686 #1 SMP Tue May 13 05:38:53 EDT
2008 i686 i686 i386 GNU/Linux

syslog is full of

b43-phy0 ERROR: PHY transmission error
printk: 21 messages suppressed.
wlan0: RX too short data frame payload
printk: 17 messages suppressed.

messages. The connection mostly works, though it drops periodically.

Thanks for any help.

sean

lspci -vvn | grep 43 -A7
04:00.0 0280: 14e4:4311 (rev 01)
        Subsystem: 1468:0422
        Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop-
ParErr- Stepping- SERR+ FastB2B- DisINTx-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
<TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 0, Cache Line Size: 64 bytes
        Interrupt: pin A routed to IRQ 17
        Region 0: Memory at f8000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
--
        Kernel driver in use: b43-pci-bridge
        Kernel modules: ssb

dmesg:
ssb: Sonics Silicon Backplane found on PCI device 0000:04:00.0
............
b43-phy0: Broadcom 4311 WLAN found
b43-phy0 debug: Found PHY: Analog 4, Type 2, Revision 8
b43-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
phy0: Selected rate control algorithm 'pid'
Broadcom 43xx driver loaded [ Features: PMLR, Firmware-ID: FW13 ]
............
input: b43-phy0 as /devices/virtual/input/input9
b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)
b43-phy0 debug: Chip initialized
b43-phy0 debug: 32-bit DMA initialized
Registered led device: b43-phy0::tx
Registered led device: b43-phy0::rx
Registered led device: b43-phy0::radio
b43-phy0 debug: Wireless interface started
b43-phy0 debug: Adding Interface type 2
ADDRCONF(NETDEV_UP): wlan0: link is not ready
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:11:50:22:95:52
wlan0: RX authentication from 00:11:50:22:95:52 (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:11:50:22:95:52
wlan0: RX AssocResp from 00:11:50:22:95:52 (capab=0x601 status=0 aid=2)
wlan0: associated
wlan0: switched to short barker preamble (BSSID=00:11:50:22:95:52)
ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
wlan0: disassociate(reason=3)
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:11:50:22:95:52
wlan0: RX authentication from 00:11:50:22:95:52 (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:11:50:22:95:52
wlan0: RX ReassocResp from 00:11:50:22:95:52 (capab=0x601 status=0 aid=4)
wlan0: associated
wlan0: switched to short barker preamble (BSSID=00:11:50:22:95:52)
wlan0: RX too short data frame payload
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
b43-phy0 ERROR: PHY transmission error
wlan0: RX too short data frame payload
wlan0: no IPv6 routers present
printk: 3 messages suppressed.
wlan0: RX too short data frame payload
printk: 21 messages suppressed.
wlan0: RX too short data frame payload
b43-phy0 ERROR: PHY transmission error
printk: 11 messages suppressed.


From celejar at gmail.com  Sun May 25 09:01:30 2008
From: celejar at gmail.com (Celejar)
Date: Sun, 25 May 2008 03:01:30 -0400
Subject: [PATCH] b43: Add hooks for firmware debugging
In-Reply-To: <482F6B63.9080706@lwfinger.net>
References: <200805172244.35966.mb@bu3sch.de>
	<69e28c910805171421l69ca2f3ame3b61a94fdc5921a@mail.gmail.com>
	<200805172324.13818.mb@bu3sch.de>
	<69e28c910805171527y4521a9e7n34d1842281234769@mail.gmail.com>
	<482F6B63.9080706@lwfinger.net>
Message-ID: <20080525030130.4c472dcc.celejar@gmail.com>

On Sat, 17 May 2008 18:33:55 -0500
Larry Finger <Larry.Finger at lwfinger.net> wrote:

> Some of these cards may be called AirForce One; however, I have 7 different 
> cards of varying form factor, and none of them have that name!

FWIW, 'lspci | grep 4318':

06:02.0 Network controller: Broadcom Corporation BCM4318 [AirForce One
54g] 802.11g Wireless LAN Controller (rev 02)

> Larry

Celejar
--
mailmin.sourceforge.net - remote access via secure (OpenPGP) email
ssuds.sourceforge.net - A Simple Sudoku Solver and Generator



From linville at tuxdriver.com  Wed May 28 21:12:24 2008
From: linville at tuxdriver.com (John W. Linville)
Date: Wed, 28 May 2008 15:12:24 -0400
Subject: [PATCH] b43legacy: Fix controller restart crash
In-Reply-To: <200805221706.37185.mb@bu3sch.de>
References: <200805221706.37185.mb@bu3sch.de>
Message-ID: <20080528191224.GB25770@tuxdriver.com>

On Thu, May 22, 2008 at 05:06:36PM +0200, Michael Buesch wrote:
> This fixes a kernel crash on rmmod, in the case where the controller
> was restarted before doing the rmmod.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> 
> ---
> 
> Stefano, this is untested. Please test by doing
> echo -n 1 >/debug/b43legacy/phy*/restart
> rmmod b43legacy
> It should not crash anymore at the rmmod (actually the restart should
> also hang in b43legacy, as it has a deadlock, which this patch also fixes).

Anyone get a chance to test this one?

John
-- 
John W. Linville
linville at tuxdriver.com


From johannes at sipsolutions.net  Fri May 30 14:31:53 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 30 May 2008 14:31:53 +0200
Subject: suspend vs. b43
Message-ID: <1212150713.4117.2.camel@johannes.berg>

Hi,

Since a while ago I've had trouble resuming when b43 was connected to an
AP while suspended.

I did a test today where this was the only difference, but I failed to
see whether ssb or b43 were causing the problem.

Does anyone have a machine with b43 in it that can suspend and supports
the RTC-trace feature so we can narrow it down? Even reproducing might
help to make sure it's not just something weird with my powerbook.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080530/5ce2e5bf/attachment.pgp>

From mb at bu3sch.de  Fri May 30 16:06:25 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 30 May 2008 16:06:25 +0200
Subject: suspend vs. b43
In-Reply-To: <1212150713.4117.2.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
Message-ID: <200805301606.25556.mb@bu3sch.de>

On Friday 30 May 2008 14:31:53 Johannes Berg wrote:
> Since a while ago I've had trouble resuming when b43 was connected to an
> AP while suspended.
> 
> I did a test today where this was the only difference, but I failed to
> see whether ssb or b43 were causing the problem.
> 
> Does anyone have a machine with b43 in it that can suspend and supports
> the RTC-trace feature so we can narrow it down? Even reproducing might
> help to make sure it's not just something weird with my powerbook.

Resume is pretty broken since some time for me.
It sometimes works fine and sometimes just hangs with a black screen.
I have no idea what's going on.

-- 
Greetings Michael.


From florin.aca at gmail.com  Fri May 30 16:11:43 2008
From: florin.aca at gmail.com (Florin Acatrinei)
Date: Fri, 30 May 2008 17:11:43 +0300
Subject: wireless  trouble (bcm43xx)
Message-ID: <48400B1F.1030009@gmail.com>

Hi,
   
I'm new to Linux and I'm having trouble with my wireless NIC.
To be precise i don't have the firmware for my NIC. Nothing on the web 
for me(nothing that I've found).
The Ethernet card is ok but I need my wireless up and running.

Thanks for your time.




From mauritsd at xs4all.nl  Fri May 30 16:21:49 2008
From: mauritsd at xs4all.nl (Maurits Dijkstra)
Date: Fri, 30 May 2008 16:21:49 +0200
Subject: wireless  trouble (bcm43xx)
In-Reply-To: <48400B1F.1030009@gmail.com>
References: <48400B1F.1030009@gmail.com>
Message-ID: <9DB07194-5C1B-4B06-BB95-37016BF81E00@xs4all.nl>

Hi,

On May 30, 2008, at 4:11 PM, Florin Acatrinei wrote:
> <snip>
> To be precise i don't have the firmware for my NIC. Nothing on the web
> for me(nothing that I've found).

http://www.google.com/search?q=bcm43xx+firmware

> <snip>

Anyway, the bcm43xx driver is deprecated/obsolete. Please look to b43/ 
b43legacy to get your wlan-hardware working.

With regards,
Maurits Dijkstra



From richie at coderworld.net  Fri May 30 16:31:35 2008
From: richie at coderworld.net (Richard Jonsson)
Date: Fri, 30 May 2008 16:31:35 +0200
Subject: wireless  trouble (bcm43xx)
In-Reply-To: <48400B1F.1030009@gmail.com>
References: <48400B1F.1030009@gmail.com>
Message-ID: <48400FC7.7060401@coderworld.net>

Florin Acatrinei skrev:
> Hi,
>    
> I'm new to Linux and I'm having trouble with my wireless NIC.
> To be precise i don't have the firmware for my NIC. Nothing on the web 
> for me(nothing that I've found).
> The Ethernet card is ok but I need my wireless up and running.
> 
> Thanks for your time.
> 

Hi!

If you indeed have a broadcom device, you will find your questions 
answered here:

http://wireless.kernel.org/en/users/Drivers/b43


hth, Richard


From johannes at sipsolutions.net  Fri May 30 16:37:18 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 30 May 2008 16:37:18 +0200
Subject: suspend vs. b43
In-Reply-To: <200805301606.25556.mb@bu3sch.de>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
Message-ID: <1212158238.4117.4.camel@johannes.berg>

On Fri, 2008-05-30 at 16:06 +0200, Michael Buesch wrote:
> On Friday 30 May 2008 14:31:53 Johannes Berg wrote:
> > Since a while ago I've had trouble resuming when b43 was connected to an
> > AP while suspended.
> > 
> > I did a test today where this was the only difference, but I failed to
> > see whether ssb or b43 were causing the problem.
> > 
> > Does anyone have a machine with b43 in it that can suspend and supports
> > the RTC-trace feature so we can narrow it down? Even reproducing might
> > help to make sure it's not just something weird with my powerbook.
> 
> Resume is pretty broken since some time for me.
> It sometimes works fine and sometimes just hangs with a black screen.
> I have no idea what's going on.

Odd. Resume itself works just fine here, except when b43 is up. But then
again, you might not notice that this is the problem because by default,
nothing gets printed on the resume console and then it will indeed hang
with a black screen.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080530/5abbd77c/attachment.pgp>

From rjw at sisk.pl  Fri May 30 16:07:23 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Fri, 30 May 2008 16:07:23 +0200
Subject: suspend vs. b43
In-Reply-To: <1212150713.4117.2.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
Message-ID: <200805301607.24378.rjw@sisk.pl>

On Friday, 30 of May 2008, Johannes Berg wrote:
> Hi,

Hi,

> Since a while ago I've had trouble resuming when b43 was connected to an
> AP while suspended.
> 
> I did a test today where this was the only difference, but I failed to
> see whether ssb or b43 were causing the problem.
> 
> Does anyone have a machine with b43 in it that can suspend and supports
> the RTC-trace feature so we can narrow it down? Even reproducing might
> help to make sure it's not just something weird with my powerbook.

No, it's not.  It just doesn't work, AFAICS.

My box is only able to suspend (without hanging) if NetworkManager is switched
off or b43 is unloaded before an attempt to.

Unfortunately, I didn't have the time to fight with that.

Thanks,
Rafael


From mb at bu3sch.de  Fri May 30 16:42:05 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 30 May 2008 16:42:05 +0200
Subject: suspend vs. b43
In-Reply-To: <1212158238.4117.4.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
Message-ID: <200805301642.05248.mb@bu3sch.de>

On Friday 30 May 2008 16:37:18 Johannes Berg wrote:
> Odd. Resume itself works just fine here, except when b43 is up. But then
> again, you might not notice that this is the problem because by default,
> nothing gets printed on the resume console and then it will indeed hang
> with a black screen.

How can I change the printing?

-- 
Greetings Michael.


From johannes at sipsolutions.net  Fri May 30 16:46:22 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 30 May 2008 16:46:22 +0200
Subject: suspend vs. b43
In-Reply-To: <200805301642.05248.mb@bu3sch.de>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
	<200805301642.05248.mb@bu3sch.de>
Message-ID: <1212158782.4117.8.camel@johannes.berg>

On Fri, 2008-05-30 at 16:42 +0200, Michael Buesch wrote:
> On Friday 30 May 2008 16:37:18 Johannes Berg wrote:
> > Odd. Resume itself works just fine here, except when b43 is up. But then
> > again, you might not notice that this is the problem because by default,
> > nothing gets printed on the resume console and then it will indeed hang
> > with a black screen.
> 
> How can I change the printing?

Hmm. It seems I might have been wrong here. Rafael, do we still have
console suspend stuff?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080530/956c821c/attachment.pgp>

From johannes at sipsolutions.net  Fri May 30 16:50:03 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 30 May 2008 16:50:03 +0200
Subject: suspend vs. b43
In-Reply-To: <200805301649.14445.hs4233@mail.mn-solutions.de>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
	<200805301649.14445.hs4233@mail.mn-solutions.de>
Message-ID: <1212159003.4117.10.camel@johannes.berg>

On Fri, 2008-05-30 at 16:49 +0200, Holger Schurig wrote:
> > Odd. Resume itself works just fine here, except when b43 is
> > up. But then again, you might not notice that this is the
> > problem because by default, nothing gets printed on the resume
> > console and then it will indeed hang with a black screen.
> 
> pepper it with printk's and add netconsole ...

Well, yeah, netconsole _might_ work as sungem gets resumed before b43,
but I tried doing that on the regular console and didn't see anything
useful.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080530/68d98040/attachment.pgp>

From gavron at wetwork.net  Fri May 30 17:02:51 2008
From: gavron at wetwork.net (Ehud Gavron)
Date: Fri, 30 May 2008 08:02:51 -0700
Subject: suspend vs. b43
In-Reply-To: <1212158238.4117.4.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
Message-ID: <4840171B.5080604@wetwork.net>



Johannes Berg wrote:
> On Fri, 2008-05-30 at 16:06 +0200, Michael Buesch wrote:
>   
>> On Friday 30 May 2008 14:31:53 Johannes Berg wrote:
>>     
>>> Since a while ago I've had trouble resuming when b43 was connected to an
>>> AP while suspended.
>>>
>>> I did a test today where this was the only difference, but I failed to
>>> see whether ssb or b43 were causing the problem.
>>>
>>> Does anyone have a machine with b43 in it that can suspend and supports
>>> the RTC-trace feature so we can narrow it down? Even reproducing might
>>> help to make sure it's not just something weird with my powerbook.
>>>       
>> Resume is pretty broken since some time for me.
>> It sometimes works fine and sometimes just hangs with a black screen.
>> I have no idea what's going on.
>>     
>
> Odd. Resume itself works just fine here, except when b43 is up. But then
> again, you might not notice that this is the problem because by default,
> nothing gets printed on the resume console and then it will indeed hang
> with a black screen.
>
> johannes
>   
>   
With NM disabled 2.6.25-wl  4311 after a suspend/resume I can:
1. Successfully scan for APs (ifconfig wlan0 up... iwlist wlan0 scan)
2. Associate with an AP  (iwconfig ...essid...key...)
3. Get a DHCP address (dhclient... offer... bound to address such and such)
but
4. NO FURTHER IP COMMUNICATIONS WORKS

Let me know what other diags to run or if I should upgrade to the latest 
wl tree if you think that will change the symptoms.
Things have been busy but there is a weekend coming up here shortly.

Ehud

> ------------------------------------------------------------------------
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>   


From hs4233 at mail.mn-solutions.de  Fri May 30 16:49:14 2008
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Fri, 30 May 2008 16:49:14 +0200
Subject: suspend vs. b43
In-Reply-To: <1212158238.4117.4.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
Message-ID: <200805301649.14445.hs4233@mail.mn-solutions.de>

> Odd. Resume itself works just fine here, except when b43 is
> up. But then again, you might not notice that this is the
> problem because by default, nothing gets printed on the resume
> console and then it will indeed hang with a black screen.

pepper it with printk's and add netconsole ...


From rjw at sisk.pl  Fri May 30 17:20:48 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Fri, 30 May 2008 17:20:48 +0200
Subject: suspend vs. b43
In-Reply-To: <1212158782.4117.8.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301642.05248.mb@bu3sch.de>
	<1212158782.4117.8.camel@johannes.berg>
Message-ID: <200805301720.49327.rjw@sisk.pl>

On Friday, 30 of May 2008, Johannes Berg wrote:
> On Fri, 2008-05-30 at 16:42 +0200, Michael Buesch wrote:
> > On Friday 30 May 2008 16:37:18 Johannes Berg wrote:
> > > Odd. Resume itself works just fine here, except when b43 is up. But then
> > > again, you might not notice that this is the problem because by default,
> > > nothing gets printed on the resume console and then it will indeed hang
> > > with a black screen.
> > 
> > How can I change the printing?
> 
> Hmm. It seems I might have been wrong here. Rafael, do we still have
> console suspend stuff?

Yes, we do.  Use "no_console_suspend" in the kernel command line to change
that, but note that it's not generally safe (eg. if you are using netconsole at
the same time).

Thanks,
Rafael


From rjw at sisk.pl  Fri May 30 17:23:23 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Fri, 30 May 2008 17:23:23 +0200
Subject: suspend vs. b43
In-Reply-To: <1212158238.4117.4.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301606.25556.mb@bu3sch.de>
	<1212158238.4117.4.camel@johannes.berg>
Message-ID: <200805301723.24192.rjw@sisk.pl>

On Friday, 30 of May 2008, Johannes Berg wrote:
> On Fri, 2008-05-30 at 16:06 +0200, Michael Buesch wrote:
> > On Friday 30 May 2008 14:31:53 Johannes Berg wrote:
> > > Since a while ago I've had trouble resuming when b43 was connected to an
> > > AP while suspended.
> > > 
> > > I did a test today where this was the only difference, but I failed to
> > > see whether ssb or b43 were causing the problem.
> > > 
> > > Does anyone have a machine with b43 in it that can suspend and supports
> > > the RTC-trace feature so we can narrow it down? Even reproducing might
> > > help to make sure it's not just something weird with my powerbook.
> > 
> > Resume is pretty broken since some time for me.
> > It sometimes works fine and sometimes just hangs with a black screen.
> > I have no idea what's going on.
> 
> Odd. Resume itself works just fine here, except when b43 is up.

I can confirm that.  It looks like a deadlock with mac80211 or something
similar to my untrained eye.

> But then again, you might not notice that this is the problem because by
> default, nothing gets printed on the resume console and then it will indeed
> hang with a black screen.

Please use "no_console_suspend", as I said in the other message.

Thanks,
Rafael


From johannes at sipsolutions.net  Fri May 30 17:42:43 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 30 May 2008 17:42:43 +0200
Subject: suspend vs. b43
In-Reply-To: <200805301720.49327.rjw@sisk.pl>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301642.05248.mb@bu3sch.de>
	<1212158782.4117.8.camel@johannes.berg>
	<200805301720.49327.rjw@sisk.pl>
Message-ID: <1212162163.7238.1.camel@johannes.berg>

On Fri, 2008-05-30 at 17:20 +0200, Rafael J. Wysocki wrote:
> On Friday, 30 of May 2008, Johannes Berg wrote:
> > On Fri, 2008-05-30 at 16:42 +0200, Michael Buesch wrote:
> > > On Friday 30 May 2008 16:37:18 Johannes Berg wrote:
> > > > Odd. Resume itself works just fine here, except when b43 is up. But then
> > > > again, you might not notice that this is the problem because by default,
> > > > nothing gets printed on the resume console and then it will indeed hang
> > > > with a black screen.
> > > 
> > > How can I change the printing?
> > 
> > Hmm. It seems I might have been wrong here. Rafael, do we still have
> > console suspend stuff?
> 
> Yes, we do.  Use "no_console_suspend" in the kernel command line to change
> that, but note that it's not generally safe (eg. if you are using netconsole at
> the same time).

I see. System reset hard and clock set to 1904, PMU didn't like me :)

Thing is, I do have no_console_suspend (hardcoded in my boot loader
config so I forgot), but even with PM-debug I didn't see it hang at b43
and no useful messages. Not sure what to do, hence asking if anybody has
the rtc-trace stuff.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080530/76ff9ff6/attachment.pgp>

From gaudenz at soziologie.ch  Fri May 30 19:56:41 2008
From: gaudenz at soziologie.ch (Gaudenz Steinlin)
Date: Fri, 30 May 2008 19:56:41 +0200
Subject: suspend vs. b43
In-Reply-To: <1212150713.4117.2.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
Message-ID: <20080530175641.GA9775@soziologie.ch>

Hi

On Fri, May 30, 2008 at 02:31:53PM +0200, Johannes Berg wrote:
> Hi,
> 
> Since a while ago I've had trouble resuming when b43 was connected to an
> AP while suspended.
> 
> I did a test today where this was the only difference, but I failed to
> see whether ssb or b43 were causing the problem.
> 
> Does anyone have a machine with b43 in it that can suspend and supports
> the RTC-trace feature so we can narrow it down? Even reproducing might
> help to make sure it's not just something weird with my powerbook.

Are you talking about suspend-to-disk or about suspend-to-ram?
Suspend-to-ram works fine for me. I'm using either the latest Debian
kernel (2.6.25.x) or 2.26-rc3 (linus tree). Both work fine. 

Suspend-to-disk is currently broken at least with the Debian kernel (did
not try the other one yet). But I supected this to be an USB issue.
Suspend-to-disk did not work in the past if I did not unload uhci-hcd
and ehci-hcd.

Gaudenz

-- 
Ever tried. Ever failed. No matter.
Try again. Fail again. Fail better.
~ Samuel Beckett ~


From rjw at sisk.pl  Fri May 30 23:19:33 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Fri, 30 May 2008 23:19:33 +0200
Subject: suspend vs. b43
In-Reply-To: <1212162163.7238.1.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301720.49327.rjw@sisk.pl>
	<1212162163.7238.1.camel@johannes.berg>
Message-ID: <200805302319.34173.rjw@sisk.pl>

On Friday, 30 of May 2008, Johannes Berg wrote:
> On Fri, 2008-05-30 at 17:20 +0200, Rafael J. Wysocki wrote:
> > On Friday, 30 of May 2008, Johannes Berg wrote:
> > > On Fri, 2008-05-30 at 16:42 +0200, Michael Buesch wrote:
> > > > On Friday 30 May 2008 16:37:18 Johannes Berg wrote:
> > > > > Odd. Resume itself works just fine here, except when b43 is up. But then
> > > > > again, you might not notice that this is the problem because by default,
> > > > > nothing gets printed on the resume console and then it will indeed hang
> > > > > with a black screen.
> > > > 
> > > > How can I change the printing?
> > > 
> > > Hmm. It seems I might have been wrong here. Rafael, do we still have
> > > console suspend stuff?
> > 
> > Yes, we do.  Use "no_console_suspend" in the kernel command line to change
> > that, but note that it's not generally safe (eg. if you are using netconsole at
> > the same time).
> 
> I see. System reset hard and clock set to 1904, PMU didn't like me :)
> 
> Thing is, I do have no_console_suspend (hardcoded in my boot loader
> config so I forgot), but even with PM-debug I didn't see it hang at b43
> and no useful messages. Not sure what to do, hence asking if anybody has
> the rtc-trace stuff.

It hangs for me either at read_unlock_irqrestore() in b43_op_tx() or somewhere
in ieee80211_tx() (at various places).

Thanks,
Rafael


From johannes at sipsolutions.net  Sat May 31 00:38:10 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sat, 31 May 2008 00:38:10 +0200
Subject: suspend vs. b43
In-Reply-To: <200805302319.34173.rjw@sisk.pl>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805301720.49327.rjw@sisk.pl>
	<1212162163.7238.1.camel@johannes.berg>
	<200805302319.34173.rjw@sisk.pl>
Message-ID: <1212187090.20421.2.camel@johannes.berg>


> It hangs for me either at read_unlock_irqrestore() in b43_op_tx() or somewhere
> in ieee80211_tx() (at various places).

Huh. Why is it even getting into the tx path? And even then, why does it
hang at an unlock?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080531/29f7cb82/attachment.pgp>

From proski at gnu.org  Sat May 31 00:39:02 2008
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 30 May 2008 18:39:02 -0400
Subject: [PATCH] b43legacy: Fix controller restart crash
In-Reply-To: <20080528191224.GB25770@tuxdriver.com>
References: <200805221706.37185.mb@bu3sch.de>
	<20080528191224.GB25770@tuxdriver.com>
Message-ID: <1212187142.18496.19.camel@dv>

On Wed, 2008-05-28 at 15:12 -0400, John W. Linville wrote:

> > Stefano, this is untested. Please test by doing
> > echo -n 1 >/debug/b43legacy/phy*/restart
> > rmmod b43legacy
> > It should not crash anymore at the rmmod (actually the restart should
> > also hang in b43legacy, as it has a deadlock, which this patch also fixes).
> 
> Anyone get a chance to test this one?

Yes, the patch is fine.

Unloading b43legacy hangs without the patch and works properly with the
patch.

-- 
Regards,
Pavel Roskin


From rjw at sisk.pl  Sat May 31 00:49:41 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 31 May 2008 00:49:41 +0200
Subject: suspend vs. b43
In-Reply-To: <1212187090.20421.2.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805302319.34173.rjw@sisk.pl>
	<1212187090.20421.2.camel@johannes.berg>
Message-ID: <200805310049.41782.rjw@sisk.pl>

On Saturday, 31 of May 2008, Johannes Berg wrote:
> 
> > It hangs for me either at read_unlock_irqrestore() in b43_op_tx() or somewhere
> > in ieee80211_tx() (at various places).
> 
> Huh. Why is it even getting into the tx path? And even then, why does it
> hang at an unlock?

Well, I saw that during hibernation, so it probably happened after creating the
image, when devices were being resumed for image saving.

Thanks,
Rafael


From johannes at sipsolutions.net  Sat May 31 00:54:33 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sat, 31 May 2008 00:54:33 +0200
Subject: suspend vs. b43
In-Reply-To: <200805310049.41782.rjw@sisk.pl>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805302319.34173.rjw@sisk.pl>
	<1212187090.20421.2.camel@johannes.berg>
	<200805310049.41782.rjw@sisk.pl>
Message-ID: <1212188073.20421.5.camel@johannes.berg>

On Sat, 2008-05-31 at 00:49 +0200, Rafael J. Wysocki wrote:
> On Saturday, 31 of May 2008, Johannes Berg wrote:
> > 
> > > It hangs for me either at read_unlock_irqrestore() in b43_op_tx() or somewhere
> > > in ieee80211_tx() (at various places).
> > 
> > Huh. Why is it even getting into the tx path? And even then, why does it
> > hang at an unlock?
> 
> Well, I saw that during hibernation, so it probably happened after creating the
> image, when devices were being resumed for image saving.

Yeah, like I said earlier to somebody. Still doesn't make much sense
here. I'll play with it next week, or you could try to put into
suspend() a call to ieee80211_stop_queues() and in resume
ieee80211_wake_queues(), maybe that fixes it? I probably won't have time
over the weekend to look more into it, sorry.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080531/de670d44/attachment.pgp>

From rjw at sisk.pl  Sat May 31 01:05:24 2008
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 31 May 2008 01:05:24 +0200
Subject: suspend vs. b43
In-Reply-To: <1212188073.20421.5.camel@johannes.berg>
References: <1212150713.4117.2.camel@johannes.berg>
	<200805310049.41782.rjw@sisk.pl>
	<1212188073.20421.5.camel@johannes.berg>
Message-ID: <200805310105.24781.rjw@sisk.pl>

On Saturday, 31 of May 2008, Johannes Berg wrote:
> On Sat, 2008-05-31 at 00:49 +0200, Rafael J. Wysocki wrote:
> > On Saturday, 31 of May 2008, Johannes Berg wrote:
> > > 
> > > > It hangs for me either at read_unlock_irqrestore() in b43_op_tx() or somewhere
> > > > in ieee80211_tx() (at various places).
> > > 
> > > Huh. Why is it even getting into the tx path? And even then, why does it
> > > hang at an unlock?
> > 
> > Well, I saw that during hibernation, so it probably happened after creating the
> > image, when devices were being resumed for image saving.
> 
> Yeah, like I said earlier to somebody. Still doesn't make much sense
> here. I'll play with it next week, or you could try to put into
> suspend() a call to ieee80211_stop_queues() and in resume
> ieee80211_wake_queues(), maybe that fixes it? I probably won't have time
> over the weekend to look more into it, sorry.

No big deal. :-)

It's always been breaking for me like this ...

Thanks,
Rafael


From netrolller.3d at gmail.com  Sat May 31 16:23:58 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 31 May 2008 16:23:58 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet transmit
Message-ID: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>

In the latest wireless-testing kernel, I get a panic when I try to
connect to a network or inject a packet in monitor mode using b43
(stack obtained using kdump and crash):

crash> bt -l
PID: 0      TASK: c0431340  CPU: 0   COMMAND: "swapper"
 #0 [c04617bc] crash_kexec at c015ce2a
    /usr/src/wl-hack/wireless-testing/kernel/kexec.c: 1077
 #1 [c046180c] die at c01054ba
    /usr/src/wl-hack/wireless-testing/arch/x86/kernel/traps_32.c: 476
 #2 [c0461828] do_page_fault at c034ef1f
    /usr/src/wl-hack/wireless-testing/arch/x86/mm/fault.c: 858
 #3 [c0461994] error_code (via page_fault) at c034d2e8
    /usr/src/wl-hack/wireless-testing/arch/i386/kernel/entry.S
    EAX: 00000000  EBX: 00000000  ECX: f6103000  EDX: f75ed4a0  EBP: c0461a58
    DS:  007b      ESI: 00000002  ES:  007b      EDI: 00000074
    CS:  0060      EIP: f8dd3a99  ERR: ffffffff  EFLAGS: 00010046
 #4 [c04619c8] b43_generate_txhdr at f8dd3a99
 #5 [c0461a5c] b43_dma_tx at f8dd83d7
 #6 [c0461ae4] b43_op_tx at f8dc4d32
 #7 [c0461afc] __ieee80211_tx at f89c3ed4
 #8 [c0461b14] ieee80211_master_start_xmit at f89c4b6d
 #9 [c0461b74] dev_hard_start_xmit at c02d4cb5
    /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
#10 [c0461ba0] __qdisc_run at c02e678d
    /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
#11 [c0461bd8] dev_queue_xmit at c02d5172
    include/net/pkt_sched.h: 89
#12 [c0461c04] ieee80211_subif_start_xmit at f89c45db
#13 [c0461cc0] dev_hard_start_xmit at c02d4cb5
    /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
#14 [c0461cec] __qdisc_run at c02e678d
    /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
#15 [c0461d24] dev_queue_xmit at c02d5172
    include/net/pkt_sched.h: 89
#16 [c0461d50] neigh_resolve_output at c02dac3e
    /usr/src/wl-hack/wireless-testing/net/core/neighbour.c: 1215
#17 [c0461d90] ip6_output_finish at f8d55c9e
#18 [c0461db0] ip6_output2 at f8d57e63
#19 [c0461dd4] ip6_output at f8d58418
#20 [c0461e50] mld_sendpack at f8d70d8d
#21 [c0461ebc] mld_ifc_timer_expire at f8d71a94
#22 [c0461ef0] run_timer_softirq at c0138547
    /usr/src/wl-hack/wireless-testing/kernel/timer.c: 798
#23 [c0461f34] __do_softirq at c0134230
    /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 234
#24 [c0461f50] do_softirq at c0134318
    /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 271
#25 [c0461f5c] irq_exit at c01344b0
    /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 310
#26 [c0461f64] smp_apic_timer_interrupt at c0113583
    /usr/src/wl-hack/wireless-testing/arch/x86/kernel/apic_32.c: 619
#27 [c0461f7c] apic_timer_interrupt at c0104963
    include/linux/kdev_t.h: 52
#28 [c0461fbc] cpu_idle at c0102d69
    /usr/src/wl-hack/wireless-testing/arch/x86/kernel/process_32.c: 188

No out-of-tree patches applied on b43. (I used to have a patch
applied, but I removed it to test reproducibility of this crash.)

Any ideas why this happens?

Thanks,
G?bor


From mb at bu3sch.de  Sat May 31 17:11:15 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 31 May 2008 17:11:15 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
Message-ID: <200805311711.16266.mb@bu3sch.de>

On Saturday 31 May 2008 16:23:58 Stefanik G?bor wrote:
> In the latest wireless-testing kernel, I get a panic when I try to
> connect to a network or inject a packet in monitor mode using b43
> (stack obtained using kdump and crash):
> 
> crash> bt -l
> PID: 0      TASK: c0431340  CPU: 0   COMMAND: "swapper"
>  #0 [c04617bc] crash_kexec at c015ce2a
>     /usr/src/wl-hack/wireless-testing/kernel/kexec.c: 1077
>  #1 [c046180c] die at c01054ba
>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/traps_32.c: 476
>  #2 [c0461828] do_page_fault at c034ef1f
>     /usr/src/wl-hack/wireless-testing/arch/x86/mm/fault.c: 858
>  #3 [c0461994] error_code (via page_fault) at c034d2e8
>     /usr/src/wl-hack/wireless-testing/arch/i386/kernel/entry.S
>     EAX: 00000000  EBX: 00000000  ECX: f6103000  EDX: f75ed4a0  EBP: c0461a58
>     DS:  007b      ESI: 00000002  ES:  007b      EDI: 00000074
>     CS:  0060      EIP: f8dd3a99  ERR: ffffffff  EFLAGS: 00010046
>  #4 [c04619c8] b43_generate_txhdr at f8dd3a99
>  #5 [c0461a5c] b43_dma_tx at f8dd83d7
>  #6 [c0461ae4] b43_op_tx at f8dc4d32
>  #7 [c0461afc] __ieee80211_tx at f89c3ed4
>  #8 [c0461b14] ieee80211_master_start_xmit at f89c4b6d
>  #9 [c0461b74] dev_hard_start_xmit at c02d4cb5
>     /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
> #10 [c0461ba0] __qdisc_run at c02e678d
>     /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
> #11 [c0461bd8] dev_queue_xmit at c02d5172
>     include/net/pkt_sched.h: 89
> #12 [c0461c04] ieee80211_subif_start_xmit at f89c45db
> #13 [c0461cc0] dev_hard_start_xmit at c02d4cb5
>     /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
> #14 [c0461cec] __qdisc_run at c02e678d
>     /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
> #15 [c0461d24] dev_queue_xmit at c02d5172
>     include/net/pkt_sched.h: 89
> #16 [c0461d50] neigh_resolve_output at c02dac3e
>     /usr/src/wl-hack/wireless-testing/net/core/neighbour.c: 1215
> #17 [c0461d90] ip6_output_finish at f8d55c9e
> #18 [c0461db0] ip6_output2 at f8d57e63
> #19 [c0461dd4] ip6_output at f8d58418
> #20 [c0461e50] mld_sendpack at f8d70d8d
> #21 [c0461ebc] mld_ifc_timer_expire at f8d71a94
> #22 [c0461ef0] run_timer_softirq at c0138547
>     /usr/src/wl-hack/wireless-testing/kernel/timer.c: 798
> #23 [c0461f34] __do_softirq at c0134230
>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 234
> #24 [c0461f50] do_softirq at c0134318
>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 271
> #25 [c0461f5c] irq_exit at c01344b0
>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 310
> #26 [c0461f64] smp_apic_timer_interrupt at c0113583
>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/apic_32.c: 619
> #27 [c0461f7c] apic_timer_interrupt at c0104963
>     include/linux/kdev_t.h: 52
> #28 [c0461fbc] cpu_idle at c0102d69
>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/process_32.c: 188
> 
> No out-of-tree patches applied on b43. (I used to have a patch
> applied, but I removed it to test reproducibility of this crash.)
> 
> Any ideas why this happens?

Please provide more information. For example as for what "crash" means.
Is this a NULL pointer dereference or whatever?
Please put a few printks into b43_generate_txhdr()


-- 
Greetings Michael.


From netrolller.3d at gmail.com  Sat May 31 18:34:29 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 31 May 2008 18:34:29 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <200805311711.16266.mb@bu3sch.de>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311711.16266.mb@bu3sch.de>
Message-ID: <69e28c910805310934w7d2bc2ddkec27926a8c8033c4@mail.gmail.com>

On Sat, May 31, 2008 at 5:11 PM, Michael Buesch <mb at bu3sch.de> wrote:
> On Saturday 31 May 2008 16:23:58 Stefanik G?bor wrote:
>> In the latest wireless-testing kernel, I get a panic when I try to
>> connect to a network or inject a packet in monitor mode using b43
>> (stack obtained using kdump and crash):
>>
>> crash> bt -l
>> PID: 0      TASK: c0431340  CPU: 0   COMMAND: "swapper"
>>  #0 [c04617bc] crash_kexec at c015ce2a
>>     /usr/src/wl-hack/wireless-testing/kernel/kexec.c: 1077
>>  #1 [c046180c] die at c01054ba
>>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/traps_32.c: 476
>>  #2 [c0461828] do_page_fault at c034ef1f
>>     /usr/src/wl-hack/wireless-testing/arch/x86/mm/fault.c: 858
>>  #3 [c0461994] error_code (via page_fault) at c034d2e8
>>     /usr/src/wl-hack/wireless-testing/arch/i386/kernel/entry.S
>>     EAX: 00000000  EBX: 00000000  ECX: f6103000  EDX: f75ed4a0  EBP: c0461a58
>>     DS:  007b      ESI: 00000002  ES:  007b      EDI: 00000074
>>     CS:  0060      EIP: f8dd3a99  ERR: ffffffff  EFLAGS: 00010046
>>  #4 [c04619c8] b43_generate_txhdr at f8dd3a99
>>  #5 [c0461a5c] b43_dma_tx at f8dd83d7
>>  #6 [c0461ae4] b43_op_tx at f8dc4d32
>>  #7 [c0461afc] __ieee80211_tx at f89c3ed4
>>  #8 [c0461b14] ieee80211_master_start_xmit at f89c4b6d
>>  #9 [c0461b74] dev_hard_start_xmit at c02d4cb5
>>     /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
>> #10 [c0461ba0] __qdisc_run at c02e678d
>>     /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
>> #11 [c0461bd8] dev_queue_xmit at c02d5172
>>     include/net/pkt_sched.h: 89
>> #12 [c0461c04] ieee80211_subif_start_xmit at f89c45db
>> #13 [c0461cc0] dev_hard_start_xmit at c02d4cb5
>>     /usr/src/wl-hack/wireless-testing/net/core/dev.c: 1558
>> #14 [c0461cec] __qdisc_run at c02e678d
>>     /usr/src/wl-hack/wireless-testing/net/sched/sch_generic.c: 155
>> #15 [c0461d24] dev_queue_xmit at c02d5172
>>     include/net/pkt_sched.h: 89
>> #16 [c0461d50] neigh_resolve_output at c02dac3e
>>     /usr/src/wl-hack/wireless-testing/net/core/neighbour.c: 1215
>> #17 [c0461d90] ip6_output_finish at f8d55c9e
>> #18 [c0461db0] ip6_output2 at f8d57e63
>> #19 [c0461dd4] ip6_output at f8d58418
>> #20 [c0461e50] mld_sendpack at f8d70d8d
>> #21 [c0461ebc] mld_ifc_timer_expire at f8d71a94
>> #22 [c0461ef0] run_timer_softirq at c0138547
>>     /usr/src/wl-hack/wireless-testing/kernel/timer.c: 798
>> #23 [c0461f34] __do_softirq at c0134230
>>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 234
>> #24 [c0461f50] do_softirq at c0134318
>>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 271
>> #25 [c0461f5c] irq_exit at c01344b0
>>     /usr/src/wl-hack/wireless-testing/kernel/softirq.c: 310
>> #26 [c0461f64] smp_apic_timer_interrupt at c0113583
>>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/apic_32.c: 619
>> #27 [c0461f7c] apic_timer_interrupt at c0104963
>>     include/linux/kdev_t.h: 52
>> #28 [c0461fbc] cpu_idle at c0102d69
>>     /usr/src/wl-hack/wireless-testing/arch/x86/kernel/process_32.c: 188
>>
>> No out-of-tree patches applied on b43. (I used to have a patch
>> applied, but I removed it to test reproducibility of this crash.)
>>
>> Any ideas why this happens?
>
> Please provide more information. For example as for what "crash" means.
> Is this a NULL pointer dereference or whatever?
> Please put a few printks into b43_generate_txhdr()
>
>
> --
> Greetings Michael.
>

"Crash" = /usr/bin/crash, the GDB-based crashdump debugger.
It's a NULL pointer dereference. I didn't know that when I sent my
previous message, because the kernel doesn't boot in anything but
80x25 mode (vesafb modes result in a blank screen, other VGA modes
like 80x50 either show a jumbled mess of fonts or are ignored in favor
of 80x25, likely a vesafb bug - BTW nvidia video card), so I only see
the bottom of the panic message. (That's why I had to use Crash to
retrieve the stack.) I used the command "bt -l" to get the stack
originally. Since then I discovered the "log" command, which allowed
me to retrieve the full message. (It's the first time I ever debug a
kdump, sorry.)
So, anyway, here is the full panic message, as it was printed out on the screen:

"BUG: unable to handle kernel NULL pointer dereference at 00000004
IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
*pdpt = 00000000360f0001 *pde = 0000000000000000
Oops: 0000 [#1] SMP
Modules linked in: rfkill_input b43 ocfs2_dlmfs ocfs2_dlm
ocfs2_nodemanager configfs ipv6 microcode af_packet snd_pcm_oss
binfmt_misc snd_mixer_oss snd_seq snd_seq_device fuse ext3 jbd mbcache
loop dm_mod joydev rt73usb crc_itu_t arc4 rt2x00usb snd_hda_intel
rt2x00lib ecb crypto_blkcipher ssb rfkill snd_aw2 pcmcia usbhid
forcedeth snd_pcm ohci1394 pcmcia_core zd1211rw sr_mod led_class hid
sata_nv ieee1394 snd_hwdep snd_timer firmware_class i2c_nforce2 cdrom
isp1760 button input_polldev snd ff_memless i2c_core snd_page_alloc
mac80211 soundcore sg cfg80211 ehci_hcd ohci_hcd sd_mod usbcore edd
reiserfs fan pata_amd libata scsi_mod dock thermal processor [last
unloaded: speedstep_lib]

Pid: 0, comm: swapper Not tainted (2.6.26-rc4-wl-wireless6 #8)
EIP: 0060:[<f8dd3a99>] EFLAGS: 00010046 CPU: 0
EIP is at b43_generate_txhdr+0x6a9/0x790 [b43]
EAX: 00000000 EBX: 00000000 ECX: f6103000 EDX: f75ed4a0
ESI: 00000002 EDI: 00000074 EBP: c0461a58 ESP: c04619d0
 DS: 007b ES: 007b FS: 00d8 GS: 0000 SS: 0068
Process swapper (pid: 0, ti=c0460000 task=c0431340 task.ti=c0460000)
Stack: 00000000 00000000 00000000 f78aee00 00000040 00004108 40201a0c f61c302c
       f6880dc0 f6103000 00000101 00000002 00000002 00000d80 02984108 00000074
       f88a2bc7 3798e6c0 00000000 f798e6c0 f798e060 f798e6c0 00000200 00000000
Call Trace:
 [<f88a2bc7>] ? qh_urb_transaction+0xe7/0x3e0 [ehci_hcd]
 [<f8dd83dc>] ? b43_dma_tx+0x19c/0x800 [b43]
 [<f8dc4d37>] ? b43_op_tx+0x57/0xc0 [b43]
 [<f89c3ed6>] ? __ieee80211_tx+0x16/0x120 [mac80211]
 [<f89c4b72>] ? ieee80211_master_start_xmit+0x262/0x310 [mac80211]
 [<c02d4cbb>] ? dev_hard_start_xmit+0x24b/0x2e0
 [<c02e6792>] ? __qdisc_run+0x62/0x1e0
 [<c02d5177>] ? dev_queue_xmit+0x307/0x380
 [<f89c45e0>] ? ieee80211_subif_start_xmit+0x3e0/0x710 [mac80211]
 [<c0123da4>] ? __enqueue_entity+0xd4/0x100
 [<c011f3c7>] ? enqueue_task+0x57/0x70
 [<c01251b4>] ? try_to_wake_up+0x74/0x1f0
 [<c02d4cbb>] ? dev_hard_start_xmit+0x24b/0x2e0
 [<c012533b>] ? default_wake_function+0xb/0x10
 [<c014366b>] ? autoremove_wake_function+0x1b/0x50
 [<c02e6792>] ? __qdisc_run+0x62/0x1e0
 [<c02d5177>] ? dev_queue_xmit+0x307/0x380
 [<c02dac41>] ? neigh_resolve_output+0xf1/0x2a0
 [<f8d6fdcc>] ? ipv6_chk_mcast_addr+0xbc/0x180 [ipv6]
 [<f8d55ca1>] ? ip6_output_finish+0x91/0xe0 [ipv6]
 [<f8d57e68>] ? ip6_output2+0x138/0x220 [ipv6]
 [<f8d5841d>] ? ip6_output+0x4cd/0xb30 [ipv6]
 [<c0138be5>] ? lock_timer_base+0x25/0x50
 [<c0138d91>] ? __mod_timer+0xa1/0xe0
 [<c0138e87>] ? mod_timer+0x37/0x80
 [<f8d641db>] ? fib6_force_start_gc+0x2b/0x30 [ipv6]
 [<f8d70d90>] ? mld_sendpack+0x2d0/0x330 [ipv6]
 [<f8d71a99>] ? mld_ifc_timer_expire+0x259/0x2f0 [ipv6]
 [<c014cf7b>] ? clockevents_program_event+0x9b/0x150
 [<c013854a>] ? run_timer_softirq+0x12a/0x1f0
 [<f8d71840>] ? mld_ifc_timer_expire+0x0/0x2f0 [ipv6]
 [<f8d71840>] ? mld_ifc_timer_expire+0x0/0x2f0 [ipv6]
 [<c0134232>] ? __do_softirq+0x92/0x120
 [<c013431d>] ? do_softirq+0x5d/0x60
 [<c01344b5>] ? irq_exit+0x75/0xa0
 [<c0113588>] ? smp_apic_timer_interrupt+0x58/0x90
 [<c0109ca0>] ? mwait_idle+0x0/0x50
 [<c0104968>] ? apic_timer_interrupt+0x28/0x30
 [<c0109ca0>] ? mwait_idle+0x0/0x50
 [<c0109cd2>] ? mwait_idle+0x32/0x50
 [<c0102d6b>] ? cpu_idle+0x6b/0xf0
 [<c033e09e>] ? rest_init+0x4e/0x60
 =======================
Code: 26 00 c7 45 d8 0c 00 00 00 90 e9 7b fc ff ff 8d 76 00 0f b6 4d
af c7 45 d8 02 00 00 00 89 4d f0 eb ae 8b 55 0c 8b 4d 9c 8b 42 0c <0f>
b6 58 04 3a 99 c2 03 00 00 0f 83 b9 00 00 00 8b 7d 9c 0f b6
EIP: [<f8dd3a99>] b43_generate_txhdr+0x6a9/0x790 [b43] SS:ESP 0068:c04619d0"

Full output of crash>log (essentially "dmesg" on a kdump) is attached as a file.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: b43_generate_txhdr_panic.log
Type: text/x-log
Size: 43919 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080531/392c4a10/attachment.bin>

From mb at bu3sch.de  Sat May 31 18:41:46 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 31 May 2008 18:41:46 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <69e28c910805310934w7d2bc2ddkec27926a8c8033c4@mail.gmail.com>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311711.16266.mb@bu3sch.de>
	<69e28c910805310934w7d2bc2ddkec27926a8c8033c4@mail.gmail.com>
Message-ID: <200805311841.46740.mb@bu3sch.de>

On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
> "BUG: unable to handle kernel NULL pointer dereference at 00000004
> IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790

So can you put a few printks into the function to see where it dereferences
a NULL pointer? (or use gdb to lookup the offset).


-- 
Greetings Michael.


From proski at gnu.org  Sat May 31 18:48:42 2008
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 31 May 2008 12:48:42 -0400
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
Message-ID: <1212252522.2766.8.camel@rd>

Hello!

You beat me at reporting it.  I was about to report the same thing.
Basically, my laptop with bcm4311 started crashing when using WEP in the
last weeks.  Its runs the current wireless-testing.

On Sat, 2008-05-31 at 16:23 +0200, Stefanik G?bor wrote:
>  #4 [c04619c8] b43_generate_txhdr at f8dd3a99

Yes, that's where it happens.  This patch prevents the panic, but it's
almost certainly not the right fix.

diff --git a/drivers/net/wireless/b43/xmit.c
b/drivers/net/wireless/b43/xmit.c
index f9e1cff..5ec8d86 100644
--- a/drivers/net/wireless/b43/xmit.c
+++ b/drivers/net/wireless/b43/xmit.c
@@ -234,11 +234,14 @@ int b43_generate_txhdr(struct b43_wldev *dev,
 
 	plcp_fragment_len = fragment_len + FCS_LEN;
 	if (use_encryption) {
-		u8 key_idx = info->control.hw_key->hw_key_idx;
+		u8 key_idx;
 		struct b43_key *key;
 		int wlhdr_len;
 		size_t iv_len;
 
+		if (!info->control.hw_key)
+			return -ENOKEY;
+		key_idx = info->control.hw_key->hw_key_idx;
 		B43_WARN_ON(key_idx >= dev->max_nr_keys);
 		key = &(dev->key[key_idx]);
 
Another workaround is to use nohwcrypt=1 in the module options.

It's strange that other drivers (b43legacy, ath5k) use
info->control.hw_key->hw_key_idx under the same conditions (see how
use_encryption is calculated), but don't have any problems on the same
network (but I need to recheck).

I'm using 40-bit WEP with wpa_supplicant (because it's configured to
recognize many networks, some of which are with WPA).  I don't know if
it's relevant.  It's Fedora 9 for x86_64, but NetworkManager is
disabled.

-- 
Regards,
Pavel Roskin


From proski at gnu.org  Sat May 31 18:50:36 2008
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 31 May 2008 12:50:36 -0400
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <200805311841.46740.mb@bu3sch.de>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311711.16266.mb@bu3sch.de>
	<69e28c910805310934w7d2bc2ddkec27926a8c8033c4@mail.gmail.com>
	<200805311841.46740.mb@bu3sch.de>
Message-ID: <1212252636.2766.10.camel@rd>

On Sat, 2008-05-31 at 18:41 +0200, Michael Buesch wrote:
> On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
> > "BUG: unable to handle kernel NULL pointer dereference at 00000004
> > IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
> 
> So can you put a few printks into the function to see where it dereferences
> a NULL pointer? (or use gdb to lookup the offset).

u8 key_idx = info->control.hw_key->hw_key_idx;

info->control.hw_key is NULL.

-- 
Regards,
Pavel Roskin


From netrolller.3d at gmail.com  Sat May 31 18:54:24 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 31 May 2008 18:54:24 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <1212252522.2766.8.camel@rd>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<1212252522.2766.8.camel@rd>
Message-ID: <69e28c910805310954s6c478001h837415a6a63d26f0@mail.gmail.com>

On Sat, May 31, 2008 at 6:48 PM, Pavel Roskin <proski at gnu.org> wrote:
> It's strange that other drivers (b43legacy, ath5k) use
> info->control.hw_key->hw_key_idx under the same conditions (see how
> use_encryption is calculated), but don't have any problems on the same
> network (but I need to recheck).

Hmm... does ath5k use hardware crypto? B43 does (but not with
nohwcrypt - and that appears to be a valid workaround), b43legacy
doesn't AFAIK.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From proski at gnu.org  Sat May 31 19:06:44 2008
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 31 May 2008 13:06:44 -0400
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <69e28c910805310954s6c478001h837415a6a63d26f0@mail.gmail.com>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<1212252522.2766.8.camel@rd>
	<69e28c910805310954s6c478001h837415a6a63d26f0@mail.gmail.com>
Message-ID: <1212253604.2766.15.camel@rd>

On Sat, 2008-05-31 at 18:54 +0200, Stefanik G?bor wrote:
> On Sat, May 31, 2008 at 6:48 PM, Pavel Roskin <proski at gnu.org> wrote:
> > It's strange that other drivers (b43legacy, ath5k) use
> > info->control.hw_key->hw_key_idx under the same conditions (see how
> > use_encryption is calculated), but don't have any problems on the same
> > network (but I need to recheck).
> 
> Hmm... does ath5k use hardware crypto?

No, it doesn't, at least with WEP, if I understand ath5k_set_key()
correctly.

> B43 does (but not with
> nohwcrypt - and that appears to be a valid workaround), b43legacy
> doesn't AFAIK.

Although the code with use_encryption is present in b43legacy, it don't
see any references to "set_key", so I guess you are right.

Well, that explains something.

-- 
Regards,
Pavel Roskin


From mb at bu3sch.de  Sat May 31 19:54:46 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 31 May 2008 19:54:46 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <1212252636.2766.10.camel@rd>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311841.46740.mb@bu3sch.de> <1212252636.2766.10.camel@rd>
Message-ID: <200805311954.46639.mb@bu3sch.de>

On Saturday 31 May 2008 18:50:36 Pavel Roskin wrote:
> On Sat, 2008-05-31 at 18:41 +0200, Michael Buesch wrote:
> > On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
> > > "BUG: unable to handle kernel NULL pointer dereference at 00000004
> > > IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
> > 
> > So can you put a few printks into the function to see where it dereferences
> > a NULL pointer? (or use gdb to lookup the offset).
> 
> u8 key_idx = info->control.hw_key->hw_key_idx;
> 
> info->control.hw_key is NULL.

Is a NULL pointer supposed to tell "do not encrypt", or is this a mac80211 bug?

-- 
Greetings Michael.


From mb at bu3sch.de  Sat May 31 19:59:18 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 31 May 2008 19:59:18 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <1212252522.2766.8.camel@rd>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<1212252522.2766.8.camel@rd>
Message-ID: <200805311959.18475.mb@bu3sch.de>

On Saturday 31 May 2008 18:48:42 Pavel Roskin wrote:
> It's strange that other drivers (b43legacy, ath5k) use

b43legacy does not support hwcrypto, so it can't crash.

-- 
Greetings Michael.


From ccmcphe at verizon.net  Sat May 31 22:05:11 2008
From: ccmcphe at verizon.net (Clyde McPherson)
Date: Sat, 31 May 2008 16:05:11 -0400
Subject: cancel_work_sync() question
Message-ID: <4841AF77.7050100@verizon.net>

I am trying to port the Broadcom drivers to an ARM archicture  (Linux 
version 2.6.21) and it appears that cancel_work_sync() is missing from 
its kernel. Is there any other function that I can replace it with?

Thanks
Tex



From johannes at sipsolutions.net  Sat May 31 22:22:02 2008
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sat, 31 May 2008 22:22:02 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <200805311954.46639.mb@bu3sch.de>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311841.46740.mb@bu3sch.de> <1212252636.2766.10.camel@rd>
	<200805311954.46639.mb@bu3sch.de>
Message-ID: <1212265322.7672.2.camel@johannes.berg>

On Sat, 2008-05-31 at 19:54 +0200, Michael Buesch wrote:
> On Saturday 31 May 2008 18:50:36 Pavel Roskin wrote:
> > On Sat, 2008-05-31 at 18:41 +0200, Michael Buesch wrote:
> > > On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
> > > > "BUG: unable to handle kernel NULL pointer dereference at 00000004
> > > > IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
> > > 
> > > So can you put a few printks into the function to see where it dereferences
> > > a NULL pointer? (or use gdb to lookup the offset).
> > 
> > u8 key_idx = info->control.hw_key->hw_key_idx;
> > 
> > info->control.hw_key is NULL.
> 
> Is a NULL pointer supposed to tell "do not encrypt", or is this a mac80211 bug?

It's probably a bug.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 828 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20080531/3aa0aca6/attachment.pgp>

From netrolller.3d at gmail.com  Sat May 31 22:29:13 2008
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?Stefanik_G=E1bor?=)
Date: Sat, 31 May 2008 22:29:13 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <1212265322.7672.2.camel@johannes.berg>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<200805311841.46740.mb@bu3sch.de> <1212252636.2766.10.camel@rd>
	<200805311954.46639.mb@bu3sch.de>
	<1212265322.7672.2.camel@johannes.berg>
Message-ID: <69e28c910805311329v8f29c42mbb97ab553cc6e96c@mail.gmail.com>

On Sat, May 31, 2008 at 10:22 PM, Johannes Berg
<johannes at sipsolutions.net> wrote:
> On Sat, 2008-05-31 at 19:54 +0200, Michael Buesch wrote:
>> On Saturday 31 May 2008 18:50:36 Pavel Roskin wrote:
>> > On Sat, 2008-05-31 at 18:41 +0200, Michael Buesch wrote:
>> > > On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
>> > > > "BUG: unable to handle kernel NULL pointer dereference at 00000004
>> > > > IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
>> > >
>> > > So can you put a few printks into the function to see where it dereferences
>> > > a NULL pointer? (or use gdb to lookup the offset).
>> >
>> > u8 key_idx = info->control.hw_key->hw_key_idx;
>> >
>> > info->control.hw_key is NULL.
>>
>> Is a NULL pointer supposed to tell "do not encrypt", or is this a mac80211 bug?
>
> It's probably a bug.
>
> johannes
>

Should we assume that it's the first key if it happens?


From mb at bu3sch.de  Sat May 31 22:48:55 2008
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 31 May 2008 22:48:55 +0200
Subject: Wireless-testing's b43 panics in b43_generate_txhdr on packet
	transmit
In-Reply-To: <69e28c910805311329v8f29c42mbb97ab553cc6e96c@mail.gmail.com>
References: <69e28c910805310723j2b721030x2609cc9e866abafa@mail.gmail.com>
	<1212265322.7672.2.camel@johannes.berg>
	<69e28c910805311329v8f29c42mbb97ab553cc6e96c@mail.gmail.com>
Message-ID: <200805312248.55551.mb@bu3sch.de>

On Saturday 31 May 2008 22:29:13 Stefanik G?bor wrote:
> On Sat, May 31, 2008 at 10:22 PM, Johannes Berg
> <johannes at sipsolutions.net> wrote:
> > On Sat, 2008-05-31 at 19:54 +0200, Michael Buesch wrote:
> >> On Saturday 31 May 2008 18:50:36 Pavel Roskin wrote:
> >> > On Sat, 2008-05-31 at 18:41 +0200, Michael Buesch wrote:
> >> > > On Saturday 31 May 2008 18:34:29 Stefanik G?bor wrote:
> >> > > > "BUG: unable to handle kernel NULL pointer dereference at 00000004
> >> > > > IP: [<f8dd3a99>] :b43:b43_generate_txhdr+0x6a9/0x790
> >> > >
> >> > > So can you put a few printks into the function to see where it dereferences
> >> > > a NULL pointer? (or use gdb to lookup the offset).
> >> >
> >> > u8 key_idx = info->control.hw_key->hw_key_idx;
> >> >
> >> > info->control.hw_key is NULL.
> >>
> >> Is a NULL pointer supposed to tell "do not encrypt", or is this a mac80211 bug?
> >
> > It's probably a bug.
> >
> > johannes
> >
> 
> Should we assume that it's the first key if it happens?

No. It looks like it should not happen at all.


-- 
Greetings Michael.


