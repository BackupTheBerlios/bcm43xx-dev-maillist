From sbrown at ewol.com  Thu Feb  1 00:09:49 2007
From: sbrown at ewol.com (Steve Brown)
Date: Wed, 31 Jan 2007 18:09:49 -0500
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <45C121BD.50301@ewol.com>

Michael Buesch wrote:
> I need some real-life data to estimate what the
> ITSSI value usually is on different cards.
> (ITSSI is called savedpctlreg in softmac driver).
>
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.
>
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-28 13:59:51.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-31 17:01:59.000000000 +0100
> @@ -235,6 +235,7 @@ static void bcm43xx_phy_init_pctl(struct
>  	bcm43xx_dummy_transmission(bcm);
>  
>  	phy->savedpctlreg = bcm43xx_phy_read(bcm, BCM43xx_PHY_G_PCTL);
> +printk("savedpctlreg == %d\n", phy->savedpctlreg);
>  
>  	if (must_reset_txpower)
>  		bcm43xx_radio_set_txpower_bg(bcm, saved_batt, saved_ratt, saved_txctl1);
>
>
>   
 From a 4318 on an ASUS WL-120g
Jan 31 16:01:45 mythtv kernel: savedpctlreg == 48

Steve



From rjw at sisk.pl  Thu Feb  1 00:11:09 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 1 Feb 2007 00:11:09 +0100
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <200702010011.10090.rjw@sisk.pl>

On Wednesday, 31 January 2007 17:04, Michael Buesch wrote:
> I need some real-life data to estimate what the
> ITSSI value usually is on different cards.
> (ITSSI is called savedpctlreg in softmac driver).
> 
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.

This is from Linux-2.6.20-rc7 (x86_64) on HPC nx6325:

bcm43xx driver
ACPI: PCI Interrupt 0000:30:00.0[A] -> GSI 18 (level, low) -> IRQ 18
PCI: Setting latency timer of device 0000:30:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
printk: 3 messages suppressed.
SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:30
6:ieee80211softmac_wx_get_rate()
SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
bcm43xx: PHY connected
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
savedpctlreg == 52
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)

"lspci -v" says:

30:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
        Subsystem: Hewlett-Packard Company Unknown device 1361
        Flags: bus master, fast devsel, latency 0, IRQ 18
        Memory at c8000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel

Greetings,
Rafael


From larry.finger at lwfinger.net  Thu Feb  1 00:32:02 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 17:32:02 -0600
Subject: Connected, but...
In-Reply-To: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
References: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
Message-ID: <45C126F2.8010600@lwfinger.net>

Igor Korot wrote:
> Hi,
> I have very strange problem. Maybe it's because I'm running 2.6.18 kernel, but I think I saw somebody connected and worked with this version.

I have run a 4311 with a 2.6.18 kernel with the patches you are using.

I do have some questions:

1. Is wpa_supplicant running? You can see that in a 'ps ax' listing.

2. If wpa_supplicant is running, it should have a '-c' switch followed by a file name, probably
/var/run... and ending in .conf. Copy that file to some other other directory and post it after
removing your secrets from it.

3. Check for an ifcfg-eth1 file, probably located in /etc/sysconfig/network. Again post that after
removing your secrets.

Larry



From rjw at sisk.pl  Thu Feb  1 00:38:19 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 1 Feb 2007 00:38:19 +0100
Subject: Connected, but...
In-Reply-To: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
References: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
Message-ID: <200702010038.19822.rjw@sisk.pl>

On Wednesday, 31 January 2007 23:25, Igor Korot wrote:
> Hi,
> I have very strange problem. Maybe it's because I'm running 2.6.18 kernel, but I think I saw somebody connected and worked with this version.
> 
> I have a bcm4311 card (Dell 1390 mini-PCI).
> 
> 0b:00.0 Network controller: Broadcom Corporation Unknown device 4311 (rev 01)
>         Subsystem: Dell Unknown device 0007
>         Flags: bus master, fast devsel, latency 0, IRQ 16
>         Memory at dfdfc000 (32-bit, non-prefetchable) [size=16K]
>         Capabilities: [40] Power Management version 2
>         Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0 Enable-
>         Capabilities: [d0] Express Legacy Endpoint IRQ 0
>         Capabilities: [100] Advanced Error Reporting
>         Capabilities: [13c] Virtual Channel
> 
> I am using the 2.6.18 gentoo kernel with the PCIE, LED and interrupt patches.
> 
> Also, I have a wpa_supplicant version 0.5.4.
> 
> After the following commands:
> 
> ifconfig eth1 up
> iwlist eth1 scan
> iwconfig eth1 essid "IgorNetwork"
> 
> my GNOME shows connection for the eth1 interface. However, there is no transmission.
> I can't ping, I can't load the page using the wireless connection. The WiFi LED is on after
> the interface was brought up.

That pretty much reflects what I'm observing with BCM4311 on HPC nx6325, plus
D-Link access points are not listed by "iwlist eth2 scan" (I wonder what's so
special about D-Link access points ...).

I have another machine with a bcm43xx here, but it has the 4306 chip and works
just fine.  I've tried to run tcpdump on it to check if I can see some traffic
from the nx6325, but apparently I can't.

I can, however, to the reverse, ie. run tcpdump on the nx6325 and sniff the
traffic from the other box (but not from the access point to it, although the
access point is a D-Link one, so ...).

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From Larry.Finger at lwfinger.net  Thu Feb  1 01:50:19 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 18:50:19 -0600
Subject: [PATCH] ieee80211: Fix sparse warning
Message-ID: <45c1394b.An8WeE68tSLsbJYy%Larry.Finger@lwfinger.net>

Sparse issues the warning "warning: symbol 'crypt' shadows an earlier one"
in net/ieee80211/ieee80211_tx.c.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/net/ieee80211/ieee80211_tx.c
===================================================================
--- wireless-2.6.orig/net/ieee80211/ieee80211_tx.c
+++ wireless-2.6/net/ieee80211/ieee80211_tx.c
@@ -502,8 +502,6 @@ int ieee80211_xmit(struct sk_buff *skb, 
 		if (host_encrypt)
 			ieee80211_encrypt_fragment(ieee, skb_frag, hdr_len);
 		else if (host_build_iv) {
-			struct ieee80211_crypt_data *crypt;
-
 			crypt = ieee->crypt[ieee->tx_keyidx];
 			atomic_inc(&crypt->refcnt);
 			if (crypt->ops->build_iv)


From larry.finger at lwfinger.net  Thu Feb  1 02:30:17 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 19:30:17 -0600
Subject: Connected, but...
In-Reply-To: <200702010038.19822.rjw@sisk.pl>
References: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
	<200702010038.19822.rjw@sisk.pl>
Message-ID: <45C142A9.6020705@lwfinger.net>

Rafael J. Wysocki wrote:
> 
> That pretty much reflects what I'm observing with BCM4311 on HPC nx6325, plus
> D-Link access points are not listed by "iwlist eth2 scan" (I wonder what's so
> special about D-Link access points ...).
> 
> I have another machine with a bcm43xx here, but it has the 4306 chip and works
> just fine.  I've tried to run tcpdump on it to check if I can see some traffic
> from the nx6325, but apparently I can't.

Kismet (www.kismetwireless.net/) can capture packets to/from any bcm43xx device. You can then use
Ethereal (or whatever it is called now) to analyze the data. I used this process to determine why I
couldn't connect to a Linksys WRT54G V5 when a V1 worked just fine. Of course, softmac was modified
long ago to get around Linksys's bug!

Larry


From ikorot at earthlink.net  Thu Feb  1 03:15:37 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Wed, 31 Jan 2007 18:15:37 -0800 (GMT-08:00)
Subject: Connected, but...
Message-ID: <14749304.1170296137867.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>

Thank you for the reply, Larry.
I will try to install Kismet along with the Ethereal.

What output do you want? Just the Kismet log file?
Or something from Ethreal?

Thank you.

-----Original Message-----
>From: Larry Finger <larry.finger at lwfinger.net>
>Sent: Jan 31, 2007 5:30 PM
>To: "Rafael J. Wysocki" <rjw at sisk.pl>
>Cc: bcm43xx-dev at lists.berlios.de, Igor Korot <ikorot at earthlink.net>, Michael Buesch <mb at bu3sch.de>
>Subject: Re: Connected, but...
>
>Rafael J. Wysocki wrote:
>> 
>> That pretty much reflects what I'm observing with BCM4311 on HPC nx6325, plus
>> D-Link access points are not listed by "iwlist eth2 scan" (I wonder what's so
>> special about D-Link access points ...).
>> 
>> I have another machine with a bcm43xx here, but it has the 4306 chip and works
>> just fine.  I've tried to run tcpdump on it to check if I can see some traffic
>> from the nx6325, but apparently I can't.
>
>Kismet (www.kismetwireless.net/) can capture packets to/from any bcm43xx device. You can then use
>Ethereal (or whatever it is called now) to analyze the data. I used this process to determine why I
>couldn't connect to a Linksys WRT54G V5 when a V1 worked just fine. Of course, softmac was modified
>long ago to get around Linksys's bug!
>
>Larry



From larry.finger at lwfinger.net  Thu Feb  1 03:25:02 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 20:25:02 -0600
Subject: Connected, but...
In-Reply-To: <14749304.1170296137867.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
References: <14749304.1170296137867.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
Message-ID: <45C14F7E.1070306@lwfinger.net>

Igor Korot wrote:
> Thank you for the reply, Larry.
> I will try to install Kismet along with the Ethereal.
> 
> What output do you want? Just the Kismet log file?
> Or something from Ethreal?

You can send me (privately) the kismet file. I'll run Ethereal on it.

Larry





From ikorot at earthlink.net  Thu Feb  1 05:56:49 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Wed, 31 Jan 2007 23:56:49 -0500 (EST)
Subject: Connected, but...
Message-ID: <144218.1170305809556.JavaMail.root@elwamui-royal.atl.sa.earthlink.net>

OK.

-----Original Message-----
>From: Larry Finger <larry.finger at lwfinger.net>
>Sent: Jan 31, 2007 9:25 PM
>To: Igor Korot <ikorot at earthlink.net>
>Cc: "Rafael J. Wysocki" <rjw at sisk.pl>, bcm43xx-dev at lists.berlios.de, Michael Buesch <mb at bu3sch.de>
>Subject: Re: Connected, but...
>
>Igor Korot wrote:
>> Thank you for the reply, Larry.
>> I will try to install Kismet along with the Ethereal.
>> 
>> What output do you want? Just the Kismet log file?
>> Or something from Ethreal?
>
>You can send me (privately) the kismet file. I'll run Ethereal on it.
>
>Larry
>
>
>



From benoit.knecht at citycable.ch  Thu Feb  1 13:51:19 2007
From: benoit.knecht at citycable.ch (=?ISO-8859-1?Q?Beno=EEt_Knecht?=)
Date: Thu, 01 Feb 2007 13:51:19 +0100
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <45C1E247.4050809@citycable.ch>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Michael Buesch wrote:
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.

On my iBook (PPC), with BCM4318, I get:
savedpctlreg == 45

Beno?t
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFFweJHy0EwBJvkHIMRAjwZAJwK15U1N/+VkvkVAbUSXEDR7tIG7ACeOorm
r2epOGpN7gbvOVe9e5bQ4jU=
=sXjm
-----END PGP SIGNATURE-----


From mb at bu3sch.de  Thu Feb  1 15:51:59 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 Feb 2007 15:51:59 +0100
Subject: Need testing help
In-Reply-To: <45C1E247.4050809@citycable.ch>
References: <200701311704.43955.mb@bu3sch.de> <45C1E247.4050809@citycable.ch>
Message-ID: <200702011551.59209.mb@bu3sch.de>

Ok, thank you all for your help.

Now I "only" have to find out why I get zero there :)

-- 
Greetings Michael.


From mjg59 at srcf.ucam.org  Thu Feb  1 16:04:21 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Thu, 1 Feb 2007 15:04:21 +0000
Subject: Problem with the lid closing event
In-Reply-To: <45BF959C.2050809@gmail.com>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
	<45BF62B2.3070600@lwfinger.net>
	<200701301818.49856.ubq7@stud.uni-karlsruhe.de>
	<45BF959C.2050809@gmail.com>
Message-ID: <20070201150421.GA28327@srcf.ucam.org>

On Tue, Jan 30, 2007 at 12:59:40PM -0600, Jory A. Pratt wrote:

> VBETOOLS is useless on x86_64, the package is only for i386 to i686
> 32bit machines, so your suggestion is useless in this case.

There's a reason it includes a copy of x86emu...

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From asil.jinn at gmail.com  Thu Feb  1 17:18:34 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Thu, 1 Feb 2007 17:18:34 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <200701312055.14492.mb@bu3sch.de>
References: <45C03A97.5070005@lwfinger.net> <200701311652.55238.mb@bu3sch.de>
	<fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
	<200701312055.14492.mb@bu3sch.de>
Message-ID: <fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>

screenshot. Tried both with modules and builtin, same oops message.

00:00.0 0600: 8086:27a0 (rev 03)
00:01.0 0604: 8086:27a1 (rev 03)
00:1b.0 0403: 8086:27d8 (rev 01)
00:1c.0 0604: 8086:27d0 (rev 01)
00:1c.1 0604: 8086:27d2 (rev 01)
00:1c.2 0604: 8086:27d4 (rev 01)
00:1d.0 0c03: 8086:27c8 (rev 01)
00:1d.1 0c03: 8086:27c9 (rev 01)
00:1d.2 0c03: 8086:27ca (rev 01)
00:1d.3 0c03: 8086:27cb (rev 01)
00:1d.7 0c03: 8086:27cc (rev 01)
00:1e.0 0604: 8086:2448 (rev e1)
00:1f.0 0601: 8086:27b9 (rev 01)
00:1f.2 0101: 8086:27c4 (rev 01)
00:1f.3 0c05: 8086:27da (rev 01)
01:00.0 0300: 10de:01d7 (rev a1)
09:00.0 0200: 14e4:1600 (rev 02)
0c:00.0 0280: 14e4:4312 (rev 01)

00:00.0 Host bridge: Intel Corporation Mobile 945GM/PM/GMS/940GML and 945GT
Express Memory Controller Hub (rev 03)
00:01.0 PCI bridge: Intel Corporation Mobile 945GM/PM/GMS/940GML and 945GT
Express PCI Express Root Port (rev 03)
00:1b.0 Audio device: Intel Corporation 82801G (ICH7 Family) High Definition
Audio Controller (rev 01)
00:1c.0 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
1 (rev 01)
00:1c.1 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
2 (rev 01)
00:1c.2 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
3 (rev 01)
00:1d.0 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #1
(rev 01)
00:1d.1 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #2
(rev 01)
00:1d.2 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #3
(rev 01)
00:1d.3 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #4
(rev 01)
00:1d.7 USB Controller: Intel Corporation 82801G (ICH7 Family) USB2 EHCI
Controller (rev 01)
00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev e1)
00:1f.0 ISA bridge: Intel Corporation 82801GBM (ICH7-M) LPC Interface Bridge
(rev 01)
00:1f.2 IDE interface: Intel Corporation 82801GBM/GHM (ICH7 Family) Serial
ATA Storage Controller IDE (rev 01)
00:1f.3 SMBus: Intel Corporation 82801G (ICH7 Family) SMBus Controller (rev
01)
01:00.0 VGA compatible controller: nVidia Corporation Quadro NVS 110M /
GeForce Go 7300 (rev a1)
09:00.0 Ethernet controller: Broadcom Corporation NetXtreme BCM5752 Gigabit
Ethernet PCI Express (rev 02)
0c:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)





2007/1/31, Michael Buesch <mb at bu3sch.de>:
>
> On Wednesday 31 January 2007 18:27, Asil Jinn wrote:
> > Micheal.. but my email was not a bug report, which you will also notice
> if
> > you read it again. It was a simple status check of how it was going with
> the
> > smp part.
>
> Well, nobody here on the list wants to know about your private testing
> sessions.
> If you are making your testing results public, _please_ do it completely
> or
> avoid sending any mail in the first place. It's only these two options to
> not waste people's time. Things like "It crashes for me, but I won't say
> what's
> going on" is just annoying and wasting other peoples time. I can't see any
> valueable information in such an email.
>
> > However it is a good idea to add the logs either way, but I have checked
> > kernel.log, and other log messages in /var/log/ and couldnt find the
> > specific information of the wireless-dev kernel crash. I have to hard
> reboot
> > every time it crashes.. I am using syslog-ng, Is there anything else I
> > should be using to get kernel crash logs?
>
> Ok, I think you need to setup a netconsole or serial console to
> live-capture
> the oops message. Crash messages usually don't appear in the syslogs.
> Or you can use a digital camera and take a photo of the screen.
>
> --
> Greetings Michael.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070201/7f117cff/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: bcm43xx_builtin.jpeg
Type: image/jpeg
Size: 115824 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070201/7f117cff/attachment.jpeg>

From mb at bu3sch.de  Thu Feb  1 17:41:40 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 1 Feb 2007 17:41:40 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net> <200701312055.14492.mb@bu3sch.de>
	<fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>
Message-ID: <200702011741.40361.mb@bu3sch.de>

On Thursday 01 February 2007 17:18, Asil Jinn wrote:
> screenshot. Tried both with modules and builtin, same oops message.

Please raise your console loglevel and try again.
All interresting information is hidden.

echo -n 6 >/proc/sys/kernel/printk

-- 
Greetings Michael.


From johannes at sipsolutions.net  Thu Feb  1 17:44:58 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 01 Feb 2007 17:44:58 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net> <200701311652.55238.mb@bu3sch.de>
	<fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
	<200701312055.14492.mb@bu3sch.de>
	<fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>
Message-ID: <1170348298.22420.20.camel@johannes.berg>

Your initramfs is broken. Nothing related to bcm43xx at all. Come back
when your system actually boots.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070201/7e6d2016/attachment.pgp>

From ikorot at earthlink.net  Thu Feb  1 21:46:17 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Thu, 1 Feb 2007 12:46:17 -0800 (GMT-08:00)
Subject: Another strange thing with the driver
Message-ID: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>

Hi, guys,
I just did a little test yesterday, and today.
The problem below occur when on the dual-boot laptop, you boot Windows first, suspend it to disk, then boot Linux.

I have a Dell Inspiron E1505 with WinXP and Gentoo installed.

And this is exactly what happened.

If you then re-boot Linux (Gentoo, in my case), and will try to bring the interface up, it will run without any problems.

I don't know what is happenning after hibernating the XP, and booting Linux, and why the interface is up after re-booting Linux, but that the story behind this problem.

Larry, will Kismet out help to track this one as well?

Thank you.

Hi, Larry,
I found another strange thing with the driver.
I was able to successfully establish the connection using "wireless tools".
I just installed wpa_supplicant", and here is what happened:

IgorsGentooOnNetwork igor # ifconfig eth1 up
SIOCSIFFLAGS: Protocol error


Looking at dmesg, I found that the problem is in the firmware:

bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.
bcm43xx: core_up for active 802.11 core failed (-71)


Here is my /etc/conf.d/net

# This blank configuration will automatically use DHCP for any net.*
# scripts in /etc/init.d.  To create a more complete configuration,
# please review /etc/conf.d/net.example and save your configuration
# in /etc/conf.d/net (this file :]!).

#Wireless-tools
#nis_domain_lo="IgorsGentoo"
#modules=("iwconfig")
#key_ESSID1="[1] s:IgorsNetwork key [1] enc open"
#key_ESSID2="[1] aaaa-bbbb-cccc-dd key [1] enc estricted"
#preferred_aps=("ESSID1" "ESSID2")

#Wpa_supplicant
modules=( "wpa_supplicant" )
wpa_supplicant_eth1="-Dbcm43xx"

Here is my /etc/wpa_supplicant.conf

ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=0
ap_scan=1
network={
  ssid="IgorsNetwork"
  psk="abcdef"
  priority=5
}

Do I need to re-install the firmware going from wireless tools to wpa_supplicant?


Thank you.


From martin-langer at gmx.de  Thu Feb  1 22:39:02 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Thu, 1 Feb 2007 22:39:02 +0100
Subject: Another strange thing with the driver
In-Reply-To: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
References: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
Message-ID: <20070201213901.GA4172@tuba>

On Thu, Feb 01, 2007 at 12:46:17PM -0800, Igor Korot wrote:
> Hi, guys,
> I just did a little test yesterday, and today.
> The problem below occur when on the dual-boot laptop, you boot Windows first, suspend it to disk, then boot Linux.
> 
> I have a Dell Inspiron E1505 with WinXP and Gentoo installed.
> 
> And this is exactly what happened.
> 
> If you then re-boot Linux (Gentoo, in my case), and will try to bring the interface up, it will run without any problems.
> 
> I don't know what is happenning after hibernating the XP, and booting Linux, and why the interface is up after re-booting Linux, but that the story behind this problem.

Probably you are using different firmware versions under windows and 
linux (v4 at win and v3 at linux). It could be a problem of already uploaded 
v4 firmware that will not work with the v3 linux driver or vice versa. 

Martin


From ubq7 at stud.uni-karlsruhe.de  Thu Feb  1 22:44:58 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Thu, 1 Feb 2007 22:44:58 +0100
Subject: Another strange thing with the driver
In-Reply-To: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
References: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
Message-ID: <200702012244.58955.ubq7@stud.uni-karlsruhe.de>

Am Donnerstag 01 Februar 2007 21:46 schrieb Igor Korot:
> I just did a little test yesterday, and today.
> The problem below occur when on the dual-boot laptop, you boot Windows
> first, suspend it to disk, then boot Linux.

Be warned that this may result in data loss when you boot Windows, then!
Especially if you do anything with the windows partition during that time.

HS


From larry.finger at lwfinger.net  Thu Feb  1 22:56:53 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 01 Feb 2007 15:56:53 -0600
Subject: Another strange thing with the driver
In-Reply-To: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
References: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
Message-ID: <45C26225.1050105@lwfinger.net>

Igor Korot wrote:
> Hi, guys,
> I just did a little test yesterday, and today.
> The problem below occur when on the dual-boot laptop, you boot Windows first, suspend it to disk, then boot Linux.
> 
> I have a Dell Inspiron E1505 with WinXP and Gentoo installed.
> 
> And this is exactly what happened.
> 
> If you then re-boot Linux (Gentoo, in my case), and will try to bring the interface up, it will run without any problems.
> 
> I don't know what is happenning after hibernating the XP, and booting Linux, and why the interface is up after re-booting Linux, but that the story behind this problem.
> 
> Larry, will Kismet out help to track this one as well?

It might. I'm not sure what is happening. At least you will know if the interface is broadcasting.

> Thank you.
> 
> Hi, Larry,
> I found another strange thing with the driver.
> I was able to successfully establish the connection using "wireless tools".
> I just installed wpa_supplicant", and here is what happened:
> 
> IgorsGentooOnNetwork igor # ifconfig eth1 up
> SIOCSIFFLAGS: Protocol error
> 
> 
> Looking at dmesg, I found that the problem is in the firmware:
> 
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.
> bcm43xx: core_up for active 802.11 core failed (-71)
> 
> 
> Here is my /etc/conf.d/net
> 
> # This blank configuration will automatically use DHCP for any net.*
> # scripts in /etc/init.d.  To create a more complete configuration,
> # please review /etc/conf.d/net.example and save your configuration
> # in /etc/conf.d/net (this file :]!).
> 
> #Wireless-tools
> #nis_domain_lo="IgorsGentoo"
> #modules=("iwconfig")
> #key_ESSID1="[1] s:IgorsNetwork key [1] enc open"
> #key_ESSID2="[1] aaaa-bbbb-cccc-dd key [1] enc estricted"
> #preferred_aps=("ESSID1" "ESSID2")
> 
> #Wpa_supplicant
> modules=( "wpa_supplicant" )
> wpa_supplicant_eth1="-Dbcm43xx"
> 
> Here is my /etc/wpa_supplicant.conf
> 
> ctrl_interface=/var/run/wpa_supplicant
> ctrl_interface_group=0
> ap_scan=1
> network={
>   ssid="IgorsNetwork"
>   psk="abcdef"
>   priority=5
> }
> 
> Do I need to re-install the firmware going from wireless tools to wpa_supplicant?

Not usually. It looks as if your firmware got corrupted.

Larry



From rjw at sisk.pl  Fri Feb  2 00:48:27 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Fri, 2 Feb 2007 00:48:27 +0100
Subject: Another strange thing with the driver
In-Reply-To: <45C26225.1050105@lwfinger.net>
References: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
	<45C26225.1050105@lwfinger.net>
Message-ID: <200702020048.28414.rjw@sisk.pl>

On Thursday, 1 February 2007 22:56, Larry Finger wrote:
> Igor Korot wrote:
> > Hi, guys,
> > I just did a little test yesterday, and today.
> > The problem below occur when on the dual-boot laptop, you boot Windows first, suspend it to disk, then boot Linux.
> > 
> > I have a Dell Inspiron E1505 with WinXP and Gentoo installed.
> > 
> > And this is exactly what happened.
> > 
> > If you then re-boot Linux (Gentoo, in my case), and will try to bring the interface up, it will run without any problems.
> > 
> > I don't know what is happenning after hibernating the XP, and booting Linux, and why the interface is up after re-booting Linux, but that the story behind this problem.
> > 
> > Larry, will Kismet out help to track this one as well?
> 
> It might. I'm not sure what is happening. At least you will know if the interface is broadcasting.
> 
> > Thank you.
> > 
> > Hi, Larry,
> > I found another strange thing with the driver.
> > I was able to successfully establish the connection using "wireless tools".
> > I just installed wpa_supplicant", and here is what happened:
> > 
> > IgorsGentooOnNetwork igor # ifconfig eth1 up
> > SIOCSIFFLAGS: Protocol error
> > 
> > 
> > Looking at dmesg, I found that the problem is in the firmware:
> > 
> > bcm43xx: PHY connected
> > bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> > bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.
> > bcm43xx: core_up for active 802.11 core failed (-71)
> > 
> > 
> > Here is my /etc/conf.d/net
> > 
> > # This blank configuration will automatically use DHCP for any net.*
> > # scripts in /etc/init.d.  To create a more complete configuration,
> > # please review /etc/conf.d/net.example and save your configuration
> > # in /etc/conf.d/net (this file :]!).
> > 
> > #Wireless-tools
> > #nis_domain_lo="IgorsGentoo"
> > #modules=("iwconfig")
> > #key_ESSID1="[1] s:IgorsNetwork key [1] enc open"
> > #key_ESSID2="[1] aaaa-bbbb-cccc-dd key [1] enc estricted"
> > #preferred_aps=("ESSID1" "ESSID2")
> > 
> > #Wpa_supplicant
> > modules=( "wpa_supplicant" )
> > wpa_supplicant_eth1="-Dbcm43xx"
> > 
> > Here is my /etc/wpa_supplicant.conf
> > 
> > ctrl_interface=/var/run/wpa_supplicant
> > ctrl_interface_group=0
> > ap_scan=1
> > network={
> >   ssid="IgorsNetwork"
> >   psk="abcdef"
> >   priority=5
> > }
> > 
> > Do I need to re-install the firmware going from wireless tools to wpa_supplicant?
> 
> Not usually. It looks as if your firmware got corrupted.

BTW, can anyone please point me to a file containing the firmware that's
known to work with the 4311 and can be extracted by fwcutter?

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From mb at bu3sch.de  Fri Feb  2 15:54:10 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 2 Feb 2007 15:54:10 +0100
Subject: Another strange thing with the driver
In-Reply-To: <200702020048.28414.rjw@sisk.pl>
References: <4765257.1170362778233.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>
	<45C26225.1050105@lwfinger.net> <200702020048.28414.rjw@sisk.pl>
Message-ID: <200702021554.11243.mb@bu3sch.de>

On Friday 02 February 2007 00:48, Rafael J. Wysocki wrote:
> BTW, can anyone please point me to a file containing the firmware that's
> known to work with the 4311 and can be extracted by fwcutter?

http://bu3sch.de/bcm43xx_fw.php

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Feb  2 22:38:09 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 02 Feb 2007 15:38:09 -0600
Subject: [PATCH] ieee80211: Fix sparse warning
In-Reply-To: <20070202203201.GB9382@tuxdriver.com>
References: <45c1394b.An8WeE68tSLsbJYy%Larry.Finger@lwfinger.net>
	<20070202203201.GB9382@tuxdriver.com>
Message-ID: <45C3AF41.1030908@lwfinger.net>

John W. Linville wrote:
> On Wed, Jan 31, 2007 at 06:50:19PM -0600, Larry Finger wrote:
>> Sparse issues the warning "warning: symbol 'crypt' shadows an earlier one"
>> in net/ieee80211/ieee80211_tx.c.
>>
>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>> ---
>>
>> Index: wireless-2.6/net/ieee80211/ieee80211_tx.c
>> ===================================================================
>> --- wireless-2.6.orig/net/ieee80211/ieee80211_tx.c
>> +++ wireless-2.6/net/ieee80211/ieee80211_tx.c
>> @@ -502,8 +502,6 @@ int ieee80211_xmit(struct sk_buff *skb, 
>>  		if (host_encrypt)
>>  			ieee80211_encrypt_fragment(ieee, skb_frag, hdr_len);
>>  		else if (host_build_iv) {
>> -			struct ieee80211_crypt_data *crypt;
>> -
>>  			crypt = ieee->crypt[ieee->tx_keyidx];
>>  			atomic_inc(&crypt->refcnt);
>>  			if (crypt->ops->build_iv)
> 
> Couldn't you remove the "crypt = ieee->crypt[ieee->tx_keyidx];"
> as well?

Yes it can. I'll send a revised patch along shortly.

Larry


From Larry.Finger at lwfinger.net  Fri Feb  2 22:40:44 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 02 Feb 2007 15:40:44 -0600
Subject: [PATCH V2] ieee80211: Fix sparse warning
Message-ID: <45c3afdc.YY1dJ2xo5mgOWKh5%Larry.Finger@lwfinger.net>

Sparse issues the warning "warning: symbol 'crypt' shadows an earlier one"
in net/ieee80211/ieee80211_tx.c.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/net/ieee80211/ieee80211_tx.c
===================================================================
--- wireless-2.6.orig/net/ieee80211/ieee80211_tx.c
+++ wireless-2.6/net/ieee80211/ieee80211_tx.c
@@ -502,9 +502,6 @@ int ieee80211_xmit(struct sk_buff *skb, 
 		if (host_encrypt)
 			ieee80211_encrypt_fragment(ieee, skb_frag, hdr_len);
 		else if (host_build_iv) {
-			struct ieee80211_crypt_data *crypt;
-
-			crypt = ieee->crypt[ieee->tx_keyidx];
 			atomic_inc(&crypt->refcnt);
 			if (crypt->ops->build_iv)
 				crypt->ops->build_iv(skb_frag, hdr_len,


From rjw at sisk.pl  Sat Feb  3 00:54:48 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 3 Feb 2007 00:54:48 +0100
Subject: Success with 4311 on HPC nx6325
Message-ID: <200702030054.48506.rjw@sisk.pl>

Hi,

Some good news here. :-)

I've finally managed to make the 4311 in my nx6325 work.

Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
are recognized by it (still older ones are not).

The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
reading e-mail and web browsing. ;-)

Thanks,
Rafael
 

-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From ftoledo at docksud.com.ar  Sat Feb  3 01:03:29 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Fri, 02 Feb 2007 21:03:29 -0300
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702030054.48506.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl>
Message-ID: <45C3D151.6010404@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Rafael J. Wysocki escribi?:
> Hi,
> 
> Some good news here. :-)
> 
> I've finally managed to make the 4311 in my nx6325 work.
> 
> Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> are recognized by it (still older ones are not).
> 
> The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> reading e-mail and web browsing. ;-)
> 
> Thanks,
> Rafael
>  
> 
hi Rafael, can you tell me what versions of kernel and patches are using
you?

i can use my 4311 to connect to several AP's, but i still can't connect
to my dlink AP.
thanks!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFw9FRz8H9Vs7bTsMRAmyAAKCUbylXrsdEW7qEPwcwt5kqpQibYgCfUbbI
oZjVoJHqBcyt5njf9f6WnJ8=
=RGpV
-----END PGP SIGNATURE-----


From rjw at sisk.pl  Sat Feb  3 01:15:24 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 3 Feb 2007 01:15:24 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C3D151.6010404@docksud.com.ar>
References: <200702030054.48506.rjw@sisk.pl> <45C3D151.6010404@docksud.com.ar>
Message-ID: <200702030115.24849.rjw@sisk.pl>

On Saturday, 3 February 2007 01:03, Fernando Toledo wrote:
> Rafael J. Wysocki escribi?:
> > Hi,
> >
> > Some good news here. :-)
> >
> > I've finally managed to make the 4311 in my nx6325 work.
> >
> > Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> > are recognized by it (still older ones are not).
> >
> > The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> > reading e-mail and web browsing. ;-)
> >
> > Thanks,
> > Rafael
> >
> >
> hi Rafael, can you tell me what versions of kernel and patches are using
> you?

2.6.20-rc7 with the radio_enable_2.6.20 patch from Larry plus some other patches
that should not matter (full series at http://www.sisk.pl/kernel/patches/2.6.20-rc7/).
 
> i can use my 4311 to connect to several AP's, but i still can't connect
> to my dlink AP.

There are some D-Link APs I can't connect to, but they are older ones (like DI-624+).

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From larry.finger at lwfinger.net  Sat Feb  3 02:03:12 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 02 Feb 2007 19:03:12 -0600
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702030054.48506.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl>
Message-ID: <45C3DF50.1070506@lwfinger.net>

Rafael J. Wysocki wrote:
> Hi,
> 
> Some good news here. :-)
> 
> I've finally managed to make the 4311 in my nx6325 work.
> 
> Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> are recognized by it (still older ones are not).
> 
> The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> reading e-mail and web browsing. ;-)

Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).

Larry


From larry.finger at lwfinger.net  Sat Feb  3 02:07:19 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 02 Feb 2007 19:07:19 -0600
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C3D151.6010404@docksud.com.ar>
References: <200702030054.48506.rjw@sisk.pl> <45C3D151.6010404@docksud.com.ar>
Message-ID: <45C3E047.4050007@lwfinger.net>

Fernando,

Fernando Toledo wrote:
> i can use my 4311 to connect to several AP's, but i still can't connect
> to my dlink AP.
> thanks!


Do you have access to another computer with a wireless interface that can run kismet? A second
interface on the system with the bcm43xx would also work. If so, please start the kismet run, then
try to connect with the Dlink, and send the .dump file that kismet produces to me (privately).

Thanks,

Larry


From proski at gnu.org  Sat Feb  3 02:53:51 2007
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 02 Feb 2007 20:53:51 -0500
Subject: [PATCH] bcm43xx-sprom: fix access to et0mdcport and et1mdcport
Message-ID: <1170467631.9733.4.camel@dv>

From: Pavel Roskin <proski at gnu.org>

sprom[] is 8-bit so it has no bits 14 and 15.  Use bits 6 and 7 in
sprom[SPROM_ETHPHY + 1] for et0mdcport and et1mdcport respectively.

Signed-off-by: Pavel Roskin <proski at gnu.org>

Index: sprom/bcm43xx_sprom.c
===================================================================
--- sprom/bcm43xx_sprom.c	(revision 1217)
+++ sprom/bcm43xx_sprom.c	(working copy)
@@ -175,14 +175,14 @@
 		sprom[SPROM_ETHPHY + 1] = (tmp & 0xFF00) >> 8;
 		break;
 	case VALUE_ET0MDC:
-		sprom[SPROM_ETHPHY + 1] &= ~(1 << 14);
+		sprom[SPROM_ETHPHY + 1] &= ~(1 << 6);
 		if (v)
-			sprom[SPROM_ETHPHY + 1] |= (1 << 14);
+			sprom[SPROM_ETHPHY + 1] |= (1 << 6);
 		break;
 	case VALUE_ET1MDC:
-		sprom[SPROM_ETHPHY + 1] &= ~(1 << 15);
+		sprom[SPROM_ETHPHY + 1] &= ~(1 << 7);
 		if (v)
-			sprom[SPROM_ETHPHY + 1] |= (1 << 15);
+			sprom[SPROM_ETHPHY + 1] |= (1 << 7);
 		break;
 	case VALUE_BREV:
 		sprom[SPROM_BOARDREV + 0] = v;
@@ -377,14 +377,14 @@
 		desc = "et0mdcport";
 		offset = SPROM_ETHPHY + 1;
 		value = 0;
-		if (sprom[SPROM_ETHPHY + 1] & (1 << 14))
+		if (sprom[SPROM_ETHPHY + 1] & (1 << 6))
 			value = 1;
 		break;
 	case VALUE_ET1MDC:
 		desc = "et1mdcport";
 		offset = SPROM_ETHPHY + 1;
 		value = 0;
-		if (sprom[SPROM_ETHPHY + 1] & (1 << 15))
+		if (sprom[SPROM_ETHPHY + 1] & (1 << 7))
 			value = 1;
 		break;
 	case VALUE_BREV:


-- 
Regards,
Pavel Roskin




From mb at bu3sch.de  Sat Feb  3 14:40:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 3 Feb 2007 14:40:13 +0100
Subject: [PATCH] bcm43xx-sprom: fix access to et0mdcport and et1mdcport
In-Reply-To: <1170467631.9733.4.camel@dv>
References: <1170467631.9733.4.camel@dv>
Message-ID: <200702031440.14087.mb@bu3sch.de>

Applied, thanks.

On Saturday 03 February 2007 02:53, Pavel Roskin wrote:
> From: Pavel Roskin <proski at gnu.org>
> 
> sprom[] is 8-bit so it has no bits 14 and 15.  Use bits 6 and 7 in
> sprom[SPROM_ETHPHY + 1] for et0mdcport and et1mdcport respectively.
> 
> Signed-off-by: Pavel Roskin <proski at gnu.org>
> 
> Index: sprom/bcm43xx_sprom.c
> ===================================================================
> --- sprom/bcm43xx_sprom.c	(revision 1217)
> +++ sprom/bcm43xx_sprom.c	(working copy)
> @@ -175,14 +175,14 @@
>  		sprom[SPROM_ETHPHY + 1] = (tmp & 0xFF00) >> 8;
>  		break;
>  	case VALUE_ET0MDC:
> -		sprom[SPROM_ETHPHY + 1] &= ~(1 << 14);
> +		sprom[SPROM_ETHPHY + 1] &= ~(1 << 6);
>  		if (v)
> -			sprom[SPROM_ETHPHY + 1] |= (1 << 14);
> +			sprom[SPROM_ETHPHY + 1] |= (1 << 6);
>  		break;
>  	case VALUE_ET1MDC:
> -		sprom[SPROM_ETHPHY + 1] &= ~(1 << 15);
> +		sprom[SPROM_ETHPHY + 1] &= ~(1 << 7);
>  		if (v)
> -			sprom[SPROM_ETHPHY + 1] |= (1 << 15);
> +			sprom[SPROM_ETHPHY + 1] |= (1 << 7);
>  		break;
>  	case VALUE_BREV:
>  		sprom[SPROM_BOARDREV + 0] = v;
> @@ -377,14 +377,14 @@
>  		desc = "et0mdcport";
>  		offset = SPROM_ETHPHY + 1;
>  		value = 0;
> -		if (sprom[SPROM_ETHPHY + 1] & (1 << 14))
> +		if (sprom[SPROM_ETHPHY + 1] & (1 << 6))
>  			value = 1;
>  		break;
>  	case VALUE_ET1MDC:
>  		desc = "et1mdcport";
>  		offset = SPROM_ETHPHY + 1;
>  		value = 0;
> -		if (sprom[SPROM_ETHPHY + 1] & (1 << 15))
> +		if (sprom[SPROM_ETHPHY + 1] & (1 << 7))
>  			value = 1;
>  		break;
>  	case VALUE_BREV:
> 
> 

-- 
Greetings Michael.


From mail at puchalla-online.de  Sat Feb  3 16:21:47 2007
From: mail at puchalla-online.de (Jochen Puchalla)
Date: Sat, 3 Feb 2007 16:21:47 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C3DF50.1070506@lwfinger.net>
References: <200702030054.48506.rjw@sisk.pl> <45C3DF50.1070506@lwfinger.net>
Message-ID: <200702031621.51525.mail@puchalla-online.de>

[Samstag, 3. Februar 2007 02:03] schrieb Larry Finger (wrote):
> Rafael J. Wysocki wrote:
> > Hi,
> >
> > Some good news here. :-)
> >
> > I've finally managed to make the 4311 in my nx6325 work.
> >
> > Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> > are recognized by it (still older ones are not).
> >
> > The transfer rates are rather low (20 - 25 KB/s downstream), but
> > sufficient for reading e-mail and web browsing. ;-)
>
> Contrary to logic, if you set your rate to 1M, you will get better
> throughput. Copying a file across my internal network with the rate set at
> 1M, I get 81 KB/s upload and 66 on download. Both are close to the expected
> maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).

I also got it working with 2.6.20-rc7 and the radio enable patch. Downstream 
is 101kB/s maximum at 1M bitrate, according to apt-get. 
I'll try to get a second machine to run kismet, but cannot promise anything.
Great Job, Larry, thanks!

Gru?,
Jochen 
-- 
"In a world without fences and walls, who needs gates and windows?"

Das bessere Office kostenlos: http://de.openoffice.org/
Einfach der bessere Browser:  http://www.mozilla.com/firefox/all
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070203/848e2bf4/attachment.pgp>

From asil.jinn at gmail.com  Sat Feb  3 17:01:31 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Sat, 3 Feb 2007 17:01:31 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <1170348298.22420.20.camel@johannes.berg>
References: <45C03A97.5070005@lwfinger.net> <200701311652.55238.mb@bu3sch.de>
	<fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
	<200701312055.14492.mb@bu3sch.de>
	<fb1e10a90702010818j298e5ce7tf1134b0942c99c49@mail.gmail.com>
	<1170348298.22420.20.camel@johannes.berg>
Message-ID: <fb1e10a90702030801l21370b1bn67b85b324d547356@mail.gmail.com>

tried the console loglevel, got the same much info again. Have tried to
build the initramfs again, same result. Just to be sure that i am doing it
right, I rebuilt my other kernels initramfs and it worked..


2007/2/1, Johannes Berg <johannes at sipsolutions.net>:
>
> Your initramfs is broken. Nothing related to bcm43xx at all. Come back
> when your system actually boots.
>
> johannes
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070203/df3eed19/attachment.html>

From Larry.Finger at lwfinger.net  Sat Feb  3 18:50:10 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 03 Feb 2007 11:50:10 -0600
Subject: RFT: bcm43xx resume patch
Message-ID: <45C4CB52.2050605@lwfinger.net>

If you are having trouble with communications after a suspend/resume cycle, please try the patch
below. The patch was made against wireless-2.6, but should apply to any 2.6.18 or later kernel. I
cannot test this one as my video driver refuses to suspend.

Thanks,

Larry

=====================

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -4295,6 +4295,7 @@ static int bcm43xx_resume(struct pci_dev
 {
 	struct net_device *net_dev = pci_get_drvdata(pdev);
 	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
+	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	int err = 0;

 	dprintk(KERN_INFO PFX "Resuming...\n");
@@ -4314,6 +4315,7 @@ static int bcm43xx_resume(struct pci_dev
 		printk(KERN_ERR PFX "Resume failed!\n");
 		return err;
 	}
+	phy->lo_control->txctl2 = 0xFFFF; /* force initial lo calibration */
 	netif_device_attach(net_dev);

 	dprintk(KERN_INFO PFX "Device resumed.\n");

===========




From Larry.Finger at lwfinger.net  Sat Feb  3 20:34:20 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 03 Feb 2007 13:34:20 -0600
Subject: [PATCH] bcm43xx: Janitorial change - remove two unused variables
	extracted from sprom
Message-ID: <45c4e3bc.U2YROV+7jDTmdxqd%Larry.Finger@lwfinger.net>

Two bit-field values are extracted from the sprom data and never used.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -513,8 +513,6 @@ struct bcm43xx_sprominfo {
 	u8 et1macaddr[6];
 	u8 et0phyaddr:5;
 	u8 et1phyaddr:5;
-	u8 et0mdcport:1;
-	u8 et1mdcport:1;
 	u8 boardrev;
 	u8 locale:4;
 	u8 antennas_aphy:2;
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -856,8 +856,6 @@ static int bcm43xx_sprom_extract(struct 
 	value = sprom[BCM43xx_SPROM_ETHPHY];
 	bcm->sprom.et0phyaddr = (value & 0x001F);
 	bcm->sprom.et1phyaddr = (value & 0x03E0) >> 5;
-	bcm->sprom.et0mdcport = (value & (1 << 14)) >> 14;
-	bcm->sprom.et1mdcport = (value & (1 << 15)) >> 15;
 
 	/* boardrev, antennas, locale */
 	value = sprom[BCM43xx_SPROM_BOARDREV];


From mb at bu3sch.de  Sat Feb  3 20:53:21 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 3 Feb 2007 20:53:21 +0100
Subject: RFT: bcm43xx resume patch
In-Reply-To: <45C4CB52.2050605@lwfinger.net>
References: <45C4CB52.2050605@lwfinger.net>
Message-ID: <200702032053.21628.mb@bu3sch.de>

On Saturday 03 February 2007 18:50, Larry Finger wrote:
> If you are having trouble with communications after a suspend/resume cycle, please try the patch
> below. The patch was made against wireless-2.6, but should apply to any 2.6.18 or later kernel. I
> cannot test this one as my video driver refuses to suspend.

I think this is redundant. We clear (=0xFFFF) txctl2 on resume, too, because
we call init_board, which calls the function to init the structures.

> Thanks,
> 
> Larry
> 
> =====================
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -4295,6 +4295,7 @@ static int bcm43xx_resume(struct pci_dev
>  {
>  	struct net_device *net_dev = pci_get_drvdata(pdev);
>  	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
> +	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
>  	int err = 0;
> 
>  	dprintk(KERN_INFO PFX "Resuming...\n");
> @@ -4314,6 +4315,7 @@ static int bcm43xx_resume(struct pci_dev
>  		printk(KERN_ERR PFX "Resume failed!\n");
>  		return err;
>  	}
> +	phy->lo_control->txctl2 = 0xFFFF; /* force initial lo calibration */
>  	netif_device_attach(net_dev);
> 
>  	dprintk(KERN_INFO PFX "Device resumed.\n");
> 
> ===========
> 
> 
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sat Feb  3 21:18:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 03 Feb 2007 14:18:26 -0600
Subject: RFT: bcm43xx resume patch
In-Reply-To: <200702032053.21628.mb@bu3sch.de>
References: <45C4CB52.2050605@lwfinger.net> <200702032053.21628.mb@bu3sch.de>
Message-ID: <45C4EE12.2030505@lwfinger.net>

Michael Buesch wrote:
> On Saturday 03 February 2007 18:50, Larry Finger wrote:
>> If you are having trouble with communications after a suspend/resume cycle, please try the patch
>> below. The patch was made against wireless-2.6, but should apply to any 2.6.18 or later kernel. I
>> cannot test this one as my video driver refuses to suspend.
> 
> I think this is redundant. We clear (=0xFFFF) txctl2 on resume, too, because
> we call init_board, which calls the function to init the structures.

I don't think that happens on SoftMAC. The original initialization is in read_phyinfo, which is
called from attach_board, and that is only called from init_one. I don't see init_board calling
anything that touches txctl2. As a result, I only think the initialization happens at initial module
load, not at resume.

Of course, the original txctl2 initialization has a "FIXME: this is in the wrong place" attached to
it. Perhaps that should be moved to init_board. Are there any other initializations that must be
considered?

Larry





From rjw at sisk.pl  Sat Feb  3 23:30:46 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 3 Feb 2007 23:30:46 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C3DF50.1070506@lwfinger.net>
References: <200702030054.48506.rjw@sisk.pl> <45C3DF50.1070506@lwfinger.net>
Message-ID: <200702032330.46480.rjw@sisk.pl>

On Saturday, 3 February 2007 02:03, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > Hi,
> > 
> > Some good news here. :-)
> > 
> > I've finally managed to make the 4311 in my nx6325 work.
> > 
> > Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> > are recognized by it (still older ones are not).
> > 
> > The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> > reading e-mail and web browsing. ;-)
> 
> Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
> my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
> to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).

Ah, thanks for the hint.  With the rate set to 1M I get similar results.

Greetings,
Rafael



From Larry.Finger at lwfinger.net  Sun Feb  4 07:26:27 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 04 Feb 2007 00:26:27 -0600
Subject: Free Linux Driver Development!
Message-ID: <45C57C93.2020808@lwfinger.net>

On Thu, Feb 01, 2007 at 09:45:45PM EST, Lennart Sorensen wrote:
>On Thu, Feb 01, 2007 at 02:59:03PM +0100, Erik Mouw wrote:
>> I can't remember that kind of corruption ever being reported to the
>> bcm43xx-dev mailing list.

I came into this discussion late as I only read LKML in summary form, but I feel I need to address
several misconceptions here.

>Well I assumed it messed up the eeprom settings, since we had to go into
>the advanced driver settings and change it from 802.11b only back to
>auto mode and I would think those settings are stored in the eeprom if
>booting a 2.6.18 kernel and loading the bcm43xx driver can cause it to
>stop working, then it has to be an eeprom setting.

As Michael Buesch has explained, bcm43xx only changes the eeprom under very controlled circumstances
that never happen accidentally. It is much more likely that your Windows driver uses V4 firmware,
whereas bcm43xx uses V3. Without a power-off step to erase the firmware the results are likely to be
indeterminate.

>Actually I suppose the other posibility is that you simply have to power
>cycle before booting windows after linux to avoid any left over settings
>in the chip from being a problem. That may be what I did. Given I
>couldn't get the card to connect using the bcm43xx driver anyhow, I
>didn't spend too much time trying (I am fairly sure I set the AP to
>802.11g only though which may have been a problem).

It is _NOT_ true that bcm43xx only works with 802.11b. My AP is set in 802.11g-only mode and I have
been using bcm43xx with it for nearly a year. What is true is that none of the OFDM rates work
because of some unknown bug, probably in initialization. As a result, we are limited to a maximum
data rate of 11Mbs, but it is still running in 802.11g mode!

>> You could use a CardBus or USB card.
>
>I just don't like things sticking out that are breakable.
>
>> So are the bcm43xx maintainers.
>
>Excellent. Is the bcm43xx planning to get 802.11g mode working at some
>point? Is broadcom ever going to help out with any specs for their
>hardware or do they still mistakenly believe that end users are not
>their customers? Given the behaviour of broadcom over the years I know
>I don't intend to buy anything with a broadcom chip in it again, which
>means broadcom's behaviour directly means they will get less sales to the
>laptop makers, since some people will actively avoid anything with
>broadcom's hardware in it. :)

I certainly would hope for a even a little cooperation from Broadcom; however, it is not easy to
avoid getting their hardware, particularly with laptops. When I recently upgraded, my primary aims
were (1) a 14 inch screen  as the native resolution of a larger one makes things too small for my
eyes and reduced resolution looks crappy on an LCD, and (2) an AMD 64 X2 processor to run an x86_64
OS. The kind of wireless card contained within was not an issue, although the BCM4311 that I got
turned out to be a benefit as I became the first developer with the hardware needed to find and fix
two major outstanding bugs.

While I'm on my soapbox, I want to thank the group that reverse-engineered the Broadcom chips and
the group that did the early coding on the driver. Although the current driver still has its faults,
the fact that there is a working driver that doesn't hang or crash an SMP version of Linux and
offers usable wireless service for such a complicated piece of totally undocumented hardware is a
real tribute to those two groups. Thanks guys.

Larry Finger
bcm43xx Maintainer


From mb at bu3sch.de  Sun Feb  4 11:36:14 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 4 Feb 2007 11:36:14 +0100
Subject: Free Linux Driver Development!
In-Reply-To: <45C57C93.2020808@lwfinger.net>
References: <45C57C93.2020808@lwfinger.net>
Message-ID: <200702041136.15083.mb@bu3sch.de>

On Sunday 04 February 2007 07:26, Larry Finger wrote:
> What is true is that none of the OFDM rates work 
> because of some unknown bug, probably in initialization. As a result, we are limited to a maximum
> data rate of 11Mbs, but it is still running in 802.11g mode!

That's also not true for me. I really don't understand why people keep saying
that rates above 11MBit don't work, because they do (and always did) on all
of my 4306 cards.
Sure, rates above 11M don't work for 4318 and similiar, but for those cards
not even 11M works, so one has to use 1M or something.

And there is absolutely no limit to 11MBit in the code.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Feb  4 18:42:33 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 04 Feb 2007 11:42:33 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900702040907y8b8eff0gc8b0bbddd79a6792@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>	
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>	
	<45BA246B.6030505@lwfinger.net> <20070129115842.GA4928@ucw.cz>	
	<195c7a900701290455o3ff9fc15k305637f8ced24caf@mail.gmail.com>	
	<20070129140408.GA19379@srcf.ucam.org>
	<45BE1639.6040106@lwfinger.net>
	<195c7a900702040907y8b8eff0gc8b0bbddd79a6792@mail.gmail.com>
Message-ID: <45C61B09.7010102@lwfinger.net>

roucaries bastien wrote:
> 
> Sorry for the delay it works. This time I can use iwlist eth scan.
> I have some difficulties to associate and I need to rmmod/modprobe in
> order to associate but it is another problem linked to a really weak
> power.

Bastien,

Please try this patch instead.

Thanks,

Larry

============================

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3638,6 +3638,7 @@ error:
 static int bcm43xx_init_board(struct bcm43xx_private *bcm)
 {
 	int err;
+	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);

 	mutex_lock(&(bcm)->mutex);

@@ -3658,6 +3659,8 @@ static int bcm43xx_init_board(struct bcm
 	if (err)
 		goto err_sysfs_unreg;
 	bcm43xx_periodic_tasks_setup(bcm);
+	/* force initial LO calibration */
+	phy->lo_control->txctl2 = 0xFFFF;

 	/*FIXME: This should be handled by softmac instead. */
 	schedule_delayed_work(&bcm->softmac->associnfo.work, 0);
@@ -3763,7 +3766,6 @@ static int bcm43xx_read_phyinfo(struct b
 		phy->lo_control = kzalloc(sizeof(*(phy->lo_control)), GFP_KERNEL);
 		if (!phy->lo_control)
 			return -ENOMEM;
-		phy->lo_control->txctl2 = 0xFFFF;//FIXME this is the wrong place
 	}

 	return 0;

----


From kmcguire3413 at hotmail.com  Sun Feb  4 22:28:34 2007
From: kmcguire3413 at hotmail.com (Leonard McGuire)
Date: Sun, 04 Feb 2007 15:28:34 -0600
Subject: OFDM Rates : Possible Initialization Problem
Message-ID: <BAY105-F7DE2670E8281126E502D1C3990@phx.gbl>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

On Sunday 04 February 2007 07:26, Larry Finger wrote:
>>What is true is that none of the OFDM rates work
>>because of some unknown bug, probably in initialization. As a result,
>>we are limited to a maximum data rate of 11Mbs, but it is still
>>running in 802.11g mode!

Could we reverse engineer the Windows Driver enough to compare its I/O
writes to our Linux driver to determine if any significant different
exists. I would imagine blocks of I/O writes might be done in different
order but their should be some significant similarity of the two?
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFxftxsUHwJtQxTo4RCpkLAJ4p6DxJ8bmQIatB+KS4lJ26w+gmfwCeNGla
sdciQwQOn+V8fM2PZPahbaQ=
=c9OK
-----END PGP SIGNATURE-----

_________________________________________________________________
Laugh, share and connect with Windows Live Messenger 
http://clk.atdmt.com/MSN/go/msnnkwme0020000001msn/direct/01/?href=http://imagine-msn.com/messenger/launch80/default.aspx?locale=en-us&source=hmtagline



From mb at bu3sch.de  Sun Feb  4 22:59:35 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 4 Feb 2007 22:59:35 +0100
Subject: OFDM Rates : Possible Initialization Problem
In-Reply-To: <BAY105-F7DE2670E8281126E502D1C3990@phx.gbl>
References: <BAY105-F7DE2670E8281126E502D1C3990@phx.gbl>
Message-ID: <200702042259.35768.mb@bu3sch.de>

On Sunday 04 February 2007 22:28, Leonard McGuire wrote:
> On Sunday 04 February 2007 07:26, Larry Finger wrote:
> >>What is true is that none of the OFDM rates work
> >>because of some unknown bug, probably in initialization. As a result,
> >>we are limited to a maximum data rate of 11Mbs, but it is still
> >>running in 802.11g mode!
> 
> Could we reverse engineer the Windows Driver enough to compare its I/O
> writes to our Linux driver to determine if any significant different
> exists. I would imagine blocks of I/O writes might be done in different
> order but their should be some significant similarity of the two?

If you'd like to compare millions of IO accesses, nobody stops
you from comparing them. There is no reverse engineering
needed to compare IO accesses.

-- 
Greetings Michael.


From kmcguire3413 at hotmail.com  Sun Feb  4 23:10:13 2007
From: kmcguire3413 at hotmail.com (Leonard McGuire)
Date: Sun, 04 Feb 2007 16:10:13 -0600
Subject: OFDM Rates : Possible Initialization Problem
Message-ID: <BAY105-F249C80EF7C8B79FB6423BAC3990@phx.gbl>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Michael Wrote:
>>If you'd like to compare millions of IO accesses, nobody stops you
from comparing them. There is no reverse engineering needed to compare
IO accesses.

Only so many should be sent to the BCM device, during initialization.
I would not think it would be in the millions for the initialization.
There is also got to be a way to determine what type of command/write
was performed such as a lot of initialization writes/reads should be
done to a certain control port for the driver, while many others for
normal activity would be done to the DMA and other ports for the bcm
device. I guess I am just wondering about the millions part, lol.
Even certain writes would have a command prepended right? Mabye we are
just sending a different flag somewhere, that might be detected by
comparason..
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFxgUlsUHwJtQxTo4RCiAvAJ9oa8Qw4PUl7Av2EoF01k43c2j0WgCfY5Ga
KO48eCxmpBxdCBxAtY+25zU=
=MGmp
-----END PGP SIGNATURE-----

_________________________________________________________________
Search for grocery stores. Find gratitude. Turn a simple search into 
something more. 
http://click4thecause.live.com/search/charity/default.aspx?source=hmemtagline_gratitude&FORM=WLMTAG



From mb at bu3sch.de  Sun Feb  4 23:33:56 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 4 Feb 2007 23:33:56 +0100
Subject: OFDM Rates : Possible Initialization Problem
In-Reply-To: <BAY105-F249C80EF7C8B79FB6423BAC3990@phx.gbl>
References: <BAY105-F249C80EF7C8B79FB6423BAC3990@phx.gbl>
Message-ID: <200702042333.56896.mb@bu3sch.de>

On Sunday 04 February 2007 23:10, Leonard McGuire wrote:
> Michael Wrote:
> >>If you'd like to compare millions of IO accesses, nobody stops you
> from comparing them. There is no reverse engineering needed to compare
> IO accesses.
> 
> Only so many should be sent to the BCM device, during initialization.
> I would not think it would be in the millions for the initialization.
> There is also got to be a way to determine what type of command/write
> was performed such as a lot of initialization writes/reads should be
> done to a certain control port for the driver, while many others for
> normal activity would be done to the DMA and other ports for the bcm
> device. I guess I am just wondering about the millions part, lol.
> Even certain writes would have a command prepended right? Mabye we are
> just sending a different flag somewhere, that might be detected by
> comparason..

There are lots of "maybe"s in your statement.
How about reading the code? It will answer all your questions.

And yes, I didn't count the MMIO accesses, but it is a _lot_.
If you want to compare them, go for it. Nobody else will, as it's
too much work. This effort is better put into actually reading,
understanding and fixing the code.

-- 
Greetings Michael.


From rjw at sisk.pl  Mon Feb  5 02:10:05 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 5 Feb 2007 02:10:05 +0100
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <45C61B09.7010102@lwfinger.net>
References: <45B92488.6090908@lwfinger.net>
	<195c7a900702040907y8b8eff0gc8b0bbddd79a6792@mail.gmail.com>
	<45C61B09.7010102@lwfinger.net>
Message-ID: <200702050210.06009.rjw@sisk.pl>

On Sunday, 4 February 2007 18:42, Larry Finger wrote:
> roucaries bastien wrote:
> > 
> > Sorry for the delay it works. This time I can use iwlist eth scan.
> > I have some difficulties to associate and I need to rmmod/modprobe in
> > order to associate but it is another problem linked to a really weak
> > power.
> 
> Bastien,
> 
> Please try this patch instead.

Hm, it doesn't seem to apply to the mainline version of the driver.  Any chance
for a fix against 2.6.20?

Rafael


From rjw at sisk.pl  Mon Feb  5 02:12:45 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 5 Feb 2007 02:12:45 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702032330.46480.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl> <45C3DF50.1070506@lwfinger.net>
	<200702032330.46480.rjw@sisk.pl>
Message-ID: <200702050212.46697.rjw@sisk.pl>

On Saturday, 3 February 2007 23:30, Rafael J. Wysocki wrote:
> On Saturday, 3 February 2007 02:03, Larry Finger wrote:
> > Rafael J. Wysocki wrote:
> > > Hi,
> > > 
> > > Some good news here. :-)
> > > 
> > > I've finally managed to make the 4311 in my nx6325 work.
> > > 
> > > Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> > > are recognized by it (still older ones are not).
> > > 
> > > The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> > > reading e-mail and web browsing. ;-)
> > 
> > Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
> > my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
> > to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).
> 
> Ah, thanks for the hint.  With the rate set to 1M I get similar results.

BTW, is there any way to tell NetworkManager to use 1M by default?

Rafael


From larry.finger at lwfinger.net  Mon Feb  5 04:19:22 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 04 Feb 2007 21:19:22 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <200702050210.06009.rjw@sisk.pl>
References: <45B92488.6090908@lwfinger.net>	<195c7a900702040907y8b8eff0gc8b0bbddd79a6792@mail.gmail.com>	<45C61B09.7010102@lwfinger.net>
	<200702050210.06009.rjw@sisk.pl>
Message-ID: <45C6A23A.8010305@lwfinger.net>

Rafael J. Wysocki wrote:
> On Sunday, 4 February 2007 18:42, Larry Finger wrote:
>> roucaries bastien wrote:
>>> Sorry for the delay it works. This time I can use iwlist eth scan.
>>> I have some difficulties to associate and I need to rmmod/modprobe in
>>> order to associate but it is another problem linked to a really weak
>>> power.
>> Bastien,
>>
>> Please try this patch instead.
> 
> Hm, it doesn't seem to apply to the mainline version of the driver.  Any chance
> for a fix against 2.6.20?

Please try this one. I forgot about some other stuff in my working copy of wireless-2.6.

Larry

============

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3617,6 +3617,7 @@ error:
 static int bcm43xx_init_board(struct bcm43xx_private *bcm)
 {
 	int err;
+	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);

 	mutex_lock(&(bcm)->mutex);

@@ -3637,6 +3638,8 @@ static int bcm43xx_init_board(struct bcm
 	if (err)
 		goto err_sysfs_unreg;
 	bcm43xx_periodic_tasks_setup(bcm);
+	/* force initial LO calibration */
+	phy->lo_control->txctl2 = 0xFFFF;

 	/*FIXME: This should be handled by softmac instead. */
 	schedule_delayed_work(&bcm->softmac->associnfo.work, 0);


From larry.finger at lwfinger.net  Mon Feb  5 04:20:38 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 04 Feb 2007 21:20:38 -0600
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702050212.46697.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl> <45C3DF50.1070506@lwfinger.net>
	<200702032330.46480.rjw@sisk.pl> <200702050212.46697.rjw@sisk.pl>
Message-ID: <45C6A286.4020801@lwfinger.net>

Rafael J. Wysocki wrote:
> On Saturday, 3 February 2007 23:30, Rafael J. Wysocki wrote:
>> On Saturday, 3 February 2007 02:03, Larry Finger wrote:
>>> Rafael J. Wysocki wrote:
>>>> Hi,
>>>>
>>>> Some good news here. :-)
>>>>
>>>> I've finally managed to make the 4311 in my nx6325 work.
>>>>
>>>> Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
>>>> are recognized by it (still older ones are not).
>>>>
>>>> The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
>>>> reading e-mail and web browsing. ;-)
>>> Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
>>> my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
>>> to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).
>> Ah, thanks for the hint.  With the rate set to 1M I get similar results.
> 
> BTW, is there any way to tell NetworkManager to use 1M by default?

Not to my knowledge, but I cc'd Dan Williams. He'll know if anyone does.

Larry


From larry.finger at lwfinger.net  Mon Feb  5 06:14:00 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 04 Feb 2007 23:14:00 -0600
Subject: bcm43xx-softmac issue
In-Reply-To: <45C6B560.1020506@gentoo.org>
References: <45C6B560.1020506@gentoo.org>
Message-ID: <45C6BD18.4080706@lwfinger.net>

Joseph Jezak wrote:
> Hi Larry,
> 
> I got a report of a user having an issue with 2.6.20 and IRQ issues, and
> I can reproduce it.  And I have a fix. :)  (The best kind of bug!)
> 
> I've attached the oops.  Basically, increasing the number of IRQ tries
> (BCM43xx_IRQWAIT_MAX_RETRIES) from 50 to 100 seems to fix the problem. 
> There's probably something else going on here, but I'm not sure what
> yet.  This at least papers over the problem. :p
> 
> Back to working on 4318 now... I'm through most of the init code and
> nothing I've fixed has fixed the issue in wireless-dev yet :p

Joe,

As you have probably read in the bcm43xx list, I cannot test the suspend/resume code as my graphics
card basically locks up when I try to suspend, but others have reported an oops on resume. I have
added the mailing list and one of the people with the problem to the cc's.

Perhaps, the bcm43xx needs a bit more settling time before we try to resume. Could you please
change IRQWAIT_MAX_RETRIES back to the original value and try the following patch? If it works,
perhaps you could try reducing the msleep time. An extra 50 times through the loop in chip_init is
only 500 usec, and it is likely that msleep(1) will be sufficient. If it works with the msleep, then
we won't spin the system the way a udelay does.

Good luck with the 4318 problem.

Thanks,

Larry

=========================

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -4266,6 +4266,7 @@ static int bcm43xx_resume(struct pci_dev

 	dprintk(KERN_INFO PFX "Resuming...\n");

+	msleep(1000);
 	pci_set_power_state(pdev, 0);
 	err = pci_enable_device(pdev);
 	if (err) {


-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: test_delay
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070204/1fbcec93/attachment.ksh>

From josejx at gentoo.org  Mon Feb  5 07:12:31 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Mon, 05 Feb 2007 01:12:31 -0500
Subject: bcm43xx-softmac issue
In-Reply-To: <45C6BD18.4080706@lwfinger.net>
References: <45C6B560.1020506@gentoo.org> <45C6BD18.4080706@lwfinger.net>
Message-ID: <45C6CACF.5030805@gentoo.org>

> Joe,
> 
> As you have probably read in the bcm43xx list, I cannot test the suspend/resume code as my graphics
> card basically locks up when I try to suspend, but others have reported an oops on resume. I have
> added the mailing list and one of the people with the problem to the cc's.
> 
> Perhaps, the bcm43xx needs a bit more settling time before we try to resume. Could you please
> change IRQWAIT_MAX_RETRIES back to the original value and try the following patch? If it works,
> perhaps you could try reducing the msleep time. An extra 50 times through the loop in chip_init is
> only 500 usec, and it is likely that msleep(1) will be sufficient. If it works with the msleep, then
> we won't spin the system the way a udelay does.
> 
> Good luck with the 4318 problem.
> 
> Thanks,
> 
> Larry

Sorry, the msleep, even at 1000, doesn't make a difference.  It 
seems to be taking about 65 cycles through the loop for the 
IRQ_READY flag to show up, with or without the msleep after suspend. 
    If I unload and reload the module during normal usage, it's only 
about 15 cycles.  Maybe Johannes has a better idea as to why, he's 
much more familiar with the firmware than I am.

-Joe


From larry.finger at lwfinger.net  Mon Feb  5 07:28:33 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 00:28:33 -0600
Subject: bcm43xx-softmac issue
In-Reply-To: <45C6CACF.5030805@gentoo.org>
References: <45C6B560.1020506@gentoo.org> <45C6BD18.4080706@lwfinger.net>
	<45C6CACF.5030805@gentoo.org>
Message-ID: <45C6CE91.9010702@lwfinger.net>

Joseph Jezak wrote:
> 
> Sorry, the msleep, even at 1000, doesn't make a difference.  It seems to
> be taking about 65 cycles through the loop for the IRQ_READY flag to
> show up, with or without the msleep after suspend.    If I unload and
> reload the module during normal usage, it's only about 15 cycles.  Maybe
> Johannes has a better idea as to why, he's much more familiar with the
> firmware than I am.


Thanks for testing. For the others reading this message, the following patch seems to fix the oops
that follows a resume operation.

Larry

=========


Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -21,7 +21,7 @@
 #define PFX				KBUILD_MODNAME ": "

 #define BCM43xx_SWITCH_CORE_MAX_RETRIES	50
-#define BCM43xx_IRQWAIT_MAX_RETRIES	50
+#define BCM43xx_IRQWAIT_MAX_RETRIES	100

 #define BCM43xx_IO_SIZE			8192



==============


From Larry.Finger at lwfinger.net  Mon Feb  5 07:47:57 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 00:47:57 -0600
Subject: Combined patch for 2.6.20
Message-ID: <45C6D31D.1050102@lwfinger.net>

As you probably know, kernel 2.6.20 was released on Sunday (As Linus said "A Super Kernel for the
American Football Super Bowl Sunday. - I paraphrased a little.). For most people, that version will
run without problems other than the usual ones. There are, however, some changes that may be needed
for certain hardware and/or conditions. The recent changes/bug fixes that will not appear until
2.6.21 are:

1. The fix for DMA with > 1 GB RAM.
2. The code change to operate the radio LED for systems with a switch.
3. The changes to get proper scaling for rates and frequencies in iwlist.
4. The fix for the oops that occurs in hwrng_unregister on resuming. By the definitions used to
control the changes in a stable release, this is a BUG and should be fixed in 2.6.20.1.

If you wish to patch your source for all of the above, you should download
ftp://lwfinger.dynalias.org/patches/2.6.20_combined.

Larry


From johannes at sipsolutions.net  Mon Feb  5 07:51:26 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 05 Feb 2007 07:51:26 +0100
Subject: bcm43xx-softmac issue
In-Reply-To: <45C6CACF.5030805@gentoo.org>
References: <45C6B560.1020506@gentoo.org> <45C6BD18.4080706@lwfinger.net>
	<45C6CACF.5030805@gentoo.org>
Message-ID: <1170658286.23273.25.camel@johannes.berg>

On Mon, 2007-02-05 at 01:12 -0500, Joseph Jezak wrote:

> Sorry, the msleep, even at 1000, doesn't make a difference.  

That's pretty obvious actually, since at that point no firmware has been
uploaded to the card again.

> It 
> seems to be taking about 65 cycles through the loop for the 
> IRQ_READY flag to show up, with or without the msleep after suspend. 
>     If I unload and reload the module during normal usage, it's only 
> about 15 cycles.  Maybe Johannes has a better idea as to why, he's 
> much more familiar with the firmware than I am.

That's pretty weird, but off-hand I see nothing that could cause it.
Then again... Maybe we don't restore all clocks of the chip properly and
it's running against a slower clock that would cause the firmware to be
slower?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/6765233a/attachment.pgp>

From e.chakravarty at sms.ed.ac.uk  Mon Feb  5 13:07:03 2007
From: e.chakravarty at sms.ed.ac.uk (Erik Chakravarty)
Date: Mon, 05 Feb 2007 12:07:03 +0000
Subject: Re-setting essid after suspend
Message-ID: <1170677223.7606.8.camel@localhost>

Apple PowerBook 5,4
BCM4306
Linux 2.6.20-6

After my machine resumes from suspend, I can see that the wireless
interface eth11 is up, but it is not connected.

iwconfig shows that all the settings are as they were before - the essid
is correctly set etc.

However, I cannot get an IP address from the DHCP server nor ping any
machine if I set an IP manually, until I have run

'iwconfig eth1 essid ....'

to set the router's essid again.

Is this a bcm43xx bug?


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 827 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/52723c91/attachment.pgp>

From rjw at sisk.pl  Mon Feb  5 13:29:00 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 5 Feb 2007 13:29:00 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C6A286.4020801@lwfinger.net>
References: <200702030054.48506.rjw@sisk.pl> <200702050212.46697.rjw@sisk.pl>
	<45C6A286.4020801@lwfinger.net>
Message-ID: <200702051329.01604.rjw@sisk.pl>

On Monday, 5 February 2007 04:20, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > On Saturday, 3 February 2007 23:30, Rafael J. Wysocki wrote:
> >> On Saturday, 3 February 2007 02:03, Larry Finger wrote:
> >>> Rafael J. Wysocki wrote:
> >>>> Hi,
> >>>>
> >>>> Some good news here. :-)
> >>>>
> >>>> I've finally managed to make the 4311 in my nx6325 work.
> >>>>
> >>>> Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
> >>>> are recognized by it (still older ones are not).
> >>>>
> >>>> The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
> >>>> reading e-mail and web browsing. ;-)
> >>> Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
> >>> my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
> >>> to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).
> >> Ah, thanks for the hint.  With the rate set to 1M I get similar results.
> > 
> > BTW, is there any way to tell NetworkManager to use 1M by default?
> 
> Not to my knowledge, but I cc'd Dan Williams. He'll know if anyone does.

Okay, so perhaps I can hack the driver to use 1M by default?

Rafael


From mb at bu3sch.de  Mon Feb  5 13:55:59 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 5 Feb 2007 13:55:59 +0100
Subject: [PATCH] bcm43xx: Ignore intermediate status reports
Message-ID: <200702051355.59288.mb@bu3sch.de>

We must ignore intermediate status reports.
This adds a specialcase for it.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

--

Larry, please stresstest this and submit it upstream.
I think it's also subject to -stable.
I'm not sure under which circumstances an intermediate
status report is delivered, but _if_ it happens, we
crash the kernel.


Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 15:33:39.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-05 13:46:38.000000000 +0100
@@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s
 
 		bcm43xx_debugfs_log_txstat(bcm, &stat);
 
-		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
+			continue;
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
 			continue;
-		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
-			//TODO: packet was not acked (was lost)
-		}
-		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h
 
 		if (bcm43xx_using_pio(bcm))
 			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-01-28 13:59:51.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-02-05 13:52:34.000000000 +0100
@@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
 	u16 unknown; //FIXME
 };
 
-#define BCM43xx_TXSTAT_FLAG_ACK		0x01
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
-#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
+#define BCM43xx_TXSTAT_FLAG_AMPDU	0x20
+#define BCM43xx_TXSTAT_FLAG_INTER	0x40
 
 u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
 u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);


-- 
Greetings Michael.


From johannes at sipsolutions.net  Mon Feb  5 14:11:25 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 05 Feb 2007 14:11:25 +0100
Subject: [PATCH] bcm43xx: Ignore intermediate status reports
In-Reply-To: <200702051355.59288.mb@bu3sch.de>
References: <200702051355.59288.mb@bu3sch.de>
Message-ID: <1170681085.3572.1.camel@johannes.berg>

On Mon, 2007-02-05 at 13:55 +0100, Michael Buesch wrote:

> -#define BCM43xx_TXSTAT_FLAG_ACK		0x01
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
> -#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
> +#define BCM43xx_TXSTAT_FLAG_AMPDU	0x20
> +#define BCM43xx_TXSTAT_FLAG_INTER	0x40

That's wrong. You see, in the specs we say:

0x0040  intermediate status notification
0x0020 status is for an AMPDU (afterburner) 
0x001C suppression reason 
0x0002 ack received 
0x0001 valid bit 

But in the v3 code this whole stuff was shifted down by one as you can
see by the code you removed:
#define BCM43xx_TXSTAT_FLAG_ACK		0x01

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/4fe895b7/attachment.pgp>

From mb at bu3sch.de  Mon Feb  5 14:23:32 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 5 Feb 2007 14:23:32 +0100
Subject: [PATCH] bcm43xx: Ignore intermediate status reports
In-Reply-To: <1170681085.3572.1.camel@johannes.berg>
References: <200702051355.59288.mb@bu3sch.de>
	<1170681085.3572.1.camel@johannes.berg>
Message-ID: <200702051423.33148.mb@bu3sch.de>

On Monday 05 February 2007 14:11, Johannes Berg wrote:
> On Mon, 2007-02-05 at 13:55 +0100, Michael Buesch wrote:
> 
> > -#define BCM43xx_TXSTAT_FLAG_ACK		0x01
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
> > -#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
> > -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
> > +#define BCM43xx_TXSTAT_FLAG_AMPDU	0x20
> > +#define BCM43xx_TXSTAT_FLAG_INTER	0x40
> 
> That's wrong. You see, in the specs we say:
> 
> 0x0040  intermediate status notification
> 0x0020 status is for an AMPDU (afterburner) 
> 0x001C suppression reason 
> 0x0002 ack received 
> 0x0001 valid bit 
> 
> But in the v3 code this whole stuff was shifted down by one as you can
> see by the code you removed:
> #define BCM43xx_TXSTAT_FLAG_ACK		0x01
> 
> johannes


Ok, so what about that?

Change mail subject to:

[PATCH] bcm43xx: Ignore ampdu status reports


Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 15:33:39.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-05 13:46:38.000000000 +0100
@@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s
 
 		bcm43xx_debugfs_log_txstat(bcm, &stat);
 
-		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
+			continue;
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
 			continue;
-		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
-			//TODO: packet was not acked (was lost)
-		}
-		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h
 
 		if (bcm43xx_using_pio(bcm))
 			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-01-28 13:59:51.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-02-05 14:22:18.000000000 +0100
@@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
 	u16 unknown; //FIXME
 };
 
-#define BCM43xx_TXSTAT_FLAG_ACK		0x01
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
-#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
+#define BCM43xx_TXSTAT_FLAG_AMPDU	0x10
+#define BCM43xx_TXSTAT_FLAG_INTER	0x20
 
 u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
 u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);


-- 
Greetings Michael.


From johannes at sipsolutions.net  Mon Feb  5 14:27:12 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 05 Feb 2007 14:27:12 +0100
Subject: [PATCH] bcm43xx: Ignore intermediate status reports
In-Reply-To: <200702051423.33148.mb@bu3sch.de>
References: <200702051355.59288.mb@bu3sch.de>
	<1170681085.3572.1.camel@johannes.berg>
	<200702051423.33148.mb@bu3sch.de>
Message-ID: <1170682032.3572.8.camel@johannes.berg>

On Mon, 2007-02-05 at 14:23 +0100, Michael Buesch wrote:

> Ok, so what about that?

Looks good to me.

> Change mail subject to:
> 
> [PATCH] bcm43xx: Ignore ampdu status reports
> 
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 15:33:39.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-05 13:46:38.000000000 +0100
> @@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s
>  
>  		bcm43xx_debugfs_log_txstat(bcm, &stat);
>  
> -		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
> +		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
> +			continue;
> +		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
>  			continue;
> -		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
> -			//TODO: packet was not acked (was lost)
> -		}
> -		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h
>  
>  		if (bcm43xx_using_pio(bcm))
>  			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-01-28 13:59:51.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-02-05 14:22:18.000000000 +0100
> @@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
>  	u16 unknown; //FIXME
>  };
>  
> -#define BCM43xx_TXSTAT_FLAG_ACK		0x01
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
> -#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
> +#define BCM43xx_TXSTAT_FLAG_AMPDU	0x10
> +#define BCM43xx_TXSTAT_FLAG_INTER	0x20
>  
>  u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
>  u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);
> 
> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/dde7d96c/attachment.pgp>

From larry.finger at lwfinger.net  Mon Feb  5 16:13:02 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 09:13:02 -0600
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702051329.01604.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl>
	<200702050212.46697.rjw@sisk.pl>	<45C6A286.4020801@lwfinger.net>
	<200702051329.01604.rjw@sisk.pl>
Message-ID: <45C7497E.4060706@lwfinger.net>

Rafael J. Wysocki wrote:
> On Monday, 5 February 2007 04:20, Larry Finger wrote:
>> Rafael J. Wysocki wrote:
>>> On Saturday, 3 February 2007 23:30, Rafael J. Wysocki wrote:
>>>> On Saturday, 3 February 2007 02:03, Larry Finger wrote:
>>>>> Rafael J. Wysocki wrote:
>>>>>> Hi,
>>>>>>
>>>>>> Some good news here. :-)
>>>>>>
>>>>>> I've finally managed to make the 4311 in my nx6325 work.
>>>>>>
>>>>>> Well, it turns out that new D-Link routers (at least DI-524 and DI-624)
>>>>>> are recognized by it (still older ones are not).
>>>>>>
>>>>>> The transfer rates are rather low (20 - 25 KB/s downstream), but sufficient for
>>>>>> reading e-mail and web browsing. ;-)
>>>>> Contrary to logic, if you set your rate to 1M, you will get better throughput. Copying a file across
>>>>> my internal network with the rate set at 1M, I get 81 KB/s upload and 66 on download. Both are close
>>>>> to the expected maximum rate ( 1M bits/sec / 8 bits/byte / 2 (approximate overhead).
>>>> Ah, thanks for the hint.  With the rate set to 1M I get similar results.
>>> BTW, is there any way to tell NetworkManager to use 1M by default?
>> Not to my knowledge, but I cc'd Dan Williams. He'll know if anyone does.
> 
> Okay, so perhaps I can hack the driver to use 1M by default?

I think the current rate of 11M i9s set in SoftMAC.

Larry


From larry.finger at lwfinger.net  Mon Feb  5 16:32:46 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 09:32:46 -0600
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <200702051329.01604.rjw@sisk.pl>
References: <200702030054.48506.rjw@sisk.pl> <200702050212.46697.rjw@sisk.pl>
	<45C6A286.4020801@lwfinger.net> <200702051329.01604.rjw@sisk.pl>
Message-ID: <45C74E1E.3050005@lwfinger.net>

Rafael J. Wysocki wrote:
> 
> Okay, so perhaps I can hack the driver to use 1M by default?

This patch will do it.

Larry

==============

Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
===================================================================
--- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_module.c
+++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
@@ -271,7 +271,7 @@ void ieee80211softmac_init_bss(struct ie
 	   more reliable. Note similar logic in
 	   ieee80211softmac_wx_set_rate() */	
 	if (ieee->modulation & IEEE80211_CCK_MODULATION) {
-		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
+		txrates->user_rate = IEEE80211_CCK_RATE_1MB;
 	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
 		txrates->user_rate = IEEE80211_OFDM_RATE_54MB;
 	} else
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: rate1MB
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/622f964e/attachment.ksh>

From rjw at sisk.pl  Mon Feb  5 16:52:48 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 5 Feb 2007 16:52:48 +0100
Subject: Success with 4311 on HPC nx6325
In-Reply-To: <45C74E1E.3050005@lwfinger.net>
References: <200702030054.48506.rjw@sisk.pl> <200702051329.01604.rjw@sisk.pl>
	<45C74E1E.3050005@lwfinger.net>
Message-ID: <200702051652.48804.rjw@sisk.pl>

On Monday, 5 February 2007 16:32, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > 
> > Okay, so perhaps I can hack the driver to use 1M by default?
> 
> This patch will do it.

Thanks a lot!

In the meantime I wrote a small bash script that fixed the bit rate to 1M
(attached) and put it in /etc/sysconfig/network/if-up.d/ (I use OpenSUSE 10.2).
[The ping part is there because my bcm43xx doesn't come up immediately,
but only after several packets have been sent through it.]

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King
-------------- next part --------------
A non-text attachment was scrubbed...
Name: set-bit-rate-for-wireless
Type: application/x-shellscript
Size: 391 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/89ed9739/attachment.bin>

From Larry.Finger at lwfinger.net  Mon Feb  5 17:15:14 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 10:15:14 -0600
Subject: RFT:  bcm43xx: Ignore intermediate status reports
Message-ID: <45C75812.3080500@lwfinger.net>

Please test the following patch. If an intermediate status report were delivered, it is likely that
the kernel would oops. As I have not received any reports of this happening, it probably doesn't
happen and this patch is benign. If testing does not reveal any problems, this patch will be
sent to wireless-2.6 and -stable.

Larry

=======================


From: Michael Buesch <mb at bu3sch.de>

If bcm43xx were to process an intermediate status status response, a kernel oops is likely. The
patch also properly names the afterburner (ampdu) status response.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 15:33:39.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-05 13:46:38.000000000 +0100
@@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s

 		bcm43xx_debugfs_log_txstat(bcm, &stat);

-		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
+			continue;
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
 			continue;
-		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
-			//TODO: packet was not acked (was lost)
-		}
-		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h

 		if (bcm43xx_using_pio(bcm))
 			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-01-28 13:59:51.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-02-05 14:22:18.000000000 +0100
@@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
 	u16 unknown; //FIXME
 };

-#define BCM43xx_TXSTAT_FLAG_ACK		0x01
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
-#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
+#define BCM43xx_TXSTAT_FLAG_AMPDU	0x10
+#define BCM43xx_TXSTAT_FLAG_INTER	0x20

 u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
 u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);

==========





From mb at bu3sch.de  Mon Feb  5 17:20:12 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 5 Feb 2007 17:20:12 +0100
Subject: RFT:  bcm43xx: Ignore intermediate status reports
In-Reply-To: <45C75812.3080500@lwfinger.net>
References: <45C75812.3080500@lwfinger.net>
Message-ID: <200702051720.12889.mb@bu3sch.de>

The names "intermediate" and "ampdu" are swapped.
My fault, sorry.
The subject should say:
RFT:  bcm43xx: Ignore ampdu status reports

The description:

If bcm43xx were to process an ampdu status response, a kernel oops is likely. The
patch also properly names the intermediate status response.

But that's only cosmetical. Please test this patch anyway.

On Monday 05 February 2007 17:15, Larry Finger wrote:
> Please test the following patch. If an intermediate status report were delivered, it is likely that
> the kernel would oops. As I have not received any reports of this happening, it probably doesn't
> happen and this patch is benign. If testing does not reveal any problems, this patch will be
> sent to wireless-2.6 and -stable.
> 
> Larry
> 
> =======================
> 
> 
> From: Michael Buesch <mb at bu3sch.de>
> 
> If bcm43xx were to process an intermediate status status response, a kernel oops is likely. The
> patch also properly names the afterburner (ampdu) status response.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 15:33:39.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-05 13:46:38.000000000 +0100
> @@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s
> 
>  		bcm43xx_debugfs_log_txstat(bcm, &stat);
> 
> -		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
> +		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
> +			continue;
> +		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
>  			continue;
> -		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
> -			//TODO: packet was not acked (was lost)
> -		}
> -		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h
> 
>  		if (bcm43xx_using_pio(bcm))
>  			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-01-28 13:59:51.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h	2007-02-05 14:22:18.000000000 +0100
> @@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
>  	u16 unknown; //FIXME
>  };
> 
> -#define BCM43xx_TXSTAT_FLAG_ACK		0x01
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
> -#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
> -//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
> +#define BCM43xx_TXSTAT_FLAG_AMPDU	0x10
> +#define BCM43xx_TXSTAT_FLAG_INTER	0x20
> 
>  u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
>  u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);
> 
> ==========
> 
> 
> 
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Feb  5 17:36:45 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 10:36:45 -0600
Subject: Re-setting essid after suspend
In-Reply-To: <1170677223.7606.8.camel@localhost>
References: <1170677223.7606.8.camel@localhost>
Message-ID: <45C75D1D.9020903@lwfinger.net>

Erik Chakravarty wrote:
> Apple PowerBook 5,4
> BCM4306
> Linux 2.6.20-6
> 
> After my machine resumes from suspend, I can see that the wireless
> interface eth11 is up, but it is not connected.
> 
> iwconfig shows that all the settings are as they were before - the essid
> is correctly set etc.
> 
> However, I cannot get an IP address from the DHCP server nor ping any
> machine if I set an IP manually, until I have run
> 
> 'iwconfig eth1 essid ....'
> 
> to set the router's essid again.
> 
> Is this a bcm43xx bug?

Probably. There have been a number of problems reported after a suspend/resume sequence. I don't
think the driver is losing the essid, but it is losing association.

Does your log report an oops? If so, does this patch help?

Larry

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: test_delay
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/c97f5f56/attachment.ksh>

From johannes at sipsolutions.net  Mon Feb  5 17:44:37 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 05 Feb 2007 17:44:37 +0100
Subject: Re-setting essid after suspend
In-Reply-To: <45C75D1D.9020903@lwfinger.net>
References: <1170677223.7606.8.camel@localhost> <45C75D1D.9020903@lwfinger.net>
Message-ID: <1170693878.3572.23.camel@johannes.berg>

On Mon, 2007-02-05 at 10:36 -0600, Larry Finger wrote:

> > 'iwconfig eth1 essid ....'
> > 
> > to set the router's essid again.
> > 
> > Is this a bcm43xx bug?
> 
> Probably. There have been a number of problems reported after a suspend/resume sequence. I don't
> think the driver is losing the essid, but it is losing association.

Yeah, softmac is actually to blame I'd say. It loses associate since
it's down for so long, but doesn't realise that it should re-associate
when resuming... We'd probably need to add some sort of callback to
softmac that drivers call during resume and which causes softmac to
re-schedule it's association.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/7fd87acd/attachment.pgp>

From rjw at sisk.pl  Mon Feb  5 19:28:45 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 5 Feb 2007 19:28:45 +0100
Subject: Combined patch for 2.6.20
In-Reply-To: <45C6D31D.1050102@lwfinger.net>
References: <45C6D31D.1050102@lwfinger.net>
Message-ID: <200702051928.46249.rjw@sisk.pl>

On Monday, 5 February 2007 07:47, Larry Finger wrote:
> As you probably know, kernel 2.6.20 was released on Sunday (As Linus said "A Super Kernel for the
> American Football Super Bowl Sunday. - I paraphrased a little.). For most people, that version will
> run without problems other than the usual ones. There are, however, some changes that may be needed
> for certain hardware and/or conditions. The recent changes/bug fixes that will not appear until
> 2.6.21 are:
> 
> 1. The fix for DMA with > 1 GB RAM.
> 2. The code change to operate the radio LED for systems with a switch.
> 3. The changes to get proper scaling for rates and frequencies in iwlist.
> 4. The fix for the oops that occurs in hwrng_unregister on resuming. By the definitions used to
> control the changes in a stable release, this is a BUG and should be fixed in 2.6.20.1.
> 
> If you wish to patch your source for all of the above, you should download
> ftp://lwfinger.dynalias.org/patches/2.6.20_combined.

I've been testing it for a while.  Seems to work and the driver survives a
suspend/resume cycle, but then I have to rmmod/modprobe it to get
NetworkManager to associate with the AP.

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From larry.finger at lwfinger.net  Mon Feb  5 20:52:38 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 13:52:38 -0600
Subject: RFC/T: Re: Re-setting essid after suspend
In-Reply-To: <1170677223.7606.8.camel@localhost>
References: <1170677223.7606.8.camel@localhost>
Message-ID: <45C78B06.6040207@lwfinger.net>

Erik Chakravarty wrote:
> Apple PowerBook 5,4
> BCM4306
> Linux 2.6.20-6
> 
> After my machine resumes from suspend, I can see that the wireless
> interface eth11 is up, but it is not connected.
> 
> iwconfig shows that all the settings are as they were before - the essid
> is correctly set etc.
> 
> However, I cannot get an IP address from the DHCP server nor ping any
> machine if I set an IP manually, until I have run
> 
> 'iwconfig eth1 essid ....'
> 
> to set the router's essid again.
> 
> Is this a bcm43xx bug?

Please try this patch. It forces a reassociation after the resume.

Larry

========


Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -4275,6 +4275,7 @@ static int bcm43xx_resume(struct pci_dev
 {
 	struct net_device *net_dev = pci_get_drvdata(pdev);
 	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
+	struct ieee80211softmac_device *mac = ieee80211_priv(net_dev);
 	int err = 0;

 	dprintk(KERN_INFO PFX "Resuming...\n");
@@ -4296,6 +4297,9 @@ static int bcm43xx_resume(struct pci_dev
 	}
 	netif_device_attach(net_dev);

+	if (mac->associnfo.associated)
+		ieee80211softmac_try_reassoc(mac);
+
 	dprintk(KERN_INFO PFX "Device resumed.\n");

 	return 0;
Index: linux-2.6/include/net/ieee80211softmac.h
===================================================================
--- linux-2.6.orig/include/net/ieee80211softmac.h
+++ linux-2.6/include/net/ieee80211softmac.h
@@ -254,6 +254,7 @@ struct ieee80211softmac_device {
 };

 extern void ieee80211softmac_scan_finished(struct ieee80211softmac_device *sm);
+extern void ieee80211softmac_try_reassoc(struct ieee80211softmac_device *mac);

 static inline void * ieee80211softmac_priv(struct net_device *dev)
 {
Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
===================================================================
--- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_assoc.c
+++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
@@ -441,6 +441,7 @@ ieee80211softmac_try_reassoc(struct ieee
 	schedule_delayed_work(&mac->associnfo.work, 0);
 	spin_unlock_irqrestore(&mac->lock, flags);
 }
+EXPORT_SYMBOL_GPL(ieee80211softmac_try_reassoc);

 int
 ieee80211softmac_handle_disassoc(struct net_device * dev,

============

Larry



From e.chakravarty at sms.ed.ac.uk  Mon Feb  5 20:19:42 2007
From: e.chakravarty at sms.ed.ac.uk (Erik Chakravarty)
Date: Mon, 05 Feb 2007 19:19:42 +0000
Subject: Re-setting essid after suspend
In-Reply-To: <45C75D1D.9020903@lwfinger.net>
References: <1170677223.7606.8.camel@localhost> <45C75D1D.9020903@lwfinger.net>
Message-ID: <1170703182.13194.21.camel@localhost>

no, I don't see any oopses in my logs after a suspend - I don't have
debugging compiled in this kernel though... not sure if these would
still be coming through to the kernel logs if they were happening.

If, as Johannes suggested, this is a problem in softmac is there a
different list I should report this bug to?



On Mon, 2007-02-05 at 10:36 -0600, Larry Finger wrote:
> Erik Chakravarty wrote:
> > Apple PowerBook 5,4
> > BCM4306
> > Linux 2.6.20-6
> > 
> > After my machine resumes from suspend, I can see that the wireless
> > interface eth11 is up, but it is not connected.
> > 
> > iwconfig shows that all the settings are as they were before - the essid
> > is correctly set etc.
> > 
> > However, I cannot get an IP address from the DHCP server nor ping any
> > machine if I set an IP manually, until I have run
> > 
> > 'iwconfig eth1 essid ....'
> > 
> > to set the router's essid again.
> > 
> > Is this a bcm43xx bug?
> 
> Probably. There have been a number of problems reported after a suspend/resume sequence. I don't
> think the driver is losing the essid, but it is losing association.
> 
> Does your log report an oops? If so, does this patch help?
> 
> Larry
> 
> plain text document attachment (test_delay)
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> @@ -21,7 +21,7 @@
>  #define PFX				KBUILD_MODNAME ": "
>  
>  #define BCM43xx_SWITCH_CORE_MAX_RETRIES	50
> -#define BCM43xx_IRQWAIT_MAX_RETRIES	50
> +#define BCM43xx_IRQWAIT_MAX_RETRIES	100
>  
>  #define BCM43xx_IO_SIZE			8192
>  
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 827 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/2b2a6ea0/attachment.pgp>

From larry.finger at lwfinger.net  Mon Feb  5 21:15:03 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 05 Feb 2007 14:15:03 -0600
Subject: Re-setting essid after suspend
In-Reply-To: <1170703182.13194.21.camel@localhost>
References: <1170677223.7606.8.camel@localhost>	
	<45C75D1D.9020903@lwfinger.net>
	<1170703182.13194.21.camel@localhost>
Message-ID: <45C79047.5010904@lwfinger.net>

Erik Chakravarty wrote:
> no, I don't see any oopses in my logs after a suspend - I don't have
> debugging compiled in this kernel though... not sure if these would
> still be coming through to the kernel logs if they were happening.
> 
> If, as Johannes suggested, this is a problem in softmac is there a
> different list I should report this bug to?

No this list is fine. If the second patch I sent works, I'll combine it and the previous one and
push them upstairs.

Larry




From e.chakravarty at sms.ed.ac.uk  Mon Feb  5 21:49:38 2007
From: e.chakravarty at sms.ed.ac.uk (Erik Chakravarty)
Date: Mon, 05 Feb 2007 20:49:38 +0000
Subject: RFC/T: Re: Re-setting essid after suspend
In-Reply-To: <45C78B06.6040207@lwfinger.net>
References: <1170677223.7606.8.camel@localhost> <45C78B06.6040207@lwfinger.net>
Message-ID: <1170708578.14779.1.camel@localhost>

OK thank you - I have the new 2.6.20 source from kernel.org - and I was
going to apply your combined patch to it as well. Is this fine?




On Mon, 2007-02-05 at 13:52 -0600, Larry Finger wrote:
> Erik Chakravarty wrote:
> > Apple PowerBook 5,4
> > BCM4306
> > Linux 2.6.20-6
> > 
> > After my machine resumes from suspend, I can see that the wireless
> > interface eth11 is up, but it is not connected.
> > 
> > iwconfig shows that all the settings are as they were before - the essid
> > is correctly set etc.
> > 
> > However, I cannot get an IP address from the DHCP server nor ping any
> > machine if I set an IP manually, until I have run
> > 
> > 'iwconfig eth1 essid ....'
> > 
> > to set the router's essid again.
> > 
> > Is this a bcm43xx bug?
> 
> Please try this patch. It forces a reassociation after the resume.
> 
> Larry
> 
> ========
> 
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -4275,6 +4275,7 @@ static int bcm43xx_resume(struct pci_dev
>  {
>  	struct net_device *net_dev = pci_get_drvdata(pdev);
>  	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
> +	struct ieee80211softmac_device *mac = ieee80211_priv(net_dev);
>  	int err = 0;
> 
>  	dprintk(KERN_INFO PFX "Resuming...\n");
> @@ -4296,6 +4297,9 @@ static int bcm43xx_resume(struct pci_dev
>  	}
>  	netif_device_attach(net_dev);
> 
> +	if (mac->associnfo.associated)
> +		ieee80211softmac_try_reassoc(mac);
> +
>  	dprintk(KERN_INFO PFX "Device resumed.\n");
> 
>  	return 0;
> Index: linux-2.6/include/net/ieee80211softmac.h
> ===================================================================
> --- linux-2.6.orig/include/net/ieee80211softmac.h
> +++ linux-2.6/include/net/ieee80211softmac.h
> @@ -254,6 +254,7 @@ struct ieee80211softmac_device {
>  };
> 
>  extern void ieee80211softmac_scan_finished(struct ieee80211softmac_device *sm);
> +extern void ieee80211softmac_try_reassoc(struct ieee80211softmac_device *mac);
> 
>  static inline void * ieee80211softmac_priv(struct net_device *dev)
>  {
> Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
> ===================================================================
> --- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_assoc.c
> +++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
> @@ -441,6 +441,7 @@ ieee80211softmac_try_reassoc(struct ieee
>  	schedule_delayed_work(&mac->associnfo.work, 0);
>  	spin_unlock_irqrestore(&mac->lock, flags);
>  }
> +EXPORT_SYMBOL_GPL(ieee80211softmac_try_reassoc);
> 
>  int
>  ieee80211softmac_handle_disassoc(struct net_device * dev,
> 
> ============
> 
> Larry
> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 827 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070205/c5dc4a49/attachment.pgp>

From Larry.Finger at lwfinger.net  Tue Feb  6 07:16:35 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 00:16:35 -0600
Subject: [PATCH] bcm43xx: Ignore ampdu status reports
Message-ID: <45c81d43.P6v/adIydh88LL+j%Larry.Finger@lwfinger.net>

From: Michael Buesch <mb at bu3sch.de>

iIf bcm43xx were to process an afterburner (ampdu) status response, Linux would oops. The
ampdu and intermediate status bits are properly named.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -1453,12 +1453,10 @@ static void handle_irq_transmit_status(s
 
 		bcm43xx_debugfs_log_txstat(bcm, &stat);
 
-		if (stat.flags & BCM43xx_TXSTAT_FLAG_IGNORE)
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_AMPDU)
+			continue;
+		if (stat.flags & BCM43xx_TXSTAT_FLAG_INTER)
 			continue;
-		if (!(stat.flags & BCM43xx_TXSTAT_FLAG_ACK)) {
-			//TODO: packet was not acked (was lost)
-		}
-		//TODO: There are more (unknown) flags to test. see bcm43xx_main.h
 
 		if (bcm43xx_using_pio(bcm))
 			bcm43xx_pio_handle_xmitstatus(bcm, &stat);
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_xmit.h
@@ -137,14 +137,8 @@ struct bcm43xx_xmitstatus {
 	u16 unknown; //FIXME
 };
 
-#define BCM43xx_TXSTAT_FLAG_ACK		0x01
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x02
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x04
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x08
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x10
-#define BCM43xx_TXSTAT_FLAG_IGNORE	0x20
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x40
-//TODO #define BCM43xx_TXSTAT_FLAG_???	0x80
+#define BCM43xx_TXSTAT_FLAG_AMPDU	0x10
+#define BCM43xx_TXSTAT_FLAG_INTER	0x20
 
 u8 bcm43xx_plcp_get_ratecode_cck(const u8 bitrate);
 u8 bcm43xx_plcp_get_ratecode_ofdm(const u8 bitrate);


From Larry.Finger at lwfinger.net  Tue Feb  6 18:39:37 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 11:39:37 -0600
Subject: [PATCH] bcm43xx: Fix for oops on resume
Message-ID: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>

There is a kernel oops on bcm43xx when resuming due to an overly tight timeout loop.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -21,7 +21,7 @@
 #define PFX				KBUILD_MODNAME ": "
 
 #define BCM43xx_SWITCH_CORE_MAX_RETRIES	50
-#define BCM43xx_IRQWAIT_MAX_RETRIES	50
+#define BCM43xx_IRQWAIT_MAX_RETRIES	100
 
 #define BCM43xx_IO_SIZE			8192
 


From email at christianhoffmann.info  Tue Feb  6 09:31:23 2007
From: email at christianhoffmann.info (Christian Hoffmann)
Date: Tue, 6 Feb 2007 09:31:23 +0100
Subject: asserts during suspend2ram (bcm43xx blacklisted)
Message-ID: <200702060931.27768.email@christianhoffmann.info>

Hello,

while playing with the new 2.6.20 (gentoo) kernel, I got some asserts when 
putting the machine to sleep (having the bcm43xx blacklisted/unloaded).

bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 3/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 16/512
bcm43xx: ASSERTION FAILED (bcm43xx_status(bcm) == BCM43xx_STAT_INITIALIZED) 
at: drivers/net/wireless/bcm43xx/bcm43
xx_main.c:1869:bcm43xx_interrupt_handler()

and a bit further down

done.
bcm43xx driver
ACPI: PCI Interrupt 0000:03:02.0[A] -> Link [LNKF] -> GSI 10 (level, low) -> 
IRQ 10
bcm43xx: Chip ID 0x4318, rev 0x2
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
SoftMAC: ASSERTION FAILED (0) at: 
net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
SoftMAC: ASSERTION FAILED (0) at: 
net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()


Chris
-------------- next part --------------
A non-text attachment was scrubbed...
Name: bcm43xxresume.log
Type: text/x-log
Size: 15472 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070206/42a03c61/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 827 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070206/42a03c61/attachment.pgp>

From Larry.Finger at lwfinger.net  Tue Feb  6 21:34:19 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 14:34:19 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
Message-ID: <45C8E64B.1050605@lwfinger.net>

I have really _GOOD_ news!!!!! While reviewing the latest changes in the V4 specs, I found an
interchange of the PHY version and PHY revision fields, relative to the current V3 specs. Of the
three cards that I have, the 4306 had the same value for the PHY version and revision. In addition,
it was the only card of the 3 thaw would work at 11Mbs. A light went on!

After installing the patch listed below, both my 4318 and my 4311 will now run at 11Mbs. From tests
with iperf, I now get rates of 6.1 - 6.5 Mbs from all three.

Larry


==========

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3707,9 +3707,9 @@ static int bcm43xx_read_phyinfo(struct b

 	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);

-	phy_version = (value & 0xF000) >> 12;
+	phy_rev = (value & 0xF000) >> 12;
 	phy_type = (value & 0x0F00) >> 8;
-	phy_rev = (value & 0x000F);
+	phy_version = (value & 0x000F);

 	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
 		phy_version, phy_type, phy_rev);




From gene.heskett at verizon.net  Tue Feb  6 22:37:31 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Tue, 06 Feb 2007 16:37:31 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <45C8E64B.1050605@lwfinger.net>
References: <45C8E64B.1050605@lwfinger.net>
Message-ID: <200702061637.31756.gene.heskett@verizon.net>

On Tuesday 06 February 2007 15:34, Larry Finger wrote:
>I have really _GOOD_ news!!!!! While reviewing the latest changes in the
> V4 specs, I found an interchange of the PHY version and PHY revision
> fields, relative to the current V3 specs. Of the three cards that I
> have, the 4306 had the same value for the PHY version and revision. In
> addition, it was the only card of the 3 thaw would work at 11Mbs. A
> light went on!
>
>After installing the patch listed below, both my 4318 and my 4311 will
> now run at 11Mbs. From tests with iperf, I now get rates of 6.1 - 6.5
> Mbs from all three.
>
>Larry
>

That's great Larry.  Now how long does it take to get this into a distro's 
update kernel queue?  Or do I have to build a kernel for my lappy, 
currently on FC5?

>==========
>
>Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>===================================================================
>--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>@@ -3707,9 +3707,9 @@ static int bcm43xx_read_phyinfo(struct b
>
> 	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
>
>-	phy_version = (value & 0xF000) >> 12;
>+	phy_rev = (value & 0xF000) >> 12;
> 	phy_type = (value & 0x0F00) >> 8;
>-	phy_rev = (value & 0x000F);
>+	phy_version = (value & 0x000F);
>
> 	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision
> %x\n", phy_version, phy_type, phy_rev);
>
>
>_______________________________________________
>Bcm43xx-dev mailing list
>Bcm43xx-dev at lists.berlios.de
>https://lists.berlios.de/mailman/listinfo/bcm43xx-dev

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From proski at gnu.org  Tue Feb  6 23:18:50 2007
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 06 Feb 2007 17:18:50 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <45C8E64B.1050605@lwfinger.net>
References: <45C8E64B.1050605@lwfinger.net>
Message-ID: <1170800330.2613.10.camel@dv>

On Tue, 2007-02-06 at 14:34 -0600, Larry Finger wrote:
> I have really _GOOD_ news!!!!! While reviewing the latest changes in the V4 specs, I found an
> interchange of the PHY version and PHY revision fields, relative to the current V3 specs. Of the
> three cards that I have, the 4306 had the same value for the PHY version and revision. In addition,
> it was the only card of the 3 thaw would work at 11Mbs. A light went on!
> 
> After installing the patch listed below, both my 4318 and my 4311 will now run at 11Mbs. From tests
> with iperf, I now get rates of 6.1 - 6.5 Mbs from all three.

I'm getting a sustained 1.7 megabytes per second over FTP with 4312
(PCIe card in Dell Latitude).  The connection to a 802.11g AP was
established instantaneously.

I have never had much success with the softmac driver at all.  Now it's
working better than the d80211 driver, with waits for minutes before it
starts talking to the same 802.11g AP.

I think it's a 2.6.20.1 material, considering its gain/changes ratio.
I'm actually going to compile this kernel without debug and keep it as a
"production" kernel.

Congratulations and many many thanks!

-- 
Regards,
Pavel Roskin



From rjw at sisk.pl  Tue Feb  6 23:27:16 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 6 Feb 2007 23:27:16 +0100
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <1170800330.2613.10.camel@dv>
References: <45C8E64B.1050605@lwfinger.net> <1170800330.2613.10.camel@dv>
Message-ID: <200702062327.17401.rjw@sisk.pl>

On Tuesday, 6 February 2007 23:18, Pavel Roskin wrote:
> On Tue, 2007-02-06 at 14:34 -0600, Larry Finger wrote:
> > I have really _GOOD_ news!!!!! While reviewing the latest changes in the V4 specs, I found an
> > interchange of the PHY version and PHY revision fields, relative to the current V3 specs. Of the
> > three cards that I have, the 4306 had the same value for the PHY version and revision. In addition,
> > it was the only card of the 3 thaw would work at 11Mbs. A light went on!
> > 
> > After installing the patch listed below, both my 4318 and my 4311 will now run at 11Mbs. From tests
> > with iperf, I now get rates of 6.1 - 6.5 Mbs from all three.
> 
> I'm getting a sustained 1.7 megabytes per second over FTP with 4312
> (PCIe card in Dell Latitude).  The connection to a 802.11g AP was
> established instantaneously.
> 
> I have never had much success with the softmac driver at all.  Now it's
> working better than the d80211 driver, with waits for minutes before it
> starts talking to the same 802.11g AP.
> 
> I think it's a 2.6.20.1 material, considering its gain/changes ratio.
> I'm actually going to compile this kernel without debug and keep it as a
> "production" kernel.
> 
> Congratulations and many many thanks!

I can confirm the driver works great with the patch!

Many thanks, Larry!

Greetings,
Rafael


From proski at gnu.org  Tue Feb  6 23:29:13 2007
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 06 Feb 2007 17:29:13 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <200702061637.31756.gene.heskett@verizon.net>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061637.31756.gene.heskett@verizon.net>
Message-ID: <1170800953.2613.17.camel@dv>

On Tue, 2007-02-06 at 16:37 -0500, Gene Heskett wrote:

> That's great Larry.  Now how long does it take to get this into a
> distro's 
> update kernel queue?  Or do I have to build a kernel for my lappy, 
> currently on FC5?

Gene, I think it would be better for all of us if we don't bother Larry
with such questions and let him discover the secrets of the 802.11g
rates :)

I think that patch has a good chance to get into Fedora 7 from the
beginning.  We may see it in Fedora Core 6 if it goes to Linux 2.6.20
and this patch goes to the 2.6.20.x branch before that.

I think the best we can do now would be to test the driver and report
the results.  This would speed up the process of getting the patch to
the kernel.  Yes, that means recompiling the kernel.

-- 
Regards,
Pavel Roskin



From gene.heskett at verizon.net  Wed Feb  7 00:48:00 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Tue, 06 Feb 2007 18:48:00 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <1170800953.2613.17.camel@dv>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061637.31756.gene.heskett@verizon.net>
	<1170800953.2613.17.camel@dv>
Message-ID: <200702061848.00815.gene.heskett@verizon.net>

On Tuesday 06 February 2007 17:29, Pavel Roskin wrote:
>On Tue, 2007-02-06 at 16:37 -0500, Gene Heskett wrote:
>> That's great Larry.  Now how long does it take to get this into a
>> distro's
>> update kernel queue?  Or do I have to build a kernel for my lappy,
>> currently on FC5?
>
>Gene, I think it would be better for all of us if we don't bother Larry
>with such questions and let him discover the secrets of the 802.11g
>rates :)
>
Probably, Larry seems to be the only one with the urge that's for sure.  
And, darnit, I keep forgetting to say thank you, Larry.

>I think that patch has a good chance to get into Fedora 7 from the
>beginning.  We may see it in Fedora Core 6 if it goes to Linux 2.6.20
>and this patch goes to the 2.6.20.x branch before that.

2.6.20 is out now, I'm running it on this box for the last 50+ hours.  So 
make it for 2.6.21 maybe.

>I think the best we can do now would be to test the driver and report
>the results.  This would speed up the process of getting the patch to
>the kernel.  Yes, that means recompiling the kernel.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From larry.finger at lwfinger.net  Wed Feb  7 01:58:20 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 18:58:20 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <fb1e10a90702061316v4209cdf5ufb8d02fcafb3e81e@mail.gmail.com>
References: <45C8E64B.1050605@lwfinger.net>
	<fb1e10a90702061316v4209cdf5ufb8d02fcafb3e81e@mail.gmail.com>
Message-ID: <45C9242C.8030804@lwfinger.net>

Asil Jinn wrote:
> Thats very good news :D. Does this patch work on 2.6.20?

Yes - 2.6.17, -.18, -.19, and .20, as well as wireless-2.6.

Larry




From larry.finger at lwfinger.net  Wed Feb  7 02:08:27 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 19:08:27 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <200702062327.17401.rjw@sisk.pl>
References: <45C8E64B.1050605@lwfinger.net> <1170800330.2613.10.camel@dv>
	<200702062327.17401.rjw@sisk.pl>
Message-ID: <45C9268B.3040408@lwfinger.net>

Rafael J. Wysocki wrote:
> On Tuesday, 6 February 2007 23:18, Pavel Roskin wrote:
>> On Tue, 2007-02-06 at 14:34 -0600, Larry Finger wrote:
>>> I have really _GOOD_ news!!!!! While reviewing the latest changes in the V4 specs, I found an
>>> interchange of the PHY version and PHY revision fields, relative to the current V3 specs. Of the
>>> three cards that I have, the 4306 had the same value for the PHY version and revision. In addition,
>>> it was the only card of the 3 thaw would work at 11Mbs. A light went on!
>>>
>>> After installing the patch listed below, both my 4318 and my 4311 will now run at 11Mbs. From tests
>>> with iperf, I now get rates of 6.1 - 6.5 Mbs from all three.
>> I'm getting a sustained 1.7 megabytes per second over FTP with 4312
>> (PCIe card in Dell Latitude).  The connection to a 802.11g AP was
>> established instantaneously.
>>
>> I have never had much success with the softmac driver at all.  Now it's
>> working better than the d80211 driver, with waits for minutes before it
>> starts talking to the same 802.11g AP.
>>
>> I think it's a 2.6.20.1 material, considering its gain/changes ratio.
>> I'm actually going to compile this kernel without debug and keep it as a
>> "production" kernel.
>>
>> Congratulations and many many thanks!
> 
> I can confirm the driver works great with the patch!
> 
> Many thanks, Larry!

You are all very welcome.

Now that others have verified that the patch makes their system work, I will be submitting it for
wireless-2.6 that will get it into 2.6.21. I will also submit it to stable so it should be included
in 2.6.20.1 and 2.6.19.4.

Larry


From Larry.Finger at lwfinger.net  Wed Feb  7 04:31:45 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 21:31:45 -0600
Subject: [PATCH] bcm43xx: Fix incorrect definition of PHY revision
Message-ID: <45c94821.qjljSnUzfws7mU7T%Larry.Finger@lwfinger.net>

There is a typographical error in the spefications that interchange the PHY version
and revision. Fixing this error makes all BCM43xx varieties work at full CCCK rates.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

John,

This patch should be put into wireless-2.6 and into 'upstream' as soon as possible.
I will be sending it to stable for inclusion in 2.6.20.1, and whatever other kernels
are still being maintained by -stable.

Larry
---
 
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3704,9 +3704,9 @@ static int bcm43xx_read_phyinfo(struct b
 
 	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
 
-	phy_version = (value & 0xF000) >> 12;
+	phy_rev = (value & 0xF000) >> 12;
 	phy_type = (value & 0x0F00) >> 8;
-	phy_rev = (value & 0x000F);
+	phy_version = (value & 0x000F);
 
 	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
 		phy_version, phy_type, phy_rev);

===



From larry.finger at lwfinger.net  Wed Feb  7 05:40:16 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 06 Feb 2007 22:40:16 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <200702061848.00815.gene.heskett@verizon.net>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061637.31756.gene.heskett@verizon.net>
	<1170800953.2613.17.camel@dv>
	<200702061848.00815.gene.heskett@verizon.net>
Message-ID: <45C95830.6040507@lwfinger.net>

I was a bit too enthusiastic. The patch I sent earlier actually breaks the 4318. It does make 4311
and 4312's work for the wrong reason. If you have that card, you can use it in the meantime while we
find out just why it helps there.

Sorry for the false alarm, but we are making progress.

Larry



From Larry.Finger at lwfinger.net  Wed Feb  7 07:02:50 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 00:02:50 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
Message-ID: <45C96B8A.8010000@lwfinger.net>

The patch I sent out earlier was wrong; however, it provided a clue as to what was wrong in the
specs and in the code. As it turned out, the mistake I made earlier only affected 4 places in the
code and it was easy to test them in turn. According to Murphy's law, the wrong one was the last one
tested. If you don't know about Murphy, his law can be paraphrased as "Anything that can go wrong will".

The patch below will only affect cards with PHY revision 8, which I think are only BCM4311 and
BCM4312. At least those are the only ones in the database.

Sorry about the false step earlier, but I was so excited to get the 4311 working that I screwed up
the test of the 4318.

Larry

==============



Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -1225,7 +1225,7 @@ static void bcm43xx_phy_initg(struct bcm
 	}
 	if (phy->rev < 3 && phy->connected)
 		bcm43xx_phy_write(bcm, 0x047E, 0x0078);
-	if (phy->rev >= 6 && phy->rev <= 8) {
+	if (phy->rev >= 6 && phy->rev < 8) {
 		bcm43xx_phy_write(bcm, 0x0801, bcm43xx_phy_read(bcm, 0x0801) | 0x0080);
 		bcm43xx_phy_write(bcm, 0x043E, bcm43xx_phy_read(bcm, 0x043E) | 0x0004);
 	}




From proski at gnu.org  Wed Feb  7 07:34:31 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 07 Feb 2007 01:34:31 -0500
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45C96B8A.8010000@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net>
Message-ID: <1170830071.11150.62.camel@dv>

On Wed, 2007-02-07 at 00:02 -0600, Larry Finger wrote:
> The patch below will only affect cards with PHY revision 8, which I think are only BCM4311 and
> BCM4312. At least those are the only ones in the database.

BCM4312, old patch: 1.7M/s
no patch: 26k/s
no patch, rate 1: 100k/s
new patch: 1.7M/s
new patch, rate 1: 1.1M/s
new patch, rate 2: 1.5M/s
new patch, rate 5.5: 1.7M/s
new patch, rate 18: 2.2M/s
new patch, rate 36: 2.2M/s

Yes, it looks like the new patch is as good as the previous one for my card.

The rates are reported by wget, so they are not nearly precise, but the
difference of 2 orders of magnitude just cannot be explained by anything
other than the fix to the driver.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Wed Feb  7 08:53:37 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 07 Feb 2007 02:53:37 -0500
Subject: Speed measurement and stability issues
Message-ID: <1170834817.11150.105.camel@dv>

Hello!

I wanted to measure speeds in the softmac driver at all rates, but it
looks like I have found something more interesting in process.

The station is a BCM4312 in Dell Latitude with an antenna embedded into
the laptop.  The AP PCI card with Atheros 5212 running current MadWifi
in 802.11g mode.  Both systems sit on the same desk, about one meter
apart.

I'm using Michael's git repository with Larry's last patch for high
rates.

The speed is measured by iperf 2.0.2 in TCP mode (which is the default).

rate:  iperf reports:

1       928 Kbits/sec
2      1.69 Mbits/sec
5.5    3.92 Mbits/sec
6      4.78 Mbits/sec
9      6.55 Mbits/sec
11     5.97 Mbits/sec
12     8.18 Mbits/sec
18     10.4 Mbits/sec
24     13.0 Mbits/sec
36     15.1 Mbits/sec
48      187 Kbits/sec
54     N/A

Testing at rate 54 caused this to appear on the console about 100 times
in a row:

bcm43xx: ASSERTION FAILED (!ring->suspended)
at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c:71:request_slot()

My attempts to test the UDP mode also lead to such messages.  At some
point, following was reported to the console:

bcm43xx: Controller RESET (TX timeout) ...
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
bcm43xx: Controller restart failed
bcm43xx: ASSERTION FAILED (!err)
at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main
.c:4057:bcm43xx_net_stop()

After that the system became very slow and I had to reboot it.

Next time I got this during UDP testing:

warning: many lost ticks.
Your time source seems to be instable or some driver is hogging
interupts
rip __do_softirq+0x4d/0xd0
Falling back to HPET

I could check the connection at 48M in USB mode with low 5Mbsp bandwidth
limit, and the packet loss is minimal (10 out of 3211 packets are lost),
so the speed drop must be explained by something else.

There is a clearly a stability problem at the high rates, and perhaps
there is also another problem that limits the throughput.

802.11g modes are faster relative to the rate, e.g. 9 is faster than 11
and 12 is much faster than 11.

36Mbps seems to be the fastest for TCP, although I would probably use
12Mbps to be safe.

-- 
Regards,
Pavel Roskin



From mail at puchalla-online.de  Wed Feb  7 08:50:50 2007
From: mail at puchalla-online.de (Jochen Puchalla)
Date: Wed, 07 Feb 2007 08:50:50 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45C96B8A.8010000@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net>
Message-ID: <45C984DA.9000606@puchalla-online.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Larry Finger wrote:
> The patch I sent out earlier was wrong; however, it provided a clue as to what was wrong in the
> specs and in the code. As it turned out, the mistake I made earlier only affected 4 places in the
> code and it was easy to test them in turn. According to Murphy's law, the wrong one was the last one
> tested. If you don't know about Murphy, his law can be paraphrased as "Anything that can go wrong will".
> 
> The patch below will only affect cards with PHY revision 8, which I think are only BCM4311 and
> BCM4312. At least those are the only ones in the database.

Hi Larry,

this sounds wonderful! However, I applied this patch and
radio_enable_2.6.20 to my 2.6.20-rc7 on an HP nx6325 (I know you have
one as well), but still I only get 100kB/s at 1M 2M 5.5M and 11M. Do I
need the combined-patch for 2.6.20? I only have 1GB RAM and don't do
suspends, so I don't think so.

Gru?,
Jochen


root at binux:/usr/src# dmesg|grep bcm
bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)

- --
"In a world without fences and walls, who needs gates and windows?"

Das bessere Office kostenlos:  http://de.openoffice.org/
Einfach der bessere Browser:   http://www.mozilla.com/firefox/all
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.5 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFyYTaZaqLqiTpDaoRAgefAJ44SxyPCfZuBCJCpIS/PjWLSsuz9QCfXGZT
4SWzhb6ALZe47JhdxNHzD38=
=hHD/
-----END PGP SIGNATURE-----


From gene.heskett at verizon.net  Wed Feb  7 09:03:40 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Wed, 07 Feb 2007 03:03:40 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <45C95830.6040507@lwfinger.net>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061848.00815.gene.heskett@verizon.net>
	<45C95830.6040507@lwfinger.net>
Message-ID: <200702070303.40968.gene.heskett@verizon.net>

On Tuesday 06 February 2007 23:40, Larry Finger wrote:
>I was a bit too enthusiastic. The patch I sent earlier actually breaks
> the 4318. It does make 4311 and 4312's work for the wrong reason. If
> you have that card, you can use it in the meantime while we find out
> just why it helps there.
>
>Sorry for the false alarm, but we are making progress.
>
>Larry

And the 4318 is whats in my lappy.  What does it break?

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From proski at gnu.org  Wed Feb  7 09:17:30 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 07 Feb 2007 03:17:30 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <200702070303.40968.gene.heskett@verizon.net>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061848.00815.gene.heskett@verizon.net>
	<45C95830.6040507@lwfinger.net>
	<200702070303.40968.gene.heskett@verizon.net>
Message-ID: <1170836250.11150.116.camel@dv>

On Wed, 2007-02-07 at 03:03 -0500, Gene Heskett wrote:

> And the 4318 is whats in my lappy.  What does it break?

Oh, please, let's stop such questions.  Does it really matter what some
knowingly wrong change does to particular hardware?  Just don't try the
old patch.  Just forget that it existed.  It's not going to the kernel.

Please try the new patch.  Ideally, measure speeds for various rates,
because it's the speed that the patch is supposed to improve.

If you have more questions of this kind, please make sure my personal
e-mail is not in CC.

-- 
Regards,
Pavel Roskin



From johannes at sipsolutions.net  Wed Feb  7 13:15:49 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 07 Feb 2007 13:15:49 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
Message-ID: <1170850549.6798.22.camel@johannes.berg>

On Tue, 2007-02-06 at 11:39 -0600, Larry Finger wrote:
> There is a kernel oops on bcm43xx when resuming due to an overly tight timeout loop.

Come to think of it... Is there any chance of fixing the actual oops
that happens in this case? I can imagine broken hardware or firmware
that causes this as well and we don't really want to oops in that case
either... That's why we have the timeout in the first place, to not hang
there forever.

Nothing against this patch though.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070207/dd356f08/attachment.pgp>

From joerg at alea.gnuu.de  Wed Feb  7 12:55:49 2007
From: joerg at alea.gnuu.de (=?UTF-8?Q?J=C3=B6rg?= Sommer)
Date: Wed, 7 Feb 2007 11:55:49 +0000 (UTC)
Subject: Patch to fix set_channelfreq
Message-ID: <slrnesjfi4.73r.joerg@alea.gnuu.de>

Hi,

the code in bcm43xx_wc.c:bcm43xx_wx_set_channelfreq() passes the value
unchanged to bcm43xx_freq_to_channel() which leads to mistakes, because
bcm43xx_freq_to_channel() expects the frequency in MHz, but the value
given to bcm43xx_wx_set_channelfreq() might be scaled somehow different.

Also passing the internal frequency value in bcm43xx_wx_get_rangeparams()
to userland is not correct. The frequency is in MHz, but the factor
passed to userland is freq*10^1.

#v+
--- /home/joerg/bcm43xx_wx.c	2007-02-07 11:25:19.000000000 +0100
+++ bcm43xx_wx.c	2007-02-07 11:09:46.000000000 +0100
@@ -108,16 +108,21 @@
 	u8 channel;
 	int freq;
 	int err = -EINVAL;
+	s16 ex;
 
 	mutex_lock(&bcm->mutex);
 	spin_lock_irqsave(&bcm->irq_lock, flags);
 
-	if ((data->freq.m >= 0) && (data->freq.m <= 1000)) {
+	if ((data->freq.e == 0) &&
+            (data->freq.m >= 0) && (data->freq.m <= 1000)) {
 		channel = data->freq.m;
 		freq = bcm43xx_channel_to_freq(bcm, channel);
 	} else {
-		channel = bcm43xx_freq_to_channel(bcm, data->freq.m);
 		freq = data->freq.m;
+		ex = 6 - data->freq.e;
+		while (--ex >= 0)    /* scale down the frequency to MHz */
+			freq /= 10;
+		channel = bcm43xx_freq_to_channel(bcm, freq);
 	}
 	if (!ieee80211_is_valid_channel(bcm->ieee, channel))
 		goto out_unlock;
@@ -295,7 +300,7 @@
 			break;
 		range->freq[j].i = j + 1;
 		range->freq[j].m = geo->bg[i].freq;//FIXME?
-		range->freq[j].e = 1;
+		range->freq[j].e = 6;
 		j++;
 	}
 	range->num_frequency = j;
@@ -439,7 +444,7 @@
 	u16 maxpower;
 
 	if ((data->txpower.flags & IW_TXPOW_TYPE) != IW_TXPOW_DBM) {
-		printk(PFX KERN_ERR "TX power not in dBm.\n");
+		printk(KERN_ERR PFX "TX power not in dBm.\n");
 		return -EOPNOTSUPP;
 	}
 
#v-

linux: 2.6.20

Bye, J?rg.
-- 
Die Erde ist das einzigste Irrenhaus, das von seinen eigenen Insassen
verwaltet wird.
                                                (U. Schmidt)


From josejx at gentoo.org  Wed Feb  7 13:53:48 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Wed, 07 Feb 2007 07:53:48 -0500
Subject: Speed measurement and stability issues
In-Reply-To: <1170834817.11150.105.camel@dv>
References: <1170834817.11150.105.camel@dv>
Message-ID: <45C9CBDC.8040701@gentoo.org>

> bcm43xx: Controller RESET (TX timeout) ...
> bcm43xx: IRQ_READY timeout
> bcm43xx: core_up for active 802.11 core failed (-19)
> bcm43xx: Controller restart failed
> bcm43xx: ASSERTION FAILED (!err)
> at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main
> .c:4057:bcm43xx_net_stop()

The IRQ_READY timeout should be fixed with Larry's combined patch 
for 2.6.20, or more specifically, the increase in cycles to wait for 
IRQ_READY patch.

-Joe


From larry.finger at lwfinger.net  Wed Feb  7 14:23:45 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 07:23:45 -0600
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <1170850549.6798.22.camel@johannes.berg>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<1170850549.6798.22.camel@johannes.berg>
Message-ID: <45C9D2E1.7040906@lwfinger.net>

Johannes Berg wrote:
> On Tue, 2007-02-06 at 11:39 -0600, Larry Finger wrote:
>> There is a kernel oops on bcm43xx when resuming due to an overly tight timeout loop.
> 
> Come to think of it... Is there any chance of fixing the actual oops
> that happens in this case? I can imagine broken hardware or firmware
> that causes this as well and we don't really want to oops in that case
> either... That's why we have the timeout in the first place, to not hang
> there forever.
> 
> Nothing against this patch though.

As you suggested earlier, a slow clock setting in the bcm43xx device may be the cause of this
difficulty. If my laptop would suspend/resume correctly, then I could test various fixes based on
that hypothesis. Since it does not, I think the band-aid approach is warranted. A proper fix is
still on my agenda; however, getting full data rates still has priority.

Larry


From johannes at sipsolutions.net  Wed Feb  7 14:32:30 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 07 Feb 2007 14:32:30 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9D2E1.7040906@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<1170850549.6798.22.camel@johannes.berg>
	<45C9D2E1.7040906@lwfinger.net>
Message-ID: <1170855150.6798.38.camel@johannes.berg>

On Wed, 2007-02-07 at 07:23 -0600, Larry Finger wrote:

> As you suggested earlier, a slow clock setting in the bcm43xx device may be the cause of this
> difficulty. If my laptop would suspend/resume correctly, then I could test various fixes based on
> that hypothesis. 

Mine does suspend, but I don't see the problem...

> Since it does not, I think the band-aid approach is warranted. 

Oh yes, I agree, having some hardware mess up will almost always crash
the computer anyway.

> A proper fix is
> still on my agenda; however, getting full data rates still has priority.

Sure. Thanks for all you're doing :)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070207/c9b9e200/attachment.pgp>

From rjw at sisk.pl  Wed Feb  7 14:35:40 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Wed, 7 Feb 2007 14:35:40 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9D2E1.7040906@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<1170850549.6798.22.camel@johannes.berg>
	<45C9D2E1.7040906@lwfinger.net>
Message-ID: <200702071435.40610.rjw@sisk.pl>

On Wednesday, 7 February 2007 14:23, Larry Finger wrote:
> Johannes Berg wrote:
> > On Tue, 2007-02-06 at 11:39 -0600, Larry Finger wrote:
> >> There is a kernel oops on bcm43xx when resuming due to an overly tight timeout loop.
> > 
> > Come to think of it... Is there any chance of fixing the actual oops
> > that happens in this case? I can imagine broken hardware or firmware
> > that causes this as well and we don't really want to oops in that case
> > either... That's why we have the timeout in the first place, to not hang
> > there forever.
> > 
> > Nothing against this patch though.
> 
> As you suggested earlier, a slow clock setting in the bcm43xx device may be the cause of this
> difficulty. If my laptop would suspend/resume correctly, then I could test various fixes based on
> that hypothesis. Since it does not, I think the band-aid approach is warranted. A proper fix is
> still on my agenda; however, getting full data rates still has priority.

BTW, have you tried to suspend to disk or to RAM only?

Rafael


From rjw at sisk.pl  Wed Feb  7 14:43:19 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Wed, 7 Feb 2007 14:43:19 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <1170830071.11150.62.camel@dv>
References: <45C96B8A.8010000@lwfinger.net> <1170830071.11150.62.camel@dv>
Message-ID: <200702071443.19676.rjw@sisk.pl>

On Wednesday, 7 February 2007 07:34, Pavel Roskin wrote:
> On Wed, 2007-02-07 at 00:02 -0600, Larry Finger wrote:
> > The patch below will only affect cards with PHY revision 8, which I think are only BCM4311 and
> > BCM4312. At least those are the only ones in the database.
> 
> BCM4312, old patch: 1.7M/s
> no patch: 26k/s
> no patch, rate 1: 100k/s
> new patch: 1.7M/s
> new patch, rate 1: 1.1M/s
> new patch, rate 2: 1.5M/s
> new patch, rate 5.5: 1.7M/s
> new patch, rate 18: 2.2M/s
> new patch, rate 36: 2.2M/s
> 
> Yes, it looks like the new patch is as good as the previous one for my card.

The patch is apparently sufficient for me too.  Moreover, the D-Link APs that
were previously "invisible" are now listed by "iwlist ... scan" and I can
connect with them.  Thanks again!

Greetings,
Rafael


From larry.finger at lwfinger.net  Wed Feb  7 14:50:40 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 07:50:40 -0600
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <1170855150.6798.38.camel@johannes.berg>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>	
	<1170850549.6798.22.camel@johannes.berg>
	<45C9D2E1.7040906@lwfinger.net>
	<1170855150.6798.38.camel@johannes.berg>
Message-ID: <45C9D930.5010307@lwfinger.net>

Johannes Berg wrote:
> On Wed, 2007-02-07 at 07:23 -0600, Larry Finger wrote:
> 
>> As you suggested earlier, a slow clock setting in the bcm43xx device may be the cause of this
>> difficulty. If my laptop would suspend/resume correctly, then I could test various fixes based on
>> that hypothesis. 
> 
> Mine does suspend, but I don't see the problem...

Could you please apply this patch and tell me what gets printed after you resume, and whether you
did a suspend to RAM or disk?

I welcome the results of this test from anyone whose system will suspend/resume. Please also note if
any further action is needed to get wireless communication re-established.

Thanks,

Larry


==========

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -2401,6 +2401,7 @@ static int bcm43xx_chip_init(struct bcm4
 		}
 		udelay(10);
 	}
+	dprintk(KERN_INFO PFX "It took %d tries to set IRQ_READY\n", i);
 	bcm43xx_read32(bcm, BCM43xx_MMIO_GEN_IRQ_REASON); /* dummy read */

 	value16 = bcm43xx_shm_read16(bcm, BCM43xx_SHM_SHARED,



From larry.finger at lwfinger.net  Wed Feb  7 14:53:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 07:53:26 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <200702071443.19676.rjw@sisk.pl>
References: <45C96B8A.8010000@lwfinger.net> <1170830071.11150.62.camel@dv>
	<200702071443.19676.rjw@sisk.pl>
Message-ID: <45C9D9D6.2070700@lwfinger.net>

Rafael J. Wysocki wrote:
> On Wednesday, 7 February 2007 07:34, Pavel Roskin wrote:
>> On Wed, 2007-02-07 at 00:02 -0600, Larry Finger wrote:
>>> The patch below will only affect cards with PHY revision 8, which I think are only BCM4311 and
>>> BCM4312. At least those are the only ones in the database.
>> BCM4312, old patch: 1.7M/s
>> no patch: 26k/s
>> no patch, rate 1: 100k/s
>> new patch: 1.7M/s
>> new patch, rate 1: 1.1M/s
>> new patch, rate 2: 1.5M/s
>> new patch, rate 5.5: 1.7M/s
>> new patch, rate 18: 2.2M/s
>> new patch, rate 36: 2.2M/s
>>
>> Yes, it looks like the new patch is as good as the previous one for my card.
> 
> The patch is apparently sufficient for me too.  Moreover, the D-Link APs that
> were previously "invisible" are now listed by "iwlist ... scan" and I can
> connect with them.  Thanks again!

Great - a two-for-one! That must have been a signal strength issue.

Larry


From larry.finger at lwfinger.net  Wed Feb  7 14:58:47 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 07:58:47 -0600
Subject: Patch to fix set_channelfreq
In-Reply-To: <slrnesjfi4.73r.joerg@alea.gnuu.de>
References: <slrnesjfi4.73r.joerg@alea.gnuu.de>
Message-ID: <45C9DB17.6090100@lwfinger.net>

J?rg Sommer wrote:
> Hi,
> 
> the code in bcm43xx_wc.c:bcm43xx_wx_set_channelfreq() passes the value
> unchanged to bcm43xx_freq_to_channel() which leads to mistakes, because
> bcm43xx_freq_to_channel() expects the frequency in MHz, but the value
> given to bcm43xx_wx_set_channelfreq() might be scaled somehow different.
> 
> Also passing the internal frequency value in bcm43xx_wx_get_rangeparams()
> to userland is not correct. The frequency is in MHz, but the factor
> passed to userland is freq*10^1.
> 
> #v+
> --- /home/joerg/bcm43xx_wx.c	2007-02-07 11:25:19.000000000 +0100
> +++ bcm43xx_wx.c	2007-02-07 11:09:46.000000000 +0100
> @@ -108,16 +108,21 @@
>  	u8 channel;
>  	int freq;
>  	int err = -EINVAL;
> +	s16 ex;
>  
>  	mutex_lock(&bcm->mutex);
>  	spin_lock_irqsave(&bcm->irq_lock, flags);
>  
> -	if ((data->freq.m >= 0) && (data->freq.m <= 1000)) {
> +	if ((data->freq.e == 0) &&
> +            (data->freq.m >= 0) && (data->freq.m <= 1000)) {
>  		channel = data->freq.m;
>  		freq = bcm43xx_channel_to_freq(bcm, channel);
>  	} else {
> -		channel = bcm43xx_freq_to_channel(bcm, data->freq.m);
>  		freq = data->freq.m;
> +		ex = 6 - data->freq.e;
> +		while (--ex >= 0)    /* scale down the frequency to MHz */
> +			freq /= 10;
> +		channel = bcm43xx_freq_to_channel(bcm, freq);
>  	}
>  	if (!ieee80211_is_valid_channel(bcm->ieee, channel))
>  		goto out_unlock;

I'm testing this hunk now.

> @@ -295,7 +300,7 @@
>  			break;
>  		range->freq[j].i = j + 1;
>  		range->freq[j].m = geo->bg[i].freq;//FIXME?
> -		range->freq[j].e = 1;
> +		range->freq[j].e = 6;
>  		j++;
>  	}
>  	range->num_frequency = j;

This one has already been fixed by multiplying geo->bg[i].freq by 100,000. Same result. There was a
similar error for 802.11a frequencies as well.

> @@ -439,7 +444,7 @@
>  	u16 maxpower;
>  
>  	if ((data->txpower.flags & IW_TXPOW_TYPE) != IW_TXPOW_DBM) {
> -		printk(PFX KERN_ERR "TX power not in dBm.\n");
> +		printk(KERN_ERR PFX "TX power not in dBm.\n");
>  		return -EOPNOTSUPP;
>  	}

Good catch. Thanks for your contribution.

Larry



From johannes at sipsolutions.net  Wed Feb  7 14:54:50 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 07 Feb 2007 14:54:50 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9D930.5010307@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<1170850549.6798.22.camel@johannes.berg>
	<45C9D2E1.7040906@lwfinger.net>
	<1170855150.6798.38.camel@johannes.berg>
	<45C9D930.5010307@lwfinger.net>
Message-ID: <1170856490.6798.40.camel@johannes.berg>

On Wed, 2007-02-07 at 07:50 -0600, Larry Finger wrote:

> Could you please apply this patch and tell me what gets printed after you resume, and whether you
> did a suspend to RAM or disk?

Not a bad idea. I can test suspend to ram as well as to disk, just got
both working again.

The kernel I'm running right now was built on my powermac so I can't do
it right away (otherwise I could've just recompiled the bcm43xx module)
but I'll do it later today or tomorrow.

Usually, to get my connection back after a suspend, I just have to set
the ssid again.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070207/f9da0e55/attachment.pgp>

From johannes at sipsolutions.net  Wed Feb  7 14:56:06 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 07 Feb 2007 14:56:06 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9D930.5010307@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<1170850549.6798.22.camel@johannes.berg>
	<45C9D2E1.7040906@lwfinger.net>
	<1170855150.6798.38.camel@johannes.berg>
	<45C9D930.5010307@lwfinger.net>
Message-ID: <1170856566.6798.42.camel@johannes.berg>

On Wed, 2007-02-07 at 07:50 -0600, Larry Finger wrote:

> Could you please apply this patch and tell me what gets printed after you resume, and whether you
> did a suspend to RAM or disk?

Oh and if anyone else does this please also let us know what it prints
on a regular freshly booted modprobe.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070207/afde004e/attachment.pgp>

From benoit.knecht at citycable.ch  Wed Feb  7 15:21:24 2007
From: benoit.knecht at citycable.ch (=?ISO-8859-1?Q?Beno=EEt_Knecht?=)
Date: Wed, 07 Feb 2007 15:21:24 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9D930.5010307@lwfinger.net>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>		<1170850549.6798.22.camel@johannes.berg>	<45C9D2E1.7040906@lwfinger.net>	<1170855150.6798.38.camel@johannes.berg>
	<45C9D930.5010307@lwfinger.net>
Message-ID: <45C9E064.1080100@citycable.ch>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi,

Larry Finger wrote:
> Johannes Berg wrote:
>> On Wed, 2007-02-07 at 07:23 -0600, Larry Finger wrote:
>>
>>> As you suggested earlier, a slow clock setting in the bcm43xx device may be the cause of this
>>> difficulty. If my laptop would suspend/resume correctly, then I could test various fixes based on
>>> that hypothesis. 
>> Mine does suspend, but I don't see the problem...
> 
> Could you please apply this patch and tell me what gets printed after you resume, and whether you
> did a suspend to RAM or disk?

I use a BCM4318 on PPC. When I first boot, I get:
bcm43xx: It took 16 tries to set IRQ_READY

Then I suspend-to-RAM, and after wake-up, I get:
bcm43xx: It took 65 tries to set IRQ_READY

> I welcome the results of this test from anyone whose system will suspend/resume. Please also note if
> any further action is needed to get wireless communication re-established.

I don't need to do anything to get wireless communication back.
wpa_supplicant just re-associates, thanks to one of your previous patches.

Beno?t

> Thanks,
> 
> Larry
> 
> 
> ==========
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -2401,6 +2401,7 @@ static int bcm43xx_chip_init(struct bcm4
>  		}
>  		udelay(10);
>  	}
> +	dprintk(KERN_INFO PFX "It took %d tries to set IRQ_READY\n", i);
>  	bcm43xx_read32(bcm, BCM43xx_MMIO_GEN_IRQ_REASON); /* dummy read */
> 
>  	value16 = bcm43xx_shm_read16(bcm, BCM43xx_SHM_SHARED,
> 
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFFyeBky0EwBJvkHIMRAvweAJ4huR7RNUfkICG/Ss82x3rfMahgpwCfY/L/
fUeabZcaqGrfS77zeuN7ixY=
=eb3g
-----END PGP SIGNATURE-----


From mb at bu3sch.de  Wed Feb  7 15:14:16 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 7 Feb 2007 15:14:16 +0100
Subject: [PATCH] bcm43xx: Fix incorrect definition of PHY revision
In-Reply-To: <45c94821.qjljSnUzfws7mU7T%Larry.Finger@lwfinger.net>
References: <45c94821.qjljSnUzfws7mU7T%Larry.Finger@lwfinger.net>
Message-ID: <200702071514.17516.mb@bu3sch.de>

On Wednesday 07 February 2007 04:31, Larry Finger wrote:
> There is a typographical error in the spefications that interchange the PHY version
> and revision. Fixing this error makes all BCM43xx varieties work at full CCCK rates.
> 
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This patch should be put into wireless-2.6 and into 'upstream' as soon as possible.
> I will be sending it to stable for inclusion in 2.6.20.1, and whatever other kernels
> are still being maintained by -stable.
> 
> Larry
> ---
>  
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -3704,9 +3704,9 @@ static int bcm43xx_read_phyinfo(struct b
>  
>  	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
>  
> -	phy_version = (value & 0xF000) >> 12;
> +	phy_rev = (value & 0xF000) >> 12;
>  	phy_type = (value & 0x0F00) >> 8;
> -	phy_rev = (value & 0x000F);
> +	phy_version = (value & 0x000F);
>  
>  	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
>  		phy_version, phy_type, phy_rev);


I don't think this is correct.
From which part of the specs did you get this?
http://bcm-v4.sipsolutions.net/802.11/PHY is where the PHY_Version
register is explained. "phy_version"=="AnalogType"

Actually it is possible that phy_revision is mask 0xFF, but that's
not too important at the moment, as we don't have revisions>0xF, yet.

But besides that, it's interresting that this "fixes" things for you.

Especially since wireless-2.6 has no support for hw-power-control, which
is needed by cards 4318 and newer.

-- 
Greetings Michael.


From dang at fprintf.net  Wed Feb  7 16:21:05 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Wed, 07 Feb 2007 10:21:05 -0500
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <1170836250.11150.116.camel@dv>
References: <45C8E64B.1050605@lwfinger.net>
	<200702061848.00815.gene.heskett@verizon.net>
	<45C95830.6040507@lwfinger.net>
	<200702070303.40968.gene.heskett@verizon.net>
	<1170836250.11150.116.camel@dv>
Message-ID: <1170861665.6964.4.camel@athena.fprintf.net>

On Wed, 2007-02-07 at 03:17 -0500, Pavel Roskin wrote:
> On Wed, 2007-02-07 at 03:03 -0500, Gene Heskett wrote:
> 
> > And the 4318 is whats in my lappy.  What does it break?
> 
> Oh, please, let's stop such questions.  Does it really matter what some
> knowingly wrong change does to particular hardware?  Just don't try the
> old patch.  Just forget that it existed.  It's not going to the kernel.
> 
> Please try the new patch.  Ideally, measure speeds for various rates,
> because it's the speed that the patch is supposed to improve.
> 
> If you have more questions of this kind, please make sure my personal
> e-mail is not in CC.
> 

Except that the new patch changes nothing for us poor 4318 users, so
what's the point of trying it?

That said, I'm running the broken patch right now, and my 4318 is
working better than ever before, so it changed *something* for my card.

Daniel



From larry.finger at lwfinger.net  Wed Feb  7 16:42:10 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 09:42:10 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <1170861665.6964.4.camel@athena.fprintf.net>
References: <45C8E64B.1050605@lwfinger.net>	<200702061848.00815.gene.heskett@verizon.net>	<45C95830.6040507@lwfinger.net>	<200702070303.40968.gene.heskett@verizon.net>	<1170836250.11150.116.camel@dv>
	<1170861665.6964.4.camel@athena.fprintf.net>
Message-ID: <45C9F352.3030706@lwfinger.net>

Daniel Gryniewicz wrote:
> On Wed, 2007-02-07 at 03:17 -0500, Pavel Roskin wrote:
>> On Wed, 2007-02-07 at 03:03 -0500, Gene Heskett wrote:
>>
>>> And the 4318 is whats in my lappy.  What does it break?
>> Oh, please, let's stop such questions.  Does it really matter what some
>> knowingly wrong change does to particular hardware?  Just don't try the
>> old patch.  Just forget that it existed.  It's not going to the kernel.
>>
>> Please try the new patch.  Ideally, measure speeds for various rates,
>> because it's the speed that the patch is supposed to improve.
>>
>> If you have more questions of this kind, please make sure my personal
>> e-mail is not in CC.
>>esg 
> 
> Except that the new patch changes nothing for us poor 4318 users, so
> what's the point of trying it?
> 
> That said, I'm running the broken patch right now, and my 4318 is
> working better than ever before, so it changed *something* for my card.

Intriguing.  Please send me the output of 'dmesg | grep bcm43xx'.  Thanks.

Larry


From hs4233 at mail.mn-solutions.de  Wed Feb  7 16:23:54 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Wed, 7 Feb 2007 16:23:54 +0100
Subject: [PATCH] bcm43xx: Fix for oops on resume
In-Reply-To: <45C9E064.1080100@citycable.ch>
References: <45c8bd59.oamnvaNRMZvKoPBa%Larry.Finger@lwfinger.net>
	<45C9D930.5010307@lwfinger.net> <45C9E064.1080100@citycable.ch>
Message-ID: <200702071623.54571.hs4233@mail.mn-solutions.de>

> I use a BCM4318 on PPC. When I first boot, I get:
> bcm43xx: It took 16 tries to set IRQ_READY
>
> Then I suspend-to-RAM, and after wake-up, I get:
> bcm43xx: It took 65 tries to set IRQ_READY

Maybe the error is somewhere else.

AFAIK a PC-Card is handled like a PCI device. Therefore, from 
pciutils you can use "lspci" to look at the PCI settings and 
tinker with them using "setpci".

Maybe "lspci -vvv" displays different timing information before 
and after the suspend/resume, e.g. a different latency for the 
BCMxxxx or for another PCI device, which then "steals us" bus 
time.


From ftoledo at docksud.com.ar  Thu Feb  8 00:33:54 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Wed, 07 Feb 2007 20:33:54 -0300
Subject: Speed measurement and stability issues
In-Reply-To: <45C9CBDC.8040701@gentoo.org>
References: <1170834817.11150.105.camel@dv> <45C9CBDC.8040701@gentoo.org>
Message-ID: <45CA61E2.3040206@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Joseph Jezak escribi?:
>> bcm43xx: Controller RESET (TX timeout) ...
>> bcm43xx: IRQ_READY timeout
>> bcm43xx: core_up for active 802.11 core failed (-19)
>> bcm43xx: Controller restart failed
>> bcm43xx: ASSERTION FAILED (!err)
>> at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main
>> .c:4057:bcm43xx_net_stop()
> 
> The IRQ_READY timeout should be fixed with Larry's combined patch 
> for 2.6.20, or more specifically, the increase in cycles to wait for 
> IRQ_READY patch.
> 
> -Joe
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 
hi joe! i have aplied the patch and today get a irq timeout when try to
connect to my dlink, with the latest "Really_GOOD_news" now i can see it
when scanning

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFymHiz8H9Vs7bTsMRAmHJAKDdmXGUvGXtWPbCQyPu7clhxPsOmACeLvsW
NNLwPUBFJlkrtfd4NjsZfho=
=SXsv
-----END PGP SIGNATURE-----


From ftoledo at docksud.com.ar  Thu Feb  8 00:36:27 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Wed, 07 Feb 2007 20:36:27 -0300
Subject: Speed measurement and stability issues
In-Reply-To: <1170834817.11150.105.camel@dv>
References: <1170834817.11150.105.camel@dv>
Message-ID: <45CA627B.8040309@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Pavel Roskin escribi?:
> Hello!
> 
> I wanted to measure speeds in the softmac driver at all rates, but it
> looks like I have found something more interesting in process.
> 
> The station is a BCM4312 in Dell Latitude with an antenna embedded into
> the laptop.  The AP PCI card with Atheros 5212 running current MadWifi
> in 802.11g mode.  Both systems sit on the same desk, about one meter
> apart.
> 
> I'm using Michael's git repository with Larry's last patch for high
> rates.
> 
> The speed is measured by iperf 2.0.2 in TCP mode (which is the default).
> 
> rate:  iperf reports:
> 
> 1       928 Kbits/sec
> 2      1.69 Mbits/sec
> 5.5    3.92 Mbits/sec
> 6      4.78 Mbits/sec
> 9      6.55 Mbits/sec
> 11     5.97 Mbits/sec
> 12     8.18 Mbits/sec
> 18     10.4 Mbits/sec
> 24     13.0 Mbits/sec
> 36     15.1 Mbits/sec
> 48      187 Kbits/sec
> 54     N/A
testing at 11Mb i have same aprox. value that Pavel.
it was a REally_GOOD_news for me :)


-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFymJ7z8H9Vs7bTsMRAmKHAJ9rK5o2dUYLwLC4nyhCgn3HaO7MjQCgoOOr
NHjz5jf7oztzWUqfNA3vmQE=
=IdnV
-----END PGP SIGNATURE-----


From larry.finger at lwfinger.net  Thu Feb  8 01:10:06 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 18:10:06 -0600
Subject: Speed measurement and stability issues
In-Reply-To: <45CA627B.8040309@docksud.com.ar>
References: <1170834817.11150.105.camel@dv> <45CA627B.8040309@docksud.com.ar>
Message-ID: <45CA6A5E.1030900@lwfinger.net>

Fernando Toledo wrote:
> Pavel Roskin escribi?:
> 
>> rate:  iperf reports:
> 
>> 1       928 Kbits/sec
>> 2      1.69 Mbits/sec
>> 5.5    3.92 Mbits/sec
>> 6      4.78 Mbits/sec
>> 9      6.55 Mbits/sec
>> 11     5.97 Mbits/sec
>> 12     8.18 Mbits/sec
>> 18     10.4 Mbits/sec
>> 24     13.0 Mbits/sec
>> 36     15.1 Mbits/sec
>> 48      187 Kbits/sec
>> 54     N/A
> testing at 11Mb i have same aprox. value that Pavel.
> it was a REally_GOOD_news for me :)

My results are:

rate		4311 rate	4318 rate
=========================================

11M		6.50 Mbs	6.34 Mbs
18M		10.4 Mbs	6.98 Mbs
24M		12.3 Mbs	7.61 Mbs
36M		15.0 Mbs	8.22 Mbs
48M		4.76 Mbs	8.05 Mbs
54M		Failed		7.82 Mbs

As can be seen, the 4311 does a little better at the lower rates; however, the 4318 persists all the
way to 54M. We still have work left, but it is really encouraging to see the reports come in that
the long-standing problems in associating are going away now that the interface is putting out more
power.

Larry


From larry.finger at lwfinger.net  Thu Feb  8 02:17:18 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 19:17:18 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45C984DA.9000606@puchalla-online.de>
References: <45C96B8A.8010000@lwfinger.net>
	<45C984DA.9000606@puchalla-online.de>
Message-ID: <45CA7A1E.3030508@lwfinger.net>

Jochen Puchalla wrote:
> this sounds wonderful! However, I applied this patch and
> radio_enable_2.6.20 to my 2.6.20-rc7 on an HP nx6325 (I know you have
> one as well), but still I only get 100kB/s at 1M 2M 5.5M and 11M. Do I
> need the combined-patch for 2.6.20? I only have 1GB RAM and don't do
> suspends, so I don't think so.

Jochen,

My laptop is an HP dv2125nr, but it has a BCM4311 with the same revisions as yours. I don't
understand why your system doesn't show the improvement.

The combined patch also includes the code for handling the rf switch correctly. It shouldn't be
needed, but please try a kernel with the combined patch for 2.6.20 and either one of the patches
from yesterday - the _GOOD_ news faulty one or the one that followed.

Larry



From Larry.Finger at lwfinger.net  Thu Feb  8 02:49:52 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 19:49:52 -0600
Subject: RFC: a new version of bcm43xx.txt
Message-ID: <45CA81C0.2090004@lwfinger.net>

I have rewritten Documentation/networking/bcm43xx.txt. I would appreciate your comments.

Thanks,

Larry


=========================



Index: wireless-2.6/Documentation/networking/bcm43xx.txt
===================================================================
--- wireless-2.6.orig/Documentation/networking/bcm43xx.txt
+++ wireless-2.6/Documentation/networking/bcm43xx.txt
@@ -2,35 +2,77 @@
 			BCM43xx Linux Driver Project
 			============================

-About this software
--------------------
-
-The goal of this project is to develop a linux driver for Broadcom
-BCM43xx chips, based on the specification at
-http://bcm-specs.sipsolutions.net/
-
-The project page is http://bcm43xx.berlios.de/
-
-
-Requirements
+Introduction
 ------------

-1)	Linux Kernel 2.6.16 or later
-	http://www.kernel.org/
-
-	You may want to configure your kernel with:
-
-	CONFIG_DEBUG_FS (optional):
-		-> Kernel hacking
-		  -> Debug Filesystem
-
-2)	SoftMAC IEEE 802.11 Networking Stack extension and patched ieee80211
-	modules:
-	http://softmac.sipsolutions.net/
+Many of the wireless devices found in modern notebook computers are based
+on the wireless chips produced by Broadcom. These devices have been a problem
+for Linux users as there is no open-source driver available. In addition,
+Broadcom has not released specifications for the device, and driver availability
+has been limited to the binary-only form used in the GPL versions of access
+point hardware such as the Linksys WRT54G, and the Windows and OS X drivers.
+Before this project began, the only way to use these devices were to use the
+Windows or OS X drivers with either the Linuxant or ndiswrapper modules. There
+is a strong penalty if this method is used as loading the binary-only module
+"taints" the kernel, and no kernel developer will help diagnose any kernel
+problems.
+
+Development
+-----------
+
+This driver has been developend using a clean-room technique that is described
+at http://bcm-specs.sipsolutions.net/ReverseEngineeringProcess. For legal
+reasons, none of the clean-room crew works on the on the Linux driver, and
+none of the Linux developers sees anything but the specifications, which are
+the ultimate product of the reverse-engineering group.
+
+Software
+--------
+
+Since the release of the 2.6.17 kernel, the bcm43xx driver has been dstributed
+with the kernel source, and is prebuilt in most, if not all, distributions.
+There is, however, additional software that is required. Because the firmware
+used by the processor in the Broadcom chip is copyrighted, it is not possible
+for any third party to distribute it. Furthermore, it cannot be placed in the
+downloadable archives of any distributing organization; therefore, the user is
+responsible for obtaining the firmware and placing it in the appropriate location
+so that the driver can find it when initializing.
+
+To help with this process, the bcm43xx developers provide a separate program
+named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
+and write the extracted files to the proper location. This program is usually
+provided with the distribution; however, it may be downloaded from
+
+http://developer.berlios.de/project/showfiles.php?group_id=4547.
+
+The firmware is available in two versions. V3 firmware is used with the in-kernel
+bcm43xx driver that uses a software MAC layer called SoftMAC, and will have a
+microcode revision of 0x127 or smaller. The V4 firmware is used by an out-of-kernel
+driver employing a variation of the devicescape MAC layer known as d80211. Once
+bcm43xx-d80211 reaches a satisfactory level of development, it will replace
+bcm43xx-softmac in the kernel as it is much more flexible and powerful.
+
+A source for rev 0x127 (V3) firmware is
+
+http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.
+
+Once this file is downloaded, the command 'bcm43xx-fwcutter -i <filename>' will list
+the "blobs" of microcode in the file. The command 'bcm43xx-fwcutter -w <dir> <filename>'
+will extract the microcode and write it to directory <dir>. The correct directory
+will depend on your distribution; however, most use '/lib/firmware'. Once this
+step is completed, the bcm3xx driver should load when the system is booted. To see
+any messages relating to the driver, issue the command 'dmesg | grep bcm43xx' from
+a terminal window. If there are any problems, please send that output to
+Bcm43xx-dev at lists.berlios.de.
+
+Although the driver has been in-kernel since 2.6.17, the earlier versions are quite
+limited in their capability. Patches for each of the stable kernel versions from
+2.6.18 onward are available to include all features of later versions. These will
+be needed if you use a BCM4318, or a PCI-E version (BCM4311 and BCM4312). In addition,
+if you have an early BCM4306 and more than 1 GB RAM, your kernel will need to be
+patched. These patches, which are being updated regularly, are available at
+ftp://lwfinger.dynalias.org/patches. Look for <kernel version>_combined_patch. Of
+course you will need kernel source, either downloaded from kernel.org, or the source
+from your distribution.

-3)	Firmware Files

-	Please try fwcutter. Fwcutter can extract the firmware from various
-	binary driver files. It supports driver files from Windows, MacOS and
-	Linux. You can get fwcutter from http://bcm43xx.berlios.de/.
-	Also, fwcutter comes with a README file for further instructions.



From caravena at ubuntu-cl.org  Thu Feb  8 03:19:39 2007
From: caravena at ubuntu-cl.org (Cristian Aravena Romero)
Date: Wed, 7 Feb 2007 23:19:39 -0300
Subject: RFC: a new version of bcm43xx.txt
In-Reply-To: <45CA81C0.2090004@lwfinger.net>
References: <45CA81C0.2090004@lwfinger.net>
Message-ID: <bbff98600702071819v1fc11880s6a71b67c22632abd@mail.gmail.com>

On 2/7/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:

[...]

> +http://developer.berlios.de/project/showfiles.php?group_id=4547.

-http://developer.berlios.de/project/showfiles.php?group_id=4547.
+http://developer.berlios.de/project/showfiles.php?group_id=4547


[...]

> +http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.

-http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.
+http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
--
Cristian Aravena Romero


From proski at gnu.org  Thu Feb  8 03:50:19 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 07 Feb 2007 21:50:19 -0500
Subject: RFC: a new version of bcm43xx.txt
In-Reply-To: <45CA81C0.2090004@lwfinger.net>
References: <45CA81C0.2090004@lwfinger.net>
Message-ID: <1170903019.2866.19.camel@dv>

On Wed, 2007-02-07 at 19:49 -0600, Larry Finger wrote:

> +This driver has been developend using a clean-room technique that is described

developed

> +Since the release of the 2.6.17 kernel, the bcm43xx driver has been dstributed

distributed

Please make sure to spell check the final edition.

> +with the kernel source, and is prebuilt in most, if not all, distributions.
> +There is, however, additional software that is required. Because the firmware
> +used by the processor in the Broadcom chip is copyrighted, it is not possible
> +for any third party to distribute it.

Strictly speaking, Linux is copyrighted too.  It would be better to
rephrase it to mention the specific restrictions, whatever they are.

>  Furthermore, it cannot be placed in the
> +downloadable archives of any distributing organization; therefore, the user is
> +responsible for obtaining the firmware and placing it in the appropriate location
> +so that the driver can find it when initializing.

But how come it's on openwrt.org then?

> +To help with this process, the bcm43xx developers provide a separate program
> +named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
> +and write the extracted files to the proper location. This program is usually
> +provided with the distribution; however, it may be downloaded from
> +
> +http://developer.berlios.de/project/showfiles.php?group_id=4547.
> +
> +The firmware is available in two versions. V3 firmware is used with the in-kernel
> +bcm43xx driver that uses a software MAC layer called SoftMAC, and will have a
> +microcode revision of 0x127 or smaller. The V4 firmware is used by an out-of-kernel
> +driver employing a variation of the devicescape MAC layer known as d80211. Once
> +bcm43xx-d80211 reaches a satisfactory level of development, it will replace
> +bcm43xx-softmac in the kernel as it is much more flexible and powerful.
> +
> +A source for rev 0x127 (V3) firmware is

I'm not sure why you are repeating this "0x127" over and over again.  It
seems a minor detail that even fwcutter docs don't mention.  The
important part is v3 vs v4.

> +http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.
> +
> +Once this file is downloaded, the command 'bcm43xx-fwcutter -i <filename>' will list
> +the "blobs" of microcode in the file. The command 'bcm43xx-fwcutter -w <dir> <filename>'
> +will extract the microcode and write it to directory <dir>.

Sorry for a naive question.  How hard would is be to run fwcutter once,
zip the firmware and put it to the same directory on the same site?

>  The correct directory
> +will depend on your distribution; however, most use '/lib/firmware'. Once this
> +step is completed, the bcm3xx driver should load when the system is booted. To see
> +any messages relating to the driver, issue the command 'dmesg | grep bcm43xx' from
> +a terminal window. If there are any problems, please send that output to
> +Bcm43xx-dev at lists.berlios.de.
> +
> +Although the driver has been in-kernel since 2.6.17, the earlier versions are quite
> +limited in their capability. Patches for each of the stable kernel versions from
> +2.6.18 onward are available to include all features of later versions. These will
> +be needed if you use a BCM4318, or a PCI-E version (BCM4311 and BCM4312). In addition,

I think PCIe is a preferred abbreviation.  Or maybe just write PCI
Express.

> +if you have an early BCM4306 and more than 1 GB RAM, your kernel will need to be
> +patched. These patches, which are being updated regularly, are available at
> +ftp://lwfinger.dynalias.org/patches. Look for <kernel version>_combined_patch. Of
> +course you will need kernel source, either downloaded from kernel.org, or the source
> +from your distribution.

Could you please rename those patches to add .diff ot .path to the
names?  Many editors would highlight the patches nicely if they are
maned like this.  Not to mention that files ending with a dot-number
could be mistaken for a manual page.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Thu Feb  8 05:00:55 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 07 Feb 2007 23:00:55 -0500
Subject: Latest firmware
Message-ID: <1170907255.2866.36.camel@dv>

Hello!

Maybe this could be incorporated into fwcutter README.  Maybe it could
even turned into scripts.

The latest V4 firmware (driver version 4.102.15.61) can be obtained by:

wget http://www.station-drivers.com/telechargement/broadcom/broadcom%20bcm-43x-4.102.15.61-vista.exe
7za x "broadcom bcm-43x-4.102.15.61-vista.exe"
bcm43xx-fwcutter bcmwl6.sys

The latest V3 driver (3.140.16.0):

wget ftp://ftp.hp.com/pub/softpaq/sp31001-31500/sp31463.exe
cabextract sp31463.exe
bcm43xx-fwcutter bcmwl5.sys

But it appears that the actual firmware revisions are newer in 3.13x.x.x
drivers, where it's 0x127, unlike 0x123 in 3.140.16.0.  I cannot find
3.130.35.0 or 3.131.35.0, but here's how to get 3.130.20.0:

wget http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
bcm43xx-fwcutter wl_apsta-3.130.20.0.o

According to http://langerland.de/linux/bcm43xx/firmware.html the
firmware in all 3.13x.x.x drivers is the same.

-- 
Regards,
Pavel Roskin



From larry.finger at lwfinger.net  Thu Feb  8 06:09:03 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 07 Feb 2007 23:09:03 -0600
Subject: RFC: a new version of bcm43xx.txt
In-Reply-To: <1170903019.2866.19.camel@dv>
References: <45CA81C0.2090004@lwfinger.net> <1170903019.2866.19.camel@dv>
Message-ID: <45CAB06F.6090008@lwfinger.net>

Pavel Roskin wrote:
> On Wed, 2007-02-07 at 19:49 -0600, Larry Finger wrote:
> 
>> +This driver has been developend using a clean-room technique that is described
> 
> developed
> 
>> +Since the release of the 2.6.17 kernel, the bcm43xx driver has been dstributed
> 
> distributed
> 
> Please make sure to spell check the final edition.
> 
>> +with the kernel source, and is prebuilt in most, if not all, distributions.
>> +There is, however, additional software that is required. Because the firmware
>> +used by the processor in the Broadcom chip is copyrighted, it is not possible
>> +for any third party to distribute it.
> 
> Strictly speaking, Linux is copyrighted too.  It would be better to
> rephrase it to mention the specific restrictions, whatever they are.

A good suggestion - perhaps some other reader might suggest language here.

>>  Furthermore, it cannot be placed in the
>> +downloadable archives of any distributing organization; therefore, the user is
>> +responsible for obtaining the firmware and placing it in the appropriate location
>> +so that the driver can find it when initializing.
> 
> But how come it's on openwrt.org then?

Linksys used Linux on the older versions of the WRT54G. According to the GPL, they have to make the
system available. Of course, it is within their rights to provide the driver in a binary-only form
and openwrt.org is allowed to redistibute the entire system. BTW, Linksys now uses VxWorks, which
doesn't have the GPL "problem".
> 
>> +To help with this process, the bcm43xx developers provide a separate program
>> +named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
>> +and write the extracted files to the proper location. This program is usually
>> +provided with the distribution; however, it may be downloaded from
>> +
>> +http://developer.berlios.de/project/showfiles.php?group_id=4547.
>> +
>> +The firmware is available in two versions. V3 firmware is used with the in-kernel
>> +bcm43xx driver that uses a software MAC layer called SoftMAC, and will have a
>> +microcode revision of 0x127 or smaller. The V4 firmware is used by an out-of-kernel
>> +driver employing a variation of the devicescape MAC layer known as d80211. Once
>> +bcm43xx-d80211 reaches a satisfactory level of development, it will replace
>> +bcm43xx-softmac in the kernel as it is much more flexible and powerful.
>> +
>> +A source for rev 0x127 (V3) firmware is
> 
> I'm not sure why you are repeating this "0x127" over and over again.  It
> seems a minor detail that even fwcutter docs don't mention.  The
> important part is v3 vs v4.
> 
>> +http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o.
>> +
>> +Once this file is downloaded, the command 'bcm43xx-fwcutter -i <filename>' will list
>> +the "blobs" of microcode in the file. The command 'bcm43xx-fwcutter -w <dir> <filename>'
>> +will extract the microcode and write it to directory <dir>.
> 
> Sorry for a naive question.  How hard would is be to run fwcutter once,
> zip the firmware and put it to the same directory on the same site?

AFAIK, we are not allowed to do anything like that.

>>  The correct directory
>> +will depend on your distribution; however, most use '/lib/firmware'. Once this
>> +step is completed, the bcm3xx driver should load when the system is booted. To see
>> +any messages relating to the driver, issue the command 'dmesg | grep bcm43xx' from
>> +a terminal window. If there are any problems, please send that output to
>> +Bcm43xx-dev at lists.berlios.de.
>> +
>> +Although the driver has been in-kernel since 2.6.17, the earlier versions are quite
>> +limited in their capability. Patches for each of the stable kernel versions from
>> +2.6.18 onward are available to include all features of later versions. These will
>> +be needed if you use a BCM4318, or a PCI-E version (BCM4311 and BCM4312). In addition,
> 
> I think PCIe is a preferred abbreviation.  Or maybe just write PCI
> Express.
> 
>> +if you have an early BCM4306 and more than 1 GB RAM, your kernel will need to be
>> +patched. These patches, which are being updated regularly, are available at
>> +ftp://lwfinger.dynalias.org/patches. Look for <kernel version>_combined_patch. Of
>> +course you will need kernel source, either downloaded from kernel.org, or the source
>> +from your distribution.
> 
> Could you please rename those patches to add .diff ot .path to the
> names?  Many editors would highlight the patches nicely if they are
> maned like this.  Not to mention that files ending with a dot-number
> could be mistaken for a manual page.

I changed the name to "combined_patch_2_6_20", etc. Once d80211 becomes the in-kernel version, I
will keep a patch set for those people with 802.11b cards that do not work with V4 firmware.

Larry


From proski at gnu.org  Thu Feb  8 06:18:20 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 00:18:20 -0500
Subject: RFC: a new version of bcm43xx.txt
In-Reply-To: <45CAB06F.6090008@lwfinger.net>
References: <45CA81C0.2090004@lwfinger.net> <1170903019.2866.19.camel@dv>
	<45CAB06F.6090008@lwfinger.net>
Message-ID: <1170911900.13570.3.camel@dv>

Hello, Larry!

Thanks for clarification.

On Wed, 2007-02-07 at 23:09 -0600, Larry Finger wrote:
> > Could you please rename those patches to add .diff ot .path to the
> > names?  Many editors would highlight the patches nicely if they are
> > maned like this.  Not to mention that files ending with a dot-number
> > could be mistaken for a manual page.
> 
> I changed the name to "combined_patch_2_6_20", etc. Once d80211 becomes the in-kernel version, I
> will keep a patch set for those people with 802.11b cards that do not work with V4 firmware.

I meant to add ".diff" or ".patch" to the end of the filenames.

-- 
Regards,
Pavel Roskin



From josejx at gentoo.org  Thu Feb  8 06:25:33 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Thu, 08 Feb 2007 00:25:33 -0500
Subject: RFC: a new version of bcm43xx.txt
In-Reply-To: <45CAB06F.6090008@lwfinger.net>
References: <45CA81C0.2090004@lwfinger.net> <1170903019.2866.19.camel@dv>
	<45CAB06F.6090008@lwfinger.net>
Message-ID: <45CAB44D.7060606@gentoo.org>

>>> +with the kernel source, and is prebuilt in most, if not all, distributions.
>>> +There is, however, additional software that is required. Because the firmware
>>> +used by the processor in the Broadcom chip is copyrighted, it is not possible
>>> +for any third party to distribute it.
>> Strictly speaking, Linux is copyrighted too.  It would be better to
>> rephrase it to mention the specific restrictions, whatever they are.
> 
> A good suggestion - perhaps some other reader might suggest language here.
>

Broadcom has not given the bcm43xx team redistribution rights to 
this firmware.  Since we cannot legally redistribute the firwmare we 
cannot include it with the driver.

>>>  Furthermore, it cannot be placed in the
>>> +downloadable archives of any distributing organization; therefore, the user is
>>> +responsible for obtaining the firmware and placing it in the appropriate location
>>> +so that the driver can find it when initializing.
>> But how come it's on openwrt.org then?
> 
> Linksys used Linux on the older versions of the WRT54G. According to the GPL, they have to make the
> system available. Of course, it is within their rights to provide the driver in a binary-only form
> and openwrt.org is allowed to redistibute the entire system. BTW, Linksys now uses VxWorks, which
> doesn't have the GPL "problem".

It's debatable.  I would rather that the bcm43xx steer clear from 
legal issues as much as possible.  (Hence the Chinese wall 
reverse-engineering effort, etc.), so we don't redistribute the 
firmware.  If Broadcom or whomever gave us explicit permission to 
distribute the firmware, it would be okay.  Otherwise, it's not in 
our best interest to do so.  That said, if others want to distribute 
it, we won't tell them not to. :)

>>> +Once this file is downloaded, the command 'bcm43xx-fwcutter -i <filename>' will list
>>> +the "blobs" of microcode in the file. The command 'bcm43xx-fwcutter -w <dir> <filename>'
>>> +will extract the microcode and write it to directory <dir>.
>> Sorry for a naive question.  How hard would is be to run fwcutter once,
>> zip the firmware and put it to the same directory on the same site?
> 
> AFAIK, we are not allowed to do anything like that.

For the same reasons as above.  It's not technical, just legal. :p

-Joe


From rjw at sisk.pl  Thu Feb  8 08:09:02 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 8 Feb 2007 08:09:02 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45CA7A1E.3030508@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net>
	<45C984DA.9000606@puchalla-online.de>
	<45CA7A1E.3030508@lwfinger.net>
Message-ID: <200702080809.03200.rjw@sisk.pl>

On Thursday, 8 February 2007 02:17, Larry Finger wrote:
> Jochen Puchalla wrote:
> > this sounds wonderful! However, I applied this patch and
> > radio_enable_2.6.20 to my 2.6.20-rc7 on an HP nx6325 (I know you have
> > one as well), but still I only get 100kB/s at 1M 2M 5.5M and 11M. Do I
> > need the combined-patch for 2.6.20? I only have 1GB RAM and don't do
> > suspends, so I don't think so.
> 
> Jochen,
> 
> My laptop is an HP dv2125nr, but it has a BCM4311 with the same revisions as yours. I don't
> understand why your system doesn't show the improvement.
> 
> The combined patch also includes the code for handling the rf switch correctly. It shouldn't be
> needed, but please try a kernel with the combined patch for 2.6.20 and either one of the patches
> from yesterday - the _GOOD_ news faulty one or the one that followed.

Well, my box is an nx6325 too and it _does_ show the improvement.  The patches
I use are available at http://www.sisk.pl/kernel/patches/2.6.20/ (of course
only the bcm43xx-* are relevant).

Greetings,
Rafael


From proski at gnu.org  Thu Feb  8 08:13:03 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 02:13:03 -0500
Subject: Hack to make bcm43xx_d80211 work with 802.11g APs
Message-ID: <1170918783.14208.19.camel@dv>

Hello!

This patch to bcm43xx_d80211 makes my bcm4312 associate with 802.11g
access points immediately:

diff --git a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
index e101ed5..1470c5b 100644
--- a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
+++ b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
@@ -135,7 +135,7 @@ static struct ieee80211_rate __bcm43xx_ratetable[] = {
 #define bcm43xx_b_ratetable		(__bcm43xx_ratetable + 0)
 #define bcm43xx_b_ratetable_size	4
 #define bcm43xx_g_ratetable		(__bcm43xx_ratetable + 0)
-#define bcm43xx_g_ratetable_size	12
+#define bcm43xx_g_ratetable_size	4
 
 #define CHANTAB_ENT(_chanid, _freq) \
 	{							\


As I wrote before, my card has a problem with 802.11g APs under
bcm43xx_d80211 driver.  It would associate once given all parameters
(channel, ap, essid), and it would even show a non-zero link quality,
but no data packets would go through for at least several minutes.

Note that even with this patch, the driver is still telling the d80211
stack that is supports 802.11g and has an 802.11g PHY.  It just doesn't
provide any OFDM rates.

iperf over TCP shows rates around 4 Mbps, which is pretty decent,
although less than 6 Mbps measured with the softmac driver in the same
setup.

I tried to enable rates 6, 9 and 12.  In this case, it takes a few
seconds (but not minutes) before ping starts working.  The speed was
much lower, about 800 kbps.  When trying to measure it again, the driver
started printing this:

bcm43xx_d80211: DMA queue
overflow                                                              
printk: 6645842 messages
suppressed.                                                            
bcm43xx_d80211: DMA queue
overflow                                                              
printk: 6687948 messages
suppressed.                                                            
bcm43xx_d80211: DMA queue
overflow                                                              
printk: 6699076 messages
suppressed.                                                            
bcm43xx_d80211: DMA queue
overflow                                                              
printk: 6686516 messages
suppressed.                                                            

The system became unresponsive and I had to reboot it.  I've never seen
this problem if all OFDM rates are disabled.

-- 
Regards,
Pavel Roskin



From rjw at sisk.pl  Thu Feb  8 08:24:47 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 8 Feb 2007 08:24:47 +0100
Subject: Speed measurement and stability issues
In-Reply-To: <45CA6A5E.1030900@lwfinger.net>
References: <1170834817.11150.105.camel@dv> <45CA627B.8040309@docksud.com.ar>
	<45CA6A5E.1030900@lwfinger.net>
Message-ID: <200702080824.47726.rjw@sisk.pl>

On Thursday, 8 February 2007 01:10, Larry Finger wrote:
> Fernando Toledo wrote:
> > Pavel Roskin escribi?:
> > 
> >> rate:  iperf reports:
> > 
> >> 1       928 Kbits/sec
> >> 2      1.69 Mbits/sec
> >> 5.5    3.92 Mbits/sec
> >> 6      4.78 Mbits/sec
> >> 9      6.55 Mbits/sec
> >> 11     5.97 Mbits/sec
> >> 12     8.18 Mbits/sec
> >> 18     10.4 Mbits/sec
> >> 24     13.0 Mbits/sec
> >> 36     15.1 Mbits/sec
> >> 48      187 Kbits/sec
> >> 54     N/A
> > testing at 11Mb i have same aprox. value that Pavel.
> > it was a REally_GOOD_news for me :)
> 
> My results are:
> 
> rate		4311 rate	4318 rate
> =========================================
> 
> 11M		6.50 Mbs	6.34 Mbs
> 18M		10.4 Mbs	6.98 Mbs
> 24M		12.3 Mbs	7.61 Mbs
> 36M		15.0 Mbs	8.22 Mbs
> 48M		4.76 Mbs	8.05 Mbs
> 54M		Failed		7.82 Mbs

I get the best results at 24M, 15 Mb/s according to gkrellm.  36M is much
worse and when I switch directly from 11M to 36M the rate drops to 1-2 Mb/s.

Greetings,
Rafael


From proski at gnu.org  Thu Feb  8 09:46:21 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 03:46:21 -0500
Subject: Wrong phystatus0?
Message-ID: <1170924381.14208.45.camel@dv>

Hello!

Since I know that my card (still the same bcm4312) has a problem
receiving data frames and the problem can be mitigated by turning off
the OFDM rates, I decided to check if the bcm43xx_d80211 driver is
receiving data with OFDM rates.

Either I'm missing the obvious, or something is seriously wrong with the
driver and with the specification.

I added this line right after phystat0 is calculated in bcm43xx_rx(),
file bcm43xx_xmit.c:

printk("phystat0 = %04x\n", phystat0);

I loaded the module and tried to associate to a 802.11g AP.  I brought
the interface up and set up the parameters (channel, ap, essid).  The
link quality became 100/100 (that's a usual value for my setup).  As
usually, ping would not work.

That's what I saw on the console:

phystat0 = 0006
phystat0 = 0004
phystat0 = 0006
phystat0 = 0004
phystat0 = 0006
phystat0 = 0004
phystat0 = 0006
phystat0 = 0002
phystat0 = 0006
phystat0 = 0002

OFDM would need an odd number.  But 2 means PRE-N, and I don't have a
pre-n AP, it's Atheros 5212 with MadWifi in 802.11g mode.

Moreover, the bit 2 (value 4) is not described at all on
http://bcm-v4.sipsolutions.net/802.11/RX

That's all the values that have been seen:

# dmesg |grep phystat0 |sort -u
phystat0 = 0000
phystat0 = 0002
phystat0 = 0004
phystat0 = 0006
phystat0 = 0008
phystat0 = 0022
phystat0 = 0024
phystat0 = 0040
phystat0 = 0041
phystat0 = 0043
phystat0 = 0060

The value of 3 in the two lower bytes would mean standard 802.11n, and I
don't have it either.

It seems to me that the description of "PHY RX Status 0" has nothing to
to with the reality.

The CPU is x86_64 (Intel Core 2 Duo).  I'm using the latest firmware
4.102.15.61.  The kernel is current from
http://bu3sch.de/git/wireless-dev.git

Kernel messages on module load:

ACPI: PCI Interrupt 0000:0c:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:0c:00.0 to 64
ssb: Sonics Silicon Backplane found on PCI device 0000:0c:00.0
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to PCI-E core, index 3
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_d80211: Broadcom 4311 WLAN found
ssb: Switching to IEEE 802.11 core, index 1
ssb: Switching to PCI-E core, index 3
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Adding Interface type 2
bcm43xx_d80211: Found PHY: Version 4, Type 2, Revision 8
bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
bcm43xx_d80211: Loading firmware version 371.1122 (2006-11-08 22:02:13)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Radio turned on
bcm43xx_d80211: Chip initialized
bcm43xx_d80211: 32-bit DMA initialized
bcm43xx_d80211: Wireless interface started
wmaster0: Does not support passive scan, disabled

-- 
Regards,
Pavel Roskin



From radarsat1 at gmail.com  Thu Feb  8 18:11:49 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Thu, 8 Feb 2007 12:11:49 -0500
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <200702080809.03200.rjw@sisk.pl>
References: <45C96B8A.8010000@lwfinger.net>
	<45C984DA.9000606@puchalla-online.de> <45CA7A1E.3030508@lwfinger.net>
	<200702080809.03200.rjw@sisk.pl>
Message-ID: <9b3e2dc20702080911r75ec55a1of8885ee97cea5f9c@mail.gmail.com>

Hello,

Apologies for being so slow about applying and testing this patch.
Now that I had some time, I tried to be quite methodical about it.  I
hadn't used iperf before, so I'm happy to have heard about this nice
tool.

Here are my results, 4311, HD dv2020 laptop:

WITHOUT the patch in this thread:
1M: 726 Kbits/sec
2M: 337 Kbits/sec
5.5M: 162 Kbits/sec
6M: 151 Kbits/sec
9M: 168 Kbits/sec
11M: 173 Kbits/sec
12M: 185 Kbits/sec
18M: 174 Kbits/sec
24M: 152 Kbits/sec
36M: 209 Kbits/sec
48M: 224 Kbits/sec
54M: 8.03 Kbits/sec

WITH the patch in this thread:
1M: 752 Kbits/sec
2M: 1.34 Mbits/sec
5.5M: 2.95 Mbits/sec
6M: 3.14 Mbits/sec
9M: 4.90 Mbits/sec
11M: 4.71 Mbits/sec
12M: 6.80 Mbits/sec
18M: 8.85 Mbits/sec
24M: 10.2 Mbits/sec
36M: 12.3 Mbits/sec
48M: 5.11 Mbits/sec
54M: 72.1 Kbits/sec


So it seems my "sweet spot" is at 36M.  My "real world" results are
that I was able to transfer a 350 MB video file from my desktop to my
laptop over wireless in 3.5 minutes. ;-)
This is just about equivalent to the rates I get under Windows.

Good times...

I have one more test to try... I am strangely never able to associate
with the wifi router in my girlfriend's apartment, however it is a
crappy old D-Link B-series router.  I'll try it next time I get a
chance.  (I've long suspected the reason is that she lives in an
apartment building, and there are something like 20 other APs in the
vicinity, so potentially a lot of wifi traffic interfering.  However,
I am always able to connect using Windows.)


Steve


From Larry.Finger at lwfinger.net  Thu Feb  8 18:31:51 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 08 Feb 2007 11:31:51 -0600
Subject: Change SoftMAC to initialize to high rates
Message-ID: <45CB5E87.6090403@lwfinger.net>

There is a bug in SoftMAC that initializes data rates for all devices to 11 Mbs. Now that many of
the devices will actually run at higher rates, this patch fixes that bug.

As not all chips will run at speeds above 11 Mbs, I will not be sending this patch upstream to
Linville, but I wanted it available for the users. As you see, I'm setting a rate of 24 Mbs. If your
card works at 36, please change that line.

Larry
================================


A bug in SoftMAC will preferentially select a rate of 11 Mbytes/sec, even though
the device has an 802.11g PHY. This patch changes the order of testing
to set an OFDM rate for G PHY's. At present, a rate of 54 Mbytes/sec has
not been achieved; therefore the rate is initialized to 24 Mbs.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
===================================================================
--- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_module.c
+++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
@@ -270,10 +270,10 @@ void ieee80211softmac_init_bss(struct ie
 	   can manually change it if they really need to, but 11M is
 	   more reliable. Note similar logic in
 	   ieee80211softmac_wx_set_rate() */	
-	if (ieee->modulation & IEEE80211_CCK_MODULATION) {
-		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
+	if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
+		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
 	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
-		txrates->user_rate = IEEE80211_OFDM_RATE_54MB;
+		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
 	} else
 		assert(0);


---



-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: set_OFDM_modulation
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070208/c6a818d8/attachment.ksh>

From ubq7 at stud.uni-karlsruhe.de  Thu Feb  8 18:45:33 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Thu, 8 Feb 2007 18:45:33 +0100
Subject: Change SoftMAC to initialize to high rates
In-Reply-To: <45CB5E87.6090403@lwfinger.net>
References: <45CB5E87.6090403@lwfinger.net>
Message-ID: <200702081845.33811.ubq7@stud.uni-karlsruhe.de>

Am Donnerstag 08 Februar 2007 18:31 schrieb Larry Finger:
> +	if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
> +		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
>  	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
> +		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
>  	} else
>  		assert(0);

This code will never set IEEE80211_CCK_RATE_11MB.

HS


From proski at gnu.org  Thu Feb  8 18:48:12 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 12:48:12 -0500
Subject: Change SoftMAC to initialize to high rates
In-Reply-To: <45CB5E87.6090403@lwfinger.net>
References: <45CB5E87.6090403@lwfinger.net>
Message-ID: <1170956892.15458.3.camel@dv>

On Thu, 2007-02-08 at 11:31 -0600, Larry Finger wrote:
> +	if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
> +		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
>  	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {

This part doesn't make sense to me.  It's exactly the same condition,
which means that the code below "else" won't ever be executed.

-- 
Regards,
Pavel Roskin



From Larry.Finger at lwfinger.net  Thu Feb  8 19:00:05 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 08 Feb 2007 12:00:05 -0600
Subject: Survey of bcm43xx cards
Message-ID: <45CB6525.3070406@lwfinger.net>

Although a number of bcm43xx chips now work at rates above 11 Mbs, I know of at least one that does
not. It will help me in debugging the code if I know of the status of the others. Please help me
fill in this table. If your results are not in agreement with my results, or your chip is not in the
table, please let me know.

chip/revision	phy revision	radio rev.	status
======================================================

4306/2		1		2		Fails
4306/3		2		2		??
4311/1		8		2		Works
4318/2		7		8		Works


If you have not entered your card in the database, please visit
http://bcm-specs.sipsolutions.net/info.html and follow the simple instructions.

Thanks,

Larry


From caravena at ubuntu-cl.org  Thu Feb  8 19:14:40 2007
From: caravena at ubuntu-cl.org (Cristian Aravena Romero)
Date: Thu, 8 Feb 2007 15:14:40 -0300
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <bbff98600702081014q3fdab50fh1284848721a773e2@mail.gmail.com>

On 2/8/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:

[...]


> If you have not entered your card in the database, please visit
> http://bcm-specs.sipsolutions.net/info.html and follow the simple instructions.

$dmesg | egrep 'bcm43xx: (Chip|Core|Detected)' ; lspci -vn | grep -i 14e4 -A1
05:02.0 0280: 14e4:4318 (rev 02)
       Subsystem: 103c:1356

Work my chipset with kernel 2.6.20?

Thanks,
-- 
Cristian


From geekypenguin at gmail.com  Thu Feb  8 19:20:30 2007
From: geekypenguin at gmail.com (Jory A. Pratt)
Date: Thu, 08 Feb 2007 12:20:30 -0600
Subject: RFT bcm43xx: Really _GOOD_ news
In-Reply-To: <45C8E64B.1050605@lwfinger.net>
References: <45C8E64B.1050605@lwfinger.net>
Message-ID: <45CB69EE.4000102@gmail.com>

Larry Finger wrote:
> I have really _GOOD_ news!!!!! While reviewing the latest changes in the V4 specs, I found an
> interchange of the PHY version and PHY revision fields, relative to the current V3 specs. Of the
> three cards that I have, the 4306 had the same value for the PHY version and revision. In addition,
> it was the only card of the 3 thaw would work at 11Mbs. A light went on!
>
> After installing the patch listed below, both my 4318 and my 4311 will now run at 11Mbs. From tests
> with iperf, I now get rates of 6.1 - 6.5 Mbs from all three.
>
> Larry
>
>
> ==========
>
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -3707,9 +3707,9 @@ static int bcm43xx_read_phyinfo(struct b
>
>  	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
>
> -	phy_version = (value & 0xF000) >> 12;
> +	phy_rev = (value & 0xF000) >> 12;
>  	phy_type = (value & 0x0F00) >> 8;
> -	phy_rev = (value & 0x000F);
> +	phy_version = (value & 0x000F);
>
>  	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
>  		phy_version, phy_type, phy_rev);
>
>   
I have tested this until I am blue in the face on a 4318. It killed me,
I was getting less then 200k/b a sec on a 5M pipe :(. I reverted the
patch and all is back to working even tho transfering files on the
internal network is still way out there.



From proski at gnu.org  Thu Feb  8 20:20:06 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 14:20:06 -0500
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <1170962406.15458.20.camel@dv>

On Thu, 2007-02-08 at 12:00 -0600, Larry Finger wrote:
> Although a number of bcm43xx chips now work at rates above 11 Mbs, I know of at least one that does
> not. It will help me in debugging the code if I know of the status of the others. Please help me
> fill in this table. If your results are not in agreement with my results, or your chip is not in the
> table, please let me know.
> 
> chip/revision	phy revision	radio rev.	status
> ======================================================
> 
> 4306/2		1		2		Fails
> 4306/3		2		2		??
> 4311/1		8		2		Works

I guess my device matches as the above line.  The PCI ID is 4312, but
the driver reports Chip ID 4311.  Yes, it works for me.

> If you have not entered your card in the database, please visit
> http://bcm-specs.sipsolutions.net/info.html and follow the simple instructions.

This form doesn't want to take my input.

$ dmesg | egrep 'bcm43xx: (Chip|Core|Detected)' ; lspci -vn | grep -i 14e4 -A1
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Chip initialized
02:00.0 0200: 14e4:170c (rev 02)
        Subsystem: 1028:01d4
--
0c:00.0 0280: 14e4:4312 (rev 01)
        Subsystem: 1028:0007

The message is "Please submit info for exactly one card at a time
(duplicate pci)"

I think you may want to replace 14e4 is your instructions with 14e4:43
if you don't want to hear about non-wireless Broadcom devices.  This
way, it worked and the data has been submitted.

Happy owners of multiple Broadcom wireless cards will still have to
split the output

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Thu Feb  8 20:22:17 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 08 Feb 2007 14:22:17 -0500
Subject: Survey of bcm43xx cards
In-Reply-To: <bbff98600702081014q3fdab50fh1284848721a773e2@mail.gmail.com>
References: <45CB6525.3070406@lwfinger.net>
	<bbff98600702081014q3fdab50fh1284848721a773e2@mail.gmail.com>
Message-ID: <1170962537.15458.23.camel@dv>

On Thu, 2007-02-08 at 15:14 -0300, Cristian Aravena Romero wrote:

> $dmesg | egrep 'bcm43xx: (Chip|Core|Detected)' ; lspci -vn | grep -i 14e4 -A1
> 05:02.0 0280: 14e4:4318 (rev 02)
>        Subsystem: 103c:1356
> 
> Work my chipset with kernel 2.6.20?

It looks like you didn't load the driver.  If you don't try, nobody
would know if the driver is working for you.

-- 
Regards,
Pavel Roskin



From benoit.knecht at citycable.ch  Thu Feb  8 20:40:48 2007
From: benoit.knecht at citycable.ch (=?ISO-8859-1?Q?Beno=EEt_Knecht?=)
Date: Thu, 08 Feb 2007 20:40:48 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <45CB7CC0.1050505@citycable.ch>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi,

Larry Finger wrote:
> Although a number of bcm43xx chips now work at rates above 11 Mbs, I know of at least one that does
> not. It will help me in debugging the code if I know of the status of the others. Please help me
> fill in this table. If your results are not in agreement with my results, or your chip is not in the
> table, please let me know.
> 
> chip/revision	phy revision	radio rev.	status
> ======================================================
> 
> 4306/2		1		2		Fails
> 4306/3		2		2		??
> 4311/1		8		2		Works
> 4318/2		7		8		Works

My card is a 4318/2, phy rev. 7, radio rev. 8, and it indeed works at
rates higher than 11M. However, it is not very reliable. I need to be
close enough from the AP, and transfer rates are usually smaller than
expected.

> 
> If you have not entered your card in the database, please visit
> http://bcm-specs.sipsolutions.net/info.html and follow the simple instructions.
> 
> Thanks,
> 
> Larry
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFFy3y/y0EwBJvkHIMRAvCJAKCBp/q5pBD5GWV3k/722N/KeKCouACgnRSz
/2KcIA4qz5vvUe/51bhllcw=
=cf75
-----END PGP SIGNATURE-----


From rjw at sisk.pl  Thu Feb  8 22:02:43 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 8 Feb 2007 22:02:43 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <9b3e2dc20702080911r75ec55a1of8885ee97cea5f9c@mail.gmail.com>
References: <45C96B8A.8010000@lwfinger.net> <200702080809.03200.rjw@sisk.pl>
	<9b3e2dc20702080911r75ec55a1of8885ee97cea5f9c@mail.gmail.com>
Message-ID: <200702082202.43761.rjw@sisk.pl>

On Thursday, 8 February 2007 18:11, Stephen Sinclair wrote:
> Hello,
> 
> Apologies for being so slow about applying and testing this patch.
> Now that I had some time, I tried to be quite methodical about it.  I
> hadn't used iperf before, so I'm happy to have heard about this nice
> tool.
> 
> Here are my results, 4311, HD dv2020 laptop:
> 
> WITHOUT the patch in this thread:
> 1M: 726 Kbits/sec
> 2M: 337 Kbits/sec
> 5.5M: 162 Kbits/sec
> 6M: 151 Kbits/sec
> 9M: 168 Kbits/sec
> 11M: 173 Kbits/sec
> 12M: 185 Kbits/sec
> 18M: 174 Kbits/sec
> 24M: 152 Kbits/sec
> 36M: 209 Kbits/sec
> 48M: 224 Kbits/sec
> 54M: 8.03 Kbits/sec
> 
> WITH the patch in this thread:
> 1M: 752 Kbits/sec
> 2M: 1.34 Mbits/sec
> 5.5M: 2.95 Mbits/sec
> 6M: 3.14 Mbits/sec
> 9M: 4.90 Mbits/sec
> 11M: 4.71 Mbits/sec
> 12M: 6.80 Mbits/sec
> 18M: 8.85 Mbits/sec
> 24M: 10.2 Mbits/sec
> 36M: 12.3 Mbits/sec
> 48M: 5.11 Mbits/sec
> 54M: 72.1 Kbits/sec
> 
> 
> So it seems my "sweet spot" is at 36M.  My "real world" results are
> that I was able to transfer a 350 MB video file from my desktop to my
> laptop over wireless in 3.5 minutes. ;-)
> This is just about equivalent to the rates I get under Windows.
> 
> Good times...
> 
> I have one more test to try... I am strangely never able to associate
> with the wifi router in my girlfriend's apartment, however it is a
> crappy old D-Link B-series router.  I'll try it next time I get a
> chance.  (I've long suspected the reason is that she lives in an
> apartment building, and there are something like 20 other APs in the
> vicinity, so potentially a lot of wifi traffic interfering.  However,
> I am always able to connect using Windows.)

Have you tried it with the patch applied?

Rafael


From kas at fi.muni.cz  Thu Feb  8 22:14:08 2007
From: kas at fi.muni.cz (Jan Kasprzak)
Date: Thu, 8 Feb 2007 22:14:08 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <20070208211408.GD23007@fi.muni.cz>

Larry Finger wrote:
: Although a number of bcm43xx chips now work at rates above 11 Mbs, I know of at least one that does
: not. It will help me in debugging the code if I know of the status of the others. Please help me
: fill in this table. If your results are not in agreement with my results, or your chip is not in the
: table, please let me know.
: 
: chip/revision	phy revision	radio rev.	status
: ======================================================
: 
: 4306/2		1		2		Fails
: 4306/3		2		2		??

	I have the above 4306/3, and with 2.6.20+combined (i386 arch)
it apparently works - when I set "iwconfig eth1 rate 54Mbit", I am able
to scp from another host connected to the AP by a wired ethernet at 2.7MB/s.
When I set "iwconfig eth1 rate auto", it falls back to 11Mbit/s (at least
this is what "iwconfig eth1" reports, also scp is slower).

	However, I have problems getting the card up after boot: when
I do "ifup eth1", it fails after few seconds with the message:
"failed. No link present - check the cable?" (probably some Fedora-
or dhclient-specific message). When I do "ifconfig eth1 up; sleep 2;
ifup eth1", it gets the address from DHCP correctly.

: If you have not entered your card in the database, please visit
: http://bcm-specs.sipsolutions.net/info.html and follow the simple instructions.

	Done. FWIW, this is the info I have pasted there:

bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Chip initialized
02:07.0 0280: 14e4:4320 (rev 03)
        Subsystem: 1043:120f

	Hope this helps,

-Yenya


-- 
| Jan "Yenya" Kasprzak  <kas at {fi.muni.cz - work | yenya.net - private}> |
| GPG: ID 1024/D3498839      Fingerprint 0D99A7FB206605D7 8B35FCDE05B18A5E |
| http://www.fi.muni.cz/~kas/    Journal: http://www.fi.muni.cz/~kas/blog/ |
> I will never go to meetings again because I think  face to face meetings <
> are the biggest waste of time you can ever have.        --Linus Torvalds <


From richie at coderworld.net  Thu Feb  8 22:08:32 2007
From: richie at coderworld.net (Richard)
Date: Thu, 8 Feb 2007 22:08:32 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <200702082208.32336.richie@coderworld.net>

torsdag 08 februari 2007 19:00 skrev Larry Finger:
> chip/revision	phy revision	radio rev.	status
> ======================================================
>
> 4306/2		1		2		Fails
> 4306/3		2		2		??
> 4311/1		8		2		Works
> 4318/2		7		8		Works
>
    4311/1         4              2              Works

RATE     SPEED
1       863 Kbits/sec
2       1.56 Mbits/sec
5.5     3.51 Mbits/sec
6       4.34 Mbits/sec
9       4.87 Mbits/sec
11      4.96 Mbits/sec
12      6.22 Mbits/sec
18      6.96 Mbits/sec
24      8.95 Mbits/sec
36      5.39 Mbits/sec
48      1.08 Kbits/sec
54      dead


From rjw at sisk.pl  Thu Feb  8 22:34:18 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 8 Feb 2007 22:34:18 +0100
Subject: Change SoftMAC to initialize to high rates
In-Reply-To: <45CB5E87.6090403@lwfinger.net>
References: <45CB5E87.6090403@lwfinger.net>
Message-ID: <200702082234.19207.rjw@sisk.pl>

On Thursday, 8 February 2007 18:31, Larry Finger wrote:
> There is a bug in SoftMAC that initializes data rates for all devices to 11 Mbs. Now that many of
> the devices will actually run at higher rates, this patch fixes that bug.
> 
> As not all chips will run at speeds above 11 Mbs, I will not be sending this patch upstream to
> Linville, but I wanted it available for the users. As you see, I'm setting a rate of 24 Mbs. If your
> card works at 36, please change that line.

Hm, may I suggest the appended patch instead? ;-)

Rafael


Signed-off-by: Rafael J. Wysocki <rjw at sisk.pl>
---
 net/ieee80211/softmac/ieee80211softmac_module.c |    9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

Index: linux-2.6.20/net/ieee80211/softmac/ieee80211softmac_module.c
===================================================================
--- linux-2.6.20.orig/net/ieee80211/softmac/ieee80211softmac_module.c
+++ linux-2.6.20/net/ieee80211/softmac/ieee80211softmac_module.c
@@ -270,12 +270,13 @@ void ieee80211softmac_init_bss(struct ie
 	   can manually change it if they really need to, but 11M is
 	   more reliable. Note similar logic in
 	   ieee80211softmac_wx_set_rate() */	 
-	if (ieee->modulation & IEEE80211_CCK_MODULATION) {
+	if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
+		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
+	} else if (ieee->modulation & IEEE80211_CCK_MODULATION) {
 		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
-	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
-		txrates->user_rate = IEEE80211_OFDM_RATE_54MB;
-	} else
+	} else {
 		assert(0);
+	}
 
 	txrates->default_rate = IEEE80211_CCK_RATE_1MB;
 	change |= IEEE80211SOFTMAC_TXRATECHG_DEFAULT;


From larry.finger at lwfinger.net  Thu Feb  8 23:09:16 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 08 Feb 2007 16:09:16 -0600
Subject: Change SoftMAC to initialize to high rates
In-Reply-To: <200702082234.19207.rjw@sisk.pl>
References: <45CB5E87.6090403@lwfinger.net> <200702082234.19207.rjw@sisk.pl>
Message-ID: <45CB9F8C.5090507@lwfinger.net>

Rafael J. Wysocki wrote:
> On Thursday, 8 February 2007 18:31, Larry Finger wrote:
>> There is a bug in SoftMAC that initializes data rates for all devices to 11 Mbs. Now that many of
>> the devices will actually run at higher rates, this patch fixes that bug.
>>
>> As not all chips will run at speeds above 11 Mbs, I will not be sending this patch upstream to
>> Linville, but I wanted it available for the users. As you see, I'm setting a rate of 24 Mbs. If your
>> card works at 36, please change that line.
> 
> Hm, may I suggest the appended patch instead? ;-)
> 
> Rafael
> 
> 
> Signed-off-by: Rafael J. Wysocki <rjw at sisk.pl>
> ---
>  net/ieee80211/softmac/ieee80211softmac_module.c |    9 +++++----
>  1 file changed, 5 insertions(+), 4 deletions(-)
> 
> Index: linux-2.6.20/net/ieee80211/softmac/ieee80211softmac_module.c
> ===================================================================
> --- linux-2.6.20.orig/net/ieee80211/softmac/ieee80211softmac_module.c
> +++ linux-2.6.20/net/ieee80211/softmac/ieee80211softmac_module.c
> @@ -270,12 +270,13 @@ void ieee80211softmac_init_bss(struct ie
>  	   can manually change it if they really need to, but 11M is
>  	   more reliable. Note similar logic in
>  	   ieee80211softmac_wx_set_rate() */	 
> -	if (ieee->modulation & IEEE80211_CCK_MODULATION) {
> +	if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
> +		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
> +	} else if (ieee->modulation & IEEE80211_CCK_MODULATION) {
>  		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
> -	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
> -		txrates->user_rate = IEEE80211_OFDM_RATE_54MB;
> -	} else
> +	} else {
>  		assert(0);
> +	}
>  
>  	txrates->default_rate = IEEE80211_CCK_RATE_1MB;
>  	change |= IEEE80211SOFTMAC_TXRATECHG_DEFAULT;

Your patch fixes the stupid mistake I had in the first version and is fine; however, after I looked
at the code a bit more, I decided to remove the assert(0). It is only there to make sure that the
driver set up ieee->modulation correctly. As it is unlikely that there will be any new drivers using
SoftMAC, that statement can go.

Larry




From larry.finger at lwfinger.net  Thu Feb  8 23:14:08 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 08 Feb 2007 16:14:08 -0600
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB7CC0.1050505@citycable.ch>
References: <45CB6525.3070406@lwfinger.net> <45CB7CC0.1050505@citycable.ch>
Message-ID: <45CBA0B0.2060900@lwfinger.net>

Beno?t Knecht wrote:
> 
> My card is a 4318/2, phy rev. 7, radio rev. 8, and it indeed works at
> rates higher than 11M. However, it is not very reliable. I need to be
> close enough from the AP, and transfer rates are usually smaller than
> expected.

Yes, the signal from the 4318 is weaker than from the 4311. The maximum rate I achieve from my 4311
is 15 Mbs, whereas my 4318 maxes out at about 8 Mbs. Once I get the 4306/2 cards working, I will be
looking at the 4318 problem.

Larry


From larry.finger at lwfinger.net  Thu Feb  8 23:17:34 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 08 Feb 2007 16:17:34 -0600
Subject: Survey of bcm43xx cards
In-Reply-To: <200702082208.32336.richie@coderworld.net>
References: <45CB6525.3070406@lwfinger.net>
	<200702082208.32336.richie@coderworld.net>
Message-ID: <45CBA17E.1080208@lwfinger.net>

Richard wrote:
> torsdag 08 februari 2007 19:00 skrev Larry Finger:
>> chip/revision	phy revision	radio rev.	status
>> ======================================================
>>
>> 4306/2		1		2		Fails
>> 4306/3		2		2		??
>> 4311/1		8		2		Works
>> 4318/2		7		8		Works
>>
>     4311/1         4              2              Works
> 
> RATE     SPEED
> 1       863 Kbits/sec
> 2       1.56 Mbits/sec
> 5.5     3.51 Mbits/sec
> 6       4.34 Mbits/sec
> 9       4.87 Mbits/sec
> 11      4.96 Mbits/sec
> 12      6.22 Mbits/sec
> 18      6.96 Mbits/sec
> 24      8.95 Mbits/sec
> 36      5.39 Mbits/sec
> 48      1.08 Kbits/sec
> 54      dead

Are you using the patch from the "RFT bcm43xx: Really _GOOD_ news" E-mail. It interchanges the PHY
version and revision numbers. AFAIK, all 4311/1's hav a PHY version of 8.

Larry


From mateusz-lists at ant.gliwice.pl  Thu Feb  8 23:27:37 2007
From: mateusz-lists at ant.gliwice.pl (Mateusz Korniak)
Date: Thu, 8 Feb 2007 23:27:37 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB7CC0.1050505@citycable.ch>
References: <45CB6525.3070406@lwfinger.net> <45CB7CC0.1050505@citycable.ch>
Message-ID: <200702082327.37086.mateusz-lists@ant.gliwice.pl>

On Thursday 08 February 2007 20:40, Beno?t Knecht wrote:
> > chip/revision?phy revision????radio rev.??????status
> > ======================================================
> >
> > 4306/2????????????????1???????????????2???????????????Fails
> > 4306/3????????????????2???????????????2?????????????????
> > 4311/1????????????????8???????????????2???????????????Works
> > 4318/2????????????????7???????????????8???????????????Works
>
> My card is a 4318/2, phy rev. 7, radio rev. 8, and it indeed works at
> rates higher than 11M. However, it is not very reliable. I need to be
> close enough from the AP, and transfer rates are usually smaller than
> expected.

I have exactly same card [1] and using 2.6.20 with _only_ 2.6.20_combined 
patch. I always get connected at 11Mbps with real transfers around 1.8 MB/s 
(download)[2] and 0.7MB/s (upload) [3] in excellent conditions [4].
I know 1.8 MB/s is above theoretical limit of 11Mbps but it is exactly like 
that.

[1]:
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Chip ID 0x4318, rev 0x2
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Number of cores: 4
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 
0x4243
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 
0x4243
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 
0x4243
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 
0x4243
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: PHY connected
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Detected PHY: Version: 3, Type 2, 
Revision 7
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Detected Radio: ID: 8205017f 
(Manuf: 17f Ver: 2050 Rev: 8)
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Radio turned off
Feb  8 17:03:01 laptop-hp kernel: bcm43xx: Radio turned off

[2]:
[matkor at charm ~/Movies/Lost_PL_2]$ time 
scp ./Lost.S02E07.PL.TVRip.XviD-RDP.www\!OSiOLEK\!com.avi  
matkor at 192.168.5.11:~/data/
Password:
Lost.S02E07.PL.TVRip.XviD-RDP.www!OSiOLEK!com.avi                                                                                                                       
100%  349MB   1.8MB/s   03:13

real    3m14.227s
user    0m14.781s
sys     0m4.748s
[matkor at charm ~/Movies/Lost_PL_2]$ ls -la 
Lost.S02E07.PL.TVRip.XviD-RDP.www\!OSiOLEK\!com.avi
-rw-r--r--  1 matkor users 365715456 2006-06-10 17:49 
Lost.S02E07.PL.TVRip.XviD-RDP.www!OSiOLEK!com.avi

[3]:
[matkor at laptop-hp ~/data]$ time scp 
Lost.S02E07.PL.TVRip.XviD-RDP.www\!OSiOLEK\!com.avi  matkor at 192.168.5.2:
Password:
Lost.S02E07.PL.TVRip.XviD-RDP.www!OSiOLEK!com.avi                                                                                                                       
100%  349MB 727.4KB/s   08:11

real    8m12.941s
user    0m9.803s
sys     0m12.303s


[4]:
eth1      IEEE 802.11b/g  ESSID:"ANT"  Nickname:"laptop-hp.ant.vpn"
          Mode:Managed  Frequency=2.412 GHz  Access Point: 00:0F:B5:18:99:32
          Bit Rate=11 Mb/s   Tx-Power=19 dBm
          RTS thr:off   Fragment thr:off
          Encryption 
key:2BA4-7596-3927-CD6D-1AE9-10FF-631B-BA68-85F7-D12C-76D7-9062-C355-660D-B2C0-BFBE   
Security mode:open
          Link Quality=71/100  Signal level=-43 dBm  Noise level=-73 dBm
          Rx invalid nwid:0  Rx invalid crypt:8  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

-- 
Mateusz Korniak


From schwab at suse.de  Fri Feb  9 01:16:09 2007
From: schwab at suse.de (Andreas Schwab)
Date: Fri, 09 Feb 2007 01:16:09 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net> (Larry Finger's message of "Thu, 
	08 Feb 2007 12:00:05 -0600")
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <jetzxwuqwm.fsf@sykes.suse.de>

Larry Finger <Larry.Finger at lwfinger.net> writes:

> 4318/2		7		8		Works

Mine is the same, but it does not work at all.  I can't get it to
associate with the AP.

Andreas.

-- 
Andreas Schwab, SuSE Labs, schwab at suse.de
SuSE Linux Products GmbH, Maxfeldstra?e 5, 90409 N?rnberg, Germany
PGP key fingerprint = 58CA 54C7 6D53 942B 1756  01D3 44D5 214B 8276 4ED5
"And now for something completely different."


From hs4233 at mail.mn-solutions.de  Fri Feb  9 08:37:41 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Fri, 9 Feb 2007 08:37:41 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <200702082327.37086.mateusz-lists@ant.gliwice.pl>
References: <45CB6525.3070406@lwfinger.net> <45CB7CC0.1050505@citycable.ch>
	<200702082327.37086.mateusz-lists@ant.gliwice.pl>
Message-ID: <200702090837.41929.hs4233@mail.mn-solutions.de>

> (upload) [3] in excellent conditions [4]. I know 1.8 MB/s is
> above theoretical limit of 11Mbps but it is exactly like that.

If you transmit above theretical limit, then you probably don't 
send at 11 MBit/s, but at a higher 802.11g rate.

Don't you guys have real access points (e.g. Cisco or whatever) 
where the Access Point can say with what data rate you're coming 
in?


From mateusz-lists at ant.gliwice.pl  Fri Feb  9 09:23:43 2007
From: mateusz-lists at ant.gliwice.pl (Mateusz Korniak)
Date: Fri, 9 Feb 2007 09:23:43 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <200702090837.41929.hs4233@mail.mn-solutions.de>
References: <45CB6525.3070406@lwfinger.net>
	<200702082327.37086.mateusz-lists@ant.gliwice.pl>
	<200702090837.41929.hs4233@mail.mn-solutions.de>
Message-ID: <200702090923.43301.mateusz-lists@ant.gliwice.pl>

On Friday 09 February 2007 08:37, Holger Schurig wrote:
> > (upload) [3] in excellent conditions [4]. I know 1.8 MB/s is
> > above theoretical limit of 11Mbps but it is exactly like that.
>
> If you transmit above theretical limit, then you probably don't
> send at 11 MBit/s, but at a higher 802.11g rate.

Just to precise my previious mail -  I am sending 750KB/s and receiving sth 
around 1.9 MB/s.


-- 
Mateusz Korniak


From mail at puchalla-online.de  Fri Feb  9 10:15:00 2007
From: mail at puchalla-online.de (Jochen Puchalla)
Date: Fri, 09 Feb 2007 10:15:00 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45CA7A1E.3030508@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net>
	<45C984DA.9000606@puchalla-online.de>
	<45CA7A1E.3030508@lwfinger.net>
Message-ID: <45CC3B94.4050006@puchalla-online.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Larry Finger wrote:
> Jochen Puchalla wrote:
>> this sounds wonderful! However, I applied this patch and
>> radio_enable_2.6.20 to my 2.6.20-rc7 on an HP nx6325 (I know you have
>> one as well), but still I only get 100kB/s at 1M 2M 5.5M and 11M. Do I
>> need the combined-patch for 2.6.20? I only have 1GB RAM and don't do
>> suspends, so I don't think so.
> 
> Jochen,
> 
> My laptop is an HP dv2125nr, but it has a BCM4311 with the same revisions as yours. I don't
> understand why your system doesn't show the improvement.
> 
> The combined patch also includes the code for handling the rf switch correctly. It shouldn't be
> needed, but please try a kernel with the combined patch for 2.6.20 and either one of the patches
> from yesterday - the _GOOD_ news faulty one or the one that followed.

Hi Larry,

I tried both versions with the combined patch on 2.6.20-rc7, still only
100kB/s. Could this be related to the fact that I have a b-type router
and not a g-type?

Gru?,
Jochen
- --
"In a world without fences and walls, who needs gates and windows?"

Das bessere Office kostenlos:  http://de.openoffice.org/
Einfach der bessere Browser:   http://www.mozilla.com/firefox/all
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.5 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFzDuUZaqLqiTpDaoRAsWQAJ4tguH9Ne9dUfIrwZDJASj5c6aCRACgizTP
2z2AfOKuoTh/unqc9uhXoMU=
=lyQe
-----END PGP SIGNATURE-----


From mathias.demare at gmail.com  Fri Feb  9 14:09:39 2007
From: mathias.demare at gmail.com (=?ISO-8859-1?Q?Mathias_De_Mar=E9?=)
Date: Fri, 9 Feb 2007 14:09:39 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <1170962537.15458.23.camel@dv>
References: <45CB6525.3070406@lwfinger.net>
	<bbff98600702081014q3fdab50fh1284848721a773e2@mail.gmail.com>
	<1170962537.15458.23.camel@dv>
Message-ID: <375c60f40702090509k617c5730ic9ced2229250b65d@mail.gmail.com>

2007/2/8, Pavel Roskin <proski at gnu.org>:
>
> On Thu, 2007-02-08 at 15:14 -0300, Cristian Aravena Romero wrote:
>
> > $dmesg | egrep 'bcm43xx: (Chip|Core|Detected)' ; lspci -vn | grep -i
> 14e4 -A1
> > 05:02.0 0280: 14e4:4318 (rev 02)
> >        Subsystem: 103c:1356
> >
> > Work my chipset with kernel 2.6.20?
>
> It looks like you didn't load the driver.  If you don't try, nobody
> would know if the driver is working for you.
>
> --
> Regards,
> Pavel Roskin
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>


I get very similar output to what Cristian Aravena Romero sent:
mathias at mathias-laptop:~$ dmesg | egrep 'bcm43xx: (Chip|Core|Detected)' ;
lspci -vn | grep -i 14e4 -A1
00:0b.0 0280: 14e4:4318 (rev 02)
        Subsystem: 1468:0312

The thing is: I'm running kernel 2.6.20 with the patches from Larry (
ftp://lwfinger.dynalias.org/patches/ ), and I'm typing this message while
connected to a wireless network through my Broadcom 4318 card.

Am I missing something here, or did I misunderstand?

Greetings,
Mathias De Mar?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070209/f9798240/attachment.html>

From Larry.Finger at lwfinger.net  Fri Feb  9 17:18:03 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 10:18:03 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
Message-ID: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>

After a suspend/resume cycle, bcm43xx-softmac has lost its association with
the AP and requires manual intervention. This situation is fixed by making
one of softmac's internal routines public and calling it.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---


Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -4278,6 +4278,7 @@ static int bcm43xx_resume(struct pci_dev
 {
 	struct net_device *net_dev = pci_get_drvdata(pdev);
 	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
+	struct ieee80211softmac_device *mac = ieee80211_priv(net_dev);
 	int err = 0;
 
 	dprintk(KERN_INFO PFX "Resuming...\n");
@@ -4299,6 +4300,9 @@ static int bcm43xx_resume(struct pci_dev
 	}
 	netif_device_attach(net_dev);
 
+	if (mac->associnfo.associated)
+		ieee80211softmac_try_reassoc(mac);
+
 	dprintk(KERN_INFO PFX "Device resumed.\n");
 
 	return 0;
Index: linux-2.6/include/net/ieee80211softmac.h
===================================================================
--- linux-2.6.orig/include/net/ieee80211softmac.h
+++ linux-2.6/include/net/ieee80211softmac.h
@@ -254,6 +254,7 @@ struct ieee80211softmac_device {
 };
 
 extern void ieee80211softmac_scan_finished(struct ieee80211softmac_device *sm);
+extern void ieee80211softmac_try_reassoc(struct ieee80211softmac_device *mac);
 
 static inline void * ieee80211softmac_priv(struct net_device *dev)
 {
Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
===================================================================
--- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_assoc.c
+++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
@@ -441,6 +441,7 @@ ieee80211softmac_try_reassoc(struct ieee
 	schedule_delayed_work(&mac->associnfo.work, 0);
 	spin_unlock_irqrestore(&mac->lock, flags);
 }
+EXPORT_SYMBOL_GPL(ieee80211softmac_try_reassoc);
 
 int
 ieee80211softmac_handle_disassoc(struct net_device * dev,


From Larry.Finger at lwfinger.net  Fri Feb  9 17:32:54 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 10:32:54 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
Message-ID: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>

The specifications for the bcm43xx driver have been modified. This patch
incorporates these changes in the code, which results in the BCM4311 and
BCM4312 working. The name of one of the PHY parameters, previously known
as "version", has been changed to "analog core version" .

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

John,

I hope this fix makes it into 2.6.21. As you have seen from the list, it is a biggie!

Larry
---

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -542,7 +542,7 @@ struct bcm43xx_lopair {
 
 struct bcm43xx_phyinfo {
 	/* Hardware Data */
-	u8 version;
+	u8 analog;
 	u8 type;
 	u8 rev;
 	u16 antenna_diversity;
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -205,8 +205,8 @@ static void bcm43xx_phy_init_pctl(struct
 	    (bcm->board_type == 0x0416))
 		return;
 
-	bcm43xx_write16(bcm, 0x03E6, bcm43xx_read16(bcm, 0x03E6) & 0xFFDF);
 	bcm43xx_phy_write(bcm, 0x0028, 0x8018);
+	bcm43xx_write16(bcm, 0x03E6, bcm43xx_read16(bcm, 0x03E6) & 0xFFDF);
 
 	if (phy->type == BCM43xx_PHYTYPE_G) {
 		if (!phy->connected)
@@ -729,19 +729,19 @@ static void bcm43xx_phy_initb5(struct bc
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
 	u16 offset;
+	u16 value;
+	u8 old_channel;
 
-	if (phy->version == 1 &&
-	    radio->version == 0x2050) {
+	if (phy->analog == 1)
 		bcm43xx_radio_write16(bcm, 0x007A,
 				      bcm43xx_radio_read16(bcm, 0x007A)
 				      | 0x0050);
-	}
 	if ((bcm->board_vendor != PCI_VENDOR_ID_BROADCOM) &&
 	    (bcm->board_type != 0x0416)) {
+		value = 0x2120;
 		for (offset = 0x00A8 ; offset < 0x00C7; offset++) {
-			bcm43xx_phy_write(bcm, offset,
-					  (bcm43xx_phy_read(bcm, offset) + 0x2020)
-					  & 0x3F3F);
+			bcm43xx_phy_write(bcm, offset, value);
+			value += 0x0202;
 		}
 	}
 	bcm43xx_phy_write(bcm, 0x0035,
@@ -776,7 +776,7 @@ static void bcm43xx_phy_initb5(struct bc
 				  bcm43xx_phy_read(bcm, BCM43xx_PHY_RADIO_BITFIELD) | (1 << 11));
 	}
 
-	if (phy->version == 1 && radio->version == 0x2050) {
+	if (phy->analog == 1) {
 		bcm43xx_phy_write(bcm, 0x0026, 0xCE00);
 		bcm43xx_phy_write(bcm, 0x0021, 0x3763);
 		bcm43xx_phy_write(bcm, 0x0022, 0x1BC3);
@@ -787,14 +787,15 @@ static void bcm43xx_phy_initb5(struct bc
 	bcm43xx_phy_write(bcm, 0x0030, 0x00C6);
 	bcm43xx_write16(bcm, 0x03EC, 0x3F22);
 
-	if (phy->version == 1 && radio->version == 0x2050)
+	if (phy->analog == 1)
 		bcm43xx_phy_write(bcm, 0x0020, 0x3E1C);
 	else
 		bcm43xx_phy_write(bcm, 0x0020, 0x301C);
 
-	if (phy->version == 0)
+	if (phy->analog == 0)
 		bcm43xx_write16(bcm, 0x03E4, 0x3000);
 
+	old_channel = radio->channel;
 	/* Force to channel 7, even if not supported. */
 	bcm43xx_radio_selectchannel(bcm, 7, 0);
 
@@ -816,11 +817,11 @@ static void bcm43xx_phy_initb5(struct bc
 
 	bcm43xx_radio_write16(bcm, 0x007A, bcm43xx_radio_read16(bcm, 0x007A) | 0x0007);
 
-	bcm43xx_radio_selectchannel(bcm, BCM43xx_RADIO_DEFAULT_CHANNEL_BG, 0);
+	bcm43xx_radio_selectchannel(bcm, old_channel, 0);
 
 	bcm43xx_phy_write(bcm, 0x0014, 0x0080);
 	bcm43xx_phy_write(bcm, 0x0032, 0x00CA);
-	bcm43xx_phy_write(bcm, 0x88A3, 0x002A);
+	bcm43xx_phy_write(bcm, 0x002A, 0x88A3);
 
 	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
 
@@ -933,6 +934,8 @@ static void bcm43xx_phy_initb6(struct bc
 		                  bcm43xx_phy_read(bcm, 0x0802) | 0x0100);
 		bcm43xx_phy_write(bcm, 0x042B,
 		                  bcm43xx_phy_read(bcm, 0x042B) | 0x2000);
+		bcm43xx_phy_write(bcm, 0x5B, 0x0000);
+		bcm43xx_phy_write(bcm, 0x5C, 0x0000);
 	}
 
 	/* Force to channel 7, even if not supported. */
@@ -976,10 +979,12 @@ static void bcm43xx_phy_initb6(struct bc
 			bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
 	}
 	
-	if (phy->rev == 4)
-		bcm43xx_phy_write(bcm, 0x0002, (bcm43xx_phy_read(bcm, 0x0002) & 0xFFC0) | 0x0004);
-	else
+	if (phy->analog == 4){
 		bcm43xx_write16(bcm, 0x03E4, 0x0009);
+		bcm43xx_phy_write(bcm, 0x61, bcm43xx_phy_read(bcm, 0x61) & 0xFFF);
+	} else {
+		bcm43xx_phy_write(bcm, 0x0002, (bcm43xx_phy_read(bcm, 0x0002) & 0xFFC0) | 0x0004);
+	}
 	if (phy->type == BCM43xx_PHYTYPE_B) {
 		bcm43xx_write16(bcm, 0x03E6, 0x8140);
 		bcm43xx_phy_write(bcm, 0x0016, 0x0410);
@@ -1063,7 +1068,7 @@ static void bcm43xx_calc_loopback_gain(s
 	bcm43xx_phy_write(bcm, 0x005A, 0x0780);
 	bcm43xx_phy_write(bcm, 0x0059, 0xC810);
 	bcm43xx_phy_write(bcm, 0x0058, 0x000D);
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		bcm43xx_phy_write(bcm, 0x0003, 0x0122);
 	} else {
 		bcm43xx_phy_write(bcm, 0x000A,
@@ -1225,7 +1230,7 @@ static void bcm43xx_phy_initg(struct bcm
 	}
 	if (phy->rev < 3 && phy->connected)
 		bcm43xx_phy_write(bcm, 0x047E, 0x0078);
-	if (phy->rev >= 6 && phy->rev <= 8) {
+	if (radio->revision == 8) {
 		bcm43xx_phy_write(bcm, 0x0801, bcm43xx_phy_read(bcm, 0x0801) | 0x0080);
 		bcm43xx_phy_write(bcm, 0x043E, bcm43xx_phy_read(bcm, 0x043E) | 0x0004);
 	}
@@ -1638,14 +1643,14 @@ void bcm43xx_phy_set_baseband_attenuatio
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	u16 value;
 
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		value = (bcm43xx_read16(bcm, 0x03E6) & 0xFFF0);
 		value |= (baseband_attenuation & 0x000F);
 		bcm43xx_write16(bcm, 0x03E6, value);
 		return;
 	}
 
-	if (phy->version > 1) {
+	if (phy->analog > 1) {
 		value = bcm43xx_phy_read(bcm, 0x0060) & ~0x003C;
 		value |= (baseband_attenuation << 2) & 0x003C;
 	} else {
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
@@ -1393,11 +1393,12 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	backup[12] = bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT);
 
 	// Initialization
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		bcm43xx_write16(bcm, 0x03E6, 0x0122);
 	} else {
-		if (phy->version >= 2)
-			bcm43xx_write16(bcm, 0x03E6, 0x0040);
+		if (phy->analog >= 2)
+			bcm43xx_write16(bcm, 0x0003, (bcm43xx_read16(bcm, 0x0003)
+					& 0xFFBF) | 0x0040);
 		bcm43xx_write16(bcm, BCM43xx_MMIO_CHANNEL_EXT,
 		                (bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT) | 0x2000));
 	}
@@ -1488,7 +1489,7 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	bcm43xx_phy_write(bcm, 0x0059, backup[17]);
 	bcm43xx_phy_write(bcm, 0x0058, backup[18]);
 	bcm43xx_write16(bcm, 0x03E6, backup[11]);
-	if (phy->version != 0)
+	if (phy->analog != 0)
 		bcm43xx_write16(bcm, BCM43xx_MMIO_CHANNEL_EXT, backup[12]);
 	bcm43xx_phy_write(bcm, 0x0035, backup[10]);
 	bcm43xx_radio_selectchannel(bcm, radio->channel, 1);
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3699,7 +3699,7 @@ static int bcm43xx_read_phyinfo(struct b
 {
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	u16 value;
-	u8 phy_version;
+	u8 phy_analog;
 	u8 phy_type;
 	u8 phy_rev;
 	int phy_rev_ok = 1;
@@ -3707,12 +3707,12 @@ static int bcm43xx_read_phyinfo(struct b
 
 	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
 
-	phy_version = (value & 0xF000) >> 12;
+	phy_analog = (value & 0xF000) >> 12;
 	phy_type = (value & 0x0F00) >> 8;
 	phy_rev = (value & 0x000F);
 
 	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
-		phy_version, phy_type, phy_rev);
+		phy_analog, phy_type, phy_rev);
 
 	switch (phy_type) {
 	case BCM43xx_PHYTYPE_A:
@@ -3755,7 +3755,7 @@ static int bcm43xx_read_phyinfo(struct b
 		       phy_rev);
 	}
 
-	phy->version = phy_version;
+	phy->analog = phy_analog;
 	phy->type = phy_type;
 	phy->rev = phy_rev;
 	if ((phy_type == BCM43xx_PHYTYPE_B) || (phy_type == BCM43xx_PHYTYPE_G)) {


From larry.finger at lwfinger.net  Fri Feb  9 17:43:40 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 10:43:40 -0600
Subject: Survey of bcm43xx cards
In-Reply-To: <375c60f40702090509k617c5730ic9ced2229250b65d@mail.gmail.com>
References: <45CB6525.3070406@lwfinger.net>	<bbff98600702081014q3fdab50fh1284848721a773e2@mail.gmail.com>	<1170962537.15458.23.camel@dv>
	<375c60f40702090509k617c5730ic9ced2229250b65d@mail.gmail.com>
Message-ID: <45CCA4BC.8010303@lwfinger.net>

Mathias De Mar? wrote:
> I get very similar output to what Cristian Aravena Romero sent:
> mathias at mathias-laptop:~$ dmesg | egrep 'bcm43xx: (Chip|Core|Detected)'
> ; lspci -vn | grep -i 14e4 -A1
> 00:0b.0 0280: 14e4:4318 (rev 02)
>         Subsystem: 1468:0312
> 
> The thing is: I'm running kernel 2.6.20 with the patches from Larry (
> ftp://lwfinger.dynalias.org/patches/
> <ftp://lwfinger.dynalias.org/patches/> ), and I'm typing this message
> while connected to a wireless network through my Broadcom 4318 card.
> 
> Am I missing something here, or did I misunderstand?
> 

You do not have CONFIG_BCM43XX_DEBUG turned on in your kernel configuration.

Larry



From mb at bu3sch.de  Fri Feb  9 17:53:12 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 17:53:12 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
Message-ID: <200702091753.12419.mb@bu3sch.de>

On Friday 09 February 2007 17:18, Larry Finger wrote:
> After a suspend/resume cycle, bcm43xx-softmac has lost its association with
> the AP and requires manual intervention. This situation is fixed by making
> one of softmac's internal routines public and calling it.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>

Ack, this is good as workaround.

> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -4278,6 +4278,7 @@ static int bcm43xx_resume(struct pci_dev
>  {
>  	struct net_device *net_dev = pci_get_drvdata(pdev);
>  	struct bcm43xx_private *bcm = bcm43xx_priv(net_dev);
> +	struct ieee80211softmac_device *mac = ieee80211_priv(net_dev);
>  	int err = 0;
>  
>  	dprintk(KERN_INFO PFX "Resuming...\n");
> @@ -4299,6 +4300,9 @@ static int bcm43xx_resume(struct pci_dev
>  	}
>  	netif_device_attach(net_dev);
>  
> +	if (mac->associnfo.associated)
> +		ieee80211softmac_try_reassoc(mac);
> +
>  	dprintk(KERN_INFO PFX "Device resumed.\n");
>  
>  	return 0;
> Index: linux-2.6/include/net/ieee80211softmac.h
> ===================================================================
> --- linux-2.6.orig/include/net/ieee80211softmac.h
> +++ linux-2.6/include/net/ieee80211softmac.h
> @@ -254,6 +254,7 @@ struct ieee80211softmac_device {
>  };
>  
>  extern void ieee80211softmac_scan_finished(struct ieee80211softmac_device *sm);
> +extern void ieee80211softmac_try_reassoc(struct ieee80211softmac_device *mac);
>  
>  static inline void * ieee80211softmac_priv(struct net_device *dev)
>  {
> Index: linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
> ===================================================================
> --- linux-2.6.orig/net/ieee80211/softmac/ieee80211softmac_assoc.c
> +++ linux-2.6/net/ieee80211/softmac/ieee80211softmac_assoc.c
> @@ -441,6 +441,7 @@ ieee80211softmac_try_reassoc(struct ieee
>  	schedule_delayed_work(&mac->associnfo.work, 0);
>  	spin_unlock_irqrestore(&mac->lock, flags);
>  }
> +EXPORT_SYMBOL_GPL(ieee80211softmac_try_reassoc);
>  
>  int
>  ieee80211softmac_handle_disassoc(struct net_device * dev,
> -
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at  http://vger.kernel.org/majordomo-info.html
> 
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Feb  9 18:00:22 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 11:00:22 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45CC3B94.4050006@puchalla-online.de>
References: <45C96B8A.8010000@lwfinger.net>
	<45C984DA.9000606@puchalla-online.de>
	<45CA7A1E.3030508@lwfinger.net>
	<45CC3B94.4050006@puchalla-online.de>
Message-ID: <45CCA8A6.4090808@lwfinger.net>

Jochen Puchalla wrote:
> 
> Hi Larry,
> 
> I tried both versions with the combined patch on 2.6.20-rc7, still only
> 100kB/s. Could this be related to the fact that I have a b-type router
> and not a g-type?

It shouldn't. I just ran tests here with different settings on my AP. With a B-only setting, I get a
maximum of 5.5 Mbs. In Mixed B/G-mode, I get 5.9 Mbs and with G only, the rate is 6.3 Mbs. All of
these were run with an iwconfig rate of 11 Mbs.

Larry



From mb at bu3sch.de  Fri Feb  9 18:11:40 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 18:11:40 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
Message-ID: <200702091811.40683.mb@bu3sch.de>

On Friday 09 February 2007 17:32, Larry Finger wrote:
> The specifications for the bcm43xx driver have been modified. This patch
> incorporates these changes in the code, which results in the BCM4311 and
> BCM4312 working. The name of one of the PHY parameters, previously known
> as "version", has been changed to "analog core version" .
> 
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
> ---

> @@ -729,19 +729,19 @@ static void bcm43xx_phy_initb5(struct bc
>  	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
>  	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
>  	u16 offset;
> +	u16 value;
> +	u8 old_channel;
>  
> -	if (phy->version == 1 &&
> -	    radio->version == 0x2050) {

Why do you delete the check to radio version.
It's still there in latest specs:
http://bcm-v4.sipsolutions.net/802.11/PHY/Init/B5

> +	if (phy->analog == 1)
>  		bcm43xx_radio_write16(bcm, 0x007A,
>  				      bcm43xx_radio_read16(bcm, 0x007A)
>  				      | 0x0050);
> -	}
>  	if ((bcm->board_vendor != PCI_VENDOR_ID_BROADCOM) &&
>  	    (bcm->board_type != 0x0416)) {
> +		value = 0x2120;
>  		for (offset = 0x00A8 ; offset < 0x00C7; offset++) {
> -			bcm43xx_phy_write(bcm, offset,
> -					  (bcm43xx_phy_read(bcm, offset) + 0x2020)
> -					  & 0x3F3F);
> +			bcm43xx_phy_write(bcm, offset, value);
> +			value += 0x0202;
>  		}

I don't see how this matches specs.

>  	}
>  	bcm43xx_phy_write(bcm, 0x0035,
> @@ -776,7 +776,7 @@ static void bcm43xx_phy_initb5(struct bc
>  				  bcm43xx_phy_read(bcm, BCM43xx_PHY_RADIO_BITFIELD) | (1 << 11));
>  	}
>  
> -	if (phy->version == 1 && radio->version == 0x2050) {

Dito.

> +	if (phy->analog == 1) {
>  		bcm43xx_phy_write(bcm, 0x0026, 0xCE00);
>  		bcm43xx_phy_write(bcm, 0x0021, 0x3763);
>  		bcm43xx_phy_write(bcm, 0x0022, 0x1BC3);
> @@ -787,14 +787,15 @@ static void bcm43xx_phy_initb5(struct bc
>  	bcm43xx_phy_write(bcm, 0x0030, 0x00C6);
>  	bcm43xx_write16(bcm, 0x03EC, 0x3F22);
>  
> -	if (phy->version == 1 && radio->version == 0x2050)

Dito.

> +	if (phy->analog == 1)
>  		bcm43xx_phy_write(bcm, 0x0020, 0x3E1C);
>  	else
>  		bcm43xx_phy_write(bcm, 0x0020, 0x301C);
>  
> -	if (phy->version == 0)
> +	if (phy->analog == 0)
>  		bcm43xx_write16(bcm, 0x03E4, 0x3000);
>  
> +	old_channel = radio->channel;
>  	/* Force to channel 7, even if not supported. */
>  	bcm43xx_radio_selectchannel(bcm, 7, 0);
>  
> @@ -816,11 +817,11 @@ static void bcm43xx_phy_initb5(struct bc
>  
>  	bcm43xx_radio_write16(bcm, 0x007A, bcm43xx_radio_read16(bcm, 0x007A) | 0x0007);
>  
> -	bcm43xx_radio_selectchannel(bcm, BCM43xx_RADIO_DEFAULT_CHANNEL_BG, 0);
> +	bcm43xx_radio_selectchannel(bcm, old_channel, 0);
>  
>  	bcm43xx_phy_write(bcm, 0x0014, 0x0080);
>  	bcm43xx_phy_write(bcm, 0x0032, 0x00CA);
> -	bcm43xx_phy_write(bcm, 0x88A3, 0x002A);
> +	bcm43xx_phy_write(bcm, 0x002A, 0x88A3);

Well, this seems correct, but specs are still different. From where did you get this?


Well, I don't review the rest until you say to which specs you did the changes. ;)

-- 
Greetings Michael.


From mcclosk at ucsc.edu  Fri Feb  9 18:23:25 2007
From: mcclosk at ucsc.edu (Jim McCloskey)
Date: Fri, 9 Feb 2007 09:23:25 -0800
Subject: speed test (4318)
Message-ID: <20070209172325.GC25635@ohlone>


With this card:

LinkSys Wireless-G WPC54GS (ver.2))

Chip ID 0x4318, rev 0x2
Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243, disabled
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled

I'm getting these speeds:

----------------------------------------------------------------------
2.6.20 patched with 2.6.20.combined
----------------------------------------------------------------------
 RATE          SPEED

11 Mb/s       621 Kb/s
18 Mb/s       620 Kb/s
24 Mb/s       608 Kb/s
36 Mb/s       534 Kb/s
54 Mb/s       572 Kb/s


----------------------------------------------------------------------
2.6.20 patched with 2.6.20.combined 
and with the `the real fix for bcm4311 and bcm4312' (Feb 7)
----------------------------------------------------------------------
 RATE          SPEED

11 Mb/s       524 Kb/s
18 Mb/s       578 Kb/s
24 Mb/s       616 Kb/s
36 Mb/s       619 Kb/s
54 Mb/s       607 Kb/s


The router is a LinkSys WRT54G(L) (no other cards connecting).

The speed estimates come from wget downloading kernel source, averaged
over 3 tries.

With the earlier patch (the `really good news' patch, Feb 6), the card
continued to work, but it slowed to a crawl.

Hope this is helpful. Thanks for all the good work,

Jim






From josejx at gentoo.org  Fri Feb  9 23:22:42 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 17:22:42 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702091811.40683.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de>
Message-ID: <45CCF432.2070002@gentoo.org>

> Well, I don't review the rest until you say to which specs you did the changes. ;)

http://bcm-specs.sipsolutions.net/B5PHY

Larry was working from the old specs, so when I updated it, I only 
updated the old specs.  I'll fix the v4 specs soon.

-Joe




From mb at bu3sch.de  Fri Feb  9 18:29:50 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 18:29:50 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCF432.2070002@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
Message-ID: <200702091829.51002.mb@bu3sch.de>

On Friday 09 February 2007 23:22, Joseph Jezak wrote:
> > Well, I don't review the rest until you say to which specs you did the changes. ;)
> 
> http://bcm-specs.sipsolutions.net/B5PHY
> 
> Larry was working from the old specs, so when I updated it, I only 
> updated the old specs.  I'll fix the v4 specs soon.

Ah, ok. I think we should decide on which specs carry most recent information.
I think v3 specs should be considered obsolete and new information/ fixes
should go into v4. It is already too confusing where to find newest information
to a certain thing.

-- 
Greetings Michael.


From josejx at gentoo.org  Fri Feb  9 23:24:35 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 17:24:35 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
Message-ID: <45CCF4A3.3080306@gentoo.org>

 >  	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, 
Revision %x\n",

You should change this too, the "Version" text should read "Analog" 
instead.

-Joe


From larry.finger at lwfinger.net  Fri Feb  9 19:11:32 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 12:11:32 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702091811.40683.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de>
Message-ID: <45CCB954.1080400@lwfinger.net>

Michael,

Michael Buesch wrote:
> On Friday 09 February 2007 17:32, Larry Finger wrote:
>> The specifications for the bcm43xx driver have been modified. This patch
>> incorporates these changes in the code, which results in the BCM4311 and
>> BCM4312 working. The name of one of the PHY parameters, previously known
>> as "version", has been changed to "analog core version" .
>>
>> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
>> ---
> 
>> @@ -729,19 +729,19 @@ static void bcm43xx_phy_initb5(struct bc
>>  	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
>>  	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
>>  	u16 offset;
>> +	u16 value;
>> +	u8 old_channel;
>>  
>> -	if (phy->version == 1 &&
>> -	    radio->version == 0x2050) {
> 
> Why do you delete the check to radio version.
> It's still there in latest specs:
> http://bcm-v4.sipsolutions.net/802.11/PHY/Init/B5

As I have no real understanding of the differences between V3 and V4 firmware, I only follow the V3
specs at http://bcm-specs.sipsolutions.net. My usage of the V4 specs is to checking if they can
clean a point of confusion in the V3 spec. The radio version check is eliminated at the beginning of
the phy_initb5 routine in http://bcm-specs.sipsolutions.net/B5PHY. As there are radio version checks
later in the routine, I think it was meant to be removed here.

>> +	if (phy->analog == 1)
>>  		bcm43xx_radio_write16(bcm, 0x007A,
>>  				      bcm43xx_radio_read16(bcm, 0x007A)
>>  				      | 0x0050);
>> -	}
>>  	if ((bcm->board_vendor != PCI_VENDOR_ID_BROADCOM) &&
>>  	    (bcm->board_type != 0x0416)) {
>> +		value = 0x2120;
>>  		for (offset = 0x00A8 ; offset < 0x00C7; offset++) {
>> -			bcm43xx_phy_write(bcm, offset,
>> -					  (bcm43xx_phy_read(bcm, offset) + 0x2020)
>> -					  & 0x3F3F);
>> +			bcm43xx_phy_write(bcm, offset, value);
>> +			value += 0x0202;
>>  		}
> 
> I don't see how this matches specs.

See step 2 of http://bcm-specs.sipsolutions.net/B5PHY.

>>  	}
>>  	bcm43xx_phy_write(bcm, 0x0035,
>> @@ -776,7 +776,7 @@ static void bcm43xx_phy_initb5(struct bc
>>  				  bcm43xx_phy_read(bcm, BCM43xx_PHY_RADIO_BITFIELD) | (1 << 11));
>>  	}
>>  
>> -	if (phy->version == 1 && radio->version == 0x2050) {
> 
> Dito.

Ibid Step 7.

>> +	if (phy->analog == 1) {
>>  		bcm43xx_phy_write(bcm, 0x0026, 0xCE00);
>>  		bcm43xx_phy_write(bcm, 0x0021, 0x3763);
>>  		bcm43xx_phy_write(bcm, 0x0022, 0x1BC3);
>> @@ -787,14 +787,15 @@ static void bcm43xx_phy_initb5(struct bc
>>  	bcm43xx_phy_write(bcm, 0x0030, 0x00C6);
>>  	bcm43xx_write16(bcm, 0x03EC, 0x3F22);
>>  
>> -	if (phy->version == 1 && radio->version == 0x2050)
> 
> Dito.

Step 11.

>> +	if (phy->analog == 1)
>>  		bcm43xx_phy_write(bcm, 0x0020, 0x3E1C);
>>  	else
>>  		bcm43xx_phy_write(bcm, 0x0020, 0x301C);
>>  
>> -	if (phy->version == 0)
>> +	if (phy->analog == 0)
>>  		bcm43xx_write16(bcm, 0x03E4, 0x3000);
>>  
>> +	old_channel = radio->channel;
>>  	/* Force to channel 7, even if not supported. */
>>  	bcm43xx_radio_selectchannel(bcm, 7, 0);
>>  
>> @@ -816,11 +817,11 @@ static void bcm43xx_phy_initb5(struct bc
>>  
>>  	bcm43xx_radio_write16(bcm, 0x007A, bcm43xx_radio_read16(bcm, 0x007A) | 0x0007);
>>  
>> -	bcm43xx_radio_selectchannel(bcm, BCM43xx_RADIO_DEFAULT_CHANNEL_BG, 0);
>> +	bcm43xx_radio_selectchannel(bcm, old_channel, 0);
>>  
>>  	bcm43xx_phy_write(bcm, 0x0014, 0x0080);
>>  	bcm43xx_phy_write(bcm, 0x0032, 0x00CA);
>> -	bcm43xx_phy_write(bcm, 0x88A3, 0x002A);
>> +	bcm43xx_phy_write(bcm, 0x002A, 0x88A3);
> 
> Well, this seems correct, but specs are still different. From where did you get this?

Steps 14 - 26 of http://bcm-specs.sipsolutions.net/B5PHY
> 
> 
> Well, I don't review the rest until you say to which specs you did the changes. ;)

As I said earlier, everything came from http://bcm-specs.sipsolutions.net.

Larry



From larry.finger at lwfinger.net  Fri Feb  9 19:21:07 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 12:21:07 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702091829.51002.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de>
Message-ID: <45CCBB93.2040703@lwfinger.net>

Michael Buesch wrote:
> On Friday 09 February 2007 23:22, Joseph Jezak wrote:
>>> Well, I don't review the rest until you say to which specs you did the changes. ;)
>> http://bcm-specs.sipsolutions.net/B5PHY
>>
>> Larry was working from the old specs, so when I updated it, I only 
>> updated the old specs.  I'll fix the v4 specs soon.
> 
> Ah, ok. I think we should decide on which specs carry most recent information.
> I think v3 specs should be considered obsolete and new information/ fixes
> should go into v4. It is already too confusing where to find newest information
> to a certain thing.
> 

I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.

Larry



From larry.finger at lwfinger.net  Fri Feb  9 19:29:14 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 12:29:14 -0600
Subject: speed test (4318)
In-Reply-To: <20070209172325.GC25635@ohlone>
References: <20070209172325.GC25635@ohlone>
Message-ID: <45CCBD7A.4020606@lwfinger.net>

Jim McCloskey wrote:
> With this card:
> 
> LinkSys Wireless-G WPC54GS (ver.2))
> 
> Chip ID 0x4318, rev 0x2
> Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
> bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243, disabled
> bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
> bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
> 
> I'm getting these speeds:
> 
> ----------------------------------------------------------------------
> 2.6.20 patched with 2.6.20.combined
> ----------------------------------------------------------------------
>  RATE          SPEED
> 
> 11 Mb/s       621 Kb/s
> 18 Mb/s       620 Kb/s
> 24 Mb/s       608 Kb/s
> 36 Mb/s       534 Kb/s
> 54 Mb/s       572 Kb/s
> 
> 
> ----------------------------------------------------------------------
> 2.6.20 patched with 2.6.20.combined 
> and with the `the real fix for bcm4311 and bcm4312' (Feb 7)
> ----------------------------------------------------------------------
>  RATE          SPEED
> 
> 11 Mb/s       524 Kb/s
> 18 Mb/s       578 Kb/s
> 24 Mb/s       616 Kb/s
> 36 Mb/s       619 Kb/s
> 54 Mb/s       607 Kb/s
> 
> 
> The router is a LinkSys WRT54G(L) (no other cards connecting).
> 
> The speed estimates come from wget downloading kernel source, averaged
> over 3 tries.
> 
> With the earlier patch (the `really good news' patch, Feb 6), the card
> continued to work, but it slowed to a crawl.
> 
> Hope this is helpful. Thanks for all the good work,

You are very welcome. I'm just happy to finally start to crack these problems after so long.

Just as a point of reference, I think wget yields KBs (kilo-bytes/sec). My iperf numbers are in Kbs
(kilo-bits/sec).

Larry


From mb at bu3sch.de  Fri Feb  9 19:45:24 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 19:45:24 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
Message-ID: <200702091945.25187.mb@bu3sch.de>

On Friday 09 February 2007 17:32, Larry Finger wrote:
> The specifications for the bcm43xx driver have been modified. This patch
> incorporates these changes in the code, which results in the BCM4311 and
> BCM4312 working. The name of one of the PHY parameters, previously known
> as "version", has been changed to "analog core version" .
> 
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>

>  	if ((bcm->board_vendor != PCI_VENDOR_ID_BROADCOM) &&
>  	    (bcm->board_type != 0x0416)) {
> +		value = 0x2120;
>  		for (offset = 0x00A8 ; offset < 0x00C7; offset++) {
> -			bcm43xx_phy_write(bcm, offset,
> -					  (bcm43xx_phy_read(bcm, offset) + 0x2020)
> -					  & 0x3F3F);
> +			bcm43xx_phy_write(bcm, offset, value);

The specs are unclear at this point:
"Write the value to the offset"
Offset in which register type?

> @@ -933,6 +934,8 @@ static void bcm43xx_phy_initb6(struct bc
>  		                  bcm43xx_phy_read(bcm, 0x0802) | 0x0100);
>  		bcm43xx_phy_write(bcm, 0x042B,
>  		                  bcm43xx_phy_read(bcm, 0x042B) | 0x2000);
> +		bcm43xx_phy_write(bcm, 0x5B, 0x0000);
> +		bcm43xx_phy_write(bcm, 0x5C, 0x0000);
>  	}
>  
>  	/* Force to channel 7, even if not supported. */

Backup and reset old_channel later here, too.
Also, look at this:

# If the current channel is 8 or greater
   1. Set the channel to 1 
# Otherwise
   1. Set the channel to 13

> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
> @@ -1393,11 +1393,12 @@ u16 bcm43xx_radio_init2050(struct bcm43x
>  	backup[12] = bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT);
>  
>  	// Initialization
> -	if (phy->version == 0) {
> +	if (phy->analog == 0) {
>  		bcm43xx_write16(bcm, 0x03E6, 0x0122);
>  	} else {
> -		if (phy->version >= 2)
> -			bcm43xx_write16(bcm, 0x03E6, 0x0040);
> +		if (phy->analog >= 2)
> +			bcm43xx_write16(bcm, 0x0003, (bcm43xx_read16(bcm, 0x0003)
> +					& 0xFFBF) | 0x0040);

I think here is a specs bug.

>  		bcm43xx_write16(bcm, BCM43xx_MMIO_CHANNEL_EXT,
>  		                (bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT) | 0x2000));
>  	}

-- 
Greetings Michael.


From mcclosk at ucsc.edu  Fri Feb  9 19:48:58 2007
From: mcclosk at ucsc.edu (Jim McCloskey)
Date: Fri, 9 Feb 2007 10:48:58 -0800
Subject: speed test (4318)
In-Reply-To: <45CCBD7A.4020606@lwfinger.net>
References: <20070209172325.GC25635@ohlone> <45CCBD7A.4020606@lwfinger.net>
Message-ID: <20070209184858.GE25635@ohlone>

* Larry Finger (larry.finger at lwfinger.net) wrote:

  |>  Just as a point of reference, I think wget yields KBs
  |>  (kilo-bytes/sec). My iperf numbers are in Kbs (kilo-bits/sec).

You're absolutely right. It should have been KBs throughout. Sorry,

Jim



From mb at bu3sch.de  Fri Feb  9 19:48:12 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 19:48:12 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCBB93.2040703@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091829.51002.mb@bu3sch.de> <45CCBB93.2040703@lwfinger.net>
Message-ID: <200702091948.13296.mb@bu3sch.de>

On Friday 09 February 2007 19:21, Larry Finger wrote:
> Michael Buesch wrote:
> > On Friday 09 February 2007 23:22, Joseph Jezak wrote:
> >>> Well, I don't review the rest until you say to which specs you did the changes. ;)
> >> http://bcm-specs.sipsolutions.net/B5PHY
> >>
> >> Larry was working from the old specs, so when I updated it, I only 
> >> updated the old specs.  I'll fix the v4 specs soon.
> > 
> > Ah, ok. I think we should decide on which specs carry most recent information.
> > I think v3 specs should be considered obsolete and new information/ fixes
> > should go into v4. It is already too confusing where to find newest information
> > to a certain thing.
> > 
> 
> I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.

Well, the difference between v3 and v4 is:
* The SHM API.
* v4 may include less BPHY stuff, as broadcom's v4 drivers don't include BHY anymore.

So I'd say for everything bug BPHY the v4 specs should be considered latest.

-- 
Greetings Michael.


From josejx at gentoo.org  Fri Feb  9 20:05:03 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 14:05:03 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCBB93.2040703@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de> <45CCBB93.2040703@lwfinger.net>
Message-ID: <45CCC5DF.8010001@gentoo.org>

> I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.

That's also part of the problem.  With the v4 driver, Broadcom 
dropped support for a number of older BPHY devices (4301/4303 and 
some 4306 revisions).  Do we still want to support those?  Should I 
continue writing the specs for the uCode revision it's based on or 
should I combine them?

-Joe


From josejx at gentoo.org  Fri Feb  9 20:17:09 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 14:17:09 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702091945.25187.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091945.25187.mb@bu3sch.de>
Message-ID: <45CCC8B5.3060108@gentoo.org>

> 
> The specs are unclear at this point:
> "Write the value to the offset"
> Offset in which register type?

PHY Register.  I've clarified it in the specs, I think this was said 
before, I made it worse when I cleaned it up.

>>  	// Initialization
>> -	if (phy->version == 0) {
>> +	if (phy->analog == 0) {
>>  		bcm43xx_write16(bcm, 0x03E6, 0x0122);
>>  	} else {
>> -		if (phy->version >= 2)
>> -			bcm43xx_write16(bcm, 0x03E6, 0x0040);
>> +		if (phy->analog >= 2)
>> +			bcm43xx_write16(bcm, 0x0003, (bcm43xx_read16(bcm, 0x0003)
>> +					& 0xFFBF) | 0x0040);
> 
> I think here is a specs bug.

This is correct.  Why do you think it's a specs bug?

-Joe


From mb at bu3sch.de  Fri Feb  9 20:17:36 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 20:17:36 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCC5DF.8010001@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
Message-ID: <200702092017.36950.mb@bu3sch.de>

On Friday 09 February 2007 20:05, Joseph Jezak wrote:
> > I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.
> 
> That's also part of the problem.  With the v4 driver, Broadcom 
> dropped support for a number of older BPHY devices (4301/4303 and 
> some 4306 revisions).  Do we still want to support those?  Should I 
> continue writing the specs for the uCode revision it's based on or 
> should I combine them?

If it's easily possible, please try to combine the old stuff
with the new v4 specs.
I think it's basically only dropped if() branches, right?

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Feb  9 20:26:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 09 Feb 2007 13:26:25 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCC5DF.8010001@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
Message-ID: <45CCCAE1.9080901@lwfinger.net>

Joe,

Joseph Jezak wrote:

> That's also part of the problem.  With the v4 driver, Broadcom dropped
> support for a number of older BPHY devices (4301/4303 and some 4306
> revisions).  Do we still want to support those?  Should I continue
> writing the specs for the uCode revision it's based on or should I
> combine them?

As my 4306 is a rev 1 and is likely a version dropped in the V4 driver, I have a special interest in
this question.

My plan is to continue to maintain bcm43xx-SoftMAC for at least the BPHY and 4306 revisions even
after d80211 becomes the in-kernel driver. Of course, I hope that we will have found the killer bugs
by that time, and that maintenance will only require following kernel API changes.

As the work will be yours, you should decide if you would rather maintain the V3 and V4 pages
separately, or denote the special requirements of each firmware flavor in a combined set of pages.

Larry


From mb at bu3sch.de  Fri Feb  9 20:26:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 20:26:42 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCC8B5.3060108@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091945.25187.mb@bu3sch.de> <45CCC8B5.3060108@gentoo.org>
Message-ID: <200702092026.43006.mb@bu3sch.de>

On Friday 09 February 2007 20:17, Joseph Jezak wrote:
> > 
> > The specs are unclear at this point:
> > "Write the value to the offset"
> > Offset in which register type?
> 
> PHY Register.  I've clarified it in the specs, I think this was said 
> before, I made it worse when I cleaned it up.
> 
> >>  	// Initialization
> >> -	if (phy->version == 0) {
> >> +	if (phy->analog == 0) {
> >>  		bcm43xx_write16(bcm, 0x03E6, 0x0122);
> >>  	} else {
> >> -		if (phy->version >= 2)
> >> -			bcm43xx_write16(bcm, 0x03E6, 0x0040);
> >> +		if (phy->analog >= 2)
> >> +			bcm43xx_write16(bcm, 0x0003, (bcm43xx_read16(bcm, 0x0003)
> >> +					& 0xFFBF) | 0x0040);
> > 
> > I think here is a specs bug.
> 
> This is correct.  Why do you think it's a specs bug?

Because
a) The old one made more sense to me.
b) Write MMIO register 0x3? I mean. What is that?
   Could this be PHY or radio register 0x3?

-- 
Greetings Michael.


From josejx at gentoo.org  Fri Feb  9 20:55:29 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 14:55:29 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702092017.36950.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>	<45CCBB93.2040703@lwfinger.net>
	<45CCC5DF.8010001@gentoo.org> <200702092017.36950.mb@bu3sch.de>
Message-ID: <45CCD1B1.80709@gentoo.org>

Michael Buesch wrote:
> On Friday 09 February 2007 20:05, Joseph Jezak wrote:
>>> I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.
>> That's also part of the problem.  With the v4 driver, Broadcom 
>> dropped support for a number of older BPHY devices (4301/4303 and 
>> some 4306 revisions).  Do we still want to support those?  Should I 
>> continue writing the specs for the uCode revision it's based on or 
>> should I combine them?
> 
> If it's easily possible, please try to combine the old stuff
> with the new v4 specs.
> I think it's basically only dropped if() branches, right?
> 

Well, here's the problem.  There are a few places where a value is 
changed (different value written to a register).  Does this mean 
that the value is different due to the uCode changes (can't tell, no 
documentation)?  Is it applicable to all revisions (can't tell, some 
revisions are not supported in this version)?  If the revision 
number range in a check changes is that because of a difference in 
supported cards or a bug fix?

So, it's not as simple as just dropped if() branches.  I can do my 
best to combine them (I have done some of this already), but I can't 
promise that it'll be accurate for all revisions or versions of the 
chipset.

-Joe


From josejx at gentoo.org  Fri Feb  9 20:58:56 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Fri, 09 Feb 2007 14:58:56 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702092026.43006.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091945.25187.mb@bu3sch.de> <45CCC8B5.3060108@gentoo.org>
	<200702092026.43006.mb@bu3sch.de>
Message-ID: <45CCD280.9070501@gentoo.org>

>> This is correct.  Why do you think it's a specs bug?
> 
> Because
> a) The old one made more sense to me.
> b) Write MMIO register 0x3? I mean. What is that?
>    Could this be PHY or radio register 0x3?
> 

Apologies.  You are correct that this should be PHY Register 0x3, 
not MMIO offset 0x3.  I've corrected this in the specs.

-Joe


From mb at bu3sch.de  Fri Feb  9 21:30:38 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 9 Feb 2007 21:30:38 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCD1B1.80709@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702092017.36950.mb@bu3sch.de> <45CCD1B1.80709@gentoo.org>
Message-ID: <200702092130.38997.mb@bu3sch.de>

On Friday 09 February 2007 20:55, Joseph Jezak wrote:
> Michael Buesch wrote:
> > On Friday 09 February 2007 20:05, Joseph Jezak wrote:
> >>> I'll agree to that as long as there is a clear indication of any differences between V3 and V4 firmware.
> >> That's also part of the problem.  With the v4 driver, Broadcom 
> >> dropped support for a number of older BPHY devices (4301/4303 and 
> >> some 4306 revisions).  Do we still want to support those?  Should I 
> >> continue writing the specs for the uCode revision it's based on or 
> >> should I combine them?
> > 
> > If it's easily possible, please try to combine the old stuff
> > with the new v4 specs.
> > I think it's basically only dropped if() branches, right?
> > 
> 
> Well, here's the problem.  There are a few places where a value is 
> changed (different value written to a register).  Does this mean 
> that the value is different due to the uCode changes (can't tell, no 
> documentation)?  Is it applicable to all revisions (can't tell, some 
> revisions are not supported in this version)?  If the revision 
> number range in a check changes is that because of a difference in 
> supported cards or a bug fix?
> 
> So, it's not as simple as just dropped if() branches.  I can do my 
> best to combine them (I have done some of this already), but I can't 
> promise that it'll be accurate for all revisions or versions of the 
> chipset.

Ok, I see.
How many of these old devices exist and who has access to them?
If we want to combine stuff, we really must test it on these devices then.

-- 
Greetings Michael.


From mjg59 at srcf.ucam.org  Fri Feb  9 22:32:39 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 9 Feb 2007 21:32:39 +0000
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCCAE1.9080901@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
	<45CCCAE1.9080901@lwfinger.net>
Message-ID: <20070209213239.GA11650@srcf.ucam.org>

On Fri, Feb 09, 2007 at 01:26:25PM -0600, Larry Finger wrote:

> My plan is to continue to maintain bcm43xx-SoftMAC for at least the BPHY and 4306 revisions even
> after d80211 becomes the in-kernel driver. Of course, I hope that we will have found the killer bugs
> by that time, and that maintenance will only require following kernel API changes.

Just to make sure I'm understanding this correctly - does the v4 
firmware drop compatibility for older cards, or is it just that Broadcom 
dropped support in the driver at the same time as the firmware changed, 
and the new firmware will still also drive the old cards?

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From martin-langer at gmx.de  Fri Feb  9 23:52:34 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Fri, 9 Feb 2007 23:52:34 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <20070209213239.GA11650@srcf.ucam.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
	<45CCCAE1.9080901@lwfinger.net>
	<20070209213239.GA11650@srcf.ucam.org>
Message-ID: <20070209225234.GA3381@tuba>

On Fri, Feb 09, 2007 at 09:32:39PM +0000, Matthew Garrett wrote:
> On Fri, Feb 09, 2007 at 01:26:25PM -0600, Larry Finger wrote:
> 
> > My plan is to continue to maintain bcm43xx-SoftMAC for at least the BPHY and 4306 revisions even
> > after d80211 becomes the in-kernel driver. Of course, I hope that we will have found the killer bugs
> > by that time, and that maintenance will only require following kernel API changes.
> 
> Just to make sure I'm understanding this correctly - does the v4 
> firmware drop compatibility for older cards, or is it just that Broadcom 
> dropped support in the driver at the same time as the firmware changed, 
> and the new firmware will still also drive the old cards?

We can't extract bcm43xx_microcode2.fw from v4 drivers. You need this 
file for old rev2+3 0x812 cores. So we don't know what firmware we 
should load into those old cores. I think broadcom never developed a new 
v4 style firmware for their old hardware.

Martin




From mb at bu3sch.de  Sat Feb 10 06:55:50 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 Feb 2007 06:55:50 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <20070209213239.GA11650@srcf.ucam.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCCAE1.9080901@lwfinger.net>
	<20070209213239.GA11650@srcf.ucam.org>
Message-ID: <200702100655.51495.mb@bu3sch.de>

On Friday 09 February 2007 22:32, Matthew Garrett wrote:
> On Fri, Feb 09, 2007 at 01:26:25PM -0600, Larry Finger wrote:
> 
> > My plan is to continue to maintain bcm43xx-SoftMAC for at least the BPHY and 4306 revisions even
> > after d80211 becomes the in-kernel driver. Of course, I hope that we will have found the killer bugs
> > by that time, and that maintenance will only require following kernel API changes.
> 
> Just to make sure I'm understanding this correctly - does the v4 
> firmware drop compatibility for older cards, or is it just that Broadcom 
> dropped support in the driver at the same time as the firmware changed, 
> and the new firmware will still also drive the old cards?

We don't know.

It's likely that old cards still work with v4 firmware, but we don't know and
it has to be tested.

Care to do so?


From mjg59 at srcf.ucam.org  Sat Feb 10 13:57:07 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 10 Feb 2007 12:57:07 +0000
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702100655.51495.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCCAE1.9080901@lwfinger.net>
	<20070209213239.GA11650@srcf.ucam.org>
	<200702100655.51495.mb@bu3sch.de>
Message-ID: <20070210125707.GA21803@srcf.ucam.org>

On Sat, Feb 10, 2007 at 06:55:50AM +0100, Michael Buesch wrote:

> We don't know.
> 
> It's likely that old cards still work with v4 firmware, but we don't know and
> it has to be tested.
> 
> Care to do so?

I'll check the revision of my 4306, but I think it's probably too new to 
be useful, unfortunately...

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mjg59 at srcf.ucam.org  Sat Feb 10 17:27:27 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 10 Feb 2007 16:27:27 +0000
Subject: Assertion failed in parse_cookie() (d80211 tree)
Message-ID: <20070210162726.GA23786@srcf.ucam.org>

I'm testing the latest dscape code (from Michael's tree) on a bcm4311. 
Performance is much better than before. The only problem I've seen so 
far is the following in the kernel logs:

[  743.064000] bcm43xx_d80211: ASSERTION FAILED (0) at: 
ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
[  743.064000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && 
*slot < ring->nr_slots) at: 
ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()

which is associated with a brief networking dropout. The AP is a Linksys 
WRT54GS running the latest openwrt rc and using the closed broadcom 
driver. I've got three sets of these messages at 120 second intervals, 
and then another after 240 seconds, which makes me think it's linked to 
some sort of periodic event. Any further debug info I can provide?

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Sat Feb 10 18:00:59 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 Feb 2007 18:00:59 +0100
Subject: Assertion failed in parse_cookie() (d80211 tree)
In-Reply-To: <20070210162726.GA23786@srcf.ucam.org>
References: <20070210162726.GA23786@srcf.ucam.org>
Message-ID: <200702101800.59402.mb@bu3sch.de>

On Saturday 10 February 2007 17:27, Matthew Garrett wrote:
> I'm testing the latest dscape code (from Michael's tree) on a bcm4311. 
> Performance is much better than before. The only problem I've seen so 
> far is the following in the kernel logs:
> 
> [  743.064000] bcm43xx_d80211: ASSERTION FAILED (0) at: 
> ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
> [  743.064000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && 
> *slot < ring->nr_slots) at: 
> ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()
> 
> which is associated with a brief networking dropout. The AP is a Linksys 
> WRT54GS running the latest openwrt rc and using the closed broadcom 
> driver. I've got three sets of these messages at 120 second intervals, 
> and then another after 240 seconds, which makes me think it's linked to 
> some sort of periodic event. Any further debug info I can provide?

Strange. THat shouldn't happen.
Can you post complete dmesg?

-- 
Greetings Michael.


From rjw at sisk.pl  Sat Feb 10 18:11:36 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sat, 10 Feb 2007 18:11:36 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702091753.12419.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702091753.12419.mb@bu3sch.de>
Message-ID: <200702101811.37355.rjw@sisk.pl>

On Friday, 9 February 2007 17:53, Michael Buesch wrote:
> On Friday 09 February 2007 17:18, Larry Finger wrote:
> > After a suspend/resume cycle, bcm43xx-softmac has lost its association with
> > the AP and requires manual intervention. This situation is fixed by making
> > one of softmac's internal routines public and calling it.
> > 
> > Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> 
> Ack, this is good as workaround.

I'm running with this patch applied right now, but the association is lost
after the resume anyway.  I have to reload bcm43xx to make it associate with
the AP again (no big deal).

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From mjg59 at srcf.ucam.org  Sat Feb 10 18:25:19 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 10 Feb 2007 17:25:19 +0000
Subject: Assertion failed in parse_cookie() (d80211 tree)
In-Reply-To: <200702101800.59402.mb@bu3sch.de>
References: <20070210162726.GA23786@srcf.ucam.org>
	<200702101800.59402.mb@bu3sch.de>
Message-ID: <20070210172518.GA24647@srcf.ucam.org>

On Sat, Feb 10, 2007 at 06:00:59PM +0100, Michael Buesch wrote:

> Strange. THat shouldn't happen.
> Can you post complete dmesg?

Attached.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org
-------------- next part --------------
Feb 10 16:06:02 vaio kernel: [    0.000000] Linux version 2.6.20-7-generic (root at drosophila) (gcc version 4.1.2 20070106 (prerelease) (Ubuntu 4.1.1-21ubuntu7)) #3 SMP Sat Feb 10 14:26:43 UTC 2007 (Ubuntu Unofficial)
Feb 10 16:06:02 vaio kernel: [    0.000000] BIOS-provided physical RAM map:
Feb 10 16:06:02 vaio kernel: [    0.000000] sanitize start
Feb 10 16:06:02 vaio kernel: [    0.000000] sanitize end
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 0000000000000000 size: 000000000009f800 end: 000000000009f800 type: 1
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() type is E820_RAM
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 000000000009f800 size: 0000000000000800 end: 00000000000a0000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000000dc000 size: 0000000000024000 end: 0000000000100000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 0000000000100000 size: 000000001f580000 end: 000000001f680000 type: 1
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() type is E820_RAM
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 000000001f680000 size: 0000000000013000 end: 000000001f693000 type: 3
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 000000001f693000 size: 000000000006d000 end: 000000001f700000 type: 4
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 000000001f700000 size: 0000000000900000 end: 0000000020000000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000e0000000 size: 0000000010000000 end: 00000000f0000000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000fec00000 size: 0000000000010000 end: 00000000fec10000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000fed14000 size: 0000000000006000 end: 00000000fed1a000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000fed1c000 size: 0000000000074000 end: 00000000fed90000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000fee00000 size: 0000000000001000 end: 00000000fee01000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000] copy_e820_map() start: 00000000ff000000 size: 0000000001000000 end: 0000000100000000 type: 2
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 0000000000000000 - 000000000009f800 (usable)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 000000000009f800 - 00000000000a0000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000000dc000 - 0000000000100000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 0000000000100000 - 000000001f680000 (usable)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 000000001f680000 - 000000001f693000 (ACPI data)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 000000001f693000 - 000000001f700000 (ACPI NVS)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 000000001f700000 - 0000000020000000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000e0000000 - 00000000f0000000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000fec00000 - 00000000fec10000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000fed14000 - 00000000fed1a000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000fed1c000 - 00000000fed90000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000fee00000 - 00000000fee01000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000]  BIOS-e820: 00000000ff000000 - 0000000100000000 (reserved)
Feb 10 16:06:02 vaio kernel: [    0.000000] 0MB HIGHMEM available.
Feb 10 16:06:02 vaio kernel: [    0.000000] 502MB LOWMEM available.
Feb 10 16:06:02 vaio kernel: [    0.000000] found SMP MP-table at 000f6490
Feb 10 16:06:02 vaio kernel: [    0.000000] Entering add_active_range(0, 0, 128640) 0 entries of 256 used
Feb 10 16:06:02 vaio kernel: [    0.000000] Zone PFN ranges:
Feb 10 16:06:02 vaio kernel: [    0.000000]   DMA             0 ->     4096
Feb 10 16:06:02 vaio kernel: [    0.000000]   Normal       4096 ->   128640
Feb 10 16:06:02 vaio kernel: [    0.000000]   HighMem    128640 ->   128640
Feb 10 16:06:02 vaio kernel: [    0.000000] early_node_map[1] active PFN ranges
Feb 10 16:06:02 vaio kernel: [    0.000000]     0:        0 ->   128640
Feb 10 16:06:02 vaio kernel: [    0.000000] On node 0 totalpages: 128640
Feb 10 16:06:02 vaio kernel: [    0.000000]   DMA zone: 32 pages used for memmap
Feb 10 16:06:02 vaio kernel: [    0.000000]   DMA zone: 0 pages reserved
Feb 10 16:06:02 vaio kernel: [    0.000000]   DMA zone: 4064 pages, LIFO batch:0
Feb 10 16:06:02 vaio kernel: [    0.000000]   Normal zone: 973 pages used for memmap
Feb 10 16:06:02 vaio kernel: [    0.000000]   Normal zone: 123571 pages, LIFO batch:31
Feb 10 16:06:02 vaio kernel: [    0.000000]   HighMem zone: 0 pages used for memmap
Feb 10 16:06:02 vaio kernel: [    0.000000] DMI present.
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: RSDP (v000 PTLTD                                 ) @ 0x000f63c0
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: RSDT (v001   Sony       N0 0x20060224 PTL  0x00000000) @ 0x1f68b529
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: FADT (v002   Sony       N0 0x20060224 PTL  0x0000005a) @ 0x1f692dde
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: MADT (v001   Sony       N0 0x20060224 PTL  0x0000005a) @ 0x1f692e62
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: BOOT (v001   Sony       N0 0x20060224 PTL  0x00000001) @ 0x1f692fd8
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: MCFG (v001   Sony       N0 0x20060224 PTL  0x0000005a) @ 0x1f692f02
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: MADT (v001   Sony       N0 0x20060224 PTL  0x00000000) @ 0x1f692f70
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: SSDT (v001   Sony       N0 0x20060224 PTL  0x20050624) @ 0x1f68c6fb
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: SSDT (v001   Sony       N0 0x20060224 PTL  0x20050624) @ 0x1f68bf30
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: SSDT (v001   Sony       N0 0x20060224 PTL  0x20050624) @ 0x1f68b56d
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: DSDT (v001   Sony       N0 0x20060224 PTL  0x0100000e) @ 0x00000000
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: PM-Timer IO Port: 0x1008
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: Local APIC address 0xfee00000
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: 2 duplicate APIC table ignored.
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: LAPIC (acpi_id[0x00] lapic_id[0x00] enabled)
Feb 10 16:06:02 vaio kernel: [    0.000000] Processor #0 6:14 APIC version 20
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: LAPIC (acpi_id[0x01] lapic_id[0x01] enabled)
Feb 10 16:06:02 vaio kernel: [    0.000000] Processor #1 6:14 APIC version 20
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: LAPIC_NMI (acpi_id[0x00] high edge lint[0x1])
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: LAPIC_NMI (acpi_id[0x01] high edge lint[0x1])
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: IOAPIC (id[0x01] address[0xfec00000] gsi_base[0])
Feb 10 16:06:02 vaio kernel: [    0.000000] IOAPIC[0]: apic_id 1, version 32, address 0xfec00000, GSI 0-23
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 0 global_irq 2 dfl dfl)
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 9 high level)
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: IRQ0 used by override.
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: IRQ2 used by override.
Feb 10 16:06:02 vaio kernel: [    0.000000] ACPI: IRQ9 used by override.
Feb 10 16:06:02 vaio kernel: [    0.000000] Enabling APIC mode:  Flat.  Using 1 I/O APICs
Feb 10 16:06:02 vaio kernel: [    0.000000] Using ACPI (MADT) for SMP configuration information
Feb 10 16:06:02 vaio kernel: [    0.000000] Allocating PCI resources starting at 30000000 (gap: 20000000:c0000000)
Feb 10 16:06:02 vaio kernel: [    0.000000] Detected 1666.925 MHz processor.
Feb 10 16:06:02 vaio kernel: [   16.087685] Built 1 zonelists.  Total pages: 127635
Feb 10 16:06:02 vaio kernel: [   16.087689] Kernel command line: root=UUID=6c320b9a-5afb-4364-8cf2-5529a338355d ro quiet splash
Feb 10 16:06:02 vaio kernel: [   16.087851] mapped APIC to ffffd000 (fee00000)
Feb 10 16:06:02 vaio kernel: [   16.087853] mapped IOAPIC to ffffc000 (fec00000)
Feb 10 16:06:02 vaio kernel: [   16.087856] Enabling fast FPU save and restore... done.
Feb 10 16:06:02 vaio kernel: [   16.087859] Enabling unmasked SIMD FPU exception support... done.
Feb 10 16:06:02 vaio kernel: [   16.087867] Initializing CPU#0
Feb 10 16:06:02 vaio kernel: [   16.087940] PID hash table entries: 2048 (order: 11, 8192 bytes)
Feb 10 16:06:02 vaio kernel: [   16.089633] Console: colour VGA+ 80x25
Feb 10 16:06:02 vaio kernel: [   16.089786] Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)
Feb 10 16:06:02 vaio kernel: [   16.089972] Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)
Feb 10 16:06:02 vaio kernel: [   16.100891] Memory: 466268k/514560k available (1979k kernel code, 47652k reserved, 882k data, 324k init, 0k highmem)
Feb 10 16:06:02 vaio kernel: [   16.100901] virtual kernel memory layout:
Feb 10 16:06:02 vaio kernel: [   16.100902]     fixmap  : 0xfff4e000 - 0xfffff000   ( 708 kB)
Feb 10 16:06:02 vaio kernel: [   16.100904]     pkmap   : 0xff800000 - 0xffc00000   (4096 kB)
Feb 10 16:06:02 vaio kernel: [   16.100905]     vmalloc : 0xe0000000 - 0xff7fe000   ( 503 MB)
Feb 10 16:06:02 vaio kernel: [   16.100906]     lowmem  : 0xc0000000 - 0xdf680000   ( 502 MB)
Feb 10 16:06:02 vaio kernel: [   16.100908]       .init : 0xc03d1000 - 0xc0422000   ( 324 kB)
Feb 10 16:06:02 vaio kernel: [   16.100909]       .data : 0xc02eec04 - 0xc03cb6d4   ( 882 kB)
Feb 10 16:06:02 vaio kernel: [   16.100910]       .text : 0xc0100000 - 0xc02eec04   (1979 kB)
Feb 10 16:06:02 vaio kernel: [   16.100914] Checking if this processor honours the WP bit even in supervisor mode... Ok.
Feb 10 16:06:02 vaio kernel: [   16.179901] Calibrating delay using timer specific routine.. 3337.64 BogoMIPS (lpj=6675288)
Feb 10 16:06:02 vaio kernel: [   16.179939] Security Framework v1.0.0 initialized
Feb 10 16:06:02 vaio kernel: [   16.179946] SELinux:  Disabled at boot.
Feb 10 16:06:02 vaio kernel: [   16.179963] Mount-cache hash table entries: 512
Feb 10 16:06:02 vaio kernel: [   16.180086] CPU: After generic identify, caps: bfe9fbff 00100000 00000000 00000000 0000c1a9 00000000 00000000
Feb 10 16:06:02 vaio kernel: [   16.180094] monitor/mwait feature present.
Feb 10 16:06:02 vaio kernel: [   16.180096] using mwait in idle threads.
Feb 10 16:06:02 vaio kernel: [   16.180100] CPU: L1 I cache: 32K, L1 D cache: 32K
Feb 10 16:06:02 vaio kernel: [   16.180103] CPU: L2 cache: 2048K
Feb 10 16:06:02 vaio kernel: [   16.180106] CPU: Physical Processor ID: 0
Feb 10 16:06:02 vaio kernel: [   16.180108] CPU: Processor Core ID: 0
Feb 10 16:06:02 vaio kernel: [   16.180110] CPU: After all inits, caps: bfe9fbff 00100000 00000000 00002940 0000c1a9 00000000 00000000
Feb 10 16:06:02 vaio kernel: [   16.180128] Checking 'hlt' instruction... OK.
Feb 10 16:06:02 vaio kernel: [   16.195992] SMP alternatives: switching to UP code
Feb 10 16:06:02 vaio kernel: [   16.196237] ACPI: Core revision 20060707
Feb 10 16:06:02 vaio kernel: [   16.234900] CPU0: Intel Genuine Intel(R) CPU           T2300  @ 1.66GHz stepping 08
Feb 10 16:06:02 vaio kernel: [   16.234920] SMP alternatives: switching to SMP code
Feb 10 16:06:02 vaio kernel: [   16.234947] Booting processor 1/1 eip 3000
Feb 10 16:06:02 vaio kernel: [   16.245359] Initializing CPU#1
Feb 10 16:06:02 vaio kernel: [   16.323823] Calibrating delay using timer specific routine.. 3333.82 BogoMIPS (lpj=6667659)
Feb 10 16:06:02 vaio kernel: [   16.323831] CPU: After generic identify, caps: bfe9fbff 00100000 00000000 00000000 0000c1a9 00000000 00000000
Feb 10 16:06:02 vaio kernel: [   16.323836] monitor/mwait feature present.
Feb 10 16:06:02 vaio kernel: [   16.323840] CPU: L1 I cache: 32K, L1 D cache: 32K
Feb 10 16:06:02 vaio kernel: [   16.323842] CPU: L2 cache: 2048K
Feb 10 16:06:02 vaio kernel: [   16.323844] CPU: Physical Processor ID: 0
Feb 10 16:06:02 vaio kernel: [   16.323846] CPU: Processor Core ID: 1
Feb 10 16:06:02 vaio kernel: [   16.323848] CPU: After all inits, caps: bfe9fbff 00100000 00000000 00002940 0000c1a9 00000000 00000000
Feb 10 16:06:02 vaio kernel: [   16.324337] CPU1: Intel Genuine Intel(R) CPU           T2300  @ 1.66GHz stepping 08
Feb 10 16:06:02 vaio kernel: [   16.324361] Total of 2 processors activated (6671.47 BogoMIPS).
Feb 10 16:06:02 vaio kernel: [   16.324564] ENABLING IO-APIC IRQs
Feb 10 16:06:02 vaio kernel: [   16.324773] ..TIMER: vector=0x31 apic1=0 pin1=2 apic2=-1 pin2=-1
Feb 10 16:06:02 vaio kernel: [   16.603688] checking TSC synchronization across 2 CPUs: passed.
Feb 10 16:06:02 vaio kernel: [    0.004000] Brought up 2 CPUs
Feb 10 16:06:02 vaio kernel: [    0.155010] migration_cost=78
Feb 10 16:06:02 vaio kernel: [    0.155301] Booting paravirtualized kernel on bare hardware
Feb 10 16:06:02 vaio kernel: [    0.155403] Time: 16:05:38  Date: 01/10/107
Feb 10 16:06:02 vaio kernel: [    0.155433] NET: Registered protocol family 16
Feb 10 16:06:02 vaio kernel: [    0.155522] EISA bus registered
Feb 10 16:06:02 vaio kernel: [    0.155526] ACPI: bus type pci registered
Feb 10 16:06:02 vaio kernel: [    0.155537] PCI: Using MMCONFIG
Feb 10 16:06:02 vaio kernel: [    0.156326] Setting up standard PCI resources
Feb 10 16:06:02 vaio kernel: [    0.162371] ACPI: Interpreter enabled
Feb 10 16:06:02 vaio kernel: [    0.162374] ACPI: Using IOAPIC for interrupt routing
Feb 10 16:06:02 vaio kernel: [    0.162753] ACPI: PCI Root Bridge [PCI0] (0000:00)
Feb 10 16:06:02 vaio kernel: [    0.162759] PCI: Probing PCI hardware (bus 00)
Feb 10 16:06:02 vaio kernel: [    0.163377] Boot video device is 0000:00:02.0
Feb 10 16:06:02 vaio kernel: [    0.163985] PCI quirk: region 1000-107f claimed by ICH6 ACPI/GPIO/TCO
Feb 10 16:06:02 vaio kernel: [    0.163989] PCI quirk: region 1180-11bf claimed by ICH6 GPIO
Feb 10 16:06:02 vaio kernel: [    0.164983] PCI: Transparent bridge - 0000:00:1e.0
Feb 10 16:06:02 vaio kernel: [    0.165053] PCI: Bus #0a (-#0d) is hidden behind transparent bridge #09 (-#0a) (try 'pci=assign-busses')
Feb 10 16:06:02 vaio kernel: [    0.165056] Please report the result to linux-kernel to fix this permanently
Feb 10 16:06:02 vaio kernel: [    0.165130] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
Feb 10 16:06:02 vaio kernel: [    0.169277] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.RP01._PRT]
Feb 10 16:06:02 vaio kernel: [    0.169850] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.RP02._PRT]
Feb 10 16:06:02 vaio kernel: [    0.170193] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.RP03._PRT]
Feb 10 16:06:02 vaio kernel: [    0.170465] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.RP04._PRT]
Feb 10 16:06:02 vaio kernel: [    0.172240] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCIB._PRT]
Feb 10 16:06:02 vaio kernel: [    0.173406] ACPI: PCI Interrupt Link [LNKA] (IRQs 10) *5
Feb 10 16:06:02 vaio kernel: [    0.173667] ACPI: PCI Interrupt Link [LNKB] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.173929] ACPI: PCI Interrupt Link [LNKC] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.174187] ACPI: PCI Interrupt Link [LNKD] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.174441] ACPI: PCI Interrupt Link [LNKE] (IRQs 10) *0, disabled.
Feb 10 16:06:02 vaio kernel: [    0.174698] ACPI: PCI Interrupt Link [LNKF] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.174956] ACPI: PCI Interrupt Link [LNKG] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.175212] ACPI: PCI Interrupt Link [LNKH] (IRQs *10)
Feb 10 16:06:02 vaio kernel: [    0.177787] Linux Plug and Play Support v0.97 (c) Adam Belay
Feb 10 16:06:02 vaio kernel: [    0.177796] pnp: PnP ACPI init
Feb 10 16:06:02 vaio kernel: [    0.180781] pnp: PnP ACPI: found 10 devices
Feb 10 16:06:02 vaio kernel: [    0.180785] PnPBIOS: Disabled by ACPI PNP
Feb 10 16:06:02 vaio kernel: [    0.180830] PCI: Using ACPI for IRQ routing
Feb 10 16:06:02 vaio kernel: [    0.180832] PCI: If a device doesn't work, try "pci=routeirq".  If it helps, post a report
Feb 10 16:06:02 vaio kernel: [    0.181426] PCI: Ignore bogus resource 6 [0:0] of 0000:00:02.0
Feb 10 16:06:02 vaio kernel: [    0.181433] PCI: Bridge: 0000:00:1c.0
Feb 10 16:06:02 vaio kernel: [    0.181436]   IO window: 2000-2fff
Feb 10 16:06:02 vaio kernel: [    0.181443]   MEM window: d6000000-d7ffffff
Feb 10 16:06:02 vaio kernel: [    0.181448]   PREFETCH window: d0000000-d1ffffff
Feb 10 16:06:02 vaio kernel: [    0.181453] PCI: Bridge: 0000:00:1c.1
Feb 10 16:06:02 vaio kernel: [    0.181455]   IO window: disabled.
Feb 10 16:06:02 vaio kernel: [    0.181461]   MEM window: dc000000-dc0fffff
Feb 10 16:06:02 vaio kernel: [    0.181465]   PREFETCH window: disabled.
Feb 10 16:06:02 vaio kernel: [    0.181470] PCI: Bridge: 0000:00:1c.2
Feb 10 16:06:02 vaio kernel: [    0.181474]   IO window: 3000-3fff
Feb 10 16:06:02 vaio kernel: [    0.181479]   MEM window: d8000000-d9ffffff
Feb 10 16:06:02 vaio kernel: [    0.181484]   PREFETCH window: d2000000-d3ffffff
Feb 10 16:06:02 vaio kernel: [    0.181490] PCI: Bridge: 0000:00:1c.3
Feb 10 16:06:02 vaio kernel: [    0.181493]   IO window: 4000-4fff
Feb 10 16:06:02 vaio kernel: [    0.181499]   MEM window: da000000-dbffffff
Feb 10 16:06:02 vaio kernel: [    0.181503]   PREFETCH window: d4000000-d5ffffff
Feb 10 16:06:02 vaio kernel: [    0.181516] PCI: Bus 10, cardbus bridge: 0000:09:04.0
Feb 10 16:06:02 vaio kernel: [    0.181518]   IO window: 00005000-000050ff
Feb 10 16:06:02 vaio kernel: [    0.181523]   IO window: 00005400-000054ff
Feb 10 16:06:02 vaio kernel: [    0.181528]   PREFETCH window: 30000000-33ffffff
Feb 10 16:06:02 vaio kernel: [    0.181534]   MEM window: 34000000-37ffffff
Feb 10 16:06:02 vaio kernel: [    0.181539] PCI: Bridge: 0000:00:1e.0
Feb 10 16:06:02 vaio kernel: [    0.181542]   IO window: 5000-5fff
Feb 10 16:06:02 vaio kernel: [    0.181548]   MEM window: dc100000-dc1fffff
Feb 10 16:06:02 vaio kernel: [    0.181553]   PREFETCH window: 30000000-33ffffff
Feb 10 16:06:02 vaio kernel: [    0.181581] ACPI: PCI Interrupt 0000:00:1c.0[A] -> GSI 16 (level, low) -> IRQ 16
Feb 10 16:06:02 vaio kernel: [    0.181587] PCI: Setting latency timer of device 0000:00:1c.0 to 64
Feb 10 16:06:02 vaio kernel: [    0.181609] ACPI: PCI Interrupt 0000:00:1c.1[B] -> GSI 17 (level, low) -> IRQ 17
Feb 10 16:06:02 vaio kernel: [    0.181615] PCI: Setting latency timer of device 0000:00:1c.1 to 64
Feb 10 16:06:02 vaio kernel: [    0.181637] ACPI: PCI Interrupt 0000:00:1c.2[C] -> GSI 18 (level, low) -> IRQ 18
Feb 10 16:06:02 vaio kernel: [    0.181643] PCI: Setting latency timer of device 0000:00:1c.2 to 64
Feb 10 16:06:02 vaio kernel: [    0.181664] ACPI: PCI Interrupt 0000:00:1c.3[D] -> GSI 19 (level, low) -> IRQ 19
Feb 10 16:06:02 vaio kernel: [    0.181670] PCI: Setting latency timer of device 0000:00:1c.3 to 64
Feb 10 16:06:02 vaio kernel: [    0.181683] PCI: Setting latency timer of device 0000:00:1e.0 to 64
Feb 10 16:06:02 vaio kernel: [    0.181703] ACPI: PCI Interrupt 0000:09:04.0[A] -> GSI 20 (level, low) -> IRQ 20
Feb 10 16:06:02 vaio kernel: [    0.181738] NET: Registered protocol family 2
Feb 10 16:06:02 vaio kernel: [    0.269024] IP route cache hash table entries: 4096 (order: 2, 16384 bytes)
Feb 10 16:06:02 vaio kernel: [    0.269099] TCP established hash table entries: 16384 (order: 5, 131072 bytes)
Feb 10 16:06:02 vaio kernel: [    0.269197] TCP bind hash table entries: 8192 (order: 4, 65536 bytes)
Feb 10 16:06:02 vaio kernel: [    0.269246] TCP: Hash tables configured (established 16384 bind 8192)
Feb 10 16:06:02 vaio kernel: [    0.269249] TCP reno registered
Feb 10 16:06:02 vaio kernel: [    0.296910] checking if image is initramfs... it is
Feb 10 16:06:02 vaio kernel: [    4.047575] Freeing initrd memory: 39523k freed
Feb 10 16:06:02 vaio kernel: [    4.048287] Simple Boot Flag at 0x37 set to 0x1
Feb 10 16:06:02 vaio kernel: [    4.048766] audit: initializing netlink socket (disabled)
Feb 10 16:06:02 vaio kernel: [    4.048783] audit(1171123541.480:1): initialized
Feb 10 16:06:02 vaio kernel: [    4.048959] VFS: Disk quotas dquot_6.5.1
Feb 10 16:06:02 vaio kernel: [    4.048986] Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)
Feb 10 16:06:02 vaio kernel: [    4.049039] io scheduler noop registered
Feb 10 16:06:02 vaio kernel: [    4.049042] io scheduler anticipatory registered
Feb 10 16:06:02 vaio kernel: [    4.049044] io scheduler deadline registered
Feb 10 16:06:02 vaio kernel: [    4.049056] io scheduler cfq registered (default)
Feb 10 16:06:02 vaio kernel: [    4.049317] PCI: Setting latency timer of device 0000:00:1c.0 to 64
Feb 10 16:06:02 vaio kernel: [    4.049371] assign_interrupt_mode Found MSI capability
Feb 10 16:06:02 vaio kernel: [    4.049424] Allocate Port Service[0000:00:1c.0:pcie00]
Feb 10 16:06:02 vaio kernel: [    4.049467] Allocate Port Service[0000:00:1c.0:pcie02]
Feb 10 16:06:02 vaio kernel: [    4.049507] Allocate Port Service[0000:00:1c.0:pcie03]
Feb 10 16:06:02 vaio kernel: [    4.049627] PCI: Setting latency timer of device 0000:00:1c.1 to 64
Feb 10 16:06:02 vaio kernel: [    4.049680] assign_interrupt_mode Found MSI capability
Feb 10 16:06:02 vaio kernel: [    4.049719] Allocate Port Service[0000:00:1c.1:pcie00]
Feb 10 16:06:02 vaio kernel: [    4.049755] Allocate Port Service[0000:00:1c.1:pcie02]
Feb 10 16:06:02 vaio kernel: [    4.049789] Allocate Port Service[0000:00:1c.1:pcie03]
Feb 10 16:06:02 vaio kernel: [    4.049911] PCI: Setting latency timer of device 0000:00:1c.2 to 64
Feb 10 16:06:02 vaio kernel: [    4.049964] assign_interrupt_mode Found MSI capability
Feb 10 16:06:02 vaio kernel: [    4.050002] Allocate Port Service[0000:00:1c.2:pcie00]
Feb 10 16:06:02 vaio kernel: [    4.050038] Allocate Port Service[0000:00:1c.2:pcie02]
Feb 10 16:06:02 vaio kernel: [    4.050077] Allocate Port Service[0000:00:1c.2:pcie03]
Feb 10 16:06:02 vaio kernel: [    4.050193] PCI: Setting latency timer of device 0000:00:1c.3 to 64
Feb 10 16:06:02 vaio kernel: [    4.050246] assign_interrupt_mode Found MSI capability
Feb 10 16:06:02 vaio kernel: [    4.050285] Allocate Port Service[0000:00:1c.3:pcie00]
Feb 10 16:06:02 vaio kernel: [    4.050320] Allocate Port Service[0000:00:1c.3:pcie02]
Feb 10 16:06:02 vaio kernel: [    4.050359] Allocate Port Service[0000:00:1c.3:pcie03]
Feb 10 16:06:02 vaio kernel: [    4.050547] isapnp: Scanning for PnP cards...
Feb 10 16:06:02 vaio kernel: [    4.404597] isapnp: No Plug & Play device found
Feb 10 16:06:02 vaio kernel: [    4.430184] Real Time Clock Driver v1.12ac
Feb 10 16:06:02 vaio kernel: [    4.430261] Serial: 8250/16550 driver $Revision: 1.90 $ 4 ports, IRQ sharing enabled
Feb 10 16:06:02 vaio kernel: [    4.430965] mice: PS/2 mouse device common for all mice
Feb 10 16:06:02 vaio kernel: [    4.431562] RAMDISK driver initialized: 16 RAM disks of 65536K size 1024 blocksize
Feb 10 16:06:02 vaio kernel: [    4.431671] Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
Feb 10 16:06:02 vaio kernel: [    4.431675] ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
Feb 10 16:06:02 vaio kernel: [    4.431983] PNP: PS/2 Controller [PNP0303:PS2K,PNP0f13:PS2M] at 0x60,0x64 irq 1,12
Feb 10 16:06:02 vaio kernel: [    4.434349] serio: i8042 KBD port at 0x60,0x64 irq 1
Feb 10 16:06:02 vaio kernel: [    4.434354] serio: i8042 AUX port at 0x60,0x64 irq 12
Feb 10 16:06:02 vaio kernel: [    4.434489] EISA: Probing bus 0 at eisa.0
Feb 10 16:06:02 vaio kernel: [    4.434497] Cannot allocate resource for EISA slot 1
Feb 10 16:06:02 vaio kernel: [    4.434501] Cannot allocate resource for EISA slot 2
Feb 10 16:06:02 vaio kernel: [    4.434505] Cannot allocate resource for EISA slot 3
Feb 10 16:06:02 vaio kernel: [    4.434507] Cannot allocate resource for EISA slot 4
Feb 10 16:06:02 vaio kernel: [    4.434510] Cannot allocate resource for EISA slot 5
Feb 10 16:06:02 vaio kernel: [    4.434526] EISA: Detected 0 cards.
Feb 10 16:06:02 vaio kernel: [    4.464703] TCP cubic registered
Feb 10 16:06:02 vaio kernel: [    4.464715] NET: Registered protocol family 1
Feb 10 16:06:02 vaio kernel: [    4.464720] NET: Registered protocol family 8
Feb 10 16:06:02 vaio kernel: [    4.464723] NET: Registered protocol family 20
Feb 10 16:06:02 vaio kernel: [    4.464759] Starting balanced_irq
Feb 10 16:06:02 vaio kernel: [    4.464767] Using IPI No-Shortcut mode
Feb 10 16:06:02 vaio kernel: [    4.464888] input: AT Translated Set 2 keyboard as /class/input/input0
Feb 10 16:06:02 vaio kernel: [    4.464914]  S3 S4 S5)
Feb 10 16:06:02 vaio kernel: [    4.464952]   Magic number: 11:933:84
Feb 10 16:06:02 vaio kernel: [    4.465247] Freeing unused kernel memory: 324k freed
Feb 10 16:06:02 vaio kernel: [    4.465644] Time: tsc clocksource has been installed.
Feb 10 16:06:02 vaio kernel: [    5.687635] ACPI (exconfig-0455): Dynamic SSDT Load - OemId [  Sony] OemTableId [      N0] [20060707]
Feb 10 16:06:02 vaio kernel: [    5.687873] ACPI (exconfig-0455): Dynamic SSDT Load - OemId [  Sony] OemTableId [      N0] [20060707]
Feb 10 16:06:02 vaio kernel: [    5.688568] ACPI: CPU0 (power states: C1[C1] C2[C2])
Feb 10 16:06:02 vaio kernel: [    5.688573] ACPI: Processor [CPU0] (supports 8 throttling states)
Feb 10 16:06:02 vaio kernel: [    5.689090] ACPI (exconfig-0455): Dynamic SSDT Load - OemId [  Sony] OemTableId [      N0] [20060707]
Feb 10 16:06:02 vaio kernel: [    5.689304] ACPI (exconfig-0455): Dynamic SSDT Load - OemId [  Sony] OemTableId [      N0] [20060707]
Feb 10 16:06:02 vaio kernel: [    5.689766] ACPI: CPU1 (power states: C1[C1] C2[C2])
Feb 10 16:06:02 vaio kernel: [    5.689770] ACPI: Processor [CPU1] (supports 8 throttling states)
Feb 10 16:06:02 vaio kernel: [    5.940000] ACPI: Thermal Zone [ATF0] (34 C)
Feb 10 16:06:02 vaio kernel: [    5.944000] ACPI: Thermal Zone [DTS0] (33 C)
Feb 10 16:06:02 vaio kernel: [    5.944000] ACPI: Thermal Zone [DTS1] (29 C)
Feb 10 16:06:02 vaio kernel: [    5.948000] Time: acpi_pm clocksource has been installed.
Feb 10 16:06:02 vaio kernel: [    6.268000] usbcore: registered new interface driver usbfs
Feb 10 16:06:02 vaio kernel: [    6.268000] usbcore: registered new interface driver hub
Feb 10 16:06:02 vaio kernel: [    6.268000] usbcore: registered new device driver usb
Feb 10 16:06:02 vaio kernel: [    6.268000] USB Universal Host Controller Interface driver v3.0
Feb 10 16:06:02 vaio kernel: [    6.268000] ACPI: PCI Interrupt 0000:00:1d.0[A] -> GSI 19 (level, low) -> IRQ 19
Feb 10 16:06:02 vaio kernel: [    6.268000] PCI: Setting latency timer of device 0000:00:1d.0 to 64
Feb 10 16:06:02 vaio kernel: [    6.268000] uhci_hcd 0000:00:1d.0: UHCI Host Controller
Feb 10 16:06:02 vaio kernel: [    6.268000] uhci_hcd 0000:00:1d.0: new USB bus registered, assigned bus number 1
Feb 10 16:06:02 vaio kernel: [    6.268000] uhci_hcd 0000:00:1d.0: irq 19, io base 0x00001820
Feb 10 16:06:02 vaio kernel: [    6.268000] usb usb1: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    6.268000] hub 1-0:1.0: USB hub found
Feb 10 16:06:02 vaio kernel: [    6.268000] hub 1-0:1.0: 2 ports detected
Feb 10 16:06:02 vaio kernel: [    6.328000] ieee1394: Initialized config rom entry `ip1394'
Feb 10 16:06:02 vaio kernel: [    6.372000] ACPI: PCI Interrupt 0000:00:1d.1[B] -> GSI 19 (level, low) -> IRQ 19
Feb 10 16:06:02 vaio kernel: [    6.372000] PCI: Setting latency timer of device 0000:00:1d.1 to 64
Feb 10 16:06:02 vaio kernel: [    6.372000] uhci_hcd 0000:00:1d.1: UHCI Host Controller
Feb 10 16:06:02 vaio kernel: [    6.372000] uhci_hcd 0000:00:1d.1: new USB bus registered, assigned bus number 2
Feb 10 16:06:02 vaio kernel: [    6.372000] uhci_hcd 0000:00:1d.1: irq 19, io base 0x00001840
Feb 10 16:06:02 vaio kernel: [    6.372000] usb usb2: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    6.372000] hub 2-0:1.0: USB hub found
Feb 10 16:06:02 vaio kernel: [    6.372000] hub 2-0:1.0: 2 ports detected
Feb 10 16:06:02 vaio kernel: [    6.484000] ACPI: PCI Interrupt 0000:00:1d.2[C] -> GSI 19 (level, low) -> IRQ 19
Feb 10 16:06:02 vaio kernel: [    6.484000] PCI: Setting latency timer of device 0000:00:1d.2 to 64
Feb 10 16:06:02 vaio kernel: [    6.484000] uhci_hcd 0000:00:1d.2: UHCI Host Controller
Feb 10 16:06:02 vaio kernel: [    6.484000] uhci_hcd 0000:00:1d.2: new USB bus registered, assigned bus number 3
Feb 10 16:06:02 vaio kernel: [    6.484000] uhci_hcd 0000:00:1d.2: irq 19, io base 0x00001860
Feb 10 16:06:02 vaio kernel: [    6.484000] usb usb3: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    6.484000] hub 3-0:1.0: USB hub found
Feb 10 16:06:02 vaio kernel: [    6.484000] hub 3-0:1.0: 2 ports detected
Feb 10 16:06:02 vaio kernel: [    6.596000] ACPI: PCI Interrupt 0000:00:1d.3[A] -> GSI 19 (level, low) -> IRQ 19
Feb 10 16:06:02 vaio kernel: [    6.596000] PCI: Setting latency timer of device 0000:00:1d.3 to 64
Feb 10 16:06:02 vaio kernel: [    6.596000] uhci_hcd 0000:00:1d.3: UHCI Host Controller
Feb 10 16:06:02 vaio kernel: [    6.596000] uhci_hcd 0000:00:1d.3: new USB bus registered, assigned bus number 4
Feb 10 16:06:02 vaio kernel: [    6.596000] uhci_hcd 0000:00:1d.3: irq 19, io base 0x00001880
Feb 10 16:06:02 vaio kernel: [    6.596000] usb usb4: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    6.596000] hub 4-0:1.0: USB hub found
Feb 10 16:06:02 vaio kernel: [    6.596000] hub 4-0:1.0: 2 ports detected
Feb 10 16:06:02 vaio kernel: [    6.700000] ACPI: PCI Interrupt 0000:00:1d.7[D] -> GSI 23 (level, low) -> IRQ 21
Feb 10 16:06:02 vaio kernel: [    6.700000] PCI: Setting latency timer of device 0000:00:1d.7 to 64
Feb 10 16:06:02 vaio kernel: [    6.700000] ehci_hcd 0000:00:1d.7: EHCI Host Controller
Feb 10 16:06:02 vaio kernel: [    6.700000] ehci_hcd 0000:00:1d.7: new USB bus registered, assigned bus number 5
Feb 10 16:06:02 vaio kernel: [    6.700000] ehci_hcd 0000:00:1d.7: debug port 1
Feb 10 16:06:02 vaio kernel: [    6.700000] PCI: cache line size of 32 is not supported by device 0000:00:1d.7
Feb 10 16:06:02 vaio kernel: [    6.700000] ehci_hcd 0000:00:1d.7: irq 21, io mem 0xdc544000
Feb 10 16:06:02 vaio kernel: [    6.704000] ehci_hcd 0000:00:1d.7: USB 2.0 started, EHCI 1.00, driver 10 Dec 2004
Feb 10 16:06:02 vaio kernel: [    6.704000] usb usb5: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    6.704000] hub 5-0:1.0: USB hub found
Feb 10 16:06:02 vaio kernel: [    6.704000] hub 5-0:1.0: 8 ports detected
Feb 10 16:06:02 vaio kernel: [    6.744000] usb 2-2: new full speed USB device using uhci_hcd and address 2
Feb 10 16:06:02 vaio kernel: [    6.816000] ACPI: PCI Interrupt 0000:09:04.1[B] -> GSI 21 (level, low) -> IRQ 22
Feb 10 16:06:02 vaio kernel: [    6.864000] ohci1394: fw-host0: OHCI-1394 1.1 (PCI): IRQ=[22]  MMIO=[dc105000-dc1057ff]  Max Packet=[2048]  IR/IT contexts=[4/8]
Feb 10 16:06:02 vaio kernel: [    6.864000] ICH7: IDE controller at PCI slot 0000:00:1f.1
Feb 10 16:06:02 vaio kernel: [    6.864000] ACPI: PCI Interrupt 0000:00:1f.1[B] -> GSI 22 (level, low) -> IRQ 23
Feb 10 16:06:02 vaio kernel: [    6.864000] ICH7: chipset revision 2
Feb 10 16:06:02 vaio kernel: [    6.864000] ICH7: not 100%% native mode: will probe irqs later
Feb 10 16:06:02 vaio kernel: [    6.864000]     ide0: BM-DMA at 0x1810-0x1817, BIOS settings: hda:DMA, hdb:pio
Feb 10 16:06:02 vaio kernel: [    6.864000] Probing IDE interface ide0...
Feb 10 16:06:02 vaio kernel: [    6.872000] SCSI subsystem initialized
Feb 10 16:06:02 vaio kernel: [    6.880000] libata version 2.00 loaded.
Feb 10 16:06:02 vaio kernel: [    7.092000] usb 5-4: new high speed USB device using ehci_hcd and address 2
Feb 10 16:06:02 vaio kernel: [    7.300000] usb 5-4: configuration #1 chosen from 1 choice
Feb 10 16:06:02 vaio kernel: [    7.312000] usbcore: registered new interface driver libusual
Feb 10 16:06:02 vaio kernel: [    7.316000] Initializing USB Mass Storage driver...
Feb 10 16:06:02 vaio kernel: [    7.316000] scsi0 : SCSI emulation for USB Mass Storage devices
Feb 10 16:06:02 vaio kernel: [    7.316000] usbcore: registered new interface driver usb-storage
Feb 10 16:06:02 vaio kernel: [    7.316000] USB Mass Storage support registered.
Feb 10 16:06:02 vaio kernel: [    7.316000] usb-storage: device found at 2
Feb 10 16:06:02 vaio kernel: [    7.316000] usb-storage: waiting for device to settle before scanning
Feb 10 16:06:02 vaio kernel: [    7.608000] hda: MATSHITAUJ-832D, ATAPI CD/DVD-ROM drive
Feb 10 16:06:02 vaio kernel: [    7.944000] ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
Feb 10 16:06:02 vaio kernel: [    7.948000] ata_piix 0000:00:1f.2: version 2.00ac7
Feb 10 16:06:02 vaio kernel: [    7.948000] ata_piix 0000:00:1f.2: MAP [ P0 P2 XX XX ]
Feb 10 16:06:02 vaio kernel: [    7.948000] ata_piix 0000:00:1f.2: invalid MAP value 0
Feb 10 16:06:02 vaio kernel: [    8.108000] ACPI: PCI Interrupt 0000:00:1f.2[B] -> GSI 22 (level, low) -> IRQ 23
Feb 10 16:06:02 vaio kernel: [    8.108000] PCI: Setting latency timer of device 0000:00:1f.2 to 64
Feb 10 16:06:02 vaio kernel: [    8.108000] ata1: SATA max UDMA/133 cmd 0x18D0 ctl 0x18C6 bmdma 0x18B0 irq 23
Feb 10 16:06:02 vaio kernel: [    8.108000] ata2: SATA max UDMA/133 cmd 0x18C8 ctl 0x18C2 bmdma 0x18B8 irq 23
Feb 10 16:06:02 vaio kernel: [    8.108000] scsi1 : ata_piix
Feb 10 16:06:02 vaio kernel: [    8.148000] ieee1394: Host added: ID:BUS[0-00:1023]  GUID[0800460302056347]
Feb 10 16:06:02 vaio kernel: [    8.284000] ata1.00: ATA-7, max UDMA/133, 156301488 sectors: LBA48 NCQ (depth 0/32)
Feb 10 16:06:02 vaio kernel: [    8.284000] ata1.00: ata1: dev 0 multi count 16
Feb 10 16:06:02 vaio kernel: [    8.304000] ata1.00: configured for UDMA/133
Feb 10 16:06:02 vaio kernel: [    8.304000] scsi2 : ata_piix
Feb 10 16:06:02 vaio kernel: [    8.464000] ATA: abnormal status 0x7F on port 0x18CF
Feb 10 16:06:02 vaio kernel: [    8.468000] scsi 1:0:0:0: Direct-Access     ATA      ST98823AS        3.14 PQ: 0 ANSI: 5
Feb 10 16:06:02 vaio kernel: [    8.472000] SCSI device sda: 156301488 512-byte hdwr sectors (80026 MB)
Feb 10 16:06:02 vaio kernel: [    8.472000] sda: Write Protect is off
Feb 10 16:06:02 vaio kernel: [    8.472000] sda: Mode Sense: 00 3a 00 00
Feb 10 16:06:02 vaio kernel: [    8.472000] SCSI device sda: write cache: enabled, read cache: enabled, doesn't support DPO or FUA
Feb 10 16:06:02 vaio kernel: [    8.472000] SCSI device sda: 156301488 512-byte hdwr sectors (80026 MB)
Feb 10 16:06:02 vaio kernel: [    8.472000] sda: Write Protect is off
Feb 10 16:06:02 vaio kernel: [    8.472000] sda: Mode Sense: 00 3a 00 00
Feb 10 16:06:02 vaio kernel: [    8.472000] SCSI device sda: write cache: enabled, read cache: enabled, doesn't support DPO or FUA
Feb 10 16:06:02 vaio kernel: [    8.472000]  sda:<6>hda: ATAPI 24X DVD-ROM DVD-R CD-R/RW drive, 2048kB Cache, UDMA(33)
Feb 10 16:06:02 vaio kernel: [    8.480000] Uniform CD-ROM driver Revision: 3.20
Feb 10 16:06:02 vaio kernel: [    8.484000]  sda1 sda2 sda3 < sda5 >
Feb 10 16:06:02 vaio kernel: [    8.516000] sd 1:0:0:0: Attached scsi disk sda
Feb 10 16:06:02 vaio kernel: [    8.520000] sd 1:0:0:0: Attached scsi generic sg0 type 0
Feb 10 16:06:02 vaio kernel: [    8.836000] Attempting manual resume
Feb 10 16:06:02 vaio kernel: [    8.836000] swsusp: Resume From Partition 8:5
Feb 10 16:06:02 vaio kernel: [    8.836000] PM: Checking swsusp image.
Feb 10 16:06:02 vaio kernel: [    8.836000] PM: Resume from disk failed.
Feb 10 16:06:02 vaio kernel: [    8.872000] kjournald starting.  Commit interval 5 seconds
Feb 10 16:06:02 vaio kernel: [    8.872000] EXT3-fs: mounted filesystem with ordered data mode.
Feb 10 16:06:02 vaio kernel: [   12.328000] usb-storage: device scan complete
Feb 10 16:06:02 vaio kernel: [   12.332000] scsi 0:0:0:0: Direct-Access     Sony     USB   HS-CARD    4.52 PQ: 0 ANSI: 0
Feb 10 16:06:02 vaio kernel: [   12.380000] sd 0:0:0:0: Attached scsi removable disk sdb
Feb 10 16:06:02 vaio kernel: [   12.380000] sd 0:0:0:0: Attached scsi generic sg1 type 0
Feb 10 16:06:02 vaio kernel: [   19.528000] pci_hotplug: PCI Hot Plug PCI Core version: 0.5
Feb 10 16:06:02 vaio kernel: [   19.556000] shpchp: Standard Hot Plug PCI Controller Driver version: 0.4
Feb 10 16:06:02 vaio kernel: [   20.012000] Yenta: CardBus bridge found at 0000:09:04.0 [104d:81e6]
Feb 10 16:06:02 vaio kernel: [   20.012000] Yenta: Enabling burst memory read transactions
Feb 10 16:06:02 vaio kernel: [   20.012000] Yenta: Using CSCINT to route CSC interrupts to PCI
Feb 10 16:06:02 vaio kernel: [   20.012000] Yenta: Routing CardBus interrupts to PCI
Feb 10 16:06:02 vaio kernel: [   20.012000] Yenta TI: socket 0000:09:04.0, mfunc 0x01a21b22, devctl 0x64
Feb 10 16:06:02 vaio kernel: [   20.180000] iTCO_vendor_support: vendor-support=0
Feb 10 16:06:02 vaio kernel: [   20.188000] iTCO_wdt: Intel TCO WatchDog Timer Driver v1.01 (11-Nov-2006)
Feb 10 16:06:02 vaio kernel: [   20.188000] iTCO_wdt: failed to reset NO_REBOOT flag, reboot disabled by hardware
Feb 10 16:06:02 vaio kernel: [   20.188000] iTCO_wdt: No card detected
Feb 10 16:06:02 vaio kernel: [   20.240000] Linux agpgart interface v0.101 (c) Dave Jones
Feb 10 16:06:02 vaio kernel: [   20.260000] Yenta: ISA IRQ mask 0x0cf8, PCI irq 20
Feb 10 16:06:02 vaio kernel: [   20.260000] Socket status: 30000006
Feb 10 16:06:02 vaio kernel: [   20.260000] Yenta: Raising subordinate bus# of parent bus (#09) from #0a to #0d
Feb 10 16:06:02 vaio kernel: [   20.260000] pcmcia: parent PCI bridge I/O window: 0x5000 - 0x5fff
Feb 10 16:06:02 vaio kernel: [   20.260000] cs: IO port probe 0x5000-0x5fff: clean.
Feb 10 16:06:02 vaio kernel: [   20.260000] pcmcia: parent PCI bridge Memory window: 0xdc100000 - 0xdc1fffff
Feb 10 16:06:02 vaio kernel: [   20.260000] pcmcia: parent PCI bridge Memory window: 0x30000000 - 0x33ffffff
Feb 10 16:06:02 vaio kernel: [   20.260000] ACPI: PCI Interrupt 0000:09:04.2[C] -> GSI 22 (level, low) -> IRQ 23
Feb 10 16:06:02 vaio kernel: [   20.260000] agpgart: Detected an Intel 945GM Chipset.
Feb 10 16:06:02 vaio kernel: [   20.260000] agpgart: Detected 7932K stolen memory.
Feb 10 16:06:02 vaio kernel: [   20.280000] agpgart: AGP aperture is 256M @ 0xc0000000
Feb 10 16:06:02 vaio kernel: [   20.520000] intel_rng: FWH not detected
Feb 10 16:06:02 vaio kernel: [   20.680000] ACPI: PCI Interrupt 0000:07:00.0[A] -> GSI 18 (level, low) -> IRQ 18
Feb 10 16:06:02 vaio kernel: [   20.680000] PCI: Setting latency timer of device 0000:07:00.0 to 64
Feb 10 16:06:02 vaio kernel: [   20.680000] sky2 v1.10 addr 0xd8000000 irq 18 Yukon-FE (0xb7) rev 1
Feb 10 16:06:02 vaio kernel: [   20.680000] sky2 eth0: addr 00:01:4a:f6:7f:e1
Feb 10 16:06:02 vaio kernel: [   20.752000] input: PS/2 Mouse as /class/input/input1
Feb 10 16:06:02 vaio kernel: [   20.772000] input: AlpsPS/2 ALPS GlidePoint as /class/input/input2
Feb 10 16:06:02 vaio kernel: [   20.984000] cs: IO port probe 0x100-0x3af: clean.
Feb 10 16:06:02 vaio kernel: [   20.988000] cs: IO port probe 0x3e0-0x4ff: excluding 0x4d0-0x4d7
Feb 10 16:06:02 vaio kernel: [   20.988000] cs: IO port probe 0x820-0x8ff: clean.
Feb 10 16:06:02 vaio kernel: [   20.988000] cs: IO port probe 0xc00-0xcf7: clean.
Feb 10 16:06:02 vaio kernel: [   20.988000] cs: IO port probe 0xa00-0xaff: clean.
Feb 10 16:06:02 vaio kernel: [   21.172000] ACPI: PCI Interrupt 0000:06:00.0[A] -> GSI 17 (level, low) -> IRQ 17
Feb 10 16:06:02 vaio kernel: [   21.172000] PCI: Setting latency timer of device 0000:06:00.0 to 64
Feb 10 16:06:02 vaio kernel: [   21.172000] ssb: Sonics Silicon Backplane found on PCI device 0000:06:00.0
Feb 10 16:06:02 vaio kernel: [   21.284000] wmaster0: Selected rate control algorithm 'simple'
Feb 10 16:06:02 vaio kernel: [   21.372000] ACPI: PCI Interrupt 0000:00:1b.0[A] -> GSI 21 (level, low) -> IRQ 22
Feb 10 16:06:02 vaio kernel: [   21.372000] PCI: Setting latency timer of device 0000:00:1b.0 to 64
Feb 10 16:06:02 vaio kernel: [   21.440000] bcm43xx_d80211: Broadcom 4311 WLAN found
Feb 10 16:06:02 vaio kernel: [   22.140000] lp: driver loaded but no devices found
Feb 10 16:06:02 vaio kernel: [   22.192000] Adding 1510068k swap on /dev/disk/by-uuid/91c72319-e9bb-4be0-9e2d-832ef7ef65ac.  Priority:-1 extents:1 across:1510068k
Feb 10 16:06:02 vaio kernel: [   22.252000] EXT3 FS on sda2, internal journal
Feb 10 16:06:02 vaio kernel: [   23.084000] ACPI: AC Adapter [ACAD] (on-line)
Feb 10 16:06:02 vaio kernel: [   23.180000] ACPI: Battery Slot [BAT1] (battery absent)
Feb 10 16:06:02 vaio kernel: [   23.200000] input: Lid Switch as /class/input/input3
Feb 10 16:06:02 vaio kernel: [   23.200000] ACPI: Lid Switch [LID0]
Feb 10 16:06:02 vaio kernel: [   23.224000] input: Power Button (CM) as /class/input/input4
Feb 10 16:06:02 vaio kernel: [   23.224000] ACPI: Power Button (CM) [PWRB]
Feb 10 16:06:02 vaio kernel: [   23.316000] ACPI: ACPI Dock Station Driver 
Feb 10 16:06:02 vaio kernel: [   23.348000] Using specific hotkey driver
Feb 10 16:06:02 vaio kernel: [   23.460000] ibm_acpi: ec object not found
Feb 10 16:06:03 vaio kernel: [   25.308000] ppdev: user-space parallel port driver
Feb 10 16:06:04 vaio kernel: [   26.496000] [drm] Initialized drm 1.1.0 20060810
Feb 10 16:06:04 vaio kernel: [   26.672000] ACPI: PCI Interrupt 0000:00:02.0[A] -> GSI 16 (level, low) -> IRQ 16
Feb 10 16:06:04 vaio kernel: [   26.672000] [drm] Initialized i915 1.6.0 20060119 on minor 0
Feb 10 16:06:06 vaio kernel: [   28.504000] apm: BIOS not found.
Feb 10 16:06:07 vaio kernel: [   29.464000] Capability LSM initialized
Feb 10 16:06:08 vaio kernel: [   30.576000] sonypi: Sony Programmable I/O Controller Driver v1.26.
Feb 10 16:06:08 vaio kernel: [   30.576000] sonypi: detected type3 model, verbose = 0, fnkeyinit = off, camera = off, compat = off, mask = 0xffffffff, useinput = on, acpi = on
Feb 10 16:06:08 vaio kernel: [   30.576000] sonypi: enabled at irq=11, port1=0x1080, port2=0x1084
Feb 10 16:06:08 vaio kernel: [   30.576000] sonypi: device allocated minor is 63
Feb 10 16:06:08 vaio kernel: [   30.576000] input: Sony Vaio Jogdial as /class/input/input5
Feb 10 16:06:08 vaio kernel: [   30.576000] input: Sony Vaio Keys as /class/input/input6
Feb 10 16:06:09 vaio kernel: [   31.528000] NET: Registered protocol family 10
Feb 10 16:06:09 vaio kernel: [   31.528000] lo: Disabled Privacy Extensions
Feb 10 16:06:09 vaio kernel: [   31.812000] Bluetooth: Core ver 2.11
Feb 10 16:06:09 vaio kernel: [   31.812000] NET: Registered protocol family 31
Feb 10 16:06:09 vaio kernel: [   31.812000] Bluetooth: HCI device and connection manager initialized
Feb 10 16:06:09 vaio kernel: [   31.812000] Bluetooth: HCI socket layer initialized
Feb 10 16:06:10 vaio kernel: [   31.860000] Bluetooth: L2CAP ver 2.8
Feb 10 16:06:10 vaio kernel: [   31.860000] Bluetooth: L2CAP socket layer initialized
Feb 10 16:06:10 vaio kernel: [   32.056000] Bluetooth: RFCOMM socket layer initialized
Feb 10 16:06:10 vaio kernel: [   32.056000] Bluetooth: RFCOMM TTY layer initialized
Feb 10 16:06:10 vaio kernel: [   32.056000] Bluetooth: RFCOMM ver 1.8
Feb 10 16:08:00 vaio kernel: [  142.500000] bcm43xx_d80211: Adding Interface type 2
Feb 10 16:08:00 vaio kernel: [  142.532000] bcm43xx_d80211: Found PHY: Analog 4, Type 2, Revision 8
Feb 10 16:08:00 vaio kernel: [  142.532000] bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
Feb 10 16:08:00 vaio kernel: [  142.692000] bcm43xx_d80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
Feb 10 16:08:00 vaio kernel: [  142.700000] bcm43xx_d80211: Radio turned on
Feb 10 16:08:00 vaio kernel: [  142.788000] bcm43xx_d80211: Chip initialized
Feb 10 16:08:00 vaio kernel: [  142.788000] bcm43xx_d80211: 32-bit DMA initialized
Feb 10 16:08:00 vaio kernel: [  142.804000] bcm43xx_d80211: Wireless interface started
Feb 10 16:08:00 vaio kernel: [  142.824000] wmaster0: Does not support passive scan, disabled
Feb 10 16:08:11 vaio kernel: [  153.744000] wlan0: no IPv6 routers present
Feb 10 16:08:13 vaio kernel: [  155.488000] wlan0: starting scan
Feb 10 16:08:15 vaio kernel: [  157.140000] wlan0: scan completed
Feb 10 16:10:07 vaio kernel: [  269.140000] wlan0: starting scan
Feb 10 16:10:08 vaio kernel: [  270.768000] wlan0: scan completed
Feb 10 16:10:41 vaio kernel: [  303.276000] wlan0: Initial auth_alg=0
Feb 10 16:10:41 vaio kernel: [  303.276000] wlan0: authenticate with AP 00:16:b6:1e:c7:2b
Feb 10 16:10:41 vaio kernel: [  303.276000] wlan0: RX authentication from 00:16:b6:1e:c7:2b (alg=0 transaction=2 status=0)
Feb 10 16:10:41 vaio kernel: [  303.276000] wlan0: authenticated
Feb 10 16:10:41 vaio kernel: [  303.276000] wlan0: associate with AP 00:16:b6:1e:c7:2b
Feb 10 16:10:41 vaio kernel: [  303.280000] wlan0: RX AssocResp from 00:16:b6:1e:c7:2b (capab=0x1 status=0 aid=3)
Feb 10 16:10:41 vaio kernel: [  303.280000] wlan0: associated
Feb 10 16:10:50 vaio kernel: [  311.956000] NET: Registered protocol family 17
Feb 10 16:12:18 vaio kernel: [  400.016000] device wlan0 entered promiscuous mode
Feb 10 16:12:18 vaio kernel: [  400.016000] audit(1171123938.207:2): dev=wlan0 prom=256 old_prom=0 auid=4294967295
Feb 10 16:12:18 vaio kernel: [  400.680000] device wlan0 left promiscuous mode
Feb 10 16:12:18 vaio kernel: [  400.680000] audit(1171123938.871:3): dev=wlan0 prom=0 old_prom=256 auid=4294967295
Feb 10 16:12:21 vaio kernel: [  403.668000] device wlan0 entered promiscuous mode
Feb 10 16:12:21 vaio kernel: [  403.668000] audit(1171123941.859:4): dev=wlan0 prom=256 old_prom=0 auid=4294967295
Feb 10 16:14:49 vaio kernel: [  550.808000] device wlan0 left promiscuous mode
Feb 10 16:14:49 vaio kernel: [  550.808000] audit(1171124089.007:5): dev=wlan0 prom=0 old_prom=256 auid=4294967295
Feb 10 16:18:01 vaio kernel: [  743.064000] bcm43xx_d80211: ASSERTION FAILED (0) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
Feb 10 16:18:01 vaio kernel: [  743.064000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && *slot < ring->nr_slots) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()
Feb 10 16:20:01 vaio kernel: [  863.096000] bcm43xx_d80211: ASSERTION FAILED (0) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
Feb 10 16:20:01 vaio kernel: [  863.096000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && *slot < ring->nr_slots) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()
Feb 10 16:22:01 vaio kernel: [  983.152000] bcm43xx_d80211: ASSERTION FAILED (0) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
Feb 10 16:22:01 vaio kernel: [  983.152000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && *slot < ring->nr_slots) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()
Feb 10 16:26:01 vaio kernel: [ 1223.236000] bcm43xx_d80211: ASSERTION FAILED (0) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1012:parse_cookie()
Feb 10 16:26:01 vaio kernel: [ 1223.236000] bcm43xx_d80211: ASSERTION FAILED (ring && *slot >= 0 && *slot < ring->nr_slots) at: ubuntu/wireless/d80211/bcm43xx/bcm43xx_dma.c:1015:parse_cookie()

From larry.finger at lwfinger.net  Sat Feb 10 21:33:51 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 10 Feb 2007 14:33:51 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702101811.37355.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702091753.12419.mb@bu3sch.de> <200702101811.37355.rjw@sisk.pl>
Message-ID: <45CE2C2F.8070502@lwfinger.net>

Rafael,

Rafael J. Wysocki wrote:
> 
> I'm running with this patch applied right now, but the association is lost
> after the resume anyway.  I have to reload bcm43xx to make it associate with
> the AP again (no big deal).


Please send me the output of iwconfig and ifconfig after the resume, but before you reload bcm43xx.

Will the interface recover with any measure less drastic than reloading? Does an ifdown/ifup
sequence do the trick?

Thanks,

Larry


From mjg59 at srcf.ucam.org  Sat Feb 10 21:46:30 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 10 Feb 2007 20:46:30 +0000
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <200612221359.25093.mb@bu3sch.de>
References: <200612221359.25093.mb@bu3sch.de>
Message-ID: <20070210204630.GA27274@srcf.ucam.org>

I'm testing with your bcm43xx git tree, which I'm guessing is the 
current ssb code. The only problem I've found is that there doesn't seem 
to be any sysfs relationship between the ssb bus and (in this case) the 
PCI device that it's associated with. Is this fixable? Right now it 
appears as an entirely separate branch of the device tree, which doesn't 
seem quite right.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Sat Feb 10 22:03:57 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 Feb 2007 22:03:57 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070210204630.GA27274@srcf.ucam.org>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210204630.GA27274@srcf.ucam.org>
Message-ID: <200702102203.57411.mb@bu3sch.de>

On Saturday 10 February 2007 21:46, Matthew Garrett wrote:
> I'm testing with your bcm43xx git tree, which I'm guessing is the 
> current ssb code. The only problem I've found is that there doesn't seem 
> to be any sysfs relationship between the ssb bus and (in this case) the 
> PCI device that it's associated with. Is this fixable? Right now it 
> appears as an entirely separate branch of the device tree, which doesn't 
> seem quite right.

I guess that's fixable, but I didn't care too much, yet.

-- 
Greetings Michael.


From mjg59 at srcf.ucam.org  Sat Feb 10 23:11:50 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 10 Feb 2007 22:11:50 +0000
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <200702102203.57411.mb@bu3sch.de>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210204630.GA27274@srcf.ucam.org>
	<200702102203.57411.mb@bu3sch.de>
Message-ID: <20070210221150.GA28338@srcf.ucam.org>

On Sat, Feb 10, 2007 at 10:03:57PM +0100, Michael Buesch wrote:
> On Saturday 10 February 2007 21:46, Matthew Garrett wrote:
> > I'm testing with your bcm43xx git tree, which I'm guessing is the 
> > current ssb code. The only problem I've found is that there doesn't seem 
> > to be any sysfs relationship between the ssb bus and (in this case) the 
> > PCI device that it's associated with. Is this fixable? Right now it 
> > appears as an entirely separate branch of the device tree, which doesn't 
> > seem quite right.
> 
> I guess that's fixable, but I didn't care too much, yet.

Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
pcmcia_device structure. Seems to work fine for PCI - I don't have any 
PCMCIA devices. The SSB devices now appear underneath the PCI device 
rather than in the top level of /sys/devices.

Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>

---

diff --git a/drivers/ssb/scan.c b/drivers/ssb/scan.c
index 64f94b8..b16cee9 100644
--- a/drivers/ssb/scan.c
+++ b/drivers/ssb/scan.c
@@ -15,6 +15,11 @@
 #include <linux/ssb/ssb.h>
 #include <linux/ssb/ssb_regs.h>
 #include <linux/pci.h>
+#include <pcmcia/cs_types.h>
+#include <pcmcia/cs.h>
+#include <pcmcia/cistpl.h>
+#include <pcmcia/ciscode.h>
+#include <pcmcia/ds.h>
 #include <asm/io.h>
 
 #include "ssb_private.h"
@@ -306,8 +311,12 @@ int ssb_bus_scan(struct ssb_bus *bus,
 		dev->id.vendor = (idhi & SSB_IDHIGH_VC) >> SSB_IDHIGH_VC_SHIFT;
 		dev->core_index = i;
 		dev->bus = bus;
-		if ((dev->bus->bustype == SSB_BUSTYPE_PCI) && (bus->host_pci))
+		if ((dev->bus->bustype == SSB_BUSTYPE_PCI) && (bus->host_pci)) {
 			dev->irq = bus->host_pci->irq;
+			dev->dev.parent = &bus->host_pci->dev;
+		} else if (dev->bus->bustype == SSB_BUSTYPE_PCMCIA) {
+		        dev->dev.parent = &bus->host_pcmcia->dev;
+		}
 
 		ssb_dprintk(KERN_INFO PFX
 			    "Core %d found: %s "

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Sat Feb 10 23:14:53 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 10 Feb 2007 23:14:53 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070210221150.GA28338@srcf.ucam.org>
References: <200612221359.25093.mb@bu3sch.de> <200702102203.57411.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
Message-ID: <200702102314.54194.mb@bu3sch.de>

On Saturday 10 February 2007 23:11, Matthew Garrett wrote:
> On Sat, Feb 10, 2007 at 10:03:57PM +0100, Michael Buesch wrote:
> > On Saturday 10 February 2007 21:46, Matthew Garrett wrote:
> > > I'm testing with your bcm43xx git tree, which I'm guessing is the 
> > > current ssb code. The only problem I've found is that there doesn't seem 
> > > to be any sysfs relationship between the ssb bus and (in this case) the 
> > > PCI device that it's associated with. Is this fixable? Right now it 
> > > appears as an entirely separate branch of the device tree, which doesn't 
> > > seem quite right.
> > 
> > I guess that's fixable, but I didn't care too much, yet.
> 
> Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
> pcmcia_device structure. Seems to work fine for PCI - I don't have any 
> PCMCIA devices. The SSB devices now appear underneath the PCI device 
> rather than in the top level of /sys/devices.
> 
> Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>

Ok, nice. Thanks for figuring this out.
I'll apply this too my tree.

> ---
> 
> diff --git a/drivers/ssb/scan.c b/drivers/ssb/scan.c
> index 64f94b8..b16cee9 100644
> --- a/drivers/ssb/scan.c
> +++ b/drivers/ssb/scan.c
> @@ -15,6 +15,11 @@
>  #include <linux/ssb/ssb.h>
>  #include <linux/ssb/ssb_regs.h>
>  #include <linux/pci.h>
> +#include <pcmcia/cs_types.h>
> +#include <pcmcia/cs.h>
> +#include <pcmcia/cistpl.h>
> +#include <pcmcia/ciscode.h>
> +#include <pcmcia/ds.h>
>  #include <asm/io.h>
>  
>  #include "ssb_private.h"
> @@ -306,8 +311,12 @@ int ssb_bus_scan(struct ssb_bus *bus,
>  		dev->id.vendor = (idhi & SSB_IDHIGH_VC) >> SSB_IDHIGH_VC_SHIFT;
>  		dev->core_index = i;
>  		dev->bus = bus;
> -		if ((dev->bus->bustype == SSB_BUSTYPE_PCI) && (bus->host_pci))
> +		if ((dev->bus->bustype == SSB_BUSTYPE_PCI) && (bus->host_pci)) {
>  			dev->irq = bus->host_pci->irq;
> +			dev->dev.parent = &bus->host_pci->dev;
> +		} else if (dev->bus->bustype == SSB_BUSTYPE_PCMCIA) {
> +		        dev->dev.parent = &bus->host_pcmcia->dev;
> +		}
>  
>  		ssb_dprintk(KERN_INFO PFX
>  			    "Core %d found: %s "
> 

-- 
Greetings Michael.


From proski at gnu.org  Sat Feb 10 23:56:44 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 10 Feb 2007 17:56:44 -0500
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070210221150.GA28338@srcf.ucam.org>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210204630.GA27274@srcf.ucam.org>
	<200702102203.57411.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
Message-ID: <1171148204.22868.1.camel@dv>

On Sat, 2007-02-10 at 22:11 +0000, Matthew Garrett wrote:
> Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
> pcmcia_device structure. Seems to work fine for PCI - I don't have any 
> PCMCIA devices. The SSB devices now appear underneath the PCI device 
> rather than in the top level of /sys/devices.

I've just checked, pcmcia/ciscode.h is not needed.  The rest is needed.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Sun Feb 11 00:10:52 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 00:10:52 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <1171148204.22868.1.camel@dv>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
	<1171148204.22868.1.camel@dv>
Message-ID: <200702110010.52586.mb@bu3sch.de>

On Saturday 10 February 2007 23:56, Pavel Roskin wrote:
> On Sat, 2007-02-10 at 22:11 +0000, Matthew Garrett wrote:
> > Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
> > pcmcia_device structure. Seems to work fine for PCI - I don't have any 
> > PCMCIA devices. The SSB devices now appear underneath the PCI device 
> > rather than in the top level of /sys/devices.
> 
> I've just checked, pcmcia/ciscode.h is not needed.  The rest is needed.

http://bu3sch.de/gitweb?p=wireless-dev.git;a=commitdiff;h=218241c63246c5611520df98ce8ae06016545c9c

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Feb 11 00:41:06 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 10 Feb 2007 17:41:06 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <a44ae5cd0702101530j38c983bfy9c1496fd50ca8b1c@mail.gmail.com>
References: <45C96B8A.8010000@lwfinger.net> <1170830071.11150.62.camel@dv>	
	<200702071443.19676.rjw@sisk.pl> <45C9D9D6.2070700@lwfinger.net>
	<a44ae5cd0702101530j38c983bfy9c1496fd50ca8b1c@mail.gmail.com>
Message-ID: <45CE5812.3000306@lwfinger.net>

Miles Lane wrote:
> I am testing this patch applied to the wireless-net git tree.
> The card is a Linksys WPC54G.  The card is still getting very
> weak signal strength and the connection seems unresponsive
> most of the time.

As the subject says, the patch was for 4311 and 4312 cards. The 4318's are not yet fixed.

As measured by my RF receiver, the amplitude of the 4318 is about -70 dBm, the 4311 is about -60 dBm
and the 4306 is -50 dBm. All should have the -50 reading with my test setup.

I'm working on the power routines and will let you know.

Larry


From radarsat1 at gmail.com  Sun Feb 11 02:24:19 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Sat, 10 Feb 2007 20:24:19 -0500
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <200702082202.43761.rjw@sisk.pl>
References: <45C96B8A.8010000@lwfinger.net> <200702080809.03200.rjw@sisk.pl>
	<9b3e2dc20702080911r75ec55a1of8885ee97cea5f9c@mail.gmail.com>
	<200702082202.43761.rjw@sisk.pl>
Message-ID: <9b3e2dc20702101724m4281cb59j9c860563a4a14a35@mail.gmail.com>

> > I have one more test to try... I am strangely never able to associate
> > with the wifi router in my girlfriend's apartment, however it is a
> > crappy old D-Link B-series router.  I'll try it next time I get a
> > chance.  (I've long suspected the reason is that she lives in an
> > apartment building, and there are something like 20 other APs in the
> > vicinity, so potentially a lot of wifi traffic interfering.  However,
> > I am always able to connect using Windows.)
>
> Have you tried it with the patch applied?
>


I hadn't, but now I have, and yes I'm happy to report that I was able
to connect to it. ;-)


Steve


From josejx at gentoo.org  Sun Feb 11 03:13:30 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Sat, 10 Feb 2007 21:13:30 -0500
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702100655.51495.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>	<45CCCAE1.9080901@lwfinger.net>	<20070209213239.GA11650@srcf.ucam.org>
	<200702100655.51495.mb@bu3sch.de>
Message-ID: <45CE7BCA.6010107@gentoo.org>

> It's likely that old cards still work with v4 firmware, but we don't know and
> it has to be tested.
> 
> Care to do so?

I'm fairly sure the reason for dropping the old cards is that the 
on-board memory which holds the firmware isn't large enough to hold 
the newer firmware.  I can't find my documentation for that at the 
moment though.  Feel free to test and I'll confirm it later if I can 
find the info.

I'd suspect it doesn't work though since they provided a different 
firmware (ucode2) in the past.

-Joe


From ranma at tdiedrich.de  Sun Feb 11 08:18:41 2007
From: ranma at tdiedrich.de (Tobias Diedrich)
Date: Sun, 11 Feb 2007 08:18:41 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070210221150.GA28338@srcf.ucam.org>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210204630.GA27274@srcf.ucam.org>
	<200702102203.57411.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
Message-ID: <20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>

Matthew Garrett wrote:

> Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
> pcmcia_device structure. Seems to work fine for PCI - I don't have any 
> PCMCIA devices. The SSB devices now appear underneath the PCI device 
> rather than in the top level of /sys/devices.

What about PCI-less devices like the WRT54G?
Wouldn't it make sense to have it in the top level on those?
What if I configure the kernel without PCI support?

BTW, is the SSB b44 driver/patch available somewhere?

-- 
Tobias						PGP: http://9ac7e0bc.uguu.de
??????????????????????????


From enrico.gatto at poste.it  Sun Feb 11 12:03:44 2007
From: enrico.gatto at poste.it (Enrico Gatto)
Date: Sun, 11 Feb 2007 12:03:44 +0100
Subject: Success on HP Pavilion dv6159eu
Message-ID: <200702111203.54533.enrico.gatto@poste.it>


Notebook HP Pavilion dv6000
Wifi adapter Broadcom BCM4310 UART
Kernel 2.6.20

Wireless card works with this patch:

--- bcm43xx_main.c      2007-02-09 18:59:23.000000000 +0100
+++ /usr/src/linux-2.6.20/drivers/net/wireless/bcm43xx/bcm43xx_main.c   
2007-02-09 18:59:37.000000000 +0100
@@ -146,6 +146,8 @@
        { PCI_VENDOR_ID_BROADCOM, 0x4324, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },
        /* Broadcom 43XG 802.11b/g */
        { PCI_VENDOR_ID_BROADCOM, 0x4325, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },
+       /* Broadcom 4310 on HP notebook */
+       { PCI_VENDOR_ID_BROADCOM, 0x14e4, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },
 #ifdef CONFIG_BCM947XX
        /* SB bus on BCM947xx */
        { PCI_VENDOR_ID_BROADCOM, 0x0800, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },


Output of lspci follows.

# lspci -nnnvvv
03:00.0 Network controller [0280]: Broadcom Corporation BCM4310 UART 
[14e4:4312] (rev 01)
        Subsystem: Hewlett-Packard Company Unknown device [103c:1361]
        Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
Stepping- SERR+ FastB2B-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- 
<TAbort- <MAbort- >SERR- <PERR-
        Latency: 0, Cache Line Size: 64 bytes
        Interrupt: pin A routed to IRQ 11
        Region 0: Memory at c0400000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
                Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=375mA 
PME(D0-,D1-,D2-,D3hot-,D3cold-)
                Status: D0 PME-Enable- DSel=0 DScale=2 PME-
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit- 
Queue=0/0 Enable-
                Address: 00000000  Data: 0000
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
                Device: Supported: MaxPayload 128 bytes, PhantFunc 0, ExtTag+
                Device: Latency L0s <4us, L1 unlimited
                Device: AtnBtn- AtnInd- PwrInd-
                Device: Errors: Correctable- Non-Fatal- Fatal- Unsupported-
                Device: RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop-
                Device: MaxPayload 128 bytes, MaxReadReq 128 bytes
                Link: Supported Speed 2.5Gb/s, Width x1, ASPM L0s, Port 0
                Link: Latency L0s <4us, L1 <64us
                Link: ASPM Disabled RCB 64 bytes CommClk- ExtSynch-
                Link: Speed 2.5Gb/s, Width x1
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070211/c93e5583/attachment.pgp>

From mjg59 at srcf.ucam.org  Sun Feb 11 12:54:47 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sun, 11 Feb 2007 11:54:47 +0000
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210204630.GA27274@srcf.ucam.org>
	<200702102203.57411.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
	<20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>
Message-ID: <20070211115447.GA4204@srcf.ucam.org>

On Sun, Feb 11, 2007 at 08:18:41AM +0100, Tobias Diedrich wrote:

> What about PCI-less devices like the WRT54G?
> Wouldn't it make sense to have it in the top level on those?
> What if I configure the kernel without PCI support?

If it's not a PCI or PCMCIA device, the parent won't be set and it'll 
appear at the top level.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From martin-langer at gmx.de  Sun Feb 11 13:17:27 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Sun, 11 Feb 2007 13:17:27 +0100
Subject: Success on HP Pavilion dv6159eu
In-Reply-To: <200702111203.54533.enrico.gatto@poste.it>
References: <200702111203.54533.enrico.gatto@poste.it>
Message-ID: <20070211121727.GA3714@tuba>

On Sun, Feb 11, 2007 at 12:03:44PM +0100, Enrico Gatto wrote:
> 
> Notebook HP Pavilion dv6000
> Wifi adapter Broadcom BCM4310 UART

> Wireless card works with this patch:

Really?

> +       { PCI_VENDOR_ID_BROADCOM, 0x14e4, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },
                                    ^^^^^^
I expect 0x4312 instead of 0x14e4.

> # lspci -nnnvvv
> 03:00.0 Network controller [0280]: Broadcom Corporation BCM4310 UART 
> [14e4:4312] (rev 01)

0x14e4 is the bcm vendor id aka PCI_VENDOR_ID_BROADCOM.


Martin


From mb at bu3sch.de  Sun Feb 11 13:25:29 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 13:25:29 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
	<20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>
Message-ID: <200702111325.29620.mb@bu3sch.de>

On Sunday 11 February 2007 08:18, Tobias Diedrich wrote:
> Matthew Garrett wrote:
> 
> > Ok, here's a patch. The stack of PCMCIA headers are needed to get the 
> > pcmcia_device structure. Seems to work fine for PCI - I don't have any 
> > PCMCIA devices. The SSB devices now appear underneath the PCI device 
> > rather than in the top level of /sys/devices.
> 
> What about PCI-less devices like the WRT54G?
> Wouldn't it make sense to have it in the top level on those?
> What if I configure the kernel without PCI support?

I already applied the correct patch to my tree. ;)

> BTW, is the SSB b44 driver/patch available somewhere?

In my tree.

-- 
Greetings Michael.


From rjw at sisk.pl  Sun Feb 11 13:56:11 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sun, 11 Feb 2007 13:56:11 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45CE2C2F.8070502@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702101811.37355.rjw@sisk.pl> <45CE2C2F.8070502@lwfinger.net>
Message-ID: <200702111356.12206.rjw@sisk.pl>

On Saturday, 10 February 2007 21:33, Larry Finger wrote:
> Rafael,
> 
> Rafael J. Wysocki wrote:
> > 
> > I'm running with this patch applied right now, but the association is lost
> > after the resume anyway.  I have to reload bcm43xx to make it associate with
> > the AP again (no big deal).
> 
> 
> Please send me the output of iwconfig and ifconfig after the resume, but before you reload bcm43xx.

albercik:~ # iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

eth1      IEEE 802.11b/g  ESSID:"DI524"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

albercik:~ # ifconfig eth1
eth1      Link encap:Ethernet  HWaddr 00:14:A5:BE:95:31
          inet addr:192.168.100.101  Bcast:192.168.100.255  Mask:255.255.255.0
          inet6 addr: fe80::214:a5ff:febe:9531/64 Scope:Link
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:5137 errors:0 dropped:120 overruns:0 frame:0
          TX packets:5703 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:4569090 (4.3 Mb)  TX bytes:156826797 (149.5 Mb)
          Interrupt:18

albercik:~ # ifconfig eth1 down
albercik:~ # ifconfig eth1 up
SIOCSIFFLAGS: No such device

Reloading the driver helps. ;-)

Greetings,
Rafael


From mb at bu3sch.de  Sun Feb 11 14:07:07 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 14:07:07 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111356.12206.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<45CE2C2F.8070502@lwfinger.net> <200702111356.12206.rjw@sisk.pl>
Message-ID: <200702111407.08099.mb@bu3sch.de>

On Sunday 11 February 2007 13:56, Rafael J. Wysocki wrote:
> On Saturday, 10 February 2007 21:33, Larry Finger wrote:
> > Rafael,
> > 
> > Rafael J. Wysocki wrote:
> > > 
> > > I'm running with this patch applied right now, but the association is lost
> > > after the resume anyway.  I have to reload bcm43xx to make it associate with
> > > the AP again (no big deal).
> > 
> > 
> > Please send me the output of iwconfig and ifconfig after the resume, but before you reload bcm43xx.
> 
> albercik:~ # iwconfig
> lo        no wireless extensions.
> 
> eth0      no wireless extensions.
> 
> eth1      IEEE 802.11b/g  ESSID:"DI524"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> albercik:~ # ifconfig eth1
> eth1      Link encap:Ethernet  HWaddr 00:14:A5:BE:95:31
>           inet addr:192.168.100.101  Bcast:192.168.100.255  Mask:255.255.255.0
>           inet6 addr: fe80::214:a5ff:febe:9531/64 Scope:Link
>           UP BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:5137 errors:0 dropped:120 overruns:0 frame:0
>           TX packets:5703 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000
>           RX bytes:4569090 (4.3 Mb)  TX bytes:156826797 (149.5 Mb)
>           Interrupt:18
> 
> albercik:~ # ifconfig eth1 down
> albercik:~ # ifconfig eth1 up
> SIOCSIFFLAGS: No such device
		^^^^^

I'd like to see dmesg, please.

-- 
Greetings Michael.


From johannes at sipsolutions.net  Sun Feb 11 14:21:45 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 11 Feb 2007 14:21:45 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <20070209213239.GA11650@srcf.ucam.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702091811.40683.mb@bu3sch.de> <45CCF432.2070002@gentoo.org>
	<200702091829.51002.mb@bu3sch.de> <45CCBB93.2040703@lwfinger.net>
	<45CCC5DF.8010001@gentoo.org> <45CCCAE1.9080901@lwfinger.net>
	<20070209213239.GA11650@srcf.ucam.org>
Message-ID: <1171200105.5032.6.camel@johannes.berg>

On Fri, 2007-02-09 at 21:32 +0000, Matthew Garrett wrote:
> On Fri, Feb 09, 2007 at 01:26:25PM -0600, Larry Finger wrote:
> 
> > My plan is to continue to maintain bcm43xx-SoftMAC for at least the BPHY and 4306 revisions even
> > after d80211 becomes the in-kernel driver. Of course, I hope that we will have found the killer bugs
> > by that time, and that maintenance will only require following kernel API changes.
> 
> Just to make sure I'm understanding this correctly - does the v4 
> firmware drop compatibility for older cards, or is it just that Broadcom 
> dropped support in the driver at the same time as the firmware changed, 
> and the new firmware will still also drive the old cards?

No, the older cards have a completely different MAC processor and
Broadcom hasn't bothered to create v4 firmware for it since they dropped
support for it along with creating new drivers (probably one decision
influenced the other, creating a v2 firmware is likely more work than a
v3+)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070211/274f21d8/attachment.pgp>

From rjw at sisk.pl  Sun Feb 11 15:02:18 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sun, 11 Feb 2007 15:02:18 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111407.08099.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111356.12206.rjw@sisk.pl> <200702111407.08099.mb@bu3sch.de>
Message-ID: <200702111502.19545.rjw@sisk.pl>

On Sunday, 11 February 2007 14:07, Michael Buesch wrote:
> On Sunday 11 February 2007 13:56, Rafael J. Wysocki wrote:
> > On Saturday, 10 February 2007 21:33, Larry Finger wrote:
> > > Rafael,
> > > 
> > > Rafael J. Wysocki wrote:
> > > > 
> > > > I'm running with this patch applied right now, but the association is lost
> > > > after the resume anyway.  I have to reload bcm43xx to make it associate with
> > > > the AP again (no big deal).
> > > 
> > > 
> > > Please send me the output of iwconfig and ifconfig after the resume, but before you reload bcm43xx.
> > 
> > albercik:~ # iwconfig
> > lo        no wireless extensions.
> > 
> > eth0      no wireless extensions.
> > 
> > eth1      IEEE 802.11b/g  ESSID:"DI524"  Nickname:"Broadcom 4311"
> >           Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
> >           Bit Rate=1 Mb/s   Tx-Power=18 dBm
> >           RTS thr:off   Fragment thr:off
> >           Encryption key:off
> >           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
> >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > 
> > albercik:~ # ifconfig eth1
> > eth1      Link encap:Ethernet  HWaddr 00:14:A5:BE:95:31
> >           inet addr:192.168.100.101  Bcast:192.168.100.255  Mask:255.255.255.0
> >           inet6 addr: fe80::214:a5ff:febe:9531/64 Scope:Link
> >           UP BROADCAST MULTICAST  MTU:1500  Metric:1
> >           RX packets:5137 errors:0 dropped:120 overruns:0 frame:0
> >           TX packets:5703 errors:0 dropped:0 overruns:0 carrier:0
> >           collisions:0 txqueuelen:1000
> >           RX bytes:4569090 (4.3 Mb)  TX bytes:156826797 (149.5 Mb)
> >           Interrupt:18
> > 
> > albercik:~ # ifconfig eth1 down
> > albercik:~ # ifconfig eth1 up
> > SIOCSIFFLAGS: No such device
> 		^^^^^
> 
> I'd like to see dmesg, please.

Appended.  It covers one suspend-resume cycle (suspend to disk).  I have
filtered HID-related messages out of it.

Greetings,
Rafael


ton.000e = 0
usb 3-1: usb auto-resume
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00040103 PSSC PPS PES CCS
usb 3-1: finish resume
usb usb1: usb auto-resume
usb usb1: finish resume
hub 1-0:1.0: hub_resume
ehci_hcd 0000:00:13.2: resume root hub
hub 1-0:1.0: state 7 ports 8 chg 0000 evt 0000
usb 3-1: usb auto-suspend
hub 1-0:1.0: hub_suspend
usb usb1: usb auto-suspend
PM: Adding info for No Bus:vcs8
PM: Adding info for No Bus:vcsa8
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
Stopping tasks ... done.
Shrinking memory...  -\|/-\|/-\done (113015 pages freed)
Freed 452060 kbytes in 1.44 seconds (313.93 MB/s)
Suspending console(s)
usbhid 3-4:1.0: freeze
usb 3-4: freeze
usbhid 3-4:1.0: suspend
usb 3-4: usb suspend
 usbdev3.18: PM: suspend 0->1, parent 3-1 already 2
 usbdev3.18_ep02: PM: suspend 0->1, parent 3-1:1.0 already 2
 usbdev3.18_ep81: PM: suspend 0->1, parent 3-1:1.0 already 2
usb 3-1:1.0: PM: suspend 2-->1
usb 3-1:1.0: PM: suspend 2->1, parent 3-1 already 2
 usbdev3.18_ep00: PM: suspend 0->1, parent 3-1 already 2
usb 3-1: PM: suspend 2-->1
usb 2-2:1.3: freeze
usb 2-2:1.2: freeze
hci_usb 2-2:1.1: freeze
hci_usb 2-2:1.0: freeze
usb 2-2: freeze
usb 2-2: usb suspend
serio serio6: freeze
platform bluetooth: freeze
hub 3-0:1.0: freeze
usb usb3: freeze
hub 3-0:1.0: hub_suspend
ohci_hcd 0000:00:13.1: suspend root hub
usb usb3: usb suspend
hub 2-0:1.0: freeze
usb usb2: freeze
hub 2-0:1.0: hub_suspend
ohci_hcd 0000:00:13.0: suspend root hub
usb usb2: usb suspend
 usbdev1.1: PM: suspend 0->1, parent usb1 already 2
 usbdev1.1_ep81: PM: suspend 0->1, parent 1-0:1.0 already 2
hub 1-0:1.0: PM: suspend 2-->1
hub 1-0:1.0: PM: suspend 2->1, parent usb1 already 2
 usbdev1.1_ep00: PM: suspend 0->1, parent usb1 already 2
usb usb1: PM: suspend 2-->1
ide-cdrom 0.0: freeze
psmouse serio4: freeze
serio serio3: freeze
serio serio2: freeze
serio serio1: freeze
atkbd serio0: freeze
i8042 i8042: freeze
sd 0:0:0:0: freeze
serial8250 serial8250: freeze
vesafb vesafb.0: freeze
pci_express 0000:00:06.0:pcie03: freeze
pci_express 0000:00:06.0:pcie01: freeze
pci_express 0000:00:06.0:pcie00: freeze
pci_express 0000:00:05.0:pcie03: freeze
pci_express 0000:00:05.0:pcie01: freeze
pci_express 0000:00:05.0:pcie00: freeze
pci_express 0000:00:04.0:pcie03: freeze
pci_express 0000:00:04.0:pcie01: freeze
pci_express 0000:00:04.0:pcie00: freeze
pcspkr pcspkr: freeze
sdhci 0000:02:04.3: freeze
ACPI: PCI interrupt for device 0000:02:04.3 disabled
tifm_7xx1 0000:02:04.2: freeze
ACPI: PCI interrupt for device 0000:02:04.2 disabled
ohci1394 0000:02:04.1: freeze
ohci1394 does not fully support suspend and resume yet
ieee1394: hpsb_bus_reset called while bus reset already in progress
yenta_cardbus 0000:02:04.0: freeze
tg3 0000:02:01.0: freeze
PM: Writing back config space on device 0000:02:01.0 at offset b (was 3ed173b, writing 30b0103c)
PM: Writing back config space on device 0000:02:01.0 at offset 3 (was 0, writing 4010)
PM: Writing back config space on device 0000:02:01.0 at offset 2 (was 2000000, writing 2000003)
PM: Writing back config space on device 0000:02:01.0 at offset 1 (was 2b00000, writing 2b00006)
PM: Writing back config space on device 0000:02:01.0 at offset 0 (was 3ed173b, writing 169c14e4)
bcm43xx 0000:30:00.0: freeze
bcm43xx: Suspending...
PM: Removing info for No Bus:hw_random
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 3/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 3/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
ACPI: PCI interrupt for device 0000:30:00.0 disabled
bcm43xx: Device suspended.
pci 0000:01:05.0: freeze
k8temp 0000:00:18.3: freeze
pci 0000:00:18.2: freeze
pci 0000:00:18.1: freeze
pci 0000:00:18.0: freeze
pci 0000:00:14.4: freeze
pci 0000:00:14.3: freeze
HDA Intel 0000:00:14.2: freeze
ACPI: PCI interrupt for device 0000:00:14.2 disabled
ATIIXP_IDE 0000:00:14.1: freeze
piix4_smbus 0000:00:14.0: freeze
ehci_hcd 0000:00:13.2: freeze
ACPI: PCI interrupt for device 0000:00:13.2 disabled
ehci_hcd 0000:00:13.2: --> PCI D3
ohci_hcd 0000:00:13.1: freeze
ACPI: PCI interrupt for device 0000:00:13.1 disabled
ohci_hcd 0000:00:13.1: --> PCI D0/legacy
ohci_hcd 0000:00:13.0: freeze
ACPI: PCI interrupt for device 0000:00:13.0 disabled
ohci_hcd 0000:00:13.0: --> PCI D0/legacy
sata_sil 0000:00:12.0: freeze
pcieport-driver 0000:00:06.0: freeze
pcieport-driver 0000:00:05.0: freeze
pcieport-driver 0000:00:04.0: freeze
pci 0000:00:01.0: freeze
pci 0000:00:00.0: freeze
ACPI Thermal Zone Driver thermal:03: freeze
ACPI Thermal Zone Driver thermal:02: freeze
ACPI Thermal Zone Driver thermal:01: freeze
ACPI Fan Driver PNP0C0B:03: freeze
ACPI Fan Driver PNP0C0B:02: freeze
ACPI: Transitioning device [C351] to D0
ACPI: Transitioning device [C351] to D0
ACPI Fan Driver PNP0C0B:01: freeze
ACPI: Transitioning device [C350] to D0
ACPI: Transitioning device [C350] to D0
ACPI Fan Driver PNP0C0B:00: freeze
ACPI: Transitioning device [C34F] to D0
ACPI: Transitioning device [C34F] to D0
ACPI Power Resource Driver power_resource:06: freeze
ACPI Power Resource Driver power_resource:05: freeze
ACPI Power Resource Driver power_resource:04: freeze
ACPI Power Resource Driver power_resource:03: freeze
acpi thermal:00: freeze
acpi PNP0C02:02: freeze
acpi PNP0C14:00: freeze
ACPI Button Driver PNP0C0D:00: freeze
ACPI Button Driver PNP0C0E:00: freeze
ACPI AC Adapter Driver ACPI0003:00: freeze
ACPI Battery Driver PNP0C0A:01: freeze
ACPI Battery Driver PNP0C0A:00: freeze
acpi HPQ0006:00: freeze
acpi PNP0C02:01: freeze
acpi device:49: freeze
acpi device:48: freeze
acpi device:47: freeze
acpi device:46: freeze
acpi device:45: freeze
acpi device:44: freeze
acpi device:43: freeze
acpi device:42: freeze
acpi device:41: freeze
acpi device:40: freeze
acpi device:3f: freeze
acpi device:3e: freeze
acpi device:3d: freeze
acpi device:3c: freeze
acpi device:3b: freeze
acpi device:3a: freeze
acpi device:39: freeze
acpi device:38: freeze
acpi device:37: freeze
acpi device:36: freeze
acpi device:35: freeze
acpi device:34: freeze
acpi device:33: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:07: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:06: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:05: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:04: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:03: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:02: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:01: freeze
ACPI PCI Interrupt Link Driver PNP0C0F:00: freeze
acpi device:32: freeze
acpi device:31: freeze
acpi device:30: freeze
acpi device:2f: freeze
acpi device:2e: freeze
acpi device:2d: freeze
acpi device:2c: freeze
acpi device:2b: freeze
acpi device:2a: freeze
acpi device:29: freeze
acpi device:28: freeze
acpi device:27: freeze
acpi device:26: freeze
acpi device:25: freeze
acpi device:24: freeze
acpi device:23: freeze
acpi device:22: freeze
acpi device:21: freeze
acpi device:20: freeze
acpi device:1f: freeze
acpi device:1e: freeze
acpi device:1d: freeze
acpi device:1c: freeze
acpi device:1b: freeze
acpi device:1a: freeze
acpi device:19: freeze
acpi device:18: freeze
acpi device:17: freeze
acpi device:16: freeze
acpi device:15: freeze
acpi device:14: freeze
acpi device:13: freeze
acpi device:12: freeze
acpi device:11: freeze
acpi device:10: freeze
acpi PNP0C02:00: freeze
acpi PNP0000:00: freeze
ACPI Power Resource Driver power_resource:02: freeze
acpi SYN0118:00: freeze
acpi PNP0303:00: freeze
acpi PNP0B00:00: freeze
acpi PNP0800:00: freeze
acpi PNP0200:00: freeze
acpi PNP0100:00: freeze
acpi PNP0C04:00: freeze
acpi IFX0102:00: freeze
ACPI Power Resource Driver power_resource:01: freeze
acpi PNP0401:00: freeze
ACPI container driver PNP0A06:00: freeze
ACPI Embedded Controller Driver PNP0C09:00: freeze
acpi device:0f: freeze
acpi device:0e: freeze
ACPI Power Resource Driver power_resource:00: freeze
acpi device:0d: freeze
acpi device:0c: freeze
acpi device:0b: freeze
acpi device:0a: freeze
acpi device:09: freeze
acpi device:08: freeze
acpi device:07: freeze
acpi device:06: freeze
acpi device:05: freeze
acpi device:04: freeze
acpi device:03: freeze
acpi device:02: freeze
acpi video:00: freeze
acpi device:01: freeze
ACPI PCI Root Bridge Driver PNP0A03:00: freeze
acpi PNP0C01:00: freeze
acpi device:00: freeze
ACPI Processor Driver ACPI0007:01: freeze
ACPI Processor Driver ACPI0007:00: freeze
ACPI Button Driver button_power:00: freeze
acpi acpi_system:00: freeze
Disabling non-boot CPUs ...
CPU 1 is now offline
SMP alternatives: switching to UP code
CPU1 is down
platform bluetooth: LATE freeze
i8042 i8042: LATE freeze
serial8250 serial8250: LATE freeze
vesafb vesafb.0: LATE freeze
pcspkr pcspkr: LATE freeze
sdhci 0000:02:04.3: LATE freeze
tifm_7xx1 0000:02:04.2: LATE freeze
ohci1394 0000:02:04.1: LATE freeze
yenta_cardbus 0000:02:04.0: LATE freeze
tg3 0000:02:01.0: LATE freeze
bcm43xx 0000:30:00.0: LATE freeze
pci 0000:01:05.0: LATE freeze
k8temp 0000:00:18.3: LATE freeze
pci 0000:00:18.2: LATE freeze
pci 0000:00:18.1: LATE freeze
pci 0000:00:18.0: LATE freeze
pci 0000:00:14.4: LATE freeze
pci 0000:00:14.3: LATE freeze
HDA Intel 0000:00:14.2: LATE freeze
ATIIXP_IDE 0000:00:14.1: LATE freeze
piix4_smbus 0000:00:14.0: LATE freeze
pcieport-driver 0000:00:06.0: LATE freeze
pcieport-driver 0000:00:05.0: LATE freeze
pcieport-driver 0000:00:04.0: LATE freeze
pci 0000:00:01.0: LATE freeze
pci 0000:00:00.0: LATE freeze
Extended CMOS year: 2000
swsusp: critical section: 
swsusp: Need to copy 95157 pages
swsusp: Normal pages needed: 95157 + 1024 + 20, available pages: 134073
Extended CMOS year: 2000
pci 0000:00:00.0: EARLY resume
pci 0000:00:01.0: EARLY resume
pcieport-driver 0000:00:04.0: EARLY resume
pcieport-driver 0000:00:05.0: EARLY resume
pcieport-driver 0000:00:06.0: EARLY resume
sata_sil 0000:00:12.0: EARLY resume
ohci_hcd 0000:00:13.0: EARLY resume
ohci_hcd 0000:00:13.1: EARLY resume
ehci_hcd 0000:00:13.2: EARLY resume
piix4_smbus 0000:00:14.0: EARLY resume
ATIIXP_IDE 0000:00:14.1: EARLY resume
HDA Intel 0000:00:14.2: EARLY resume
pci 0000:00:14.3: EARLY resume
pci 0000:00:14.4: EARLY resume
pci 0000:00:18.0: EARLY resume
pci 0000:00:18.1: EARLY resume
pci 0000:00:18.2: EARLY resume
k8temp 0000:00:18.3: EARLY resume
pci 0000:01:05.0: EARLY resume
bcm43xx 0000:30:00.0: EARLY resume
tg3 0000:02:01.0: EARLY resume
yenta_cardbus 0000:02:04.0: EARLY resume
ohci1394 0000:02:04.1: EARLY resume
tifm_7xx1 0000:02:04.2: EARLY resume
sdhci 0000:02:04.3: EARLY resume
pcspkr pcspkr: EARLY resume
vesafb vesafb.0: EARLY resume
serial8250 serial8250: EARLY resume
i8042 i8042: EARLY resume
platform bluetooth: EARLY resume
Enabling non-boot CPUs ...
SMP alternatives: switching to SMP code
Booting processor 1/2 APIC 0x1
Initializing CPU#1
Calibrating delay using timer specific routine.. 3990.23 BogoMIPS (lpj=7980462)
CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)
CPU: L2 Cache: 512K (64 bytes/line)
CPU: Physical Processor ID: 0
CPU: Processor Core ID: 1
AMD Turion(tm) 64 X2 Mobile Technology TL-60 stepping 02
CPU 1: Syncing TSC to CPU 0.
CPU 1: synchronized TSC with CPU 0 (last diff 0 cycles, maxerr 510 cycles)
powernow-k8:    0 : fid 0xc (2000 MHz), vid 0x13
powernow-k8:    1 : fid 0xa (1800 MHz), vid 0x15
powernow-k8:    2 : fid 0x8 (1600 MHz), vid 0x17
powernow-k8:    3 : fid 0x0 (800 MHz), vid 0x1e
CPU1 is up
acpi acpi_system:00: resuming
ACPI Button Driver button_power:00: resuming
ACPI Processor Driver ACPI0007:00: resuming
ACPI Processor Driver ACPI0007:01: resuming
acpi device:00: resuming
acpi PNP0C01:00: resuming
ACPI PCI Root Bridge Driver PNP0A03:00: resuming
acpi device:01: resuming
acpi video:00: resuming
acpi device:02: resuming
acpi device:03: resuming
acpi device:04: resuming
acpi device:05: resuming
acpi device:06: resuming
acpi device:07: resuming
acpi device:08: resuming
acpi device:09: resuming
acpi device:0a: resuming
acpi device:0b: resuming
acpi device:0c: resuming
acpi device:0d: resuming
ACPI Power Resource Driver power_resource:00: resuming
acpi device:0e: resuming
acpi device:0f: resuming
ACPI Embedded Controller Driver PNP0C09:00: resuming
ACPI container driver PNP0A06:00: resuming
acpi PNP0401:00: resuming
ACPI Power Resource Driver power_resource:01: resuming
acpi IFX0102:00: resuming
acpi PNP0C04:00: resuming
acpi PNP0100:00: resuming
acpi PNP0200:00: resuming
acpi PNP0800:00: resuming
acpi PNP0B00:00: resuming
acpi PNP0303:00: resuming
acpi SYN0118:00: resuming
ACPI Power Resource Driver power_resource:02: resuming
acpi PNP0000:00: resuming
acpi PNP0C02:00: resuming
acpi device:10: resuming
acpi device:11: resuming
acpi device:12: resuming
acpi device:13: resuming
acpi device:14: resuming
acpi device:15: resuming
acpi device:16: resuming
acpi device:17: resuming
acpi device:18: resuming
acpi device:19: resuming
acpi device:1a: resuming
acpi device:1b: resuming
acpi device:1c: resuming
acpi device:1d: resuming
acpi device:1e: resuming
acpi device:1f: resuming
acpi device:20: resuming
acpi device:21: resuming
acpi device:22: resuming
acpi device:23: resuming
acpi device:24: resuming
acpi device:25: resuming
acpi device:26: resuming
acpi device:27: resuming
acpi device:28: resuming
acpi device:29: resuming
acpi device:2a: resuming
acpi device:2b: resuming
acpi device:2c: resuming
acpi device:2d: resuming
acpi device:2e: resuming
acpi device:2f: resuming
acpi device:30: resuming
acpi device:31: resuming
acpi device:32: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:00: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:01: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:02: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:03: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:04: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:05: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:06: resuming
ACPI PCI Interrupt Link Driver PNP0C0F:07: resuming
acpi device:33: resuming
acpi device:34: resuming
acpi device:35: resuming
acpi device:36: resuming
acpi device:37: resuming
acpi device:38: resuming
acpi device:39: resuming
acpi device:3a: resuming
acpi device:3b: resuming
acpi device:3c: resuming
acpi device:3d: resuming
acpi device:3e: resuming
acpi device:3f: resuming
acpi device:40: resuming
acpi device:41: resuming
acpi device:42: resuming
acpi device:43: resuming
acpi device:44: resuming
acpi device:45: resuming
acpi device:46: resuming
acpi device:47: resuming
acpi device:48: resuming
acpi device:49: resuming
acpi PNP0C02:01: resuming
acpi HPQ0006:00: resuming
ACPI Battery Driver PNP0C0A:00: resuming
ACPI Battery Driver PNP0C0A:01: resuming
ACPI AC Adapter Driver ACPI0003:00: resuming
ACPI Button Driver PNP0C0E:00: resuming
ACPI Button Driver PNP0C0D:00: resuming
acpi PNP0C14:00: resuming
acpi PNP0C02:02: resuming
acpi thermal:00: resuming
ACPI Power Resource Driver power_resource:03: resuming
ACPI Power Resource Driver power_resource:04: resuming
ACPI Power Resource Driver power_resource:05: resuming
ACPI Power Resource Driver power_resource:06: resuming
ACPI Fan Driver PNP0C0B:00: resuming
ACPI: Transitioning device [C34F] to D0
ACPI: Transitioning device [C34F] to D0
ACPI Fan Driver PNP0C0B:01: resuming
ACPI: Transitioning device [C350] to D0
ACPI: Transitioning device [C350] to D0
ACPI Fan Driver PNP0C0B:02: resuming
ACPI: Transitioning device [C351] to D0
ACPI: Transitioning device [C351] to D0
ACPI Fan Driver PNP0C0B:03: resuming
ACPI Thermal Zone Driver thermal:01: resuming
ACPI Thermal Zone Driver thermal:02: resuming
ACPI Thermal Zone Driver thermal:03: resuming
pci 0000:00:00.0: resuming
pci 0000:00:01.0: resuming
pcieport-driver 0000:00:04.0: resuming
PCI: Setting latency timer of device 0000:00:04.0 to 64
pcieport-driver 0000:00:05.0: resuming
PCI: Setting latency timer of device 0000:00:05.0 to 64
pcieport-driver 0000:00:06.0: resuming
PCI: Setting latency timer of device 0000:00:06.0 to 64
sata_sil 0000:00:12.0: resuming
ohci_hcd 0000:00:13.0: resuming
ohci_hcd 0000:00:13.0: PCI legacy resume
ACPI: PCI Interrupt 0000:00:13.0[A] -> GSI 19 (level, low) -> IRQ 19
ohci_hcd 0000:00:13.1: resuming
ohci_hcd 0000:00:13.1: PCI legacy resume
ACPI: PCI Interrupt 0000:00:13.1[A] -> GSI 19 (level, low) -> IRQ 19
ehci_hcd 0000:00:13.2: resuming
ehci_hcd 0000:00:13.2: PCI D0, from previous PCI D3
ACPI: PCI Interrupt 0000:00:13.2[A] -> GSI 19 (level, low) -> IRQ 19
PM: Writing back config space on device 0000:00:13.2 at offset 1 (was 2b00007, writing 2b00017)
ehci_hcd 0000:00:13.2: lost power, restarting
usb usb1: root hub lost power or was reset
ehci_hcd 0000:00:13.2: reset command 080002 (park)=0 ithresh=8 period=1024 Reset HALT
ehci_hcd 0000:00:13.2: MWI active
piix4_smbus 0000:00:14.0: resuming
ATIIXP_IDE 0000:00:14.1: resuming
ACPI: PCI Interrupt 0000:00:14.1[A] -> GSI 16 (level, low) -> IRQ 16
HDA Intel 0000:00:14.2: resuming
PM: Writing back config space on device 0000:00:14.2 at offset f (was 10a, writing a)
PM: Writing back config space on device 0000:00:14.2 at offset 1 (was 4100006, writing 4100002)
ACPI: PCI Interrupt 0000:00:14.2[A] -> GSI 16 (level, low) -> IRQ 16
pci 0000:00:14.3: resuming
pci 0000:00:14.4: resuming
PM: Writing back config space on device 0000:00:14.4 at offset 6 (was 40030200, writing 40060200)
pci 0000:00:18.0: resuming
pci 0000:00:18.1: resuming
pci 0000:00:18.2: resuming
k8temp 0000:00:18.3: resuming
pci 0000:01:05.0: resuming
bcm43xx 0000:30:00.0: resuming
bcm43xx: Resuming...
ACPI: PCI Interrupt 0000:30:00.0[A] -> GSI 18 (level, low) -> IRQ 18
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
ata2: SATA link down (SStatus 0 SControl 300)
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
PM: Adding info for No Bus:hw_random
bcm43xx: Device resumed.
tg3 0000:02:01.0: resuming
PM: Writing back config space on device 0000:02:01.0 at offset b (was 3ed173b, writing 30b0103c)
PM: Writing back config space on device 0000:02:01.0 at offset 3 (was 0, writing 4010)
PM: Writing back config space on device 0000:02:01.0 at offset 2 (was 2000000, writing 2000003)
PM: Writing back config space on device 0000:02:01.0 at offset 1 (was 2b00000, writing 2b00006)
PM: Writing back config space on device 0000:02:01.0 at offset 0 (was 3ed173b, writing 169c14e4)
SoftMAC: Associate: Scanning for networks first.
yenta_cardbus 0000:02:04.0: resuming
PM: Writing back config space on device 0000:02:04.0 at offset f (was 3c4010a, writing 5c0010a)
PM: Writing back config space on device 0000:02:04.0 at offset 3 (was 824010, writing 82a810)
ohci1394 0000:02:04.1: resuming
ohci1394: fw-host0: OHCI-1394 1.1 (PCI): IRQ=[20]  MMIO=[d4011000-d40117ff]  Max Packet=[2048]  IR/IT contexts=[4/8]
tifm_7xx1 0000:02:04.2: resuming
ACPI: PCI Interrupt 0000:02:04.2[A] -> GSI 20 (level, low) -> IRQ 20
sdhci 0000:02:04.3: resuming
ACPI: PCI Interrupt 0000:02:04.3[A] -> GSI 20 (level, low) -> IRQ 20
pcspkr pcspkr: resuming
pci_express 0000:00:04.0:pcie00: resuming
pci_express 0000:00:04.0:pcie01: resuming
pci_express 0000:00:04.0:pcie03: resuming
pci_express 0000:00:05.0:pcie00: resuming
pci_express 0000:00:05.0:pcie01: resuming
pci_express 0000:00:05.0:pcie03: resuming
pci_express 0000:00:06.0:pcie00: resuming
pci_express 0000:00:06.0:pcie01: resuming
pci_express 0000:00:06.0:pcie03: resuming
vesafb vesafb.0: resuming
serial8250 serial8250: resuming
sd 0:0:0:0: resuming
i8042 i8042: resuming
atkbd serio0: resuming
serio serio1: resuming
serio serio2: resuming
serio serio3: resuming
psmouse serio4: resuming
synaptics reset failed
synaptics reset failed
synaptics reset failed
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
ide-cdrom 0.0: resuming
usb usb1: resuming
usb usb1: usb resume
usb usb1: finish resume
hub 1-0:1.0: hub_resume
ehci_hcd 0000:00:13.2: resume root hub after power loss
usb usb2: resuming
usb usb2: usb resume
usb usb2: finish resume
hub 2-0:1.0: hub_resume
ohci_hcd 0000:00:13.0: BIOS/SMM active, control 008
usb usb2: root hub lost power or was reset
ohci_hcd 0000:00:13.0: resetting from state 'reset', control = 0x8
ohci_hcd 0000:00:13.0: OHCI controller state
ohci_hcd 0000:00:13.0: OHCI 1.0, NO legacy support registers
ohci_hcd 0000:00:13.0: control 0x083 HCFS=operational CBSR=3
ohci_hcd 0000:00:13.0: cmdstatus 0x00000 SOC=0
ohci_hcd 0000:00:13.0: intrstatus 0x00000004 SF
ohci_hcd 0000:00:13.0: intrenable 0x8000005a MIE RHSC UE RD WDH
ohci_hcd 0000:00:13.0: hcca frame #0005
ohci_hcd 0000:00:13.0: roothub.a 02000204 POTPGT=2 NPS NDP=4(4)
ohci_hcd 0000:00:13.0: roothub.b 00000000 PPCM=0000 DR=0000
ohci_hcd 0000:00:13.0: roothub.status 00008000 DRWE
ohci_hcd 0000:00:13.0: roothub.portstatus [0] 0x00000100 PPS
ohci_hcd 0000:00:13.0: roothub.portstatus [1] 0x00010100 CSC PPS
ohci_hcd 0000:00:13.0: roothub.portstatus [2] 0x00000100 PPS
ohci_hcd 0000:00:13.0: roothub.portstatus [3] 0x00000100 PPS
ohci_hcd 0000:00:13.0: restart complete
hub 2-0:1.0: resuming
usb usb3: resuming
usb usb3: usb resume
usb usb3: finish resume
hub 3-0:1.0: hub_resume
ohci_hcd 0000:00:13.1: BIOS/SMM active, control 008
usb usb3: root hub lost power or was reset
ohci_hcd 0000:00:13.1: resetting from state 'reset', control = 0x8
ohci_hcd 0000:00:13.1: OHCI controller state
ohci_hcd 0000:00:13.1: OHCI 1.0, NO legacy support registers
ohci_hcd 0000:00:13.1: control 0x083 HCFS=operational CBSR=3
ohci_hcd 0000:00:13.1: cmdstatus 0x00000 SOC=0
ohci_hcd 0000:00:13.1: intrstatus 0x00000004 SF
ohci_hcd 0000:00:13.1: intrenable 0x8000005a MIE RHSC UE RD WDH
ohci_hcd 0000:00:13.1: hcca frame #0005
ohci_hcd 0000:00:13.1: roothub.a 02000204 POTPGT=2 NPS NDP=4(4)
ohci_hcd 0000:00:13.1: roothub.b 00000000 PPCM=0000 DR=0000
ohci_hcd 0000:00:13.1: roothub.status 00008000 DRWE
ohci_hcd 0000:00:13.1: roothub.portstatus [0] 0x00010100 CSC PPS
ohci_hcd 0000:00:13.1: roothub.portstatus [1] 0x00000100 PPS
ohci_hcd 0000:00:13.1: roothub.portstatus [2] 0x00000100 PPS
ohci_hcd 0000:00:13.1: roothub.portstatus [3] 0x00010100 CSC PPS
ohci_hcd 0000:00:13.1: restart complete
hub 3-0:1.0: resuming
platform bluetooth: resuming
serio serio6: resuming
usb 2-2: resuming
 usbdev2.10_ep00: PM: resume from 0, parent 2-2 still 1
hci_usb 2-2:1.0: PM: resume from 1, parent 2-2 still 1
hci_usb 2-2:1.0: resuming
 hci0: PM: resume from 0, parent 2-2:1.0 still 1
 usbdev2.10_ep81: PM: resume from 0, parent 2-2:1.0 still 1
 usbdev2.10_ep82: PM: resume from 0, parent 2-2:1.0 still 1
 usbdev2.10_ep02: PM: resume from 0, parent 2-2:1.0 still 1
hci_usb 2-2:1.1: PM: resume from 1, parent 2-2 still 1
hci_usb 2-2:1.1: resuming
 usbdev2.10_ep83: PM: resume from 0, parent 2-2:1.1 still 1
 usbdev2.10_ep03: PM: resume from 0, parent 2-2:1.1 still 1
usb 2-2:1.2: PM: resume from 1, parent 2-2 still 1
usb 2-2:1.2: resuming
 usbdev2.10_ep84: PM: resume from 0, parent 2-2:1.2 still 1
 usbdev2.10_ep04: PM: resume from 0, parent 2-2:1.2 still 1
usb 2-2:1.3: PM: resume from 1, parent 2-2 still 1
usb 2-2:1.3: resuming
 usbdev2.10: PM: resume from 0, parent 2-2 still 1
 usbdev3.18_ep00: PM: resume from 0, parent 3-1 still 2
 usbdev3.18_ep81: PM: resume from 0, parent 3-1:1.0 still 2
 usbdev3.18_ep02: PM: resume from 0, parent 3-1:1.0 still 2
 usbdev3.18: PM: resume from 0, parent 3-1 still 2
usb 3-4: resuming
 usbdev3.19_ep00: PM: resume from 0, parent 3-4 still 1
usbhid 3-4:1.0: PM: resume from 1, parent 3-4 still 1
usbhid 3-4:1.0: resuming
 usbdev3.19_ep81: PM: resume from 0, parent 3-4:1.0 still 1
 usbdev3.19: PM: resume from 0, parent 3-4 still 1
Restarting tasks ... <7>hub 2-0:1.0: state 7 ports 4 chg 0004 evt 001e
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [0] = 0x00010100 CSC PPS
hub 2-0:1.0: port 1, status 0100, change 0001, 12 Mb/s
done.
PM: Removing info for No Bus:vcs8
PM: Removing info for No Bus:vcsa8
ata1: SATA link up 1.5 Gbps (SStatus 113 SControl 300)
ata1.00: configured for UDMA/100
SCSI device sda: 156301488 512-byte hdwr sectors (80026 MB)
sda: Write Protect is off
sda: Mode Sense: 00 3a 00 00
SCSI device sda: write cache: enabled, read cache: enabled, doesn't support DPO or FUA
hub 2-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00010100 CSC PPS
hub 2-0:1.0: port 2, status 0100, change 0001, 12 Mb/s
usb 2-2: USB disconnect, address 10
usb 2-2: unregistering device
usb 2-2: usb_disable_device nuking all URBs
usb 2-2: unregistering interface 2-2:1.0
PM: Removing info for No Bus:usbdev2.10_ep81
 usbdev2.10_ep81: ep_device_release called for usbdev2.10_ep81
PM: Removing info for No Bus:usbdev2.10_ep82
 usbdev2.10_ep82: ep_device_release called for usbdev2.10_ep82
PM: Removing info for No Bus:usbdev2.10_ep02
 usbdev2.10_ep02: ep_device_release called for usbdev2.10_ep02
PM: Removing info for No Bus:hci0
PM: Removing info for usb:2-2:1.0
usb 2-2:1.0: uevent
usb 2-2: unregistering interface 2-2:1.1
PM: Removing info for No Bus:usbdev2.10_ep83
 usbdev2.10_ep83: ep_device_release called for usbdev2.10_ep83
PM: Removing info for No Bus:usbdev2.10_ep03
 usbdev2.10_ep03: ep_device_release called for usbdev2.10_ep03
PM: Removing info for usb:2-2:1.1
usb 2-2:1.1: uevent
usb 2-2: unregistering interface 2-2:1.2
PM: Removing info for No Bus:usbdev2.10_ep84
 usbdev2.10_ep84: ep_device_release called for usbdev2.10_ep84
PM: Removing info for No Bus:usbdev2.10_ep04
 usbdev2.10_ep04: ep_device_release called for usbdev2.10_ep04
PM: Removing info for usb:2-2:1.2
usb 2-2:1.2: uevent
usb 2-2: unregistering interface 2-2:1.3
PM: Removing info for usb:2-2:1.3
usb 2-2:1.3: uevent
PM: Removing info for No Bus:usbdev2.10
PM: Removing info for No Bus:usbdev2.10_ep00
 usbdev2.10_ep00: ep_device_release called for usbdev2.10_ep00
PM: Removing info for usb:2-2
usb 2-2: uevent
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
hub 2-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [2] = 0x00010100 CSC PPS
hub 2-0:1.0: port 3, status 0100, change 0001, 12 Mb/s
hub 2-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [3] = 0x00010100 CSC PPS
hub 2-0:1.0: port 4, status 0100, change 0001, 12 Mb/s
hub 2-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x100
hub 3-0:1.0: state 7 ports 4 chg 0012 evt 001e
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00010100 CSC PPS
hub 3-0:1.0: port 1, status 0100, change 0001, 12 Mb/s
usb 3-1: USB disconnect, address 18
usb 3-1: unregistering device
usb 3-1: usb_disable_device nuking all URBs
usb 3-1: unregistering interface 3-1:1.0
PM: Removing info for No Bus:usbdev3.18_ep81
 usbdev3.18_ep81: ep_device_release called for usbdev3.18_ep81
PM: Removing info for No Bus:usbdev3.18_ep02
 usbdev3.18_ep02: ep_device_release called for usbdev3.18_ep02
PM: Removing info for usb:3-1:1.0
usb 3-1:1.0: uevent
PM: Removing info for No Bus:usbdev3.18
PM: Removing info for No Bus:usbdev3.18_ep00
 usbdev3.18_ep00: ep_device_release called for usbdev3.18_ep00
PM: Removing info for usb:3-1
usb 3-1: uevent
hub 3-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [1] = 0x00010100 CSC PPS
hub 3-0:1.0: port 2, status 0100, change 0001, 12 Mb/s
hub 3-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [2] = 0x00010100 CSC PPS
hub 3-0:1.0: port 3, status 0100, change 0001, 12 Mb/s
hub 3-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x100
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00010100 CSC PPS
hub 3-0:1.0: port 4, status 0100, change 0001, 12 Mb/s
usb 3-4: USB disconnect, address 19
usb 3-4: unregistering device
usb 3-4: usb_disable_device nuking all URBs
usb 3-4: unregistering interface 3-4:1.0
PM: Removing info for No Bus:usbdev3.19_ep81
 usbdev3.19_ep81: ep_device_release called for usbdev3.19_ep81
PM: Removing info for usb:3-4:1.0
usb 3-4:1.0: uevent
PM: Removing info for No Bus:usbdev3.19
PM: Removing info for No Bus:usbdev3.19_ep00
 usbdev3.19_ep00: ep_device_release called for usbdev3.19_ep00
PM: Removing info for usb:3-4
usb 3-4: uevent
hub 3-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x100
hub 1-0:1.0: state 7 ports 8 chg 0000 evt 010c
ehci_hcd 0000:00:13.2: GetStatus port 2 status 001803 POWER sig=j CSC CONNECT
hub 1-0:1.0: port 2, status 0501, change 0001, 480 Mb/s
hub 1-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x501
ehci_hcd 0000:00:13.2: port 2 full speed --> companion
ehci_hcd 0000:00:13.2: GetStatus port 2 status 003801 POWER OWNER sig=j CONNECT
hub 1-0:1.0: port 2 not reset yet, waiting 50ms
ehci_hcd 0000:00:13.2: GetStatus port 2 status 003002 POWER OWNER sig=se0 CSC
ehci_hcd 0000:00:13.2: GetStatus port 3 status 001803 POWER sig=j CSC CONNECT
hub 1-0:1.0: port 3, status 0501, change 0001, 480 Mb/s
hub 1-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x501
ehci_hcd 0000:00:13.2: port 3 full speed --> companion
ehci_hcd 0000:00:13.2: GetStatus port 3 status 003801 POWER OWNER sig=j CONNECT
hub 1-0:1.0: port 3 not reset yet, waiting 50ms
ehci_hcd 0000:00:13.2: GetStatus port 3 status 003002 POWER OWNER sig=se0 CSC
ehci_hcd 0000:00:13.2: GetStatus port 8 status 001403 POWER sig=k CSC CONNECT
hub 1-0:1.0: port 8, status 0501, change 0001, 480 Mb/s
hub 1-0:1.0: debounce: port 8: total 100ms stable 100ms status 0x501
ehci_hcd 0000:00:13.2: port 8 low speed --> companion
ehci_hcd 0000:00:13.2: GetStatus port 8 status 003002 POWER OWNER sig=se0 CSC
hub 2-0:1.0: state 7 ports 4 chg 0000 evt 0004
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00010101 CSC PPS CCS
hub 2-0:1.0: port 2, status 0101, change 0001, 12 Mb/s
hub 2-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x101
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00100103 PRSC PPS PES CCS
usb 2-2: new full speed USB device using ohci_hcd and address 11
ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00100103 PRSC PPS PES CCS
usb 2-2: skipped 1 descriptor after interface
usb 2-2: default language 0x0409
usb 2-2: new device strings: Mfr=1, Product=2, SerialNumber=0
usb 2-2: Product: HP Integrated Module
usb 2-2: Manufacturer: Broadcom Corp
PM: Adding info for usb:2-2
usb 2-2: uevent
usb 2-2: usb_probe_device
PM: Adding info for No Bus:usbdev2.11_ep00
usb 2-2: configuration #1 chosen from 1 choice
usb 2-2: adding 2-2:1.0 (config #1, interface 0)
PM: Adding info for usb:2-2:1.0
usb 2-2:1.0: uevent
hci_usb 2-2:1.0: usb_probe_interface
hci_usb 2-2:1.0: usb_probe_interface - got id
PM: Adding info for No Bus:hci0
PM: Adding info for No Bus:usbdev2.11_ep81
PM: Adding info for No Bus:usbdev2.11_ep82
PM: Adding info for No Bus:usbdev2.11_ep02
usb 2-2: adding 2-2:1.1 (config #1, interface 1)
PM: Adding info for usb:2-2:1.1
usb 2-2:1.1: uevent
PM: Adding info for No Bus:usbdev2.11_ep83
PM: Adding info for No Bus:usbdev2.11_ep03
usb 2-2: adding 2-2:1.2 (config #1, interface 2)
PM: Adding info for usb:2-2:1.2
usb 2-2:1.2: uevent
hci_usb 2-2:1.2: usb_probe_interface
hci_usb 2-2:1.2: usb_probe_interface - got id
PM: Adding info for No Bus:usbdev2.11_ep84
PM: Adding info for No Bus:usbdev2.11_ep04
usb 2-2: adding 2-2:1.3 (config #1, interface 3)
PM: Adding info for usb:2-2:1.3
usb 2-2:1.3: uevent
hci_usb 2-2:1.3: usb_probe_interface
hci_usb 2-2:1.3: usb_probe_interface - got id
PM: Adding info for No Bus:usbdev2.11
drivers/usb/core/inode.c: creating file '011'
hub 3-0:1.0: state 7 ports 4 chg 0000 evt 0012
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00010101 CSC PPS CCS
hub 3-0:1.0: port 1, status 0101, change 0001, 12 Mb/s
hub 3-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x101
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00100103 PRSC PPS PES CCS
usb 3-1: new full speed USB device using ohci_hcd and address 20
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00100103 PRSC PPS PES CCS
usb 3-1: ep0 maxpacket = 8
usb 3-1: default language 0x0409
usb 3-1: new device strings: Mfr=0, Product=1, SerialNumber=0
usb 3-1: Product: Fingerprint Sensor
PM: Adding info for usb:3-1
usb 3-1: uevent
usb 3-1: usb_probe_device
PM: Adding info for No Bus:usbdev3.20_ep00
usb 3-1: configuration #1 chosen from 1 choice
usb 3-1: adding 3-1:1.0 (config #1, interface 0)
PM: Adding info for usb:3-1:1.0
usb 3-1:1.0: uevent
PM: Adding info for No Bus:usbdev3.20_ep81
PM: Adding info for No Bus:usbdev3.20_ep02
PM: Adding info for No Bus:usbdev3.20
drivers/usb/core/inode.c: creating file '020'
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00010301 CSC LSDA PPS CCS
hub 3-0:1.0: port 4, status 0301, change 0001, 1.5 Mb/s
hub 3-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x301
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00100303 PRSC LSDA PPS PES CCS
usb 3-4: new low speed USB device using ohci_hcd and address 21
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00100303 PRSC LSDA PPS PES CCS
usb 3-4: skipped 1 descriptor after interface
usb 3-4: default language 0x0409
usb 3-4: new device strings: Mfr=1, Product=2, SerialNumber=0
usb 3-4: Product: USB Receiver
usb 3-4: Manufacturer: Logitech
PM: Adding info for usb:3-4
usb 3-4: uevent
usb 3-4: usb_probe_device
PM: Adding info for No Bus:usbdev3.21_ep00
usb 3-4: configuration #1 chosen from 1 choice
usb 3-4: adding 3-4:1.0 (config #1, interface 0)
PM: Adding info for usb:3-4:1.0
usb 3-4:1.0: uevent
usbhid 3-4:1.0: usb_probe_interface
usbhid 3-4:1.0: usb_probe_interface - got id
  INPUT[INPUT]
    Field(0)
      Physical(GenericDesktop.Pointer)
      Usage(8)
        Button.0001
        Button.0002
        Button.0003
        Button.0004
        Button.0005
        Button.0006
        Button.0007
        Button.0008
      Logical Minimum(0)
      Logical Maximum(1)
      Report Size(1)
      Report Count(8)
      Report Offset(0)
      Flags( Variable Absolute )
    Field(1)
      Physical(GenericDesktop.Pointer)
      Usage(3)
        GenericDesktop.X
        GenericDesktop.Y
        GenericDesktop.Wheel
      Logical Minimum(-127)
      Logical Maximum(127)
      Report Size(8)
      Report Count(3)
      Report Offset(8)
      Flags( Variable Relative )
    Field(2)
      Physical(GenericDesktop.Pointer)
      Usage(1)
        Consumer.HorizontalWheel
      Logical Minimum(-127)
      Logical Maximum(127)
      Report Size(8)
      Report Count(1)
      Report Offset(32)
      Flags( Variable Relative )
    Field(3)
      Usage(8)
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
        LED.GenericIndicator
      Logical Minimum(0)
      Logical Maximum(1)
      Report Size(1)
      Report Count(8)
      Report Offset(40)
      Flags( Variable Absolute )
    Field(4)
      Usage(8)
        Button.0009
        Button.000a
        Button.000b
        Button.000c
        Button.000d
        Button.000e
        Button.000f
        Button.0010
      Logical Minimum(0)
      Logical Maximum(1)
      Report Size(1)
      Report Count(8)
      Report Offset(48)
      Flags( Variable Absolute )
  FEATURE[FEATURE]
    Field(0)
      Usage(1)
        GenericDesktop.MotionWakeup
      Logical Minimum(0)
      Logical Maximum(1)
      Report Size(1)
      Report Count(1)
      Report Offset(0)
      Flags( Variable Absolute NoPrefferedState )
Mapping: Button.0001 ---> Key.LeftBtn
Mapping: Button.0002 ---> Key.RightBtn
Mapping: Button.0003 ---> Key.MiddleBtn
Mapping: Button.0004 ---> Key.SideBtn
Mapping: Button.0005 ---> Key.ExtraBtn
Mapping: Button.0006 ---> Key.ForwardBtn
Mapping: Button.0007 ---> Key.BackBtn
Mapping: Button.0008 ---> Key.TaskBtn
Mapping: GenericDesktop.X ---> Relative.X
Mapping: GenericDesktop.Y ---> Relative.Y
Mapping: GenericDesktop.Wheel ---> Relative.Wheel
Mapping: Consumer.HorizontalWheel ---> Relative.HWheel
Mapping: LED.GenericIndicator ---> LED.Misc
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: LED.GenericIndicator ---> LED.?
Mapping: Button.0009 ---> Key.?
Mapping: Button.000a ---> Key.?
Mapping: Button.000b ---> Key.?
Mapping: Button.000c ---> Key.?
Mapping: Button.000d ---> Key.?
Mapping: Button.000e ---> Key.?
Mapping: Button.000f ---> Key.?
Mapping: Button.0010 ---> Key.?
input: Logitech USB Receiver as /class/input/input16
hid-pidff: starting pid init
hid-pidff: not a PID device, no output report
input: USB HID v1.10 Mouse [Logitech USB Receiver] on usb-0000:00:13.1-4
PM: Adding info for No Bus:usbdev3.21_ep81
PM: Adding info for No Bus:usbdev3.21
drivers/usb/core/inode.c: creating file '021'
hub 1-0:1.0: state 7 ports 8 chg 0000 evt 0100
hub 2-0:1.0: state 7 ports 4 chg 0000 evt 0004
hub 3-0:1.0: state 7 ports 4 chg 0000 evt 0002
usb 3-1: usb auto-suspend
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
hub 1-0:1.0: hub_suspend
usb usb1: usb auto-suspend
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
PM: Removing info for No Bus:hw_random
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 0/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 56/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
PM: Adding info for No Bus:0000:30:00.0
PM: Removing info for No Bus:0000:30:00.0
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
usb 3-1: usb auto-resume
ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00040103 PSSC PPS PES CCS
usb 3-1: finish resume
usb usb1: usb auto-resume
usb usb1: finish resume
hub 1-0:1.0: hub_resume
ehci_hcd 0000:00:13.2: resume root hub
hub 1-0:1.0: state 7 ports 8 chg 0000 evt 0000
usb 3-1: usb auto-suspend
hub 1-0:1.0: hub_suspend
usb usb1: usb auto-suspend


From mb at bu3sch.de  Sun Feb 11 15:14:04 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 15:14:04 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111502.19545.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111407.08099.mb@bu3sch.de> <200702111502.19545.rjw@sisk.pl>
Message-ID: <200702111514.04893.mb@bu3sch.de>

On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
> On Sunday, 11 February 2007 14:07, Michael Buesch wrote:
> > On Sunday 11 February 2007 13:56, Rafael J. Wysocki wrote:
> > > On Saturday, 10 February 2007 21:33, Larry Finger wrote:
> > > > Rafael,
> > > > 
> > > > Rafael J. Wysocki wrote:
> > > > > 
> > > > > I'm running with this patch applied right now, but the association is lost
> > > > > after the resume anyway.  I have to reload bcm43xx to make it associate with
> > > > > the AP again (no big deal).
> > > > 
> > > > 
> > > > Please send me the output of iwconfig and ifconfig after the resume, but before you reload bcm43xx.
> > > 
> > > albercik:~ # iwconfig
> > > lo        no wireless extensions.
> > > 
> > > eth0      no wireless extensions.
> > > 
> > > eth1      IEEE 802.11b/g  ESSID:"DI524"  Nickname:"Broadcom 4311"
> > >           Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
> > >           Bit Rate=1 Mb/s   Tx-Power=18 dBm
> > >           RTS thr:off   Fragment thr:off
> > >           Encryption key:off
> > >           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
> > >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> > >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> > > 
> > > albercik:~ # ifconfig eth1
> > > eth1      Link encap:Ethernet  HWaddr 00:14:A5:BE:95:31
> > >           inet addr:192.168.100.101  Bcast:192.168.100.255  Mask:255.255.255.0
> > >           inet6 addr: fe80::214:a5ff:febe:9531/64 Scope:Link
> > >           UP BROADCAST MULTICAST  MTU:1500  Metric:1
> > >           RX packets:5137 errors:0 dropped:120 overruns:0 frame:0
> > >           TX packets:5703 errors:0 dropped:0 overruns:0 carrier:0
> > >           collisions:0 txqueuelen:1000
> > >           RX bytes:4569090 (4.3 Mb)  TX bytes:156826797 (149.5 Mb)
> > >           Interrupt:18
> > > 
> > > albercik:~ # ifconfig eth1 down
> > > albercik:~ # ifconfig eth1 up
> > > SIOCSIFFLAGS: No such device
> > 		^^^^^
> > 
> > I'd like to see dmesg, please.
> 
> Appended.  It covers one suspend-resume cycle (suspend to disk).  I have
> filtered HID-related messages out of it.
> 
> Greetings,
> Rafael
> 
> 
> ton.000e = 0
> usb 3-1: usb auto-resume
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00040103 PSSC PPS PES CCS
> usb 3-1: finish resume
> usb usb1: usb auto-resume
> usb usb1: finish resume
> hub 1-0:1.0: hub_resume
> ehci_hcd 0000:00:13.2: resume root hub
> hub 1-0:1.0: state 7 ports 8 chg 0000 evt 0000
> usb 3-1: usb auto-suspend
> hub 1-0:1.0: hub_suspend
> usb usb1: usb auto-suspend
> PM: Adding info for No Bus:vcs8
> PM: Adding info for No Bus:vcsa8
> SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
> Stopping tasks ... done.
> Shrinking memory...  -\|/-\|/-\done (113015 pages freed)
> Freed 452060 kbytes in 1.44 seconds (313.93 MB/s)
> Suspending console(s)
> usbhid 3-4:1.0: freeze
> usb 3-4: freeze
> usbhid 3-4:1.0: suspend
> usb 3-4: usb suspend
>  usbdev3.18: PM: suspend 0->1, parent 3-1 already 2
>  usbdev3.18_ep02: PM: suspend 0->1, parent 3-1:1.0 already 2
>  usbdev3.18_ep81: PM: suspend 0->1, parent 3-1:1.0 already 2
> usb 3-1:1.0: PM: suspend 2-->1
> usb 3-1:1.0: PM: suspend 2->1, parent 3-1 already 2
>  usbdev3.18_ep00: PM: suspend 0->1, parent 3-1 already 2
> usb 3-1: PM: suspend 2-->1
> usb 2-2:1.3: freeze
> usb 2-2:1.2: freeze
> hci_usb 2-2:1.1: freeze
> hci_usb 2-2:1.0: freeze
> usb 2-2: freeze
> usb 2-2: usb suspend
> serio serio6: freeze
> platform bluetooth: freeze
> hub 3-0:1.0: freeze
> usb usb3: freeze
> hub 3-0:1.0: hub_suspend
> ohci_hcd 0000:00:13.1: suspend root hub
> usb usb3: usb suspend
> hub 2-0:1.0: freeze
> usb usb2: freeze
> hub 2-0:1.0: hub_suspend
> ohci_hcd 0000:00:13.0: suspend root hub
> usb usb2: usb suspend
>  usbdev1.1: PM: suspend 0->1, parent usb1 already 2
>  usbdev1.1_ep81: PM: suspend 0->1, parent 1-0:1.0 already 2
> hub 1-0:1.0: PM: suspend 2-->1
> hub 1-0:1.0: PM: suspend 2->1, parent usb1 already 2
>  usbdev1.1_ep00: PM: suspend 0->1, parent usb1 already 2
> usb usb1: PM: suspend 2-->1
> ide-cdrom 0.0: freeze
> psmouse serio4: freeze
> serio serio3: freeze
> serio serio2: freeze
> serio serio1: freeze
> atkbd serio0: freeze
> i8042 i8042: freeze
> sd 0:0:0:0: freeze
> serial8250 serial8250: freeze
> vesafb vesafb.0: freeze
> pci_express 0000:00:06.0:pcie03: freeze
> pci_express 0000:00:06.0:pcie01: freeze
> pci_express 0000:00:06.0:pcie00: freeze
> pci_express 0000:00:05.0:pcie03: freeze
> pci_express 0000:00:05.0:pcie01: freeze
> pci_express 0000:00:05.0:pcie00: freeze
> pci_express 0000:00:04.0:pcie03: freeze
> pci_express 0000:00:04.0:pcie01: freeze
> pci_express 0000:00:04.0:pcie00: freeze
> pcspkr pcspkr: freeze
> sdhci 0000:02:04.3: freeze
> ACPI: PCI interrupt for device 0000:02:04.3 disabled
> tifm_7xx1 0000:02:04.2: freeze
> ACPI: PCI interrupt for device 0000:02:04.2 disabled
> ohci1394 0000:02:04.1: freeze
> ohci1394 does not fully support suspend and resume yet
> ieee1394: hpsb_bus_reset called while bus reset already in progress
> yenta_cardbus 0000:02:04.0: freeze
> tg3 0000:02:01.0: freeze
> PM: Writing back config space on device 0000:02:01.0 at offset b (was 3ed173b, writing 30b0103c)
> PM: Writing back config space on device 0000:02:01.0 at offset 3 (was 0, writing 4010)
> PM: Writing back config space on device 0000:02:01.0 at offset 2 (was 2000000, writing 2000003)
> PM: Writing back config space on device 0000:02:01.0 at offset 1 (was 2b00000, writing 2b00006)
> PM: Writing back config space on device 0000:02:01.0 at offset 0 (was 3ed173b, writing 169c14e4)
> bcm43xx 0000:30:00.0: freeze
> bcm43xx: Suspending...
> PM: Removing info for No Bus:hw_random
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 3/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 3/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> ACPI: PCI interrupt for device 0000:30:00.0 disabled
> bcm43xx: Device suspended.
> pci 0000:01:05.0: freeze
> k8temp 0000:00:18.3: freeze
> pci 0000:00:18.2: freeze
> pci 0000:00:18.1: freeze
> pci 0000:00:18.0: freeze
> pci 0000:00:14.4: freeze
> pci 0000:00:14.3: freeze
> HDA Intel 0000:00:14.2: freeze
> ACPI: PCI interrupt for device 0000:00:14.2 disabled
> ATIIXP_IDE 0000:00:14.1: freeze
> piix4_smbus 0000:00:14.0: freeze
> ehci_hcd 0000:00:13.2: freeze
> ACPI: PCI interrupt for device 0000:00:13.2 disabled
> ehci_hcd 0000:00:13.2: --> PCI D3
> ohci_hcd 0000:00:13.1: freeze
> ACPI: PCI interrupt for device 0000:00:13.1 disabled
> ohci_hcd 0000:00:13.1: --> PCI D0/legacy
> ohci_hcd 0000:00:13.0: freeze
> ACPI: PCI interrupt for device 0000:00:13.0 disabled
> ohci_hcd 0000:00:13.0: --> PCI D0/legacy
> sata_sil 0000:00:12.0: freeze
> pcieport-driver 0000:00:06.0: freeze
> pcieport-driver 0000:00:05.0: freeze
> pcieport-driver 0000:00:04.0: freeze
> pci 0000:00:01.0: freeze
> pci 0000:00:00.0: freeze
> ACPI Thermal Zone Driver thermal:03: freeze
> ACPI Thermal Zone Driver thermal:02: freeze
> ACPI Thermal Zone Driver thermal:01: freeze
> ACPI Fan Driver PNP0C0B:03: freeze
> ACPI Fan Driver PNP0C0B:02: freeze
> ACPI: Transitioning device [C351] to D0
> ACPI: Transitioning device [C351] to D0
> ACPI Fan Driver PNP0C0B:01: freeze
> ACPI: Transitioning device [C350] to D0
> ACPI: Transitioning device [C350] to D0
> ACPI Fan Driver PNP0C0B:00: freeze
> ACPI: Transitioning device [C34F] to D0
> ACPI: Transitioning device [C34F] to D0
> ACPI Power Resource Driver power_resource:06: freeze
> ACPI Power Resource Driver power_resource:05: freeze
> ACPI Power Resource Driver power_resource:04: freeze
> ACPI Power Resource Driver power_resource:03: freeze
> acpi thermal:00: freeze
> acpi PNP0C02:02: freeze
> acpi PNP0C14:00: freeze
> ACPI Button Driver PNP0C0D:00: freeze
> ACPI Button Driver PNP0C0E:00: freeze
> ACPI AC Adapter Driver ACPI0003:00: freeze
> ACPI Battery Driver PNP0C0A:01: freeze
> ACPI Battery Driver PNP0C0A:00: freeze
> acpi HPQ0006:00: freeze
> acpi PNP0C02:01: freeze
> acpi device:49: freeze
> acpi device:48: freeze
> acpi device:47: freeze
> acpi device:46: freeze
> acpi device:45: freeze
> acpi device:44: freeze
> acpi device:43: freeze
> acpi device:42: freeze
> acpi device:41: freeze
> acpi device:40: freeze
> acpi device:3f: freeze
> acpi device:3e: freeze
> acpi device:3d: freeze
> acpi device:3c: freeze
> acpi device:3b: freeze
> acpi device:3a: freeze
> acpi device:39: freeze
> acpi device:38: freeze
> acpi device:37: freeze
> acpi device:36: freeze
> acpi device:35: freeze
> acpi device:34: freeze
> acpi device:33: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:07: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:06: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:05: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:04: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:03: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:02: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:01: freeze
> ACPI PCI Interrupt Link Driver PNP0C0F:00: freeze
> acpi device:32: freeze
> acpi device:31: freeze
> acpi device:30: freeze
> acpi device:2f: freeze
> acpi device:2e: freeze
> acpi device:2d: freeze
> acpi device:2c: freeze
> acpi device:2b: freeze
> acpi device:2a: freeze
> acpi device:29: freeze
> acpi device:28: freeze
> acpi device:27: freeze
> acpi device:26: freeze
> acpi device:25: freeze
> acpi device:24: freeze
> acpi device:23: freeze
> acpi device:22: freeze
> acpi device:21: freeze
> acpi device:20: freeze
> acpi device:1f: freeze
> acpi device:1e: freeze
> acpi device:1d: freeze
> acpi device:1c: freeze
> acpi device:1b: freeze
> acpi device:1a: freeze
> acpi device:19: freeze
> acpi device:18: freeze
> acpi device:17: freeze
> acpi device:16: freeze
> acpi device:15: freeze
> acpi device:14: freeze
> acpi device:13: freeze
> acpi device:12: freeze
> acpi device:11: freeze
> acpi device:10: freeze
> acpi PNP0C02:00: freeze
> acpi PNP0000:00: freeze
> ACPI Power Resource Driver power_resource:02: freeze
> acpi SYN0118:00: freeze
> acpi PNP0303:00: freeze
> acpi PNP0B00:00: freeze
> acpi PNP0800:00: freeze
> acpi PNP0200:00: freeze
> acpi PNP0100:00: freeze
> acpi PNP0C04:00: freeze
> acpi IFX0102:00: freeze
> ACPI Power Resource Driver power_resource:01: freeze
> acpi PNP0401:00: freeze
> ACPI container driver PNP0A06:00: freeze
> ACPI Embedded Controller Driver PNP0C09:00: freeze
> acpi device:0f: freeze
> acpi device:0e: freeze
> ACPI Power Resource Driver power_resource:00: freeze
> acpi device:0d: freeze
> acpi device:0c: freeze
> acpi device:0b: freeze
> acpi device:0a: freeze
> acpi device:09: freeze
> acpi device:08: freeze
> acpi device:07: freeze
> acpi device:06: freeze
> acpi device:05: freeze
> acpi device:04: freeze
> acpi device:03: freeze
> acpi device:02: freeze
> acpi video:00: freeze
> acpi device:01: freeze
> ACPI PCI Root Bridge Driver PNP0A03:00: freeze
> acpi PNP0C01:00: freeze
> acpi device:00: freeze
> ACPI Processor Driver ACPI0007:01: freeze
> ACPI Processor Driver ACPI0007:00: freeze
> ACPI Button Driver button_power:00: freeze
> acpi acpi_system:00: freeze
> Disabling non-boot CPUs ...
> CPU 1 is now offline
> SMP alternatives: switching to UP code
> CPU1 is down
> platform bluetooth: LATE freeze
> i8042 i8042: LATE freeze
> serial8250 serial8250: LATE freeze
> vesafb vesafb.0: LATE freeze
> pcspkr pcspkr: LATE freeze
> sdhci 0000:02:04.3: LATE freeze
> tifm_7xx1 0000:02:04.2: LATE freeze
> ohci1394 0000:02:04.1: LATE freeze
> yenta_cardbus 0000:02:04.0: LATE freeze
> tg3 0000:02:01.0: LATE freeze
> bcm43xx 0000:30:00.0: LATE freeze
> pci 0000:01:05.0: LATE freeze
> k8temp 0000:00:18.3: LATE freeze
> pci 0000:00:18.2: LATE freeze
> pci 0000:00:18.1: LATE freeze
> pci 0000:00:18.0: LATE freeze
> pci 0000:00:14.4: LATE freeze
> pci 0000:00:14.3: LATE freeze
> HDA Intel 0000:00:14.2: LATE freeze
> ATIIXP_IDE 0000:00:14.1: LATE freeze
> piix4_smbus 0000:00:14.0: LATE freeze
> pcieport-driver 0000:00:06.0: LATE freeze
> pcieport-driver 0000:00:05.0: LATE freeze
> pcieport-driver 0000:00:04.0: LATE freeze
> pci 0000:00:01.0: LATE freeze
> pci 0000:00:00.0: LATE freeze
> Extended CMOS year: 2000
> swsusp: critical section: 
> swsusp: Need to copy 95157 pages
> swsusp: Normal pages needed: 95157 + 1024 + 20, available pages: 134073
> Extended CMOS year: 2000
> pci 0000:00:00.0: EARLY resume
> pci 0000:00:01.0: EARLY resume
> pcieport-driver 0000:00:04.0: EARLY resume
> pcieport-driver 0000:00:05.0: EARLY resume
> pcieport-driver 0000:00:06.0: EARLY resume
> sata_sil 0000:00:12.0: EARLY resume
> ohci_hcd 0000:00:13.0: EARLY resume
> ohci_hcd 0000:00:13.1: EARLY resume
> ehci_hcd 0000:00:13.2: EARLY resume
> piix4_smbus 0000:00:14.0: EARLY resume
> ATIIXP_IDE 0000:00:14.1: EARLY resume
> HDA Intel 0000:00:14.2: EARLY resume
> pci 0000:00:14.3: EARLY resume
> pci 0000:00:14.4: EARLY resume
> pci 0000:00:18.0: EARLY resume
> pci 0000:00:18.1: EARLY resume
> pci 0000:00:18.2: EARLY resume
> k8temp 0000:00:18.3: EARLY resume
> pci 0000:01:05.0: EARLY resume
> bcm43xx 0000:30:00.0: EARLY resume
> tg3 0000:02:01.0: EARLY resume
> yenta_cardbus 0000:02:04.0: EARLY resume
> ohci1394 0000:02:04.1: EARLY resume
> tifm_7xx1 0000:02:04.2: EARLY resume
> sdhci 0000:02:04.3: EARLY resume
> pcspkr pcspkr: EARLY resume
> vesafb vesafb.0: EARLY resume
> serial8250 serial8250: EARLY resume
> i8042 i8042: EARLY resume
> platform bluetooth: EARLY resume
> Enabling non-boot CPUs ...
> SMP alternatives: switching to SMP code
> Booting processor 1/2 APIC 0x1
> Initializing CPU#1
> Calibrating delay using timer specific routine.. 3990.23 BogoMIPS (lpj=7980462)
> CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)
> CPU: L2 Cache: 512K (64 bytes/line)
> CPU: Physical Processor ID: 0
> CPU: Processor Core ID: 1
> AMD Turion(tm) 64 X2 Mobile Technology TL-60 stepping 02
> CPU 1: Syncing TSC to CPU 0.
> CPU 1: synchronized TSC with CPU 0 (last diff 0 cycles, maxerr 510 cycles)
> powernow-k8:    0 : fid 0xc (2000 MHz), vid 0x13
> powernow-k8:    1 : fid 0xa (1800 MHz), vid 0x15
> powernow-k8:    2 : fid 0x8 (1600 MHz), vid 0x17
> powernow-k8:    3 : fid 0x0 (800 MHz), vid 0x1e
> CPU1 is up
> acpi acpi_system:00: resuming
> ACPI Button Driver button_power:00: resuming
> ACPI Processor Driver ACPI0007:00: resuming
> ACPI Processor Driver ACPI0007:01: resuming
> acpi device:00: resuming
> acpi PNP0C01:00: resuming
> ACPI PCI Root Bridge Driver PNP0A03:00: resuming
> acpi device:01: resuming
> acpi video:00: resuming
> acpi device:02: resuming
> acpi device:03: resuming
> acpi device:04: resuming
> acpi device:05: resuming
> acpi device:06: resuming
> acpi device:07: resuming
> acpi device:08: resuming
> acpi device:09: resuming
> acpi device:0a: resuming
> acpi device:0b: resuming
> acpi device:0c: resuming
> acpi device:0d: resuming
> ACPI Power Resource Driver power_resource:00: resuming
> acpi device:0e: resuming
> acpi device:0f: resuming
> ACPI Embedded Controller Driver PNP0C09:00: resuming
> ACPI container driver PNP0A06:00: resuming
> acpi PNP0401:00: resuming
> ACPI Power Resource Driver power_resource:01: resuming
> acpi IFX0102:00: resuming
> acpi PNP0C04:00: resuming
> acpi PNP0100:00: resuming
> acpi PNP0200:00: resuming
> acpi PNP0800:00: resuming
> acpi PNP0B00:00: resuming
> acpi PNP0303:00: resuming
> acpi SYN0118:00: resuming
> ACPI Power Resource Driver power_resource:02: resuming
> acpi PNP0000:00: resuming
> acpi PNP0C02:00: resuming
> acpi device:10: resuming
> acpi device:11: resuming
> acpi device:12: resuming
> acpi device:13: resuming
> acpi device:14: resuming
> acpi device:15: resuming
> acpi device:16: resuming
> acpi device:17: resuming
> acpi device:18: resuming
> acpi device:19: resuming
> acpi device:1a: resuming
> acpi device:1b: resuming
> acpi device:1c: resuming
> acpi device:1d: resuming
> acpi device:1e: resuming
> acpi device:1f: resuming
> acpi device:20: resuming
> acpi device:21: resuming
> acpi device:22: resuming
> acpi device:23: resuming
> acpi device:24: resuming
> acpi device:25: resuming
> acpi device:26: resuming
> acpi device:27: resuming
> acpi device:28: resuming
> acpi device:29: resuming
> acpi device:2a: resuming
> acpi device:2b: resuming
> acpi device:2c: resuming
> acpi device:2d: resuming
> acpi device:2e: resuming
> acpi device:2f: resuming
> acpi device:30: resuming
> acpi device:31: resuming
> acpi device:32: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:00: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:01: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:02: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:03: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:04: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:05: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:06: resuming
> ACPI PCI Interrupt Link Driver PNP0C0F:07: resuming
> acpi device:33: resuming
> acpi device:34: resuming
> acpi device:35: resuming
> acpi device:36: resuming
> acpi device:37: resuming
> acpi device:38: resuming
> acpi device:39: resuming
> acpi device:3a: resuming
> acpi device:3b: resuming
> acpi device:3c: resuming
> acpi device:3d: resuming
> acpi device:3e: resuming
> acpi device:3f: resuming
> acpi device:40: resuming
> acpi device:41: resuming
> acpi device:42: resuming
> acpi device:43: resuming
> acpi device:44: resuming
> acpi device:45: resuming
> acpi device:46: resuming
> acpi device:47: resuming
> acpi device:48: resuming
> acpi device:49: resuming
> acpi PNP0C02:01: resuming
> acpi HPQ0006:00: resuming
> ACPI Battery Driver PNP0C0A:00: resuming
> ACPI Battery Driver PNP0C0A:01: resuming
> ACPI AC Adapter Driver ACPI0003:00: resuming
> ACPI Button Driver PNP0C0E:00: resuming
> ACPI Button Driver PNP0C0D:00: resuming
> acpi PNP0C14:00: resuming
> acpi PNP0C02:02: resuming
> acpi thermal:00: resuming
> ACPI Power Resource Driver power_resource:03: resuming
> ACPI Power Resource Driver power_resource:04: resuming
> ACPI Power Resource Driver power_resource:05: resuming
> ACPI Power Resource Driver power_resource:06: resuming
> ACPI Fan Driver PNP0C0B:00: resuming
> ACPI: Transitioning device [C34F] to D0
> ACPI: Transitioning device [C34F] to D0
> ACPI Fan Driver PNP0C0B:01: resuming
> ACPI: Transitioning device [C350] to D0
> ACPI: Transitioning device [C350] to D0
> ACPI Fan Driver PNP0C0B:02: resuming
> ACPI: Transitioning device [C351] to D0
> ACPI: Transitioning device [C351] to D0
> ACPI Fan Driver PNP0C0B:03: resuming
> ACPI Thermal Zone Driver thermal:01: resuming
> ACPI Thermal Zone Driver thermal:02: resuming
> ACPI Thermal Zone Driver thermal:03: resuming
> pci 0000:00:00.0: resuming
> pci 0000:00:01.0: resuming
> pcieport-driver 0000:00:04.0: resuming
> PCI: Setting latency timer of device 0000:00:04.0 to 64
> pcieport-driver 0000:00:05.0: resuming
> PCI: Setting latency timer of device 0000:00:05.0 to 64
> pcieport-driver 0000:00:06.0: resuming
> PCI: Setting latency timer of device 0000:00:06.0 to 64
> sata_sil 0000:00:12.0: resuming
> ohci_hcd 0000:00:13.0: resuming
> ohci_hcd 0000:00:13.0: PCI legacy resume
> ACPI: PCI Interrupt 0000:00:13.0[A] -> GSI 19 (level, low) -> IRQ 19
> ohci_hcd 0000:00:13.1: resuming
> ohci_hcd 0000:00:13.1: PCI legacy resume
> ACPI: PCI Interrupt 0000:00:13.1[A] -> GSI 19 (level, low) -> IRQ 19
> ehci_hcd 0000:00:13.2: resuming
> ehci_hcd 0000:00:13.2: PCI D0, from previous PCI D3
> ACPI: PCI Interrupt 0000:00:13.2[A] -> GSI 19 (level, low) -> IRQ 19
> PM: Writing back config space on device 0000:00:13.2 at offset 1 (was 2b00007, writing 2b00017)
> ehci_hcd 0000:00:13.2: lost power, restarting
> usb usb1: root hub lost power or was reset
> ehci_hcd 0000:00:13.2: reset command 080002 (park)=0 ithresh=8 period=1024 Reset HALT
> ehci_hcd 0000:00:13.2: MWI active
> piix4_smbus 0000:00:14.0: resuming
> ATIIXP_IDE 0000:00:14.1: resuming
> ACPI: PCI Interrupt 0000:00:14.1[A] -> GSI 16 (level, low) -> IRQ 16
> HDA Intel 0000:00:14.2: resuming
> PM: Writing back config space on device 0000:00:14.2 at offset f (was 10a, writing a)
> PM: Writing back config space on device 0000:00:14.2 at offset 1 (was 4100006, writing 4100002)
> ACPI: PCI Interrupt 0000:00:14.2[A] -> GSI 16 (level, low) -> IRQ 16
> pci 0000:00:14.3: resuming
> pci 0000:00:14.4: resuming
> PM: Writing back config space on device 0000:00:14.4 at offset 6 (was 40030200, writing 40060200)
> pci 0000:00:18.0: resuming
> pci 0000:00:18.1: resuming
> pci 0000:00:18.2: resuming
> k8temp 0000:00:18.3: resuming
> pci 0000:01:05.0: resuming
> bcm43xx 0000:30:00.0: resuming
> bcm43xx: Resuming...
> ACPI: PCI Interrupt 0000:30:00.0[A] -> GSI 18 (level, low) -> IRQ 18
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio enabled by hardware
> ata2: SATA link down (SStatus 0 SControl 300)
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> PM: Adding info for No Bus:hw_random
> bcm43xx: Device resumed.
> tg3 0000:02:01.0: resuming
> PM: Writing back config space on device 0000:02:01.0 at offset b (was 3ed173b, writing 30b0103c)
> PM: Writing back config space on device 0000:02:01.0 at offset 3 (was 0, writing 4010)
> PM: Writing back config space on device 0000:02:01.0 at offset 2 (was 2000000, writing 2000003)
> PM: Writing back config space on device 0000:02:01.0 at offset 1 (was 2b00000, writing 2b00006)
> PM: Writing back config space on device 0000:02:01.0 at offset 0 (was 3ed173b, writing 169c14e4)
> SoftMAC: Associate: Scanning for networks first.
> yenta_cardbus 0000:02:04.0: resuming
> PM: Writing back config space on device 0000:02:04.0 at offset f (was 3c4010a, writing 5c0010a)
> PM: Writing back config space on device 0000:02:04.0 at offset 3 (was 824010, writing 82a810)
> ohci1394 0000:02:04.1: resuming
> ohci1394: fw-host0: OHCI-1394 1.1 (PCI): IRQ=[20]  MMIO=[d4011000-d40117ff]  Max Packet=[2048]  IR/IT contexts=[4/8]
> tifm_7xx1 0000:02:04.2: resuming
> ACPI: PCI Interrupt 0000:02:04.2[A] -> GSI 20 (level, low) -> IRQ 20
> sdhci 0000:02:04.3: resuming
> ACPI: PCI Interrupt 0000:02:04.3[A] -> GSI 20 (level, low) -> IRQ 20
> pcspkr pcspkr: resuming
> pci_express 0000:00:04.0:pcie00: resuming
> pci_express 0000:00:04.0:pcie01: resuming
> pci_express 0000:00:04.0:pcie03: resuming
> pci_express 0000:00:05.0:pcie00: resuming
> pci_express 0000:00:05.0:pcie01: resuming
> pci_express 0000:00:05.0:pcie03: resuming
> pci_express 0000:00:06.0:pcie00: resuming
> pci_express 0000:00:06.0:pcie01: resuming
> pci_express 0000:00:06.0:pcie03: resuming
> vesafb vesafb.0: resuming
> serial8250 serial8250: resuming
> sd 0:0:0:0: resuming
> i8042 i8042: resuming
> atkbd serio0: resuming
> serio serio1: resuming
> serio serio2: resuming
> serio serio3: resuming
> psmouse serio4: resuming
> synaptics reset failed
> synaptics reset failed
> synaptics reset failed
> SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
> ide-cdrom 0.0: resuming
> usb usb1: resuming
> usb usb1: usb resume
> usb usb1: finish resume
> hub 1-0:1.0: hub_resume
> ehci_hcd 0000:00:13.2: resume root hub after power loss
> usb usb2: resuming
> usb usb2: usb resume
> usb usb2: finish resume
> hub 2-0:1.0: hub_resume
> ohci_hcd 0000:00:13.0: BIOS/SMM active, control 008
> usb usb2: root hub lost power or was reset
> ohci_hcd 0000:00:13.0: resetting from state 'reset', control = 0x8
> ohci_hcd 0000:00:13.0: OHCI controller state
> ohci_hcd 0000:00:13.0: OHCI 1.0, NO legacy support registers
> ohci_hcd 0000:00:13.0: control 0x083 HCFS=operational CBSR=3
> ohci_hcd 0000:00:13.0: cmdstatus 0x00000 SOC=0
> ohci_hcd 0000:00:13.0: intrstatus 0x00000004 SF
> ohci_hcd 0000:00:13.0: intrenable 0x8000005a MIE RHSC UE RD WDH
> ohci_hcd 0000:00:13.0: hcca frame #0005
> ohci_hcd 0000:00:13.0: roothub.a 02000204 POTPGT=2 NPS NDP=4(4)
> ohci_hcd 0000:00:13.0: roothub.b 00000000 PPCM=0000 DR=0000
> ohci_hcd 0000:00:13.0: roothub.status 00008000 DRWE
> ohci_hcd 0000:00:13.0: roothub.portstatus [0] 0x00000100 PPS
> ohci_hcd 0000:00:13.0: roothub.portstatus [1] 0x00010100 CSC PPS
> ohci_hcd 0000:00:13.0: roothub.portstatus [2] 0x00000100 PPS
> ohci_hcd 0000:00:13.0: roothub.portstatus [3] 0x00000100 PPS
> ohci_hcd 0000:00:13.0: restart complete
> hub 2-0:1.0: resuming
> usb usb3: resuming
> usb usb3: usb resume
> usb usb3: finish resume
> hub 3-0:1.0: hub_resume
> ohci_hcd 0000:00:13.1: BIOS/SMM active, control 008
> usb usb3: root hub lost power or was reset
> ohci_hcd 0000:00:13.1: resetting from state 'reset', control = 0x8
> ohci_hcd 0000:00:13.1: OHCI controller state
> ohci_hcd 0000:00:13.1: OHCI 1.0, NO legacy support registers
> ohci_hcd 0000:00:13.1: control 0x083 HCFS=operational CBSR=3
> ohci_hcd 0000:00:13.1: cmdstatus 0x00000 SOC=0
> ohci_hcd 0000:00:13.1: intrstatus 0x00000004 SF
> ohci_hcd 0000:00:13.1: intrenable 0x8000005a MIE RHSC UE RD WDH
> ohci_hcd 0000:00:13.1: hcca frame #0005
> ohci_hcd 0000:00:13.1: roothub.a 02000204 POTPGT=2 NPS NDP=4(4)
> ohci_hcd 0000:00:13.1: roothub.b 00000000 PPCM=0000 DR=0000
> ohci_hcd 0000:00:13.1: roothub.status 00008000 DRWE
> ohci_hcd 0000:00:13.1: roothub.portstatus [0] 0x00010100 CSC PPS
> ohci_hcd 0000:00:13.1: roothub.portstatus [1] 0x00000100 PPS
> ohci_hcd 0000:00:13.1: roothub.portstatus [2] 0x00000100 PPS
> ohci_hcd 0000:00:13.1: roothub.portstatus [3] 0x00010100 CSC PPS
> ohci_hcd 0000:00:13.1: restart complete
> hub 3-0:1.0: resuming
> platform bluetooth: resuming
> serio serio6: resuming
> usb 2-2: resuming
>  usbdev2.10_ep00: PM: resume from 0, parent 2-2 still 1
> hci_usb 2-2:1.0: PM: resume from 1, parent 2-2 still 1
> hci_usb 2-2:1.0: resuming
>  hci0: PM: resume from 0, parent 2-2:1.0 still 1
>  usbdev2.10_ep81: PM: resume from 0, parent 2-2:1.0 still 1
>  usbdev2.10_ep82: PM: resume from 0, parent 2-2:1.0 still 1
>  usbdev2.10_ep02: PM: resume from 0, parent 2-2:1.0 still 1
> hci_usb 2-2:1.1: PM: resume from 1, parent 2-2 still 1
> hci_usb 2-2:1.1: resuming
>  usbdev2.10_ep83: PM: resume from 0, parent 2-2:1.1 still 1
>  usbdev2.10_ep03: PM: resume from 0, parent 2-2:1.1 still 1
> usb 2-2:1.2: PM: resume from 1, parent 2-2 still 1
> usb 2-2:1.2: resuming
>  usbdev2.10_ep84: PM: resume from 0, parent 2-2:1.2 still 1
>  usbdev2.10_ep04: PM: resume from 0, parent 2-2:1.2 still 1
> usb 2-2:1.3: PM: resume from 1, parent 2-2 still 1
> usb 2-2:1.3: resuming
>  usbdev2.10: PM: resume from 0, parent 2-2 still 1
>  usbdev3.18_ep00: PM: resume from 0, parent 3-1 still 2
>  usbdev3.18_ep81: PM: resume from 0, parent 3-1:1.0 still 2
>  usbdev3.18_ep02: PM: resume from 0, parent 3-1:1.0 still 2
>  usbdev3.18: PM: resume from 0, parent 3-1 still 2
> usb 3-4: resuming
>  usbdev3.19_ep00: PM: resume from 0, parent 3-4 still 1
> usbhid 3-4:1.0: PM: resume from 1, parent 3-4 still 1
> usbhid 3-4:1.0: resuming
>  usbdev3.19_ep81: PM: resume from 0, parent 3-4:1.0 still 1
>  usbdev3.19: PM: resume from 0, parent 3-4 still 1
> Restarting tasks ... <7>hub 2-0:1.0: state 7 ports 4 chg 0004 evt 001e
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [0] = 0x00010100 CSC PPS
> hub 2-0:1.0: port 1, status 0100, change 0001, 12 Mb/s
> done.
> PM: Removing info for No Bus:vcs8
> PM: Removing info for No Bus:vcsa8
> ata1: SATA link up 1.5 Gbps (SStatus 113 SControl 300)
> ata1.00: configured for UDMA/100
> SCSI device sda: 156301488 512-byte hdwr sectors (80026 MB)
> sda: Write Protect is off
> sda: Mode Sense: 00 3a 00 00
> SCSI device sda: write cache: enabled, read cache: enabled, doesn't support DPO or FUA
> hub 2-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00010100 CSC PPS
> hub 2-0:1.0: port 2, status 0100, change 0001, 12 Mb/s
> usb 2-2: USB disconnect, address 10
> usb 2-2: unregistering device
> usb 2-2: usb_disable_device nuking all URBs
> usb 2-2: unregistering interface 2-2:1.0
> PM: Removing info for No Bus:usbdev2.10_ep81
>  usbdev2.10_ep81: ep_device_release called for usbdev2.10_ep81
> PM: Removing info for No Bus:usbdev2.10_ep82
>  usbdev2.10_ep82: ep_device_release called for usbdev2.10_ep82
> PM: Removing info for No Bus:usbdev2.10_ep02
>  usbdev2.10_ep02: ep_device_release called for usbdev2.10_ep02
> PM: Removing info for No Bus:hci0
> PM: Removing info for usb:2-2:1.0
> usb 2-2:1.0: uevent
> usb 2-2: unregistering interface 2-2:1.1
> PM: Removing info for No Bus:usbdev2.10_ep83
>  usbdev2.10_ep83: ep_device_release called for usbdev2.10_ep83
> PM: Removing info for No Bus:usbdev2.10_ep03
>  usbdev2.10_ep03: ep_device_release called for usbdev2.10_ep03
> PM: Removing info for usb:2-2:1.1
> usb 2-2:1.1: uevent
> usb 2-2: unregistering interface 2-2:1.2
> PM: Removing info for No Bus:usbdev2.10_ep84
>  usbdev2.10_ep84: ep_device_release called for usbdev2.10_ep84
> PM: Removing info for No Bus:usbdev2.10_ep04
>  usbdev2.10_ep04: ep_device_release called for usbdev2.10_ep04
> PM: Removing info for usb:2-2:1.2
> usb 2-2:1.2: uevent
> usb 2-2: unregistering interface 2-2:1.3
> PM: Removing info for usb:2-2:1.3
> usb 2-2:1.3: uevent
> PM: Removing info for No Bus:usbdev2.10
> PM: Removing info for No Bus:usbdev2.10_ep00
>  usbdev2.10_ep00: ep_device_release called for usbdev2.10_ep00
> PM: Removing info for usb:2-2
> usb 2-2: uevent
> SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
> hub 2-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [2] = 0x00010100 CSC PPS
> hub 2-0:1.0: port 3, status 0100, change 0001, 12 Mb/s
> hub 2-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [3] = 0x00010100 CSC PPS
> hub 2-0:1.0: port 4, status 0100, change 0001, 12 Mb/s
> hub 2-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x100
> hub 3-0:1.0: state 7 ports 4 chg 0012 evt 001e
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00010100 CSC PPS
> hub 3-0:1.0: port 1, status 0100, change 0001, 12 Mb/s
> usb 3-1: USB disconnect, address 18
> usb 3-1: unregistering device
> usb 3-1: usb_disable_device nuking all URBs
> usb 3-1: unregistering interface 3-1:1.0
> PM: Removing info for No Bus:usbdev3.18_ep81
>  usbdev3.18_ep81: ep_device_release called for usbdev3.18_ep81
> PM: Removing info for No Bus:usbdev3.18_ep02
>  usbdev3.18_ep02: ep_device_release called for usbdev3.18_ep02
> PM: Removing info for usb:3-1:1.0
> usb 3-1:1.0: uevent
> PM: Removing info for No Bus:usbdev3.18
> PM: Removing info for No Bus:usbdev3.18_ep00
>  usbdev3.18_ep00: ep_device_release called for usbdev3.18_ep00
> PM: Removing info for usb:3-1
> usb 3-1: uevent
> hub 3-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [1] = 0x00010100 CSC PPS
> hub 3-0:1.0: port 2, status 0100, change 0001, 12 Mb/s
> hub 3-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [2] = 0x00010100 CSC PPS
> hub 3-0:1.0: port 3, status 0100, change 0001, 12 Mb/s
> hub 3-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x100
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00010100 CSC PPS
> hub 3-0:1.0: port 4, status 0100, change 0001, 12 Mb/s
> usb 3-4: USB disconnect, address 19
> usb 3-4: unregistering device
> usb 3-4: usb_disable_device nuking all URBs
> usb 3-4: unregistering interface 3-4:1.0
> PM: Removing info for No Bus:usbdev3.19_ep81
>  usbdev3.19_ep81: ep_device_release called for usbdev3.19_ep81
> PM: Removing info for usb:3-4:1.0
> usb 3-4:1.0: uevent
> PM: Removing info for No Bus:usbdev3.19
> PM: Removing info for No Bus:usbdev3.19_ep00
>  usbdev3.19_ep00: ep_device_release called for usbdev3.19_ep00
> PM: Removing info for usb:3-4
> usb 3-4: uevent
> hub 3-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x100
> hub 1-0:1.0: state 7 ports 8 chg 0000 evt 010c
> ehci_hcd 0000:00:13.2: GetStatus port 2 status 001803 POWER sig=j CSC CONNECT
> hub 1-0:1.0: port 2, status 0501, change 0001, 480 Mb/s
> hub 1-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x501
> ehci_hcd 0000:00:13.2: port 2 full speed --> companion
> ehci_hcd 0000:00:13.2: GetStatus port 2 status 003801 POWER OWNER sig=j CONNECT
> hub 1-0:1.0: port 2 not reset yet, waiting 50ms
> ehci_hcd 0000:00:13.2: GetStatus port 2 status 003002 POWER OWNER sig=se0 CSC
> ehci_hcd 0000:00:13.2: GetStatus port 3 status 001803 POWER sig=j CSC CONNECT
> hub 1-0:1.0: port 3, status 0501, change 0001, 480 Mb/s
> hub 1-0:1.0: debounce: port 3: total 100ms stable 100ms status 0x501
> ehci_hcd 0000:00:13.2: port 3 full speed --> companion
> ehci_hcd 0000:00:13.2: GetStatus port 3 status 003801 POWER OWNER sig=j CONNECT
> hub 1-0:1.0: port 3 not reset yet, waiting 50ms
> ehci_hcd 0000:00:13.2: GetStatus port 3 status 003002 POWER OWNER sig=se0 CSC
> ehci_hcd 0000:00:13.2: GetStatus port 8 status 001403 POWER sig=k CSC CONNECT
> hub 1-0:1.0: port 8, status 0501, change 0001, 480 Mb/s
> hub 1-0:1.0: debounce: port 8: total 100ms stable 100ms status 0x501
> ehci_hcd 0000:00:13.2: port 8 low speed --> companion
> ehci_hcd 0000:00:13.2: GetStatus port 8 status 003002 POWER OWNER sig=se0 CSC
> hub 2-0:1.0: state 7 ports 4 chg 0000 evt 0004
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00010101 CSC PPS CCS
> hub 2-0:1.0: port 2, status 0101, change 0001, 12 Mb/s
> hub 2-0:1.0: debounce: port 2: total 100ms stable 100ms status 0x101
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00100103 PRSC PPS PES CCS
> usb 2-2: new full speed USB device using ohci_hcd and address 11
> ohci_hcd 0000:00:13.0: GetStatus roothub.portstatus [1] = 0x00100103 PRSC PPS PES CCS
> usb 2-2: skipped 1 descriptor after interface
> usb 2-2: default language 0x0409
> usb 2-2: new device strings: Mfr=1, Product=2, SerialNumber=0
> usb 2-2: Product: HP Integrated Module
> usb 2-2: Manufacturer: Broadcom Corp
> PM: Adding info for usb:2-2
> usb 2-2: uevent
> usb 2-2: usb_probe_device
> PM: Adding info for No Bus:usbdev2.11_ep00
> usb 2-2: configuration #1 chosen from 1 choice
> usb 2-2: adding 2-2:1.0 (config #1, interface 0)
> PM: Adding info for usb:2-2:1.0
> usb 2-2:1.0: uevent
> hci_usb 2-2:1.0: usb_probe_interface
> hci_usb 2-2:1.0: usb_probe_interface - got id
> PM: Adding info for No Bus:hci0
> PM: Adding info for No Bus:usbdev2.11_ep81
> PM: Adding info for No Bus:usbdev2.11_ep82
> PM: Adding info for No Bus:usbdev2.11_ep02
> usb 2-2: adding 2-2:1.1 (config #1, interface 1)
> PM: Adding info for usb:2-2:1.1
> usb 2-2:1.1: uevent
> PM: Adding info for No Bus:usbdev2.11_ep83
> PM: Adding info for No Bus:usbdev2.11_ep03
> usb 2-2: adding 2-2:1.2 (config #1, interface 2)
> PM: Adding info for usb:2-2:1.2
> usb 2-2:1.2: uevent
> hci_usb 2-2:1.2: usb_probe_interface
> hci_usb 2-2:1.2: usb_probe_interface - got id
> PM: Adding info for No Bus:usbdev2.11_ep84
> PM: Adding info for No Bus:usbdev2.11_ep04
> usb 2-2: adding 2-2:1.3 (config #1, interface 3)
> PM: Adding info for usb:2-2:1.3
> usb 2-2:1.3: uevent
> hci_usb 2-2:1.3: usb_probe_interface
> hci_usb 2-2:1.3: usb_probe_interface - got id
> PM: Adding info for No Bus:usbdev2.11
> drivers/usb/core/inode.c: creating file '011'
> hub 3-0:1.0: state 7 ports 4 chg 0000 evt 0012
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00010101 CSC PPS CCS
> hub 3-0:1.0: port 1, status 0101, change 0001, 12 Mb/s
> hub 3-0:1.0: debounce: port 1: total 100ms stable 100ms status 0x101
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00100103 PRSC PPS PES CCS
> usb 3-1: new full speed USB device using ohci_hcd and address 20
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [0] = 0x00100103 PRSC PPS PES CCS
> usb 3-1: ep0 maxpacket = 8
> usb 3-1: default language 0x0409
> usb 3-1: new device strings: Mfr=0, Product=1, SerialNumber=0
> usb 3-1: Product: Fingerprint Sensor
> PM: Adding info for usb:3-1
> usb 3-1: uevent
> usb 3-1: usb_probe_device
> PM: Adding info for No Bus:usbdev3.20_ep00
> usb 3-1: configuration #1 chosen from 1 choice
> usb 3-1: adding 3-1:1.0 (config #1, interface 0)
> PM: Adding info for usb:3-1:1.0
> usb 3-1:1.0: uevent
> PM: Adding info for No Bus:usbdev3.20_ep81
> PM: Adding info for No Bus:usbdev3.20_ep02
> PM: Adding info for No Bus:usbdev3.20
> drivers/usb/core/inode.c: creating file '020'
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00010301 CSC LSDA PPS CCS
> hub 3-0:1.0: port 4, status 0301, change 0001, 1.5 Mb/s
> hub 3-0:1.0: debounce: port 4: total 100ms stable 100ms status 0x301
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00100303 PRSC LSDA PPS PES CCS
> usb 3-4: new low speed USB device using ohci_hcd and address 21
> ohci_hcd 0000:00:13.1: GetStatus roothub.portstatus [3] = 0x00100303 PRSC LSDA PPS PES CCS
> usb 3-4: skipped 1 descriptor after interface
> usb 3-4: default language 0x0409
> usb 3-4: new device strings: Mfr=1, Product=2, SerialNumber=0
> usb 3-4: Product: USB Receiver
> usb 3-4: Manufacturer: Logitech
> PM: Adding info for usb:3-4
> usb 3-4: uevent
> usb 3-4: usb_probe_device
> PM: Adding info for No Bus:usbdev3.21_ep00
> usb 3-4: configuration #1 chosen from 1 choice
> usb 3-4: adding 3-4:1.0 (config #1, interface 0)
> PM: Adding info for usb:3-4:1.0
> usb 3-4:1.0: uevent
> usbhid 3-4:1.0: usb_probe_interface
> usbhid 3-4:1.0: usb_probe_interface - got id
>   INPUT[INPUT]
>     Field(0)
>       Physical(GenericDesktop.Pointer)
>       Usage(8)
>         Button.0001
>         Button.0002
>         Button.0003
>         Button.0004
>         Button.0005
>         Button.0006
>         Button.0007
>         Button.0008
>       Logical Minimum(0)
>       Logical Maximum(1)
>       Report Size(1)
>       Report Count(8)
>       Report Offset(0)
>       Flags( Variable Absolute )
>     Field(1)
>       Physical(GenericDesktop.Pointer)
>       Usage(3)
>         GenericDesktop.X
>         GenericDesktop.Y
>         GenericDesktop.Wheel
>       Logical Minimum(-127)
>       Logical Maximum(127)
>       Report Size(8)
>       Report Count(3)
>       Report Offset(8)
>       Flags( Variable Relative )
>     Field(2)
>       Physical(GenericDesktop.Pointer)
>       Usage(1)
>         Consumer.HorizontalWheel
>       Logical Minimum(-127)
>       Logical Maximum(127)
>       Report Size(8)
>       Report Count(1)
>       Report Offset(32)
>       Flags( Variable Relative )
>     Field(3)
>       Usage(8)
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>         LED.GenericIndicator
>       Logical Minimum(0)
>       Logical Maximum(1)
>       Report Size(1)
>       Report Count(8)
>       Report Offset(40)
>       Flags( Variable Absolute )
>     Field(4)
>       Usage(8)
>         Button.0009
>         Button.000a
>         Button.000b
>         Button.000c
>         Button.000d
>         Button.000e
>         Button.000f
>         Button.0010
>       Logical Minimum(0)
>       Logical Maximum(1)
>       Report Size(1)
>       Report Count(8)
>       Report Offset(48)
>       Flags( Variable Absolute )
>   FEATURE[FEATURE]
>     Field(0)
>       Usage(1)
>         GenericDesktop.MotionWakeup
>       Logical Minimum(0)
>       Logical Maximum(1)
>       Report Size(1)
>       Report Count(1)
>       Report Offset(0)
>       Flags( Variable Absolute NoPrefferedState )
> Mapping: Button.0001 ---> Key.LeftBtn
> Mapping: Button.0002 ---> Key.RightBtn
> Mapping: Button.0003 ---> Key.MiddleBtn
> Mapping: Button.0004 ---> Key.SideBtn
> Mapping: Button.0005 ---> Key.ExtraBtn
> Mapping: Button.0006 ---> Key.ForwardBtn
> Mapping: Button.0007 ---> Key.BackBtn
> Mapping: Button.0008 ---> Key.TaskBtn
> Mapping: GenericDesktop.X ---> Relative.X
> Mapping: GenericDesktop.Y ---> Relative.Y
> Mapping: GenericDesktop.Wheel ---> Relative.Wheel
> Mapping: Consumer.HorizontalWheel ---> Relative.HWheel
> Mapping: LED.GenericIndicator ---> LED.Misc
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: LED.GenericIndicator ---> LED.?
> Mapping: Button.0009 ---> Key.?
> Mapping: Button.000a ---> Key.?
> Mapping: Button.000b ---> Key.?
> Mapping: Button.000c ---> Key.?
> Mapping: Button.000d ---> Key.?
> Mapping: Button.000e ---> Key.?
> Mapping: Button.000f ---> Key.?
> Mapping: Button.0010 ---> Key.?
> input: Logitech USB Receiver as /class/input/input16
> hid-pidff: starting pid init
> hid-pidff: not a PID device, no output report
> input: USB HID v1.10 Mouse [Logitech USB Receiver] on usb-0000:00:13.1-4
> PM: Adding info for No Bus:usbdev3.21_ep81
> PM: Adding info for No Bus:usbdev3.21
> drivers/usb/core/inode.c: creating file '021'
> hub 1-0:1.0: state 7 ports 8 chg 0000 evt 0100
> hub 2-0:1.0: state 7 ports 4 chg 0000 evt 0004
> hub 3-0:1.0: state 7 ports 4 chg 0000 evt 0002
> usb 3-1: usb auto-suspend
> SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
> hub 1-0:1.0: hub_suspend
> usb usb1: usb auto-suspend
> SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
> PM: Removing info for No Bus:hw_random
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 0/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 56/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> PM: Adding info for No Bus:0000:30:00.0
> PM: Removing info for No Bus:0000:30:00.0
> PM: Adding info for No Bus:0000:30:00.0
> PM: Removing info for No Bus:0000:30:00.0
> PM: Adding info for No Bus:0000:30:00.0
> PM: Removing info for No Bus:0000:30:00.0
> PM: Adding info for No Bus:0000:30:00.0
> PM: Removing info for No Bus:0000:30:00.0
> bcm43xx: IRQ_READY timeout
> bcm43xx: core_up for active 802.11 core failed (-19)

I never tried suspend to disk with the driver.
Larry, an idea why the microcode doesn't respond?

-- 
Greetings Michael.


From johannes at sipsolutions.net  Sun Feb 11 15:41:50 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 11 Feb 2007 15:41:50 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111514.04893.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111407.08099.mb@bu3sch.de> <200702111502.19545.rjw@sisk.pl>
	<200702111514.04893.mb@bu3sch.de>
Message-ID: <1171204910.5032.7.camel@johannes.berg>

On Sun, 2007-02-11 at 15:14 +0100, Michael Buesch wrote:

> > bcm43xx: IRQ_READY timeout
> > bcm43xx: core_up for active 802.11 core failed (-19)
> 
> I never tried suspend to disk with the driver.
> Larry, an idea why the microcode doesn't respond?

Rafael, is bcm43xx built in or modular?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070211/5c06d57f/attachment.pgp>

From rjw at sisk.pl  Sun Feb 11 15:45:02 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Sun, 11 Feb 2007 15:45:02 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <1171204910.5032.7.camel@johannes.berg>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111514.04893.mb@bu3sch.de>
	<1171204910.5032.7.camel@johannes.berg>
Message-ID: <200702111545.04183.rjw@sisk.pl>

On Sunday, 11 February 2007 15:41, Johannes Berg wrote:
> On Sun, 2007-02-11 at 15:14 +0100, Michael Buesch wrote:
> 
> > > bcm43xx: IRQ_READY timeout
> > > bcm43xx: core_up for active 802.11 core failed (-19)
> > 
> > I never tried suspend to disk with the driver.
> > Larry, an idea why the microcode doesn't respond?
> 
> Rafael, is bcm43xx built in or modular?

Modular.  Otherwise I wouldn't have been able to reload it. :-)

Rafael


From johannes at sipsolutions.net  Sun Feb 11 15:48:35 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 11 Feb 2007 15:48:35 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111545.04183.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111514.04893.mb@bu3sch.de>
	<1171204910.5032.7.camel@johannes.berg>
	<200702111545.04183.rjw@sisk.pl>
Message-ID: <1171205315.5032.9.camel@johannes.berg>

On Sun, 2007-02-11 at 15:45 +0100, Rafael J. Wysocki wrote:
> On Sunday, 11 February 2007 15:41, Johannes Berg wrote:
> > On Sun, 2007-02-11 at 15:14 +0100, Michael Buesch wrote:
> > 
> > > > bcm43xx: IRQ_READY timeout
> > > > bcm43xx: core_up for active 802.11 core failed (-19)
> > > 
> > > I never tried suspend to disk with the driver.
> > > Larry, an idea why the microcode doesn't respond?
> > 
> > Rafael, is bcm43xx built in or modular?
> 
> Modular.  Otherwise I wouldn't have been able to reload it. :-)

Guess I should've paid more attention. No idea what causes this then.
Could you try increasing the timeout loop for that wait? (search for the
message in the source code)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070211/8a85bd98/attachment.pgp>

From larry.finger at lwfinger.net  Sun Feb 11 16:59:13 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 11 Feb 2007 09:59:13 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111514.04893.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111407.08099.mb@bu3sch.de> <200702111502.19545.rjw@sisk.pl>
	<200702111514.04893.mb@bu3sch.de>
Message-ID: <45CF3D51.5050302@lwfinger.net>

Michael Buesch wrote:
> On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
>> PM: Removing info for No Bus:0000:30:00.0
>> bcm43xx: IRQ_READY timeout
>> bcm43xx: core_up for active 802.11 core failed (-19)
> 
> I never tried suspend to disk with the driver.

This implies that suspend to RAM works. Is that true?

> Larry, an idea why the microcode doesn't respond?

Is this code snippet supposed to keep the firmware loaded when the system is suspended?

                bcm->firmware_norelease = 1;
                bcm43xx_free_board(bcm);
                bcm->firmware_norelease = 0;

If so, that may be the problem. What would force it to be reloaded when resuming after a suspend to
disk and subsequent power off? That would certainly explain why a reload is successful. Is there a
volatile location that would safely indicate that the firmware is not good? Perhaps, we need to bite
the bullet and reload the firmware after every resume. The patch below should do that.

I am also working on a case where the user has troubles with a suspend to disk from Windows followed
by a reboot to Linux, and warm reboots from Windows to Linux. In these cases, he gets a firmware
file-format error; however, his firmware is fine from a cold boot.

Larry

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -4296,6 +4297,7 @@ static int bcm43xx_resume(struct pci_dev
 		printk(KERN_ERR PFX "Resume failed!\n");
 		return err;
 	}
+	bcm43xx_request_firmware(bcm);
 	netif_device_attach(net_dev);

 	dprintk(KERN_INFO PFX "Device resumed.\n");


From mb at bu3sch.de  Sun Feb 11 17:03:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 17:03:13 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45CF3D51.5050302@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111514.04893.mb@bu3sch.de> <45CF3D51.5050302@lwfinger.net>
Message-ID: <200702111703.13702.mb@bu3sch.de>

On Sunday 11 February 2007 16:59, Larry Finger wrote:
> Michael Buesch wrote:
> > On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
> >> PM: Removing info for No Bus:0000:30:00.0
> >> bcm43xx: IRQ_READY timeout
> >> bcm43xx: core_up for active 802.11 core failed (-19)
> > 
> > I never tried suspend to disk with the driver.
> 
> This implies that suspend to RAM works. Is that true?

No.

> > Larry, an idea why the microcode doesn't respond?
> 
> Is this code snippet supposed to keep the firmware loaded when the system is suspended?

Well, eh, no. Don't confuse suspend-to-ram with suspend-to-disk.
On suspend-to-disk the kernel is (mostly) reloaded as usual.
Just userspace is restored.
So the driver enters through the probe routine on resume from disk.

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Feb 11 17:16:51 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 11 Feb 2007 17:16:51 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111703.13702.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<45CF3D51.5050302@lwfinger.net> <200702111703.13702.mb@bu3sch.de>
Message-ID: <200702111716.51539.mb@bu3sch.de>

On Sunday 11 February 2007 17:03, Michael Buesch wrote:
> On Sunday 11 February 2007 16:59, Larry Finger wrote:
> > Michael Buesch wrote:
> > > On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
> > >> PM: Removing info for No Bus:0000:30:00.0
> > >> bcm43xx: IRQ_READY timeout
> > >> bcm43xx: core_up for active 802.11 core failed (-19)
> > > 
> > > I never tried suspend to disk with the driver.
> > 
> > This implies that suspend to RAM works. Is that true?
> 
> No.
> 
> > > Larry, an idea why the microcode doesn't respond?
> > 
> > Is this code snippet supposed to keep the firmware loaded when the system is suspended?
> 
> Well, eh, no. Don't confuse suspend-to-ram with suspend-to-disk.
> On suspend-to-disk the kernel is (mostly) reloaded as usual.
> Just userspace is restored.
> So the driver enters through the probe routine on resume from disk.

I've been told this is wrong.
Well, ok. Anyway. I don't think we need to re-request the fw,
as it's restored, too.

Can you try bcm43xx-d80211 from my tree? There it reinitializes the
device completely on resume. So it might work there.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Feb 11 17:17:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 11 Feb 2007 10:17:25 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702111703.13702.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111514.04893.mb@bu3sch.de> <45CF3D51.5050302@lwfinger.net>
	<200702111703.13702.mb@bu3sch.de>
Message-ID: <45CF4195.10709@lwfinger.net>

Michael Buesch wrote:
> On Sunday 11 February 2007 16:59, Larry Finger wrote:
>> Michael Buesch wrote:
>>> On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
>>>> PM: Removing info for No Bus:0000:30:00.0
>>>> bcm43xx: IRQ_READY timeout
>>>> bcm43xx: core_up for active 802.11 core failed (-19)
>>> I never tried suspend to disk with the driver.
>> This implies that suspend to RAM works. Is that true?
> 
> No.
> 
>>> Larry, an idea why the microcode doesn't respond?
>> Is this code snippet supposed to keep the firmware loaded when the system is suspended?
> 
> Well, eh, no. Don't confuse suspend-to-ram with suspend-to-disk.
> On suspend-to-disk the kernel is (mostly) reloaded as usual.
> Just userspace is restored.
> So the driver enters through the probe routine on resume from disk.
> 
Does it then call the resume entry? Rafael's dmesg output has the line "bcm43xx: Resuming..." that
only gets printed if the resume routine was called.

Larry



From proski at gnu.org  Sun Feb 11 18:24:07 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sun, 11 Feb 2007 12:24:07 -0500
Subject: Success on HP Pavilion dv6159eu
In-Reply-To: <200702111203.54533.enrico.gatto@poste.it>
References: <200702111203.54533.enrico.gatto@poste.it>
Message-ID: <20070211122407.nxq6iscockkw4ck4@webmail.spamcop.net>

Hello!

Quoting Enrico Gatto <enrico.gatto at poste.it>:

> Notebook HP Pavilion dv6000
> Wifi adapter Broadcom BCM4310 UART
> Kernel 2.6.20
>
> Wireless card works with this patch:
[skip]
> +       /* Broadcom 4310 on HP notebook */
> +       { PCI_VENDOR_ID_BROADCOM, 0x14e4, PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0 },
[skip]
> 03:00.0 Network controller [0280]: Broadcom Corporation BCM4310 UART
> [14e4:4312] (rev 01)

I don't think your patch is correct.  There is already an entry for 14e4:4312. 
Your patch adds an entry for 14e4:14e4, but you didn't show that you have such
device.

--
Regards,
Pavel Roskin


From ikorot at earthlink.net  Sun Feb 11 18:46:33 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 11 Feb 2007 09:46:33 -0800 (GMT-08:00)
Subject: Dual-boot laptop
Message-ID: <9770644.1171215994350.JavaMail.root@elwamui-rubis.atl.sa.earthlink.net>

Hi, ALL,
Does anybody here have a dual-boot laptop with Windows+Linux?

Thank you.



From ikorot at earthlink.net  Sun Feb 11 19:21:41 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 11 Feb 2007 10:21:41 -0800 (GMT-08:00)
Subject: Dual-boot laptop
Message-ID: <27672800.1171218101448.JavaMail.root@elwamui-rubis.atl.sa.earthlink.net>

Thank you for the fast reply, Jochen and Evan.
I have a DELL E1505 with the Dell Mini PCI 1390 card (4311).
It is mostly booted on Windows.
When I suspend Windows, and then boot Linux (I am using Gentoo flavor), I can't bring the interface up.
I have to reboot Linux and then "ifconfig eth1 up" works.

Anybody experiencing the same problem as myself?

Thank you.

-----Original Message-----
>From: Jochen Puchalla <mail at puchalla-online.de>
>Sent: Feb 11, 2007 9:58 AM
>To: Igor Korot <ikorot at earthlink.net>
>Subject: Re: Dual-boot laptop
>
>[Sonntag, 11. Februar 2007 18:46] schrieb Igor Korot (wrote):
>> Hi, ALL,
>> Does anybody here have a dual-boot laptop with Windows+Linux?
>
>Hi Igor,
>My wife's with the bcm chip does dual-boot, why?
>
>Gru?,
>Jochen 
>-- 
>"In a world without fences and walls, who needs gates and windows?"
>
>Das bessere Office kostenlos: http://de.openoffice.org/
>Einfach der bessere Browser:  http://www.mozilla.com/firefox/all



From evanfoss at gmail.com  Sun Feb 11 19:41:58 2007
From: evanfoss at gmail.com (evan foss)
Date: Sun, 11 Feb 2007 13:41:58 -0500
Subject: Dual-boot laptop
In-Reply-To: <27672800.1171218101448.JavaMail.root@elwamui-rubis.atl.sa.earthlink.net>
References: <27672800.1171218101448.JavaMail.root@elwamui-rubis.atl.sa.earthlink.net>
Message-ID: <4a55afb80702111041mc0dfba4w8ddabcb044859da3@mail.gmail.com>

No I have not had that problem. I am also in Gentoo. I do not however
suspend my machine so I would not have noticed it. Also I have yet to
actually get the interface to work for anything other than kismet. I
am going to try changing kernels later to use the one big patch.


-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From ikorot at earthlink.net  Sun Feb 11 20:27:55 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 11 Feb 2007 11:27:55 -0800 (GMT-08:00)
Subject: Dual-boot laptop
Message-ID: <6405621.1171222076202.JavaMail.root@elwamui-rubis.atl.sa.earthlink.net>

Jochen,
I also use this laptop at home.

Problem is I'm receiving very strange message in my dmesg.

Care to try and respond?
I have latest patches from Larry for the 4311 to work.
I didn't yet apply the very latest one: "Real fix for 4311 and 4312".

Those are my steps:
1. Boot Windows.
2. Wait until I have a connection.
3. Hit Fn+F1 -> Suspend.
4. Hit Power button on laptop and boot Linux.
5. Run "ifconfig eth1 up".

Thank you.

-----Original Message-----
>From: Jochen Puchalla <mail at puchalla-online.de>
>Sent: Feb 11, 2007 10:50 AM
>To: Igor Korot <ikorot at earthlink.net>
>Subject: Re: Dual-boot laptop
>
>[Sonntag, 11. Februar 2007 19:21] schrieb Igor Korot (wrote):
>> Thank you for the fast reply, Jochen and Evan.
>> I have a DELL E1505 with the Dell Mini PCI 1390 card (4311).
>> It is mostly booted on Windows.
>> When I suspend Windows, and then boot Linux (I am using Gentoo flavor), I
>> can't bring the interface up. I have to reboot Linux and then "ifconfig
>> eth1 up" works.
>>
>> Anybody experiencing the same problem as myself?
>
>Sorry, Igor, I don't do suspends, the machine is mainly used at home.
>
>Gru?,
>Jochen
>



From rjw at sisk.pl  Mon Feb 12 01:50:58 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 12 Feb 2007 01:50:58 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45CF3D51.5050302@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702111514.04893.mb@bu3sch.de> <45CF3D51.5050302@lwfinger.net>
Message-ID: <200702120150.59747.rjw@sisk.pl>

On Sunday, 11 February 2007 16:59, Larry Finger wrote:
> Michael Buesch wrote:
> > On Sunday 11 February 2007 15:02, Rafael J. Wysocki wrote:
> >> PM: Removing info for No Bus:0000:30:00.0
> >> bcm43xx: IRQ_READY timeout
> >> bcm43xx: core_up for active 802.11 core failed (-19)
> > 
> > I never tried suspend to disk with the driver.
> 
> This implies that suspend to RAM works. Is that true?
> 
> > Larry, an idea why the microcode doesn't respond?
> 
> Is this code snippet supposed to keep the firmware loaded when the system is suspended?
> 
>                 bcm->firmware_norelease = 1;
>                 bcm43xx_free_board(bcm);
>                 bcm->firmware_norelease = 0;
> 
> If so, that may be the problem. What would force it to be reloaded when resuming after a suspend to
> disk and subsequent power off? That would certainly explain why a reload is successful. Is there a
> volatile location that would safely indicate that the firmware is not good? Perhaps, we need to bite
> the bullet and reload the firmware after every resume. The patch below should do that.
> 
> I am also working on a case where the user has troubles with a suspend to disk from Windows followed
> by a reboot to Linux, and warm reboots from Windows to Linux. In these cases, he gets a firmware
> file-format error; however, his firmware is fine from a cold boot.
> 
> Larry
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -4296,6 +4297,7 @@ static int bcm43xx_resume(struct pci_dev
>  		printk(KERN_ERR PFX "Resume failed!\n");
>  		return err;
>  	}
> +	bcm43xx_request_firmware(bcm);
>  	netif_device_attach(net_dev);
> 
>  	dprintk(KERN_INFO PFX "Device resumed.\n");

It doesn't help in my case.  The behavior is similar to that without the patch,
but also with the patch it loses the association entirely.

Greetings,
Rafael


From larry.finger at lwfinger.net  Mon Feb 12 02:18:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 11 Feb 2007 19:18:26 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702120150.59747.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>	<200702111514.04893.mb@bu3sch.de>
	<45CF3D51.5050302@lwfinger.net> <200702120150.59747.rjw@sisk.pl>
Message-ID: <45CFC062.1050301@lwfinger.net>

Rafael J. Wysocki wrote:
> 
> It doesn't help in my case.  The behavior is similar to that without the patch,
> but also with the patch it loses the association entirely.

Thanks for trying.

Do you have this patch installed? If you do, please try increasing the 100 to 200.


Larry
---
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -21,7 +21,7 @@
 #define PFX				KBUILD_MODNAME ": "

 #define BCM43xx_SWITCH_CORE_MAX_RETRIES	50
-#define BCM43xx_IRQWAIT_MAX_RETRIES	50
+#define BCM43xx_IRQWAIT_MAX_RETRIES	100

 #define BCM43xx_IO_SIZE			8192







From ranma at tdiedrich.de  Mon Feb 12 07:25:01 2007
From: ranma at tdiedrich.de (Tobias Diedrich)
Date: Mon, 12 Feb 2007 07:25:01 +0100
Subject: The new SSB subsystem for bcm43xx (and others)
In-Reply-To: <200702111325.29620.mb@bu3sch.de>
References: <200612221359.25093.mb@bu3sch.de>
	<20070210221150.GA28338@srcf.ucam.org>
	<20070211071841.GA7874@melchior.yamamaya.is-a-geek.org>
	<200702111325.29620.mb@bu3sch.de>
Message-ID: <20070212062501.GA4756@melchior.yamamaya.is-a-geek.org>

Michael Buesch wrote:

> > What if I configure the kernel without PCI support?
> 
> I already applied the correct patch to my tree. ;)
> 
> > BTW, is the SSB b44 driver/patch available somewhere?
> 
> In my tree.

Oh, last time I looked it wasn't there yet, thanks. :)

-- 
Tobias						PGP: http://9ac7e0bc.uguu.de
??????????????????????????


From johannes at sipsolutions.net  Mon Feb 12 09:12:08 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 12 Feb 2007 09:12:08 +0100
Subject: [PATCH 1/4] create cfg80211
In-Reply-To: <1171222767.3576.2.camel@johannes.berg>
References: <20070209162711.375886000@sipsolutions.net>
	<20070209162826.930724000@sipsolutions.net>
	<1171222767.3576.2.camel@johannes.berg>
Message-ID: <1171267928.4881.9.camel@johannes.berg>

On Sun, 2007-02-11 at 20:39 +0100, Johannes Berg wrote:
> On Fri, 2007-02-09 at 17:27 +0100, johannes at sipsolutions.net wrote:

> [...]
> needs to be changed. wiphy_free() should wait for
> wiphy_class_dev_release (to make sure sysfs is gone) before freeing the
> structure (if it has ever been added to sysfs).

On second thought, no, that's perfectly correct. There's a slight bug
however in the registration, it must not set wiphy_index when sysfs
registration fails.

The real bug I'm chasing (use-after-free leading to oops when rmmod'ing
bcm43xx-d80211 while device is up) is in bcm43xx-d80211 and I found it
too. Consider the following changes I made to debug:

diff --git a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
index 9f4d51d..5205859 100644
--- a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
+++ b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
@@ -1479,6 +1479,8 @@ static irqreturn_t bcm43xx_interrupt_handler(int irq, void *dev_id)
 	if (!dev)
 		return IRQ_NONE;
 
+	printk(KERN_INFO "bcm43xx_interrupt_handler\n");
+
 	spin_lock(&dev->wl->irq_lock);
 
 	assert(bcm43xx_status(dev) == BCM43xx_STAT_INITIALIZED);
@@ -3453,7 +3455,8 @@ static void bcm43xx_one_core_detach(struct ssb_device *dev)
 	list_del(&wldev->list);
 	wl->nr_devs--;
 	ssb_set_drvdata(dev, NULL);
-	kfree(wldev);
+	printk(KERN_INFO "kfree(wldev)\n");
+//	kfree(wldev);
 }
 
 static int bcm43xx_one_core_attach(struct ssb_device *dev,
@@ -3535,8 +3538,10 @@ static void bcm43xx_wireless_exit(struct ssb_device *dev,
 {
 	struct ieee80211_hw *hw = wl->hw;
 
+	printk(KERN_INFO "bcm43xx_wireless_exit(): unregister_hw()\n");
 	ieee80211_unregister_hw(hw);
 	ssb_set_devtypedata(dev, NULL);
+	printk(KERN_INFO "bcm43xx_wireless_exit(): free_hw()\n");
 	ieee80211_free_hw(hw);
 }
 

Now remember the oops I got which was a use-after-free in the interrupt handler.

Now also consider this message log I got when inserting bcm43xx,
scanning (I removed some interrupt messages), and then removing the
module again:

[ 1443.269289] wlan0: starting scan
[ 1443.316409] bcm43xx_interrupt_handler
...
[ 1444.016378] bcm43xx_interrupt_handler
[ 1444.053623] wlan0: scan completed
[ 1445.317311] kfree(wldev)
[ 1445.317931] bcm43xx_wireless_exit(): unregister_hw()
[ 1445.385872] bcm43xx_d80211: Wireless interface stopped
[ 1445.386554] bcm43xx_d80211: Removing Interface type 2
[ 1445.387219] bcm43xx_d80211: DMA-32 0x0200 (RX) max used slots: 0/64
[ 1445.389551] bcm43xx_d80211: DMA-32 0x02A0 (TX) max used slots: 0/128
[ 1445.390609] bcm43xx_d80211: DMA-32 0x0280 (TX) max used slots: 0/128
[ 1445.391678] bcm43xx_d80211: DMA-32 0x0260 (TX) max used slots: 0/128
[ 1445.392756] bcm43xx_d80211: DMA-32 0x0240 (TX) max used slots: 0/128
[ 1445.393821] bcm43xx_d80211: DMA-32 0x0220 (TX) max used slots: 2/128
[ 1445.394869] bcm43xx_d80211: DMA-32 0x0200 (TX) max used slots: 0/128
[ 1445.395924] bcm43xx_d80211: Radio turned off
[ 1445.516479] bcm43xx_wireless_exit(): free_hw()
[ 1445.517144] wiphy_free()
[ 1445.518029] PM: Removing info for ssb:ssb04:04
[ 1445.518164] PM: Removing info for ssb:ssb04:03
[ 1445.518284] PM: Removing info for ssb:ssb04:02
[ 1445.518405] PM: Removing info for ssb:ssb04:01
[ 1445.518597] PM: Removing info for ssb:ssb04:00


Now let's also take a look at the code that prints "Wireless interface
stopped". That function is bcm43xx_wireless_core_stop(), which is passed
a struct bcm43xx_wldev, precisely the one that two lines before was
passed to that kfree()...

So what happens is that sometimes a whole bunch of things in
bcm43xx_wireless_core_stop will not work properly due to the
use-after-free we have here. Unless you have slab debugging disabled
(like me) where of course it fails every time...

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070212/b152191c/attachment.pgp>

From mail at puchalla-online.de  Mon Feb 12 11:22:48 2007
From: mail at puchalla-online.de (Jochen Puchalla)
Date: Mon, 12 Feb 2007 11:22:48 +0100
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45CCA8A6.4090808@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net>
	<45CC3B94.4050006@puchalla-online.de>
	<45CCA8A6.4090808@lwfinger.net>
Message-ID: <200702121122.52750.mail@puchalla-online.de>

[Freitag, 9. Februar 2007 18:00] schrieb Larry Finger (wrote):
> Jochen Puchalla wrote:
> > Hi Larry,
> >
> > I tried both versions with the combined patch on 2.6.20-rc7, still only
> > 100kB/s. Could this be related to the fact that I have a b-type router
> > and not a g-type?
>
> It shouldn't. I just ran tests here with different settings on my AP. With
> a B-only setting, I get a maximum of 5.5 Mbs. In Mixed B/G-mode, I get 5.9
> Mbs and with G only, the rate is 6.3 Mbs. All of these were run with an
> iwconfig rate of 11 Mbs.

Hi Larry,

finally I switched to 2.6.20 and your second revision patch and it works! 
I get >2Mbps with iperf, that's great! 
Probably the maximum rate was also reduced by another network on the same 
channel, now I switched to an exclusive channel and the rate doesn't drop.
Green light for upstream from me :-)
Again, many thanks!

Gru?,
Jochen 
-- 
"In a world without fences and walls, who needs gates and windows?"

Das bessere Office kostenlos: http://de.openoffice.org/
Einfach der bessere Browser:  http://www.mozilla.com/firefox/all
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070212/5d6ad3d5/attachment.pgp>

From rjw at sisk.pl  Mon Feb 12 21:48:57 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Mon, 12 Feb 2007 21:48:57 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45CFC062.1050301@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702120150.59747.rjw@sisk.pl> <45CFC062.1050301@lwfinger.net>
Message-ID: <200702122148.58101.rjw@sisk.pl>

On Monday, 12 February 2007 02:18, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > 
> > It doesn't help in my case.  The behavior is similar to that without the patch,
> > but also with the patch it loses the association entirely.
> 
> Thanks for trying.
> 
> Do you have this patch installed? If you do, please try increasing the 100 to 200.

Hm, but it wouldn't help to get the microcode to respond after the resume ...

I'm still thinking the problem is with the firmware.  Where exactly is it
stored?

> 
> 
> Larry
> ---
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> @@ -21,7 +21,7 @@
>  #define PFX				KBUILD_MODNAME ": "
> 
>  #define BCM43xx_SWITCH_CORE_MAX_RETRIES	50
> -#define BCM43xx_IRQWAIT_MAX_RETRIES	50
> +#define BCM43xx_IRQWAIT_MAX_RETRIES	100
> 
>  #define BCM43xx_IO_SIZE			8192
> 

Greetings,
Rafael


From larry.finger at lwfinger.net  Mon Feb 12 23:20:36 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 12 Feb 2007 16:20:36 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702122148.58101.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702120150.59747.rjw@sisk.pl> <45CFC062.1050301@lwfinger.net>
	<200702122148.58101.rjw@sisk.pl>
Message-ID: <45D0E834.4050800@lwfinger.net>

Rafael J. Wysocki wrote:
> On Monday, 12 February 2007 02:18, Larry Finger wrote:
>> Rafael J. Wysocki wrote:
>>> It doesn't help in my case.  The behavior is similar to that without the patch,
>>> but also with the patch it loses the association entirely.
>> Thanks for trying.
>>
>> Do you have this patch installed? If you do, please try increasing the 100 to 200.
> 
> Hm, but it wouldn't help to get the microcode to respond after the resume ...

Yes it would. That count is how long the system waits for the firmware to respond.

> I'm still thinking the problem is with the firmware.  Where exactly is it
> stored?

In the memory of the microprocessor on the card.

Please do what I asked.

Larry


From rjw at sisk.pl  Tue Feb 13 00:08:46 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 13 Feb 2007 00:08:46 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45D0E834.4050800@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702122148.58101.rjw@sisk.pl> <45D0E834.4050800@lwfinger.net>
Message-ID: <200702130008.47684.rjw@sisk.pl>

On Monday, 12 February 2007 23:20, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > On Monday, 12 February 2007 02:18, Larry Finger wrote:
> >> Rafael J. Wysocki wrote:
> >>> It doesn't help in my case.  The behavior is similar to that without the patch,
> >>> but also with the patch it loses the association entirely.
> >> Thanks for trying.
> >>
> >> Do you have this patch installed? If you do, please try increasing the 100 to 200.
> > 
> > Hm, but it wouldn't help to get the microcode to respond after the resume ...
> 
> Yes it would. That count is how long the system waits for the firmware to respond.
> 
> > I'm still thinking the problem is with the firmware.  Where exactly is it
> > stored?
> 
> In the memory of the microprocessor on the card.
> 
> Please do what I asked.

With or without the previous patch?

Rafael


From larry.finger at lwfinger.net  Tue Feb 13 00:18:44 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 12 Feb 2007 17:18:44 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702130008.47684.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>	<200702122148.58101.rjw@sisk.pl>
	<45D0E834.4050800@lwfinger.net> <200702130008.47684.rjw@sisk.pl>
Message-ID: <45D0F5D4.3070305@lwfinger.net>

Rafael J. Wysocki wrote:
> On Monday, 12 February 2007 23:20, Larry Finger wrote:
>> Rafael J. Wysocki wrote:
>>> On Monday, 12 February 2007 02:18, Larry Finger wrote:
>>>> Rafael J. Wysocki wrote:
>>>>> It doesn't help in my case.  The behavior is similar to that without the patch,
>>>>> but also with the patch it loses the association entirely.
>>>> Thanks for trying.
>>>>
>>>> Do you have this patch installed? If you do, please try increasing the 100 to 200.
>>> Hm, but it wouldn't help to get the microcode to respond after the resume ...
>> Yes it would. That count is how long the system waits for the firmware to respond.
>>
>>> I'm still thinking the problem is with the firmware.  Where exactly is it
>>> stored?
>> In the memory of the microprocessor on the card.
>>
>> Please do what I asked.
> 
> With or without the previous patch?

With the change to BCM43xx_IRQWAIT_MAX_RETRIES, but not the one that tries to reload the firmware.

Larry



From mb at bu3sch.de  Tue Feb 13 00:24:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 Feb 2007 00:24:20 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702130008.47684.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<45D0E834.4050800@lwfinger.net> <200702130008.47684.rjw@sisk.pl>
Message-ID: <200702130024.20876.mb@bu3sch.de>

On Tuesday 13 February 2007 00:08, Rafael J. Wysocki wrote:
> On Monday, 12 February 2007 23:20, Larry Finger wrote:
> > Rafael J. Wysocki wrote:
> > > On Monday, 12 February 2007 02:18, Larry Finger wrote:
> > >> Rafael J. Wysocki wrote:
> > >>> It doesn't help in my case.  The behavior is similar to that without the patch,
> > >>> but also with the patch it loses the association entirely.
> > >> Thanks for trying.
> > >>
> > >> Do you have this patch installed? If you do, please try increasing the 100 to 200.
> > > 
> > > Hm, but it wouldn't help to get the microcode to respond after the resume ...
> > 
> > Yes it would. That count is how long the system waits for the firmware to respond.
> > 
> > > I'm still thinking the problem is with the firmware.  Where exactly is it
> > > stored?
> > 
> > In the memory of the microprocessor on the card.
> > 
> > Please do what I asked.
> 
> With or without the previous patch?

Both, please.

-- 
Greetings Michael.


From mb at bu3sch.de  Tue Feb 13 01:15:31 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 Feb 2007 01:15:31 +0100
Subject: [PATCH 1/4] create cfg80211
In-Reply-To: <1171267928.4881.9.camel@johannes.berg>
References: <20070209162711.375886000@sipsolutions.net>
	<1171222767.3576.2.camel@johannes.berg>
	<1171267928.4881.9.camel@johannes.berg>
Message-ID: <200702130115.32118.mb@bu3sch.de>

On Monday 12 February 2007 09:12, Johannes Berg wrote:
> The real bug I'm chasing (use-after-free leading to oops when rmmod'ing
> bcm43xx-d80211 while device is up) is in bcm43xx-d80211 and I found it
> too. Consider the following changes I made to debug:

Should be fixed in my tree now.
Thanks for the good bugreport.

-- 
Greetings Michael.


From arbouzas at gmail.com  Tue Feb 13 11:00:48 2007
From: arbouzas at gmail.com (=?ISO-8859-1?Q?Alberto_Rodr=EDguez_Bouzas?=)
Date: Tue, 13 Feb 2007 11:00:48 +0100
Subject: A problem with the sprom utility
Message-ID: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>

Hello, i have got a problem when trying to read values from the SPROM memory
i get allways the same answer:

No input data.

When trying to write: (255) Could not modify SPROM data.

My card has the following numbers:

Chipset:4306
Product id: 4320
Subsystem vendor: 14e4
Subsystem product id: 0453

I have configured it correctly under Ubuntu edgy into a Toshiba notebook
following the ubuntu guide and it works fine.

The problem is that i can't get this card to work in HP or Compaq notebooks,
so what i wanted to do is to modify the subsystem id to match the whitelist
stored in HP and Compaq notebooks, so this card can work into this
notebooks.

Thanks for your attention.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/2e2c304b/attachment.html>

From mb at bu3sch.de  Tue Feb 13 11:53:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 Feb 2007 11:53:20 +0100
Subject: A problem with the sprom utility
In-Reply-To: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
Message-ID: <200702131153.20868.mb@bu3sch.de>

On Tuesday 13 February 2007 11:00, Alberto Rodr?guez Bouzas wrote:
> Hello, i have got a problem when trying to read values from the SPROM memory
> i get allways the same answer:
> 
> No input data.
> 
> When trying to write: (255) Could not modify SPROM data.
> 
> My card has the following numbers:
> 
> Chipset:4306
> Product id: 4320
> Subsystem vendor: 14e4
> Subsystem product id: 0453
> 
> I have configured it correctly under Ubuntu edgy into a Toshiba notebook
> following the ubuntu guide and it works fine.
> 
> The problem is that i can't get this card to work in HP or Compaq notebooks,
> so what i wanted to do is to modify the subsystem id to match the whitelist
> stored in HP and Compaq notebooks, so this card can work into this
> notebooks.
> 
> Thanks for your attention.

Ehm, how are you calling the tool?

-- 
Greetings Michael.


From stefano.brivio at polimi.it  Tue Feb 13 11:45:26 2007
From: stefano.brivio at polimi.it (Stefano Brivio)
Date: Tue, 13 Feb 2007 11:45:26 +0100
Subject: A problem with the sprom utility
In-Reply-To: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
Message-ID: <20070213114526.6ac7802c@localhost>

On Tue, 13 Feb 2007 11:00:48 +0100
"Alberto Rodr?guez Bouzas" <arbouzas at gmail.com> wrote:

> Hello, i have got a problem when trying to read values from the SPROM
> memory i get allways the same answer:

How are you doing it?

> No input data.
> 
> When trying to write: (255) Could not modify SPROM data.

Ditto.


-- 
Ciao
Stefano


From arbouzas at gmail.com  Tue Feb 13 12:53:54 2007
From: arbouzas at gmail.com (=?ISO-8859-1?Q?Alberto_Rodr=EDguez_Bouzas?=)
Date: Tue, 13 Feb 2007 12:53:54 +0100
Subject: A problem with the sprom utility
In-Reply-To: <200702131153.20868.mb@bu3sch.de>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<200702131153.20868.mb@bu3sch.de>
Message-ID: <21f66e860702130353t5ca5592r3b8ca3409115004c@mail.gmail.com>

On 2/13/07, Michael Buesch <mb at bu3sch.de> wrote:
> On Tuesday 13 February 2007 11:00, Alberto Rodr?guez Bouzas wrote:
> > Hello, i have got a problem when trying to read values from the SPROM memory
> > i get allways the same answer:
> >
> > No input data.
> >
> > When trying to write: (255) Could not modify SPROM data.
> >
> > My card has the following numbers:
> >
> > Chipset:4306
> > Product id: 4320
> > Subsystem vendor: 14e4
> > Subsystem product id: 0453
> >
> > I have configured it correctly under Ubuntu edgy into a Toshiba notebook
> > following the ubuntu guide and it works fine.
> >
> > The problem is that i can't get this card to work in HP or Compaq notebooks,
> > so what i wanted to do is to modify the subsystem id to match the whitelist
> > stored in HP and Compaq notebooks, so this card can work into this
> > notebooks.
> >
> > Thanks for your attention.
>
> Ehm, how are you calling the tool?
>
> --
> Greetings Michael.
>


I have tried with shprommod.sh and with bcm43xx-sprom.

For example:

./shprommod.sh eth1 -g 0x08
./bcm43xx-sprom -g 0x08

with the same result

and trying to write with

./shpromod.sh eth1 -s 0x08,0x53
./bcm43xx-sprom -s 0x08,0x53

all coomands being root, otherway it returns a permission error


From larry.finger at lwfinger.net  Tue Feb 13 16:25:19 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 09:25:19 -0600
Subject: A problem with the sprom utility
In-Reply-To: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
Message-ID: <45D1D85F.60803@lwfinger.net>

Alberto Rodr?guez Bouzas wrote:
> Hello, i have got a problem when trying to read values from the SPROM
> memory i get allways the same answer:
> 
> No input data.
> 
> When trying to write: (255) Could not modify SPROM data.
> 
> My card has the following numbers:
> 
> Chipset:4306
> Product id: 4320
> Subsystem vendor: 14e4
> Subsystem product id: 0453
> 
> I have configured it correctly under Ubuntu edgy into a Toshiba notebook
> following the ubuntu guide and it works fine.
> 
> The problem is that i can't get this card to work in HP or Compaq
> notebooks, so what i wanted to do is to modify the subsystem id to match
> the whitelist stored in HP and Compaq notebooks, so this card can work
> into this notebooks.

Can someone explain this "whitelist" to me?

Larry



From rjw at sisk.pl  Tue Feb 13 17:25:43 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 13 Feb 2007 17:25:43 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702130024.20876.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702130008.47684.rjw@sisk.pl> <200702130024.20876.mb@bu3sch.de>
Message-ID: <200702131725.45033.rjw@sisk.pl>

On Tuesday, 13 February 2007 00:24, Michael Buesch wrote:
> On Tuesday 13 February 2007 00:08, Rafael J. Wysocki wrote:
> > On Monday, 12 February 2007 23:20, Larry Finger wrote:
> > > Rafael J. Wysocki wrote:
> > > > On Monday, 12 February 2007 02:18, Larry Finger wrote:
> > > >> Rafael J. Wysocki wrote:
> > > >>> It doesn't help in my case.  The behavior is similar to that without the patch,
> > > >>> but also with the patch it loses the association entirely.
> > > >> Thanks for trying.
> > > >>
> > > >> Do you have this patch installed? If you do, please try increasing the 100 to 200.
> > > > 
> > > > Hm, but it wouldn't help to get the microcode to respond after the resume ...
> > > 
> > > Yes it would. That count is how long the system waits for the firmware to respond.
> > > 
> > > > I'm still thinking the problem is with the firmware.  Where exactly is it
> > > > stored?
> > > 
> > > In the memory of the microprocessor on the card.
> > > 
> > > Please do what I asked.
> > 
> > With or without the previous patch?
> 
> Both, please.

It doesn't help in either case.  I get

albercik:~ # ifconfig eth1 down
albercik:~ # ifconfig eth1 up
SIOCSIFFLAGS: No such device

in both cases.

I think the problem is that the firmware is not present and requesting it 
doesn't work for some reason.

Greetings,
Rafael


From johannes at sipsolutions.net  Tue Feb 13 17:28:35 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 13 Feb 2007 17:28:35 +0100
Subject: A problem with the sprom utility
In-Reply-To: <45D1D85F.60803@lwfinger.net>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<45D1D85F.60803@lwfinger.net>
Message-ID: <1171384115.10344.41.camel@johannes.berg>

On Tue, 2007-02-13 at 09:25 -0600, Larry Finger wrote:

> > The problem is that i can't get this card to work in HP or Compaq
> > notebooks, so what i wanted to do is to modify the subsystem id to match
> > the whitelist stored in HP and Compaq notebooks, so this card can work
> > into this notebooks.
> 
> Can someone explain this "whitelist" to me?

The BIOS in some notebooks (HP, Compaq but also Thinkpads for example)
includes a "whitelist" of valid miniPCI (wireless) cards you are allowed
to plug in. On any other card the BIOS will usually refuse to boot up
the computer with a message saying that the card is not supported.

This often keys off the subvendor or subsystem PCI IDs in the card which
with Broadcom cards we can modify easily.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/3e743605/attachment.pgp>

From larry.finger at lwfinger.net  Tue Feb 13 18:02:42 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 11:02:42 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702131725.45033.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702130008.47684.rjw@sisk.pl> <200702130024.20876.mb@bu3sch.de>
	<200702131725.45033.rjw@sisk.pl>
Message-ID: <45D1EF32.4060506@lwfinger.net>

Rafael J. Wysocki wrote:
> On Tuesday, 13 February 2007 00:24, Michael Buesch wrote:
>> On Tuesday 13 February 2007 00:08, Rafael J. Wysocki wrote:
>>> On Monday, 12 February 2007 23:20, Larry Finger wrote:
>>>> Rafael J. Wysocki wrote:
>>>>> On Monday, 12 February 2007 02:18, Larry Finger wrote:
>>>>>> Rafael J. Wysocki wrote:
>>>>>>> It doesn't help in my case.  The behavior is similar to that without the patch,
>>>>>>> but also with the patch it loses the association entirely.
>>>>>> Thanks for trying.
>>>>>>
>>>>>> Do you have this patch installed? If you do, please try increasing the 100 to 200.
>>>>> Hm, but it wouldn't help to get the microcode to respond after the resume ...
>>>> Yes it would. That count is how long the system waits for the firmware to respond.
>>>>
>>>>> I'm still thinking the problem is with the firmware.  Where exactly is it
>>>>> stored?
>>>> In the memory of the microprocessor on the card.
>>>>
>>>> Please do what I asked.
>>> With or without the previous patch?
>> Both, please.
> 
> It doesn't help in either case.  I get
> 
> albercik:~ # ifconfig eth1 down
> albercik:~ # ifconfig eth1 up
> SIOCSIFFLAGS: No such device
> 
> in both cases.
> 
> I think the problem is that the firmware is not present and requesting it 
> doesn't work for some reason.

PLEASE SEND OUTPUT FROM dmesg!!!!!!!!!!!!!!!!!!!!!

Larry


From larry.finger at lwfinger.net  Tue Feb 13 19:04:00 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 12:04:00 -0600
Subject: A problem with the sprom utility
In-Reply-To: <1171384115.10344.41.camel@johannes.berg>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>	
	<45D1D85F.60803@lwfinger.net>
	<1171384115.10344.41.camel@johannes.berg>
Message-ID: <45D1FD90.2050207@lwfinger.net>

Johannes Berg wrote:
> On Tue, 2007-02-13 at 09:25 -0600, Larry Finger wrote:
> 
>>> The problem is that i can't get this card to work in HP or Compaq
>>> notebooks, so what i wanted to do is to modify the subsystem id to match
>>> the whitelist stored in HP and Compaq notebooks, so this card can work
>>> into this notebooks.
>> Can someone explain this "whitelist" to me?
> 
> The BIOS in some notebooks (HP, Compaq but also Thinkpads for example)
> includes a "whitelist" of valid miniPCI (wireless) cards you are allowed
> to plug in. On any other card the BIOS will usually refuse to boot up
> the computer with a message saying that the card is not supported.
> 
> This often keys off the subvendor or subsystem PCI IDs in the card which
> with Broadcom cards we can modify easily.

Thanks. I figured it had something to do with Big Brother in Redmond. Obviously, Microsoft doesn't
want you to do whatever you want with your computer. Their OS (sic) breaks enough with a tightly
controlled hardware list.

If I'm grumpy today, it is bacause my wife just got a new laptop with Vista on it and nothing works now.

Larry




From johannes at sipsolutions.net  Tue Feb 13 19:05:11 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 13 Feb 2007 19:05:11 +0100
Subject: A problem with the sprom utility
In-Reply-To: <45D1FD90.2050207@lwfinger.net>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<45D1D85F.60803@lwfinger.net> <1171384115.10344.41.camel@johannes.berg>
	<45D1FD90.2050207@lwfinger.net>
Message-ID: <1171389911.10344.70.camel@johannes.berg>

On Tue, 2007-02-13 at 12:04 -0600, Larry Finger wrote:

> If I'm grumpy today, it is bacause my wife just got a new laptop with Vista on it and nothing works now.

http://www.schneier.com/blog/archives/2007/02/drm_in_windows.html

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/661a1a26/attachment.pgp>

From larry.finger at lwfinger.net  Tue Feb 13 19:51:00 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 12:51:00 -0600
Subject: A problem with the sprom utility
In-Reply-To: <1171389911.10344.70.camel@johannes.berg>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>	
	<45D1D85F.60803@lwfinger.net>
	<1171384115.10344.41.camel@johannes.berg>	
	<45D1FD90.2050207@lwfinger.net>
	<1171389911.10344.70.camel@johannes.berg>
Message-ID: <45D20894.8040407@lwfinger.net>

Johannes Berg wrote:
> On Tue, 2007-02-13 at 12:04 -0600, Larry Finger wrote:
> 
>> If I'm grumpy today, it is bacause my wife just got a new laptop with Vista on it and nothing works now.
> 
> http://www.schneier.com/blog/archives/2007/02/drm_in_windows.html

We haven't even gotten to DRM. That probably won't be much of a problem as our computers aren't used
for watching movies nor for playing music. We're not of the iPod generation.

We may have DOA hardware, but the system cannot even read the DVD's it makes. When I pop them into
my openSUSE 10.2 system, up pops Konquerer with the expected directory. In addition, the Vista
computer cannot see the local network. It finds the router and can get to the internet, but cannot
see the local Samba server nor the other machine that runs XP. The XP machine sees it, but not vice
versa. We are now running sneakernet with a 512 MB thumb drive!

What passes for a firewall on Vista is really annoying. The Apple commercial spoofing it
(http://www.youtube.com/watch?v=FfetbidVUYw) is pretty close to the truth.

Larry


From mail at puchalla-online.de  Tue Feb 13 20:26:09 2007
From: mail at puchalla-online.de (Jochen Puchalla)
Date: Tue, 13 Feb 2007 20:26:09 +0100
Subject: A problem with the sprom utility
In-Reply-To: <45D20894.8040407@lwfinger.net>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<1171389911.10344.70.camel@johannes.berg>
	<45D20894.8040407@lwfinger.net>
Message-ID: <200702132026.14411.mail@puchalla-online.de>

[Dienstag, 13. Februar 2007 19:51] schrieb Larry Finger (wrote):
> Johannes Berg wrote:
> > On Tue, 2007-02-13 at 12:04 -0600, Larry Finger wrote:
> >> If I'm grumpy today, it is bacause my wife just got a new laptop with
> >> Vista on it and nothing works now.
> >
> > http://www.schneier.com/blog/archives/2007/02/drm_in_windows.html
>
> We haven't even gotten to DRM. That probably won't be much of a problem as
> our computers aren't used for watching movies nor for playing music. We're
> not of the iPod generation.
>
> We may have DOA hardware, but the system cannot even read the DVD's it
> makes. When I pop them into my openSUSE 10.2 system, up pops Konquerer with
> the expected directory. In addition, the Vista computer cannot see the
> local network. It finds the router and can get to the internet, but cannot
> see the local Samba server nor the other machine that runs XP. The XP
> machine sees it, but not vice versa. We are now running sneakernet with a
> 512 MB thumb drive!

If that's no reason to get the money back...
MS checks how far they can go, obviously.

Gru?,
Jochen 
-- 
"In a world without fences and walls, who needs gates and windows?"

Das bessere Office kostenlos: http://de.openoffice.org/
Einfach der bessere Browser:  http://www.mozilla.com/firefox/all
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/1568bf0c/attachment.pgp>

From proski at gnu.org  Tue Feb 13 20:29:38 2007
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 13 Feb 2007 14:29:38 -0500
Subject: A problem with the sprom utility
In-Reply-To: <45D1FD90.2050207@lwfinger.net>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<45D1D85F.60803@lwfinger.net> <1171384115.10344.41.camel@johannes.berg>
	<45D1FD90.2050207@lwfinger.net>
Message-ID: <1171394978.2414.25.camel@dv>

On Tue, 2007-02-13 at 12:04 -0600, Larry Finger wrote:

> > This often keys off the subvendor or subsystem PCI IDs in the card which
> > with Broadcom cards we can modify easily.
> 
> Thanks. I figured it had something to do with Big Brother in Redmond.

To be fair to Big Brothers, it's the one in Washington, DC.  Laptops are
FCC-certified with certain wireless cards, and the laptop manufacturers
think it's their duty to prevent end users from sticking unapproved
cards into their laptops.

I'm not sure about HP/Compaq, but Thinkpads check the card in BIOS.  The
fix is to patch CMOS:

http://www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card

Atheros cards should also be patched so that they don't appear as
Ethernet controllers (PCI_CLASS_NETWORK_ETHERNET = 0x200), but as "other
network devices (PCI_CLASS_NETWORK_OTHER = 0x280).  Broadcom got it
right, I believe.

I heard that the new Lenovo Thinkpads are not so obnoxious as those made
by IBM.

-- 
Regards,
Pavel Roskin



From rjw at sisk.pl  Tue Feb 13 22:08:19 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 13 Feb 2007 22:08:19 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45D1EF32.4060506@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702131725.45033.rjw@sisk.pl> <45D1EF32.4060506@lwfinger.net>
Message-ID: <200702132208.19974.rjw@sisk.pl>

On Tuesday, 13 February 2007 18:02, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > On Tuesday, 13 February 2007 00:24, Michael Buesch wrote:
> >> On Tuesday 13 February 2007 00:08, Rafael J. Wysocki wrote:
> >>> On Monday, 12 February 2007 23:20, Larry Finger wrote:
> >>>> Rafael J. Wysocki wrote:
> >>>>> On Monday, 12 February 2007 02:18, Larry Finger wrote:
> >>>>>> Rafael J. Wysocki wrote:
> >>>>>>> It doesn't help in my case.  The behavior is similar to that without the patch,
> >>>>>>> but also with the patch it loses the association entirely.
> >>>>>> Thanks for trying.
> >>>>>>
> >>>>>> Do you have this patch installed? If you do, please try increasing the 100 to 200.
> >>>>> Hm, but it wouldn't help to get the microcode to respond after the resume ...
> >>>> Yes it would. That count is how long the system waits for the firmware to respond.
> >>>>
> >>>>> I'm still thinking the problem is with the firmware.  Where exactly is it
> >>>>> stored?
> >>>> In the memory of the microprocessor on the card.
> >>>>
> >>>> Please do what I asked.
> >>> With or without the previous patch?
> >> Both, please.
> > 
> > It doesn't help in either case.  I get
> > 
> > albercik:~ # ifconfig eth1 down
> > albercik:~ # ifconfig eth1 up
> > SIOCSIFFLAGS: No such device
> > 
> > in both cases.
> > 
> > I think the problem is that the firmware is not present and requesting it 
> > doesn't work for some reason.
> 
> PLEASE SEND OUTPUT FROM dmesg!!!!!!!!!!!!!!!!!!!!!

Okay, okay.

The first one (dmesg.log.gz) is for the driver with bcm43xx_request_firmware(bcm)
in bcm43xx_resume().  The other one is for the driver without it.

BCM43xx_IRQWAIT_MAX_RETRIES was set to 100 in both cases.

Greetings,
Rafael
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dmesg.log.gz
Type: application/x-gzip
Size: 6315 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/29e2e0e2/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dmesg-2.log.gz
Type: application/x-gzip
Size: 6122 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070213/29e2e0e2/attachment-0001.bin>

From mb at bu3sch.de  Tue Feb 13 22:54:11 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 Feb 2007 22:54:11 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702132208.19974.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<45D1EF32.4060506@lwfinger.net> <200702132208.19974.rjw@sisk.pl>
Message-ID: <200702132254.12126.mb@bu3sch.de>

Did you already try my tree? I fixed resume there by completely
reinitializing the device on resume.

git clone http://bu3sch.de/git/wireless-dev.git

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Tue Feb 13 23:19:57 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 16:19:57 -0600
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <20070213211340.GG3572@tuxdriver.com>
References: <45C96B8A.8010000@lwfinger.net> <1170830071.11150.62.camel@dv>
	<200702071443.19676.rjw@sisk.pl> <45C9D9D6.2070700@lwfinger.net>
	<a44ae5cd0702101530j38c983bfy9c1496fd50ca8b1c@mail.gmail.com>
	<45CE5812.3000306@lwfinger.net>
	<20070213211340.GG3572@tuxdriver.com>
Message-ID: <45D2398D.7050104@lwfinger.net>

John W. Linville wrote:
> On Sat, Feb 10, 2007 at 05:41:06PM -0600, Larry Finger wrote:
>> Miles Lane wrote:
>>> I am testing this patch applied to the wireless-net git tree.
>>> The card is a Linksys WPC54G.  The card is still getting very
>>> weak signal strength and the connection seems unresponsive
>>> most of the time.
>> As the subject says, the patch was for 4311 and 4312 cards. The 4318's are not yet fixed.
>>
>> As measured by my RF receiver, the amplitude of the 4318 is about -70 dBm, the 4311 is about -60 dBm
>> and the 4306 is -50 dBm. All should have the -50 reading with my test setup.
>>
>> I'm working on the power routines and will let you know.
> 
> FWIW, this patch seems to have helped some BCM4311 and BCM4312 wielding
> Fedora users.

I think most, if not all, the 4311 and 4312's are helped. I will be submitting a set of patches this
afternoon that help most cards.

Larry


From rjw at sisk.pl  Tue Feb 13 23:47:20 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 13 Feb 2007 23:47:20 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702132254.12126.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702132208.19974.rjw@sisk.pl> <200702132254.12126.mb@bu3sch.de>
Message-ID: <200702132347.20956.rjw@sisk.pl>

On Tuesday, 13 February 2007 22:54, Michael Buesch wrote:
> Did you already try my tree? I fixed resume there by completely
> reinitializing the device on resume.

No, I didn't.  So far I've had no time to set up a git tree on my box.
I'll try when I finally do it (but probably not any time soon ;-)).

Greetings,
Rafael


From Larry.Finger at lwfinger.net  Tue Feb 13 23:54:56 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 16:54:56 -0600
Subject: [PATCH] bcm43xx: Fix for 4311 and 02/07/07 specification changes
Message-ID: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>

The specifications for the bcm43xx driver have been modified. This patch
incorporates these changes in the code, which results in the BCM4311 and
BCM4312 working. The name of one of the PHY parameters, previously known
as "version", has been changed to "analog", short for  "analog core version" .

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---

John,

I hope this fix makes it into 2.6.21. It is the main one that makes 4311 and
4312 cards work.

Larry
---

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -333,7 +333,7 @@
 #define BCM43xx_SBF_PS2			0x04000000
 #define BCM43xx_SBF_NO_SSID_BCAST	0x08000000
 #define BCM43xx_SBF_TIME_UPDATE		0x10000000
-#define BCM43xx_SBF_80000000		0x80000000 /*FIXME: fix name*/
+#define BCM43xx_SBF_MODE_G		0x80000000
 
 /* Microcode */
 #define BCM43xx_UCODE_REVISION		0x0000
@@ -540,7 +540,7 @@ struct bcm43xx_lopair {
 
 struct bcm43xx_phyinfo {
 	/* Hardware Data */
-	u8 version;
+	u8 analog;
 	u8 type;
 	u8 rev;
 	u16 antenna_diversity;
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -205,8 +205,8 @@ static void bcm43xx_phy_init_pctl(struct
 	    (bcm->board_type == 0x0416))
 		return;
 
-	bcm43xx_write16(bcm, 0x03E6, bcm43xx_read16(bcm, 0x03E6) & 0xFFDF);
 	bcm43xx_phy_write(bcm, 0x0028, 0x8018);
+	bcm43xx_write16(bcm, 0x03E6, bcm43xx_read16(bcm, 0x03E6) & 0xFFDF);
 
 	if (phy->type == BCM43xx_PHYTYPE_G) {
 		if (!phy->connected)
@@ -317,6 +317,13 @@ static void bcm43xx_phy_agcsetup(struct 
 	bcm43xx_ilt_write(bcm, offset + 0x0801, 7);
 	bcm43xx_ilt_write(bcm, offset + 0x0802, 16);
 	bcm43xx_ilt_write(bcm, offset + 0x0803, 28);
+
+	if (phy->rev >= 6) {
+		bcm43xx_phy_write(bcm, 0x0426, (bcm43xx_phy_read(bcm, 0x0426)
+				  & 0xFFFC));
+		bcm43xx_phy_write(bcm, 0x0426, (bcm43xx_phy_read(bcm, 0x0426)
+				  & 0xEFFF));
+	}
 }
 
 static void bcm43xx_phy_setupg(struct bcm43xx_private *bcm)
@@ -729,19 +736,19 @@ static void bcm43xx_phy_initb5(struct bc
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
 	u16 offset;
+	u16 value;
+	u8 old_channel;
 
-	if (phy->version == 1 &&
-	    radio->version == 0x2050) {
+	if (phy->analog == 1)
 		bcm43xx_radio_write16(bcm, 0x007A,
 				      bcm43xx_radio_read16(bcm, 0x007A)
 				      | 0x0050);
-	}
 	if ((bcm->board_vendor != PCI_VENDOR_ID_BROADCOM) &&
 	    (bcm->board_type != 0x0416)) {
+		value = 0x2120;
 		for (offset = 0x00A8 ; offset < 0x00C7; offset++) {
-			bcm43xx_phy_write(bcm, offset,
-					  (bcm43xx_phy_read(bcm, offset) + 0x2020)
-					  & 0x3F3F);
+			bcm43xx_phy_write(bcm, offset, value);
+			value += 0x0202;
 		}
 	}
 	bcm43xx_phy_write(bcm, 0x0035,
@@ -750,7 +757,7 @@ static void bcm43xx_phy_initb5(struct bc
 	if (radio->version == 0x2050)
 		bcm43xx_phy_write(bcm, 0x0038, 0x0667);
 
-	if (phy->connected) {
+	if (phy->type == BCM43xx_PHYTYPE_G) {
 		if (radio->version == 0x2050) {
 			bcm43xx_radio_write16(bcm, 0x007A,
 					      bcm43xx_radio_read16(bcm, 0x007A)
@@ -776,7 +783,7 @@ static void bcm43xx_phy_initb5(struct bc
 				  bcm43xx_phy_read(bcm, BCM43xx_PHY_RADIO_BITFIELD) | (1 << 11));
 	}
 
-	if (phy->version == 1 && radio->version == 0x2050) {
+	if (phy->analog == 1) {
 		bcm43xx_phy_write(bcm, 0x0026, 0xCE00);
 		bcm43xx_phy_write(bcm, 0x0021, 0x3763);
 		bcm43xx_phy_write(bcm, 0x0022, 0x1BC3);
@@ -787,14 +794,15 @@ static void bcm43xx_phy_initb5(struct bc
 	bcm43xx_phy_write(bcm, 0x0030, 0x00C6);
 	bcm43xx_write16(bcm, 0x03EC, 0x3F22);
 
-	if (phy->version == 1 && radio->version == 0x2050)
+	if (phy->analog == 1)
 		bcm43xx_phy_write(bcm, 0x0020, 0x3E1C);
 	else
 		bcm43xx_phy_write(bcm, 0x0020, 0x301C);
 
-	if (phy->version == 0)
+	if (phy->analog == 0)
 		bcm43xx_write16(bcm, 0x03E4, 0x3000);
 
+	old_channel = radio->channel;
 	/* Force to channel 7, even if not supported. */
 	bcm43xx_radio_selectchannel(bcm, 7, 0);
 
@@ -816,11 +824,11 @@ static void bcm43xx_phy_initb5(struct bc
 
 	bcm43xx_radio_write16(bcm, 0x007A, bcm43xx_radio_read16(bcm, 0x007A) | 0x0007);
 
-	bcm43xx_radio_selectchannel(bcm, BCM43xx_RADIO_DEFAULT_CHANNEL_BG, 0);
+	bcm43xx_radio_selectchannel(bcm, old_channel, 0);
 
 	bcm43xx_phy_write(bcm, 0x0014, 0x0080);
 	bcm43xx_phy_write(bcm, 0x0032, 0x00CA);
-	bcm43xx_phy_write(bcm, 0x88A3, 0x002A);
+	bcm43xx_phy_write(bcm, 0x002A, 0x88A3);
 
 	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
 
@@ -835,61 +843,24 @@ static void bcm43xx_phy_initb6(struct bc
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
 	u16 offset, val;
+	u8 old_channel;
 
 	bcm43xx_phy_write(bcm, 0x003E, 0x817A);
 	bcm43xx_radio_write16(bcm, 0x007A,
 	                      (bcm43xx_radio_read16(bcm, 0x007A) | 0x0058));
-	if ((radio->manufact == 0x17F) &&
-	    (radio->version == 0x2050) &&
-	    (radio->revision == 3 ||
-	     radio->revision == 4 ||
-	     radio->revision == 5)) {
-		bcm43xx_radio_write16(bcm, 0x0051, 0x001F);
-		bcm43xx_radio_write16(bcm, 0x0052, 0x0040);
-		bcm43xx_radio_write16(bcm, 0x0053, 0x005B);
-		bcm43xx_radio_write16(bcm, 0x0054, 0x0098);
+	if (radio->revision == 4 ||
+	     radio->revision == 5) {
+		bcm43xx_radio_write16(bcm, 0x0051, 0x0037);
+		bcm43xx_radio_write16(bcm, 0x0052, 0x0070);
+		bcm43xx_radio_write16(bcm, 0x0053, 0x00B3);
+		bcm43xx_radio_write16(bcm, 0x0054, 0x009B);
 		bcm43xx_radio_write16(bcm, 0x005A, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x005B, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);
 	}
-	if ((radio->manufact == 0x17F) &&
-	    (radio->version == 0x2050) &&
-	    (radio->revision == 6)) {
-		bcm43xx_radio_write16(bcm, 0x0051, 0x0000);
-		bcm43xx_radio_write16(bcm, 0x0052, 0x0040);
-		bcm43xx_radio_write16(bcm, 0x0053, 0x00B7);
-		bcm43xx_radio_write16(bcm, 0x0054, 0x0098);
-		bcm43xx_radio_write16(bcm, 0x005A, 0x0088);
-		bcm43xx_radio_write16(bcm, 0x005B, 0x008B);
-		bcm43xx_radio_write16(bcm, 0x005C, 0x00B5);
-		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
-		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
-		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);
-		bcm43xx_radio_write16(bcm, 0x007C, 0x0001);
-		bcm43xx_radio_write16(bcm, 0x007E, 0x0008);
-	}
-	if ((radio->manufact == 0x17F) &&
-	    (radio->version == 0x2050) &&
-	    (radio->revision == 7)) {
-		bcm43xx_radio_write16(bcm, 0x0051, 0x0000);
-		bcm43xx_radio_write16(bcm, 0x0052, 0x0040);
-		bcm43xx_radio_write16(bcm, 0x0053, 0x00B7);
-		bcm43xx_radio_write16(bcm, 0x0054, 0x0098);
-		bcm43xx_radio_write16(bcm, 0x005A, 0x0088);
-		bcm43xx_radio_write16(bcm, 0x005B, 0x00A8);
-		bcm43xx_radio_write16(bcm, 0x005C, 0x0075);
-		bcm43xx_radio_write16(bcm, 0x005D, 0x00F5);
-		bcm43xx_radio_write16(bcm, 0x005E, 0x00B8);
-		bcm43xx_radio_write16(bcm, 0x007D, 0x00E8);
-		bcm43xx_radio_write16(bcm, 0x007C, 0x0001);
-		bcm43xx_radio_write16(bcm, 0x007E, 0x0008);
-		bcm43xx_radio_write16(bcm, 0x007B, 0x0000);
-	}
-	if ((radio->manufact == 0x17F) &&
-	    (radio->version == 0x2050) &&
-	    (radio->revision == 8)) {
+	if (radio->revision == 8) {
 		bcm43xx_radio_write16(bcm, 0x0051, 0x0000);
 		bcm43xx_radio_write16(bcm, 0x0052, 0x0040);
 		bcm43xx_radio_write16(bcm, 0x0053, 0x00B7);
@@ -933,20 +904,26 @@ static void bcm43xx_phy_initb6(struct bc
 		                  bcm43xx_phy_read(bcm, 0x0802) | 0x0100);
 		bcm43xx_phy_write(bcm, 0x042B,
 		                  bcm43xx_phy_read(bcm, 0x042B) | 0x2000);
+		bcm43xx_phy_write(bcm, 0x5B, 0x0000);
+		bcm43xx_phy_write(bcm, 0x5C, 0x0000);
 	}
 
-	/* Force to channel 7, even if not supported. */
-	bcm43xx_radio_selectchannel(bcm, 7, 0);
+	old_channel = radio->channel;
+	if (old_channel >= 8)
+		bcm43xx_radio_selectchannel(bcm, 1, 0);
+	else
+		bcm43xx_radio_selectchannel(bcm, 13, 0);
 
 	bcm43xx_radio_write16(bcm, 0x0050, 0x0020);
 	bcm43xx_radio_write16(bcm, 0x0050, 0x0023);
 	udelay(40);
-	bcm43xx_radio_write16(bcm, 0x007C, (bcm43xx_radio_read16(bcm, 0x007C) | 0x0002));
-	bcm43xx_radio_write16(bcm, 0x0050, 0x0020);
-	if (radio->manufact == 0x17F &&
-	    radio->version == 0x2050 &&
-	    radio->revision <= 2) {
+	if (radio->revision < 6 || radio-> revision == 8) {
+		bcm43xx_radio_write16(bcm, 0x007C, (bcm43xx_radio_read16(bcm, 0x007C)
+				      | 0x0002));
 		bcm43xx_radio_write16(bcm, 0x0050, 0x0020);
+	}
+	if (radio->revision <= 2) {
+		bcm43xx_radio_write16(bcm, 0x007C, 0x0020);
 		bcm43xx_radio_write16(bcm, 0x005A, 0x0070);
 		bcm43xx_radio_write16(bcm, 0x005B, 0x007B);
 		bcm43xx_radio_write16(bcm, 0x005C, 0x00B0);
@@ -954,46 +931,41 @@ static void bcm43xx_phy_initb6(struct bc
 	bcm43xx_radio_write16(bcm, 0x007A,
 	                      (bcm43xx_radio_read16(bcm, 0x007A) & 0x00F8) | 0x0007);
 
-	bcm43xx_radio_selectchannel(bcm, BCM43xx_RADIO_DEFAULT_CHANNEL_BG, 0);
+	bcm43xx_radio_selectchannel(bcm, old_channel, 0);
 
 	bcm43xx_phy_write(bcm, 0x0014, 0x0200);
-	if (radio->version == 0x2050){
-		if (radio->revision == 3 ||
-		    radio->revision == 4 ||
-		    radio->revision == 5)
-			bcm43xx_phy_write(bcm, 0x002A, 0x8AC0);
-		else
-			bcm43xx_phy_write(bcm, 0x002A, 0x88C2);
-	}
+	if (radio->revision >= 6)
+		bcm43xx_phy_write(bcm, 0x002A, 0x88C2);
+	else
+		bcm43xx_phy_write(bcm, 0x002A, 0x8AC0);
 	bcm43xx_phy_write(bcm, 0x0038, 0x0668);
 	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
-	if (radio->version == 0x2050) {
-		if (radio->revision == 3 ||
-		    radio->revision == 4 ||
-		    radio->revision == 5)
-			bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);
-		else if (radio->revision <= 2)
-			bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
-	}
+	if (radio->revision <= 5)
+		bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);
+	if (radio->revision <= 2)
+		bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
 	
-	if (phy->rev == 4)
-		bcm43xx_phy_write(bcm, 0x0002, (bcm43xx_phy_read(bcm, 0x0002) & 0xFFC0) | 0x0004);
-	else
+	if (phy->analog == 4){
 		bcm43xx_write16(bcm, 0x03E4, 0x0009);
+		bcm43xx_phy_write(bcm, 0x61, bcm43xx_phy_read(bcm, 0x61) & 0xFFF);
+	} else {
+		bcm43xx_phy_write(bcm, 0x0002, (bcm43xx_phy_read(bcm, 0x0002) & 0xFFC0) | 0x0004);
+	}
+	if (phy->type == BCM43xx_PHYTYPE_G)
+		bcm43xx_write16(bcm, 0x03E6, 0x0);
 	if (phy->type == BCM43xx_PHYTYPE_B) {
 		bcm43xx_write16(bcm, 0x03E6, 0x8140);
 		bcm43xx_phy_write(bcm, 0x0016, 0x0410);
 		bcm43xx_phy_write(bcm, 0x0017, 0x0820);
 		bcm43xx_phy_write(bcm, 0x0062, 0x0007);
 		(void) bcm43xx_radio_calibrationvalue(bcm);
-		bcm43xx_phy_lo_b_measure(bcm);
+		bcm43xx_phy_lo_g_measure(bcm);
 		if (bcm->sprom.boardflags & BCM43xx_BFL_RSSI) {
 			bcm43xx_calc_nrssi_slope(bcm);
 			bcm43xx_calc_nrssi_threshold(bcm);
 		}
 		bcm43xx_phy_init_pctl(bcm);
-	} else
-		bcm43xx_write16(bcm, 0x03E6, 0x0);
+	}
 }
 
 static void bcm43xx_calc_loopback_gain(struct bcm43xx_private *bcm)
@@ -1063,7 +1035,7 @@ static void bcm43xx_calc_loopback_gain(s
 	bcm43xx_phy_write(bcm, 0x005A, 0x0780);
 	bcm43xx_phy_write(bcm, 0x0059, 0xC810);
 	bcm43xx_phy_write(bcm, 0x0058, 0x000D);
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		bcm43xx_phy_write(bcm, 0x0003, 0x0122);
 	} else {
 		bcm43xx_phy_write(bcm, 0x000A,
@@ -1205,27 +1177,30 @@ static void bcm43xx_phy_initg(struct bcm
 	if (phy->rev >= 2) {
 		bcm43xx_phy_write(bcm, 0x0814, 0x0000);
 		bcm43xx_phy_write(bcm, 0x0815, 0x0000);
-		if (phy->rev == 2)
-			bcm43xx_phy_write(bcm, 0x0811, 0x0000);
-		else if (phy->rev >= 3)
-			bcm43xx_phy_write(bcm, 0x0811, 0x0400);
+	}
+	if (phy->rev == 2) {
+		bcm43xx_phy_write(bcm, 0x0811, 0x0000);
 		bcm43xx_phy_write(bcm, 0x0015, 0x00C0);
-		if (phy->connected) {
-			tmp = bcm43xx_phy_read(bcm, 0x0400) & 0xFF;
-			if (tmp < 6) {
-				bcm43xx_phy_write(bcm, 0x04C2, 0x1816);
-				bcm43xx_phy_write(bcm, 0x04C3, 0x8006);
-				if (tmp != 3) {
-					bcm43xx_phy_write(bcm, 0x04CC,
-							  (bcm43xx_phy_read(bcm, 0x04CC)
-							   & 0x00FF) | 0x1F00);
-				}
+	}
+	if (phy->rev >= 3) {
+		bcm43xx_phy_write(bcm, 0x0811, 0x0400);
+		bcm43xx_phy_write(bcm, 0x0015, 0x00C0);
+	}
+	if (phy->connected) {
+		tmp = bcm43xx_phy_read(bcm, 0x0400) & 0xFF;
+		if (tmp < 6) {
+			bcm43xx_phy_write(bcm, 0x04C2, 0x1816);
+			bcm43xx_phy_write(bcm, 0x04C3, 0x8006);
+			if (tmp != 3) {
+				bcm43xx_phy_write(bcm, 0x04CC,
+						  (bcm43xx_phy_read(bcm, 0x04CC)
+						   & 0x00FF) | 0x1F00);
 			}
 		}
 	}
 	if (phy->rev < 3 && phy->connected)
 		bcm43xx_phy_write(bcm, 0x047E, 0x0078);
-	if (phy->rev >= 6 && phy->rev <= 8) {
+	if (radio->revision == 8) {
 		bcm43xx_phy_write(bcm, 0x0801, bcm43xx_phy_read(bcm, 0x0801) | 0x0080);
 		bcm43xx_phy_write(bcm, 0x043E, bcm43xx_phy_read(bcm, 0x043E) | 0x0004);
 	}
@@ -1638,14 +1613,14 @@ void bcm43xx_phy_set_baseband_attenuatio
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	u16 value;
 
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		value = (bcm43xx_read16(bcm, 0x03E6) & 0xFFF0);
 		value |= (baseband_attenuation & 0x000F);
 		bcm43xx_write16(bcm, 0x03E6, value);
 		return;
 	}
 
-	if (phy->version > 1) {
+	if (phy->analog > 1) {
 		value = bcm43xx_phy_read(bcm, 0x0060) & ~0x003C;
 		value |= (baseband_attenuation << 2) & 0x003C;
 	} else {
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_radio.c
@@ -1393,11 +1393,12 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	backup[12] = bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT);
 
 	// Initialization
-	if (phy->version == 0) {
+	if (phy->analog == 0) {
 		bcm43xx_write16(bcm, 0x03E6, 0x0122);
 	} else {
-		if (phy->version >= 2)
-			bcm43xx_write16(bcm, 0x03E6, 0x0040);
+		if (phy->analog >= 2)
+			bcm43xx_phy_write(bcm, 0x0003, (bcm43xx_phy_read(bcm, 0x0003)
+					& 0xFFBF) | 0x0040);
 		bcm43xx_write16(bcm, BCM43xx_MMIO_CHANNEL_EXT,
 		                (bcm43xx_read16(bcm, BCM43xx_MMIO_CHANNEL_EXT) | 0x2000));
 	}
@@ -1405,7 +1406,7 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	ret = bcm43xx_radio_calibrationvalue(bcm);
 
 	if (phy->type == BCM43xx_PHYTYPE_B)
-		bcm43xx_radio_write16(bcm, 0x0078, 0x0003);
+		bcm43xx_radio_write16(bcm, 0x0078, 0x0026);
 
 	bcm43xx_phy_write(bcm, 0x0015, 0xBFAF);
 	bcm43xx_phy_write(bcm, 0x002B, 0x1403);
@@ -1416,7 +1417,7 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	                      (bcm43xx_radio_read16(bcm, 0x0051) | 0x0004));
 	bcm43xx_radio_write16(bcm, 0x0052, 0x0000);
 	bcm43xx_radio_write16(bcm, 0x0043,
-			      bcm43xx_radio_read16(bcm, 0x0043) | 0x0009);
+			      (bcm43xx_radio_read16(bcm, 0x0043) & 0xFFF0) | 0x0009);
 	bcm43xx_phy_write(bcm, 0x0058, 0x0000);
 
 	for (i = 0; i < 16; i++) {
@@ -1488,7 +1489,7 @@ u16 bcm43xx_radio_init2050(struct bcm43x
 	bcm43xx_phy_write(bcm, 0x0059, backup[17]);
 	bcm43xx_phy_write(bcm, 0x0058, backup[18]);
 	bcm43xx_write16(bcm, 0x03E6, backup[11]);
-	if (phy->version != 0)
+	if (phy->analog != 0)
 		bcm43xx_write16(bcm, BCM43xx_MMIO_CHANNEL_EXT, backup[12]);
 	bcm43xx_phy_write(bcm, 0x0035, backup[10]);
 	bcm43xx_radio_selectchannel(bcm, radio->channel, 1);
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -3692,7 +3692,7 @@ static int bcm43xx_read_phyinfo(struct b
 {
 	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
 	u16 value;
-	u8 phy_version;
+	u8 phy_analog;
 	u8 phy_type;
 	u8 phy_rev;
 	int phy_rev_ok = 1;
@@ -3700,12 +3700,12 @@ static int bcm43xx_read_phyinfo(struct b
 
 	value = bcm43xx_read16(bcm, BCM43xx_MMIO_PHY_VER);
 
-	phy_version = (value & 0xF000) >> 12;
+	phy_analog = (value & 0xF000) >> 12;
 	phy_type = (value & 0x0F00) >> 8;
 	phy_rev = (value & 0x000F);
 
-	dprintk(KERN_INFO PFX "Detected PHY: Version: %x, Type %x, Revision %x\n",
-		phy_version, phy_type, phy_rev);
+	dprintk(KERN_INFO PFX "Detected PHY: Analog: %x, Type %x, Revision %x\n",
+		phy_analog, phy_type, phy_rev);
 
 	switch (phy_type) {
 	case BCM43xx_PHYTYPE_A:
@@ -3748,7 +3748,7 @@ static int bcm43xx_read_phyinfo(struct b
 		       phy_rev);
 	}
 
-	phy->version = phy_version;
+	phy->analog = phy_analog;
 	phy->type = phy_type;
 	phy->rev = phy_rev;
 	if ((phy_type == BCM43xx_PHYTYPE_B) || (phy_type == BCM43xx_PHYTYPE_G)) {


From Larry.Finger at lwfinger.net  Tue Feb 13 23:56:21 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 16:56:21 -0600
Subject: [PATCH] bcm43xx: OFDM fix for rev 1 cards
Message-ID: <45d24215.ArbNyvChpk0vYXTg%Larry.Finger@lwfinger.net>

Nearly all of the writes to the bcm43xx internal lookup tables (ilt)
involve 16-bit quantities. Accordingly, the ilt_write routine was coded to
pass a u16 value. For one early GPHY chip, 32-bit quantities are needed. For
those writes, the value was clipped to 16 bits. This patch adds an ilt_write32
routine that receives a 32-bit quantity and writes it to the appropriate
locations.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---


Nearly all of the writes to the bcm43xx internal lookup tables (ilt)
involve 16-bit quantities. Accordingly, the ilt_write routine was coded to
pass a u16 value. For one early GPHY chip, 32-bit quantities are needed. For
those writes, the value was clipped to 16 bits. This patch adds an ilt_write32
routine that receives a 32-bit quantity and writes it to the appropriate
locations.

Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
---


Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_ilt.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_ilt.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_ilt.c
@@ -325,6 +325,21 @@ void bcm43xx_ilt_write(struct bcm43xx_pr
 	}
 }
 
+void bcm43xx_ilt_write32(struct bcm43xx_private *bcm, u16 offset, u32 val)
+{
+	if (bcm43xx_current_phy(bcm)->type == BCM43xx_PHYTYPE_A) {
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_A_CTRL, offset);
+		mmiowb();
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_A_DATA2, (val & 0xFFFF0000) >> 16);
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_A_DATA1, val & 0x0000FFFF);
+	} else {
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_G_CTRL, offset);
+		mmiowb();
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_G_DATA2, (val & 0xFFFF0000) >> 16);
+		bcm43xx_phy_write(bcm, BCM43xx_PHY_ILT_G_DATA1, val & 0x0000FFFF);
+	}
+}
+
 u16 bcm43xx_ilt_read(struct bcm43xx_private *bcm, u16 offset)
 {
 	if (bcm43xx_current_phy(bcm)->type == BCM43xx_PHYTYPE_A) {
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -344,7 +344,7 @@ static void bcm43xx_phy_setupg(struct bc
 		for (i = 0; i < BCM43xx_ILT_NOISEG1_SIZE; i++)
 			bcm43xx_ilt_write(bcm, 0x1800 + i, bcm43xx_ilt_noiseg1[i]);
 		for (i = 0; i < BCM43xx_ILT_ROTOR_SIZE; i++)
-			bcm43xx_ilt_write(bcm, 0x2000 + i, bcm43xx_ilt_rotor[i]);
+			bcm43xx_ilt_write32(bcm, 0x2000 + i, bcm43xx_ilt_rotor[i]);
 	} else {
 		/* nrssi values are signed 6-bit values. Not sure why we write 0x7654 here... */
 		bcm43xx_nrssi_hw_write(bcm, 0xBA98, (s16)0x7654);
@@ -384,7 +384,7 @@ static void bcm43xx_phy_setupg(struct bc
 	
 	if (phy->rev == 1) {
 		for (i = 0; i < BCM43xx_ILT_RETARD_SIZE; i++)
-			bcm43xx_ilt_write(bcm, 0x2400 + i, bcm43xx_ilt_retard[i]);
+			bcm43xx_ilt_write32(bcm, 0x2400 + i, bcm43xx_ilt_retard[i]);
 		for (i = 0; i < 4; i++) {
 			bcm43xx_ilt_write(bcm, 0x5404 + i, 0x0020);
 			bcm43xx_ilt_write(bcm, 0x5408 + i, 0x0020);
@@ -507,10 +507,10 @@ static void bcm43xx_phy_setupa(struct bc
 		for (i = 0; i < BCM43xx_ILT_NOISEA2_SIZE; i++)
 			bcm43xx_ilt_write(bcm, 0x1800 + i, bcm43xx_ilt_noisea2[i]);
 		for (i = 0; i < BCM43xx_ILT_ROTOR_SIZE; i++)
-			bcm43xx_ilt_write(bcm, 0x2000 + i, bcm43xx_ilt_rotor[i]);
+			bcm43xx_ilt_write32(bcm, 0x2000 + i, bcm43xx_ilt_rotor[i]);
 		bcm43xx_phy_init_noisescaletbl(bcm);
 		for (i = 0; i < BCM43xx_ILT_RETARD_SIZE; i++)
-			bcm43xx_ilt_write(bcm, 0x2400 + i, bcm43xx_ilt_retard[i]);
+			bcm43xx_ilt_write32(bcm, 0x2400 + i, bcm43xx_ilt_retard[i]);
 		break;
 	case 3:
 		for (i = 0; i < 64; i++)
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_ilt.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_ilt.h
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_ilt.h
@@ -27,6 +27,7 @@ extern const u16 bcm43xx_ilt_sigmasqr2[B
 
 
 void bcm43xx_ilt_write(struct bcm43xx_private *bcm, u16 offset, u16 val);
+void bcm43xx_ilt_write32(struct bcm43xx_private *bcm, u16 offset, u32 val);
 u16 bcm43xx_ilt_read(struct bcm43xx_private *bcm, u16 offset);
 
 #endif /* BCM43xx_ILT_H_ */


From mb at bu3sch.de  Tue Feb 13 23:57:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 13 Feb 2007 23:57:20 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702132347.20956.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702132254.12126.mb@bu3sch.de> <200702132347.20956.rjw@sisk.pl>
Message-ID: <200702132357.20280.mb@bu3sch.de>

On Tuesday 13 February 2007 23:47, Rafael J. Wysocki wrote:
> On Tuesday, 13 February 2007 22:54, Michael Buesch wrote:
> > Did you already try my tree? I fixed resume there by completely
> > reinitializing the device on resume.
> 
> No, I didn't.  So far I've had no time to set up a git tree on my box.
> I'll try when I finally do it (but probably not any time soon ;-)).

Well, "setting up a git tree" is about issueing one command.
I even wrote the exact command in the previous mail.
So it's not really that amount of work.

If you don't have git installed, it's two commands. :)
apt-get install git-core
git clone ...

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Feb 14 00:02:05 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 00:02:05 +0100
Subject: [PATCH] bcm43xx: Fix for 4311 and 02/07/07 specification changes
In-Reply-To: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
References: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
Message-ID: <200702140002.05727.mb@bu3sch.de>

On Tuesday 13 February 2007 23:54, Larry Finger wrote:
> The specifications for the bcm43xx driver have been modified. This patch
> incorporates these changes in the code, which results in the BCM4311 and
> BCM4312 working. The name of one of the PHY parameters, previously known
> as "version", has been changed to "analog", short for  "analog core version" .
> 
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>

> @@ -750,7 +757,7 @@ static void bcm43xx_phy_initb5(struct bc
>  	if (radio->version == 0x2050)
>  		bcm43xx_phy_write(bcm, 0x0038, 0x0667);
>  
> -	if (phy->connected) {
> +	if (phy->type == BCM43xx_PHYTYPE_G) {

I don't think this is correct.
I think (didn't verify) the specs talk about the "gmode" here.
I think you have been misleaded by that. The "gmode" bit is
the "connected" bit in the old softmac driver.

-- 
Greetings Michael.


From radarsat1 at gmail.com  Wed Feb 14 00:36:54 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Tue, 13 Feb 2007 18:36:54 -0500
Subject: RFT: The real fix for BCM4311 and BCM4312
In-Reply-To: <45D2398D.7050104@lwfinger.net>
References: <45C96B8A.8010000@lwfinger.net> <1170830071.11150.62.camel@dv>
	<200702071443.19676.rjw@sisk.pl> <45C9D9D6.2070700@lwfinger.net>
	<a44ae5cd0702101530j38c983bfy9c1496fd50ca8b1c@mail.gmail.com>
	<45CE5812.3000306@lwfinger.net> <20070213211340.GG3572@tuxdriver.com>
	<45D2398D.7050104@lwfinger.net>
Message-ID: <9b3e2dc20702131536q2f2a89aev8076bbd6e1ccdee9@mail.gmail.com>

> I think most, if not all, the 4311 and 4312's are helped. I will be submitting a set of
> patches this afternoon that help most cards.

I just wanted to express my thanks for all your work on this driver,
and everyone else who's contributed to it.  Since this patch has fixed
the speed issues, I haven't had to boot to Windows on my laptop in
like a week.  I wonder if I ever will again.  It's the way it should
be, and it's just fantastic.  Thank you!  If I could, I'd definitely
buy you a beer.  ;-)


Steve


From larry.finger at lwfinger.net  Wed Feb 14 01:42:36 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 18:42:36 -0600
Subject: [PATCH] bcm43xx: Fix for 4311 and 02/07/07 specification changes
In-Reply-To: <200702140002.05727.mb@bu3sch.de>
References: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
	<200702140002.05727.mb@bu3sch.de>
Message-ID: <45D25AFC.2060508@lwfinger.net>

Michael Buesch wrote:
> On Tuesday 13 February 2007 23:54, Larry Finger wrote:
>> The specifications for the bcm43xx driver have been modified. This patch
>> incorporates these changes in the code, which results in the BCM4311 and
>> BCM4312 working. The name of one of the PHY parameters, previously known
>> as "version", has been changed to "analog", short for  "analog core version" .
>>
>> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
> 
>> @@ -750,7 +757,7 @@ static void bcm43xx_phy_initb5(struct bc
>>  	if (radio->version == 0x2050)
>>  		bcm43xx_phy_write(bcm, 0x0038, 0x0667);
>>  
>> -	if (phy->connected) {
>> +	if (phy->type == BCM43xx_PHYTYPE_G) {
> 
> I don't think this is correct.
> I think (didn't verify) the specs talk about the "gmode" here.
> I think you have been misleaded by that. The "gmode" bit is
> the "connected" bit in the old softmac driver.
> 

The specs definitely say "If this is a GPHY" is step 5 of http://bcm-specs.sipsolutions.net/B5PHY.

Larry



From Larry.Finger at lwfinger.net  Wed Feb 14 01:58:03 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 13 Feb 2007 18:58:03 -0600
Subject: [PATCH] ieee80211softmac: Fix setting of initial transmit rates
Message-ID: <45d25e9b.otGTejHOp8dOGSbd%Larry.Finger@lwfinger.net>

There is a bug in ieee80211softmac that always sets the user rate to 11Mbs,
no matter the capabilities of the device. This bug was probably beneficial
as long as the bcm43xx cards were rate limited; however, most are now capable
of relatively high speeds. This patch fixes that bug and eliminates an assert
that is no longer needed. 

Once the cards are capable of full OFDM speeds, the 24 Mbs rate will be changed
to 54 Mbs.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
===================================================================
--- wireless-2.6.orig/net/ieee80211/softmac/ieee80211softmac_module.c
+++ wireless-2.6/net/ieee80211/softmac/ieee80211softmac_module.c
@@ -265,17 +265,10 @@ void ieee80211softmac_init_bss(struct ie
 	/* Change the default txrate to the highest possible value.
 	 * The txrate machine will lower it, if it is too high.
 	 */
-	/* FIXME: We don't correctly handle backing down to lower
-	   rates, so 801.11g devices start off at 11M for now. People
-	   can manually change it if they really need to, but 11M is
-	   more reliable. Note similar logic in
-	   ieee80211softmac_wx_set_rate() */	 
-	if (ieee->modulation & IEEE80211_CCK_MODULATION) {
+	if (ieee->modulation & IEEE80211_OFDM_MODULATION)
+		txrates->user_rate = IEEE80211_OFDM_RATE_24MB;
+	else
 		txrates->user_rate = IEEE80211_CCK_RATE_11MB;
-	} else if (ieee->modulation & IEEE80211_OFDM_MODULATION) {
-		txrates->user_rate = IEEE80211_OFDM_RATE_54MB;
-	} else
-		assert(0);
 
 	txrates->default_rate = IEEE80211_CCK_RATE_1MB;
 	change |= IEEE80211SOFTMAC_TXRATECHG_DEFAULT;
Index: wireless-2.6/net/ieee80211/softmac/ieee80211softmac_wx.c
===================================================================
--- wireless-2.6.orig/net/ieee80211/softmac/ieee80211softmac_wx.c
+++ wireless-2.6/net/ieee80211/softmac/ieee80211softmac_wx.c
@@ -177,15 +177,10 @@ ieee80211softmac_wx_set_rate(struct net_
 	int err = -EINVAL;
 
 	if (in_rate == -1) {
-		/* FIXME: We don't correctly handle backing down to lower
-		   rates, so 801.11g devices start off at 11M for now. People
-		   can manually change it if they really need to, but 11M is
-		   more reliable. Note similar logic in
-		   ieee80211softmac_wx_set_rate() */	 
-		if (ieee->modulation & IEEE80211_CCK_MODULATION)
-			in_rate = 11000000;
+		if (ieee->modulation & IEEE80211_OFDM_MODULATION)
+			in_rate = 24000000;
 		else
-			in_rate = 54000000;
+			in_rate = 11000000;
 	}
 
 	switch (in_rate) {


From evanfoss at gmail.com  Wed Feb 14 06:23:02 2007
From: evanfoss at gmail.com (evan foss)
Date: Wed, 14 Feb 2007 00:23:02 -0500
Subject: A problem with the sprom utility
In-Reply-To: <1171394978.2414.25.camel@dv>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<45D1D85F.60803@lwfinger.net>
	<1171384115.10344.41.camel@johannes.berg>
	<45D1FD90.2050207@lwfinger.net> <1171394978.2414.25.camel@dv>
Message-ID: <4a55afb80702132123u67728d8bv78b219b6455cb349@mail.gmail.com>

> To be fair to Big Brothers, it's the one in Washington, DC.  Laptops are
> FCC-certified with certain wireless cards, and the laptop manufacturers
> think it's their duty to prevent end users from sticking unapproved
> cards into their laptops.

The FCC allowed people to change antennas. The manufacturers just
don't like you changing the hardware. It leads to more tech support
calls. At least this is my thinking. They limit the BIOS in terms of
all kinds of other things just to prevent users from tinkering. The
wireless cards are easy in some cases to modify. Even scanners which
legally shouldn't be alterable to get 900MHz can be altered (usually
easily). The wireless card typically goes though it's own FCC
compliance testing. They don't want to have to re-do it for every new
machine they stick them in.

>Atheros cards should also be patched so that they don't appear as
>Ethernet controllers (PCI_CLASS_NETWORK_ETHERNET = 0x200), but as "other
>network devices (PCI_CLASS_NETWORK_OTHER = 0x280).  Broadcom got it right, I
>believe.

The 802.11 spec should have defined this. I blame IEEE for not pinning
this down if they really did miss it.

-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From gaedol at gmail.com  Wed Feb 14 10:10:55 2007
From: gaedol at gmail.com (marco)
Date: Wed, 14 Feb 2007 10:10:55 +0100
Subject: Problem with firmware on ibook G4
Message-ID: <1171444256.12506.9.camel@pisolo>

	Hi all, 
i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
While on edgy bcm43xx was running fine, on feisty i am not able to have
it anymore. 
When i try to load the module bcm43xx i get, in messages:

[ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
[ 5038.591167] ssb: Core 1 found: cc 0812, rev 05, vendor 4243
[ 5038.591180] ssb: Core 2 found: cc 080D, rev 02, vendor 4243
[ 5038.591192] ssb: Core 3 found: cc 0807, rev 02, vendor 4243
[ 5038.591204] ssb: Core 4 found: cc 0804, rev 09, vendor 4243
[ 5038.591212] bcm43xx: Broadcom 4306 WLAN found
[ 5038.591224] ssb: Switching to core 4
[ 5038.594524] ssb: Switching to core 1
[ 5038.597604] wmaster0: Selected rate control algorithm 'simple'
[ 5039.540531] ssb: Switching to core 0
[ 5039.540566] ssb: Switching to core 1
[ 5039.652777] bcm43xx: YOUR FIRMWARE IS TOO OLD. Firmware from binary
drivers older than version 4.x is unsupported. You must upgrade your
firmware files.

Now, i have tried to upgrade the firmware
with /usr/share/bcm43xx-fwcutter/install_bcm43xx_firmware.sh that
basically downloads wl_apsta.o and runs fwcutter on it, and then
installs it on /lib/firmware/, but got no results.

Which firmware should i use then, to avoid the "your firmware is too
old" message?

TIA, 

marco
 



From benoit.knecht at citycable.ch  Wed Feb 14 11:03:00 2007
From: benoit.knecht at citycable.ch (=?ISO-8859-1?Q?Beno=EEt_Knecht?=)
Date: Wed, 14 Feb 2007 11:03:00 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171444256.12506.9.camel@pisolo>
References: <1171444256.12506.9.camel@pisolo>
Message-ID: <45D2DE54.5070806@citycable.ch>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi,

marco wrote:
> Which firmware should i use then, to avoid the "your firmware is too
> old" message?

According to another post on this list, you can get the latest v4
firmware from:

wget
http://www.station-drivers.com/telechargement/broadcom/broadcom%20bcm-43x-4.102.15.61-vista.exe
7za x "broadcom bcm-43x-4.102.15.61-vista.exe"
bcm43xx-fwcutter bcmwl6.sys

Beno?t
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFF0t5Ty0EwBJvkHIMRArUqAKCbvvt4RpMzGhl/tWhiLwuOYAtFnACfY4Yu
Ts4UpDZyHaFP72dboc/wC+8=
=XZZS
-----END PGP SIGNATURE-----


From mb at bu3sch.de  Wed Feb 14 12:05:32 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 12:05:32 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171444256.12506.9.camel@pisolo>
References: <1171444256.12506.9.camel@pisolo>
Message-ID: <200702141205.32914.mb@bu3sch.de>

On Wednesday 14 February 2007 10:10, marco wrote:
> 	Hi all, 
> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> While on edgy bcm43xx was running fine, on feisty i am not able to have
> it anymore. 
> When i try to load the module bcm43xx i get, in messages:
> 
> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> [ 5038.591167] ssb: Core 1 found: cc 0812, rev 05, vendor 4243
> [ 5038.591180] ssb: Core 2 found: cc 080D, rev 02, vendor 4243
> [ 5038.591192] ssb: Core 3 found: cc 0807, rev 02, vendor 4243
> [ 5038.591204] ssb: Core 4 found: cc 0804, rev 09, vendor 4243
> [ 5038.591212] bcm43xx: Broadcom 4306 WLAN found
> [ 5038.591224] ssb: Switching to core 4
> [ 5038.594524] ssb: Switching to core 1
> [ 5038.597604] wmaster0: Selected rate control algorithm 'simple'
> [ 5039.540531] ssb: Switching to core 0
> [ 5039.540566] ssb: Switching to core 1
> [ 5039.652777] bcm43xx: YOUR FIRMWARE IS TOO OLD. Firmware from binary
> drivers older than version 4.x is unsupported. You must upgrade your
> firmware files.
> 
> Now, i have tried to upgrade the firmware
> with /usr/share/bcm43xx-fwcutter/install_bcm43xx_firmware.sh that
> basically downloads wl_apsta.o and runs fwcutter on it, and then
> installs it on /lib/firmware/, but got no results.
> 
> Which firmware should i use then, to avoid the "your firmware is too
> old" message?

http://linuxwireless.org/en/users/Drivers/bcm43xx

-- 
Greetings Michael.


From hs4233 at mail.mn-solutions.de  Wed Feb 14 12:30:43 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Wed, 14 Feb 2007 12:30:43 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <45CB6525.3070406@lwfinger.net>
References: <45CB6525.3070406@lwfinger.net>
Message-ID: <200702141230.43855.hs4233@mail.mn-solutions.de>

I have three PCCards from Buffalo with the BCM43xx chipset,
which I all added to into the registration site. One thing
to note it that the debug output of bcm43xx.o puts out
exactly the same info between for the "normal" card (the
first below) and the high speed version (the second below).

I'm also posting the data for the high power card, in case
anyone want me to test some patches against this card.


BTW: all of those cards have an external antenna socket. I
don't have any info right now on how to select this antenna.
But I haven't even tried to find this out :-)


Buffalo AirStation 54 Mbps CardBus
WLI-CB-G54A

bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
03:00.0 0280: 14e4:4320 (rev 03)



Buffalo AirStation 125 High Speed Mode
WLI-CB-G54S

bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)



Buffalo AirStation
High Power
WLI-CB-G54HP

bcm43xx: Chip ID 0x4318, rev 0x2
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
03:00.0 0280: 14e4:4318 (rev 02)
        Subsystem: 1154:033a


From hs4233 at mail.mn-solutions.de  Wed Feb 14 12:43:06 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Wed, 14 Feb 2007 12:43:06 +0100
Subject: No subject
Message-ID: <200702141243.06478.hs4233@mail.mn-solutions.de>

Buffalo AirStation 54 Mbps CardBus
WLI-CB-G54A

bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
03:00.0 0280: 14e4:4320 (rev 03)



Buffalo AirStation 125 High Speed Mode
WLI-CB-G54S

bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)



Buffalo AirStation
High Power
WLI-CB-G54HP

bcm43xx: Chip ID 0x4318, rev 0x2
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
03:00.0 0280: 14e4:4318 (rev 02)
        Subsystem: 1154:033a


From mb at bu3sch.de  Wed Feb 14 12:50:24 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 12:50:24 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702132347.20956.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702132254.12126.mb@bu3sch.de> <200702132347.20956.rjw@sisk.pl>
Message-ID: <200702141250.24532.mb@bu3sch.de>

To summerize it.

We have different kinds of initialization problems in the
bcm43xx-softmac tree on resuming.
These usually don't show up if you suspend to ram.
But if you suspend to disk, you end up completely reloading
the driver through the resume routine. You completely miss
to redo the HW initializations in the attach step, then.
I think you must also redo the coreswitch procedure
to make really sure you start with the correct core.

And no, it is not correct to just call attach_board from resume. ;)
Instead you must copy (or probably move) the HW init stuff that
is in the attach step to the init step.

I have done that in my tree in bcm43xx-d80211.

Not easy to refactor without introducing bugs. Definately _not_
a patch for next -stable kernel. ;)

-- 
Greetings Michael.


From gaedol at gmail.com  Wed Feb 14 13:50:58 2007
From: gaedol at gmail.com (marco)
Date: Wed, 14 Feb 2007 13:50:58 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <45D2DE54.5070806@citycable.ch>
References: <1171444256.12506.9.camel@pisolo> <45D2DE54.5070806@citycable.ch>
Message-ID: <1171457458.8176.6.camel@pisolo>

On mer, 2007-02-14 at 11:03 +0100, Beno?t Knecht wrote:
> According to another post on this list, you can get the latest v4
> firmware from:

Hi,

I didn't notice, sorry.

> wget
> http://www.station-drivers.com/telechargement/broadcom/broadcom%20bcm-43x-4.102.15.61-vista.exe
> 7za x "broadcom bcm-43x-4.102.15.61-vista.exe"
> bcm43xx-fwcutter bcmwl6.sys

Would be great. But both with fwcutter version 005 and 006 doing 

$ bcm43xx-fwcutter bcmwl6.sys 

returns:

Sorry, the input file is either wrong or not supported by
bcm43xx-fwcutter.
This file has an unknown MD5sum 97f98e5e6a83585e42b1e1e15716aae8.


My guess is that bcmwl6.sys is not the right file to extract the
firmware from, but i could be wrong...


TIA, 

marco






From larry.finger at lwfinger.net  Wed Feb 14 16:42:13 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 09:42:13 -0600
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <1171444256.12506.9.camel@pisolo>
References: <1171444256.12506.9.camel@pisolo>
Message-ID: <45D32DD5.8050204@lwfinger.net>

marco wrote:
> 	Hi all, 
> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> While on edgy bcm43xx was running fine, on feisty i am not able to have
> it anymore. 
> When i try to load the module bcm43xx i get, in messages:
> 
> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243

Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
needed when they make the change to "feisty".

Larry



From larry.finger at lwfinger.net  Wed Feb 14 17:29:29 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 10:29:29 -0600
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702141250.24532.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702132254.12126.mb@bu3sch.de> <200702132347.20956.rjw@sisk.pl>
	<200702141250.24532.mb@bu3sch.de>
Message-ID: <45D338E9.2030605@lwfinger.net>

Michael Buesch wrote:
> To summerize it.
> 
> We have different kinds of initialization problems in the
> bcm43xx-softmac tree on resuming.
> These usually don't show up if you suspend to ram.
> But if you suspend to disk, you end up completely reloading
> the driver through the resume routine. You completely miss
> to redo the HW initializations in the attach step, then.
> I think you must also redo the coreswitch procedure
> to make really sure you start with the correct core.
> 
> And no, it is not correct to just call attach_board from resume. ;)
> Instead you must copy (or probably move) the HW init stuff that
> is in the attach step to the init step.
> 
> I have done that in my tree in bcm43xx-d80211.
> 
> Not easy to refactor without introducing bugs. Definately _not_
> a patch for next -stable kernel. ;)

After looking through your code, I agree that it is not -stable material.

It would be drastic, but we could call remove_one on suspend and init_one on resume. Userland might
get excited about the interface disappearing and reappearing, but it should work. Any thoughts?

Larry





From proski at gnu.org  Wed Feb 14 17:45:46 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 14 Feb 2007 11:45:46 -0500
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171457458.8176.6.camel@pisolo>
References: <1171444256.12506.9.camel@pisolo>
	<45D2DE54.5070806@citycable.ch>  <1171457458.8176.6.camel@pisolo>
Message-ID: <1171471546.2240.4.camel@dv>

On Wed, 2007-02-14 at 13:50 +0100, marco wrote:

> Sorry, the input file is either wrong or not supported by
> bcm43xx-fwcutter.
> This file has an unknown MD5sum 97f98e5e6a83585e42b1e1e15716aae8.
> 
> 
> My guess is that bcmwl6.sys is not the right file to extract the
> firmware from, but i could be wrong...

Sorry, support for Vista drivers was added immediately after 006
release.  Please try the svn version:

svn co svn://svn.berlios.de/bcm43xx/trunk/fwcutter

Please report the result.  If everything is fine on PowerPC, I think
it's time for version 007.

-- 
Regards,
Pavel Roskin



From benoit.knecht at citycable.ch  Wed Feb 14 18:12:26 2007
From: benoit.knecht at citycable.ch (=?ISO-8859-1?Q?Beno=EEt_Knecht?=)
Date: Wed, 14 Feb 2007 18:12:26 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171471546.2240.4.camel@dv>
References: <1171444256.12506.9.camel@pisolo>	<45D2DE54.5070806@citycable.ch>
	<1171457458.8176.6.camel@pisolo> <1171471546.2240.4.camel@dv>
Message-ID: <45D342FA.9020903@citycable.ch>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Pavel Roskin wrote:
> Sorry, support for Vista drivers was added immediately after 006
> release.  Please try the svn version:
> 
> svn co svn://svn.berlios.de/bcm43xx/trunk/fwcutter
> 
> Please report the result.  If everything is fine on PowerPC, I think
> it's time for version 007.

I just tried the svn version on my iBook, an the firmware was extracted
correctly. If it works for marco too, then I guess it's good for version
007.

Beno?t
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFF00L6y0EwBJvkHIMRAnszAJ9+aF8emTRzakF+3k2jSPvXR/xRDACfVwWm
5YjBULWe5QFEwNLP/xL5Jm4=
=yEUN
-----END PGP SIGNATURE-----


From johannes at sipsolutions.net  Wed Feb 14 13:52:05 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 13:52:05 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45CCD1B1.80709@gentoo.org>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
	<200702092017.36950.mb@bu3sch.de>  <45CCD1B1.80709@gentoo.org>
Message-ID: <1171457525.11116.19.camel@johannes.berg>

On Fri, 2007-02-09 at 14:55 -0500, Joseph Jezak wrote:

> Well, here's the problem.  There are a few places where a value is 
> changed (different value written to a register).  Does this mean 
> that the value is different due to the uCode changes (can't tell, no 
> documentation)? 

From what I've seen in the ucode that question isn't really too hard to
answer: as long as it's not in the shared memory or ucode register space
the ucode can't really have an influence.

>  Is it applicable to all revisions (can't tell, some 
> revisions are not supported in this version)?  

Best bet would be to make it conditional right now and have someone test
for these cases with older hw.

> If the revision 
> number range in a check changes is that because of a difference in 
> supported cards or a bug fix?

Hmm. Same I guess, use the new check for new hw and the old check for
old hw, i.e. assume it's the former and not a bug fix (until tested
otherwise.)

I think our best bet is to treat the older hw the same as the older
driver does.

A bigger problem, IMO, is that we'd have to support all the older
microcode things which is a bit tricky since things in shm have moved a
lot... Maybe we should find a third maintainer who has access to a
couple of old cards :)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/db82f784/attachment.pgp>

From johannes at sipsolutions.net  Wed Feb 14 14:18:10 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 14:18:10 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702100655.51495.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCCAE1.9080901@lwfinger.net> <20070209213239.GA11650@srcf.ucam.org>
	<200702100655.51495.mb@bu3sch.de>
Message-ID: <1171459090.11116.22.camel@johannes.berg>

On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:

> It's likely that old cards still work with v4 firmware,

No, it's absolutely impossible. Rev 2/4 cores have a totally different
instruction set in the microcode.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/4457f792/attachment.pgp>

From larry.finger at lwfinger.net  Wed Feb 14 20:13:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 13:13:41 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171457525.11116.19.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>	
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>	
	<200702092017.36950.mb@bu3sch.de> <45CCD1B1.80709@gentoo.org>
	<1171457525.11116.19.camel@johannes.berg>
Message-ID: <45D35F65.7060001@lwfinger.net>

Johannes Berg wrote:
>> supported cards or a bug fix?
> 
> Hmm. Same I guess, use the new check for new hw and the old check for
> old hw, i.e. assume it's the former and not a bug fix (until tested
> otherwise.)
> 
> I think our best bet is to treat the older hw the same as the older
> driver does.
> 
> A bigger problem, IMO, is that we'd have to support all the older
> microcode things which is a bit tricky since things in shm have moved a
> lot... Maybe we should find a third maintainer who has access to a
> couple of old cards :)

I've got a pair of BCM4306 rev 2 cards. One of them is certainly available. Its LEDS don't work
anymore, but the rest is functional.

Larry


From johannes at sipsolutions.net  Wed Feb 14 20:16:18 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 20:16:18 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <200702141230.43855.hs4233@mail.mn-solutions.de>
References: <45CB6525.3070406@lwfinger.net>
	<200702141230.43855.hs4233@mail.mn-solutions.de>
Message-ID: <1171480578.6093.4.camel@johannes.berg>

On Wed, 2007-02-14 at 12:30 +0100, Holger Schurig wrote:
> I have three PCCards from Buffalo with the BCM43xx chipset,
> which I all added to into the registration site. One thing
> to note it that the debug output of bcm43xx.o puts out
> exactly the same info between for the "normal" card (the
> first below) and the high speed version (the second below).
> 
> I'm also posting the data for the high power card, in case
> anyone want me to test some patches against this card.

That "high speed" and "high power" is just a matter of programming the
eeprom differently, only in the case of "high sensitivity" *may*
actually a slightly different chip be present on the card.

"high speed" is mostly Broadcom's proprietary version of 802.11e frame
aggregation (modified, WWISE I think might be very close).

"high power" I'm not sure about.

"high sensitivity" (or "max range") is some extra chip that may be
present to allow better OFDM frame recognition.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/946a2d33/attachment.pgp>

From johannes at sipsolutions.net  Wed Feb 14 20:23:06 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 20:23:06 +0100
Subject: A problem with the sprom utility
In-Reply-To: <4a55afb80702132123u67728d8bv78b219b6455cb349@mail.gmail.com>
References: <21f66e860702130200w26da9c44ndfab011e9c066ea@mail.gmail.com>
	<45D1D85F.60803@lwfinger.net> <1171384115.10344.41.camel@johannes.berg>
	<45D1FD90.2050207@lwfinger.net> <1171394978.2414.25.camel@dv>
	<4a55afb80702132123u67728d8bv78b219b6455cb349@mail.gmail.com>
Message-ID: <1171480986.6093.6.camel@johannes.berg>

On Wed, 2007-02-14 at 00:23 -0500, evan foss wrote:

> The 802.11 spec should have defined this. I blame IEEE for not pinning
> this down if they really did miss it.

Umm, no. The PCI spec might have missed this (I don't have it), but the
IEEE 802.11 spec has nothing to do with that *at all*.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/513154b5/attachment.pgp>

From johannes at sipsolutions.net  Wed Feb 14 20:26:20 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 20:26:20 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <45D35F65.7060001@lwfinger.net>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
	<200702092017.36950.mb@bu3sch.de>  <45CCD1B1.80709@gentoo.org>
	<1171457525.11116.19.camel@johannes.berg>
	<45D35F65.7060001@lwfinger.net>
Message-ID: <1171481180.6093.11.camel@johannes.berg>

On Wed, 2007-02-14 at 13:13 -0600, Larry Finger wrote:

> I've got a pair of BCM4306 rev 2 cards. One of them is certainly available. Its LEDS don't work
> anymore, but the rest is functional.

Oh good. Do they actually work right now?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/f196af6a/attachment.pgp>

From johannes at sipsolutions.net  Wed Feb 14 20:27:55 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 14 Feb 2007 20:27:55 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171481180.6093.11.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>
	<200702092017.36950.mb@bu3sch.de>  <45CCD1B1.80709@gentoo.org>
	<1171457525.11116.19.camel@johannes.berg>
	<45D35F65.7060001@lwfinger.net>
	<1171481180.6093.11.camel@johannes.berg>
Message-ID: <1171481275.6093.14.camel@johannes.berg>

On Wed, 2007-02-14 at 20:26 +0100, Johannes Berg wrote:
> On Wed, 2007-02-14 at 13:13 -0600, Larry Finger wrote:
> 
> > I've got a pair of BCM4306 rev 2 cards. One of them is certainly available. Its LEDS don't work
> > anymore, but the rest is functional.
> 
> Oh good. Do they actually work right now?

Heh, stupid question if you say they're functional :)

Anyway, I'm not quite sure how we should keep those old code paths in
there. Maybe having a different wireless driver for the older cores
would be good, maybe split bcm43xx into three drivers, one for the
PCI/SSB stuff and then two SSB drivers for old and new cores?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070214/5ac25e0f/attachment.pgp>

From mb at bu3sch.de  Wed Feb 14 22:40:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 22:40:01 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171459090.11116.22.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702100655.51495.mb@bu3sch.de>
	<1171459090.11116.22.camel@johannes.berg>
Message-ID: <200702142240.01494.mb@bu3sch.de>

On Wednesday 14 February 2007 14:18, Johannes Berg wrote:
> On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:
> 
> > It's likely that old cards still work with v4 firmware,
> 
> No, it's absolutely impossible. Rev 2/4 cores have a totally different
> instruction set in the microcode.

Ok, I was not talking about _that_ old cards. ;)

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Feb 14 22:43:29 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 22:43:29 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <45D338E9.2030605@lwfinger.net>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702141250.24532.mb@bu3sch.de> <45D338E9.2030605@lwfinger.net>
Message-ID: <200702142243.29837.mb@bu3sch.de>

On Wednesday 14 February 2007 17:29, Larry Finger wrote:
> > And no, it is not correct to just call attach_board from resume. ;)
> > Instead you must copy (or probably move) the HW init stuff that
> > is in the attach step to the init step.
> > 
> > I have done that in my tree in bcm43xx-d80211.
> > 
> > Not easy to refactor without introducing bugs. Definately _not_
> > a patch for next -stable kernel. ;)
> 
> After looking through your code, I agree that it is not -stable material.
> 
> It would be drastic, but we could call remove_one on suspend and init_one on resume. Userland might
> get excited about the interface disappearing and reappearing, but it should work. Any thoughts?

Yes, exactly. The problem would be that we redo all the data structures, too.
If you want, create a patch to test if it works. But I really don't want
to have something like that in the kernel tree, because it's worse behaviour
in the common suspend-to-ram case. Userspace is confused by it. The supplicant
for instance might, too, and might be unable to reassociate. But I don't know
for sure.

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Feb 14 22:47:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 22:47:01 +0100
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <45D32DD5.8050204@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
Message-ID: <200702142247.01680.mb@bu3sch.de>

On Wednesday 14 February 2007 16:42, Larry Finger wrote:
> marco wrote:
> > 	Hi all, 
> > i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> > While on edgy bcm43xx was running fine, on feisty i am not able to have
> > it anymore. 
> > When i try to load the module bcm43xx i get, in messages:
> > 
> > [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> 
> Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
> needed when they make the change to "feisty".

So, where's the problem? What doesn't work for you with d80211?

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Feb 14 22:52:45 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 14 Feb 2007 22:52:45 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171481275.6093.14.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<1171481180.6093.11.camel@johannes.berg>
	<1171481275.6093.14.camel@johannes.berg>
Message-ID: <200702142252.45352.mb@bu3sch.de>

On Wednesday 14 February 2007 20:27, Johannes Berg wrote:
> On Wed, 2007-02-14 at 20:26 +0100, Johannes Berg wrote:
> > On Wed, 2007-02-14 at 13:13 -0600, Larry Finger wrote:
> > 
> > > I've got a pair of BCM4306 rev 2 cards. One of them is certainly available. Its LEDS don't work
> > > anymore, but the rest is functional.
> > 
> > Oh good. Do they actually work right now?
> 
> Heh, stupid question if you say they're functional :)
> 
> Anyway, I'm not quite sure how we should keep those old code paths in
> there. Maybe having a different wireless driver for the older cores
> would be good, maybe split bcm43xx into three drivers, one for the
> PCI/SSB stuff and then two SSB drivers for old and new cores?

It's _really_ a pain to support both v3 and v4 fw in one driver.
I tried it, but it's really really hard to do. The API to the FW
is different in so many ways.
We would have to completely abstract the SharedMemory accesses.
That would mean a lot of additional code and functions (or we could
clutter the code with if{}else{} all over, which is even worse (IMO).

So, I would say we should have a seperate driver, probably also based
on d80211 for very old cards. But I don't really want to maintain
such a beast either. (I also don't have the required old HW).

-- 
Greetings Michael.


From rjw at sisk.pl  Wed Feb 14 22:53:32 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Wed, 14 Feb 2007 22:53:32 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702142243.29837.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<45D338E9.2030605@lwfinger.net> <200702142243.29837.mb@bu3sch.de>
Message-ID: <200702142253.34037.rjw@sisk.pl>

On Wednesday, 14 February 2007 22:43, Michael Buesch wrote:
> On Wednesday 14 February 2007 17:29, Larry Finger wrote:
> > > And no, it is not correct to just call attach_board from resume. ;)
> > > Instead you must copy (or probably move) the HW init stuff that
> > > is in the attach step to the init step.
> > > 
> > > I have done that in my tree in bcm43xx-d80211.
> > > 
> > > Not easy to refactor without introducing bugs. Definately _not_
> > > a patch for next -stable kernel. ;)
> > 
> > After looking through your code, I agree that it is not -stable material.
> > 
> > It would be drastic, but we could call remove_one on suspend and init_one on resume. Userland might
> > get excited about the interface disappearing and reappearing, but it should work. Any thoughts?
> 
> Yes, exactly. The problem would be that we redo all the data structures, too.
> If you want, create a patch to test if it works. But I really don't want
> to have something like that in the kernel tree, because it's worse behaviour
> in the common suspend-to-ram case. Userspace is confused by it. The supplicant
> for instance might, too, and might be unable to reassociate. But I don't know
> for sure.

I think the current behavior is acceptable if the driver generally works with
the STR.  The STR is more important to us than the STD these days. :-)

It may be possible to make it work after the resume from disk too if it's
loaded before reading the image, for example.

I have to carry out some more tests and debug it a bit more, but that will
take some time (obviously).

Greetings,
Rafael


From larry.finger at lwfinger.net  Wed Feb 14 23:28:22 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 16:28:22 -0600
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171481180.6093.11.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>	
	<45CCBB93.2040703@lwfinger.net> <45CCC5DF.8010001@gentoo.org>	
	<200702092017.36950.mb@bu3sch.de> <45CCD1B1.80709@gentoo.org>	
	<1171457525.11116.19.camel@johannes.berg>
	<45D35F65.7060001@lwfinger.net>
	<1171481180.6093.11.camel@johannes.berg>
Message-ID: <45D38D06.40801@lwfinger.net>

Johannes Berg wrote:
> On Wed, 2007-02-14 at 13:13 -0600, Larry Finger wrote:
> 
>> I've got a pair of BCM4306 rev 2 cards. One of them is certainly available. Its LEDS don't work
>> anymore, but the rest is functional.
> 
> Oh good. Do they actually work right now?
> 
> johannes

With the patches I pulled yesterday, they work to 54Mbs. Performance is not as good as the 4311 or
4318 cards, but usable.

Larry



From rjw at sisk.pl  Wed Feb 14 23:51:00 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Wed, 14 Feb 2007 23:51:00 +0100
Subject: [PATCH] bcm43xx: Fix for 4311 and 02/07/07 specification changes
In-Reply-To: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
References: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
Message-ID: <200702142351.01381.rjw@sisk.pl>

On Tuesday, 13 February 2007 23:54, Larry Finger wrote:
> The specifications for the bcm43xx driver have been modified. This patch
> incorporates these changes in the code, which results in the BCM4311 and
> BCM4312 working. The name of one of the PHY parameters, previously known
> as "version", has been changed to "analog", short for  "analog core version" .
>
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>

I have tested this patch and it works on my box, FWIW.

Greetings,
Rafael

-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From larry.finger at lwfinger.net  Wed Feb 14 23:56:05 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 16:56:05 -0600
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <200702142247.01680.mb@bu3sch.de>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
	<200702142247.01680.mb@bu3sch.de>
Message-ID: <45D39385.9050201@lwfinger.net>

Michael Buesch wrote:
> On Wednesday 14 February 2007 16:42, Larry Finger wrote:
>> marco wrote:
>>> 	Hi all, 
>>> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
>>> While on edgy bcm43xx was running fine, on feisty i am not able to have
>>> it anymore. 
>>> When i try to load the module bcm43xx i get, in messages:
>>>
>>> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
>> Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
>> needed when they make the change to "feisty".
> 
> So, where's the problem? What doesn't work for you with d80211?
> 

When I last tried, all I had was a BCM4306/2. Due to the V4 firmware problem, absolutely nothing
worked. Now that I have a 4311, I'll try again.

Larry



From mb at bu3sch.de  Thu Feb 15 00:01:37 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 00:01:37 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702142253.34037.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702142243.29837.mb@bu3sch.de> <200702142253.34037.rjw@sisk.pl>
Message-ID: <200702150001.37229.mb@bu3sch.de>

On Wednesday 14 February 2007 22:53, Rafael J. Wysocki wrote:
> I think the current behavior is acceptable if the driver generally works with
> the STR.  The STR is more important to us than the STD these days. :-)
> 
> It may be possible to make it work after the resume from disk too if it's
> loaded before reading the image, for example.
> 
> I have to carry out some more tests and debug it a bit more, but that will

Well, the easiest workaround is simply reloading bcm43xx by the hibernate scripts.
I think people could live with that for now.

-- 
Greetings Michael.


From rjw at sisk.pl  Thu Feb 15 00:11:55 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Thu, 15 Feb 2007 00:11:55 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702150001.37229.mb@bu3sch.de>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702142253.34037.rjw@sisk.pl> <200702150001.37229.mb@bu3sch.de>
Message-ID: <200702150011.56615.rjw@sisk.pl>

On Thursday, 15 February 2007 00:01, Michael Buesch wrote:
> On Wednesday 14 February 2007 22:53, Rafael J. Wysocki wrote:
> > I think the current behavior is acceptable if the driver generally works with
> > the STR.  The STR is more important to us than the STD these days. :-)
> > 
> > It may be possible to make it work after the resume from disk too if it's
> > loaded before reading the image, for example.
> > 
> > I have to carry out some more tests and debug it a bit more, but that will
> 
> Well, the easiest workaround is simply reloading bcm43xx by the hibernate scripts.
> I think people could live with that for now.

Yes, I do exactly this.  It's not really troublesome.  I only sometimes need to
switch NetworkManager to the offline and back to the online mode afterwards
so that it shows the wireless networks.

Greetings,
Rafael


From mb at bu3sch.de  Thu Feb 15 00:44:49 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 00:44:49 +0100
Subject: [PATCH] bcm43xx: Fix loss of association after resume
In-Reply-To: <200702150011.56615.rjw@sisk.pl>
References: <45cc9ebb.+9O/IXvs/C9RyFnk%Larry.Finger@lwfinger.net>
	<200702150001.37229.mb@bu3sch.de> <200702150011.56615.rjw@sisk.pl>
Message-ID: <200702150044.49679.mb@bu3sch.de>

On Thursday 15 February 2007 00:11, Rafael J. Wysocki wrote:
> On Thursday, 15 February 2007 00:01, Michael Buesch wrote:
> > On Wednesday 14 February 2007 22:53, Rafael J. Wysocki wrote:
> > > I think the current behavior is acceptable if the driver generally works with
> > > the STR.  The STR is more important to us than the STD these days. :-)
> > > 
> > > It may be possible to make it work after the resume from disk too if it's
> > > loaded before reading the image, for example.
> > > 
> > > I have to carry out some more tests and debug it a bit more, but that will
> > 
> > Well, the easiest workaround is simply reloading bcm43xx by the hibernate scripts.
> > I think people could live with that for now.
> 
> Yes, I do exactly this.  It's not really troublesome.  I only sometimes need to
> switch NetworkManager to the offline and back to the online mode afterwards
> so that it shows the wireless networks.

That is _exactly_ the problem that will show up if you completely
redo the attach step, as I suggested before, too. ;)

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Thu Feb 15 02:22:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 14 Feb 2007 19:22:41 -0600
Subject: Problem with mb tree
In-Reply-To: <200702142247.01680.mb@bu3sch.de>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
	<200702142247.01680.mb@bu3sch.de>
Message-ID: <45D3B5E1.1010701@lwfinger.net>

Michael Buesch wrote:

> So, where's the problem? What doesn't work for you with d80211?

The mb tree cannot authenticate using wpa. When I run wpa_supplicant in debug, non-daemon mode, it
generates the following:

...
State: 4WAY_HANDSHAKE -> 4WAY_HANDSHAKE
WPA: RX message 1 of 4-Way Handshake from 00:14:bf:85:49:fa (ver=1)
WPA: WPA IE for msg 2/4 - hexdump(len=24): dd 16 00 50 f2 01 01 00 00 50 f2 02 01 00 00 50 f2 02 01
00 00 50 f2 02
WPA: PMK - hexdump(len=32): [REMOVED]
WPA: PTK - hexdump(len=64): [REMOVED]
WPA: Sending EAPOL-Key 2/4
WPA: TX EAPOL-Key - hexdump(len=123): 01 03 00 77 fe 01 09 00 20 00 00 00 00 00 00 00 03 5e 7c 57 a1
27 f5 30 f1 5e 6d c0 11 6b 22 b4 00 2d 58 3f 53 0f 35 1a 53 41 5d 96 0a 10 f7 7f e4 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa f8 26 f4 3b 03
83 9e 57 b0 c5 b5 06 e5 e5 c8 00 18 dd 16 00 50 f2 01 01 00 00 50 f2 02 01 00 00 50 f2 02 01 00 00
50 f2 02
Authentication with 00:14:bf:85:49:fa timed out.

-------------------------------------- This line is a killer and the process loops.

BSSID 00:14:bf:85:49:fa blacklist count incremented to 2
State: 4WAY_HANDSHAKE -> DISCONNECTED
wpa_driver_wext_disassociate
No keys have been configured - skip key clearing
EAPOL: External notification - portEnabled=0
EAPOL: SUPP_PAE entering state DISCONNECTED
EAPOL: SUPP_BE entering state INITIALIZE
EAPOL: External notification - portValid=0
Setting scan request: 0 sec 0 usec
State: DISCONNECTED -> SCANNING
...

Is anyone using d80211 with WPA-PSK TKIP?

Larry



From mactalla.obair at gmail.com  Thu Feb 15 02:41:21 2007
From: mactalla.obair at gmail.com (Andrew Fuller)
Date: Wed, 14 Feb 2007 20:41:21 -0500
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <45D39385.9050201@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
	<200702142247.01680.mb@bu3sch.de> <45D39385.9050201@lwfinger.net>
Message-ID: <ae67fd3f0702141741r47d2bcf5p6de5fe52a75479f5@mail.gmail.com>

On 2/14/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Michael Buesch wrote:
> > On Wednesday 14 February 2007 16:42, Larry Finger wrote:
> >> marco wrote:
> >>>     Hi all,
> >>> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> >>> While on edgy bcm43xx was running fine, on feisty i am not able to have
> >>> it anymore.
> >>> When i try to load the module bcm43xx i get, in messages:
> >>>
> >>> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> >> Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
> >> needed when they make the change to "feisty".
> >
> > So, where's the problem? What doesn't work for you with d80211?
> >
>
> When I last tried, all I had was a BCM4306/2. Due to the V4 firmware problem, absolutely nothing
> worked. Now that I have a 4311, I'll try again.
>
> Larry

Just wondering with all this talk of old cards possibly getting left
behind come d80211, would a 4306rev3 be supported with v4 firmware?

Thanks,
-AF


From hs4233 at mail.mn-solutions.de  Thu Feb 15 08:34:24 2007
From: hs4233 at mail.mn-solutions.de (Holger Schurig)
Date: Thu, 15 Feb 2007 08:34:24 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <1171480578.6093.4.camel@johannes.berg>
References: <45CB6525.3070406@lwfinger.net>
	<200702141230.43855.hs4233@mail.mn-solutions.de>
	<1171480578.6093.4.camel@johannes.berg>
Message-ID: <200702150834.24520.hs4233@mail.mn-solutions.de>

> That "high speed" and "high power" is just a matter of
> programming the eeprom differently, only in the case of "high
> sensitivity" *may* actually a slightly different chip be
> present on the card.

For high speed I assumed the same.

> "high power" I'm not sure about.

For high power I don't think this is the case. The card is 
visually much thicker (the part that is outside the laptop). 
However, I opened the case and it looks like that "just" the 
antenna plates are wider away from the PCB.

Maybe there is also some extra chip there to get more antenna 
gain, I don't know.


From mb at bu3sch.de  Thu Feb 15 10:56:07 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 10:56:07 +0100
Subject: Problem with mb tree
In-Reply-To: <45D3B5E1.1010701@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo> <200702142247.01680.mb@bu3sch.de>
	<45D3B5E1.1010701@lwfinger.net>
Message-ID: <200702151056.07290.mb@bu3sch.de>

On Thursday 15 February 2007 02:22, Larry Finger wrote:
> Michael Buesch wrote:
> 
> > So, where's the problem? What doesn't work for you with d80211?
> 
> The mb tree cannot authenticate using wpa.

It authenticates fine for me in TKIP and AES mode.

Are you using a 4318? You should know that 4318 is unsupported. ;)

-- 
Greetings Michael.


From gene.heskett at verizon.net  Thu Feb 15 12:00:27 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 15 Feb 2007 06:00:27 -0500
Subject: Problem with mb tree
In-Reply-To: <200702151056.07290.mb@bu3sch.de>
References: <1171444256.12506.9.camel@pisolo> <45D3B5E1.1010701@lwfinger.net>
	<200702151056.07290.mb@bu3sch.de>
Message-ID: <200702150600.27951.gene.heskett@verizon.net>

On Thursday 15 February 2007, Michael Buesch wrote:
>On Thursday 15 February 2007 02:22, Larry Finger wrote:
>> Michael Buesch wrote:
>> > So, where's the problem? What doesn't work for you with d80211?
>>
>> The mb tree cannot authenticate using wpa.
>
>It authenticates fine for me in TKIP and AES mode.
>
>Are you using a 4318? You should know that 4318 is unsupported. ;)

It might not be supported, but with a bit of fiddling its working just 
fine in my HP lappy.  Now using the in kernel bcm43xx driver in the 
latest FC5 kernel. 

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From mb at bu3sch.de  Thu Feb 15 12:16:45 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 12:16:45 +0100
Subject: Problem with mb tree
In-Reply-To: <200702150600.27951.gene.heskett@verizon.net>
References: <1171444256.12506.9.camel@pisolo> <200702151056.07290.mb@bu3sch.de>
	<200702150600.27951.gene.heskett@verizon.net>
Message-ID: <200702151216.45244.mb@bu3sch.de>

On Thursday 15 February 2007 12:00, Gene Heskett wrote:
> On Thursday 15 February 2007, Michael Buesch wrote:
> >On Thursday 15 February 2007 02:22, Larry Finger wrote:
> >> Michael Buesch wrote:
> >> > So, where's the problem? What doesn't work for you with d80211?
> >>
> >> The mb tree cannot authenticate using wpa.
> >
> >It authenticates fine for me in TKIP and AES mode.
> >
> >Are you using a 4318? You should know that 4318 is unsupported. ;)
> 
> It might not be supported, but with a bit of fiddling its working just 
> fine in my HP lappy.  Now using the in kernel bcm43xx driver in the 
> latest FC5 kernel. 
> 

We are talking about my development tree.
It is _unsupported_. And If I say _unsupported_ I really really really
mean _unsupported_. ;)

-- 
Greetings Michael.


From gaedol at gmail.com  Thu Feb 15 13:01:19 2007
From: gaedol at gmail.com (marco)
Date: Thu, 15 Feb 2007 13:01:19 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171471546.2240.4.camel@dv>
References: <1171444256.12506.9.camel@pisolo>
	<45D2DE54.5070806@citycable.ch>  <1171457458.8176.6.camel@pisolo>
	<1171471546.2240.4.camel@dv>
Message-ID: <1171540879.5192.9.camel@pisolo>

On mer, 2007-02-14 at 11:45 -0500, Pavel Roskin wrote:

> Please report the result.  If everything is fine on PowerPC, I think
> it's time for version 007.


hi, 
tried with svn version of fwcutter and it worked great on the ibook. 


Now my firmware gets loaded flawlessy (according to dmesg), but when i
set the ESSID it can't get associated.
Nor i see my AP:

$ iwlist eth1 scanning
eth1      No scan results
$

eth1 is UP.

dmesg says nothing, in the meanwhile, about authentication.

this is the relevant part of dmesg:

[ 5581.730794] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
[ 5581.730815] ssb: Core 1 found: cc 0812, rev 05, vendor 4243
[ 5581.730853] ssb: Core 2 found: cc 080D, rev 02, vendor 4243
[ 5581.730865] ssb: Core 3 found: cc 0807, rev 02, vendor 4243
[ 5581.730877] ssb: Core 4 found: cc 0804, rev 09, vendor 4243
[ 5581.730885] bcm43xx: Broadcom 4306 WLAN found
[ 5581.730896] ssb: Switching to core 4
[ 5581.736781] ssb: Switching to core 1
[ 5581.737995] wmaster0: Selected rate control algorithm 'simple'
[ 5582.310834] ssb: Switching to core 0
[ 5582.311031] ssb: Switching to core 1
[ 5582.488400] bcm43xx: firmware revision 173, patchlevel 462, date 2006-11-08 22:02:13
[ 5582.488423] ssb: Switching to core 0
[ 5582.492034] ssb: Switching to core 1
[ 5582.698924] ssb: Switching to core 0
[ 5582.709872] ssb: Switching to core 1
[ 5582.746240] wmaster0: Does not support passive scan, disabled
[ 5592.874830] eth1: no IPv6 routers present
[ 5743.225277] eth1: starting scan
[ 5743.287912] eth0: Link is up at 100 Mbps, full-duplex.
[ 5743.287930] eth0: Pause is disabled
[ 5743.982736] eth1: scan completed
[ 5745.294271] eth1: starting scan
[ 5746.042706] eth1: scan completed
[ 5753.798833] eth0: no IPv6 routers present
[ 6089.638982] eth1: starting scan
[ 6090.390668] eth1: scan completed
[ 6116.011187] eth1: starting scan
[ 6116.762762] eth1: scan completed
[ 6116.782561] eth1: starting scan
[ 6116.807914] eth0: Link is up at 100 Mbps, full-duplex.
[ 6116.807932] eth0: Pause is disabled
[ 6117.530684] eth1: scan completed
[ 6136.066842] eth0: no IPv6 routers present

eth0 is wired, eth1 is wireless...


Any ideas at this point?


thanks & ciao, 

marco




From martin-langer at gmx.de  Thu Feb 15 13:19:12 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Thu, 15 Feb 2007 13:19:12 +0100
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <ae67fd3f0702141741r47d2bcf5p6de5fe52a75479f5@mail.gmail.com>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
	<200702142247.01680.mb@bu3sch.de> <45D39385.9050201@lwfinger.net>
	<ae67fd3f0702141741r47d2bcf5p6de5fe52a75479f5@mail.gmail.com>
Message-ID: <20070215121912.GA3303@tuba>

On Wed, Feb 14, 2007 at 08:41:21PM -0500, Andrew Fuller wrote:
> On 2/14/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > Michael Buesch wrote:
> > > On Wednesday 14 February 2007 16:42, Larry Finger wrote:
> > >> marco wrote:
> > >>>     Hi all,
> > >>> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> > >>> While on edgy bcm43xx was running fine, on feisty i am not able to have
> > >>> it anymore.
> > >>> When i try to load the module bcm43xx i get, in messages:
> > >>>
> > >>> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> > >> Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
> > >> needed when they make the change to "feisty".
> > >
> > > So, where's the problem? What doesn't work for you with d80211?
> > >
> >
> > When I last tried, all I had was a BCM4306/2. Due to the V4 firmware problem, absolutely nothing
> > worked. Now that I have a 4311, I'll try again.
> >
> > Larry
> 
> Just wondering with all this talk of old cards possibly getting left
> behind come d80211, would a 4306rev3 be supported with v4 firmware?

That revision number says nothing about it.

Look for an entry in your dmesg output which describes the 0x812 core:
e.g. bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
                                ^^^^^^^

There is a revision number which is the key for v4 suppport. You'll need 
at least revision number 0x4 there for d80211 support. The older 
revisions 0x2 and 0x3 have to use the softmac stack. 

Martin


From mactalla.obair at gmail.com  Thu Feb 15 13:30:03 2007
From: mactalla.obair at gmail.com (Andrew Fuller)
Date: Thu, 15 Feb 2007 07:30:03 -0500
Subject: Problem with Ubuntu feisty - V4 firmware required
In-Reply-To: <20070215121912.GA3303@tuba>
References: <1171444256.12506.9.camel@pisolo> <45D32DD5.8050204@lwfinger.net>
	<200702142247.01680.mb@bu3sch.de> <45D39385.9050201@lwfinger.net>
	<ae67fd3f0702141741r47d2bcf5p6de5fe52a75479f5@mail.gmail.com>
	<20070215121912.GA3303@tuba>
Message-ID: <ae67fd3f0702150430h4f10108cw7a39f5f59782f64a@mail.gmail.com>

On 2/15/07, Martin Langer <martin-langer at gmx.de> wrote:
> On Wed, Feb 14, 2007 at 08:41:21PM -0500, Andrew Fuller wrote:
> > On 2/14/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > > Michael Buesch wrote:
> > > > On Wednesday 14 February 2007 16:42, Larry Finger wrote:
> > > >> marco wrote:
> > > >>>     Hi all,
> > > >>> i have recently upgraded my ibook G4 from ubuntu edgy to feisty.
> > > >>> While on edgy bcm43xx was running fine, on feisty i am not able to have
> > > >>> it anymore.
> > > >>> When i try to load the module bcm43xx i get, in messages:
> > > >>>
> > > >>> [ 5038.591146] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> > > >> Obviously, Ubuntu switched to the d80211 stack. All users must be aware that V4 firmware will be
> > > >> needed when they make the change to "feisty".
> > > >
> > > > So, where's the problem? What doesn't work for you with d80211?
> > > >
> > >
> > > When I last tried, all I had was a BCM4306/2. Due to the V4 firmware problem, absolutely nothing
> > > worked. Now that I have a 4311, I'll try again.
> > >
> > > Larry
> >
> > Just wondering with all this talk of old cards possibly getting left
> > behind come d80211, would a 4306rev3 be supported with v4 firmware?
>
> That revision number says nothing about it.
>
> Look for an entry in your dmesg output which describes the 0x812 core:
> e.g. bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243
>                                 ^^^^^^^
>
> There is a revision number which is the key for v4 suppport. You'll need
> at least revision number 0x4 there for d80211 support. The older
> revisions 0x2 and 0x3 have to use the softmac stack.
>
> Martin

Sweet.  Mine's rev 0x5, so my laptop's safe :)

Thanks for the clarification.

-AF


From mb at bu3sch.de  Thu Feb 15 13:45:50 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 13:45:50 +0100
Subject: Problem with firmware on ibook G4
In-Reply-To: <1171540879.5192.9.camel@pisolo>
References: <1171444256.12506.9.camel@pisolo> <1171471546.2240.4.camel@dv>
	<1171540879.5192.9.camel@pisolo>
Message-ID: <200702151345.50208.mb@bu3sch.de>

On Thursday 15 February 2007 13:01, marco wrote:
> On mer, 2007-02-14 at 11:45 -0500, Pavel Roskin wrote:
> 
> > Please report the result.  If everything is fine on PowerPC, I think
> > it's time for version 007.
> 
> 
> hi, 
> tried with svn version of fwcutter and it worked great on the ibook. 
> 
> 
> Now my firmware gets loaded flawlessy (according to dmesg), but when i
> set the ESSID it can't get associated.
> Nor i see my AP:
> 
> $ iwlist eth1 scanning
> eth1      No scan results
> $
> 
> eth1 is UP.
> 
> dmesg says nothing, in the meanwhile, about authentication.
> 
> this is the relevant part of dmesg:
> 
> [ 5581.730794] ssb: Core 0 found: cc 0800, rev 04, vendor 4243
> [ 5581.730815] ssb: Core 1 found: cc 0812, rev 05, vendor 4243
> [ 5581.730853] ssb: Core 2 found: cc 080D, rev 02, vendor 4243
> [ 5581.730865] ssb: Core 3 found: cc 0807, rev 02, vendor 4243
> [ 5581.730877] ssb: Core 4 found: cc 0804, rev 09, vendor 4243
> [ 5581.730885] bcm43xx: Broadcom 4306 WLAN found

I wonder which kernel you are using. This looks like a
damn old driver.

-- 
Greetings Michael.


From johannes at sipsolutions.net  Thu Feb 15 16:07:04 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 16:07:04 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702142240.01494.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702100655.51495.mb@bu3sch.de>
	<1171459090.11116.22.camel@johannes.berg>
	<200702142240.01494.mb@bu3sch.de>
Message-ID: <1171552024.5220.4.camel@johannes.berg>

On Wed, 2007-02-14 at 22:40 +0100, Michael Buesch wrote:
> On Wednesday 14 February 2007 14:18, Johannes Berg wrote:
> > On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:
> > 
> > > It's likely that old cards still work with v4 firmware,
> > 
> > No, it's absolutely impossible. Rev 2/4 cores have a totally different
> > instruction set in the microcode.
> 
> Ok, I was not talking about _that_ old cards. ;)

Are there cards where they have new microcode instruction set but no v4
firmware?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/374696eb/attachment.pgp>

From mb at bu3sch.de  Thu Feb 15 16:13:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 16:13:20 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171552024.5220.4.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702142240.01494.mb@bu3sch.de>
	<1171552024.5220.4.camel@johannes.berg>
Message-ID: <200702151613.20746.mb@bu3sch.de>

On Thursday 15 February 2007 16:07, Johannes Berg wrote:
> On Wed, 2007-02-14 at 22:40 +0100, Michael Buesch wrote:
> > On Wednesday 14 February 2007 14:18, Johannes Berg wrote:
> > > On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:
> > > 
> > > > It's likely that old cards still work with v4 firmware,
> > > 
> > > No, it's absolutely impossible. Rev 2/4 cores have a totally different
> > > instruction set in the microcode.
> > 
> > Ok, I was not talking about _that_ old cards. ;)
> 
> Are there cards where they have new microcode instruction set but no v4
> firmware?

I don't know. I guessed so. Am I wrong? That would be good :)

-- 
Greetings Michael.


From johannes at sipsolutions.net  Thu Feb 15 16:19:13 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 16:19:13 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <200702151613.20746.mb@bu3sch.de>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702142240.01494.mb@bu3sch.de>
	<1171552024.5220.4.camel@johannes.berg>
	<200702151613.20746.mb@bu3sch.de>
Message-ID: <1171552753.5220.10.camel@johannes.berg>

On Thu, 2007-02-15 at 16:13 +0100, Michael Buesch wrote:
> On Thursday 15 February 2007 16:07, Johannes Berg wrote:
> > On Wed, 2007-02-14 at 22:40 +0100, Michael Buesch wrote:
> > > On Wednesday 14 February 2007 14:18, Johannes Berg wrote:
> > > > On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:
> > > > 
> > > > > It's likely that old cards still work with v4 firmware,
> > > > 
> > > > No, it's absolutely impossible. Rev 2/4 cores have a totally different
> > > > instruction set in the microcode.
> > > 
> > > Ok, I was not talking about _that_ old cards. ;)
> > 
> > Are there cards where they have new microcode instruction set but no v4
> > firmware?
> 
> I don't know. I guessed so. Am I wrong? That would be good :)

I wouldn't think so since we have rev5 v4 firmware and that should be
the oldest post-rev4 right?

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/95537051/attachment.pgp>

From larry.finger at lwfinger.net  Thu Feb 15 16:23:57 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 15 Feb 2007 09:23:57 -0600
Subject: Problem with mb tree
In-Reply-To: <200702151056.07290.mb@bu3sch.de>
References: <1171444256.12506.9.camel@pisolo>
	<200702142247.01680.mb@bu3sch.de>	<45D3B5E1.1010701@lwfinger.net>
	<200702151056.07290.mb@bu3sch.de>
Message-ID: <45D47B0D.9030608@lwfinger.net>

Michael Buesch wrote:
> On Thursday 15 February 2007 02:22, Larry Finger wrote:
>> Michael Buesch wrote:
>>
>>> So, where's the problem? What doesn't work for you with d80211?
>> The mb tree cannot authenticate using wpa.
> 
> It authenticates fine for me in TKIP and AES mode.
> 
> Are you using a 4318? You should know that 4318 is unsupported. ;)
> 

No, it is a 4311.

Larry



From mb at bu3sch.de  Thu Feb 15 16:32:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 16:32:42 +0100
Subject: Problem with mb tree
In-Reply-To: <45D47B0D.9030608@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo> <200702151056.07290.mb@bu3sch.de>
	<45D47B0D.9030608@lwfinger.net>
Message-ID: <200702151632.42266.mb@bu3sch.de>

On Thursday 15 February 2007 16:23, Larry Finger wrote:
> Michael Buesch wrote:
> > On Thursday 15 February 2007 02:22, Larry Finger wrote:
> >> Michael Buesch wrote:
> >>
> >>> So, where's the problem? What doesn't work for you with d80211?
> >> The mb tree cannot authenticate using wpa.
> > 
> > It authenticates fine for me in TKIP and AES mode.
> > 
> > Are you using a 4318? You should know that 4318 is unsupported. ;)
> > 
> 
> No, it is a 4311.

Well, I think that has the same problem with not being able
to transmit all packets. So it looses important packets.
Can you try with a 4306?

-- 
Greetings Michael.


From johannes at sipsolutions.net  Thu Feb 15 17:11:38 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 17:11:38 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <200702150834.24520.hs4233@mail.mn-solutions.de>
References: <45CB6525.3070406@lwfinger.net>
	<200702141230.43855.hs4233@mail.mn-solutions.de>
	<1171480578.6093.4.camel@johannes.berg>
	<200702150834.24520.hs4233@mail.mn-solutions.de>
Message-ID: <1171555898.5220.20.camel@johannes.berg>

On Thu, 2007-02-15 at 08:34 +0100, Holger Schurig wrote:
> > That "high speed" and "high power" is just a matter of
> > programming the eeprom differently, only in the case of "high
> > sensitivity" *may* actually a slightly different chip be
> > present on the card.
> 
> For high speed I assumed the same.

I'm pretty sure that high speed is just 802.11e frame aggregation or
similar.

> For high power I don't think this is the case. The card is 
> visually much thicker (the part that is outside the laptop). 
> However, I opened the case and it looks like that "just" the 
> antenna plates are wider away from the PCB.
> 
> Maybe there is also some extra chip there to get more antenna 
> gain, I don't know.

But that doesn't necessarily mean that it needs to be programmed
differently. The eeprom settings and the calibration is quite flexible
so a higher power chip with the appropriate feedback would be
sufficient.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/0193e312/attachment.pgp>

From Larry.Finger at lwfinger.net  Thu Feb 15 17:25:42 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 15 Feb 2007 10:25:42 -0600
Subject: V4 firmware and supported cards in d80211
Message-ID: <45D48986.1010102@lwfinger.net>

My BCM4306 cards are among the oldest 802.11g varieties as they were actually pre-G versions. They
have a 0x812 core rev of 4 and firmware4.fw was extracted from my V4 driver. Therefore, it seems
safe to conclude that all GPHY varieties will be supported by d80211. Thus only the BPHY chips
(BCM4301 and BCM4303) will be unsupported.

In a related matter, my BCM4306's have only 30-bit DMA, and the fixes for DMA with more than 1 GB
RAM will be needed. As I have the necessary hardware, and did that patch for softmac, I will prepare
and submit such a patch for d80211.

Larry


From larry.finger at lwfinger.net  Thu Feb 15 17:32:05 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 15 Feb 2007 10:32:05 -0600
Subject: Problem with mb tree
In-Reply-To: <200702151632.42266.mb@bu3sch.de>
References: <1171444256.12506.9.camel@pisolo> <200702151056.07290.mb@bu3sch.de>
	<45D47B0D.9030608@lwfinger.net> <200702151632.42266.mb@bu3sch.de>
Message-ID: <45D48B05.1050004@lwfinger.net>

Michael Buesch wrote:
> On Thursday 15 February 2007 16:23, Larry Finger wrote:
>> Michael Buesch wrote:
>>> On Thursday 15 February 2007 02:22, Larry Finger wrote:
>>>> Michael Buesch wrote:
>>>>
>>>>> So, where's the problem? What doesn't work for you with d80211?
>>>> The mb tree cannot authenticate using wpa.
>>> It authenticates fine for me in TKIP and AES mode.
>>>
>>> Are you using a 4318? You should know that 4318 is unsupported. ;)
>>>
>> No, it is a 4311.
> 
> Well, I think that has the same problem with not being able
> to transmit all packets. So it looses important packets.
> Can you try with a 4306?

Yes, but that testing just got more difficult. My old laptop that was used for the purpose died, and
my new one has an ExpressCard slot. No place for PCMCIA cards. To do testing with 4306 and 4318
varieties, I have to take my server off-line.

Larry


From johannes at sipsolutions.net  Thu Feb 15 17:45:04 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 17:45:04 +0100
Subject: V4 firmware and supported cards in d80211
In-Reply-To: <45D48986.1010102@lwfinger.net>
References: <45D48986.1010102@lwfinger.net>
Message-ID: <1171557904.5220.34.camel@johannes.berg>

On Thu, 2007-02-15 at 10:25 -0600, Larry Finger wrote:
> My BCM4306 cards are among the oldest 802.11g varieties as they were actually pre-G versions. They
> have a 0x812 core rev of 4 and firmware4.fw was extracted from my V4 driver.

Hmm, you're right, I was wrong about them not doing a rev4 v4 firmware.

> Therefore, it seems
> safe to conclude that all GPHY varieties will be supported by d80211. Thus only the BPHY chips
> (BCM4301 and BCM4303) will be unsupported.

Yup, looks like. The question is what we do about them. Do we just
remove support for them once bcm43xx gets deleted in favour of the
d80211 version?

> In a related matter, my BCM4306's have only 30-bit DMA, and the fixes for DMA with more than 1 GB
> RAM will be needed. As I have the necessary hardware, and did that patch for softmac, I will prepare
> and submit such a patch for d80211.

Ah, great. I don't actually have that much memory in my laptop, and no
PCI machine to put my PCI bcm card in...

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/26903509/attachment.pgp>

From johannes at sipsolutions.net  Thu Feb 15 17:46:21 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 17:46:21 +0100
Subject: Problem with mb tree
In-Reply-To: <45D48B05.1050004@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo>
	<200702151056.07290.mb@bu3sch.de> <45D47B0D.9030608@lwfinger.net>
	<200702151632.42266.mb@bu3sch.de>  <45D48B05.1050004@lwfinger.net>
Message-ID: <1171557981.5220.36.camel@johannes.berg>

On Thu, 2007-02-15 at 10:32 -0600, Larry Finger wrote:

> Yes, but that testing just got more difficult. My old laptop that was used for the purpose died, and
> my new one has an ExpressCard slot. No place for PCMCIA cards. To do testing with 4306 and 4318
> varieties, I have to take my server off-line.

If you have any machine with PCI slots I can send you a 4306 PCI card.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/49fa9b26/attachment.pgp>

From martin-langer at gmx.de  Thu Feb 15 17:51:25 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Thu, 15 Feb 2007 17:51:25 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <1171552753.5220.10.camel@johannes.berg>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702142240.01494.mb@bu3sch.de>
	<1171552024.5220.4.camel@johannes.berg>
	<200702151613.20746.mb@bu3sch.de>
	<1171552753.5220.10.camel@johannes.berg>
Message-ID: <20070215165125.GA3328@tuba>

On Thu, Feb 15, 2007 at 04:19:13PM +0100, Johannes Berg wrote:
> On Thu, 2007-02-15 at 16:13 +0100, Michael Buesch wrote:
> > On Thursday 15 February 2007 16:07, Johannes Berg wrote:
> > > On Wed, 2007-02-14 at 22:40 +0100, Michael Buesch wrote:
> > > > On Wednesday 14 February 2007 14:18, Johannes Berg wrote:
> > > > > On Sat, 2007-02-10 at 06:55 +0100, Michael Buesch wrote:
> > > > > 
> > > > > > It's likely that old cards still work with v4 firmware,
> > > > > 
> > > > > No, it's absolutely impossible. Rev 2/4 cores have a totally different
> > > > > instruction set in the microcode.
> > > > 
> > > > Ok, I was not talking about _that_ old cards. ;)
> > > 
> > > Are there cards where they have new microcode instruction set but no v4
> > > firmware?
> > 
> > I don't know. I guessed so. Am I wrong? That would be good :)
> 
> I wouldn't think so since we have rev5 v4 firmware and that should be
> the oldest post-rev4 right?

Yep. We have all kinds of firmware with the new instruction set. It's 
only ucode2 (old instruction set) that's missing. But the later ucode4 
which also uses the old instruction set is available in v4.
OTOH, ucode13 isn't available in v3. We can't offer one firmware version 
for all card revisions. Both are limited to a specific range of 
revisions.

v3	rev2...rev12
v4	rev4...<=rev13


Martin


From johannes at sipsolutions.net  Thu Feb 15 17:53:33 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 17:53:33 +0100
Subject: [PATCH] bcm43xx: Fix code for spec changes of 2/7/2007
In-Reply-To: <20070215165125.GA3328@tuba>
References: <45cca236.+lL/rsW3DbM3elnk%Larry.Finger@lwfinger.net>
	<200702142240.01494.mb@bu3sch.de>
	<1171552024.5220.4.camel@johannes.berg>
	<200702151613.20746.mb@bu3sch.de>
	<1171552753.5220.10.camel@johannes.berg>
	<20070215165125.GA3328@tuba>
Message-ID: <1171558414.5220.38.camel@johannes.berg>

On Thu, 2007-02-15 at 17:51 +0100, Martin Langer wrote:

> Yep. We have all kinds of firmware with the new instruction set. It's 
> only ucode2 (old instruction set) that's missing. But the later ucode4 
> which also uses the old instruction set is available in v4.
> OTOH, ucode13 isn't available in v3. We can't offer one firmware version 
> for all card revisions. Both are limited to a specific range of 
> revisions.
> 
> v3	rev2...rev12
> v4	rev4...<=rev13

The upper limit doesn't really matter, afaict the effect of running a
rev9 instead of rev13 will just be a missing performance increase due to
bigger FIFOs not being used fully.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/35b078e1/attachment.pgp>

From larry.finger at lwfinger.net  Thu Feb 15 18:20:15 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 15 Feb 2007 11:20:15 -0600
Subject: Problem with mb tree
In-Reply-To: <1171557981.5220.36.camel@johannes.berg>
References: <1171444256.12506.9.camel@pisolo>	<200702151056.07290.mb@bu3sch.de>
	<45D47B0D.9030608@lwfinger.net>	<200702151632.42266.mb@bu3sch.de>
	<45D48B05.1050004@lwfinger.net>
	<1171557981.5220.36.camel@johannes.berg>
Message-ID: <45D4964F.8000104@lwfinger.net>

Johannes Berg wrote:
> On Thu, 2007-02-15 at 10:32 -0600, Larry Finger wrote:
> 
>> Yes, but that testing just got more difficult. My old laptop that was used for the purpose died, and
>> my new one has an ExpressCard slot. No place for PCMCIA cards. To do testing with 4306 and 4318
>> varieties, I have to take my server off-line.
> 
> If you have any machine with PCI slots I can send you a 4306 PCI card.

Thanks for the offer, but my only machine with a PCI slot is Windows only. If I were to put Linux on
it, my wife would have my head. She isn't very happy with Vista, but she does a lot of stuff that
won't run on Linux, even under Wine. Perhaps with vmware, but I'm not going there now.

Does anyone in the US have a laptop that they could loan me? It doesn't have to be much. It would
not be running X, thus the memory requirements would be low. In fact, the display need not work as I
would ssh into it as I have been doing. Similarly, no hard-wired network card is needed. I have a
hard drive that I would use. Of course, it needs a working PCMCIA slot.

Thanks,

Larry




From johannes at sipsolutions.net  Thu Feb 15 18:39:18 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 18:39:18 +0100
Subject: Problem with mb tree
In-Reply-To: <45D4964F.8000104@lwfinger.net>
References: <1171444256.12506.9.camel@pisolo>
	<200702151056.07290.mb@bu3sch.de> <45D47B0D.9030608@lwfinger.net>
	<200702151632.42266.mb@bu3sch.de>  <45D48B05.1050004@lwfinger.net>
	<1171557981.5220.36.camel@johannes.berg>
	<45D4964F.8000104@lwfinger.net>
Message-ID: <1171561158.5220.42.camel@johannes.berg>

On Thu, 2007-02-15 at 11:20 -0600, Larry Finger wrote:

> Does anyone in the US have a laptop that they could loan me? It doesn't have to be much. It would
> not be running X, thus the memory requirements would be low. In fact, the display need not work as I
> would ssh into it as I have been doing. Similarly, no hard-wired network card is needed. I have a
> hard drive that I would use. Of course, it needs a working PCMCIA slot.

Maybe you can find one on ebay. We still have enough donations to get a
laptop like that and there isn't much point in not using the money if we
need to.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/51c37ff5/attachment.pgp>

From mb at bu3sch.de  Thu Feb 15 20:28:37 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 15 Feb 2007 20:28:37 +0100
Subject: DON'T use Ubuntu Feisty kernel
Message-ID: <200702152028.37965.mb@bu3sch.de>

https://launchpad.net/bugs/85404

It turns out that they ship a heavily obsolete,
deprecated and unsupported piece of bcm43xx junk.

Please don't report bugs on it.

-- 
Greetings Michael.


From johannes at sipsolutions.net  Thu Feb 15 23:22:05 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Thu, 15 Feb 2007 23:22:05 +0100
Subject: Survey of bcm43xx cards
In-Reply-To: <1171555898.5220.20.camel@johannes.berg>
References: <45CB6525.3070406@lwfinger.net>
	<200702141230.43855.hs4233@mail.mn-solutions.de>
	<1171480578.6093.4.camel@johannes.berg>
	<200702150834.24520.hs4233@mail.mn-solutions.de>
	<1171555898.5220.20.camel@johannes.berg>
Message-ID: <1171578125.5220.65.camel@johannes.berg>

On Thu, 2007-02-15 at 17:11 +0100, Johannes Berg wrote:

> I'm pretty sure that high speed is just 802.11e frame aggregation or
> similar.

Ignore me. .11e defines block-ack, no frame aggregation. Afaict Broadcom
does in fact do frame aggregation, however, that isn't defined anywhere
yet.

johannes -- now let me try finding my head

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070215/b85ed305/attachment.pgp>

From mjg59 at srcf.ucam.org  Fri Feb 16 15:13:21 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 16 Feb 2007 14:13:21 +0000
Subject: DON'T use Ubuntu Feisty kernel
In-Reply-To: <200702152028.37965.mb@bu3sch.de>
References: <200702152028.37965.mb@bu3sch.de>
Message-ID: <20070216141321.GA13790@srcf.ucam.org>

On Thu, Feb 15, 2007 at 08:28:37PM +0100, Michael Buesch wrote:
> https://launchpad.net/bugs/85404
> 
> It turns out that they ship a heavily obsolete,
> deprecated and unsupported piece of bcm43xx junk.

Yes, sorry about this - there was some miscommunication and an ancient 
patch got applied and shipped. Things should be rectified in the next 
upload.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mjg59 at srcf.ucam.org  Fri Feb 16 15:15:22 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 16 Feb 2007 14:15:22 +0000
Subject: V4 firmware and supported cards in d80211
In-Reply-To: <1171557904.5220.34.camel@johannes.berg>
References: <45D48986.1010102@lwfinger.net>
	<1171557904.5220.34.camel@johannes.berg>
Message-ID: <20070216141522.GB13790@srcf.ucam.org>

On Thu, Feb 15, 2007 at 05:45:04PM +0100, Johannes Berg wrote:

> Yup, looks like. The question is what we do about them. Do we just
> remove support for them once bcm43xx gets deleted in favour of the
> d80211 version?

Easiest might just be to leave the softmac driver with only the bcm4301 
and bcm4303 PCI IDs in the short term, and then let someone port that 
over to d80211 independently?

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Fri Feb 16 15:19:18 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 16 Feb 2007 15:19:18 +0100
Subject: DON'T use Ubuntu Feisty kernel
In-Reply-To: <20070216141317.GB31494@gateway.home>
References: <200702152028.37965.mb@bu3sch.de>
	<20070216141317.GB31494@gateway.home>
Message-ID: <200702161519.18273.mb@bu3sch.de>

On Friday 16 February 2007 15:13, Erik Mouw wrote:
> On Thu, Feb 15, 2007 at 08:28:37PM +0100, Michael Buesch wrote:
> > https://launchpad.net/bugs/85404
> > 
> > It turns out that they ship a heavily obsolete,
> > deprecated and unsupported piece of bcm43xx junk.
> 
> Isn't that true for any distro?

Well, depends. :)
I think Fedora for example has a pretty usable driver
in their kernel. But I didn't try that myself.

-- 
Greetings Michael.


From mouw at nl.linux.org  Fri Feb 16 15:13:18 2007
From: mouw at nl.linux.org (Erik Mouw)
Date: Fri, 16 Feb 2007 15:13:18 +0100
Subject: DON'T use Ubuntu Feisty kernel
In-Reply-To: <200702152028.37965.mb@bu3sch.de>
References: <200702152028.37965.mb@bu3sch.de>
Message-ID: <20070216141317.GB31494@gateway.home>

On Thu, Feb 15, 2007 at 08:28:37PM +0100, Michael Buesch wrote:
> https://launchpad.net/bugs/85404
> 
> It turns out that they ship a heavily obsolete,
> deprecated and unsupported piece of bcm43xx junk.

Isn't that true for any distro?


Erik

-- 
They're all fools. Don't worry. Darwin may be slow, but he'll
eventually get them. -- Matthew Lammers in alt.sysadmin.recovery
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070216/6163572e/attachment.pgp>

From larry.finger at lwfinger.net  Fri Feb 16 17:08:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 16 Feb 2007 10:08:41 -0600
Subject: DON'T use Ubuntu Feisty kernel
In-Reply-To: <20070216141317.GB31494@gateway.home>
References: <200702152028.37965.mb@bu3sch.de>
	<20070216141317.GB31494@gateway.home>
Message-ID: <45D5D709.3040405@lwfinger.net>

Erik Mouw wrote:
> On Thu, Feb 15, 2007 at 08:28:37PM +0100, Michael Buesch wrote:
>> https://launchpad.net/bugs/85404
>>
>> It turns out that they ship a heavily obsolete,
>> deprecated and unsupported piece of bcm43xx junk.
> 
> Isn't that true for any distro?

Certainly not with openSUSE, which is my distro of choice. They are using a 2.6.18 kernel and will
apply only the patches that are in stable. I tried to get them to put in the fixes that make PCIe
work, but they refused for the same reason as -stable will not accept them, i.e. only bug fixes, no
feature additions.

Larry


From proski at gnu.org  Sat Feb 17 06:41:08 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 00:41:08 -0500
Subject: More breakage in wireless-dev.git
Message-ID: <1171690868.31103.17.camel@dv>

Hello!

There are more problems with today's wireless-dev.git even after I
applied the two Johannes' patches.

Even after updating DadWifi to the new API, it keeps crashing, and
debugging shows that it doesn't happens around the changes code.

One of the crashes happens in spin_lock_init() on a spinlock that has
just been allocated by ieee80211_alloc_hw().  Maybe the size of the
private area is miscalculated.  I have most checks enabled, including
Ingo's lockdep checker, but everything worked with the yesterday's tree.

In another case, access to another field in the private are causes
kernel oops.  Looking at the code now, I see that both fields are close
to the end on the structure used for private data.  I guess something is
either messing with the private data or not enough space is allocated.

To exclude issues with DadWifi, I tried bcm43xx_d80211 from the kernel.
It has always worked for me, but this time I got a message:

FOUND UNSUPPORTED PHY (Analog 4, Type 0, Revision 7)

Attempt to bring the interface down resulted in this:

slab error in verify_redzone_free(): cache `size-64': double free detected
Call Trace:
 [<ffffffff8027c091>] __slab_error+0x21/0x30
 [<ffffffff8027c908>] cache_free_debugcheck+0xf8/0x220
 [<ffffffff880371cf>] :bcm43xx_d80211:bcm43xx_wireless_core_exit+0x3f/0x90
 [<ffffffff8027cc00>] kfree+0xb0/0x120
 [<ffffffff880371cf>] :bcm43xx_d80211:bcm43xx_wireless_core_exit+0x3f/0x90
 [<ffffffff8803789c>] :bcm43xx_d80211:bcm43xx_remove_interface+0xfc/0x140
 [<ffffffff8800d086>] :80211:ieee80211_stop+0x106/0x130
 [<ffffffff804612a2>] dev_close+0x62/0x90
 [<ffffffff804606bd>] dev_change_flags+0x6d/0x150
 [<ffffffff8049c97c>] devinet_ioctl+0x30c/0x730
 [<ffffffff804623b4>] dev_ioctl+0x304/0x370
 [<ffffffff802435b6>] up_read+0x26/0x30
 [<ffffffff8049d08c>] inet_ioctl+0x4c/0x70
 [<ffffffff804556c0>] sock_ioctl+0x210/0x240
 [<ffffffff8028dcdb>] do_ioctl+0x1b/0x60
 [<ffffffff8028df81>] vfs_ioctl+0x261/0x280
 [<ffffffff8028dfea>] sys_ioctl+0x4a/0x80
 [<ffffffff80209b1e>] system_call+0x7e/0x83

ffff81001d775c38: redzone 1:0x5a2cf071, redzone 2:0x5a2cf071.
slab: double free detected in cache 'size-64', objp ffff81001d775c38

Again, phy is a private part of the network device, and both direct
kfree() calls in bcm43xx_wireless_core_exit() are applied to pointers
kept in phy.

Copying to bcm43xx folks to alert them of the breakage.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Sat Feb 17 09:06:14 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 03:06:14 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <1171690868.31103.17.camel@dv>
References: <1171690868.31103.17.camel@dv>
Message-ID: <1171699574.32411.6.camel@dv>

On Sat, 2007-02-17 at 00:41 -0500, Pavel Roskin wrote:

> There are more problems with today's wireless-dev.git even after I
> applied the two Johannes' patches.

Fixed in "d80211: fix incorrect hw.priv setting in ieee80211_alloc_hw()"
posted in linux-wireless.  In the meantime, just remove the second
assignment for local->hw.priv in ieee80211_alloc_hw().

I'm still getting "bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type
0, Revision 7)" from bcm43xx_d80211 for a card that used to work.  That
must be a separate problem.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Sat Feb 17 14:02:24 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 14:02:24 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <1171699574.32411.6.camel@dv>
References: <1171690868.31103.17.camel@dv> <1171699574.32411.6.camel@dv>
Message-ID: <200702171402.24593.mb@bu3sch.de>

On Saturday 17 February 2007 09:06, Pavel Roskin wrote:
> I'm still getting "bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type
> 0, Revision 7)" from bcm43xx_d80211 for a card that used to work.  That
> must be a separate problem.

More info about your device, please.

-- 
Greetings Michael.


From proski at gnu.org  Sat Feb 17 17:44:36 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 11:44:36 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171402.24593.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv> <1171699574.32411.6.camel@dv>
	<200702171402.24593.mb@bu3sch.de>
Message-ID: <20070217114436.jhcgs4soo4sgo8sk@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> On Saturday 17 February 2007 09:06, Pavel Roskin wrote:
> > I'm still getting "bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type
> > 0, Revision 7)" from bcm43xx_d80211 for a card that used to work.  That
> > must be a separate problem.
>
> More info about your device, please.

It's the same PCIe module with PCI ID 14e4:4312.

# lspci -v -s 0c:00.0
0c:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
        Subsystem: Dell Unknown device 0007
        Flags: bus master, fast devsel, latency 0, IRQ 17
        Memory at efdfc000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0
Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel

As it turns out, I'm getting the same problems with your (mb) branch, which
doesn't have the latest wireless-dev.git changes yet.

That's loading the device and bringing it up:

ACPI: PCI Interrupt 0000:0c:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:0c:00.0 to 64
ssb: Sonics Silicon Backplane found on PCI device 0000:0c:00.0
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to PCI-E core, index 3
bcm43xx_d80211: Broadcom 4311 WLAN found
ssb: Switching to IEEE 802.11 core, index 1
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_d80211: Adding Interface type 2
bcm43xx_d80211: Found PHY: Analog 4, Type 2, Revision 8
bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
ssb: Switching to PCI-E core, index 3
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Loading firmware version 371.1122 (2006-11-08 22:02:13)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Radio turned on
bcm43xx_d80211: Radio enabled by hardware
bcm43xx_d80211: Chip initialized
bcm43xx_d80211: 32-bit DMA initialized
bcm43xx_d80211: Wireless interface started
wmaster0: Does not support passive scan, disabled
bcm43xx_d80211: Using hardware based encryption for keyidx: 0, mac:
ff:ff:ff:ff:ff:ff

Then I do scanning.  I didn't need to bring the interface down, but it's
possible that some userspace utility tried to do it:

wlan0: starting scan
bcm43xx_d80211: Reconfiguring PHYmode to A-PHY
bcm43xx_d80211: Wireless interface stopped
bcm43xx_d80211: DMA-32 0x0200 (RX) max used slots: 2/64
bcm43xx_d80211: DMA-32 0x02A0 (TX) max used slots: 0/128
bcm43xx_d80211: DMA-32 0x0280 (TX) max used slots: 0/128
bcm43xx_d80211: DMA-32 0x0260 (TX) max used slots: 0/128
bcm43xx_d80211: DMA-32 0x0240 (TX) max used slots: 0/128
bcm43xx_d80211: DMA-32 0x0220 (TX) max used slots: 0/128
bcm43xx_d80211: DMA-32 0x0200 (TX) max used slots: 0/128
bcm43xx_d80211: Radio turned off
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type 0, Revision 7)
bcm43xx_d80211: Fatal: Could not initialize device for new selected A-PHY mode
wlan0: failed to set channel 36 (5180 MHz) for scan
bcm43xx_d80211: Reconfiguring PHYmode to G-PHY
bcm43xx_d80211: Reconfiguring PHYmode to A-PHY
wlan0: scan completed
bcm43xx_d80211: Removing Interface type 2
bcm43xx_d80211: Radio turned off
ssb: Switching to ChipCommon core, index 0
slab error in verify_redzone_free(): cache `size-64': double free detected

Call Trace:
 [<ffffffff8027c761>] __slab_error+0x21/0x30
 [<ffffffff8027cfc8>] cache_free_debugcheck+0xf8/0x220
 [<ffffffff8802f1cd>] :bcm43xx_d80211:bcm43xx_wireless_core_exit+0x3d/0x90
 [<ffffffff8027d2d0>] kfree+0xb0/0x120
 [<ffffffff8802f1cd>] :bcm43xx_d80211:bcm43xx_wireless_core_exit+0x3d/0x90
 [<ffffffff8802f89b>] :bcm43xx_d80211:bcm43xx_remove_interface+0xfb/0x140
 [<ffffffff880057fa>] :80211:ieee80211_stop+0xfa/0x120
 [<ffffffff80463032>] dev_close+0x62/0x90
 [<ffffffff8046246d>] dev_change_flags+0x6d/0x150
 [<ffffffff8049f022>] devinet_ioctl+0x2f2/0x710
 [<ffffffff80464276>] dev_ioctl+0x3f6/0x440
 [<ffffffff80248cd5>] __lock_acquire+0xd35/0xdd0
 [<ffffffff8049f71c>] inet_ioctl+0x4c/0x80
 [<ffffffff804573a0>] sock_ioctl+0x210/0x240
 [<ffffffff804bb9db>] _spin_unlock_irq+0x2b/0x40
 [<ffffffff8028e68b>] do_ioctl+0x1b/0x60
 [<ffffffff8028e931>] vfs_ioctl+0x261/0x280
 [<ffffffff8028e99a>] sys_ioctl+0x4a/0x80
 [<ffffffff80209b6e>] system_call+0x7e/0x83

ffff81000763e240: redzone 1:0x5a2cf071, redzone 2:0x5a2cf071.
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Adding Interface type 2
bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type 0, Revision 7)

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Sat Feb 17 17:55:35 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 17:55:35 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <20070217114436.jhcgs4soo4sgo8sk@webmail.spamcop.net>
References: <1171690868.31103.17.camel@dv> <200702171402.24593.mb@bu3sch.de>
	<20070217114436.jhcgs4soo4sgo8sk@webmail.spamcop.net>
Message-ID: <200702171755.36291.mb@bu3sch.de>

On Saturday 17 February 2007 17:44, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > On Saturday 17 February 2007 09:06, Pavel Roskin wrote:
> > > I'm still getting "bcm43xx_d80211: FOUND UNSUPPORTED PHY (Analog 4, Type
> > > 0, Revision 7)" from bcm43xx_d80211 for a card that used to work.  That
> > > must be a separate problem.
> >
> > More info about your device, please.
> 
> It's the same PCIe module with PCI ID 14e4:4312.
> 
> # lspci -v -s 0c:00.0
> 0c:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
>         Subsystem: Dell Unknown device 0007
>         Flags: bus master, fast devsel, latency 0, IRQ 17
>         Memory at efdfc000 (32-bit, non-prefetchable) [size=16K]
>         Capabilities: [40] Power Management version 2
>         Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0
> Enable-
>         Capabilities: [d0] Express Legacy Endpoint IRQ 0
>         Capabilities: [100] Advanced Error Reporting
>         Capabilities: [13c] Virtual Channel
> 
> As it turns out, I'm getting the same problems with your (mb) branch, which
> doesn't have the latest wireless-dev.git changes yet.
> 
> That's loading the device and bringing it up:
> 
> ACPI: PCI Interrupt 0000:0c:00.0[A] -> GSI 17 (level, low) -> IRQ 17
> PCI: Setting latency timer of device 0000:0c:00.0 to 64
> ssb: Sonics Silicon Backplane found on PCI device 0000:0c:00.0
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x11, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x0A, vendor 0x4243)
> ssb: Core 2 found: USB 1.1 Host (cc 0x817, rev 0x03, vendor 0x4243)
> ssb: Core 3 found: PCI-E (cc 0x820, rev 0x01, vendor 0x4243)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to PCI-E core, index 3
> bcm43xx_d80211: Broadcom 4311 WLAN found
> ssb: Switching to IEEE 802.11 core, index 1
> wmaster0: Selected rate control algorithm 'simple'
> bcm43xx_d80211: Adding Interface type 2
> bcm43xx_d80211: Found PHY: Analog 4, Type 2, Revision 8
> bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> ssb: Switching to PCI-E core, index 3
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_d80211: Loading firmware version 371.1122 (2006-11-08 22:02:13)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_d80211: Radio turned on
> bcm43xx_d80211: Radio enabled by hardware
> bcm43xx_d80211: Chip initialized
> bcm43xx_d80211: 32-bit DMA initialized
> bcm43xx_d80211: Wireless interface started
> wmaster0: Does not support passive scan, disabled
> bcm43xx_d80211: Using hardware based encryption for keyidx: 0, mac:
> ff:ff:ff:ff:ff:ff
> 
> Then I do scanning.  I didn't need to bring the interface down, but it's
> possible that some userspace utility tried to do it:
> 
> wlan0: starting scan
> bcm43xx_d80211: Reconfiguring PHYmode to A-PHY

Oh, heh. Well. Does your device have an A-PHY?
If not, it's related to a bug I am fixing at the moment. ;)


-- 
Greetings Michael.


From stefano.brivio at polimi.it  Sat Feb 17 18:24:44 2007
From: stefano.brivio at polimi.it (Stefano Brivio)
Date: Sat, 17 Feb 2007 18:24:44 +0100
Subject: [PATCH] bcm43xx: fix for 4309
Message-ID: <20070217182444.5a7e3641@localhost>

BCM4309 devices aren't working properly as A PHYs aren't supported yet, but
we probe 802.11a cores anyway. This fixes it, while still allowing for A PHY code
to be developed in the future.

Signed-off-by: Stefano Brivio <stefano.brivio at polimi.it>
----

John,

This is actually a bugfix so I think it should make into 2.6.21. This makes
BCM4309 cards working.

-- 
Ciao
Stefano

----

--- linux-2.6.20/drivers/net/wireless/bcm43xx/bcm43xx_main.c.orig	2007-02-17 18:05:21.872891550 +0100
+++ linux-2.6.20/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-17 18:14:59.620752491 +0100
@@ -2741,8 +2741,9 @@
 				 * dangling pins on the second core. Be careful
 				 * and ignore these cores here.
 				 */
-				if (bcm->pci_dev->device != 0x4324) {
-					dprintk(KERN_INFO PFX "Ignoring additional 802.11 core.\n");
+				if (1 /*bcm->pci_dev->device != 0x4324*/ ) {
+				/* TODO: A PHY */
+					dprintk(KERN_INFO PFX "Ignoring additional 802.11a core.\n");
 					continue;
 				}
 			}


From mb at bu3sch.de  Sat Feb 17 18:30:37 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 18:30:37 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171755.36291.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv>
	<20070217114436.jhcgs4soo4sgo8sk@webmail.spamcop.net>
	<200702171755.36291.mb@bu3sch.de>
Message-ID: <200702171830.38104.mb@bu3sch.de>

On Saturday 17 February 2007 17:55, Michael Buesch wrote:
> > wlan0: starting scan
> > bcm43xx_d80211: Reconfiguring PHYmode to A-PHY
> 
> Oh, heh. Well. Does your device have an A-PHY?
> If not, it's related to a bug I am fixing at the moment. ;)

Well, anyway, this should be fixed in my tree now by
ignoring A-PHYs, as we don't support them, yet.

The slab error on the end of your dmesg is interresting, though.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sat Feb 17 18:46:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 17 Feb 2007 11:46:25 -0600
Subject: [PATCH] bcm43xx: fix for 4309
In-Reply-To: <20070217182444.5a7e3641@localhost>
References: <20070217182444.5a7e3641@localhost>
Message-ID: <45D73F71.6050803@lwfinger.net>

Stefano Brivio wrote:
> BCM4309 devices aren't working properly as A PHYs aren't supported yet, but
> we probe 802.11a cores anyway. This fixes it, while still allowing for A PHY code
> to be developed in the future.
> 
> Signed-off-by: Stefano Brivio <stefano.brivio at polimi.it>
Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
> ----
> 
> John,
> 
> This is actually a bugfix so I think it should make into 2.6.21. This makes
> BCM4309 cards working.
> 

--- linux-2.6.20/drivers/net/wireless/bcm43xx/bcm43xx_main.c.orig	2007-02-17 18:05:21.872891550 +0100
+++ linux-2.6.20/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-02-17 18:14:59.620752491 +0100
@@ -2741,8 +2741,9 @@
 				 * dangling pins on the second core. Be careful
 				 * and ignore these cores here.
 				 */
-				if (bcm->pci_dev->device != 0x4324) {
-					dprintk(KERN_INFO PFX "Ignoring additional 802.11 core.\n");
+				if (1 /*bcm->pci_dev->device != 0x4324*/ ) {
+				/* TODO: A PHY */
+					dprintk(KERN_INFO PFX "Ignoring additional 802.11a core.\n");
 					continue;
 				}
 			}
_______________________________________________


From proski at gnu.org  Sat Feb 17 18:51:27 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 12:51:27 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171830.38104.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv>
	<20070217114436.jhcgs4soo4sgo8sk@webmail.spamcop.net>
	<200702171755.36291.mb@bu3sch.de> <200702171830.38104.mb@bu3sch.de>
Message-ID: <20070217125127.hfrlkwkgo884sos8@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> On Saturday 17 February 2007 17:55, Michael Buesch wrote:
> > > wlan0: starting scan
> > > bcm43xx_d80211: Reconfiguring PHYmode to A-PHY
> >
> > Oh, heh. Well. Does your device have an A-PHY?
> > If not, it's related to a bug I am fixing at the moment. ;)
>
> Well, anyway, this should be fixed in my tree now by
> ignoring A-PHYs, as we don't support them, yet.

Actually, my card supports 802.11a.  The card is marked as 1490, and Dell
advertises such cards as 802.11a/b/g.

But it would be fine if it supports 802.11b/g for now.

> The slab error on the end of your dmesg is interresting, though.

I'll have a closer look.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Sat Feb 17 18:56:07 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 18:56:07 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <20070217125127.hfrlkwkgo884sos8@webmail.spamcop.net>
References: <1171690868.31103.17.camel@dv> <200702171830.38104.mb@bu3sch.de>
	<20070217125127.hfrlkwkgo884sos8@webmail.spamcop.net>
Message-ID: <200702171856.08068.mb@bu3sch.de>

On Saturday 17 February 2007 18:51, Pavel Roskin wrote:
> > The slab error on the end of your dmesg is interresting, though.
> 
> I'll have a closer look.

I think that's fixed now, too.

-- 
Greetings Michael.


From proski at gnu.org  Sat Feb 17 19:10:45 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 13:10:45 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171856.08068.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv> <200702171830.38104.mb@bu3sch.de>
	<20070217125127.hfrlkwkgo884sos8@webmail.spamcop.net>
	<200702171856.08068.mb@bu3sch.de>
Message-ID: <20070217131045.tsmois8g0og8okc4@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> On Saturday 17 February 2007 18:51, Pavel Roskin wrote:
> > > The slab error on the end of your dmesg is interresting, though.
> >
> > I'll have a closer look.
>
> I think that's fixed now, too.

Awesome!  I'm waiting for your public repository to update so I can test your
fixes.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Sat Feb 17 19:14:06 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 19:14:06 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <20070217131045.tsmois8g0og8okc4@webmail.spamcop.net>
References: <1171690868.31103.17.camel@dv> <200702171856.08068.mb@bu3sch.de>
	<20070217131045.tsmois8g0og8okc4@webmail.spamcop.net>
Message-ID: <200702171914.06802.mb@bu3sch.de>

On Saturday 17 February 2007 19:10, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > On Saturday 17 February 2007 18:51, Pavel Roskin wrote:
> > > > The slab error on the end of your dmesg is interresting, though.
> > >
> > > I'll have a closer look.
> >
> > I think that's fixed now, too.
> 
> Awesome!  I'm waiting for your public repository to update so I can test your
> fixes.

I always update that when committing stuff, directly.
So when you see mail from me "I committed foo", it means it's
available in the public repository.

-- 
Greetings Michael.


From proski at gnu.org  Sat Feb 17 19:26:14 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 13:26:14 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171914.06802.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv> <200702171856.08068.mb@bu3sch.de>
	<20070217131045.tsmois8g0og8okc4@webmail.spamcop.net>
	<200702171914.06802.mb@bu3sch.de>
Message-ID: <20070217132614.zfbt6sckkogosss8@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> On Saturday 17 February 2007 19:10, Pavel Roskin wrote:
> > Awesome!  I'm waiting for your public repository to update so I can test
> your
> > fixes.
>
> I always update that when committing stuff, directly.
> So when you see mail from me "I committed foo", it means it's
> available in the public repository.

Then you are not running git-update-server-info every time from
hooks/post-update.  It needs to be run every time any of the branch heads
changes, i.e. on every git-push.  The git documentation was unclear about it
until recently.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Sat Feb 17 19:30:10 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 17 Feb 2007 19:30:10 +0100
Subject: More breakage in wireless-dev.git
In-Reply-To: <20070217132614.zfbt6sckkogosss8@webmail.spamcop.net>
References: <1171690868.31103.17.camel@dv> <200702171914.06802.mb@bu3sch.de>
	<20070217132614.zfbt6sckkogosss8@webmail.spamcop.net>
Message-ID: <200702171930.10830.mb@bu3sch.de>

On Saturday 17 February 2007 19:26, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > On Saturday 17 February 2007 19:10, Pavel Roskin wrote:
> > > Awesome!  I'm waiting for your public repository to update so I can test
> > your
> > > fixes.
> >
> > I always update that when committing stuff, directly.
> > So when you see mail from me "I committed foo", it means it's
> > available in the public repository.
> 
> Then you are not running git-update-server-info every time from
> hooks/post-update.  It needs to be run every time any of the branch heads
> changes, i.e. on every git-push.  The git documentation was unclear about it
> until recently.

Uh, why? I thought it is just an optimization and
git walks the tree, if the server info is not updated.

But I ran it manually now.

-- 
Greetings Michael.


From proski at gnu.org  Sat Feb 17 19:58:05 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 17 Feb 2007 13:58:05 -0500
Subject: More breakage in wireless-dev.git
In-Reply-To: <200702171930.10830.mb@bu3sch.de>
References: <1171690868.31103.17.camel@dv> <200702171914.06802.mb@bu3sch.de>
	<20070217132614.zfbt6sckkogosss8@webmail.spamcop.net>
	<200702171930.10830.mb@bu3sch.de>
Message-ID: <20070217135805.zfkg8kokc4s4owgg@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> Uh, why? I thought it is just an optimization and
> git walks the tree, if the server info is not updated.
>
> But I ran it manually now.

The driver is working now!

As for git, I think all you need to make hooks/post-update executable, since it
already has the right command in it.

The problem is that git-fetch trusts refs/info instead of making individual
requests to refs/branches/*.  Git needs to request refs/info anyway because it
never relies on the ability to request and parse http directory listings.  And
since refs/info already has the branch heads, why request more files?

I know, this sounds weird.  It must be caused by the git developers' attitude
towards http as a dumb protocol.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Mon Feb 19 19:46:52 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 19 Feb 2007 19:46:52 +0100
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
Message-ID: <200702191946.52440.mb@bu3sch.de>

I just want to mention that Ad-Hoc works fine
with the bcm43xx-d80211 driver in my tree.
I didn't have to do any code changes, but simply try it once. ;)

So, well. As the question has been asked several times
if adhoc is supported, here is the answer: Yes it is.

-- 
Greetings Michael.


From ftoledo at docksud.com.ar  Mon Feb 19 20:53:07 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Mon, 19 Feb 2007 16:53:07 -0300
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191946.52440.mb@bu3sch.de>
References: <200702191946.52440.mb@bu3sch.de>
Message-ID: <200702191653.12472.ftoledo@docksud.com.ar>

El Lunes, 19 de Febrero de 2007 15:46, Michael Buesch escribi?:
> I just want to mention that Ad-Hoc works fine
> with the bcm43xx-d80211 driver in my tree.
> I didn't have to do any code changes, but simply try it once. ;)
>
> So, well. As the question has been asked several times
> if adhoc is supported, here is the answer: Yes it is.
Great Michael!
can you remenber me you git tree url?
i want to begin test my board with the dscape stack
at now, with the 2.6.20 and larry combined patch it works fine 


-- 
Dock Sud BBS
http://www.docksud.com.ar
telnet://bbs.docksud.com.ar
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070219/ae74ae90/attachment.pgp>

From mb at bu3sch.de  Mon Feb 19 21:10:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 19 Feb 2007 21:10:13 +0100
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191653.12472.ftoledo@docksud.com.ar>
References: <200702191946.52440.mb@bu3sch.de>
	<200702191653.12472.ftoledo@docksud.com.ar>
Message-ID: <200702192110.13135.mb@bu3sch.de>

On Monday 19 February 2007 20:53, Fernando Toledo wrote:
> El Lunes, 19 de Febrero de 2007 15:46, Michael Buesch escribi?:
> > I just want to mention that Ad-Hoc works fine
> > with the bcm43xx-d80211 driver in my tree.
> > I didn't have to do any code changes, but simply try it once. ;)
> >
> > So, well. As the question has been asked several times
> > if adhoc is supported, here is the answer: Yes it is.
> Great Michael!
> can you remenber me you git tree url?
> i want to begin test my board with the dscape stack
> at now, with the 2.6.20 and larry combined patch it works fine 

http://bu3sch.de/git/wireless-dev.git/

-- 
Greetings Michael.


From gene.heskett at verizon.net  Mon Feb 19 21:48:14 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Mon, 19 Feb 2007 15:48:14 -0500
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191946.52440.mb@bu3sch.de>
References: <200702191946.52440.mb@bu3sch.de>
Message-ID: <200702191548.14982.gene.heskett@verizon.net>

On Monday 19 February 2007, Michael Buesch wrote:
>I just want to mention that Ad-Hoc works fine
>with the bcm43xx-d80211 driver in my tree.
>I didn't have to do any code changes, but simply try it once. ;)
>
>So, well. As the question has been asked several times
>if adhoc is supported, here is the answer: Yes it is.

Where might I find a decent, plain english, description of these 
various 'modes', Micheal?  I have relatively little experience in 802-11 
stuff and could use a tutorial explaining the lingo.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From johannes at sipsolutions.net  Mon Feb 19 21:50:16 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Mon, 19 Feb 2007 21:50:16 +0100
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191548.14982.gene.heskett@verizon.net>
References: <200702191946.52440.mb@bu3sch.de>
	<200702191548.14982.gene.heskett@verizon.net>
Message-ID: <1171918216.15489.9.camel@johannes.berg>

On Mon, 2007-02-19 at 15:48 -0500, Gene Heskett wrote:
> On Monday 19 February 2007, Michael Buesch wrote:
> >I just want to mention that Ad-Hoc works fine
> >with the bcm43xx-d80211 driver in my tree.
> >I didn't have to do any code changes, but simply try it once. ;)
> >
> >So, well. As the question has been asked several times
> >if adhoc is supported, here is the answer: Yes it is.
> 
> Where might I find a decent, plain english, description of these 
> various 'modes', Micheal?  I have relatively little experience in 802-11 
> stuff and could use a tutorial explaining the lingo.

If anyone writes something please add it to linuxwireless.org too :)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070219/8f022a8b/attachment.pgp>

From larry.finger at lwfinger.net  Mon Feb 19 22:08:46 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 19 Feb 2007 15:08:46 -0600
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191548.14982.gene.heskett@verizon.net>
References: <200702191946.52440.mb@bu3sch.de>
	<200702191548.14982.gene.heskett@verizon.net>
Message-ID: <45DA11DE.4050600@lwfinger.net>

Gene Heskett wrote:
> On Monday 19 February 2007, Michael Buesch wrote:
>> I just want to mention that Ad-Hoc works fine
>> with the bcm43xx-d80211 driver in my tree.
>> I didn't have to do any code changes, but simply try it once. ;)
>>
>> So, well. As the question has been asked several times
>> if adhoc is supported, here is the answer: Yes it is.
> 
> Where might I find a decent, plain english, description of these 
> various 'modes', Micheal?  I have relatively little experience in 802-11 
> stuff and could use a tutorial explaining the lingo.
> 

http://en.wikipedia.org/wiki/Wireless_ad-hoc_network

Larry



From mb at bu3sch.de  Mon Feb 19 22:17:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 19 Feb 2007 22:17:01 +0100
Subject: bcm43xx: Ad-Hoc (IBSS) works fine
In-Reply-To: <200702191548.14982.gene.heskett@verizon.net>
References: <200702191946.52440.mb@bu3sch.de>
	<200702191548.14982.gene.heskett@verizon.net>
Message-ID: <200702192217.01975.mb@bu3sch.de>

On Monday 19 February 2007 21:48, Gene Heskett wrote:
> On Monday 19 February 2007, Michael Buesch wrote:
> >I just want to mention that Ad-Hoc works fine
> >with the bcm43xx-d80211 driver in my tree.
> >I didn't have to do any code changes, but simply try it once. ;)
> >
> >So, well. As the question has been asked several times
> >if adhoc is supported, here is the answer: Yes it is.
> 
> Where might I find a decent, plain english, description of these 
> various 'modes', Micheal?  I have relatively little experience in 802-11 
> stuff and could use a tutorial explaining the lingo.

Here you go:
http://linuxwireless.org/en/users

-- 
Greetings Michael.


From proski at gnu.org  Tue Feb 20 02:31:25 2007
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 19 Feb 2007 20:31:25 -0500
Subject: Capture of unsuccessful ARP exchange
Message-ID: <1171935085.8133.42.camel@dv>

Hello!

As I wrote before, bcm43xx_d80211 connects quickly to an 802.11g AP only
if it doesn't support OFDM modes (bcm43xx_g_ratetable_size changed from
12 to 4).  Actually, association is not a problem, but no data goes
through for several minutes.

I'm attaching a capture file of an unsuccessful APR exchange following
the association.

The AP is current MadWifi, MAC address 00:0F:B5:35:73:D8.  The STA is
current bcm43xx_d80211 from mb branch, PCIe 4312, MAC address
00:19:7D:21:7B:50.  The capture is done by another system running
Wireshark 0.99.5 and current MadWifi in monitor mode.


AP broadcasts a beacon announcing that it supports rates from 1 to
54Mbps.  The flags indicate short preamble, spectrum management and
short slot time.

STA broadcasts an ARP request at 36Mbps.  QoS field requests normal ACK.

STA receives ACK at 24Mbps.

STA broadcasts another ARP request, this time at 1Mbps.  It's a non-QoS
data frame.  However, the flags indicate that it's a frame from DS not
to DS, unlike the previous ARP request that got that part correctly!

AP rends APR reply at 5.5Mbps.  QoS field requests normal ACK, which
never arrives.

AP sends another such frame with retry bit set, followed by 6 more
frames at 1Mbps.  QoS field requests normal ACK, which never arrives.

STA broadcasts an ARP request at 36Mbps.  To-DS is set correctly.  Retry
bit is set.  QoS field requests normal ACK.

STA receives ACK at 24Mbps.

STA broadcasts an ARP request at 24Mbps.  To-DS is set correctly.  Retry
bit is set.  QoS field requests normal ACK.


Following seems wrong to me:

1) STA sends some packets with From-DS instead of To-DS.  I've seen more
than one such packet, and they are always sent at 1Mbps.

2) STA doesn't send ACK to frames specifically requesting it (if I
understand the Wireshark interpretation correctly).

-- 
Regards,
Pavel Roskin
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 80211g-arp
Type: application/octet-stream
Size: 3305 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070219/fd23878d/attachment.obj>

From proski at gnu.org  Tue Feb 20 03:28:03 2007
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 19 Feb 2007 21:28:03 -0500
Subject: Capture of unsuccessful ARP exchange
In-Reply-To: <20070220015851.GE5279@jm.kir.nu>
References: <1171935085.8133.42.camel@dv>  <20070220015851.GE5279@jm.kir.nu>
Message-ID: <1171938483.10139.13.camel@dv>

Hi, Jouni!

Thanks for quick and helpful reply!

On Mon, 2007-02-19 at 17:58 -0800, Jouni Malinen wrote:
> On Mon, Feb 19, 2007 at 08:31:25PM -0500, Pavel Roskin wrote:

> > STA broadcasts another ARP request, this time at 1Mbps.  It's a non-QoS
> > data frame.  However, the flags indicate that it's a frame from DS not
> > to DS, unlike the previous ARP request that got that part correctly!
> 
> This is the same ARP packet being sent out by the AP and this time it is
> actually transmitted to broadcast address (and no ACK, as expected).

That's a relief.  I should pay more attention to the order of addresses,
not just to the contents of the "source" column.

> > AP rends APR reply at 5.5Mbps.  QoS field requests normal ACK, which
> > never arrives.
> > 
> > AP sends another such frame with retry bit set, followed by 6 more
> > frames at 1Mbps.  QoS field requests normal ACK, which never arrives.
> 
> It looks like the client has some problems receiving this frame or
> ACKing it..

My first assumption was that the field QoS confuses it, but looking at
the code, it's more likely a low-level problem.  I'll try to see if the
frame is even seen by the driver.

> > STA broadcasts an ARP request at 36Mbps.  To-DS is set correctly.  Retry
> > bit is set.  QoS field requests normal ACK.
> > 
> > STA receives ACK at 24Mbps.
> 
> This is odd.. This frame is a retry of the first ARP request. In other
> words, it looks like the non-AP STA did not receive the ACK from the AP.
> What's even stranger is that it took so long to retry the frame that the
> AP had enough time to actually send its reply multiple times.. It looks
> like the non-AP STA is just not receiving any frames from the AP at this
> point.

I agree.  The frames are either not received physically or thrown out.
Which makes me wonder why the association happens so quickly.  Perhaps
it's done at lower rates.

When ping finally starts working, all the data is transmitted at 1Mbps.
And the QoS field is still there , so it's not a problem by itself.

> > 2) STA doesn't send ACK to frames specifically requesting it (if I
> > understand the Wireshark interpretation correctly).
> 
> And continues retrying a packet ACK'ed by the AP. In other words, the
> non-AP STA does not seem to be receiving anything here (either data or
> ACK to stop retransmission of its own data frame). And this is not only
> OFDM frames getting lost (all ACKs were using 24 Mbps), but also 1 and
> 5.5 Mbps frames in the case of ARP response..

That's the most interesting part, especially that ARP responses at 1Mbps
are ignored.

It looks like my doubts about the d80211 stack were wrong, and the
solution is deeper in the driver, almost certainly on the receiving
side.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Tue Feb 20 04:54:46 2007
From: proski at gnu.org (Pavel Roskin)
Date: Mon, 19 Feb 2007 22:54:46 -0500
Subject: Kernel bug in bcm43xx-d80211
In-Reply-To: <178298.69840.qm@web50208.mail.yahoo.com>
References: <178298.69840.qm@web50208.mail.yahoo.com>
Message-ID: <20070219225446.bgyosgww88c8wk80@webmail.spamcop.net>

Quoting Alex Davis <alex14641 at yahoo.com>:

> I merged Michael's changes. It doesn't panic anymore, but I still can't
> associate. Here's the
> output from wpa_supplicant 0.4.9:

I'm sorry!  I didn't realize git would be merging two branches.  I did try my
commands, but I didn't notice the message about merging.

If you merge two branches, you are pulling the bugs from wireless.dev into the
bcm43xx branch.

You need to remove the merge by resetting the local branch to the remote branch.
 Please use this command:

git-reset --hard remotes/bcm43xx/master

bcm43xx is the name you used in the git-remote command.  Perhaps we need some
kind of git wrapper to deal with all that complexity of having multiple remotes
in one repository.  I'll ask in the git list.  It doesn't look like an exotic
case anymore.

Once you have reverted the branch, disable CONFIG_CFG80211 in .config - it's not
ready yet.  This would fix the iwconfig output.

As for association timeout, it's probably unrelated, bit it would be helpful if
you recheck it on clean sources.  It's possible wpa_supplicant doesn't get the
AP MAC address properly.

--
Regards,
Pavel Roskin


From johannes at sipsolutions.net  Tue Feb 20 09:23:35 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 20 Feb 2007 09:23:35 +0100
Subject: Capture of unsuccessful ARP exchange
In-Reply-To: <1171938483.10139.13.camel@dv>
References: <1171935085.8133.42.camel@dv>  <20070220015851.GE5279@jm.kir.nu>
	<1171938483.10139.13.camel@dv>
Message-ID: <1171959815.15489.75.camel@johannes.berg>

On Mon, 2007-02-19 at 21:28 -0500, Pavel Roskin wrote:

> My first assumption was that the field QoS confuses it, but looking at
> the code, it's more likely a low-level problem.  

bcm43xx firmware can definitely handle QoS.

> I'll try to see if the
> frame is even seen by the driver.

I would expect you to find that it is not, but just run a monitor
interface in addition.

> I agree.  The frames are either not received physically or thrown out.
> Which makes me wonder why the association happens so quickly.  Perhaps
> it's done at lower rates.

Could you start capturing earlier to confirm this?

> When ping finally starts working, all the data is transmitted at 1Mbps.
> And the QoS field is still there , so it's not a problem by itself.

Didn't you say that you're using mb's tree? You have a 4311 IIRC so I
wouldn't be surprised if there are problems with receive sensitivity
that go away after, say, two minutes (recalibration interval).

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070220/94ef1910/attachment.pgp>

From johannes at sipsolutions.net  Tue Feb 20 09:25:16 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Tue, 20 Feb 2007 09:25:16 +0100
Subject: Kernel bug in bcm43xx-d80211
In-Reply-To: <20070219225446.bgyosgww88c8wk80@webmail.spamcop.net>
References: <178298.69840.qm@web50208.mail.yahoo.com>
	<20070219225446.bgyosgww88c8wk80@webmail.spamcop.net>
Message-ID: <1171959916.15489.78.camel@johannes.berg>

On Mon, 2007-02-19 at 22:54 -0500, Pavel Roskin wrote:

> Once you have reverted the branch, disable CONFIG_CFG80211 in .config - it's not
> ready yet.  This would fix the iwconfig output.

I don't think that's actually true, the iwconfig output typo bug is
present in that part of the code that is always enabled whether you have
CFG80211 or not. You're just assuming that it would fix it because it
did weeks ago ;)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070220/ef18476f/attachment.pgp>

From mb at bu3sch.de  Tue Feb 20 11:04:41 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 20 Feb 2007 11:04:41 +0100
Subject: Capture of unsuccessful ARP exchange
In-Reply-To: <1171959815.15489.75.camel@johannes.berg>
References: <1171935085.8133.42.camel@dv> <1171938483.10139.13.camel@dv>
	<1171959815.15489.75.camel@johannes.berg>
Message-ID: <200702201104.42201.mb@bu3sch.de>

On Tuesday 20 February 2007 09:23, Johannes Berg wrote:
> > When ping finally starts working, all the data is transmitted at 1Mbps.
> > And the QoS field is still there , so it's not a problem by itself.
> 
> Didn't you say that you're using mb's tree? You have a 4311 IIRC so I
> wouldn't be surprised if there are problems with receive sensitivity
> that go away after, say, two minutes (recalibration interval).

My tree has serious transmission problems (TX and I think RX, too).
I'd like to fix that as soon as possible, but I really can't find the
damn bug. It's kind of: I verified the whole PHY code for sanity and
correctness, but still don't see where it is.

Maybe we can workaround that by driving the card at highest
attenuation control values, always. But that would obviously break
regulatory domain laws, so... .
Let's try to find the bug. :)

If someone wants to help searching, please do so. I'm kind of
running out of ideas where to search.
It's some issue with the idle-TSSI measurement in the PHY powercontrol
init code. We almost always get a 0 value there, but we should
get something around 50. That messes up attenuation control, later.
Well, why do we get a 0 there? I have no idea. Must be a bug somewhere
in the code that's run before the idle-TSSI is measured.

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Tue Feb 20 17:32:48 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 20 Feb 2007 10:32:48 -0600
Subject: No subject
Message-ID: <45db22b0.GKNQKWTa5rHqiydN%Larry.Finger@lwfinger.net>

The in-kernel documentation of the bcm43xx driver is out of date.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/Documentation/networking/bcm43xx.txt
===================================================================
--- wireless-2.6.orig/Documentation/networking/bcm43xx.txt
+++ wireless-2.6/Documentation/networking/bcm43xx.txt
@@ -2,35 +2,79 @@
 			BCM43xx Linux Driver Project
 			============================
 
-About this software
--------------------
-
-The goal of this project is to develop a linux driver for Broadcom
-BCM43xx chips, based on the specification at 
-http://bcm-specs.sipsolutions.net/
-
-The project page is http://bcm43xx.berlios.de/
-
-
-Requirements
+Introduction
 ------------
 
-1)	Linux Kernel 2.6.16 or later
-	http://www.kernel.org/
-
-	You may want to configure your kernel with:
-
-	CONFIG_DEBUG_FS (optional):
-		-> Kernel hacking
-		  -> Debug Filesystem
-
-2)	SoftMAC IEEE 802.11 Networking Stack extension and patched ieee80211
-	modules:
-	http://softmac.sipsolutions.net/
-
-3)	Firmware Files
-
-	Please try fwcutter. Fwcutter can extract the firmware from various 
-	binary driver files. It supports driver files from Windows, MacOS and 
-	Linux. You can get fwcutter from http://bcm43xx.berlios.de/.
-	Also, fwcutter comes with a README file for further instructions.
+Many of the wireless devices found in modern notebook computers are based
+on the wireless chips produced by Broadcom. These devices have been a problem
+for Linux users as there is no open-source driver available. In addition,
+Broadcom has not released specifications for the device, and driver availability
+has been limited to the binary-only form used in the GPL versions of AP
+hardware such as the Linksys WRT54G, and the Windows and OS X drivers.
+Before this project began, the only way to use these devices were to use the
+Windows or OS X drivers with either the Linuxant or ndiswrapper modules. There
+is a strong penalty if this method is used as loading the binary-only module
+"taints" the kernel, and no kernel developer will help diagnose any kernel
+problems.
+
+Development
+-----------
+
+This driver has been developed using a clean-room technique that is described
+at http://bcm-specs.sipsolutions.net/ReverseEngineeringProcess. For legal
+reasons, none of the clean-room crew works on the on the Linux driver, and
+none of the Linux developers sees anything but the specifications, which are
+the ultimate product of the reverse-engineering group.
+
+Software
+--------
+
+Since the release of the 2.6.17 kernel, the bcm43xx driver has been distributed
+with the kernel source, and is prebuilt in most, if not all, distributions.
+There is, however, additional software that is required. The firmware used by the
+chip is the intellectual property of Broadcom and they have not given the bcm43xx
+team redistribution rights to this firmware.  Since we cannot legally redistribute
+the firwmare we cannot include it with the driver. Furthermore, it cannot be placed
+in the downloadable archives of any distributing organization; therefore, the user is
+responsible for obtaining the firmware and placing it in the appropriate location
+so that the driver can find it when initializing.
+
+To help with this process, the bcm43xx developers provide a separate program
+named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
+and write the extracted files to the proper location. This program is usually
+provided with the distribution; however, it may be downloaded from
+
+http://developer.berlios.de/project/showfiles.php?group_id=4547
+
+The firmware is available in two versions. V3 firmware is used with the in-kernel
+bcm43xx driver that uses a software MAC layer called SoftMAC, and will have a
+microcode revision of 0x127 or smaller. The V4 firmware is used by an out-of-kernel
+driver employing a variation of the Devicescape MAC layer known as d80211. Once
+bcm43xx-d80211 reaches a satisfactory level of development, it will replace
+bcm43xx-softmac in the kernel as it is much more flexible and powerful.
+
+A source for the latest V3 firmware is
+
+http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
+
+Once this file is downloaded, the command 'bcm43xx-fwcutter -w <dir> <filename>'
+will extract the microcode and write it to directory <dir>. The correct directory
+will depend on your distribution; however, most use '/lib/firmware'. Once this
+step is completed, the bcm3xx driver should load when the system is booted. To see
+any messages relating to the driver, issue the command 'dmesg | grep bcm43xx' from
+a terminal window. If there are any problems, please send that output to
+Bcm43xx-dev at lists.berlios.de.
+
+Although the driver has been in-kernel since 2.6.17, the earliest version is quite
+limited in its capability. Patches that include all features of later versions are
+available for the stable kernel versions from 2.6.18. These will be needed if you
+use a BCM4318, or a PCI Express version (BCM4311 and BCM4312). In addition, if you
+have an early BCM4306 and more than 1 GB RAM, your kernel will need to be patched.
+These patches, which are being updated regularly, are available at
+ftp://lwfinger.dynalias.org/patches. Look for combined_2.6.YY.patch. Of course you
+will need kernel source downloaded from kernel.org, or the source from your
+distribution.
+
+If you build your own kernel, please enable CONFIG_BCM43XX_DEBUG and
+CONFIG_IEEE80211_SOFTMAC_DEBUG. The log information provided is essential for solving
+any problems.


From Larry.Finger at lwfinger.net  Tue Feb 20 17:33:13 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 20 Feb 2007 10:33:13 -0600
Subject: bcm43xx: Update Documentation/bcm43xx.txt
Message-ID: <45db22c9.UMvRraqKhAGR5vmR%Larry.Finger@lwfinger.net>

The in-kernel documentation of the bcm43xx driver is out of date.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/Documentation/networking/bcm43xx.txt
===================================================================
--- wireless-2.6.orig/Documentation/networking/bcm43xx.txt
+++ wireless-2.6/Documentation/networking/bcm43xx.txt
@@ -2,35 +2,79 @@
 			BCM43xx Linux Driver Project
 			============================
 
-About this software
--------------------
-
-The goal of this project is to develop a linux driver for Broadcom
-BCM43xx chips, based on the specification at 
-http://bcm-specs.sipsolutions.net/
-
-The project page is http://bcm43xx.berlios.de/
-
-
-Requirements
+Introduction
 ------------
 
-1)	Linux Kernel 2.6.16 or later
-	http://www.kernel.org/
-
-	You may want to configure your kernel with:
-
-	CONFIG_DEBUG_FS (optional):
-		-> Kernel hacking
-		  -> Debug Filesystem
-
-2)	SoftMAC IEEE 802.11 Networking Stack extension and patched ieee80211
-	modules:
-	http://softmac.sipsolutions.net/
-
-3)	Firmware Files
-
-	Please try fwcutter. Fwcutter can extract the firmware from various 
-	binary driver files. It supports driver files from Windows, MacOS and 
-	Linux. You can get fwcutter from http://bcm43xx.berlios.de/.
-	Also, fwcutter comes with a README file for further instructions.
+Many of the wireless devices found in modern notebook computers are based
+on the wireless chips produced by Broadcom. These devices have been a problem
+for Linux users as there is no open-source driver available. In addition,
+Broadcom has not released specifications for the device, and driver availability
+has been limited to the binary-only form used in the GPL versions of AP
+hardware such as the Linksys WRT54G, and the Windows and OS X drivers.
+Before this project began, the only way to use these devices were to use the
+Windows or OS X drivers with either the Linuxant or ndiswrapper modules. There
+is a strong penalty if this method is used as loading the binary-only module
+"taints" the kernel, and no kernel developer will help diagnose any kernel
+problems.
+
+Development
+-----------
+
+This driver has been developed using a clean-room technique that is described
+at http://bcm-specs.sipsolutions.net/ReverseEngineeringProcess. For legal
+reasons, none of the clean-room crew works on the on the Linux driver, and
+none of the Linux developers sees anything but the specifications, which are
+the ultimate product of the reverse-engineering group.
+
+Software
+--------
+
+Since the release of the 2.6.17 kernel, the bcm43xx driver has been distributed
+with the kernel source, and is prebuilt in most, if not all, distributions.
+There is, however, additional software that is required. The firmware used by the
+chip is the intellectual property of Broadcom and they have not given the bcm43xx
+team redistribution rights to this firmware.  Since we cannot legally redistribute
+the firwmare we cannot include it with the driver. Furthermore, it cannot be placed
+in the downloadable archives of any distributing organization; therefore, the user is
+responsible for obtaining the firmware and placing it in the appropriate location
+so that the driver can find it when initializing.
+
+To help with this process, the bcm43xx developers provide a separate program
+named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
+and write the extracted files to the proper location. This program is usually
+provided with the distribution; however, it may be downloaded from
+
+http://developer.berlios.de/project/showfiles.php?group_id=4547
+
+The firmware is available in two versions. V3 firmware is used with the in-kernel
+bcm43xx driver that uses a software MAC layer called SoftMAC, and will have a
+microcode revision of 0x127 or smaller. The V4 firmware is used by an out-of-kernel
+driver employing a variation of the Devicescape MAC layer known as d80211. Once
+bcm43xx-d80211 reaches a satisfactory level of development, it will replace
+bcm43xx-softmac in the kernel as it is much more flexible and powerful.
+
+A source for the latest V3 firmware is
+
+http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
+
+Once this file is downloaded, the command 'bcm43xx-fwcutter -w <dir> <filename>'
+will extract the microcode and write it to directory <dir>. The correct directory
+will depend on your distribution; however, most use '/lib/firmware'. Once this
+step is completed, the bcm3xx driver should load when the system is booted. To see
+any messages relating to the driver, issue the command 'dmesg | grep bcm43xx' from
+a terminal window. If there are any problems, please send that output to
+Bcm43xx-dev at lists.berlios.de.
+
+Although the driver has been in-kernel since 2.6.17, the earliest version is quite
+limited in its capability. Patches that include all features of later versions are
+available for the stable kernel versions from 2.6.18. These will be needed if you
+use a BCM4318, or a PCI Express version (BCM4311 and BCM4312). In addition, if you
+have an early BCM4306 and more than 1 GB RAM, your kernel will need to be patched.
+These patches, which are being updated regularly, are available at
+ftp://lwfinger.dynalias.org/patches. Look for combined_2.6.YY.patch. Of course you
+will need kernel source downloaded from kernel.org, or the source from your
+distribution.
+
+If you build your own kernel, please enable CONFIG_BCM43XX_DEBUG and
+CONFIG_IEEE80211_SOFTMAC_DEBUG. The log information provided is essential for solving
+any problems.


From schwab at suse.de  Tue Feb 20 17:55:03 2007
From: schwab at suse.de (Andreas Schwab)
Date: Tue, 20 Feb 2007 17:55:03 +0100
Subject: bcm43xx: Update Documentation/bcm43xx.txt
In-Reply-To: <45db22c9.UMvRraqKhAGR5vmR%Larry.Finger@lwfinger.net> (Larry
	Finger's message of "Tue, 20 Feb 2007 10:33:13 -0600")
References: <45db22c9.UMvRraqKhAGR5vmR%Larry.Finger@lwfinger.net>
Message-ID: <je3b50ixaw.fsf@sykes.suse.de>

Larry Finger <Larry.Finger at lwfinger.net> writes:

> The in-kernel documentation of the bcm43xx driver is out of date.

Please avoid lines longer than 80 columns.

Andreas.

-- 
Andreas Schwab, SuSE Labs, schwab at suse.de
SuSE Linux Products GmbH, Maxfeldstra?e 5, 90409 N?rnberg, Germany
PGP key fingerprint = 58CA 54C7 6D53 942B 1756  01D3 44D5 214B 8276 4ED5
"And now for something completely different."


From proski at gnu.org  Wed Feb 21 18:22:15 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 12:22:15 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
Message-ID: <1172078535.17231.9.camel@dv>

Hello!

I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
G3 PowerMac though a MiniPCI to PCI adapter.  I tried the current code
from wireless-dev.git.

The softmac bcm43xx driver would load.  The scanning works, but the
association times out (sorry, I forgot to save the logs).  That's a
802.11g AP that my 4311 card easily associates to with the same driver.

The d80211 driver crashes when I try to bring the interface up:

ssb: Sonics Silicon Backplane found on PCI device 0000:01:04.0
bcm43xx_d80211: Broadcom 4306 WLAN found
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_d80211: Ignoring unconnected 802.11 core
bcm43xx_d80211: Adding Interface type 2
bcm43xx_d80211: Found PHY: Analog 1, Type 2, Revision 1
bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
Machine check in kernel mode.
Caused by (from SRR1=49030): Transfer error ack signal
Oops: Machine check, sig: 7 [#1]

Modules linked in: bcm43xx_d80211 ssb
NIP: F103B1CC LR: F21C8784 CTR: F103B18C
REGS: ef14db90 TRAP: 0200   Not tainted  (2.6.20)
MSR: 00049030 <EE,ME,IR,DR>  CR: 24084422  XER: 20000000
TASK = c0b6f440[9472] 'ifconfig' THREAD: ef14c000
GPR00: 0000FFFF EF14DC40 C0B6F440 DF784000 DF784200 0000042B 302BFE00 000003C5 
GPR08: 00000000 F1024000 F103B04C DF784000 000DDB58 1002ADCC 24004422 00000000 
GPR16: 10128700 100E0000 100A0000 0000017F DD8ECE40 0000017F 00002050 00002050 
GPR24: 00000002 DF784000 00000001 E5B3A810 E5B3A810 E5B3A800 000003FE DF784000 
NIP [F103B1CC] ssb_pci_read16+0x40/0x78 [ssb]
LR [F21C8784] bcm43xx_phy_read+0x84/0x9c [bcm43xx_d80211]
Call Trace:
[EF14DC40] [E5B3A800] 0xe5b3a800 (unreliable)
[EF14DC50] [F21C8784] bcm43xx_phy_read+0x84/0x9c [bcm43xx_d80211]
[EF14DC60] [F21D0F14] bcm43xx_phy_initb5+0x104/0x518 [bcm43xx_d80211]
[EF14DC80] [F21D1C60] bcm43xx_phy_initg+0x938/0xd64 [bcm43xx_d80211]
[EF14DD00] [F21D2118] bcm43xx_phy_early_init+0x8c/0x194 [bcm43xx_d80211]
[EF14DD20] [F21C45B0] bcm43xx_wireless_core_init+0x314/0xb18 [bcm43xx_d80211]
[EF14DD80] [F21C6364] bcm43xx_add_interface+0xd0/0x130 [bcm43xx_d80211]
[EF14DDA0] [C023965C] ieee80211_open+0x174/0x408
[EF14DDF0] [C01E0A54] dev_open+0x78/0xcc
[EF14DE10] [C01DEBB8] dev_change_flags+0x13c/0x168
[EF14DE30] [C021EA10] devinet_ioctl+0x5bc/0x71c
[EF14DEA0] [C021F0C8] inet_ioctl+0xb0/0xdc
[EF14DEB0] [C01D30E4] sock_ioctl+0xd4/0x26c
[EF14DED0] [C0083510] do_ioctl+0x38/0x84
[EF14DEE0] [C00835E0] vfs_ioctl+0x84/0x3d8
[EF14DF10] [C0083974] sys_ioctl+0x40/0x74
[EF14DF40] [C000F584] ret_from_syscall+0x0/0x38
--- Exception: c01 at 0xff22ec8
    LR = 0xff22e60
Instruction dump:
7c9e2378 7c641b78 90010014 83e30150 801f0008 7fe3fb78 7f804800 409e0034 
813f0000 7c09f214 7c0004ac 7c00062c <0c000000> 4c00012c 5403043e 80010014 
 

My question is whether it would be useful to investigate those problems
or I'm hitting known bugs.  I think I'll try the mb branch as well.  And
I'll try the card in a x86 system.  In the meantime, I want to share
what I have.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Wed Feb 21 18:29:03 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 Feb 2007 18:29:03 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172078535.17231.9.camel@dv>
References: <1172078535.17231.9.camel@dv>
Message-ID: <200702211829.03416.mb@bu3sch.de>

On Wednesday 21 February 2007 18:22, Pavel Roskin wrote:
> Hello!
> 
> I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
> G3 PowerMac though a MiniPCI to PCI adapter.  I tried the current code
> from wireless-dev.git.
> 
> The softmac bcm43xx driver would load.  The scanning works, but the
> association times out (sorry, I forgot to save the logs).  That's a
> 802.11g AP that my 4311 card easily associates to with the same driver.
> 
> The d80211 driver crashes when I try to bring the interface up:
> 
> ssb: Sonics Silicon Backplane found on PCI device 0000:01:04.0
> bcm43xx_d80211: Broadcom 4306 WLAN found
> wmaster0: Selected rate control algorithm 'simple'
> bcm43xx_d80211: Ignoring unconnected 802.11 core
> bcm43xx_d80211: Adding Interface type 2
> bcm43xx_d80211: Found PHY: Analog 1, Type 2, Revision 1
> bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> Machine check in kernel mode.
> Caused by (from SRR1=49030): Transfer error ack signal
> Oops: Machine check, sig: 7 [#1]
> 
> Modules linked in: bcm43xx_d80211 ssb
> NIP: F103B1CC LR: F21C8784 CTR: F103B18C
> REGS: ef14db90 TRAP: 0200   Not tainted  (2.6.20)
> MSR: 00049030 <EE,ME,IR,DR>  CR: 24084422  XER: 20000000
> TASK = c0b6f440[9472] 'ifconfig' THREAD: ef14c000
> GPR00: 0000FFFF EF14DC40 C0B6F440 DF784000 DF784200 0000042B 302BFE00 000003C5 
> GPR08: 00000000 F1024000 F103B04C DF784000 000DDB58 1002ADCC 24004422 00000000 
> GPR16: 10128700 100E0000 100A0000 0000017F DD8ECE40 0000017F 00002050 00002050 
> GPR24: 00000002 DF784000 00000001 E5B3A810 E5B3A810 E5B3A800 000003FE DF784000 
> NIP [F103B1CC] ssb_pci_read16+0x40/0x78 [ssb]
> LR [F21C8784] bcm43xx_phy_read+0x84/0x9c [bcm43xx_d80211]
> Call Trace:
> [EF14DC40] [E5B3A800] 0xe5b3a800 (unreliable)
> [EF14DC50] [F21C8784] bcm43xx_phy_read+0x84/0x9c [bcm43xx_d80211]
> [EF14DC60] [F21D0F14] bcm43xx_phy_initb5+0x104/0x518 [bcm43xx_d80211]
> [EF14DC80] [F21D1C60] bcm43xx_phy_initg+0x938/0xd64 [bcm43xx_d80211]
> [EF14DD00] [F21D2118] bcm43xx_phy_early_init+0x8c/0x194 [bcm43xx_d80211]
> [EF14DD20] [F21C45B0] bcm43xx_wireless_core_init+0x314/0xb18 [bcm43xx_d80211]
> [EF14DD80] [F21C6364] bcm43xx_add_interface+0xd0/0x130 [bcm43xx_d80211]
> [EF14DDA0] [C023965C] ieee80211_open+0x174/0x408
> [EF14DDF0] [C01E0A54] dev_open+0x78/0xcc
> [EF14DE10] [C01DEBB8] dev_change_flags+0x13c/0x168
> [EF14DE30] [C021EA10] devinet_ioctl+0x5bc/0x71c
> [EF14DEA0] [C021F0C8] inet_ioctl+0xb0/0xdc
> [EF14DEB0] [C01D30E4] sock_ioctl+0xd4/0x26c
> [EF14DED0] [C0083510] do_ioctl+0x38/0x84
> [EF14DEE0] [C00835E0] vfs_ioctl+0x84/0x3d8
> [EF14DF10] [C0083974] sys_ioctl+0x40/0x74
> [EF14DF40] [C000F584] ret_from_syscall+0x0/0x38
> --- Exception: c01 at 0xff22ec8
>     LR = 0xff22e60
> Instruction dump:
> 7c9e2378 7c641b78 90010014 83e30150 801f0008 7fe3fb78 7f804800 409e0034 
> 813f0000 7c09f214 7c0004ac 7c00062c <0c000000> 4c00012c 5403043e 80010014 
>  
> 
> My question is whether it would be useful to investigate those problems
> or I'm hitting known bugs.  I think I'll try the mb branch as well.  And
> I'll try the card in a x86 system.  In the meantime, I want to share
> what I have.


Interresting oops.
I don't see that on my 4306 with PHY: Analog2, type2, rev2.
If must be caused by one of the lines in the if (analog==1)
in bcm43xx_phy_initb5. Can you check which one triggers?
Can you also enable SSB debugging?
Can you try with my tree?

-- 
Greetings Michael.


From proski at gnu.org  Wed Feb 21 18:54:39 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 12:54:39 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702211829.03416.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv>  <200702211829.03416.mb@bu3sch.de>
Message-ID: <1172080479.17618.15.camel@dv>

On Wed, 2007-02-21 at 18:29 +0100, Michael Buesch wrote:
> Interresting oops.
> I don't see that on my 4306 with PHY: Analog2, type2, rev2.
> If must be caused by one of the lines in the if (analog==1)
> in bcm43xx_phy_initb5. Can you check which one triggers?
> Can you also enable SSB debugging?
> Can you try with my tree?

Thanks for suggestions.  I'll try it tonight.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Wed Feb 21 19:51:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 Feb 2007 19:51:42 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172078535.17231.9.camel@dv>
References: <1172078535.17231.9.camel@dv>
Message-ID: <200702211951.43096.mb@bu3sch.de>

On Wednesday 21 February 2007 18:22, Pavel Roskin wrote:
> Hello!
> 
> I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White

Questions came up on IRC if this really is a 4306.
I think it's a 4309. The 4306 also reports 4306 as chipid.
Help us to find out by providing lspci ;)

(Not that it really matters in this oops issue)

-- 
Greetings Michael.


From mb at bu3sch.de  Wed Feb 21 19:53:02 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 Feb 2007 19:53:02 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702211951.43096.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv> <200702211951.43096.mb@bu3sch.de>
Message-ID: <200702211953.02555.mb@bu3sch.de>

On Wednesday 21 February 2007 19:51, Michael Buesch wrote:
> On Wednesday 21 February 2007 18:22, Pavel Roskin wrote:
> > Hello!
> > 
> > I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
> 
> Questions came up on IRC if this really is a 4306.
> I think it's a 4309. The 4306 also reports 4306 as chipid.
                              ^
Yeah, ya know what I mean. ;)

> Help us to find out by providing lspci ;)
> 
> (Not that it really matters in this oops issue)
> 

-- 
Greetings Michael.


From proski at gnu.org  Wed Feb 21 20:31:06 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 14:31:06 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702211951.43096.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv>  <200702211951.43096.mb@bu3sch.de>
Message-ID: <1172086266.17618.35.camel@dv>

On Wed, 2007-02-21 at 19:51 +0100, Michael Buesch wrote:
> On Wednesday 21 February 2007 18:22, Pavel Roskin wrote:
> > Hello!
> > 
> > I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
> 
> Questions came up on IRC if this really is a 4306.
> I think it's a 4309. The 4306 also reports 4306 as chipid.
> Help us to find out by providing lspci ;)
> 
> (Not that it really matters in this oops issue)

I have another card from the same batch, and I'm 99.9% sure it's
equivalent to the one in PowerPC (but I will check).  I put it to an x86
laptop, and it's working much better, although I had with an assertion
failure the first time I tried it.  When trying it for the second time,
scanning was OK, association was OK and ping was working right away.

This is the current mb kernel with bcm43xx_d80211 and ssb debugging on.
First of all, the lspci output:

# lspci -vvvn -s 02:02.0
02:02.0 0280: 14e4:4320 (rev 03)
        Subsystem: 1028:0003
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR-
        Latency: 64
        Interrupt: pin A routed to IRQ 11
        Region 0: Memory at d0200000 (32-bit, non-prefetchable) [size=8K]

# lspci -vvv -s 02:02.0
02:02.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless LAN Controller (rev 03)
        Subsystem: Dell Wireless 1350 WLAN Mini-PCI Card
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR-
        Latency: 64
        Interrupt: pin A routed to IRQ 11
        Region 0: Memory at d0200000 (32-bit, non-prefetchable) [size=8K]

The chip on the card has BCM4306KFB on it.

The kernel messages from module load to ping:

ACPI: PCI Interrupt 0000:02:02.0[A] -> Link [LNKC] -> GSI 11 (level, low) -> IRQ 11
ssb: Sonics Silicon Backplane found on PCI device 0000:02:02.0
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x04, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x05, vendor 0x4243)
ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x02, vendor 0x4243)
ssb: Core 3 found: V90 (cc 0x807, rev 0x02, vendor 0x4243)
ssb: Core 4 found: PCI (cc 0x804, rev 0x09, vendor 0x4243)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to PCI core, index 4
bcm43xx_d80211: Broadcom 4306 WLAN found
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Radio turned off
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_d80211: Adding Interface type 2
bcm43xx_d80211: Found PHY: Analog 2, Type 2, Revision 2
bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
ssb: Switching to PCI core, index 4
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Loading firmware version 371.1122 (2006-11-08 22:02:13)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Radio turned on
bcm43xx_d80211: Radio enabled by hardware
bcm43xx_d80211: Chip initialized
bcm43xx_d80211: 30-bit DMA initialized
bcm43xx_d80211: Wireless interface started
wmaster0: Does not support passive scan, disabled
wlan0: starting scan
wlan0: scan completed
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:11:50:d9:2e:66
wlan0: Initial auth_alg=0
wlan0: authenticate with AP 00:11:50:d9:2e:66
wlan0: RX authentication from 00:11:50:d9:2e:66 (alg=0 transaction=2 status=0)
wlan0: authenticated
wlan0: associate with AP 00:11:50:d9:2e:66
wlan0: authentication frame received from 00:11:50:d9:2e:66, but not in authenticate state - ignored
wlan0: RX AssocResp from 00:11:50:d9:2e:66 (capab=0x421 status=0 aid=1)
wlan0: associated
wlan0: WMM queue=2 aci=0 acm=0 aifs=2 cWmin=7 cWmax=1023 burst=20
wlan0: WMM queue=3 aci=1 acm=0 aifs=7 cWmin=15 cWmax=1023 burst=0
wlan0: WMM queue=1 aci=2 acm=0 aifs=2 cWmin=7 cWmax=15 burst=30
wlan0: WMM queue=0 aci=3 acm=0 aifs=2 cWmin=3 cWmax=7 burst=15

I found the logs from the first try, and the difference is that there is
one extra line between "Radio enabled by hardware" and "Chip
initialized":

bcm43xx_d80211: ASSERTION FAILED (phy->cur_idle_tssi)
at: /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_phy.c:548:bcm43xx_phy_init_pctl()

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Wed Feb 21 20:37:36 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 Feb 2007 20:37:36 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172086266.17618.35.camel@dv>
References: <1172078535.17231.9.camel@dv> <200702211951.43096.mb@bu3sch.de>
	<1172086266.17618.35.camel@dv>
Message-ID: <200702212037.36516.mb@bu3sch.de>

On Wednesday 21 February 2007 20:31, Pavel Roskin wrote:
> On Wed, 2007-02-21 at 19:51 +0100, Michael Buesch wrote:
> > On Wednesday 21 February 2007 18:22, Pavel Roskin wrote:
> > > Hello!
> > > 
> > > I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
> > 
> > Questions came up on IRC if this really is a 4306.
> > I think it's a 4309. The 4306 also reports 4306 as chipid.
> > Help us to find out by providing lspci ;)
> > 
> > (Not that it really matters in this oops issue)
> 
> I have another card from the same batch, and I'm 99.9% sure it's

I don't think it is.
It doesn't print the line:
bcm43xx_d80211: Ignoring unconnected 802.11 core

But that's expected, because this one is a real 4306.

> bcm43xx_d80211: ASSERTION FAILED (phy->cur_idle_tssi)
> at: /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_phy.c:548:bcm43xx_phy_init_pctl()

Yeah, known. Something broken. Dunno what.

-- 
Greetings Michael.


From proski at gnu.org  Wed Feb 21 21:48:56 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 15:48:56 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702212037.36516.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv> <200702211951.43096.mb@bu3sch.de>
	<1172086266.17618.35.camel@dv>  <200702212037.36516.mb@bu3sch.de>
Message-ID: <1172090936.17618.66.camel@dv>

On Wed, 2007-02-21 at 20:37 +0100, Michael Buesch wrote:
> On Wednesday 21 February 2007 20:31, Pavel Roskin wrote:
> > I have another card from the same batch, and I'm 99.9% sure it's
> 
> I don't think it is.
> It doesn't print the line:
> bcm43xx_d80211: Ignoring unconnected 802.11 core

Either I'm incredibly lucky to actually get two different cards, or we
have some interesting PowerPC specific bugs.

> But that's expected, because this one is a real 4306.
> 
> > bcm43xx_d80211: ASSERTION FAILED (phy->cur_idle_tssi)
> > at: /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_phy.c:548:bcm43xx_phy_init_pctl()
> 
> Yeah, known. Something broken. Dunno what.

I see.  It's _the_ Tx problem.  I'll try to research it.

-- 
Regards,
Pavel Roskin



From mb at bu3sch.de  Wed Feb 21 21:59:50 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 21 Feb 2007 21:59:50 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172090936.17618.66.camel@dv>
References: <1172078535.17231.9.camel@dv> <200702212037.36516.mb@bu3sch.de>
	<1172090936.17618.66.camel@dv>
Message-ID: <200702212159.50350.mb@bu3sch.de>

On Wednesday 21 February 2007 21:48, Pavel Roskin wrote:
> On Wed, 2007-02-21 at 20:37 +0100, Michael Buesch wrote:
> > On Wednesday 21 February 2007 20:31, Pavel Roskin wrote:
> > > I have another card from the same batch, and I'm 99.9% sure it's
> > 
> > I don't think it is.
> > It doesn't print the line:
> > bcm43xx_d80211: Ignoring unconnected 802.11 core
> 
> Either I'm incredibly lucky to actually get two different cards, or we
> have some interesting PowerPC specific bugs.
> 
> > But that's expected, because this one is a real 4306.
> > 
> > > bcm43xx_d80211: ASSERTION FAILED (phy->cur_idle_tssi)
> > > at: /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_phy.c:548:bcm43xx_phy_init_pctl()
> > 
> > Yeah, known. Something broken. Dunno what.
> 
> I see.  It's _the_ Tx problem.  I'll try to research it.

No it's something different in addition to that. ;)
Actually, if you get this assertion failure the bug is pretty much hidden
and you won't notice it much (that's why I added it, so you will notice
something is broken). If you don't see this, TXpower will rapidely
go down within a few seconds of operation. Something like,
it starts to work fine, but quickly gets unusable, as TX power gets less
and less.
I always see the assertion failure on my 4306, but I don't see it
most times on my 4318 (With the hard consequences ;) ). I don't know
why there's a difference, yet.

To explain it, if you don't get the assertion failure, it doesn't mean
the cur_idle_tssi value is correct. It can be as low as 2 or 3. Which
is bad, as it should be around 50.

-- 
Greetings Michael.


From proski at gnu.org  Wed Feb 21 23:43:05 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 17:43:05 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702212159.50350.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv> <200702212037.36516.mb@bu3sch.de>
	<1172090936.17618.66.camel@dv>  <200702212159.50350.mb@bu3sch.de>
Message-ID: <1172097785.2894.11.camel@dv>

On Wed, 2007-02-21 at 21:59 +0100, Michael Buesch wrote:

> To explain it, if you don't get the assertion failure, it doesn't mean
> the cur_idle_tssi value is correct. It can be as low as 2 or 3. Which
> is bad, as it should be around 50.

I tried to reload the module to get some statistics.  I'm seeing values
from 5 to 10.  It normally starts with 5 or 6 after reboot, then the
value tends to increase over time until it hits 9 or 10:

802.11bg phy->cur_idle_tssi=5
802.11bg phy->cur_idle_tssi=6
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=6
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=7
802.11bg phy->cur_idle_tssi=6
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=10
802.11bg phy->cur_idle_tssi=9
802.11bg phy->cur_idle_tssi=9

It looks like there are two different names for the same register:
BCM43xx_PHY_G_PCTL and BCM43xx_PHY_ITSSI.  I wonder if there is any
confusion here.

The d80211 driver reads from BCM43xx_PHY_ITSSI and calls the result
cur_idle_tssi.  The softmac driver reads from BCM43xx_PHY_G_PCTL and
calls the result savedpctlreg.

The strangest thing is that savedpctlreg is always 56!  Then I load
bcm43xx_d80211 and get 9 or 10.  Then I load bcm43xx and get 56 again.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Thu Feb 22 00:21:43 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 21 Feb 2007 18:21:43 -0500
Subject: Softmac bcm43xx: assertion failure in bcm43xx_interrupt_handler
Message-ID: <1172100103.2894.19.camel@dv>

Hello!

I'm getting assertion failure in bcm43xx_interrupt_handler() when I
unload bcm43xx without bringing the interface down first.

bcm43xx: ASSERTION FAILED (bcm43xx_status(bcm) ==
BCM43xx_STAT_INITIALIZED)
at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c:1869:bcm43xx_interrupt_handler()

bcm43xx_status(bcm) is always BCM43xx_STAT_SHUTTINGDOWN if the assert is
triggered.  I think the best solution would be to disable interrupts
before BCM43xx_STAT_SHUTTINGDOWN is set.  Another solution would be to
exit from the interrupt handler in this case.

I wish I could implement the first solution, but since the interrupts
are disabled in a loop involving core switches, things are not trivial.

-- 
Regards,
Pavel Roskin



From proski at gnu.org  Thu Feb 22 06:17:41 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 22 Feb 2007 00:17:41 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702212159.50350.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv> <200702212037.36516.mb@bu3sch.de>
	<1172090936.17618.66.camel@dv> <200702212159.50350.mb@bu3sch.de>
Message-ID: <20070222001741.2v9cw4ocwsowkwgg@webmail.spamcop.net>

Hi, Michael!

First of all, phy->cur_idle_tssi is consistently 0 outside the office.  I guess
the radio noise is higher in the office.

The softmac driver seems to have some issues with WEP on both cards.  On the x86
machine, I see messages like

bcm43xx: TODO: Incomplete code in keymac_write() at
/home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c:1132

so I'm assuming the issue is known.  Indeed, keymac_write() doesn't know what to
do with keys for core revision 4 or less.  I'm only surprised that the code is
supposed to handle keys with index 4 and higher, and I'm just trying to set the
default key.  Specifying key [1] suppresses the warning and I get a message that
the card is associated, but the link quality remains 0.  dhclient worked once,
but I cannot ping the AP.

The cards are indeed different.  The output of "lspci -vvvn" is following.  For
the card in the x86 machine (sorry for wrapping, I'm writing in a dumb client):

02:02.0 0280: 14e4:4320 (rev 03)
        Subsystem: 1028:0003
        Control: I/O- Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr-
            Stepping- SERR+ FastB2B-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
            <TAbort- <MAbort- >SERR- <PERR-
        Interrupt: pin A routed to IRQ 11
        Region 0: Memory at d0200000 (32-bit, non-prefetchable) [size=8K]

For the card in PowerPC:

01:04.0 0280: 14e4:4320 (rev 02)
        Subsystem: 1028:0001
        Control: I/O- Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr-
           Stepping- SERR- FastB2B-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
           <TAbort- <MAbort- >SERR- <PERR-
        Interrupt: pin A routed to IRQ 25
        Region 0: Memory at 80888000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: [40] Power Management version 2
                Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=375mA
                    PME(D0+,D1+,D2+,D3hot+,D3cold+)
                Status: D0 PME-Enable- DSel=0 DScale=2 PME-

Although both cards have PCI ID 14e4:4320 and both have a chip marked
BCM4306KFB, they have different revisions and different subsystem ID.

I traced the "Machine check" to reading PHY register 0x42b in
bcm43xx_phy_initb5().  The actual check happens on readw() on an address that
was accessed already, namely BCM43xx_MMIO_PHY_DATA.  I assume the difference is
that something is special about PHY register 0x42b.

I understand it's the same as BCM43xx_PHY_ANTDWELL.  I commented out all
accesses to 0x42b and BCM43xx_PHY_ANTDWELL, but I'm getting machine check
elsewhere.

Perhaps the PowerPC machine could help us find accesses to invalid registers.

I'm pretty much overloaded by all that information, so I'll appreciate if you
suggest what issues are most interesting for you.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Thu Feb 22 14:54:11 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 Feb 2007 14:54:11 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <20070222001741.2v9cw4ocwsowkwgg@webmail.spamcop.net>
References: <1172078535.17231.9.camel@dv> <200702212159.50350.mb@bu3sch.de>
	<20070222001741.2v9cw4ocwsowkwgg@webmail.spamcop.net>
Message-ID: <200702221454.11927.mb@bu3sch.de>

On Thursday 22 February 2007 06:17, Pavel Roskin wrote:
> I traced the "Machine check" to reading PHY register 0x42b in
> bcm43xx_phy_initb5().  The actual check happens on readw() on an address that
> was accessed already, namely BCM43xx_MMIO_PHY_DATA.  I assume the difference is
> that something is special about PHY register 0x42b.

Ehm, not sure what you've done. I don't want to know on
which writew register it crashes, because that _must_ be PHY_DATA.
I want to know which sourcecode line (or which PHY register) triggers
it.

Go to bcm43xx_phy_initb5(), add printks before each line in the
branches I suggested and see which line is executed last.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu Feb 22 14:56:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 Feb 2007 14:56:13 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172097785.2894.11.camel@dv>
References: <1172078535.17231.9.camel@dv> <200702212159.50350.mb@bu3sch.de>
	<1172097785.2894.11.camel@dv>
Message-ID: <200702221456.13700.mb@bu3sch.de>

On Wednesday 21 February 2007 23:43, Pavel Roskin wrote:
> On Wed, 2007-02-21 at 21:59 +0100, Michael Buesch wrote:
> 
> > To explain it, if you don't get the assertion failure, it doesn't mean
> > the cur_idle_tssi value is correct. It can be as low as 2 or 3. Which
> > is bad, as it should be around 50.
> 
> I tried to reload the module to get some statistics.  I'm seeing values
> from 5 to 10.  It normally starts with 5 or 6 after reboot, then the
> value tends to increase over time until it hits 9 or 10:

Yeah, as I said. It's broken. There is no need to trace this. ;)

> It looks like there are two different names for the same register:
> BCM43xx_PHY_G_PCTL and BCM43xx_PHY_ITSSI.  I wonder if there is any
> confusion here.

Yeah, don't worry about obsolete defines.
Forget about itssi. The crash issue is _much_ more important (and
might even get us to the fix for the itssi)

> The strangest thing is that savedpctlreg is always 56!  Then I load
> bcm43xx_d80211 and get 9 or 10.  Then I load bcm43xx and get 56 again.

It's not strange, it's broken.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu Feb 22 14:57:49 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 Feb 2007 14:57:49 +0100
Subject: Softmac bcm43xx: assertion failure in bcm43xx_interrupt_handler
In-Reply-To: <1172100103.2894.19.camel@dv>
References: <1172100103.2894.19.camel@dv>
Message-ID: <200702221457.49373.mb@bu3sch.de>

On Thursday 22 February 2007 00:21, Pavel Roskin wrote:
> Hello!
> 
> I'm getting assertion failure in bcm43xx_interrupt_handler() when I
> unload bcm43xx without bringing the interface down first.
> 
> bcm43xx: ASSERTION FAILED (bcm43xx_status(bcm) ==
> BCM43xx_STAT_INITIALIZED)
> at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c:1869:bcm43xx_interrupt_handler()
> 
> bcm43xx_status(bcm) is always BCM43xx_STAT_SHUTTINGDOWN if the assert is
> triggered.  I think the best solution would be to disable interrupts
> before BCM43xx_STAT_SHUTTINGDOWN is set.  Another solution would be to
> exit from the interrupt handler in this case.

We do this. Find out why it doesn't work, if you want to
do something.
Do you still have this failure with my tree (d80211 driver)?

-- 
Greetings Michael.


From proski at gnu.org  Thu Feb 22 15:56:09 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 22 Feb 2007 09:56:09 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702221454.11927.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv> <200702212159.50350.mb@bu3sch.de>
	<20070222001741.2v9cw4ocwsowkwgg@webmail.spamcop.net>
	<200702221454.11927.mb@bu3sch.de>
Message-ID: <20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>

Quoting Michael Buesch <mb at bu3sch.de>:

> On Thursday 22 February 2007 06:17, Pavel Roskin wrote:
> > I traced the "Machine check" to reading PHY register 0x42b in
> > bcm43xx_phy_initb5().  The actual check happens on readw() on an address
> that
> > was accessed already, namely BCM43xx_MMIO_PHY_DATA.  I assume the
> difference is
> > that something is special about PHY register 0x42b.
>
> Ehm, not sure what you've done. I don't want to know on
> which writew register it crashes, because that _must_ be PHY_DATA.
> I want to know which sourcecode line (or which PHY register) triggers
> it.

I put printk's in many places to be sure, including bcm43xx_phy_initb5().

> Go to bcm43xx_phy_initb5(), add printks before each line in the
> branches I suggested and see which line is executed last.

It's line 1157, the only place in bcm43xx_phy_initb5() that refers to 0x42b.

I also tried to disable access to all registers from 0x400 to 0x800, and then I
got machine check on 0x814.

--
Regards,
Pavel Roskin


From mb at bu3sch.de  Thu Feb 22 17:07:43 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 Feb 2007 17:07:43 +0100
Subject: [PATCH] bcm43xx: Fix for 4311 and 02/07/07 specification changes
In-Reply-To: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
References: <45d241c0.gWJcHxUYgWmBTwx8%Larry.Finger@lwfinger.net>
Message-ID: <200702221707.43730.mb@bu3sch.de>

On Tuesday 13 February 2007 23:54, Larry Finger wrote:
> The specifications for the bcm43xx driver have been modified. This patch
> incorporates these changes in the code, which results in the BCM4311 and
> BCM4312 working. The name of one of the PHY parameters, previously known
> as "version", has been changed to "analog", short for  "analog core version" .
> 
> Signed-off-by: Larry Finger<Larry.Finger at lwfinger.net>
> ---

Sorry for the late review. If this is already applied,
please create a patch on top of it.

> @@ -835,61 +843,24 @@ static void bcm43xx_phy_initb6(struct bc
>  	struct bcm43xx_phyinfo *phy = bcm43xx_current_phy(bcm);
>  	struct bcm43xx_radioinfo *radio = bcm43xx_current_radio(bcm);
>  	u16 offset, val;
> +	u8 old_channel;
>  
>  	bcm43xx_phy_write(bcm, 0x003E, 0x817A);
>  	bcm43xx_radio_write16(bcm, 0x007A,
>  	                      (bcm43xx_radio_read16(bcm, 0x007A) | 0x0058));
> -	if ((radio->manufact == 0x17F) &&
> -	    (radio->version == 0x2050) &&
> -	    (radio->revision == 3 ||
> -	     radio->revision == 4 ||
> -	     radio->revision == 5)) {
> -		bcm43xx_radio_write16(bcm, 0x0051, 0x001F);
> -		bcm43xx_radio_write16(bcm, 0x0052, 0x0040);
> -		bcm43xx_radio_write16(bcm, 0x0053, 0x005B);
> -		bcm43xx_radio_write16(bcm, 0x0054, 0x0098);
> +	if (radio->revision == 4 ||
> +	     radio->revision == 5) {
> +		bcm43xx_radio_write16(bcm, 0x0051, 0x0037);
> +		bcm43xx_radio_write16(bcm, 0x0052, 0x0070);
> +		bcm43xx_radio_write16(bcm, 0x0053, 0x00B3);
> +		bcm43xx_radio_write16(bcm, 0x0054, 0x009B);
>  		bcm43xx_radio_write16(bcm, 0x005A, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x005B, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);

Here should also be a "MicrocodeFlagsBitfield", which is HostFlags, write.

>  	bcm43xx_phy_write(bcm, 0x0038, 0x0668);
>  	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
> -	if (radio->version == 0x2050) {
> -		if (radio->revision == 3 ||
> -		    radio->revision == 4 ||
> -		    radio->revision == 5)
> -			bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);
> -		else if (radio->revision <= 2)
> -			bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
> -	}
> +	if (radio->revision <= 5)
> +		bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);

The above should be
  MaskSet PHYRegister 0x5D with mask 0xFF80 and set with 3


The rest is OK. Thanks for the patch!

-- 
Greetings Michael.


From mb at bu3sch.de  Thu Feb 22 17:14:28 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 22 Feb 2007 17:14:28 +0100
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>
References: <1172078535.17231.9.camel@dv> <200702221454.11927.mb@bu3sch.de>
	<20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>
Message-ID: <200702221714.28319.mb@bu3sch.de>

On Thursday 22 February 2007 15:56, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > On Thursday 22 February 2007 06:17, Pavel Roskin wrote:
> > > I traced the "Machine check" to reading PHY register 0x42b in
> > > bcm43xx_phy_initb5().  The actual check happens on readw() on an address
> > that
> > > was accessed already, namely BCM43xx_MMIO_PHY_DATA.  I assume the
> > difference is
> > > that something is special about PHY register 0x42b.
> >
> > Ehm, not sure what you've done. I don't want to know on
> > which writew register it crashes, because that _must_ be PHY_DATA.
> > I want to know which sourcecode line (or which PHY register) triggers
> > it.
> 
> I put printk's in many places to be sure, including bcm43xx_phy_initb5().
> 
> > Go to bcm43xx_phy_initb5(), add printks before each line in the
> > branches I suggested and see which line is executed last.
> 
> It's line 1157, the only place in bcm43xx_phy_initb5() that refers to 0x42b.

Joe, can you re-check if the specs is correct here?

B5PHY:

5. If this is a G PHY
   1.
      If the RadioID Radio Version is 2050
         1.
            OR RadioRegister 0x7A with 0x20
         2.
            OR RadioRegister 0x51 with 0x4 
   2.
      Write 0 to MMIO offset 0x3E2
   3.
      OR PHYRegister 0x802 with 0x100
   4.
      OR PHYRegister 0x42B with 0x2000  <<<<<<<<<<<<<<<<<<

-- 
Greetings Michael.


From josejx at gentoo.org  Fri Feb 23 01:14:13 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Thu, 22 Feb 2007 19:14:13 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <200702221714.28319.mb@bu3sch.de>
References: <1172078535.17231.9.camel@dv>
	<200702221454.11927.mb@bu3sch.de>	<20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>
	<200702221714.28319.mb@bu3sch.de>
Message-ID: <45DE31D5.8090704@gentoo.org>

> Joe, can you re-check if the specs is correct here?
> 
> B5PHY:
> 
> 5. If this is a G PHY
>    1.
>       If the RadioID Radio Version is 2050
>          1.
>             OR RadioRegister 0x7A with 0x20
>          2.
>             OR RadioRegister 0x51 with 0x4 
>    2.
>       Write 0 to MMIO offset 0x3E2
>    3.
>       OR PHYRegister 0x802 with 0x100
>    4.
>       OR PHYRegister 0x42B with 0x2000  <<<<<<<<<<<<<<<<<<
> 

The spec is correct, but there is a special case that is most likely
causing this.  Basically, there's a few things that we're calling
"If this is a G PHY".  We need to separate them out. :p  Here, this
code isn't executed on his card because it's a Rev1 (See:
http://bcm-v4.sipsolutions.net/802.11/PHY/calinit) and this GPHY
check isn't taken because of the above.

I'll try to clean this mess up this weekend. :p

-Joe



From proski at gnu.org  Fri Feb 23 01:22:36 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 22 Feb 2007 19:22:36 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <45DE31D5.8090704@gentoo.org>
References: <1172078535.17231.9.camel@dv> <200702221454.11927.mb@bu3sch.de>
	<20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>
	<200702221714.28319.mb@bu3sch.de>  <45DE31D5.8090704@gentoo.org>
Message-ID: <1172190156.20817.29.camel@dv>

On Thu, 2007-02-22 at 19:14 -0500, Joseph Jezak wrote:
> The spec is correct, but there is a special case that is most likely
> causing this.  Basically, there's a few things that we're calling
> "If this is a G PHY".  We need to separate them out. :p  Here, this
> code isn't executed on his card because it's a Rev1 (See:
> http://bcm-v4.sipsolutions.net/802.11/PHY/calinit) and this GPHY
> check isn't taken because of the above.
> 
> I'll try to clean this mess up this weekend. :p

The other registers that cause machine check are 0x429 and 0x814.  I'm
quite sure that the list is incomplete.

-- 
Regards,
Pavel Roskin



From josejx at gentoo.org  Fri Feb 23 04:16:01 2007
From: josejx at gentoo.org (Joseph Jezak)
Date: Thu, 22 Feb 2007 22:16:01 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172190156.20817.29.camel@dv>
References: <1172078535.17231.9.camel@dv> <200702221454.11927.mb@bu3sch.de>	
	<20070222095609.t8oin5x4wcwow8so@webmail.spamcop.net>	
	<200702221714.28319.mb@bu3sch.de> <45DE31D5.8090704@gentoo.org>
	<1172190156.20817.29.camel@dv>
Message-ID: <45DE5C71.9020107@gentoo.org>

Pavel Roskin wrote:
> On Thu, 2007-02-22 at 19:14 -0500, Joseph Jezak wrote:
>> The spec is correct, but there is a special case that is most likely
>> causing this.  Basically, there's a few things that we're calling
>> "If this is a G PHY".  We need to separate them out. :p  Here, this
>> code isn't executed on his card because it's a Rev1 (See:
>> http://bcm-v4.sipsolutions.net/802.11/PHY/calinit) and this GPHY
>> check isn't taken because of the above.
>>
>> I'll try to clean this mess up this weekend. :p
> 
> The other registers that cause machine check are 0x429 and 0x814.  I'm
> quite sure that the list is incomplete.
> 

Like I said, it's most likely because there are a few branches of 
code in the GPHY/BPHY init functions that shouldn't be executed on 
PHY Revision 1 that currently are.  I'll make it clear when I fix 
the specs. :p

-Joe


From proski at gnu.org  Sat Feb 24 05:54:36 2007
From: proski at gnu.org (Pavel Roskin)
Date: Fri, 23 Feb 2007 23:54:36 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172292619.3344.4.camel@shinybook.infradead.org>
References: <1172078535.17231.9.camel@dv>
	<1172292619.3344.4.camel@shinybook.infradead.org>
Message-ID: <1172292876.19767.60.camel@dv>

On Fri, 2007-02-23 at 23:50 -0500, David Woodhouse wrote:
> I see something very similar when I use wireless-dev.git (courtesy of
> the latest Fedora rawhide kernel package) on my PowerBook:
> http://david.woodhou.se/bcm43xx-d80211.dmesg

Yes, PowerPC is helpful at finding the places where the driver touches
the absent registers.  I have no idea how it works and whether I can
program a x86 PC to do the same.  It would be helpful since that 300MHz
G3 is annoyingly slow.  Besides, there is no way for me to test a PCIe
card in that PowerPC machine.

-- 
Regards,
Pavel Roskin



From dwmw2 at infradead.org  Sat Feb 24 05:50:19 2007
From: dwmw2 at infradead.org (David Woodhouse)
Date: Fri, 23 Feb 2007 23:50:19 -0500
Subject: 4306 of PowerPC: machine check in ssb_pci_read16
In-Reply-To: <1172078535.17231.9.camel@dv>
References: <1172078535.17231.9.camel@dv>
Message-ID: <1172292619.3344.4.camel@shinybook.infradead.org>

On Wed, 2007-02-21 at 12:22 -0500, Pavel Roskin wrote:
> 
> I've got my hands on a 4306 MiniPCI card, and I put it into a Blue&White
> G3 PowerMac though a MiniPCI to PCI adapter.  I tried the current code
> from wireless-dev.git.
> 
> The softmac bcm43xx driver would load.  The scanning works, but the
> association times out (sorry, I forgot to save the logs).  That's a
> 802.11g AP that my 4311 card easily associates to with the same driver.
> 
> The d80211 driver crashes when I try to bring the interface up:

I see something very similar when I use wireless-dev.git (courtesy of
the latest Fedora rawhide kernel package) on my PowerBook:
http://david.woodhou.se/bcm43xx-d80211.dmesg

I also see a similar crash with the ieee80211 driver:
http://david.woodhou.se/bcm43xx.dmesg

With older kernels (2.6.20-rc4-git4) it works fine:
http://david.woodhou.se/bcm43xx-working.dmesg

-- 
dwmw2



From larry.finger at lwfinger.net  Sun Feb 25 04:49:07 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 24 Feb 2007 21:49:07 -0600
Subject: Softmac bcm43xx: assertion failure in bcm43xx_interrupt_handler
In-Reply-To: <1172100103.2894.19.camel@dv>
References: <1172100103.2894.19.camel@dv>
Message-ID: <45E10733.40601@lwfinger.net>

Pavel Roskin wrote:
> Hello!
> 
> I'm getting assertion failure in bcm43xx_interrupt_handler() when I
> unload bcm43xx without bringing the interface down first.
> 
> bcm43xx: ASSERTION FAILED (bcm43xx_status(bcm) ==
> BCM43xx_STAT_INITIALIZED)
> at: /home/proski/src/linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c:1869:bcm43xx_interrupt_handler()
> 
> bcm43xx_status(bcm) is always BCM43xx_STAT_SHUTTINGDOWN if the assert is
> triggered.  I think the best solution would be to disable interrupts
> before BCM43xx_STAT_SHUTTINGDOWN is set.  Another solution would be to
> exit from the interrupt handler in this case.
> 
> I wish I could implement the first solution, but since the interrupts
> are disabled in a loop involving core switches, things are not trivial.

What kernel, SMP/UP, PREEMPTION option, architecture and patch level of bcm43xx, please? I now use
NetworkManager for connection and authentication, which means that I can no longer issue an ifdown
command before unloading bcm43xx. Despite this, I never see the assertion you mention running either
Linus's tree or wireless-2.6 with a BCM4311 on an SMP system. Why?

Larry


From proski at gnu.org  Sun Feb 25 05:24:18 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 24 Feb 2007 23:24:18 -0500
Subject: Softmac bcm43xx: assertion failure in
	bcm43xx_interrupt_handler
In-Reply-To: <45E10733.40601@lwfinger.net>
References: <1172100103.2894.19.camel@dv> <45E10733.40601@lwfinger.net>
Message-ID: <20070224232418.w0s8goswgc08wos4@webmail.spamcop.net>

Quoting Larry Finger <larry.finger at lwfinger.net>:

> > I wish I could implement the first solution, but since the interrupts
> > are disabled in a loop involving core switches, things are not trivial.
>
> What kernel, SMP/UP, PREEMPTION option, architecture and patch level of
> bcm43xx, please?

I won't see that machine until Monday, but I'm quite sure that the kernel was
from the current master branch of the mb repository (I have no idea how current
the bcm43xx softmac driver is there, but the kernel version was 2.6.20).

It's a UP kernel with no preemption.  NetworkManager is not used.  It's a Fedora
Core 6 install, x86 architecture (Pentium M) with all updates and custom kernel.

The card is a MiniPCI 4306.  I have two revisions, and it was the newer of them
(the older one was mentioned to be in a PowerPC).  I described the cards
recently.  Sorry, I'm away from my list archives, but I hope you will find the
description.

I was checking one of the registers that Michael mentioned as a problem.  It was
0 or a small value on bcm43xx_d80211 and 56 in bcm43xx.

I noticed that unloading bcm43xx_d80211 was fine, but bcm43xx would report
several (10 maybe) assertion failures in a row if unloaded with the interface
up.

I found the assertion and added a printk that indicated that the unexpected
state was always SHUTTINGDOWN.  I looked at the code for turning off the
interrupts, and noticed that it's done several times in a loop after switching
the core.  At this point I realized that the problem was over my head (given my
time constrains), so I wrote the previous e-mail.

Since I now realize that it's not the expected behavior, I'll try to collect
more information about the problem.

--
Regards,
Pavel Roskin


From proski at gnu.org  Sun Feb 25 05:30:01 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sat, 24 Feb 2007 23:30:01 -0500
Subject: Patch to allow specification of interface name prefix
In-Reply-To: <510326.55988.qm@web50211.mail.yahoo.com>
References: <510326.55988.qm@web50211.mail.yahoo.com>
Message-ID: <20070224233001.3ok4k0c00ksos4sw@webmail.spamcop.net>

Quoting Alex Davis <alex14641 at yahoo.com>:

> This patch will allow you to specify the interface name prefix of wireless
> devices.
>
> On my machine, the wireless devices under the bcm43xx driver are named
> 'ethx'; I
> would really rather have them called 'wlanx', like bcm43xx-d80211 does.

You can use ifrename from wireless tools.  Use the option that checks the
ethtool information.

Jean has just released Wireless Tools 29-pre12, which can read symlinks in
sysfs.  That would allow renaming d80211 based network devices by checking the
"driver" symlinks in sysfs.  I asked Jean to do that with bcm43xx_d80211 in
mind.

It's not that I'm against your patch.  I'm rather ambivalent.  But I think using
ifrename could reduce the need in kernel support for interface renaming.

--
Regards,
Pavel Roskin


From larry.finger at lwfinger.net  Sun Feb 25 05:39:19 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 24 Feb 2007 22:39:19 -0600
Subject: Patch to allow specification of interface name prefix
In-Reply-To: <20070224233001.3ok4k0c00ksos4sw@webmail.spamcop.net>
References: <510326.55988.qm@web50211.mail.yahoo.com>
	<20070224233001.3ok4k0c00ksos4sw@webmail.spamcop.net>
Message-ID: <45E112F7.9090908@lwfinger.net>

Pavel Roskin wrote:
> Quoting Alex Davis <alex14641 at yahoo.com>:
> 
>> This patch will allow you to specify the interface name prefix of wireless
>> devices.
>>
>> On my machine, the wireless devices under the bcm43xx driver are named
>> 'ethx'; I
>> would really rather have them called 'wlanx', like bcm43xx-d80211 does.
> 
> You can use ifrename from wireless tools.  Use the option that checks the
> ethtool information.
> 
> Jean has just released Wireless Tools 29-pre12, which can read symlinks in
> sysfs.  That would allow renaming d80211 based network devices by checking the
> "driver" symlinks in sysfs.  I asked Jean to do that with bcm43xx_d80211 in
> mind.
> 
> It's not that I'm against your patch.  I'm rather ambivalent.  But I think using
> ifrename could reduce the need in kernel support for interface renaming.

NACK.

On my system (openSUSE 10.2), one sets the name in /etc/udev/rules.d/30-net_persistent_names.rule. I
feel that interface renaming is handled perfectly well in userland, and kernel support is not needed.

Larry


From larry.finger at lwfinger.net  Sun Feb 25 05:58:56 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 24 Feb 2007 22:58:56 -0600
Subject: Softmac bcm43xx: assertion failure in	bcm43xx_interrupt_handler
In-Reply-To: <20070224232418.w0s8goswgc08wos4@webmail.spamcop.net>
References: <1172100103.2894.19.camel@dv> <45E10733.40601@lwfinger.net>
	<20070224232418.w0s8goswgc08wos4@webmail.spamcop.net>
Message-ID: <45E11790.70705@lwfinger.net>

Pavel Roskin wrote:
> Quoting Larry Finger <larry.finger at lwfinger.net>:
> 
>>> I wish I could implement the first solution, but since the interrupts
>>> are disabled in a loop involving core switches, things are not trivial.
>> What kernel, SMP/UP, PREEMPTION option, architecture and patch level of
>> bcm43xx, please?
> 
> I won't see that machine until Monday, but I'm quite sure that the kernel was
> from the current master branch of the mb repository (I have no idea how current
> the bcm43xx softmac driver is there, but the kernel version was 2.6.20).
> 
> It's a UP kernel with no preemption.  NetworkManager is not used.  It's a Fedora
> Core 6 install, x86 architecture (Pentium M) with all updates and custom kernel.
> 
> The card is a MiniPCI 4306.  I have two revisions, and it was the newer of them
> (the older one was mentioned to be in a PowerPC).  I described the cards
> recently.  Sorry, I'm away from my list archives, but I hope you will find the
> description.
> 
> I was checking one of the registers that Michael mentioned as a problem.  It was
> 0 or a small value on bcm43xx_d80211 and 56 in bcm43xx.
> 
> I noticed that unloading bcm43xx_d80211 was fine, but bcm43xx would report
> several (10 maybe) assertion failures in a row if unloaded with the interface
> up.
> 
> I found the assertion and added a printk that indicated that the unexpected
> state was always SHUTTINGDOWN.  I looked at the code for turning off the
> interrupts, and noticed that it's done several times in a loop after switching
> the core.  At this point I realized that the problem was over my head (given my
> time constrains), so I wrote the previous e-mail.
> 
> Since I now realize that it's not the expected behavior, I'll try to collect
> more information about the problem.

The bcm43xx-softmac version in the mb tree is a little behind wireless-2.6. The attached patch will
bring it up to date with the wireless-2.6 tree with my local modifications.

Larry
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: diffs
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070224/0e744967/attachment.ksh>

From proski at gnu.org  Sun Feb 25 16:50:53 2007
From: proski at gnu.org (Pavel Roskin)
Date: Sun, 25 Feb 2007 10:50:53 -0500
Subject: Softmac bcm43xx: assertion failure in
	bcm43xx_interrupt_handler
In-Reply-To: <45E11790.70705@lwfinger.net>
References: <1172100103.2894.19.camel@dv> <45E10733.40601@lwfinger.net>
	<20070224232418.w0s8goswgc08wos4@webmail.spamcop.net>
	<45E11790.70705@lwfinger.net>
Message-ID: <20070225105053.hmh2ccgso0ggo8gg@webmail.spamcop.net>

Quoting Larry Finger <larry.finger at lwfinger.net>:

> The bcm43xx-softmac version in the mb tree is a little behind wireless-2.6.
> The attached patch will
> bring it up to date with the wireless-2.6 tree with my local modifications.

OK, thanks.  I'll apply it and then I'll write a more coherent bugreport.

--
Regards,
Pavel Roskin


From possmanet at web.de  Mon Feb 26 16:42:16 2007
From: possmanet at web.de (Possma Net)
Date: Mon, 26 Feb 2007 16:42:16 +0100
Subject: new hardware / not listet on [devices] on the HP
Message-ID: <45E2FFD8.6020108@web.de>

Hello my driver heroes! ;-)

I have an IBM/Lenovo T40 Notebook with an BCM 4306 mini-PCI device in
it. This device is not listed on the driver homepage. lspci gives me a
new Subsystem Product ID (0453):

02:02.0 0280: 14e4:4320 (rev 03)
        Subsystem: 14e4:0453
        Flags: bus master, fast devsel, latency 64, IRQ 11
        Memory at c0200000 (32-bit, non-prefetchable) [size=8K]

I don't exactly know who has manufactured this card - lspci tells me
Broadcom (ha ha). As i bought this notebook from an IBM used parts
dealer, i thought maybe this is a card that IBM sells (Yes, they offer
one Broadcom card.). (IBM never sold the T40 together with Broadcom wlan
in it, though - as far as i know. Maybe it has been an upgrade.) Well, i
downloaded a WinXP driver from their homepage at:

http://www-307.ibm.com/pc/support/site.wss/document.do?sitestyle=lenovo&lndocid=MIGR-63550
filename:
http://www-307.ibm.com/pc/support/site.wss/license.do?filename=mobiles/60wb04ww.exe

...and this driver works 100% under WinXP. This driver also works 100%
with ndiswrapper (only suspend worksnt) under my Linux - so i think it's
the right one. BUT:
The fwcutter software complains about unknown MD5sum. (Driver unknown?
Its an bcmwl5.inf type...) see:
modd at pont:~/tmp/bcm$ bcm43xx-fwcutter WLLANBCM/bcmwl5.inf
Sorry, the input file is either wrong or not supported by bcm43xx-fwcutter.
This file has an unknown MD5sum 96b0d9d46dfc7386fb5c0fab3bd103ed.

By the way (info):
bcm43xx freezes my PC on booting Knoppix Live-Linux 5.1.1 :-P (this one
has Linux Kernel 2.6.19(.1))

Greetings, and a lot of respect to Your work!
posmanet


From martin-langer at gmx.de  Mon Feb 26 18:53:19 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Mon, 26 Feb 2007 18:53:19 +0100
Subject: new hardware / not listet on [devices] on the HP
In-Reply-To: <45E2FFD8.6020108@web.de>
References: <45E2FFD8.6020108@web.de>
Message-ID: <20070226175319.GA3400@tuba>

On Mon, Feb 26, 2007 at 04:42:16PM +0100, Possma Net wrote:

> modd at pont:~/tmp/bcm$ bcm43xx-fwcutter WLLANBCM/bcmwl5.inf
> Sorry, the input file is either wrong or not supported by bcm43xx-fwcutter.
> This file has an unknown MD5sum 96b0d9d46dfc7386fb5c0fab3bd103ed.

That's fine. Fwcutter doesn't understand *.inf files. But you can point 
it to your bcmwl5.sys instead. All supported files can be listed with 
"bcm43xx-fwcutter -l".

Martin


From possmanet at web.de  Mon Feb 26 19:06:51 2007
From: possmanet at web.de (Possma Net)
Date: Mon, 26 Feb 2007 19:06:51 +0100
Subject: new hardware / not listet on [devices] on the HP
In-Reply-To: <20070226175319.GA3400@tuba>
References: <45E2FFD8.6020108@web.de> <20070226175319.GA3400@tuba>
Message-ID: <45E321BB.7040502@web.de>

> That's fine. Fwcutter doesn't understand *.inf files. But you can point 
> it to your bcmwl5.sys instead. All supported files can be listed with 
> "bcm43xx-fwcutter -l".

Thanks Martin! That was exactly the point. Maybe i was irritated because
ndiswrapper takes the .inf file. I will try loading the driver with my
own formware data then - and let You know if it works or not.

Greetings


From linville at tuxdriver.com  Tue Feb 27 02:33:20 2007
From: linville at tuxdriver.com (John W. Linville)
Date: Mon, 26 Feb 2007 20:33:20 -0500
Subject: Patch to allow specification of interface name prefix
In-Reply-To: <20070226150241.1b5b63b2@freekitty>
References: <510326.55988.qm@web50211.mail.yahoo.com>
	<20070224233001.3ok4k0c00ksos4sw@webmail.spamcop.net>
	<45E112F7.9090908@lwfinger.net> <20070226150241.1b5b63b2@freekitty>
Message-ID: <20070227013320.GA4476@tuxdriver.com>

On Mon, Feb 26, 2007 at 03:02:41PM -0800, Stephen Hemminger wrote:

> This was hashed out on netdev 2+ years ago and decided that both ethernet
> and wireless devices should show up as 'eth%d'. For inclusion d80211 needs to conform
> to existing mainline kernel practice. If this means breaking the expectation of older
> out of tree wireless support (ie madwifi), sorry.

Any chance you could provide a pointer to that discussion in the archives?

John
-- 
John W. Linville
linville at tuxdriver.com


From joerg at alea.gnuu.de  Tue Feb 27 10:46:07 2007
From: joerg at alea.gnuu.de (=?UTF-8?Q?J=C3=B6rg?= Sommer)
Date: Tue, 27 Feb 2007 09:46:07 +0000 (UTC)
Subject: driver does not report association
Message-ID: <slrneu7vev.46r.joerg@alea.gnuu.de>

Hi,

firstly, I asked[1] the wpa_supplicant team and they advised[2] me to ask
you.

[1] http://lists.shmoo.com/pipermail/hostap/2007-February/015136.html
[2] http://lists.shmoo.com/pipermail/hostap/2007-February/015140.html

I've an Airport Extreme card (bcm4306) and I use wpa_supplicant 0.5.7
with a Debian unstable on PowerPC and linux 2.6.20. My config is
available at
http://www.uni-jena.de/Linux_Fedora_Core___Scientific_Linux_4_x_mit_WPA_EAP_TTLS_PAP.html

# lspci -s 10:12 -v
0001:10:12.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless
LAN Controller (rev 03)
        Subsystem: Apple Computer Inc. AirPort Extreme
        Flags: bus master, fast devsel, latency 16, IRQ 52
        Memory at 80084000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: [40] Power Management version 2

% iwlist eth1 sc
  Cell 03 - Address: 00:14:1B:60:6A:40
            ESSID:"802.1X"
            Protocol:IEEE 802.11bg
            Mode:Master
            Channel:13
            Encryption key:on
            Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                      11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                      48 Mb/s; 54 Mb/s
            Quality=89/100  Signal level=-61 dBm  Noise level=-67 dBm
            IE: WPA Version 1
                Group Cipher : TKIP
                Pairwise Ciphers (1) : TKIP
                Authentication Suites (1) : 802.1X
            IE: IEEE 802.11i/WPA2 Version 1
                Group Cipher : TKIP
                Pairwise Ciphers (1) : CCMP
                Authentication Suites (1) : 802.1X
            Extra: Last beacon: 2324ms ago

% iwevent
12:29:08.536222   eth1     Set Mode:Managed
12:29:08.866442   eth1     Scan request completed
12:29:08.866542   eth1     Set Mode:Managed
12:29:08.877978   eth1     Set Frequency:2.472 GHz (Channel 13)
12:29:08.878259   eth1     Set ESSID:"802.1X"
12:29:09.222180   eth1     Scan request completed
12:29:09.224278   eth1     Custom driver event:authenticated
12:29:19.242191   eth1     Scan request completed
12:29:19.242266   eth1     Set Mode:Managed
12:29:19.245092   eth1     Set Frequency:2.472 GHz (Channel 13)
12:29:19.245244   eth1     Set ESSID:"802.1X"
12:29:29.606026   eth1     Scan request completed
12:29:29.606101   eth1     Set Mode:Managed
12:29:29.617045   eth1     Set Frequency:2.452 GHz (Channel 9)

% wpa_supplicant -D wext -i eth1
Trying to associate with 00:14:1b:60:6a:40 (SSID='802.1X' freq=2472 MHz)
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:6a:40 (SSID='802.1X' freq=2472 MHz)
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:be:c0 (SSID='802.1X' freq=2452 MHz)
Authentication with 00:00:00:00:00:00 timed out.

The wpa_supplicant team told me, that the 00:00:00:00:00:00 indicate,
that the driver did not report the association, but it seems it could
associate:

% dmesg
[371477.004914] bcm43xx: Keys cleared
[371477.004957] bcm43xx: Selected 802.11 core (phytype 2)
[371477.022872] SoftMAC: Associate: Scanning for networks first.
[371477.086927] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[371477.087472] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[371477.087701] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[371477.087911] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[371477.374209] SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
[371477.374290] SoftMAC: Queueing Authentication Request to 00:14:1b:5b:b0:f0
[371477.382170] SoftMAC: Sent Authentication Request to 00:14:1b:5b:b0:f0.
[371477.382915] SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
[371477.382979] bcm43xx: Request to set channel/freq: 13/2472
[371477.394331] SoftMAC: Already associating or associated to 00:14:1b:5b:b0:f0
[371477.394379] SoftMAC: Associate: Scanning for networks first.
[371477.738216] SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
[371477.738305] SoftMAC: Queueing Authentication Request to 00:14:1b:60:6a:40
[371477.746191] SoftMAC: Sent Authentication Request to 00:14:1b:60:6a:40.
[371477.747539] SoftMAC: Open Authentication completed with 00:14:1b:60:6a:40
[371487.346208] eth1: no IPv6 routers present
[371487.750219] SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
[371487.759142] SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
[371487.759212] bcm43xx: Request to set channel/freq: 13/2472
[371487.768420] SoftMAC: Already associating or associated to 00:14:1b:60:6a:40
[371489.386104] SoftMAC: Sent Authentication Request to 00:14:1b:5b:b0:f0.
[371498.114219] SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
[371498.122988] SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
[371498.123059] bcm43xx: Request to set channel/freq: 9/2452
[371498.132264] SoftMAC: Already associating or associated to 00:14:1b:60:6a:40
[371498.470210] SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
[371498.470295] SoftMAC: Queueing Authentication Request to 00:14:1b:5b:be:c0
[371498.478169] SoftMAC: Sent Authentication Request to 00:14:1b:5b:be:c0.

Bye, J?rg.
-- 
Computer Science is no more about Computers than astronomy is about
telescopes.
            (Edsger Wybe Dijkstra)


From larry.finger at lwfinger.net  Tue Feb 27 19:03:04 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 27 Feb 2007 12:03:04 -0600
Subject: driver does not report association
In-Reply-To: <slrneu7vev.46r.joerg@alea.gnuu.de>
References: <slrneu7vev.46r.joerg@alea.gnuu.de>
Message-ID: <45E47258.4040500@lwfinger.net>

J?rg,

J?rg Sommer wrote:
> Hi,
> 
> firstly, I asked[1] the wpa_supplicant team and they advised[2] me to ask
> you.
> 
> [1] http://lists.shmoo.com/pipermail/hostap/2007-February/015136.html
> [2] http://lists.shmoo.com/pipermail/hostap/2007-February/015140.html
> 
> I've an Airport Extreme card (bcm4306) and I use wpa_supplicant 0.5.7
> with a Debian unstable on PowerPC and linux 2.6.20. My config is
> available at
> http://www.uni-jena.de/Linux_Fedora_Core___Scientific_Linux_4_x_mit_WPA_EAP_TTLS_PAP.html
> 
> # lspci -s 10:12 -v
> 0001:10:12.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless
> LAN Controller (rev 03)
>         Subsystem: Apple Computer Inc. AirPort Extreme
>         Flags: bus master, fast devsel, latency 16, IRQ 52
>         Memory at 80084000 (32-bit, non-prefetchable) [size=8K]
>         Capabilities: [40] Power Management version 2
> 
> % iwlist eth1 sc
>   Cell 03 - Address: 00:14:1B:60:6A:40
>             ESSID:"802.1X"
>             Protocol:IEEE 802.11bg
>             Mode:Master
>             Channel:13
>             Encryption key:on
>             Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
>                       11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>                       48 Mb/s; 54 Mb/s
>             Quality=89/100  Signal level=-61 dBm  Noise level=-67 dBm
>             IE: WPA Version 1
>                 Group Cipher : TKIP
>                 Pairwise Ciphers (1) : TKIP
>                 Authentication Suites (1) : 802.1X
>             IE: IEEE 802.11i/WPA2 Version 1
>                 Group Cipher : TKIP
>                 Pairwise Ciphers (1) : CCMP
>                 Authentication Suites (1) : 802.1X
>             Extra: Last beacon: 2324ms ago
> 

Thank you very much for the complete report. Everything that I needed to diagnose your situation was
included.

The problem is not that the driver is failing to report the association, but that the driver cannot
associate when the signal/noise is as low as you have. You have only 6 dBm difference in the
received strength. Due to residual bugs in the PHY and radio setup, the transmitted signal/noise is
even lower. To associate and authenticate, you need a stronger signal.

There have been a number of changes that influence the transmitter strength since the 2.6.20 code
was frozen. If you are willing to rebuild your kernel, try the fixes contained in
ftp://lwfinger.dynalias.org/patches/combined_2.6.20.patch. Those may help you.

The only other "fix" I can offer is to reduce the attenuation between your AP and the computer by
moving closer.

Larry


From Larry.Finger at lwfinger.net  Tue Feb 27 22:35:59 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 27 Feb 2007 15:35:59 -0600
Subject: [PATCH] bcm43xx: Fix errors in specs to code translation in B6PHY init
Message-ID: <45e4a43f.BEt7jx5dMLQiM3wz%Larry.Finger@lwfinger.net>

There are three errors in the transcription of the latest revision to the
B6PHY init specifications.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This patch should be applied to wireless-2.6 and sent upstream to 2.6.21-rcX.

Larry

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -859,6 +859,9 @@ static void bcm43xx_phy_initb6(struct bc
 		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);
+		bcm43xx_write32(bcm, BCM43xx_MMIO_STATUS_BITFIELD,
+				bcm43xx_read32(bcm, BCM43xx_MMIO_STATUS_BITFIELD)
+				| 0x00000200);
 	}
 	if (radio->revision == 8) {
 		bcm43xx_radio_write16(bcm, 0x0051, 0x0000);
@@ -941,7 +944,8 @@ static void bcm43xx_phy_initb6(struct bc
 	bcm43xx_phy_write(bcm, 0x0038, 0x0668);
 	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
 	if (radio->revision <= 5)
-		bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);
+		bcm43xx_phy_write(bcm, 0x005D, (bcm43xx_phy_read(bcm, 0x005D)
+			          & 0xFF80) | 0x0003);
 	if (radio->revision <= 2)
 		bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
 	
@@ -958,7 +962,7 @@ static void bcm43xx_phy_initb6(struct bc
 		bcm43xx_phy_write(bcm, 0x0016, 0x0410);
 		bcm43xx_phy_write(bcm, 0x0017, 0x0820);
 		bcm43xx_phy_write(bcm, 0x0062, 0x0007);
-		(void) bcm43xx_radio_calibrationvalue(bcm);
+		bcm43xx_radio_init2050(bcm);
 		bcm43xx_phy_lo_g_measure(bcm);
 		if (bcm->sprom.boardflags & BCM43xx_BFL_RSSI) {
 			bcm43xx_calc_nrssi_slope(bcm);


From Larry.Finger at lwfinger.net  Tue Feb 27 22:39:27 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 27 Feb 2007 15:39:27 -0600
Subject: [PATCH V2] bcm43xx: Update Documentation/bcm43xx.txt
Message-ID: <45e4a50f.sCG/5tmeAFHjK3H5%Larry.Finger@lwfinger.net>

The in-kernel documentation of the bcm43xx driver is out of date.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

Index: wireless-2.6/Documentation/networking/bcm43xx.txt
===================================================================
--- wireless-2.6.orig/Documentation/networking/bcm43xx.txt
+++ wireless-2.6/Documentation/networking/bcm43xx.txt
@@ -2,35 +2,80 @@
 			BCM43xx Linux Driver Project
 			============================
 
-About this software
--------------------
-
-The goal of this project is to develop a linux driver for Broadcom
-BCM43xx chips, based on the specification at 
-http://bcm-specs.sipsolutions.net/
-
-The project page is http://bcm43xx.berlios.de/
-
-
-Requirements
+Introduction
 ------------
 
-1)	Linux Kernel 2.6.16 or later
-	http://www.kernel.org/
-
-	You may want to configure your kernel with:
-
-	CONFIG_DEBUG_FS (optional):
-		-> Kernel hacking
-		  -> Debug Filesystem
-
-2)	SoftMAC IEEE 802.11 Networking Stack extension and patched ieee80211
-	modules:
-	http://softmac.sipsolutions.net/
-
-3)	Firmware Files
-
-	Please try fwcutter. Fwcutter can extract the firmware from various 
-	binary driver files. It supports driver files from Windows, MacOS and 
-	Linux. You can get fwcutter from http://bcm43xx.berlios.de/.
-	Also, fwcutter comes with a README file for further instructions.
+Many of the wireless devices found in modern notebook computers are based
+on the wireless chips produced by Broadcom. These devices have been a problem
+for Linux users as there is no open-source driver available. In addition,
+Broadcom has not released specifications for the device, and driver availability
+has been limited to the binary-only form used in the GPL versions of AP
+hardware such as the Linksys WRT54G, and the Windows and OS X drivers.
+Before this project began, the only way to use these devices were to use the
+Windows or OS X drivers with either the Linuxant or ndiswrapper modules. There
+is a strong penalty if this method is used as loading the binary-only module
+"taints" the kernel, and no kernel developer will help diagnose any kernel
+problems.
+
+Development
+-----------
+
+This driver has been developed using a clean-room technique that is described
+at http://bcm-specs.sipsolutions.net/ReverseEngineeringProcess. For legal
+reasons, none of the clean-room crew works on the on the Linux driver, and
+none of the Linux developers sees anything but the specifications, which are
+the ultimate product of the reverse-engineering group.
+
+Software
+--------
+
+Since the release of the 2.6.17 kernel, the bcm43xx driver has been distributed
+with the kernel source, and is prebuilt in most, if not all, distributions.
+There is, however, additional software that is required. The firmware used by the
+chip is the intellectual property of Broadcom and they have not given the bcm43xx
+team redistribution rights to this firmware.  Since we cannot legally redistribute
+the firwmare we cannot include it with the driver. Furthermore, it cannot be placed
+in the downloadable archives of any distributing organization; therefore, the user is
+responsible for obtaining the firmware and placing it in the appropriate location
+so that the driver can find it when initializing.
+
+To help with this process, the bcm43xx developers provide a separate program
+named bcm43xx-fwcutter to "cut" the firmware out of a Windows or OS X driver
+and write the extracted files to the proper location. This program is usually
+provided with the distribution; however, it may be downloaded from
+
+http://developer.berlios.de/project/showfiles.php?group_id=4547
+
+The firmware is available in two versions. V3 firmware is used with the
+in-kernel bcm43xx driver that uses a software MAC layer called SoftMAC, and
+will have a microcode revision of 0x127 or smaller. The V4 firmware is used
+by an out-of-kernel driver employing a variation of the Devicescape MAC layer
+known as d80211. Once bcm43xx-d80211 reaches a satisfactory level of
+development, it will replace bcm43xx-softmac in the kernel as it is much more
+flexible and powerful.
+
+A source for the latest V3 firmware is
+
+http://downloads.openwrt.org/sources/wl_apsta-3.130.20.0.o
+
+Once this file is downloaded, the command 'bcm43xx-fwcutter -w <dir> <filename>'
+will extract the microcode and write it to directory <dir>. The correct
+directory will depend on your distribution; however, most use '/lib/firmware'.
+Once this step is completed, the bcm3xx driver should load when the system is
+booted. To see any messages relating to the driver, issue the command
+'dmesg | grep bcm43xx' from a terminal window. If there are any problems,
+please send that output to Bcm43xx-dev at lists.berlios.de.
+
+Although the driver has been in-kernel since 2.6.17, the earliest version is
+quite limited in its capability. Patches that include all features of later
+versions are available for the stable kernel versions from 2.6.18. These will
+be needed if you use a BCM4318, or a PCI Express version (BCM4311 and BCM4312).
+In addition, if you have an early BCM4306 and more than 1 GB RAM, your kernel
+will need to be patched. These patches, which are being updated regularly, are
+available at ftp://lwfinger.dynalias.org/patches. Look for
+'combined_2.6.YY.patch'. Of course you will need kernel source downloaded from
+kernel.org, or the source from your distribution.
+
+If you build your own kernel, please enable CONFIG_BCM43XX_DEBUG and
+CONFIG_IEEE80211_SOFTMAC_DEBUG. The log information provided is essential for
+solving any problems.


From joerg at alea.gnuu.de  Tue Feb 27 23:59:11 2007
From: joerg at alea.gnuu.de (=?UTF-8?Q?J=C3=B6rg?= Sommer)
Date: Tue, 27 Feb 2007 22:59:11 +0000 (UTC)
Subject: driver does not report association
References: <slrneu7vev.46r.joerg@alea.gnuu.de> <45E47258.4040500@lwfinger.net>
Message-ID: <slrneu9dtv.69n.joerg@alea.gnuu.de>

Hi Larry,

Larry Finger <larry.finger at lwfinger.net> wrote:
> J?rg Sommer wrote:
>> % iwlist eth1 sc
>>   Cell 03 - Address: 00:14:1B:60:6A:40
>>             ESSID:"802.1X"
>>             Protocol:IEEE 802.11bg
>>             Mode:Master
>>             Channel:13
>>             Encryption key:on
>>             Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
>>                       11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>>                       48 Mb/s; 54 Mb/s
>>             Quality=89/100  Signal level=-61 dBm  Noise level=-67 dBm
>
> The problem is not that the driver is failing to report the
> association, but that the driver cannot associate when the signal/noise
> is as low as you have. You have only 6 dBm difference in the received
> strength. Due to residual bugs in the PHY and radio setup, the
> transmitted signal/noise is even lower. To associate and authenticate,
> you need a stronger signal.

How strong it must be? What tells me the Quality value? When is it good?

I took your advice and move closer to the access point. I've got this
values:

eth1      Scan completed :
    Cell 01 - Address: 00:14:1B:60:6A:40
              ESSID:"802.1X"
              Quality=91/100  Signal level=-55 dBm  Noise level=-72 dBm

but I still had problems to connect. Sometime, I've got a noise level of
-256 dBm. Is this correct? Is this a good value?

> since the 2.6.20 code was frozen. If you are willing to rebuild your
> kernel, try the fixes contained in
> ftp://lwfinger.dynalias.org/patches/combined_2.6.20.patch. Those may
> help you.

I read in the README that these are the differences between 2.6.20 and
2.6.21-rc1. So I decided to build 2.6.21-rc1. The values above are from
this new kernel.

BTW: I saw, you didn't patch set_channelfreq() as I suggested in
https://lists.berlios.de/pipermail/bcm43xx-dev/2007-February/003815.html
Did you forget about it or do you have a reason not to include it?

In my first mail in this thread, I've included the output from iwevent.
There is a line ?Custom driver event:authenticated.? The wpa_supplicant
people said this is meaningless to them. Is this true? When gets this
event send out?

And I made another observation. SoftMAC sometimes report about error
code?12. Should I care about it? What does it mean?

SoftMAC: Queueing Authentication Request to 00:14:1b:60:6a:40
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:14:1b:60:6a:40.
SoftMAC: Open Authentication with 00:14:1b:60:6a:40 failed, error code: 12
SoftMAC: Authentication response received from 00:12:f0:07:51:9e but no queue item exists.

Sch?ne Gr??e, J?rg.
-- 
Die zehn Gebote Gottes enthalten 172 W?rter, die amerikanische
Unabh?ngigkeitserkl?rung 300 W?rter, die Verordnung der europ?ischen
Gemeinschaft ?ber den Import von Karamelbonbons exakt 25911 W?rter.


From johannes at sipsolutions.net  Wed Feb 28 00:59:11 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 28 Feb 2007 00:59:11 +0100
Subject: driver does not report association
In-Reply-To: <slrneu9dtv.69n.joerg@alea.gnuu.de>
References: <slrneu7vev.46r.joerg@alea.gnuu.de>
	<45E47258.4040500@lwfinger.net>  <slrneu9dtv.69n.joerg@alea.gnuu.de>
Message-ID: <1172620751.3681.15.camel@johannes.berg>

On Tue, 2007-02-27 at 22:59 +0000, J?rg Sommer wrote:

> but I still had problems to connect. Sometime, I've got a noise level of
> -256 dBm. Is this correct? Is this a good value?

-256 dBm is when it doesn't report anything at all.

> In my first mail in this thread, I've included the output from iwevent.
> There is a line ?Custom driver event:authenticated.? The wpa_supplicant
> people said this is meaningless to them. Is this true? When gets this
> event send out?

It's a custom event, wpa_supplicant ignores it. Just for softmac
debugging/looking what it does. It is sent out when a positive
authentication response is received from the access point.

> And I made another observation. SoftMAC sometimes report about error
> code 12. Should I care about it? What does it mean?

Yeah, your AP is not letting you authenticate. I don't remember what it
means, check the 802.11 specs of some header file.

If you get 'associated!' in the log file then at the same time in
iwevent you should get a "new ap" event (or such). This is what
wpa_supplicant actually uses.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070228/275e999c/attachment.pgp>

From mb at bu3sch.de  Wed Feb 28 18:14:00 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 28 Feb 2007 18:14:00 +0100
Subject: [PATCH] bcm43xx: Fix errors in specs to code translation in B6PHY
	init
In-Reply-To: <45e4a43f.BEt7jx5dMLQiM3wz%Larry.Finger@lwfinger.net>
References: <45e4a43f.BEt7jx5dMLQiM3wz%Larry.Finger@lwfinger.net>
Message-ID: <200702281814.00713.mb@bu3sch.de>

On Tuesday 27 February 2007 22:35, Larry Finger wrote:
> There are three errors in the transcription of the latest revision to the
> B6PHY init specifications.

NACK

> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This patch should be applied to wireless-2.6 and sent upstream to 2.6.21-rcX.
> 
> Larry
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> @@ -859,6 +859,9 @@ static void bcm43xx_phy_initb6(struct bc
>  		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
>  		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);
> +		bcm43xx_write32(bcm, BCM43xx_MMIO_STATUS_BITFIELD,
> +				bcm43xx_read32(bcm, BCM43xx_MMIO_STATUS_BITFIELD)
> +				| 0x00000200);

This is wrong.

Set bit 0x200 in the MicrocodeFlagsBitfield
http://bcm-specs.sipsolutions.net/MicrocodeFlagsBitfield

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Wed Feb 28 21:54:39 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 28 Feb 2007 14:54:39 -0600
Subject: [PATCH V2] bcm43xx: Fix errors in specs to code translation in
	B6PHY init
Message-ID: <45e5ec0f.3gZBQ2k0CuR4JjTT%Larry.Finger@lwfinger.net>

There are three errors in the transcription of the latest revision to the
B6PHY init specifications.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This patch should be applied to wireless-2.6 and sent upstream to 2.6.21-rcX.

Larry

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
@@ -859,6 +859,11 @@ static void bcm43xx_phy_initb6(struct bc
 		bcm43xx_radio_write16(bcm, 0x005D, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x005E, 0x0088);
 		bcm43xx_radio_write16(bcm, 0x007D, 0x0088);
+		bcm43xx_shm_write32(bcm, BCM43xx_SHM_SHARED,
+				    BCM43xx_UCODEFLAGS_OFFSET,
+				    (bcm43xx_shm_read32(bcm, BCM43xx_SHM_SHARED,
+				    BCM43xx_UCODEFLAGS_OFFSET)
+				    | 0x00000200));
 	}
 	if (radio->revision == 8) {
 		bcm43xx_radio_write16(bcm, 0x0051, 0x0000);
@@ -941,7 +946,8 @@ static void bcm43xx_phy_initb6(struct bc
 	bcm43xx_phy_write(bcm, 0x0038, 0x0668);
 	bcm43xx_radio_set_txpower_bg(bcm, 0xFFFF, 0xFFFF, 0xFFFF);
 	if (radio->revision <= 5)
-		bcm43xx_phy_write(bcm, 0x005D, bcm43xx_phy_read(bcm, 0x005D) | 0x0003);
+		bcm43xx_phy_write(bcm, 0x005D, (bcm43xx_phy_read(bcm, 0x005D)
+			          & 0xFF80) | 0x0003);
 	if (radio->revision <= 2)
 		bcm43xx_radio_write16(bcm, 0x005D, 0x000D);
 	
@@ -958,7 +964,7 @@ static void bcm43xx_phy_initb6(struct bc
 		bcm43xx_phy_write(bcm, 0x0016, 0x0410);
 		bcm43xx_phy_write(bcm, 0x0017, 0x0820);
 		bcm43xx_phy_write(bcm, 0x0062, 0x0007);
-		(void) bcm43xx_radio_calibrationvalue(bcm);
+		bcm43xx_radio_init2050(bcm);
 		bcm43xx_phy_lo_g_measure(bcm);
 		if (bcm->sprom.boardflags & BCM43xx_BFL_RSSI) {
 			bcm43xx_calc_nrssi_slope(bcm);


