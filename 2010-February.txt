From Larry.Finger at lwfinger.net  Tue Feb  2 17:08:19 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 02 Feb 2010 10:08:19 -0600
Subject: [PATCH] b43: Fix regression from commit c7ab5ef
Message-ID: <4b684df3.V5ikfWDIHGqzoqeC%Larry.Finger@lwfinger.net>

Commit c7ab5ef9bcd281135c21b4732c9be779585181be entitled "b43: implement
short slot and basic rate handling" reduced the transmit throughput for
my BCM4311 device from 18 Mb/s to 0.7 Mb/s. The basic rate handling
portion is OK, the problem is in the short slot handling.

Prior to this change, the short slot enable/disable routines were never
called. Experimentation showed that the critical part was changing the
value at offset 0x0010 in the shared memory. This is supposed to contain
the 802.11 Slot Time in usec, but if it is changed from its initial value
of zero, performance is destroyed. On the other hand, changing the value
in the MMIO register corresponding to the Interframe Slot Time increased
performance from 18 to 22 Mb/s. A BCM4306/3 also shows dramatic
improvement of the transmit rate from 5.3 to 19.0 Mb/s.

Other changes in the patch include removal of the magic number for the
MMIO register, and allowing the slot time to be set for any PHY operating
in the 2.4 GHz band. Previously, the routine was executed only for G PHYs.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
Cc: Stable <stable at kernel.org> [Any stable version back through 2.6.28]
---

John,

Although late in the cycle, this is 2.6.33 material, and should be applied
to kernels back to and including 2.6.28.

Thanks,

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -637,10 +637,17 @@ static void b43_upload_card_macaddress(s
 static void b43_set_slot_time(struct b43_wldev *dev, u16 slot_time)
 {
 	/* slot_time is in usec. */
-	if (dev->phy.type != B43_PHYTYPE_G)
+	/* This test used to exit for all but a G PHY. */
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
 		return;
-	b43_write16(dev, 0x684, 510 + slot_time);
-	b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	b43_write16(dev, B43_MMIO_IFSSLOT, 510 + slot_time);
+	/* Shared memory location 0x0010 is the slot time and should be
+	 * set to slot_time; however, this register is initially 0 and changing
+	 * the value adversely affects the transmit rate for BCM4311
+	 * devices. Until this behavior is unterstood, delete this step
+	 *
+	 * b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	 */
 }
 
 static void b43_short_slot_timing_enable(struct b43_wldev *dev)
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h
+++ wireless-testing/drivers/net/wireless/b43/b43.h
@@ -115,6 +115,7 @@
 #define B43_MMIO_TSF_2			0x636	/* core rev < 3 only */
 #define B43_MMIO_TSF_3			0x638	/* core rev < 3 only */
 #define B43_MMIO_RNG			0x65A
+#define B43_MMIO_IFSSLOT		0x684	/* Interframe slot time */
 #define B43_MMIO_IFSCTL			0x688 /* Interframe space control */
 #define  B43_MMIO_IFSCTL_USE_EDCF	0x0004
 #define B43_MMIO_POWERUP_DELAY		0x6A8


From Larry.Finger at lwfinger.net  Wed Feb  3 05:45:46 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 02 Feb 2010 22:45:46 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201001291205.36942.smpuj@bk.ru>
References: <20091226190129.GA20638@garlic>	<200912271626.27144.yhager@yhager.com>	<201001271604.31640.yhager@yhager.com>
	<201001291205.36942.smpuj@bk.ru>
Message-ID: <4B68FF7A.8080108@lwfinger.net>

On 01/29/2010 03:05 AM, Orivej Desh wrote:
> Not sure if this helps, but on my system (Network controller [0280]: Broadcom 
> Corporation BCM4311 802.11b/g WLAN [14e4:4311] (rev 01); b43-phy0: Broadcom 4311 
> WLAN found (core revision 10)) network controller no longer operates after 
> disconnect. That is, "iwlist wlan0 scan" finds nothing.
> 
> My other details are similar to Yuval's one ? I've got the latest firmware, the 
> problem appeared in 2.6.32, I've tested latest git without luck. Can't help too 
> much, though, because there is no unprotected network over here (from which 
> laptop disconnects immediately), and on the protected one on-line time is too 
> large: at this session the first disconnect occured after 35 hours, the second - 
> after half an hour after driver reset with ifconfig wlan0 down/up, the third - 
> hour and an half after reset; this is not normal because I had no disconnects 
> before 2.6.32.

I installed my BCM4311/2 device to try to duplicate your results from above. I
found a problem with performance and have posted a patch for that. I set my AP,
which is a Linksys WRT54GL V1.1 running openWRT Kamikaze r16206 firmware. I set
my network to be unencrypted as  you said that made the failure to occur more
quickly. As I write this, my device has been running for 32 hours with no
dropouts. I cannot duplicate your results.

My system is wireless-testing 2.6.33-rc5 with the two patches below. Please add
them to your system and try again.

Larry

===================


Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -637,10 +637,17 @@ static void b43_upload_card_macaddress(s
 static void b43_set_slot_time(struct b43_wldev *dev, u16 slot_time)
 {
 	/* slot_time is in usec. */
-	if (dev->phy.type != B43_PHYTYPE_G)
+	/* This test used to exit for all but a G PHY. */
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ)
 		return;
-	b43_write16(dev, 0x684, 510 + slot_time);
-	b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	b43_write16(dev, B43_MMIO_IFSSLOT, 510 + slot_time);
+	/* Shared memory location 0x0010 is the slot time and should be
+	 * set to slot_time; however, this register is initially 0 and changing
+	 * the value adversely affects the transmit rate for BCM4311
+	 * devices. Until this behavior is unterstood, delete this step
+	 *
+	 * b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);
+	 */
 }

 static void b43_short_slot_timing_enable(struct b43_wldev *dev)
Index: wireless-testing/drivers/net/wireless/b43/b43.h
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/b43.h
+++ wireless-testing/drivers/net/wireless/b43/b43.h
@@ -115,6 +115,7 @@
 #define B43_MMIO_TSF_2			0x636	/* core rev < 3 only */
 #define B43_MMIO_TSF_3			0x638	/* core rev < 3 only */
 #define B43_MMIO_RNG			0x65A
+#define B43_MMIO_IFSSLOT		0x684	/* Interframe slot time */
 #define B43_MMIO_IFSCTL			0x688 /* Interframe space control */
 #define  B43_MMIO_IFSCTL_USE_EDCF	0x0004
 #define B43_MMIO_POWERUP_DELAY		0x6A8

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
 	}

 	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
 	b43_set_status(dev, B43_STAT_STARTED);

 	/* Start data flow (TX/RX). */



From yhager at yhager.com  Wed Feb  3 18:33:50 2010
From: yhager at yhager.com (Yuval Hager)
Date: Wed, 3 Feb 2010 19:33:50 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B68FF7A.8080108@lwfinger.net>
References: <20091226190129.GA20638@garlic> <201001291205.36942.smpuj@bk.ru>
	<4B68FF7A.8080108@lwfinger.net>
Message-ID: <201002031933.50290.yhager@yhager.com>

On Wednesday 03 February 2010 06:45:46 Larry Finger wrote:
> My system is wireless-testing 2.6.33-rc5 with the two patches below. Please
>  add them to your system and try again.
> 

Thank you for your efforts, I highly appreciate it.

I pulled latest wireless-testing (git describe says v2.6.33-rc6-47373-
g3b4936f), and applied these two patches.

This time there is another type of disconnection (wlan0: deauthenticating from 
00:22:3f:18:89:5e by local choice (reason=3)), in addition to the "no probe 
response" I was getting previously.
The big change in these patches is that the system is able to get over it and 
reconnect after the disconnection. 

dmesg attached.

--yuval
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dmesg.gz
Type: application/x-gzip
Size: 15222 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100203/446ce604/attachment.bin>

From Larry.Finger at lwfinger.net  Wed Feb  3 19:18:52 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 03 Feb 2010 12:18:52 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201002031933.50290.yhager@yhager.com>
References: <20091226190129.GA20638@garlic> <201001291205.36942.smpuj@bk.ru>
	<4B68FF7A.8080108@lwfinger.net>
	<201002031933.50290.yhager@yhager.com>
Message-ID: <4B69BE0C.6000907@lwfinger.net>

On 02/03/2010 11:33 AM, Yuval Hager wrote:
> 
> Thank you for your efforts, I highly appreciate it.
> 
> I pulled latest wireless-testing (git describe says v2.6.33-rc6-47373-
> g3b4936f), and applied these two patches.
> 
> This time there is another type of disconnection (wlan0: deauthenticating from 
> 00:22:3f:18:89:5e by local choice (reason=3)), in addition to the "no probe 
> response" I was getting previously.
> The big change in these patches is that the system is able to get over it and 
> reconnect after the disconnection. 

The short-slot patch will only affect performance; however, the patch that
restarts the queues could certainly be the one that allows the system to
reconnect and continue. The surprising part is that I sent it earlier and was
told that it did not help.

Does your AP have the latest firmware? At
http://forums.wi-fiplanet.com/showthread.php?t=6536, reason 3 is listed as "The
access point went offline, deauthenticating the client." Other explanations are
likely possible. I have not checked the IEEE802.11 documents.

Larry


From Larry.Finger at lwfinger.net  Wed Feb  3 20:33:44 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 03 Feb 2010 13:33:44 -0600
Subject: [PATCH] b43/b43legacy: Wake queues in wireless_core_start
Message-ID: <4b69cf98.XrygqPz8t8ULClLG%Larry.Finger@lwfinger.net>

If b43 or b43legacy are deauthenticated or disconnected, there is a
possibility that a reconnection is tried with the queues stopped in
mac80211. To prevent this, start the queues before setting
STAT_INITIALIZED.

In b43, a similar change has been in place (twice) in the
wireless_core_init() routine. Remove the duplicate and add similar
code to b43legacy.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
Cc: Stable <stable at kernel.org>   [2.6.32]
---

John,

The b43 patch to wireless_core_start() seems to help a regression
between 2.6.31 and 2.6.32. Accordingly, these changes should be
applied to 2.6.33 with the automatic backport to 2.6.32.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
 	}
 
 	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
 	b43_set_status(dev, B43_STAT_STARTED);
 
 	/* Start data flow (TX/RX). */
@@ -4389,8 +4390,6 @@ static int b43_wireless_core_init(struct
 
 	ieee80211_wake_queues(dev->wl->hw);
 
-	ieee80211_wake_queues(dev->wl->hw);
-
 	b43_set_status(dev, B43_STAT_INITIALIZED);
 
 out:
Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-testing/drivers/net/wireless/b43legacy/main.c
@@ -2923,6 +2923,7 @@ static int b43legacy_wireless_core_start
 		goto out;
 	}
 	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
 	b43legacy_set_status(dev, B43legacy_STAT_STARTED);
 
 	/* Start data flow (TX/RX) */
@@ -3343,6 +3344,7 @@ static int b43legacy_wireless_core_init(
 	b43legacy_security_init(dev);
 	b43legacy_rng_init(wl);
 
+	ieee80211_wake_queues(dev->wl->hw);
 	b43legacy_set_status(dev, B43legacy_STAT_INITIALIZED);
 
 	b43legacy_leds_init(dev);


From yhager at yhager.com  Wed Feb  3 20:37:24 2010
From: yhager at yhager.com (Yuval Hager)
Date: Wed, 3 Feb 2010 21:37:24 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B69BE0C.6000907@lwfinger.net>
References: <20091226190129.GA20638@garlic>
	<201002031933.50290.yhager@yhager.com>
	<4B69BE0C.6000907@lwfinger.net>
Message-ID: <201002032137.25153.yhager@yhager.com>

On Wednesday 03 February 2010 20:18:52 Larry Finger wrote:
> On 02/03/2010 11:33 AM, Yuval Hager wrote:
> > Thank you for your efforts, I highly appreciate it.
> >
> > I pulled latest wireless-testing (git describe says v2.6.33-rc6-47373-
> > g3b4936f), and applied these two patches.
> >
> > This time there is another type of disconnection (wlan0: deauthenticating
> > from 00:22:3f:18:89:5e by local choice (reason=3)), in addition to the
> > "no probe response" I was getting previously.
> > The big change in these patches is that the system is able to get over it
> > and reconnect after the disconnection.
> 
> The short-slot patch will only affect performance; however, the patch that
> restarts the queues could certainly be the one that allows the system to
> reconnect and continue. The surprising part is that I sent it earlier and
>  was told that it did not help.
>

You are right. I retested just with the queue wake patch, and it does seem to 
reconnect as well.
I am not sure why it didn't work before - I probably applied it to the first 
version that broke (after bisecting) instead of wireless-testing, or I simply 
didn't wait enough time. Sorry about that - bisecting, compiling, rebooting 
etc. can get really confusing at times (especially late at night...).

Please let me know if you have any othes patch ideas for me to try.
 
> Does your AP have the latest firmware? At
> http://forums.wi-fiplanet.com/showthread.php?t=6536, reason 3 is listed as
>  "The access point went offline, deauthenticating the client." Other
>  explanations are likely possible. I have not checked the IEEE802.11
>  documents.
> 

I just upgraded to the latest firmware, but there is no change. I am not 
having any issues with this router while running 2.6.29 on this machine, or 
2.6.32 on another machine (using rt2x500pci). The router is Netgear WGR614V9, 
and the firmware is V1.2.24_37.0.35.
Also note that this "reason 3" only occures after the first association - 
after that it just continues with the "no probe response" I got used to.

--yuval


From mb at bu3sch.de  Wed Feb  3 20:47:38 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 3 Feb 2010 20:47:38 +0100
Subject: [PATCH] b43/b43legacy: Wake queues in wireless_core_start
In-Reply-To: <4b69cf98.XrygqPz8t8ULClLG%Larry.Finger@lwfinger.net>
References: <4b69cf98.XrygqPz8t8ULClLG%Larry.Finger@lwfinger.net>
Message-ID: <201002032047.40531.mb@bu3sch.de>

On Wednesday 03 February 2010 20:33:44 Larry Finger wrote:
> If b43 or b43legacy are deauthenticated or disconnected, there is a
> possibility that a reconnection is tried with the queues stopped in
> mac80211. To prevent this, start the queues before setting
> STAT_INITIALIZED.
> 
> In b43, a similar change has been in place (twice) in the
> wireless_core_init() routine. Remove the duplicate and add similar
> code to b43legacy.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> Cc: Stable <stable at kernel.org>   [2.6.32]
> ---
> 
> John,
> 
> The b43 patch to wireless_core_start() seems to help a regression
> between 2.6.31 and 2.6.32. Accordingly, these changes should be
> applied to 2.6.33 with the automatic backport to 2.6.32.
> 
> Larry
> ---
> 
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c
> +++ wireless-testing/drivers/net/wireless/b43/main.c
> @@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
>  	}
>  
>  	/* We are ready to run. */
> +	ieee80211_wake_queues(dev->wl->hw);
>  	b43_set_status(dev, B43_STAT_STARTED);
>  
>  	/* Start data flow (TX/RX). */
> @@ -4389,8 +4390,6 @@ static int b43_wireless_core_init(struct
>  
>  	ieee80211_wake_queues(dev->wl->hw);
>  
> -	ieee80211_wake_queues(dev->wl->hw);
> -
>  	b43_set_status(dev, B43_STAT_INITIALIZED);

Well, I wonder why it makes a difference.
I think we only call core_start() right after core_init() calls.

Anyway, I think wake_queues should both be removed from core_init()
and queues should only be woken in core_start.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Wed Feb  3 21:38:32 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 03 Feb 2010 14:38:32 -0600
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <201002032137.25153.yhager@yhager.com>
References: <20091226190129.GA20638@garlic>	<201002031933.50290.yhager@yhager.com>	<4B69BE0C.6000907@lwfinger.net>
	<201002032137.25153.yhager@yhager.com>
Message-ID: <4B69DEC8.1010201@lwfinger.net>

On 02/03/2010 01:37 PM, Yuval Hager wrote:
> 
> I just upgraded to the latest firmware, but there is no change. I am not 
> having any issues with this router while running 2.6.29 on this machine, or 
> 2.6.32 on another machine (using rt2x500pci). The router is Netgear WGR614V9, 
> and the firmware is V1.2.24_37.0.35.
> Also note that this "reason 3" only occures after the first association - 
> after that it just continues with the "no probe response" I got used to.

Based on a suggestion by Michael Buesch, I am trying a new version of the patch.
Does this one work for you?

Larry

===========

Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
 	}

 	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
 	b43_set_status(dev, B43_STAT_STARTED);

 	/* Start data flow (TX/RX). */
@@ -4387,10 +4388,6 @@ static int b43_wireless_core_init(struct
 	b43_upload_card_macaddress(dev);
 	b43_security_init(dev);

-	ieee80211_wake_queues(dev->wl->hw);
-
-	ieee80211_wake_queues(dev->wl->hw);
-
 	b43_set_status(dev, B43_STAT_INITIALIZED);

 out:
Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c
+++ wireless-testing/drivers/net/wireless/b43legacy/main.c
@@ -2923,6 +2923,7 @@ static int b43legacy_wireless_core_start
 		goto out;
 	}
 	/* We are ready to run. */
+	ieee80211_wake_queues(dev->wl->hw);
 	b43legacy_set_status(dev, B43legacy_STAT_STARTED);

 	/* Start data flow (TX/RX) */


-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: b43_queues_patch
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100203/0236a4dc/attachment.ksh>

From yhager at yhager.com  Wed Feb  3 21:57:20 2010
From: yhager at yhager.com (Yuval Hager)
Date: Wed, 3 Feb 2010 22:57:20 +0200
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B69DEC8.1010201@lwfinger.net>
References: <20091226190129.GA20638@garlic>
	<201002032137.25153.yhager@yhager.com>
	<4B69DEC8.1010201@lwfinger.net>
Message-ID: <201002032257.20693.yhager@yhager.com>

On Wednesday 03 February 2010, Larry Finger wrote:
> On 02/03/2010 01:37 PM, Yuval Hager wrote:
> > I just upgraded to the latest firmware, but there is no change. I am
> > not having any issues with this router while running 2.6.29 on this
> > machine, or 2.6.32 on another machine (using rt2x500pci). The router is
> > Netgear WGR614V9, and the firmware is V1.2.24_37.0.35.
> > Also note that this "reason 3" only occures after the first association
> > - after that it just continues with the "no probe response" I got used
> > to.
> 
> Based on a suggestion by Michael Buesch, I am trying a new version of the
>  patch. Does this one work for you?
> 

Nope, still same as previous patch (dmesg attached).

--y

> Larry
> 
> ===========
> 
> Index: wireless-testing/drivers/net/wireless/b43/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43/main.c
> +++ wireless-testing/drivers/net/wireless/b43/main.c
> @@ -3980,6 +3980,7 @@ static int b43_wireless_core_start(struc
>  	}
> 
>  	/* We are ready to run. */
> +	ieee80211_wake_queues(dev->wl->hw);
>  	b43_set_status(dev, B43_STAT_STARTED);
> 
>  	/* Start data flow (TX/RX). */
> @@ -4387,10 +4388,6 @@ static int b43_wireless_core_init(struct
>  	b43_upload_card_macaddress(dev);
>  	b43_security_init(dev);
> 
> -	ieee80211_wake_queues(dev->wl->hw);
> -
> -	ieee80211_wake_queues(dev->wl->hw);
> -
>  	b43_set_status(dev, B43_STAT_INITIALIZED);
> 
>  out:
> Index: wireless-testing/drivers/net/wireless/b43legacy/main.c
> ===================================================================
> --- wireless-testing.orig/drivers/net/wireless/b43legacy/main.c
> +++ wireless-testing/drivers/net/wireless/b43legacy/main.c
> @@ -2923,6 +2923,7 @@ static int b43legacy_wireless_core_start
>  		goto out;
>  	}
>  	/* We are ready to run. */
> +	ieee80211_wake_queues(dev->wl->hw);
>  	b43legacy_set_status(dev, B43legacy_STAT_STARTED);
> 
>  	/* Start data flow (TX/RX) */
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: dmesg.gz
Type: application/x-gzip
Size: 12872 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100203/5f1abc13/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part.
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100203/5f1abc13/attachment.pgp>

From akaihola at gmail.com  Thu Feb  4 08:48:57 2010
From: akaihola at gmail.com (Antti Kaihola)
Date: Thu, 4 Feb 2010 09:48:57 +0200
Subject: addition to list of supported devices: 14e4:4315
Message-ID: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>

Hi,


Looking at http://bcm43xx.berlios.de/?go=devices it seems that the device on
my Dell Mini 9 is missing:

03:00.0 0280: 14e4:4315 (rev 01)
    Subsystem: 14e4:04b5
    Flags: bus master, fast devsel, latency 0, IRQ 17
    Memory at f0200000 (64-bit, non-prefetchable) [size=16K]
    Capabilities: <access denied>
    Kernel driver in use: b43-pci-bridge
    Kernel modules: ssb

This card worked perfectly in Ubuntu 9.04 with the b43 driver. I haven't
tested with 9.10.

On a current Ubuntu 10.04 Lucid with kernel 2.6.32-12-generic #16-Ubuntu SMP
it does work with the acpi=off kernel parameter.

With ACPI turned on I get the fatal DMA errors which have been discussed on
this list. A bug has also been filed in Launchpad:
https://bugs.launchpad.net/ubuntu/+source/linux/+bug/502433


-Antti
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100204/b3081b3d/attachment.html>

From zajec5 at gmail.com  Thu Feb  4 09:23:13 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Thu, 4 Feb 2010 09:23:13 +0100
Subject: addition to list of supported devices: 14e4:4315
In-Reply-To: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>
References: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>
Message-ID: <b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>

2010/2/4 Antti Kaihola <akaihola at gmail.com>:
> Looking at http://bcm43xx.berlios.de/?go=devices it seems that the device on
> my Dell Mini 9 is missing:

If you see home page on this address
(http://bcm43xx.berlios.de/?go=home) you will notice link to correct
place for b43 info:
http://linuxwireless.org/en/users/Drivers/b43


> 03:00.0 0280: 14e4:4315 (rev 01)
> ??? Subsystem: 14e4:04b5
> ??? Flags: bus master, fast devsel, latency 0, IRQ 17
> ??? Memory at f0200000 (64-bit, non-prefetchable) [size=16K]
> ??? Capabilities: <access denied>
> ??? Kernel driver in use: b43-pci-bridge
> ??? Kernel modules: ssb
>
> This card worked perfectly in Ubuntu 9.04 with the b43 driver. I haven't
> tested with 9.10.

Wait, moment. What did you say? Are you completely, really sure
14e4:4315 did work in Ubuntu 9.04 with b43? 9.04 comes with kernel
2.6.28. As far as we know 14e4:4315 is LP-PHY and we support LP-PHY
from 2.6.32 kernel. Did you install some more recent kernel in your
9.04? I don't understand... maybe id is duplicated, and there are two
cards with same ID and different PHYs?

Please, try to explain this.


> On a current Ubuntu 10.04 Lucid with kernel 2.6.32-12-generic #16-Ubuntu SMP
> it does work with the acpi=off kernel parameter.
>
> With ACPI turned on I get the fatal DMA errors which have been discussed on
> this list. A bug has also been filed in Launchpad:
> https://bugs.launchpad.net/ubuntu/+source/linux/+bug/502433


-- 
Rafa?


From E.A.B.Piel at tudelft.nl  Thu Feb  4 10:23:22 2010
From: E.A.B.Piel at tudelft.nl (=?UTF-8?B?w4lyaWMgUGllbA==?=)
Date: Thu, 04 Feb 2010 10:23:22 +0100
Subject: addition to list of supported devices: 14e4:4315
In-Reply-To: <b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>
References: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>
	<b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>
Message-ID: <4B6A920A.2050406@tudelft.nl>

Op 04-02-10 09:23, Rafa? Mi?ecki schreef:
> 2010/2/4 Antti Kaihola <akaihola at gmail.com>:
> 
>> 03:00.0 0280: 14e4:4315 (rev 01)
>>     Subsystem: 14e4:04b5
>>     Flags: bus master, fast devsel, latency 0, IRQ 17
>>     Memory at f0200000 (64-bit, non-prefetchable) [size=16K]
>>     Capabilities: <access denied>
>>     Kernel driver in use: b43-pci-bridge
>>     Kernel modules: ssb
>>
>> This card worked perfectly in Ubuntu 9.04 with the b43 driver. I haven't
>> tested with 9.10.
> 
> Wait, moment. What did you say? Are you completely, really sure
> 14e4:4315 did work in Ubuntu 9.04 with b43? 9.04 comes with kernel
> 2.6.28. As far as we know 14e4:4315 is LP-PHY and we support LP-PHY
> from 2.6.32 kernel. Did you install some more recent kernel in your
> 9.04? I don't understand... maybe id is duplicated, and there are two
> cards with same ID and different PHYs?
> 
> Please, try to explain this.
Hi,
Antti, maybe you could do a lsmod, to check if the "wl" driver is loaded.

Eric


From zajec5 at gmail.com  Thu Feb  4 12:23:11 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 12:23:11 +0100
Subject: [PATCH 4/5] b43: N-PHY: save calibration for further restore
In-Reply-To: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
References: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
Message-ID: <1265282592-25491-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   51 +++++++++++++++++++++++++++++++++++++-
 drivers/net/wireless/b43/phy_n.h |    1 +
 2 files changed, 51 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index e8266ed..f632494 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -2319,6 +2319,55 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
 	}
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SaveCal */
+static void b43_nphy_save_cal(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
+	u16 *txcal_radio_regs = NULL;
+	u8 *iqcal_chanspec;
+	u16 *table = NULL;
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+		rxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_2G;
+		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;
+		iqcal_chanspec = &nphy->iqcal_chanspec_2G;
+		table = nphy->cal_cache.txcal_coeffs_2G;
+	} else {
+		rxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_5G;
+		txcal_radio_regs = nphy->cal_cache.txcal_radio_regs_5G;
+		iqcal_chanspec = &nphy->iqcal_chanspec_5G;
+		table = nphy->cal_cache.txcal_coeffs_5G;
+	}
+
+	b43_nphy_rx_iq_coeffs(dev, false, rxcal_coeffs);
+	/* TODO use some definitions */
+	if (dev->phy.rev >= 3) {
+		txcal_radio_regs[0] = b43_radio_read(dev, 0x2021);
+		txcal_radio_regs[1] = b43_radio_read(dev, 0x2022);
+		txcal_radio_regs[2] = b43_radio_read(dev, 0x3021);
+		txcal_radio_regs[3] = b43_radio_read(dev, 0x3022);
+		txcal_radio_regs[4] = b43_radio_read(dev, 0x2023);
+		txcal_radio_regs[5] = b43_radio_read(dev, 0x2024);
+		txcal_radio_regs[6] = b43_radio_read(dev, 0x3023);
+		txcal_radio_regs[7] = b43_radio_read(dev, 0x3024);
+	} else {
+		txcal_radio_regs[0] = b43_radio_read(dev, 0x8B);
+		txcal_radio_regs[1] = b43_radio_read(dev, 0xBA);
+		txcal_radio_regs[2] = b43_radio_read(dev, 0x8D);
+		txcal_radio_regs[3] = b43_radio_read(dev, 0xBC);
+	}
+	*iqcal_chanspec = nphy->radio_chanspec;
+	b43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 8, table);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */
 static void b43_nphy_restore_cal(struct b43_wldev *dev)
 {
@@ -3016,7 +3065,7 @@ int b43_phy_initn(struct b43_wldev *dev)
 
 	if (!b43_nphy_cal_tx_iq_lo(dev, target, true, false)) {
 		if (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)
-			;/* Call N PHY Save Cal */
+			b43_nphy_save_cal(dev);
 		else if (nphy->mphase_cal_phase_id == 0)
 			;/* N PHY Periodic Calibration with argument 3 */
 	} else {
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index ae82f0f..0400a2c 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -975,6 +975,7 @@ struct b43_phy_n {
 	u16 papd_epsilon_offset[2];
 	s32 preamble_override;
 	u32 bb_mult_save;
+	u16 radio_chanspec;
 
 	bool gain_boost;
 	bool elna_gain_config;
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 12:23:12 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 12:23:12 +0100
Subject: [PATCH 5/5] b43: N-PHY: partly implement SPUR workaround
In-Reply-To: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
References: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
Message-ID: <1265282592-25491-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   64 +++++++++++++++++++++++++++++++++++++-
 drivers/net/wireless/b43/phy_n.h |    3 ++
 2 files changed, 66 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index f632494..6f56844 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -717,6 +717,67 @@ static void b43_nphy_stop_playback(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SpurWar */
+static void b43_nphy_spur_workaround(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	unsigned int channel;
+	int tone[2] = { 57, 58 };
+	u32 noise[2] = { 0x3FF, 0x3FF };
+
+	B43_WARN_ON(dev->phy.rev < 3);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	/* FIXME: channel = radio_chanspec */
+
+	if (nphy->gband_spurwar_en) {
+		/* TODO: N PHY Adjust Analog Pfbw (7) */
+		if (channel == 11 && dev->phy.is_40mhz)
+			; /* TODO: N PHY Adjust Min Noise Var(2, tone, noise)*/
+		else
+			; /* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/
+		/* TODO: N PHY Adjust CRS Min Power (0x1E) */
+	}
+
+	if (nphy->aband_spurwar_en) {
+		if (channel == 54) {
+			tone[0] = 0x20;
+			noise[0] = 0x25F;
+		} else if (channel == 38 || channel == 102 || channel == 118) {
+			if (0 /* FIXME */) {
+				tone[0] = 0x20;
+				noise[0] = 0x21F;
+			} else {
+				tone[0] = 0;
+				noise[0] = 0;
+			}
+		} else if (channel == 134) {
+			tone[0] = 0x20;
+			noise[0] = 0x21F;
+		} else if (channel == 151) {
+			tone[0] = 0x10;
+			noise[0] = 0x23F;
+		} else if (channel == 153 || channel == 161) {
+			tone[0] = 0x30;
+			noise[0] = 0x23F;
+		} else {
+			tone[0] = 0;
+			noise[0] = 0;
+		}
+
+		if (!tone[0] && !noise[0])
+			; /* TODO: N PHY Adjust Min Noise Var(1, tone, noise)*/
+		else
+			; /* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/
+	}
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */
 static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 {
@@ -3079,7 +3140,8 @@ int b43_phy_initn(struct b43_wldev *dev)
 	if (phy->rev >= 3 && phy->rev <= 6)
 		b43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x0014);
 	b43_nphy_tx_lp_fbw(dev);
-	/* TODO N PHY Spur Workaround */
+	if (phy->rev >= 3)
+		b43_nphy_spur_workaround(dev);
 
 	b43err(dev->wl, "IEEE 802.11n devices are not supported, yet.\n");
 	return 0;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 0400a2c..403aad3 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -1002,6 +1002,9 @@ struct b43_phy_n {
 	u16 classifier_state;
 	u16 clip_state[2];
 
+	bool aband_spurwar_en;
+	bool gband_spurwar_en;
+
 	bool ipa2g_on;
 	u8 iqcal_chanspec_2G;
 	u8 rssical_chanspec_2G;
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 12:23:08 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 12:23:08 +0100
Subject: [PATCH 1/5] b43: N-PHY: implement overriding RF control intc
Message-ID: <1265282592-25491-1-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |  117 +++++++++++++++++++++++++++++++++++---
 1 files changed, 109 insertions(+), 8 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6392da2..8992457 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -68,6 +68,10 @@ static void b43_nphy_set_rf_sequence(struct b43_wldev *dev, u8 cmd,
 					u8 *events, u8 *delays, u8 length);
 static void b43_nphy_force_rf_sequence(struct b43_wldev *dev,
 				       enum b43_nphy_rf_sequence seq);
+static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
+						u16 value, u8 core, bool off);
+static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
+						u16 value, u8 core);
 
 void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
 {//TODO
@@ -498,8 +502,8 @@ static void b43_nphy_rx_cal_phy_setup(struct b43_wldev *dev, u8 core)
 		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0007);
 	}
 
-	/* TODO: Call N PHY RF Ctrl Intc Override with 2, 0, 3 as arguments */
-	/* TODO: Call N PHY RF Intc Override with 8, 0, 3, 0 as arguments */
+	b43_nphy_rf_control_intc_override(dev, 2, 0, 3);
+	b43_nphy_rf_control_override(dev, 8, 0, 3, false);
 	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);
 
 	if (core == 0) {
@@ -509,9 +513,8 @@ static void b43_nphy_rx_cal_phy_setup(struct b43_wldev *dev, u8 core)
 		rxval = 4;
 		txval = 2;
 	}
-
-	/* TODO: Call N PHY RF Ctrl Intc Override with 1, rxval, (core + 1) */
-	/* TODO: Call N PHY RF Ctrl Intc Override with 1, txval, (2 - core) */
+	b43_nphy_rf_control_intc_override(dev, 1, rxval, (core + 1));
+	b43_nphy_rf_control_intc_override(dev, 1, txval, (2 - core));
 }
 
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalcRxIqComp */
@@ -1264,6 +1267,104 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 	}
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlIntcOverride */
+static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
+						u16 value, u8 core)
+{
+	u8 i, j;
+	u16 reg, tmp, val;
+
+	B43_WARN_ON(dev->phy.rev < 3);
+	B43_WARN_ON(field > 4);
+
+	for (i = 0; i < 2; i++) {
+		if ((core == 1 && i == 1) || (core == 2 && !i))
+			continue;
+
+		reg = (i == 0) ?
+			B43_NPHY_RFCTL_INTC1 : B43_NPHY_RFCTL_INTC2;
+		b43_phy_mask(dev, reg, 0xFBFF);
+
+		switch (field) {
+		case 0:
+			b43_phy_write(dev, reg, 0);
+			b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);
+			break;
+		case 1:
+			if (!i) {
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_INTC1,
+						0xFC3F, (value << 6));
+				b43_phy_maskset(dev, B43_NPHY_TXF_40CO_B1S1,
+						0xFFFE, 1);
+				b43_phy_set(dev, B43_NPHY_RFCTL_CMD,
+						B43_NPHY_RFCTL_CMD_START);
+				for (j = 0; j < 100; j++) {
+					if (b43_phy_read(dev, B43_NPHY_RFCTL_CMD) & B43_NPHY_RFCTL_CMD_START) {
+						j = 0;
+						break;
+					}
+					udelay(10);
+				}
+				if (j)
+					b43err(dev->wl,
+						"intc override timeout\n");
+				b43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S1,
+						0xFFFE);
+			} else {
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_INTC2,
+						0xFC3F, (value << 6));
+				b43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,
+						0xFFFE, 1);
+				b43_phy_set(dev, B43_NPHY_RFCTL_CMD,
+						B43_NPHY_RFCTL_CMD_RXTX);
+				for (j = 0; j < 100; j++) {
+					if (b43_phy_read(dev, B43_NPHY_RFCTL_CMD) & B43_NPHY_RFCTL_CMD_RXTX) {
+						j = 0;
+						break;
+					}
+					udelay(10);
+				}
+				if (j)
+					b43err(dev->wl,
+						"intc override timeout\n");
+				b43_phy_mask(dev, B43_NPHY_RFCTL_OVER,
+						0xFFFE);
+			}
+			break;
+		case 2:
+			if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {
+				tmp = 0x0020;
+				val = value << 5;
+			} else {
+				tmp = 0x0010;
+				val = value << 4;
+			}
+			b43_phy_maskset(dev, reg, ~tmp, val);
+			break;
+		case 3:
+			if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {
+				tmp = 0x0001;
+				val = value;
+			} else {
+				tmp = 0x0004;
+				val = value << 2;
+			}
+			b43_phy_maskset(dev, reg, ~tmp, val);
+			break;
+		case 4:
+			if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {
+				tmp = 0x0002;
+				val = value << 1;
+			} else {
+				tmp = 0x0008;
+				val = value << 3;
+			}
+			b43_phy_maskset(dev, reg, ~tmp, val);
+			break;
+		}
+	}
+}
+
 static void b43_nphy_bphy_init(struct b43_wldev *dev)
 {
 	unsigned int i;
@@ -2161,9 +2262,9 @@ static void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)
 		regs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);
 		regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);
 
-		/* TODO: Call N PHY RF Ctrl Intc Override with 2, 1, 3 */
-		/* TODO: Call N PHY RF Ctrl Intc Override with 1, 2, 1 */
-		/* TODO: Call N PHY RF Ctrl Intc Override with 1, 8, 2 */
+		b43_nphy_rf_control_intc_override(dev, 2, 1, 3);
+		b43_nphy_rf_control_intc_override(dev, 1, 2, 1);
+		b43_nphy_rf_control_intc_override(dev, 1, 8, 2);
 
 		regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);
 		regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 12:23:10 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 12:23:10 +0100
Subject: [PATCH 3/5] b43: N-PHY: prepare code for reapplying TX cal coeffs
In-Reply-To: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
References: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
Message-ID: <1265282592-25491-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   35 ++++++++++++++++++++++++++++++++++-
 1 files changed, 34 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 89e9d66..e8266ed 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -2611,6 +2611,39 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 	return error;
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ReapplyTxCalCoeffs */
+static void b43_nphy_reapply_tx_cal_coeffs(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+	u8 i;
+	u16 buffer[7];
+	bool equal = true;
+
+	if (!nphy->txiqlocal_coeffsvalid || 1 /* FIXME */)
+		return;
+
+	b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);
+	for (i = 0; i < 4; i++) {
+		if (buffer[i] != nphy->txiqlocal_bestc[i]) {
+			equal = false;
+			break;
+		}
+	}
+
+	if (!equal) {
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4,
+					nphy->txiqlocal_bestc);
+		for (i = 0; i < 4; i++)
+			buffer[i] = 0;
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,
+					buffer);
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,
+					&nphy->txiqlocal_bestc[5]);
+		b43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,
+					&nphy->txiqlocal_bestc[5]);
+	}
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
 static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 			struct nphy_txgains target, u8 type, bool debug)
@@ -2641,7 +2674,7 @@ static int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,
 	b43_nphy_stay_in_carrier_search(dev, 1);
 
 	if (dev->phy.rev < 2)
-		;/* TODO: Call N PHY Reapply TX Cal Coeffs */
+		b43_nphy_reapply_tx_cal_coeffs(dev);
 	b43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);
 	for (i = 0; i < 2; i++) {
 		b43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 12:23:09 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 12:23:09 +0100
Subject: [PATCH 2/5] b43: N-PHY: load generated samples
In-Reply-To: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
References: <1265282592-25491-1-git-send-email-zajec5@gmail.com>
Message-ID: <1265282592-25491-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   26 +++++++++++++++++++++++++-
 1 files changed, 25 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 8992457..89e9d66 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -956,6 +956,30 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/LoadSampleTable */
+static void b43_nphy_load_samples(struct b43_wldev *dev,
+					struct b43_c32 *samples, u16 len) {
+	struct b43_phy_n *nphy = dev->phy.n;
+	u16 i;
+	u32 *data;
+
+	data = kzalloc(len * sizeof(u32), GFP_KERNEL);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	for (i = 0; i < len; i++) {
+		data[i] = (samples[i].i & 0x3FF << 10);
+		data[i] |= samples[i].q & 0x3FF;
+	}
+	b43_ntab_write_bulk(dev, B43_NTAB32(17, 0), len, data);
+
+	kfree(data);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */
 static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 					bool test)
@@ -991,7 +1015,7 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 		samples[i].i = CORDIC_CONVERT(samples[i].i * max);
 	}
 
-	/* TODO: Call N PHY Load Sample Table with buffer, len as arguments */
+	b43_nphy_load_samples(dev, samples, len);
 	kfree(samples);
 	return len;
 }
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 13:08:08 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 13:08:08 +0100
Subject: [PATCH 2/5 V2] b43: N-PHY: load generated samples
Message-ID: <1265285291-28202-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: handle allocation fail, thanks Johannes for pointing
---
 drivers/net/wireless/b43/phy_n.c |   31 +++++++++++++++++++++++++++++--
 1 files changed, 29 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 8992457..b2a91c2 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -956,6 +956,33 @@ static void b43_nphy_workarounds(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/LoadSampleTable */
+static int b43_nphy_load_samples(struct b43_wldev *dev,
+					struct b43_c32 *samples, u16 len) {
+	struct b43_phy_n *nphy = dev->phy.n;
+	u16 i;
+	u32 *data;
+
+	data = kzalloc(len * sizeof(u32), GFP_KERNEL);
+	if (!data) {
+		b43err(dev->wl, "allocation for samples loading failed\n");
+		return -ENOMEM;
+	}
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	for (i = 0; i < len; i++) {
+		data[i] = (samples[i].i & 0x3FF << 10);
+		data[i] |= samples[i].q & 0x3FF;
+	}
+	b43_ntab_write_bulk(dev, B43_NTAB32(17, 0), len, data);
+
+	kfree(data);
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+	return 0;
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */
 static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 					bool test)
@@ -991,9 +1018,9 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 		samples[i].i = CORDIC_CONVERT(samples[i].i * max);
 	}
 
-	/* TODO: Call N PHY Load Sample Table with buffer, len as arguments */
+	i = b43_nphy_load_samples(dev, samples, len);
 	kfree(samples);
-	return len;
+	return (i < 0) ? 0 : len;
 }
 
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 13:11:54 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 13:11:54 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
Message-ID: <1265285514-28798-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 074b34c..795bb1e 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
 	}
 
 	samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
+	if (!samples) {
+		b43err(dev->wl, "allocation for samples generation failed\n");
+		return 0;
+	}
 	rot = (((freq * 36) / bw) << 16) / 100;
 	angle = 0;
 
-- 
1.6.4.2



From zajec5 at gmail.com  Thu Feb  4 21:57:45 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Thu,  4 Feb 2010 21:57:45 +0100
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel switch
Message-ID: <1265317065-2922-2-git-send-email-zajec5@gmail.com>

---
G??bor: I think you missed specs here. Could you check whole routine just for
sure, please? I don't understand whole radio and chanspec magic yet.
---
 drivers/net/wireless/b43/phy_lp.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
index 185219e..61009ee 100644
--- a/drivers/net/wireless/b43/phy_lp.c
+++ b/drivers/net/wireless/b43/phy_lp.c
@@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
 		if (err)
 			return err;
 		lpphy_set_analog_filter(dev, new_channel);
-		lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
 	}
+	lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
 
 	lpphy->channel = new_channel;
 	b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
-- 
1.6.4.2



From Larry.Finger at lwfinger.net  Fri Feb  5 04:24:59 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 04 Feb 2010 21:24:59 -0600
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel
	switch
In-Reply-To: <1265317065-2922-2-git-send-email-zajec5@gmail.com>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com>
Message-ID: <4B6B8F8B.6020908@lwfinger.net>

On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
> ---
> G??bor: I think you missed specs here. Could you check whole routine just for
> sure, please? I don't understand whole radio and chanspec magic yet.
> ---
>  drivers/net/wireless/b43/phy_lp.c |    2 +-
>  1 files changed, 1 insertions(+), 1 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
> index 185219e..61009ee 100644
> --- a/drivers/net/wireless/b43/phy_lp.c
> +++ b/drivers/net/wireless/b43/phy_lp.c
> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>  		if (err)
>  			return err;
>  		lpphy_set_analog_filter(dev, new_channel);
> -		lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>  	}
> +	lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>  
>  	lpphy->channel = new_channel;
>  	b43_write16(dev, B43_MMIO_CHANNEL, new_channel);

Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
outside the if statement. I changed the spec a little. It used to test "radio
enabled", but I have found that is always true for our driver.

Larry



From monterod at gmail.com  Fri Feb  5 08:04:00 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 08:04:00 +0100
Subject: b43/b43legacy driver
Message-ID: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>

Hi all:

My wifi doesn't work after applying the procedure of the following page "
http://linuxwireless.org/en/users/Drivers/b43#Known_PCI_devices".
I am going to try to summarize my situation.

I have installed in my Lenovo Laptop N500, Ubuntu 9.10 Karmic.

monterod at latosca:~$ uname -r
*2.6.31-14-generic*

I thing it's working with 64 bits

monterod at latosca:~$ cat /proc/cpuinfo
processor    : 0
vendor_id    : GenuineIntel
cpu family    : 6
model        : 15
model name    : Intel(R) Pentium(R) Dual  CPU  T3400  @ 2.16GHz
stepping    : 13
cpu MHz        : 1000.000
cache size    : 1024 KB
physical id    : 0
siblings    : 2
core id        : 0
cpu cores    : 2
apicid        : 0
initial apicid    : 0
fdiv_bug    : no
hlt_bug        : no
f00f_bug    : no
coma_bug    : no
fpu        : yes
fpu_exception    : yes
cpuid level    : 10
wp        : yes
flags        : fpu vme de pse tsc msr pae mce cx8 apic mtrr pge mca cmov pat
pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe nx lm constant_tsc
arch_perfmon pebs bts pni dtes64 monitor ds_cpl est tm2 ssse3 cx16 xtpr pdcm
lahf_lm
bogomips    : 4321.84
*clflush size    : 64*
power management:

processor    : 1
vendor_id    : GenuineIntel
cpu family    : 6
model        : 15
model name    : Intel(R) Pentium(R) Dual  CPU  T3400  @ 2.16GHz
stepping    : 13
cpu MHz        : 1000.000
cache size    : 1024 KB
physical id    : 0
siblings    : 2
core id        : 1
cpu cores    : 2
apicid        : 1
initial apicid    : 1
fdiv_bug    : no
hlt_bug        : no
f00f_bug    : no
coma_bug    : no
fpu        : yes
fpu_exception    : yes
cpuid level    : 10
wp        : yes
flags        : fpu vme de pse tsc msr pae mce cx8 apic mtrr pge mca cmov pat
pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe nx lm constant_tsc
arch_perfmon pebs bts pni dtes64 monitor ds_cpl est tm2 ssse3 cx16 xtpr pdcm
lahf_lm
bogomips    : 4322.50
*clflush size    : 64*
power management:
Known PCI devicesmonterod at latosca:~$ lspci -vnn | grep 14e4
04:00.0 Network controller [0280]: Broadcom Corporation BCM4312
802.11b/g*[14e4:4315]
* (rev 01)
    Subsystem: Broadcom Corporation Device [14e4:04b5]
07:00.0 Ethernet controller [0200]: Broadcom Corporation NetLink BCM5906M
Fast Ethernet PCI Express [14e4:1713] (rev 02)

I thing that my card is the following:

*PCI-ID*

*State*

*Chip*

*Modes*

*PHY version*

*Driver*

14e4:4315

supported 2.6.32 and later

BCM4312

b/g

LP

b43

Then, I applied the following procedure without problems and when I
restarted my laptop the wifi network didn't work yet. Can you help me?

You are using the b43 driver with an LP-PHY card (e.g. BCM4312)

Follow these instructions if you are using the *b43* driver from *
linux-2.6.32* and newer or *compat-wireless-2.6*, or from any current GIT
tree, and have a device with a low-power PHY.

Use the current Git version of b43-fwcutter.
Download, extract the b43-fwcutter tarball and build it:

git clone http://git.bu3sch.de/git/b43-tools.git
cd b43-tools/fwcutter
make
cd ..

Use version 4.174.64.19 of Broadcom's proprietary driver. (The tarball is
mislabeled as "4.178.10.4", but it is actually 4.174.64.19.)
Download and extract the firmware from this driver tarball:

export FIRMWARE_INSTALL_DIR="/lib/firmware"
wget http://downloads.openwrt.org/sources/broadcom-wl-4.178.10.4.tar.bz2
tar xjf broadcom-wl-4.178.10.4.tar.bz2
cd broadcom-wl-4.178.10.4/linux
sudo ../../fwcutter/b43-fwcutter -w "$FIRMWARE_INSTALL_DIR" wl_apsta.o

Note that you must adjust the FIRMWARE_INSTALL_DIR path to your
distribution. The standard place where firmware is installed to is
/lib/firmware. However some distributions put firmware in a different place.


Thanks in advance
BR

-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/06fe101f/attachment.html>

From zajec5 at gmail.com  Fri Feb  5 08:45:09 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 5 Feb 2010 08:45:09 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
Message-ID: <b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>

Argh, please, use text/plain for ML!

2010/2/5 David Montero <monterod at gmail.com>
> monterod at latosca:~$ uname -r
> 2.6.31-14-generic
>
> I thing it's working with 64 bits

You can check that with uname -a. Should not make difference however.


> I thing that my card is the following:
>
> (...)
> 14e4:4315
> supported 2.6.32 and later
> BCM4312
> b/g
> LP
> b43
>
> Then, I applied the following procedure without problems and when I restarted my laptop the wifi network didn't work yet. Can you help me?

You installed (hopefully) firmware but missed "supported 2.6.32 and
later". Update your kernel.

--
Rafa?


From monterod at gmail.com  Fri Feb  5 12:06:10 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 12:06:10 +0100
Subject: b43/b43legacy driver
In-Reply-To: <b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
Message-ID: <db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>

Thanks Rafal!
I updated the kernel to 2.6.32 and it doesn't work yet.

monterod at latosca:~$ uname -a
Linux latosca 2.6.32-020632-generic #020632 SMP Thu Dec 3 10:58:45 UTC 2009
i686 GNU/Linux

After updating the kernel I have deleted the directory /lib/firmware/b43 and
I have executed again the below  procedure. After that I restarted my laptop
and it doesn't work... :-(
Can you help me, please?

You are using the b43 driver with an LP-PHY card (e.g. BCM4312)

Follow these instructions if you are using the *b43* driver from *
linux-2.6.32* and newer or *compat-wireless-2.6*, or from any current GIT
tree, and have a device with a low-power PHY.

Use the current Git version of b43-fwcutter.
Download, extract the b43-fwcutter tarball and build it:

git clone http://git.bu3sch.de/git/b43-tools.git
cd b43-tools/fwcutter
make
cd ..

Use version 4.174.64.19 of Broadcom's proprietary driver. (The tarball is
mislabeled as "4.178.10.4", but it is actually 4.174.64.19.)
Download and extract the firmware from this driver tarball:

export FIRMWARE_INSTALL_DIR="/lib/firmware"
wget http://downloads.openwrt.org/sources/broadcom-wl-4.178.10.4.tar.bz2
tar xjf broadcom-wl-4.178.10.4.tar.bz2
cd broadcom-wl-4.178.10.4/linux
sudo ../../fwcutter/b43-fwcutter -w "$FIRMWARE_INSTALL_DIR" wl_apsta.o

Note that you must adjust the FIRMWARE_INSTALL_DIR path to your
distribution. The standard place where firmware is installed to is
/lib/firmware. However some distributions put firmware in a different place.


2010/2/5 Rafa? Mi?ecki <zajec5 at gmail.com>

> Argh, please, use text/plain for ML!
>
> 2010/2/5 David Montero <monterod at gmail.com>
> > monterod at latosca:~$ uname -r
> > 2.6.31-14-generic
> >
> > I thing it's working with 64 bits
>
> You can check that with uname -a. Should not make difference however.
>
>
> > I thing that my card is the following:
> >
> > (...)
> > 14e4:4315
> > supported 2.6.32 and later
> > BCM4312
> > b/g
> > LP
> > b43
> >
> > Then, I applied the following procedure without problems and when I
> restarted my laptop the wifi network didn't work yet. Can you help me?
>
> You installed (hopefully) firmware but missed "supported 2.6.32 and
> later". Update your kernel.
>
> --
> Rafa?
>



-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/2a145108/attachment.html>

From E.A.B.Piel at tudelft.nl  Fri Feb  5 13:47:15 2010
From: E.A.B.Piel at tudelft.nl (=?UTF-8?B?w4lyaWMgUGllbA==?=)
Date: Fri, 05 Feb 2010 13:47:15 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
Message-ID: <4B6C1353.4080408@tudelft.nl>

Op 05-02-10 12:06, David Montero schreef:
> Thanks Rafal!
> I updated the kernel to 2.6.32 and it doesn't work yet.
> 
> monterod at latosca:~$ uname -a
> Linux latosca 2.6.32-020632-generic #020632 SMP Thu Dec 3 10:58:45 UTC
> 2009 i686 GNU/Linux
> 
> After updating the kernel I have deleted the directory /lib/firmware/b43
> and I have executed again the below  procedure. After that I restarted
> my laptop and it doesn't work... :-(
> Can you help me, please?
Hi,

It should be ok (although I would recommend a 2.6.33 if you have the
opportunity to find one already available). To help you further, I
recommend you provide the output of these 3 commands:

# dmesg | grep b43
# lsmod
# iwconfig

Cheers,
Eric


From zajec5 at gmail.com  Fri Feb  5 14:02:57 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 5 Feb 2010 14:02:57 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
Message-ID: <b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>

W dniu 5 lutego 2010 12:06 u?ytkownik David Montero
<monterod at gmail.com> napisa?:
> Thanks Rafal!
> I updated the kernel to 2.6.32 and it doesn't work yet.

Please, *stop* using html for your mails. Use ?ric's commands.

-- 
Rafa?


From monterod at gmail.com  Fri Feb  5 14:24:54 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 14:24:54 +0100
Subject: b43/b43legacy driver
In-Reply-To: <b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
Message-ID: <db4aab9b1002050524w2d78f59dh8f9246f098997057@mail.gmail.com>

Hi Rafal,

I am sorry, what do you mean with "*stop* using html for your mails"?
I am using my gmail account from internet, could you recommend me another
way to use it?
Thanks in advance
david

2010/2/5 Rafa? Mi?ecki <zajec5 at gmail.com>

> W dniu 5 lutego 2010 12:06 u?ytkownik David Montero
> <monterod at gmail.com> napisa?:
> > Thanks Rafal!
> > I updated the kernel to 2.6.32 and it doesn't work yet.
>
> Please, *stop* using html for your mails. Use ?ric's commands.
>
> --
> Rafa?
>



-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/cff693a8/attachment.html>

From monterod at gmail.com  Fri Feb  5 14:18:23 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 14:18:23 +0100
Subject: b43/b43legacy driver
In-Reply-To: <4B6C1353.4080408@tudelft.nl>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<4B6C1353.4080408@tudelft.nl>
Message-ID: <db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>

Hi:

I will try to install that kernel version.
Here you can find the outputs.
Thanks

monterod at latosca:/etc$ dmesg | grep b43
[    2.079698] b43-pci-bridge 0000:04:00.0: PCI INT A -> GSI 18 (level, low)
-> IRQ 18
[    2.079720] b43-pci-bridge 0000:04:00.0: setting latency timer to 6

monterod at latosca:/etc$ lsmod
Module                  Size  Used by
nls_iso8859_1           3177  2
nls_cp437               4847  2
vfat                    8713  2
fat                    46452  1 vfat
binfmt_misc             6311  1
ppdev                   5101  0
snd_hda_codec_conexant    22468  1
snd_hda_codec_intelhdmi    12779  1
snd_hda_intel          22647  2
snd_hda_codec          71914  3
snd_hda_codec_conexant,snd_hda_codec_intelhdmi,snd_hda_intel
snd_hwdep               5257  1 snd_hda_codec
snd_pcm_oss            37172  0
snd_mixer_oss          15029  1 snd_pcm_oss
snd_pcm                71804  3 snd_hda_intel,snd_hda_codec,snd_pcm_oss
bridge                 44005  0
snd_seq_dummy           1456  0
snd_seq_oss            26458  0
snd_seq_midi            4435  0
snd_rawmidi            18299  1 snd_seq_midi
stp                     1583  1 bridge
snd_seq_midi_event      5707  2 snd_seq_oss,snd_seq_midi
iptable_filter          2199  0
bnep                    9500  2
snd_seq                45535  6
snd_seq_dummy,snd_seq_oss,snd_seq_midi,snd_seq_midi_event
snd_timer              19260  2 snd_pcm,snd_seq
joydev                  8915  0
lp                      6900  0
snd_seq_device          5596  5
snd_seq_dummy,snd_seq_oss,snd_seq_midi,snd_rawmidi,snd_seq
uvcvideo               57156  0
ip_tables              10370  1 iptable_filter
videodev               36381  1 uvcvideo
snd                    53253  17
snd_hda_codec_conexant,snd_hda_codec_intelhdmi,snd_hda_intel,snd_hda_codec,snd_hwdep,snd_pcm_oss,snd_mixer_oss,snd_pcm,snd_seq_oss,snd_rawmidi,snd_seq,snd_timer,snd_seq_device
sdhci_pci               5536  0
x_tables               13791  1 ip_tables
parport                32240  2 ppdev,lp
psmouse                54168  0
v4l1_compat            13316  2 uvcvideo,videodev
soundcore               6410  1 snd
jmb38x_ms               7431  0
sdhci                  16371  1 sdhci_pci
snd_page_alloc          7108  2 snd_hda_intel,snd_pcm
led_class               2830  1 sdhci
serio_raw               3978  0
memstick                7818  1 jmb38x_ms
btusb                  10716  2
usbhid                 35312  0
fbcon                  36595  72
tileblit                1927  1 fbcon
font                    7517  1 fbcon
bitblit                 4509  1 fbcon
softcursor              1117  1 bitblit
i915                  282796  3
drm_kms_helper         26652  1 i915
drm                   153012  4 i915,drm_kms_helper
intel_agp              23625  1
i2c_algo_bit            4858  1 i915
agpgart                31758  2 drm,intel_agp
ssb                    34172  0
tg3                   112825  0
video                  17586  1 i915
output                  1799  1 video

monterod at latosca:/etc$ iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

pan0      no wireless extensions.

On 5 February 2010 13:47, ?ric Piel <E.A.B.Piel at tudelft.nl> wrote:

> Op 05-02-10 12:06, David Montero schreef:
> > Thanks Rafal!
> > I updated the kernel to 2.6.32 and it doesn't work yet.
> >
> > monterod at latosca:~$ uname -a
> > Linux latosca 2.6.32-020632-generic #020632 SMP Thu Dec 3 10:58:45 UTC
> > 2009 i686 GNU/Linux
> >
> > After updating the kernel I have deleted the directory /lib/firmware/b43
> > and I have executed again the below  procedure. After that I restarted
> > my laptop and it doesn't work... :-(
> > Can you help me, please?
> Hi,
>
> It should be ok (although I would recommend a 2.6.33 if you have the
> opportunity to find one already available). To help you further, I
> recommend you provide the output of these 3 commands:
>
> # dmesg | grep b43
> # lsmod
> # iwconfig
>
> Cheers,
> Eric
>



-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/0efc5c88/attachment.html>

From E.A.B.Piel at tudelft.nl  Fri Feb  5 14:34:37 2010
From: E.A.B.Piel at tudelft.nl (=?UTF-8?B?w4lyaWMgUGllbA==?=)
Date: Fri, 05 Feb 2010 14:34:37 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>	
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>	
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>	
	<4B6C1353.4080408@tudelft.nl>
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
Message-ID: <4B6C1E6D.3020407@tudelft.nl>

Op 05-02-10 14:18, David Montero schreef:
> Hi:
> 
> I will try to install that kernel version.
> Here you can find the outputs.
> Thanks
> 
> monterod at latosca:/etc$ dmesg | grep b43
> [    2.079698] b43-pci-bridge 0000:04:00.0: PCI INT A -> GSI 18 (level,
> low) -> IRQ 18
> [    2.079720] b43-pci-bridge 0000:04:00.0: setting latency timer to 6

Not sure why, but the b43 driver is not even tried to be loaded. (maybe
due to some black-listing in modprobe?)

David, please do a "modprobe b43" and rerun the 3 commands.

Eric


From monterod at gmail.com  Fri Feb  5 14:47:40 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 14:47:40 +0100
Subject: b43/b43legacy driver
In-Reply-To: <4B6C1E6D.3020407@tudelft.nl>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<4B6C1353.4080408@tudelft.nl>
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
	<4B6C1E6D.3020407@tudelft.nl>
Message-ID: <db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>

Hi all,

Attached are the outputs.
Now I am going to setup my gmail account in Thunderbird. I am sorry for the
inconvenients!

root at latosca:~# dmesg | grep b43
[    2.074486] b43-pci-bridge 0000:04:00.0: PCI INT A -> GSI 18 (level, low)
-> IRQ 18
[    2.074504] b43-pci-bridge 0000:04:00.0: setting latency timer to 64
[  118.548653] b43-phy0: Broadcom 4312 WLAN found (core revision 15)
[  118.659228] Registered led device: b43-phy0::tx
[  118.659267] Registered led device: b43-phy0::rx
[  118.659304] Registered led device: b43-phy0::radio
[  118.800147] b43 ssb0:0: firmware: requesting b43/ucode15.fw
[  118.858012] b43 ssb0:0: firmware: requesting b43/lp0initvals15.fw
[  118.866463] b43 ssb0:0: firmware: requesting b43/lp0bsinitvals15.fw
[  119.028134] b43-phy0: Loading firmware version 478.104 (2008-07-01
00:50:23)

root at latosca:~# lsmod
Module                  Size  Used by
arc4                    1113  2
b43                   160155  0
mac80211              169408  1 b43
cfg80211              124530  2 b43,mac80211
binfmt_misc             6311  1
ppdev                   5101  0
snd_hda_codec_conexant    22468  1
snd_hda_codec_intelhdmi    12779  1
snd_hda_intel          22647  2
snd_hda_codec          71914  3
snd_hda_codec_conexant,snd_hda_codec_intelhdmi,snd_hda_intel
snd_hwdep               5257  1 snd_hda_codec
bridge                 44005  0
snd_pcm_oss            37172  0
snd_mixer_oss          15029  1 snd_pcm_oss
snd_pcm                71804  3 snd_hda_intel,snd_hda_codec,snd_pcm_oss
stp                     1583  1 bridge
snd_seq_dummy           1456  0
bnep                    9500  2
snd_seq_oss            26458  0
snd_seq_midi            4435  0
snd_rawmidi            18299  1 snd_seq_midi
snd_seq_midi_event      5707  2 snd_seq_oss,snd_seq_midi
snd_seq                45535  6
snd_seq_dummy,snd_seq_oss,snd_seq_midi,snd_seq_midi_event
snd_timer              19260  2 snd_pcm,snd_seq
snd_seq_device          5596  5
snd_seq_dummy,snd_seq_oss,snd_seq_midi,snd_rawmidi,snd_seq
snd                    53253  17
snd_hda_codec_conexant,snd_hda_codec_intelhdmi,snd_hda_intel,snd_hda_codec,snd_hwdep,snd_pcm_oss,snd_mixer_oss,snd_pcm,snd_seq_oss,snd_rawmidi,snd_seq,snd_timer,snd_seq_device
lp                      6900  0
soundcore               6410  1 snd
joydev                  8915  0
sdhci_pci               5536  0
snd_page_alloc          7108  2 snd_hda_intel,snd_pcm
sdhci                  16371  1 sdhci_pci
iptable_filter          2199  0
parport                32240  2 ppdev,lp
led_class               2830  2 b43,sdhci
btusb                  10716  2
psmouse                54168  0
serio_raw               3978  0
uvcvideo               57156  0
videodev               36381  1 uvcvideo
v4l1_compat            13316  2 uvcvideo,videodev
ip_tables              10370  1 iptable_filter
x_tables               13791  1 ip_tables
jmb38x_ms               7431  0
memstick                7818  1 jmb38x_ms
usbhid                 35312  0
fbcon                  36595  72
tileblit                1927  1 fbcon
font                    7517  1 fbcon
bitblit                 4509  1 fbcon
softcursor              1117  1 bitblit
i915                  282796  3
drm_kms_helper         26652  1 i915
drm                   153012  4 i915,drm_kms_helper
intel_agp              23625  1
i2c_algo_bit            4858  1 i915
tg3                   112825  0
agpgart                31758  2 drm,intel_agp
ssb                    34172  1 b43
video                  17586  1 i915
output                  1799  1 video

root at latosca:~# iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

pan0      no wireless extensions.

wlan0     IEEE 802.11bg  Mode:Managed  Access Point: Not-Associated
          Tx-Power=20 dBm
          Retry  long limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:off


On 5 February 2010 14:34, ?ric Piel <E.A.B.Piel at tudelft.nl> wrote:

> Op 05-02-10 14:18, David Montero schreef:
> > Hi:
> >
> > I will try to install that kernel version.
> > Here you can find the outputs.
> > Thanks
> >
> > monterod at latosca:/etc$ dmesg | grep b43
> > [    2.079698] b43-pci-bridge 0000:04:00.0: PCI INT A -> GSI 18 (level,
> > low) -> IRQ 18
> > [    2.079720] b43-pci-bridge 0000:04:00.0: setting latency timer to 6
>
> Not sure why, but the b43 driver is not even tried to be loaded. (maybe
> due to some black-listing in modprobe?)
>
> David, please do a "modprobe b43" and rerun the 3 commands.
>
> Eric
>



-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/bcbe866b/attachment.html>

From E.A.B.Piel at tudelft.nl  Fri Feb  5 15:02:01 2010
From: E.A.B.Piel at tudelft.nl (=?UTF-8?B?w4lyaWMgUGllbA==?=)
Date: Fri, 05 Feb 2010 15:02:01 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>	
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>	
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>	
	<4B6C1353.4080408@tudelft.nl>	
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>	
	<4B6C1E6D.3020407@tudelft.nl>
	<db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>
Message-ID: <4B6C24D9.3060103@tudelft.nl>

Op 05-02-10 14:47, David Montero schreef:
> Hi all,
> 
> Attached are the outputs.
> Now I am going to setup my gmail account in Thunderbird. I am sorry for
> the inconvenients!
:
> 
> root at latosca:~# iwconfig
> lo        no wireless extensions.
> 
> eth0      no wireless extensions.
> 
> pan0      no wireless extensions.
> 
> wlan0     IEEE 802.11bg  Mode:Managed  Access Point: Not-Associated  
>           Tx-Power=20 dBm  
>           Retry  long limit:7   RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Power Management:off
> 
Ah, it looks much better! You should now be able to use the wifi (via
NetworkManager for instance) :-)

To get the driver automatically loaded, I would recommend you ask on a
community who knows more about ubuntu, I highly suspect some kind of
blacklisting in modprobe (because this hardware required the wl driver
in older kernels).

Please let us know if you succeed in connecting to your wifi network.

See you,
Eric


From gavron at wetwork.net  Fri Feb  5 14:34:59 2010
From: gavron at wetwork.net (Ehud Gavron)
Date: Fri, 05 Feb 2010 06:34:59 -0700
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050524w2d78f59dh8f9246f098997057@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
	<db4aab9b1002050524w2d78f59dh8f9246f098997057@mail.gmail.com>
Message-ID: <4B6C1E83.9060404@wetwork.net>



David Montero wrote:
> Hi Rafal,
>
> I am sorry, what do you mean with "*stop* using html for your mails"?
> I am using my gmail account from internet, could you recommend me 
> another way to use it?

Yes, stop using gmail.  Use a real mailer (thunderbird, mutt, etc.) and 
set it to use plain-text.
Bottom-post (add text on the bottom of the previous text).

It makes what you say fully readable for everyone who sees it.  Very few 
people on the developer
lists use HTML-readers.


Regards,

Ehud
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 5507 bytes
Desc: S/MIME Cryptographic Signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/75dea8a6/attachment.bin>

From monterod at gmail.com  Fri Feb  5 15:23:28 2010
From: monterod at gmail.com (David Montero)
Date: Fri, 5 Feb 2010 15:23:28 +0100
Subject: b43/b43legacy driver
In-Reply-To: <4B6C24D9.3060103@tudelft.nl>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<4B6C1353.4080408@tudelft.nl>
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
	<4B6C1E6D.3020407@tudelft.nl>
	<db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>
	<4B6C24D9.3060103@tudelft.nl>
Message-ID: <db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>

Thanks a lot!
Now It's working properly. GREAT!
Yes, you were right, it was in the blacklist. See below:

monterod at latosca:~$ more /etc/modprobe.d/blacklist-local.conf
#blacklist b43
#blacklist wl

I have commented these lines and it works.
Thanks a lot,
BR
david

On 5 February 2010 15:02, ?ric Piel <E.A.B.Piel at tudelft.nl> wrote:

> Op 05-02-10 14:47, David Montero schreef:
> > Hi all,
> >
> > Attached are the outputs.
> > Now I am going to setup my gmail account in Thunderbird. I am sorry for
> > the inconvenients!
> :
> >
> > root at latosca:~# iwconfig
> > lo        no wireless extensions.
> >
> > eth0      no wireless extensions.
> >
> > pan0      no wireless extensions.
> >
> > wlan0     IEEE 802.11bg  Mode:Managed  Access Point: Not-Associated
> >           Tx-Power=20 dBm
> >           Retry  long limit:7   RTS thr:off   Fragment thr:off
> >           Encryption key:off
> >           Power Management:off
> >
> Ah, it looks much better! You should now be able to use the wifi (via
> NetworkManager for instance) :-)
>
> To get the driver automatically loaded, I would recommend you ask on a
> community who knows more about ubuntu, I highly suspect some kind of
> blacklisting in modprobe (because this hardware required the wl driver
> in older kernels).
>
> Please let us know if you succeed in connecting to your wifi network.
>
> See you,
> Eric
>



-- 
Skype user: montero.david
E-mail: monterod at gmail.com
http://www.globalcool.org/
http://www.compartir.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/fc08360d/attachment.html>

From enhaisa at gmail.com  Fri Feb  5 15:25:02 2010
From: enhaisa at gmail.com (Daniel Kuehn)
Date: Fri, 5 Feb 2010 15:25:02 +0100
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<4B6C1353.4080408@tudelft.nl>
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
	<4B6C1E6D.3020407@tudelft.nl>
	<db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>
	<4B6C24D9.3060103@tudelft.nl>
	<db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>
Message-ID: <4247d9861002050625j2177a1c1j4fb25d4870ec37d2@mail.gmail.com>

On Fri, Feb 5, 2010 at 3:23 PM, David Montero <monterod at gmail.com> wrote:

> Thanks a lot!
> Now It's working properly. GREAT!
> Yes, you were right, it was in the blacklist. See below:
>
> monterod at latosca:~$ more /etc/modprobe.d/blacklist-local.conf
> #blacklist b43
> #blacklist wl
>
> I have commented these lines and it works.
> Thanks a lot,
> BR
> david
>
>
> On 5 February 2010 15:02, ?ric Piel <E.A.B.Piel at tudelft.nl> wrote:
>
>> Op 05-02-10 14:47, David Montero schreef:
>> > Hi all,
>> >
>> > Attached are the outputs.
>> > Now I am going to setup my gmail account in Thunderbird. I am sorry for
>> > the inconvenients!
>> :
>> >
>> > root at latosca:~# iwconfig
>> > lo        no wireless extensions.
>> >
>> > eth0      no wireless extensions.
>> >
>> > pan0      no wireless extensions.
>> >
>> > wlan0     IEEE 802.11bg  Mode:Managed  Access Point: Not-Associated
>> >           Tx-Power=20 dBm
>> >           Retry  long limit:7   RTS thr:off   Fragment thr:off
>> >           Encryption key:off
>> >           Power Management:off
>> >
>> Ah, it looks much better! You should now be able to use the wifi (via
>> NetworkManager for instance) :-)
>>
>> To get the driver automatically loaded, I would recommend you ask on a
>> community who knows more about ubuntu, I highly suspect some kind of
>> blacklisting in modprobe (because this hardware required the wl driver
>> in older kernels).
>>
>> Please let us know if you succeed in connecting to your wifi network.
>>
>> See you,
>> Eric
>>
>
>
>
> --
> Skype user: montero.david
> E-mail: monterod at gmail.com
> http://www.globalcool.org/
> http://www.compartir.org/
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
> 2010/2/5 Ehud Gavron <gavron at wetwork.net>

> - Show quoted text -
>
>
> David Montero wrote:
>
>> Hi Rafal,
>>
>> I am sorry, what do you mean with "*stop* using html for your mails"?
>> I am using my gmail account from internet, could you recommend me another
>> way to use it?
>>
>
> Yes, stop using gmail.  Use a real mailer (thunderbird, mutt, etc.) and set
> it to use plain-text.
> Bottom-post (add text on the bottom of the previous text).
>
> It makes what you say fully readable for everyone who sees it.  Very few
> people on the developer
> lists use HTML-readers.
>
>
> Regards,
>
> Ehud
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
There is an option in gmail to tell it to send the mails as plain-text too.
That is what I use, it should be in the first tab that is opened when you go
to settings.

Regards,
Daniel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100205/db92bb5c/attachment.html>

From gene.heskett at verizon.net  Fri Feb  5 15:48:04 2010
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 05 Feb 2010 09:48:04 -0500
Subject: b43/b43legacy driver
In-Reply-To: <b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
Message-ID: <201002050948.04485.gene.heskett@verizon.net>

On Friday 05 February 2010, Rafa? Mi?ecki wrote:
>W dniu 5 lutego 2010 12:06 u?ytkownik David Montero
>
><monterod at gmail.com> napisa?:
>> Thanks Rafal!
>> I updated the kernel to 2.6.32 and it doesn't work yet.
>
>Please, *stop* using html for your mails. Use ?ric's commands.
>
While I took the time to look, there is a plain text component which kmail is 
showing me, in Davids msgs, and to see the html, I have to specifically click 
on that line in the automatic mime report kmail gives me.

Perhaps its one of your own prefs that mixed up?

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)

Things are more like they used to be than they are now.


From gene.heskett at verizon.net  Fri Feb  5 15:56:19 2010
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 05 Feb 2010 09:56:19 -0500
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050524w2d78f59dh8f9246f098997057@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
	<db4aab9b1002050524w2d78f59dh8f9246f098997057@mail.gmail.com>
Message-ID: <201002050956.19268.gene.heskett@verizon.net>

On Friday 05 February 2010, David Montero wrote:
>Hi Rafal,
>
>I am sorry, what do you mean with "*stop* using html for your mails"?
>I am using my gmail account from internet, could you recommend me another
>way to use it?
>Thanks in advance
>david
>
You are actually sending both plain text and an html version of it, and 
unless I click on the html line in the mime report window kmail opens when 
the msgs has different mimetype sections, I do not see the html.
If I can copy/paste from that little window your msg has the following parts:

And no, it won't let me copy it.  But there are 2 copies of the plain text, 
and one copy of the html'd version.

>2010/2/5 Rafa? Mi?ecki <zajec5 at gmail.com>
>
>> W dniu 5 lutego 2010 12:06 u?ytkownik David Montero
>>
>> <monterod at gmail.com> napisa?:
>> > Thanks Rafal!
>> > I updated the kernel to 2.6.32 and it doesn't work yet.
>>
>> Please, *stop* using html for your mails. Use ?ric's commands.
>>
>> --
>> Rafa?
>


-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)

Things are more like they used to be than they are now.


From Larry.Finger at lwfinger.net  Fri Feb  5 16:57:36 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Feb 2010 09:57:36 -0600
Subject: b43/b43legacy driver
In-Reply-To: <201002050948.04485.gene.heskett@verizon.net>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>	<b170af451002050502n406fc6cbm8df7ea953dda1e5@mail.gmail.com>
	<201002050948.04485.gene.heskett@verizon.net>
Message-ID: <4B6C3FF0.1040600@lwfinger.net>

On 02/05/2010 08:48 AM, Gene Heskett wrote:
> While I took the time to look, there is a plain text component which kmail is 
> showing me, in Davids msgs, and to see the html, I have to specifically click 
> on that line in the automatic mime report kmail gives me.
> 
> Perhaps its one of your own prefs that mixed up?

That does not matter. The HTML version should not be on the lists! Period!!

Larry


From Larry.Finger at lwfinger.net  Fri Feb  5 17:00:45 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Feb 2010 10:00:45 -0600
Subject: b43/b43legacy driver
In-Reply-To: <db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>	<4B6C1353.4080408@tudelft.nl>	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>	<4B6C1E6D.3020407@tudelft.nl>	<db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>	<4B6C24D9.3060103@tudelft.nl>
	<db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>
Message-ID: <4B6C40AD.9000602@lwfinger.net>

On 02/05/2010 08:23 AM, David Montero wrote:
> Thanks a lot!
> Now It's working properly. GREAT!
> Yes, you were right, it was in the blacklist. See below:
> 
> monterod at latosca:~$ more /etc/modprobe.d/blacklist-local.conf
> #blacklist b43
> #blacklist wl
> 
> I have commented these lines and it works.

You should have left the blacklist on wl. It and b43 are mutually incompatible.

You are still top posting! Please stop.

A. Because it interferes with the way that people normally read and process
information.

Q. Why is top posting wrong?

Larry



From netrolller.3d at gmail.com  Fri Feb  5 17:27:25 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 17:27:25 +0100
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel 
	switch
In-Reply-To: <4B6B8F8B.6020908@lwfinger.net>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com> 
	<4B6B8F8B.6020908@lwfinger.net>
Message-ID: <69e28c911002050827x63aa5d3cjda82d8c7a643fd82@mail.gmail.com>

On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>> ---
>> G??bor: I think you missed specs here. Could you check whole routine just for
>> sure, please? I don't understand whole radio and chanspec magic yet.
>> ---
>> ?drivers/net/wireless/b43/phy_lp.c | ? ?2 +-
>> ?1 files changed, 1 insertions(+), 1 deletions(-)
>>
>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>> index 185219e..61009ee 100644
>> --- a/drivers/net/wireless/b43/phy_lp.c
>> +++ b/drivers/net/wireless/b43/phy_lp.c
>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>> ? ? ? ? ? ? ? if (err)
>> ? ? ? ? ? ? ? ? ? ? ? return err;
>> ? ? ? ? ? ? ? lpphy_set_analog_filter(dev, new_channel);
>> - ? ? ? ? ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>> ? ? ? }
>> + ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>
>> ? ? ? lpphy->channel = new_channel;
>> ? ? ? b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>
> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
> outside the if statement. I changed the spec a little. It used to test "radio
> enabled", but I have found that is always true for our driver.
>
> Larry
>
>

Isn't set_analog_filter() rev0/1-specific?

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb  5 17:41:00 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 17:41:00 +0100
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel 
	switch
In-Reply-To: <4B6B8F8B.6020908@lwfinger.net>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com> 
	<4B6B8F8B.6020908@lwfinger.net>
Message-ID: <69e28c911002050841x20053c6jbe768c19e983ef50@mail.gmail.com>

On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>> ---
>> G??bor: I think you missed specs here. Could you check whole routine just for
>> sure, please? I don't understand whole radio and chanspec magic yet.
>> ---
>> ?drivers/net/wireless/b43/phy_lp.c | ? ?2 +-
>> ?1 files changed, 1 insertions(+), 1 deletions(-)
>>
>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>> index 185219e..61009ee 100644
>> --- a/drivers/net/wireless/b43/phy_lp.c
>> +++ b/drivers/net/wireless/b43/phy_lp.c
>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>> ? ? ? ? ? ? ? if (err)
>> ? ? ? ? ? ? ? ? ? ? ? return err;
>> ? ? ? ? ? ? ? lpphy_set_analog_filter(dev, new_channel);
>> - ? ? ? ? ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>> ? ? ? }
>> + ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>
>> ? ? ? lpphy->channel = new_channel;
>> ? ? ? b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>
> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
> outside the if statement. I changed the spec a little. It used to test "radio
> enabled", but I have found that is always true for our driver.
>
> Larry
>
>

Isn't set_analog_filter() rev0/1-specific?

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb  5 18:34:14 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 18:34:14 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
In-Reply-To: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
References: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
Message-ID: <69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com>

2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> ?drivers/net/wireless/b43/phy_n.c | ? ?4 ++++
> ?1 files changed, 4 insertions(+), 0 deletions(-)
>
> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
> index 074b34c..795bb1e 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
> ? ? ? ?}
>
> ? ? ? ?samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
> + ? ? ? if (!samples) {
> + ? ? ? ? ? ? ? b43err(dev->wl, "allocation for samples generation failed\n");
> + ? ? ? ? ? ? ? return 0;

return -ENOMEM;

> + ? ? ? }
> ? ? ? ?rot = (((freq * 36) / bw) << 16) / 100;
> ? ? ? ?angle = 0;
>
> --
> 1.6.4.2
>
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb  5 18:34:14 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 18:34:14 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
In-Reply-To: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
References: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
Message-ID: <69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com>

2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
> ?drivers/net/wireless/b43/phy_n.c | ? ?4 ++++
> ?1 files changed, 4 insertions(+), 0 deletions(-)
>
> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
> index 074b34c..795bb1e 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
> ? ? ? ?}
>
> ? ? ? ?samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
> + ? ? ? if (!samples) {
> + ? ? ? ? ? ? ? b43err(dev->wl, "allocation for samples generation failed\n");
> + ? ? ? ? ? ? ? return 0;

return -ENOMEM;

> + ? ? ? }
> ? ? ? ?rot = (((freq * 36) / bw) << 16) / 100;
> ? ? ? ?angle = 0;
>
> --
> 1.6.4.2
>
> --
> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
> the body of a message to majordomo at vger.kernel.org
> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Feb  5 19:09:55 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Feb 2010 12:09:55 -0600
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel
	switch
In-Reply-To: <69e28c911002050841x20053c6jbe768c19e983ef50@mail.gmail.com>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com>
	<4B6B8F8B.6020908@lwfinger.net>
	<69e28c911002050841x20053c6jbe768c19e983ef50@mail.gmail.com>
Message-ID: <4B6C5EF3.5060006@lwfinger.net>

On 02/05/2010 10:41 AM, G?bor Stefanik wrote:
> On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>>> ---
>>> G??bor: I think you missed specs here. Could you check whole routine just for
>>> sure, please? I don't understand whole radio and chanspec magic yet.
>>> ---
>>>  drivers/net/wireless/b43/phy_lp.c |    2 +-
>>>  1 files changed, 1 insertions(+), 1 deletions(-)
>>>
>>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>>> index 185219e..61009ee 100644
>>> --- a/drivers/net/wireless/b43/phy_lp.c
>>> +++ b/drivers/net/wireless/b43/phy_lp.c
>>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>>>               if (err)
>>>                       return err;
>>>               lpphy_set_analog_filter(dev, new_channel);
>>> -             lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>       }
>>> +     lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>
>>>       lpphy->channel = new_channel;
>>>       b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>>
>> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
>> outside the if statement. I changed the spec a little. It used to test "radio
>> enabled", but I have found that is always true for our driver.
>>
>> Larry
>>
>>
> 
> Isn't set_analog_filter() rev0/1-specific?

It was in the 4.174.64.19 driver that I RE'd when you wrote the LP PHY code.
That as changed in 5.10.56.46, which I am now doing. It will take me a while to
complete the new routine "LP PHY TX Filter Init" and a routine that it calls.

Certainly, there is no hurry that these changes be made. Whenever you or Rafa?
have time. There is no guarantee that these changes will have any effect on the
LP PHY operations. Hitting a moving target is not easy.

Larry







From netrolller.3d at gmail.com  Fri Feb  5 19:46:17 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 19:46:17 +0100
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel 
	switch
In-Reply-To: <4B6C5EF3.5060006@lwfinger.net>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com> 
	<4B6B8F8B.6020908@lwfinger.net>
	<69e28c911002050841x20053c6jbe768c19e983ef50@mail.gmail.com> 
	<4B6C5EF3.5060006@lwfinger.net>
Message-ID: <69e28c911002051046s64c69462k9a43bcb1db704476@mail.gmail.com>

On Fri, Feb 5, 2010 at 7:09 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 02/05/2010 10:41 AM, G?bor Stefanik wrote:
>> On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>>> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>>>> ---
>>>> G??bor: I think you missed specs here. Could you check whole routine just for
>>>> sure, please? I don't understand whole radio and chanspec magic yet.
>>>> ---
>>>> ?drivers/net/wireless/b43/phy_lp.c | ? ?2 +-
>>>> ?1 files changed, 1 insertions(+), 1 deletions(-)
>>>>
>>>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>>>> index 185219e..61009ee 100644
>>>> --- a/drivers/net/wireless/b43/phy_lp.c
>>>> +++ b/drivers/net/wireless/b43/phy_lp.c
>>>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>>>> ? ? ? ? ? ? ? if (err)
>>>> ? ? ? ? ? ? ? ? ? ? ? return err;
>>>> ? ? ? ? ? ? ? lpphy_set_analog_filter(dev, new_channel);
>>>> - ? ? ? ? ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>> ? ? ? }
>>>> + ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>>
>>>> ? ? ? lpphy->channel = new_channel;
>>>> ? ? ? b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>>>
>>> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
>>> outside the if statement. I changed the spec a little. It used to test "radio
>>> enabled", but I have found that is always true for our driver.
>>>
>>> Larry
>>>
>>>
>>
>> Isn't set_analog_filter() rev0/1-specific?
>
> It was in the 4.174.64.19 driver that I RE'd when you wrote the LP PHY code.
> That as changed in 5.10.56.46, which I am now doing. It will take me a while to
> complete the new routine "LP PHY TX Filter Init" and a routine that it calls.
>
> Certainly, there is no hurry that these changes be made. Whenever you or Rafa?
> have time. There is no guarantee that these changes will have any effect on the
> LP PHY operations. Hitting a moving target is not easy.
>
> Larry
>

Just out of curiosity, is 5.10.56.46 available anywhere (for firmware reasons)?

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Feb  5 20:19:50 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Feb 2010 13:19:50 -0600
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel
	switch
In-Reply-To: <69e28c911002051046s64c69462k9a43bcb1db704476@mail.gmail.com>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com>
	<4B6B8F8B.6020908@lwfinger.net>
	<69e28c911002050841x20053c6jbe768c19e983ef50@mail.gmail.com>
	<4B6C5EF3.5060006@lwfinger.net>
	<69e28c911002051046s64c69462k9a43bcb1db704476@mail.gmail.com>
Message-ID: <4B6C6F56.2060401@lwfinger.net>

On 02/05/2010 12:46 PM, G?bor Stefanik wrote:
> On Fri, Feb 5, 2010 at 7:09 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>> On 02/05/2010 10:41 AM, G?bor Stefanik wrote:
>>> On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>>>> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>>>>> ---
>>>>> G??bor: I think you missed specs here. Could you check whole routine just for
>>>>> sure, please? I don't understand whole radio and chanspec magic yet.
>>>>> ---
>>>>>  drivers/net/wireless/b43/phy_lp.c |    2 +-
>>>>>  1 files changed, 1 insertions(+), 1 deletions(-)
>>>>>
>>>>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>>>>> index 185219e..61009ee 100644
>>>>> --- a/drivers/net/wireless/b43/phy_lp.c
>>>>> +++ b/drivers/net/wireless/b43/phy_lp.c
>>>>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>>>>>               if (err)
>>>>>                       return err;
>>>>>               lpphy_set_analog_filter(dev, new_channel);
>>>>> -             lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>>>       }
>>>>> +     lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>>>
>>>>>       lpphy->channel = new_channel;
>>>>>       b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>>>>
>>>> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
>>>> outside the if statement. I changed the spec a little. It used to test "radio
>>>> enabled", but I have found that is always true for our driver.
>>>>
>>>> Larry
>>>>
>>>>
>>>
>>> Isn't set_analog_filter() rev0/1-specific?
>>
>> It was in the 4.174.64.19 driver that I RE'd when you wrote the LP PHY code.
>> That as changed in 5.10.56.46, which I am now doing. It will take me a while to
>> complete the new routine "LP PHY TX Filter Init" and a routine that it calls.
>>
>> Certainly, there is no hurry that these changes be made. Whenever you or Rafa?
>> have time. There is no guarantee that these changes will have any effect on the
>> LP PHY operations. Hitting a moving target is not easy.
>>
>> Larry
>>
> 
> Just out of curiosity, is 5.10.56.46 available anywhere (for firmware reasons)?

I'm not sure what the driver version is, but a file with 508 ucode dated 6/26/09
is found at:

http://www.linksysbycisco.com/gpl/wrt610n_v2.00.00.05_us.tar.gz

The binaries are in directory wrt610n_v2.00.00.05_us/release/src/wl/linux/. I
used Daniel Lenski's script names b43_fwcutter.py can extract the firmware from
wl_apsta.o. Included are ucode_2w20 - Rev 20 802.11 cores have an SSLPN PHY.

I'm still looking for a file with 5XX firmware that is not a huge download. This
file contains everything needed to build the firmware for a WRT610N AP and is
356 MB. If anyone knows of a smaller file, please let me know.

Larry


From zajec5 at gmail.com  Fri Feb  5 21:31:20 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 5 Feb 2010 21:31:20 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
In-Reply-To: <69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com>
References: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
	<69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com>
Message-ID: <b170af451002051231xefa1c28p9549db5d4ce48204@mail.gmail.com>

W dniu 5 lutego 2010 18:34 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_n.c | ? ?4 ++++
>> ?1 files changed, 4 insertions(+), 0 deletions(-)
>>
>> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
>> index 074b34c..795bb1e 100644
>> --- a/drivers/net/wireless/b43/phy_n.c
>> +++ b/drivers/net/wireless/b43/phy_n.c
>> @@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
>> ? ? ? ?}
>>
>> ? ? ? ?samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
>> + ? ? ? if (!samples) {
>> + ? ? ? ? ? ? ? b43err(dev->wl, "allocation for samples generation failed\n");
>> + ? ? ? ? ? ? ? return 0;
>
> return -ENOMEM;

Function was somehow designed to return unsigned only. Returning 0
means error (see place where we call b43_nphy_gen_load_samples, we
check result for 0 there.

Is that OK then?

>> + ? ? ? }
>> ? ? ? ?rot = (((freq * 36) / bw) << 16) / 100;
>> ? ? ? ?angle = 0;
>>
>> --
>> 1.6.4.2
>>
>> --
>> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
>> the body of a message to majordomo at vger.kernel.org
>> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>>
>
>
>
> --
> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>



-- 
Rafa?


From netrolller.3d at gmail.com  Fri Feb  5 22:38:19 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 5 Feb 2010 22:38:19 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
In-Reply-To: <b170af451002051231xefa1c28p9549db5d4ce48204@mail.gmail.com>
References: <1265285514-28798-2-git-send-email-zajec5@gmail.com> 
	<69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com> 
	<b170af451002051231xefa1c28p9549db5d4ce48204@mail.gmail.com>
Message-ID: <69e28c911002051338q652041c1md1dd4001050f2be1@mail.gmail.com>

2010/2/5 Rafa? Mi?ecki <zajec5 at gmail.com>:
> W dniu 5 lutego 2010 18:34 u?ytkownik G?bor Stefanik
> <netrolller.3d at gmail.com> napisa?:
>> 2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>> ---
>>> ?drivers/net/wireless/b43/phy_n.c | ? ?4 ++++
>>> ?1 files changed, 4 insertions(+), 0 deletions(-)
>>>
>>> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
>>> index 074b34c..795bb1e 100644
>>> --- a/drivers/net/wireless/b43/phy_n.c
>>> +++ b/drivers/net/wireless/b43/phy_n.c
>>> @@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
>>> ? ? ? ?}
>>>
>>> ? ? ? ?samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
>>> + ? ? ? if (!samples) {
>>> + ? ? ? ? ? ? ? b43err(dev->wl, "allocation for samples generation failed\n");
>>> + ? ? ? ? ? ? ? return 0;
>>
>> return -ENOMEM;
>
> Function was somehow designed to return unsigned only. Returning 0
> means error (see place where we call b43_nphy_gen_load_samples, we
> check result for 0 there.
>
> Is that OK then?

In that case, OK - I thought this could be passed up to userspace handlers.

>
>>> + ? ? ? }
>>> ? ? ? ?rot = (((freq * 36) / bw) << 16) / 100;
>>> ? ? ? ?angle = 0;
>>>
>>> --
>>> 1.6.4.2
>>>
>>> --
>>> To unsubscribe from this list: send the line "unsubscribe linux-wireless" in
>>> the body of a message to majordomo at vger.kernel.org
>>> More majordomo info at ?http://vger.kernel.org/majordomo-info.html
>>>
>>
>>
>>
>> --
>> Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
>>
>
>
>
> --
> Rafa?
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Fri Feb  5 23:24:24 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 5 Feb 2010 23:24:24 +0100
Subject: [PATCH] b43: N-PHY: handle allocation fail in samples generation
In-Reply-To: <69e28c911002051338q652041c1md1dd4001050f2be1@mail.gmail.com>
References: <1265285514-28798-2-git-send-email-zajec5@gmail.com>
	<69e28c911002050934p1a2f587fo863b4896e553f2c3@mail.gmail.com>
	<b170af451002051231xefa1c28p9549db5d4ce48204@mail.gmail.com>
	<69e28c911002051338q652041c1md1dd4001050f2be1@mail.gmail.com>
Message-ID: <b170af451002051424y446dde31m494830ad8e19b03e@mail.gmail.com>

W dniu 5 lutego 2010 22:38 u?ytkownik G?bor Stefanik
<netrolller.3d at gmail.com> napisa?:
> 2010/2/5 Rafa? Mi?ecki <zajec5 at gmail.com>:
>> W dniu 5 lutego 2010 18:34 u?ytkownik G?bor Stefanik
>> <netrolller.3d at gmail.com> napisa?:
>>> 2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>>>> ---
>>>> ?drivers/net/wireless/b43/phy_n.c | ? ?4 ++++
>>>> ?1 files changed, 4 insertions(+), 0 deletions(-)
>>>>
>>>> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
>>>> index 074b34c..795bb1e 100644
>>>> --- a/drivers/net/wireless/b43/phy_n.c
>>>> +++ b/drivers/net/wireless/b43/phy_n.c
>>>> @@ -1069,6 +1069,10 @@ static u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,
>>>> ? ? ? ?}
>>>>
>>>> ? ? ? ?samples = kzalloc(len * sizeof(struct b43_c32), GFP_KERNEL);
>>>> + ? ? ? if (!samples) {
>>>> + ? ? ? ? ? ? ? b43err(dev->wl, "allocation for samples generation failed\n");
>>>> + ? ? ? ? ? ? ? return 0;
>>>
>>> return -ENOMEM;
>>
>> Function was somehow designed to return unsigned only. Returning 0
>> means error (see place where we call b43_nphy_gen_load_samples, we
>> check result for 0 there.
>>
>> Is that OK then?
>
> In that case, OK - I thought this could be passed up to userspace handlers.

Thanks for review :)

-- 
Rafa?


From Larry.Finger at lwfinger.net  Sat Feb  6 01:06:05 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Feb 2010 18:06:05 -0600
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel
	switch
In-Reply-To: <69e28c911002050827x63aa5d3cjda82d8c7a643fd82@mail.gmail.com>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com>
	<4B6B8F8B.6020908@lwfinger.net>
	<69e28c911002050827x63aa5d3cjda82d8c7a643fd82@mail.gmail.com>
Message-ID: <4B6CB26D.9040002@lwfinger.net>

On 02/05/2010 10:27 AM, G?bor Stefanik wrote:
> On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>>> ---
>>> G??bor: I think you missed specs here. Could you check whole routine just for
>>> sure, please? I don't understand whole radio and chanspec magic yet.
>>> ---
>>>  drivers/net/wireless/b43/phy_lp.c |    2 +-
>>>  1 files changed, 1 insertions(+), 1 deletions(-)
>>>
>>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>>> index 185219e..61009ee 100644
>>> --- a/drivers/net/wireless/b43/phy_lp.c
>>> +++ b/drivers/net/wireless/b43/phy_lp.c
>>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>>>               if (err)
>>>                       return err;
>>>               lpphy_set_analog_filter(dev, new_channel);
>>> -             lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>       }
>>> +     lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>
>>>       lpphy->channel = new_channel;
>>>       b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>>
>> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
>> outside the if statement. I changed the spec a little. It used to test "radio
>> enabled", but I have found that is always true for our driver.
>>
>> Larry
>>
>>
> 
> Isn't set_analog_filter() rev0/1-specific?

The new routines are described in

http://bcm-v4.sipsolutions.net/802.11/PHY/LP/TxFilterInit

http://bcm-v4.sipsolutions.net/802.11/PHY/LP/TxDigFiltUcodeRev2

The revised routines are:

http://bcm-v4.sipsolutions.net/802.11/PHY/LP/SetChanSpecLPPHY

http://bcm-v4.sipsolutions.net/802.11/PHY/LP/PR41573

Larry



From info at lategoodbye.de  Sat Feb  6 11:24:37 2010
From: info at lategoodbye.de (Stefan Wahren)
Date: Sat, 06 Feb 2010 11:24:37 +0100
Subject: skb_over_panic from b43 after a few hours
Message-ID: <4B6D4365.2040803@lategoodbye.de>

Hi,

i'm using OpenWRT on an ASUS WL-500gP V2 with the built-in Broadcom
BCM3302. After a few hours the b43 driver crashes with a skb_over_panic
and i need to reboot the device. The crash happend also, if there is no
traffic over the wireless interface. The wireless interface is
configured in AP mode and the encryption psk2.

The used kernel (Linux OpenWrt 2.6.30.10 #1 Tue Feb 2 01:15:42 CET 2010
mips GNU/Linux) throws the following output:

skb_over_panic: text:80c9a8e4 len:2374 put:2374 head:80e79000
data:80e79040 tail:0x80e79986 end:0x80e79980 dev:<NULL>
Kernel bug detected[#1]:
Cpu 0
$ 0   : 00000000 1000f800 00000079 00000001
$ 4   : 802880c0 0000271f ffffffff 0000271f
$ 8   : 00004000 00000000 802959b0 00000001
$12   : 0000000f 8022a1d0 ffffffff 7ffb537b
$16   : 00e79040 80e79040 00000928 80e9a9a0
$20   : 80d84c80 00000019 a0df7190 80ca1518
$24   : 00000002 80151108
$28   : 80ea0000 80ea1e60 0000001b 8018c2d4
Hi    : 00000000
Lo    : 00000077
epc   : 8018c2d4 skb_put+0x74/0x90
    Not tainted
ra    : 8018c2d4 skb_put+0x74/0x90
Status: 1000f803    KERNEL EXL IE
Cause : 00800024
PrId  : 00029029 (Broadcom BCM3302)
Modules linked in: pl2303 option ftdi_sio usb_storage usbserial ohci_hcd
nf_nat_
tftp nf_conntrack_tftp nf_nat_irc nf_conntrack_irc nf_nat_ftp
nf_conntrack_ftp i
pt_MASQUERADE iptable_nat nf_nat xt_NOTRACK iptable_raw xt_state
nf_conntrack_ip
v4 nf_defrag_ipv4 nf_conntrack ehci_hcd sd_mod pppoe pppox ipt_REJECT
xt_TCPMSS
          ipt_LOG xt_multiport xt_mac xt_limit iptable_mangle
iptable_filter ip_tables xt_
                            tcpudp x_tables ext2 ext3 jbd tun ppp_async
ppp_generic slhc vfat fat b43 nls_ut
                                    f8 nls_iso8859_15 nls_iso8859_1
nls_cp850 nls_cp437 usbcore scsi_mod nls_base ma
                                                c80211 cfg80211
compat_firmware_class compat crc_ccitt arc4 aes_generic deflate
                                                                ecb cbc
switch_robo switch_core diag
Process compirq/5-b43 (pid: 812, threadinfo=80ea0000, task=81f19188,
tls=0000000
           0)
Stack : 00000000 80c9a8e4 00000946 00000946 80e79000 80e79040 80e79986
80e79980
        80266f84 80d84c80 00000019 80c9a8e4 80287b88 80286170 1000f800
ffff00fe
        80ea1fe0 0000f800 80d92d2c 80284000 80ca1518 7f816db4 00010000
80c7f400
        00008000 00010000 fffffffc 802c7860 00010000 fffffffe efffffff
80c87420
        81f19188 80c80000 80e9ee08 8001c63c 80ea0000 80ea1f18 8021db88
00000000
        ...
Call Trace:
[<8018c2d4>] skb_put+0x74/0x90
[<80c9a8e4>] b43_dma_rx+0x338/0x444 [b43]
[<80c87420>] b43_controller_restart+0x7a0/0x974 [b43]


Code: afab001c  0c00268d  afa20020 <0200000d> 080630b6  00000000
8fbf002c  0120
              1021  03e00008
Disabling lock debugging due to kernel taint


Stefan


From netrolller.3d at gmail.com  Sat Feb  6 20:24:16 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 6 Feb 2010 20:24:16 +0100
Subject: [RFC][PATCH] b43: LP-PHY: always adjust gain table on channel 
	switch
In-Reply-To: <4B6CB26D.9040002@lwfinger.net>
References: <1265317065-2922-2-git-send-email-zajec5@gmail.com> 
	<4B6B8F8B.6020908@lwfinger.net>
	<69e28c911002050827x63aa5d3cjda82d8c7a643fd82@mail.gmail.com> 
	<4B6CB26D.9040002@lwfinger.net>
Message-ID: <69e28c911002061124n76890459w821b783ed02cc04c@mail.gmail.com>

On Sat, Feb 6, 2010 at 1:06 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 02/05/2010 10:27 AM, G?bor Stefanik wrote:
>> On Fri, Feb 5, 2010 at 4:24 AM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
>>> On 02/04/2010 02:57 PM, Rafa? Mi?ecki wrote:
>>>> ---
>>>> G??bor: I think you missed specs here. Could you check whole routine just for
>>>> sure, please? I don't understand whole radio and chanspec magic yet.
>>>> ---
>>>> ?drivers/net/wireless/b43/phy_lp.c | ? ?2 +-
>>>> ?1 files changed, 1 insertions(+), 1 deletions(-)
>>>>
>>>> diff --git a/drivers/net/wireless/b43/phy_lp.c b/drivers/net/wireless/b43/phy_lp.c
>>>> index 185219e..61009ee 100644
>>>> --- a/drivers/net/wireless/b43/phy_lp.c
>>>> +++ b/drivers/net/wireless/b43/phy_lp.c
>>>> @@ -2655,8 +2655,8 @@ static int b43_lpphy_op_switch_channel(struct b43_wldev *dev,
>>>> ? ? ? ? ? ? ? if (err)
>>>> ? ? ? ? ? ? ? ? ? ? ? return err;
>>>> ? ? ? ? ? ? ? lpphy_set_analog_filter(dev, new_channel);
>>>> - ? ? ? ? ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>> ? ? ? }
>>>> + ? ? lpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));
>>>>
>>>> ? ? ? lpphy->channel = new_channel;
>>>> ? ? ? b43_write16(dev, B43_MMIO_CHANNEL, new_channel);
>>>
>>> Both the lpphy_set_analog_filter() and lpphy_adjust_gain_table() calls should be
>>> outside the if statement. I changed the spec a little. It used to test "radio
>>> enabled", but I have found that is always true for our driver.
>>>
>>> Larry
>>>
>>>
>>
>> Isn't set_analog_filter() rev0/1-specific?
>
> The new routines are described in
>
> http://bcm-v4.sipsolutions.net/802.11/PHY/LP/TxFilterInit
>
> http://bcm-v4.sipsolutions.net/802.11/PHY/LP/TxDigFiltUcodeRev2
>
> The revised routines are:
>
> http://bcm-v4.sipsolutions.net/802.11/PHY/LP/SetChanSpecLPPHY
>
> http://bcm-v4.sipsolutions.net/802.11/PHY/LP/PR41573
>
> Larry
>
>

Note to implementors: Chanspec is broadcrap, please do NOT use in b43.
Use a struct if you need the extra parameters contained in chanspec.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From strk at keybit.net  Sat Feb  6 20:11:04 2010
From: strk at keybit.net (strk)
Date: Sat, 6 Feb 2010 20:11:04 +0100
Subject: test
Message-ID: <20100206191104.GT48563@keybit.net>

Is it me or this list is misconfigured ?

--srrk;


From strk at keybit.net  Sat Feb  6 20:08:37 2010
From: strk at keybit.net (strk)
Date: Sat, 6 Feb 2010 20:08:37 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
Message-ID: <20100206190837.GR48563@keybit.net>

Hi everybody,
my excuses in advance for asking something which was likely
asked a lot more in the past.

I just switched to usin b43legacy from bmcxxx (from linux 2.6.18
to linux 2.6.26) and am having some problems with the wireless
card. In particular I continually get disable-enable messages:

Feb  6 20:01:21 xtops kernel: [ 4910.000194] b43legacy-phy3: Radio hardware
status changed to ENABLED
Feb  6 20:01:46 xtops kernel: [ 4935.000441] __ratelimit: 3 messages suppressed
Feb  6 20:01:46 xtops kernel: [ 4935.000458] b43legacy-phy3: Radio hardware
status changed to DISABLED

Sometimes this results in a disconnection.

# lspci | grep Network
00:0c.0 Network controller: Broadcom Corporation BCM4303 802.11b Wireless LAN
Controller (rev 02)
# uname -r
2.6.26-2-686
# b43-fwcutter --version
b43-fwcutter version 011

The machine is an Asus L5800C laptop.

Any hint on how to further debug or fix ?
Thanks in advance.

--strk;

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From strk at keybit.net  Sat Feb  6 20:09:26 2010
From: strk at keybit.net (strk)
Date: Sat, 6 Feb 2010 20:09:26 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
Message-ID: <20100206190926.GS48563@keybit.net>

Hi everybody,
my excuses in advance for asking something which was likely
asked a lot more in the past.

I just switched to usin b43legacy from bmcxxx (from linux 2.6.18
to linux 2.6.26) and am having some problems with the wireless
card. In particular I continually get disable-enable messages:

Feb  6 20:01:21 xtops kernel: [ 4910.000194] b43legacy-phy3: Radio hardware
status changed to ENABLED
Feb  6 20:01:46 xtops kernel: [ 4935.000441] __ratelimit: 3 messages suppressed
Feb  6 20:01:46 xtops kernel: [ 4935.000458] b43legacy-phy3: Radio hardware
status changed to DISABLED

Sometimes this results in a disconnection.

# lspci | grep Network
00:0c.0 Network controller: Broadcom Corporation BCM4303 802.11b Wireless LAN
Controller (rev 02)
# uname -r
2.6.26-2-686
# b43-fwcutter --version
b43-fwcutter version 011

The machine is an Asus L5800C laptop.

Any hint on how to further debug or fix ?
Thanks in advance.

--strk;

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From netrolller.3d at gmail.com  Sat Feb  6 20:41:04 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 6 Feb 2010 20:41:04 +0100
Subject: test
In-Reply-To: <20100206191104.GT48563@keybit.net>
References: <20100206191104.GT48563@keybit.net>
Message-ID: <69e28c911002061141y6f475e0p1292428b1784edac@mail.gmail.com>

Why would it be misconfigured?

On Sat, Feb 6, 2010 at 8:11 PM, strk <strk at keybit.net> wrote:
> Is it me or this list is misconfigured ?
>
> --srrk;
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From smpuj at bk.ru  Sat Feb  6 20:54:47 2010
From: smpuj at bk.ru (Orivej Desh)
Date: Sat, 6 Feb 2010 22:54:47 +0300
Subject: BCM4311/02 ABG disconnects on 2.6.32
In-Reply-To: <4B68FF7A.8080108@lwfinger.net>
References: <20091226190129.GA20638@garlic> <201001291205.36942.smpuj@bk.ru>
	<4B68FF7A.8080108@lwfinger.net>
Message-ID: <201002062254.48048.smpuj@bk.ru>

On Wednesday 03 February 2010 07:45:46 Larry Finger wrote:
> I installed my BCM4311/2 device to try to duplicate your results from
> above. I found a problem with performance and have posted a patch for
> that. I set my AP, which is a Linksys WRT54GL V1.1 running openWRT
> Kamikaze r16206 firmware. I set my network to be unencrypted as  you said
> that made the failure to occur more quickly. As I write this, my device
> has been running for 32 hours with no dropouts. I cannot duplicate your
> results.
> 
> My system is wireless-testing 2.6.33-rc5 with the two patches below. Please
> add them to your system and try again.

Thanks, I've tested wireless-testing with your pathes and they really increase 
the speed from 8 to 20 Mbps. Great! I used to think that slow speed was the 
problem with the router, not the laptop.

The router is the same as yours, though it runs Tomato 1.27. I've tried to 
disable secure authentication on it and have to admit that the problem is more 
specific than I thought ? 2.6.32 connects to the insecure router without problem 
(though disconnects continue to happen with 2.6.32 after a long period of time, 
not sure about patched wireless-testing). I'll be able to access the unprotected 
network which I fail to connect in a few days (it might be powered by 3Com, not 
sure about that), then I'll try wireless-testing with it.


From Larry.Finger at lwfinger.net  Sat Feb  6 21:43:36 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Feb 2010 14:43:36 -0600
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100206190837.GR48563@keybit.net>
References: <20100206190837.GR48563@keybit.net>
Message-ID: <4B6DD478.3030204@lwfinger.net>

On 02/06/2010 01:08 PM, strk wrote:
> Hi everybody,
> my excuses in advance for asking something which was likely
> asked a lot more in the past.
> 
> I just switched to usin b43legacy from bmcxxx (from linux 2.6.18
> to linux 2.6.26) and am having some problems with the wireless
> card. In particular I continually get disable-enable messages:
> 
> Feb  6 20:01:21 xtops kernel: [ 4910.000194] b43legacy-phy3: Radio hardware
> status changed to ENABLED
> Feb  6 20:01:46 xtops kernel: [ 4935.000441] __ratelimit: 3 messages suppressed
> Feb  6 20:01:46 xtops kernel: [ 4935.000458] b43legacy-phy3: Radio hardware
> status changed to DISABLED
> 
> Sometimes this results in a disconnection.
-- snip --
> 
> Any hint on how to further debug or fix ?
> Thanks in advance.

After bcm43xx was split into b43 and b43legacy, both were upgraded to take
account of the computers "radio kill switch". Changes in the hardware switch
input are causing the "Radio hardware ENABLED/DISABLED" messages.

How does the ASUS implement that switch? Some laptops have a slide switch with
an on/off position, while others have a push button with software keeping track
of the state.

Larry

PS: Your address bcm43xx-dev at berios.de is wrong. You should use just
bcm43xx-dev at lists.berlios.de.


From strk at keybit.net  Sat Feb  6 22:14:12 2010
From: strk at keybit.net (strk)
Date: Sat, 6 Feb 2010 22:14:12 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <4B6DD478.3030204@lwfinger.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
Message-ID: <20100206211412.GW48563@keybit.net>

On Sat, Feb 06, 2010 at 02:43:36PM -0600, Larry Finger wrote:

> After bcm43xx was split into b43 and b43legacy, both were upgraded to take
> account of the computers "radio kill switch". Changes in the hardware switch
> input are causing the "Radio hardware ENABLED/DISABLED" messages.
> 
> How does the ASUS implement that switch? Some laptops have a slide switch with
> an on/off position, while others have a push button with software keeping track
> of the state.

I can see no slide switch, nor sign on any key suggesting
to have that purpose. It seems my problem was already reported here:

https://lists.berlios.de/pipermail/bcm43xx-dev/2008-November/004843.html

... but the thread has no happy end (I add the author of that post in Cc).

Jorge, have you figured it out lately  ?

-- 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From strk at keybit.net  Sun Feb  7 01:18:13 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 01:18:13 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100206211412.GW48563@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net>
Message-ID: <20100207001813.GC83107@keybit.net>

[ sorry for repost, Jorge wasn't in recipient list ]

On Sat, Feb 06, 2010 at 10:14:12PM +0100, strk wrote:
> On Sat, Feb 06, 2010 at 02:43:36PM -0600, Larry Finger wrote:

> > How does the ASUS implement that switch? Some laptops have a slide switch with
> > an on/off position, while others have a push button with software keeping track
> > of the state.
> 
> I can see no slide switch, nor sign on any key suggesting
> to have that purpose. It seems my problem was already reported here:
> 
> https://lists.berlios.de/pipermail/bcm43xx-dev/2008-November/004843.html
> 
> ... but the thread has no happy end (I add the author of that post in Cc).
> 
> Jorge, have you figured it out lately  ?

--strk;

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From Larry.Finger at lwfinger.net  Sun Feb  7 01:20:15 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Feb 2010 18:20:15 -0600
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100206211412.GW48563@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net>
Message-ID: <4B6E073F.4080207@lwfinger.net>

On 02/06/2010 03:14 PM, strk wrote:
> On Sat, Feb 06, 2010 at 02:43:36PM -0600, Larry Finger wrote:
> 
>> After bcm43xx was split into b43 and b43legacy, both were upgraded to take
>> account of the computers "radio kill switch". Changes in the hardware switch
>> input are causing the "Radio hardware ENABLED/DISABLED" messages.
>>
>> How does the ASUS implement that switch? Some laptops have a slide switch with
>> an on/off position, while others have a push button with software keeping track
>> of the state.
> 
> I can see no slide switch, nor sign on any key suggesting
> to have that purpose. It seems my problem was already reported here:
> 
> https://lists.berlios.de/pipermail/bcm43xx-dev/2008-November/004843.html
> 
> ... but the thread has no happy end (I add the author of that post in Cc).
> 
> Jorge, have you figured it out lately  ?

You could probably avoid the problems by disabling the RFKILL and RFKILL_INPUT
options.

Larry


From strk at keybit.net  Sun Feb  7 01:22:52 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 01:22:52 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <4B6E073F.4080207@lwfinger.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
Message-ID: <20100207002252.GD83107@keybit.net>

On Sat, Feb 06, 2010 at 06:20:15PM -0600, Larry Finger wrote:

> You could probably avoid the problems by disabling the RFKILL and RFKILL_INPUT
> options.

How do I do that ? Runtime ? Compile-time ?

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From Larry.Finger at lwfinger.net  Sun Feb  7 01:29:03 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Feb 2010 18:29:03 -0600
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207002252.GD83107@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net>
Message-ID: <4B6E094F.4020801@lwfinger.net>

On 02/06/2010 06:22 PM, strk wrote:
> On Sat, Feb 06, 2010 at 06:20:15PM -0600, Larry Finger wrote:
> 
>> You could probably avoid the problems by disabling the RFKILL and RFKILL_INPUT
>> options.
> 
> How do I do that ? Runtime ? Compile-time ?

It needs to be compile time to elimionate that section of b43legacy.

Larry


From strk at keybit.net  Sun Feb  7 01:49:06 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 01:49:06 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <4B6E094F.4020801@lwfinger.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
Message-ID: <20100207004906.GF83107@keybit.net>

On Sat, Feb 06, 2010 at 06:29:03PM -0600, Larry Finger wrote:
> On 02/06/2010 06:22 PM, strk wrote:
> > On Sat, Feb 06, 2010 at 06:20:15PM -0600, Larry Finger wrote:
> > 
> >> You could probably avoid the problems by disabling the RFKILL and RFKILL_INPUT
> >> options.
> > 
> > How do I do that ? Runtime ? Compile-time ?
> 
> It needs to be compile time to elimionate that section of b43legacy.

Thanks. Is there a repository from which I can get *only*
bcm43xx sources and compile against kernel headers ?
I've seen this done with debian module-assistant tool...

--strk;

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From Larry.Finger at lwfinger.net  Sun Feb  7 01:54:44 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Feb 2010 18:54:44 -0600
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207004906.GF83107@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
	<20100207004906.GF83107@keybit.net>
Message-ID: <4B6E0F54.1070403@lwfinger.net>

On 02/06/2010 06:49 PM, strk wrote:
> On Sat, Feb 06, 2010 at 06:29:03PM -0600, Larry Finger wrote:
>> On 02/06/2010 06:22 PM, strk wrote:
>>> On Sat, Feb 06, 2010 at 06:20:15PM -0600, Larry Finger wrote:
>>>
>>>> You could probably avoid the problems by disabling the RFKILL and RFKILL_INPUT
>>>> options.
>>>
>>> How do I do that ? Runtime ? Compile-time ?
>>
>> It needs to be compile time to elimionate that section of b43legacy.
> 
> Thanks. Is there a repository from which I can get *only*
> bcm43xx sources and compile against kernel headers ?
> I've seen this done with debian module-assistant tool...

You can get the wireless-compat sources for kernel 2.6.26 and build that.
Othersise, go to kernel.org and get the full sources.

Larry


From strk at keybit.net  Sun Feb  7 12:57:17 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 12:57:17 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <4B6E0F54.1070403@lwfinger.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
	<20100207004906.GF83107@keybit.net> <4B6E0F54.1070403@lwfinger.net>
Message-ID: <20100207115717.GA89844@keybit.net>

On Sat, Feb 06, 2010 at 06:54:44PM -0600, Larry Finger wrote:

> You can get the wireless-compat sources for kernel 2.6.26 and build that.
> Othersise, go to kernel.org and get the full sources.

I opted for an upgrade first (debian lenny to debian squeeze).
So I'm now at kernel version 2.6.32 and the problem is somehow
different (still related to kill switch).

The messages in this case are more clear (on ifconfig wlan0 xxxx):

b43legacy ssb0:0: firmware: requesting b3legacy/ucode2.fw
b43legacy ssb0:0: firmware: requesting b3legacy/pcm4.fw
b43legacy ssb0:0: firmware: requesting b3legacy/b0g0initvals2.fw
b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
b43legacy-phy0: Radio hardware status changed to DISABLED
b43legacy-phy0: Radio turned on by software
b43legacy-phy0: The hardware RF-kill button still turns the radio physically off. Press th ebutton to turn it on.

Same suggestions applies ? Or was some load-time option added in 2.6.32 ?

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From zajec5 at gmail.com  Sun Feb  7 13:48:59 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 7 Feb 2010 13:48:59 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207115717.GA89844@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
	<20100207004906.GF83107@keybit.net> <4B6E0F54.1070403@lwfinger.net>
	<20100207115717.GA89844@keybit.net>
Message-ID: <b170af451002070448w7d55fe43ia97bf88eb1626bc0@mail.gmail.com>

2010/2/7 strk <strk at keybit.net>:
> On Sat, Feb 06, 2010 at 06:54:44PM -0600, Larry Finger wrote:
>
>> You can get the wireless-compat sources for kernel 2.6.26 and build that.
>> Othersise, go to kernel.org and get the full sources.
>
> I opted for an upgrade first (debian lenny to debian squeeze).
> So I'm now at kernel version 2.6.32 and the problem is somehow
> different (still related to kill switch).
>
> The messages in this case are more clear (on ifconfig wlan0 xxxx):
>
> b43legacy ssb0:0: firmware: requesting b3legacy/ucode2.fw
> b43legacy ssb0:0: firmware: requesting b3legacy/pcm4.fw
> b43legacy ssb0:0: firmware: requesting b3legacy/b0g0initvals2.fw
> b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
> b43legacy-phy0: Radio hardware status changed to DISABLED
> b43legacy-phy0: Radio turned on by software
> b43legacy-phy0: The hardware RF-kill button still turns the radio physically off. Press th ebutton to turn it on.

I'm not sure... if radio is turned off physically (by hardware) can
compiling without RFKILL help at all? AFAIU rfkill is just for
disabling radio by software...

-- 
Rafa?


From mb at bu3sch.de  Sun Feb  7 14:05:09 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 14:05:09 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <b170af451002070448w7d55fe43ia97bf88eb1626bc0@mail.gmail.com>
References: <20100206190837.GR48563@keybit.net>
	<20100207115717.GA89844@keybit.net>
	<b170af451002070448w7d55fe43ia97bf88eb1626bc0@mail.gmail.com>
Message-ID: <201002071405.11899.mb@bu3sch.de>

On Sunday 07 February 2010 13:48:59 Rafa? Mi?ecki wrote:
> 2010/2/7 strk <strk at keybit.net>:
> > On Sat, Feb 06, 2010 at 06:54:44PM -0600, Larry Finger wrote:
> >
> >> You can get the wireless-compat sources for kernel 2.6.26 and build that.
> >> Othersise, go to kernel.org and get the full sources.
> >
> > I opted for an upgrade first (debian lenny to debian squeeze).
> > So I'm now at kernel version 2.6.32 and the problem is somehow
> > different (still related to kill switch).
> >
> > The messages in this case are more clear (on ifconfig wlan0 xxxx):
> >
> > b43legacy ssb0:0: firmware: requesting b3legacy/ucode2.fw
> > b43legacy ssb0:0: firmware: requesting b3legacy/pcm4.fw
> > b43legacy ssb0:0: firmware: requesting b3legacy/b0g0initvals2.fw
> > b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
> > b43legacy-phy0: Radio hardware status changed to DISABLED
> > b43legacy-phy0: Radio turned on by software
> > b43legacy-phy0: The hardware RF-kill button still turns the radio physically off. Press th ebutton to turn it on.
> 
> I'm not sure... if radio is turned off physically (by hardware) can
> compiling without RFKILL help at all? AFAIU rfkill is just for
> disabling radio by software...

rfkill is a hardware lock in the case of broadcom. Software can only read the state.

(There may be laptops with broadcom cards where rfkill can be changed by software.
But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sun Feb  7 14:18:43 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 7 Feb 2010 14:18:43 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071405.11899.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<20100207115717.GA89844@keybit.net>
	<b170af451002070448w7d55fe43ia97bf88eb1626bc0@mail.gmail.com>
	<201002071405.11899.mb@bu3sch.de>
Message-ID: <b170af451002070518r25edb8c9t32553477da2862f8@mail.gmail.com>

2010/2/7 Michael Buesch <mb at bu3sch.de>:
> On Sunday 07 February 2010 13:48:59 Rafa? Mi?ecki wrote:
>> 2010/2/7 strk <strk at keybit.net>:
>> > On Sat, Feb 06, 2010 at 06:54:44PM -0600, Larry Finger wrote:
>> >
>> >> You can get the wireless-compat sources for kernel 2.6.26 and build that.
>> >> Othersise, go to kernel.org and get the full sources.
>> >
>> > I opted for an upgrade first (debian lenny to debian squeeze).
>> > So I'm now at kernel version 2.6.32 and the problem is somehow
>> > different (still related to kill switch).
>> >
>> > The messages in this case are more clear (on ifconfig wlan0 xxxx):
>> >
>> > b43legacy ssb0:0: firmware: requesting b3legacy/ucode2.fw
>> > b43legacy ssb0:0: firmware: requesting b3legacy/pcm4.fw
>> > b43legacy ssb0:0: firmware: requesting b3legacy/b0g0initvals2.fw
>> > b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
>> > b43legacy-phy0: Radio hardware status changed to DISABLED
>> > b43legacy-phy0: Radio turned on by software
>> > b43legacy-phy0: The hardware RF-kill button still turns the radio physically off. Press th ebutton to turn it on.
>>
>> I'm not sure... if radio is turned off physically (by hardware) can
>> compiling without RFKILL help at all? AFAIU rfkill is just for
>> disabling radio by software...
>
> rfkill is a hardware lock in the case of broadcom. Software can only read the state.
>
> (There may be laptops with broadcom cards where rfkill can be changed by software.
> But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)

So pressing something like Fn+FX can eventually be handled by BIOS and
can cause hardware (physical) enabling radio?

In such a case Broadcom hardware doesn't know about this (wow, that's
weird), and so b43 driver doesn't know as well? As the result b43
doesn't try to run wireless.

If we compile without rfkill we won't check for radio status, and we
will just try to use radio, that may be enabled at some point by BIOS.

Is my understand correct? Thanks for explaining Michael :)

-- 
Rafa?


From mb at bu3sch.de  Sun Feb  7 14:22:47 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 14:22:47 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <b170af451002070518r25edb8c9t32553477da2862f8@mail.gmail.com>
References: <20100206190837.GR48563@keybit.net>
	<201002071405.11899.mb@bu3sch.de>
	<b170af451002070518r25edb8c9t32553477da2862f8@mail.gmail.com>
Message-ID: <201002071422.49083.mb@bu3sch.de>

On Sunday 07 February 2010 14:18:43 Rafa? Mi?ecki wrote:
> So pressing something like Fn+FX can eventually be handled by BIOS and
> can cause hardware (physical) enabling radio?

Yeah, could be the case. It could also be handled by another kernel driver (wmi).
In no case will the wireless driver be able to modify the state.

> In such a case Broadcom hardware doesn't know about this (wow, that's
> weird), and so b43 driver doesn't know as well? As the result b43
> doesn't try to run wireless.

Well, the only thing the driver can do is _observing_ that the radio is killed.

> If we compile without rfkill we won't check for radio status, and we
> will just try to use radio, that may be enabled at some point by BIOS.

Yeah.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sun Feb  7 15:04:22 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 7 Feb 2010 15:04:22 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071422.49083.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<201002071405.11899.mb@bu3sch.de>
	<b170af451002070518r25edb8c9t32553477da2862f8@mail.gmail.com>
	<201002071422.49083.mb@bu3sch.de>
Message-ID: <b170af451002070604o35c10851m8edea591917a3d59@mail.gmail.com>

W dniu 7 lutego 2010 14:22 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Sunday 07 February 2010 14:18:43 Rafa? Mi?ecki wrote:
>> So pressing something like Fn+FX can eventually be handled by BIOS and
>> can cause hardware (physical) enabling radio?
>
> Yeah, could be the case. It could also be handled by another kernel driver (wmi).
> In no case will the wireless driver be able to modify the state.
>
>> In such a case Broadcom hardware doesn't know about this (wow, that's
>> weird), and so b43 driver doesn't know as well? As the result b43
>> doesn't try to run wireless.
>
> Well, the only thing the driver can do is _observing_ that the radio is killed.
>
>> If we compile without rfkill we won't check for radio status, and we
>> will just try to use radio, that may be enabled at some point by BIOS.
>
> Yeah.

Would it be good idea to add kernel-module-parameter hack like "ignore_rfkill"?

-- 
Rafa?


From zajec5 at gmail.com  Sun Feb  7 15:09:05 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 7 Feb 2010 15:09:05 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071422.49083.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<201002071405.11899.mb@bu3sch.de>
	<b170af451002070518r25edb8c9t32553477da2862f8@mail.gmail.com>
	<201002071422.49083.mb@bu3sch.de>
Message-ID: <b170af451002070609icb80348j81442a75881be0fc@mail.gmail.com>

W dniu 7 lutego 2010 14:22 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Sunday 07 February 2010 14:18:43 Rafa? Mi?ecki wrote:
>> So pressing something like Fn+FX can eventually be handled by BIOS and
>> can cause hardware (physical) enabling radio?
>
> Yeah, could be the case. It could also be handled by another kernel driver (wmi).
> In no case will the wireless driver be able to modify the state.
>
>> In such a case Broadcom hardware doesn't know about this (wow, that's
>> weird), and so b43 driver doesn't know as well? As the result b43
>> doesn't try to run wireless.
>
> Well, the only thing the driver can do is _observing_ that the radio is killed.

Hm, AFAIR my old Acer Aspire 5024 was using acer-wmi module to manage
(turn off) rfkill. I was using this with b43 driver so somehow in my
case b43 (and hardware?) did know state of radio state... But you
wrote:

> But that's done by other means (BIOS) and the broadcom hardware doesn't know about it

so finally... when we are able to know rfkill status and when we are
not? Is this like following?
1) If BIOS handles rfkill we don't know status of radio and radio
doesn't know as well
2) If something like WMI handles rfkill, we know status of radio
?

-- 
Rafa?


From strk at keybit.net  Sun Feb  7 15:30:18 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 15:30:18 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071405.11899.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<20100207115717.GA89844@keybit.net>
	<b170af451002070448w7d55fe43ia97bf88eb1626bc0@mail.gmail.com>
	<201002071405.11899.mb@bu3sch.de>
Message-ID: <20100207143018.GB89844@keybit.net>

On Sun, Feb 07, 2010 at 02:05:09PM +0100, Michael Buesch wrote:

> rfkill is a hardware lock in the case of broadcom. Software can only read the state.
>
> (There may be laptops with broadcom cards where rfkill can be changed by software.
> But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)

Uhm, but still I'm pretty sure there's no physical switch on this laptop (L5800C).
Also, if there was one, surely I wasn't turning it on and off continuosly to
justify those notices coming down to b43legacy.

Note that bcm43xx used to work fine. 

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From mb at bu3sch.de  Sun Feb  7 15:30:32 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 15:30:32 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <b170af451002070604o35c10851m8edea591917a3d59@mail.gmail.com>
References: <20100206190837.GR48563@keybit.net>
	<201002071422.49083.mb@bu3sch.de>
	<b170af451002070604o35c10851m8edea591917a3d59@mail.gmail.com>
Message-ID: <201002071530.34272.mb@bu3sch.de>

On Sunday 07 February 2010 15:04:22 Rafa? Mi?ecki wrote:
> Would it be good idea to add kernel-module-parameter hack like "ignore_rfkill"?

No. If b43 detects the radio as disabled, it _really_ _is_ physically turned off.
There's no way around that except by enabling the radio physically.

-- 
Greetings, Michael.


From mb at bu3sch.de  Sun Feb  7 15:34:17 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 15:34:17 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <b170af451002070609icb80348j81442a75881be0fc@mail.gmail.com>
References: <20100206190837.GR48563@keybit.net>
	<201002071422.49083.mb@bu3sch.de>
	<b170af451002070609icb80348j81442a75881be0fc@mail.gmail.com>
Message-ID: <201002071534.19487.mb@bu3sch.de>

On Sunday 07 February 2010 15:09:05 Rafa? Mi?ecki wrote:
> W dniu 7 lutego 2010 14:22 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> > On Sunday 07 February 2010 14:18:43 Rafa? Mi?ecki wrote:
> >> So pressing something like Fn+FX can eventually be handled by BIOS and
> >> can cause hardware (physical) enabling radio?
> >
> > Yeah, could be the case. It could also be handled by another kernel driver (wmi).
> > In no case will the wireless driver be able to modify the state.
> >
> >> In such a case Broadcom hardware doesn't know about this (wow, that's
> >> weird), and so b43 driver doesn't know as well? As the result b43
> >> doesn't try to run wireless.
> >
> > Well, the only thing the driver can do is _observing_ that the radio is killed.
> 
> Hm, AFAIR my old Acer Aspire 5024 was using acer-wmi module to manage
> (turn off) rfkill. I was using this with b43 driver so somehow in my
> case b43 (and hardware?) did know state of radio state... But you
> wrote:
> 
> > But that's done by other means (BIOS) and the broadcom hardware doesn't know about it
> 
> so finally... when we are able to know rfkill status and when we are
> not? Is this like following?
> 1) If BIOS handles rfkill we don't know status of radio and radio
> doesn't know as well
> 2) If something like WMI handles rfkill, we know status of radio
> ?

We always know about the status of the radio (rfkill). We just can't
modify it from within the broadcom device.
The rfkill signal is a physical signal that goes into the broadcom radio.
If that signal is turned to "kill" by the BIOS, there's nothing the broadcom
chip can do about it. It will just show the state of that physical line to
the driver via a bit in a register or via IRQ.

So if rfkill can be switched by software, that is totally unrelated to b43.
It's done by completely unrelated hardware registers that are not on the broadcom device
or by other means (BIOS calls, etc...).

-- 
Greetings, Michael.


From mb at bu3sch.de  Sun Feb  7 15:37:36 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 15:37:36 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207143018.GB89844@keybit.net>
References: <20100206190837.GR48563@keybit.net>
	<201002071405.11899.mb@bu3sch.de>
	<20100207143018.GB89844@keybit.net>
Message-ID: <201002071537.37600.mb@bu3sch.de>

On Sunday 07 February 2010 15:30:18 strk wrote:
> On Sun, Feb 07, 2010 at 02:05:09PM +0100, Michael Buesch wrote:
> 
> > rfkill is a hardware lock in the case of broadcom. Software can only read the state.
> >
> > (There may be laptops with broadcom cards where rfkill can be changed by software.
> > But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)
> 
> Uhm, but still I'm pretty sure there's no physical switch on this laptop (L5800C).
> Also, if there was one, surely I wasn't turning it on and off continuosly to
> justify those notices coming down to b43legacy.
> 
> Note that bcm43xx used to work fine. 

I'm not talking about possible bugs in the software. I'm just explaining
how the hardware works, because I think there's some confusion here.

-- 
Greetings, Michael.


From strk at keybit.net  Sun Feb  7 15:44:01 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 15:44:01 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071537.37600.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<201002071405.11899.mb@bu3sch.de>
	<20100207143018.GB89844@keybit.net>
	<201002071537.37600.mb@bu3sch.de>
Message-ID: <20100207144400.GD89844@keybit.net>

On Sun, Feb 07, 2010 at 03:37:36PM +0100, Michael Buesch wrote:
> On Sunday 07 February 2010 15:30:18 strk wrote:
> > On Sun, Feb 07, 2010 at 02:05:09PM +0100, Michael Buesch wrote:
> > 
> > > rfkill is a hardware lock in the case of broadcom. Software can only read the state.
> > >
> > > (There may be laptops with broadcom cards where rfkill can be changed by software.
> > > But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)
> > 
> > Uhm, but still I'm pretty sure there's no physical switch on this laptop (L5800C).
> > Also, if there was one, surely I wasn't turning it on and off continuosly to
> > justify those notices coming down to b43legacy.
> > 
> > Note that bcm43xx used to work fine. 
> 
> I'm not talking about possible bugs in the software. I'm just explaining
> how the hardware works, because I think there's some confusion here.

Ok, so supposedly here the situation can be on of these:

 1) b43legacy driver is wrong while reading kill switch state
 2) something (software) is toggling kill switch 

Would case 1 be fixed by having b43legacy NOT check the state ?

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From mb at bu3sch.de  Sun Feb  7 15:48:07 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 15:48:07 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207144400.GD89844@keybit.net>
References: <20100206190837.GR48563@keybit.net>
	<201002071537.37600.mb@bu3sch.de>
	<20100207144400.GD89844@keybit.net>
Message-ID: <201002071548.12268.mb@bu3sch.de>

On Sunday 07 February 2010 15:44:01 strk wrote:
> On Sun, Feb 07, 2010 at 03:37:36PM +0100, Michael Buesch wrote:
> > On Sunday 07 February 2010 15:30:18 strk wrote:
> > > On Sun, Feb 07, 2010 at 02:05:09PM +0100, Michael Buesch wrote:
> > > 
> > > > rfkill is a hardware lock in the case of broadcom. Software can only read the state.
> > > >
> > > > (There may be laptops with broadcom cards where rfkill can be changed by software.
> > > > But that's done by other means (BIOS) and the broadcom hardware doesn't know about it.)
> > > 
> > > Uhm, but still I'm pretty sure there's no physical switch on this laptop (L5800C).
> > > Also, if there was one, surely I wasn't turning it on and off continuosly to
> > > justify those notices coming down to b43legacy.
> > > 
> > > Note that bcm43xx used to work fine. 
> > 
> > I'm not talking about possible bugs in the software. I'm just explaining
> > how the hardware works, because I think there's some confusion here.
> 
> Ok, so supposedly here the situation can be on of these:
> 
>  1) b43legacy driver is wrong while reading kill switch state
>  2) something (software) is toggling kill switch 
> 
> Would case 1 be fixed by having b43legacy NOT check the state ?

Well, it would not be a fix, but it would possibly be a workaround for it.

-- 
Greetings, Michael.


From strk at keybit.net  Sun Feb  7 15:59:53 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 15:59:53 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071548.12268.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<201002071537.37600.mb@bu3sch.de>
	<20100207144400.GD89844@keybit.net>
	<201002071548.12268.mb@bu3sch.de>
Message-ID: <20100207145953.GE89844@keybit.net>

On Sun, Feb 07, 2010 at 03:48:07PM +0100, Michael Buesch wrote:
> On Sunday 07 February 2010 15:44:01 strk wrote:

> > Ok, so supposedly here the situation can be on of these:
> > 
> >  1) b43legacy driver is wrong while reading kill switch state
> >  2) something (software) is toggling kill switch 
> > 
> > Would case 1 be fixed by having b43legacy NOT check the state ?
> 
> Well, it would not be a fix, but it would possibly be a workaround for it.

If it *does* work as a workaround it'd be a good reason to add 
a load-time option to the driver (allow workaround to bogus behaviours).
I'll let you know if it does work.

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From mb at bu3sch.de  Sun Feb  7 16:05:24 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 7 Feb 2010 16:05:24 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207145953.GE89844@keybit.net>
References: <20100206190837.GR48563@keybit.net>
	<201002071548.12268.mb@bu3sch.de>
	<20100207145953.GE89844@keybit.net>
Message-ID: <201002071605.25568.mb@bu3sch.de>

On Sunday 07 February 2010 15:59:53 strk wrote:
> On Sun, Feb 07, 2010 at 03:48:07PM +0100, Michael Buesch wrote:
> > On Sunday 07 February 2010 15:44:01 strk wrote:
> 
> > > Ok, so supposedly here the situation can be on of these:
> > > 
> > >  1) b43legacy driver is wrong while reading kill switch state
> > >  2) something (software) is toggling kill switch 
> > > 
> > > Would case 1 be fixed by having b43legacy NOT check the state ?
> > 
> > Well, it would not be a fix, but it would possibly be a workaround for it.
> 
> If it *does* work as a workaround it'd be a good reason to add 
> a load-time option to the driver (allow workaround to bogus behaviours).
> I'll let you know if it does work.

We are not going to add module options to workaround bugs. We fix the bug instead.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sun Feb  7 16:27:02 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 7 Feb 2010 16:27:02 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <201002071605.25568.mb@bu3sch.de>
References: <20100206190837.GR48563@keybit.net>
	<201002071548.12268.mb@bu3sch.de> <20100207145953.GE89844@keybit.net>
	<201002071605.25568.mb@bu3sch.de>
Message-ID: <b170af451002070727y492bbe2fof69002bdbaf8c25f@mail.gmail.com>

2010/2/7 Michael Buesch <mb at bu3sch.de>:
> On Sunday 07 February 2010 15:59:53 strk wrote:
>> On Sun, Feb 07, 2010 at 03:48:07PM +0100, Michael Buesch wrote:
>> > On Sunday 07 February 2010 15:44:01 strk wrote:
>>
>> > > Ok, so supposedly here the situation can be on of these:
>> > >
>> > > ?1) b43legacy driver is wrong while reading kill switch state
>> > > ?2) something (software) is toggling kill switch
>> > >
>> > > Would case 1 be fixed by having b43legacy NOT check the state ?
>> >
>> > Well, it would not be a fix, but it would possibly be a workaround for it.
>>
>> If it *does* work as a workaround it'd be a good reason to add
>> a load-time option to the driver (allow workaround to bogus behaviours).
>> I'll let you know if it does work.
>
> We are not going to add module options to workaround bugs. We fix the bug instead.

++

Please test first if it actually changes anything.

-- 
Rafa?


From strk at keybit.net  Sun Feb  7 17:45:30 2010
From: strk at keybit.net (strk)
Date: Sun, 7 Feb 2010 17:45:30 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <b170af451002070727y492bbe2fof69002bdbaf8c25f@mail.gmail.com>
References: <20100206190837.GR48563@keybit.net>
	<201002071548.12268.mb@bu3sch.de>
	<20100207145953.GE89844@keybit.net>
	<201002071605.25568.mb@bu3sch.de>
	<b170af451002070727y492bbe2fof69002bdbaf8c25f@mail.gmail.com>
Message-ID: <20100207164530.GH89844@keybit.net>

On Sun, Feb 07, 2010 at 04:27:02PM +0100, Rafa?? Mi??ecki wrote:
> 2010/2/7 Michael Buesch <mb at bu3sch.de>:
> > On Sunday 07 February 2010 15:59:53 strk wrote:
> >> On Sun, Feb 07, 2010 at 03:48:07PM +0100, Michael Buesch wrote:
> >> > On Sunday 07 February 2010 15:44:01 strk wrote:
> >>
> >> > > Ok, so supposedly here the situation can be on of these:
> >> > >
> >> > > ??1) b43legacy driver is wrong while reading kill switch state
> >> > > ??2) something (software) is toggling kill switch
> >> > >
> >> > > Would case 1 be fixed by having b43legacy NOT check the state ?
> >> >
> >> > Well, it would not be a fix, but it would possibly be a workaround for it.
> >>
> >> If it *does* work as a workaround it'd be a good reason to add
> >> a load-time option to the driver (allow workaround to bogus behaviours).
> >> I'll let you know if it does work.
> >
> > We are not going to add module options to workaround bugs. We fix the bug instead.
> 
> ++
> 
> Please test first if it actually changes anything.

Aaargh, my laptop's screen just died. It'll probaby take some
time before I go on with this task (luckly the *wired* nic
still works).

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From Larry.Finger at lwfinger.net  Sun Feb  7 20:54:13 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 07 Feb 2010 13:54:13 -0600
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207115717.GA89844@keybit.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
	<20100207004906.GF83107@keybit.net> <4B6E0F54.1070403@lwfinger.net>
	<20100207115717.GA89844@keybit.net>
Message-ID: <4B6F1A65.6080402@lwfinger.net>

On 02/07/2010 05:57 AM, strk wrote:
> On Sat, Feb 06, 2010 at 06:54:44PM -0600, Larry Finger wrote:
> 
>> You can get the wireless-compat sources for kernel 2.6.26 and build that.
>> Othersise, go to kernel.org and get the full sources.
> 
> I opted for an upgrade first (debian lenny to debian squeeze).
> So I'm now at kernel version 2.6.32 and the problem is somehow
> different (still related to kill switch).
> 
> The messages in this case are more clear (on ifconfig wlan0 xxxx):
> 
> b43legacy ssb0:0: firmware: requesting b3legacy/ucode2.fw
> b43legacy ssb0:0: firmware: requesting b3legacy/pcm4.fw
> b43legacy ssb0:0: firmware: requesting b3legacy/b0g0initvals2.fw
> b43legacy-phy0: Loading firmware version 0x127, patch level 14 (2005-04-18 02:36:27)
> b43legacy-phy0: Radio hardware status changed to DISABLED
> b43legacy-phy0: Radio turned on by software
> b43legacy-phy0: The hardware RF-kill button still turns the radio physically off. Press th ebutton to turn it on.
> 
> Same suggestions applies ? Or was some load-time option added in 2.6.32 ?

There is no load-time option to ignore RFKILL, and as you have read, there never
will be.

I assume that your laptop has a mini-PCI BCM4303 card. Neither of my two devices
uses that format, nor do either of mine implement the "RF silent" input, which
is on pin 13, according to

http://www.interfacebus.com/MiniPCI_Pinout_124Pin.html

You did not see any logged rfkill messages with bcm43xx as it did not examine
this input. The hardware must have honored that input and suppressed the radio
whenever it was set.

If you generate a system with the RFKILL subsystem disabled, all that will
happen is that the messages will go away, and your radio will be silently
disabled on an intermittent basis. You need to discover why that input is being
generated? There could be a failure in the motherboard circuits that generate
the signal. There could be a bug in the software that processes whatever WMI
info that your system generates. WMI (Windows Management Interface) code handles
the functions of the top row of your keyboard that are generated by a fn+FX key.

One alternative would be to alter the MB or the card so that the "RF silent"
input cannot be changed. BTW, I have no idea if it is a high or a low here that
kills the radio. I suspect that the radio will be on if the pin is floating, but
that is a guess.

Larry


From akaihola at gmail.com  Mon Feb  8 11:03:18 2010
From: akaihola at gmail.com (Antti Kaihola)
Date: Mon, 8 Feb 2010 12:03:18 +0200
Subject: addition to list of supported devices: 14e4:4315
In-Reply-To: <b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>
References: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>
	<b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>
Message-ID: <154405ff1002080203s1fa1976dq226614a0d186e604@mail.gmail.com>

2010/2/4 Rafa? Mi?ecki <zajec5 at gmail.com>

> If you see home page on this address
> (http://bcm43xx.berlios.de/?go=home) you will notice link to correct
> place for b43 info:
>

Ah, ok. I was brought directly to the "Devices" page by Google and didn't
know to read "Home" as well. Maybe it would be good to add the same notice
on other pages as well?


> > This card worked perfectly in Ubuntu 9.04 with the b43 driver. I haven't
> > tested with 9.10.
>
> Wait, moment. What did you say? Are you completely, really sure
> 14e4:4315 did work in Ubuntu 9.04 with b43?


Yes. As far as I recall, I never had any problems with it, neither with the
original or any updated kernel. I'll re-test this with a live CD to be sure.
I don't believe I ever installed kernels from other sources than the Ubuntu
"main" and "updates" repositories.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100208/dd065fb3/attachment.html>

From akaihola at gmail.com  Mon Feb  8 12:53:07 2010
From: akaihola at gmail.com (Antti Kaihola)
Date: Mon, 8 Feb 2010 13:53:07 +0200
Subject: addition to list of supported devices: 14e4:4315
In-Reply-To: <4B6A920A.2050406@tudelft.nl>
References: <154405ff1002032348w44494c8bo8c7affcee60fe5a2@mail.gmail.com>
	<b170af451002040023t5fb236ebj3138eae50a253d17@mail.gmail.com>
	<4B6A920A.2050406@tudelft.nl>
Message-ID: <154405ff1002080353r1d5211a5y3fe6c704ea513b3a@mail.gmail.com>

2010/2/4 ?ric Piel <E.A.B.Piel at tudelft.nl>

> Antti, maybe you could do a lsmod, to check if the "wl" driver is loaded.
>

This was indeed the case. Jaunty used the STA driver (which doesn't work in
Lucid either) by default so I assumed I was on an open driver since I never
approved any closed ones. Sorry for the noise.

Antti
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100208/a2a5f717/attachment.html>

From peter at stuge.se  Tue Feb  9 10:50:14 2010
From: peter at stuge.se (Peter Stuge)
Date: Tue, 9 Feb 2010 10:50:14 +0100
Subject: b43/b43legacy driver
In-Reply-To: <4247d9861002050625j2177a1c1j4fb25d4870ec37d2@mail.gmail.com>
References: <db4aab9b1002042304x4a9b3561ud6e12c9b938d02d7@mail.gmail.com>
	<b170af451002042345k48c6e9b9va29a6ad175b471f4@mail.gmail.com>
	<db4aab9b1002050306o3e7283ecn3616f55b2bd1af5d@mail.gmail.com>
	<4B6C1353.4080408@tudelft.nl>
	<db4aab9b1002050518k7e7c5393xea3513983ca6f3ab@mail.gmail.com>
	<4B6C1E6D.3020407@tudelft.nl>
	<db4aab9b1002050547j7610c7dfg732a7c6a8467b185@mail.gmail.com>
	<4B6C24D9.3060103@tudelft.nl>
	<db4aab9b1002050623n2ba5e4dfyeaf0b7a6c966b11b@mail.gmail.com>
	<4247d9861002050625j2177a1c1j4fb25d4870ec37d2@mail.gmail.com>
Message-ID: <20100209095014.1989.qmail@stuge.se>

Daniel Kuehn wrote:
> There is an option in gmail to tell it to send the mails as
> plain-text too.
> That is what I use,

Good point - important to post plain text.

I think another point which is also really important is to
EXTENSIVELY TRIM messages that you reply to.

It is quite common that Gmail users include the full previous history
of a thread in every reply they create and this is absolute madness!

Please be more aware of how you post, and make sure to trim when
sending replies.

Some particular behavior of Gmail (maybe it hides old parts of the
thread?) is not an excuse for you to waste everyone else's time!


//Peter


From peter at stuge.se  Tue Feb  9 13:58:45 2010
From: peter at stuge.se (Peter Stuge)
Date: Tue, 9 Feb 2010 13:58:45 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <4B6F1A65.6080402@lwfinger.net>
References: <20100206190837.GR48563@keybit.net> <4B6DD478.3030204@lwfinger.net>
	<20100206211412.GW48563@keybit.net> <4B6E073F.4080207@lwfinger.net>
	<20100207002252.GD83107@keybit.net> <4B6E094F.4020801@lwfinger.net>
	<20100207004906.GF83107@keybit.net> <4B6E0F54.1070403@lwfinger.net>
	<20100207115717.GA89844@keybit.net> <4B6F1A65.6080402@lwfinger.net>
Message-ID: <20100209125845.4393.qmail@stuge.se>

Larry Finger wrote:
> There could be a bug in the software that processes whatever WMI
> info that your system generates. WMI (Windows Management Interface)
> code handles the functions of the top row of your keyboard that are
> generated by a fn+FX key.

The BIOS is rarely if ever involved in any of this.

As was already explained, the rfkill signal is an electrical input to
the wifi hardware, and the b43 driver can only ever read the state of
this input.

Who drives the signal depends on the unique system design. (Think
mainboard.)

In laptops there is always at least one "embedded controller" AKA EC
which handles some or all of keyboard, GPIO signals, LEDs, Fn keys,
lid switch, power switch, special function keys, fan control, battery
charging and various other bits and pieces of the system.

Bytecode within the ACPI tables in the BIOS may be executed by the
kernel in order to discover e.g. Fn+key combination presses or lid
switch, but the BIOS does not have anything to do with changing the
electrical signal going out from the EC - that is done either by the
EC firmware (in response to some keypress, which will also be
reported via ACPI so the OS can update some status display) or as
ordered by the operating system (in response to some keypress
reported by the EC via ACPI).

There is no standardization at all for these signals and this
behavior. If you can find the schematics for your laptop that
would help.


//Peter


From zajec5 at gmail.com  Tue Feb  9 21:04:33 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:33 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs definitions
Message-ID: <1265745883-3392-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/b43.h         |    1 +
 drivers/net/wireless/b43/phy_n.h       |    9 +++++++++
 drivers/net/wireless/b43/tables_nphy.h |    9 +++++++++
 3 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/b43.h b/drivers/net/wireless/b43/b43.h
index 6a6ab0f..bd7c505 100644
--- a/drivers/net/wireless/b43/b43.h
+++ b/drivers/net/wireless/b43/b43.h
@@ -104,6 +104,7 @@
 #define B43_MMIO_MACFILTER_CONTROL	0x420
 #define B43_MMIO_MACFILTER_DATA		0x422
 #define B43_MMIO_RCMTA_COUNT		0x43C
+#define B43_MMIO_PSM_PHY_HDR		0x492	/* programmable state machine */
 #define B43_MMIO_RADIO_HWENABLED_LO	0x49A
 #define B43_MMIO_GPIO_CONTROL		0x49C
 #define B43_MMIO_GPIO_MASK		0x49E
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 403aad3..47d20dc 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -711,6 +711,8 @@
 #define B43_NPHY_PAPD_EN1			B43_PHY_N(0x29B) /* PAPD Enable1 TBD */
 #define B43_NPHY_EPS_TABLE_ADJ1			B43_PHY_N(0x29C) /* EPS Table Adj1 TBD */
 
+#define B43_PHY_B_BBCFG				B43_PHY_N_BMODE(0x001) /* BB config */
+#define B43_PHY_B_TEST				B43_PHY_N_BMODE(0x00A)
 
 
 /* Broadcom 2055 radio registers */
@@ -924,6 +926,13 @@
 
 struct b43_wldev;
 
+struct b43_chanspec {
+	u8 channel;
+	u8 sideband;
+	u8 b_width;
+	u8 b_freq;
+};
+
 struct b43_phy_n_iq_comp {
 	s16 a0;
 	s16 b0;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 9c1c6ec..b23036f 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -4,6 +4,15 @@
 #include <linux/types.h>
 
 
+struct b43_phy_n_sfo_cfg {
+	u16 phy_bw1a;
+	u16 phy_bw2;
+	u16 phy_bw3;
+	u16 phy_bw4;
+	u16 phy_bw5;
+	u16 phy_bw6;
+};
+
 struct b43_nphy_channeltab_entry {
 	/* The channel number */
 	u8 channel;
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:34 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:34 +0100
Subject: [PATCH 02/11] b43: N-PHY: initialize super switch
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   37 ++++++++++++++++++++++++++++++++++++-
 1 files changed, 36 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 795bb1e..2d8eda1 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -646,6 +646,41 @@ static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *clip_st)
 	clip_st[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SuperSwitchInit */
+static void b43_nphy_superswitch_init(struct b43_wldev *dev, bool init)
+{
+	if (dev->phy.rev >= 3) {
+		if (!init)
+			return;
+		if (0 /* FIXME */) {
+			b43_ntab_write(dev, B43_NTAB16(9, 2), 0x211);
+			b43_ntab_write(dev, B43_NTAB16(9, 3), 0x222);
+			b43_ntab_write(dev, B43_NTAB16(9, 8), 0x144);
+			b43_ntab_write(dev, B43_NTAB16(9, 12), 0x188);
+		}
+	} else {
+		b43_phy_write(dev, B43_NPHY_GPIO_LOOEN, 0);
+		b43_phy_write(dev, B43_NPHY_GPIO_HIOEN, 0);
+
+		ssb_chipco_gpio_control(&dev->dev->bus->chipco, 0xFC00,
+					0xFC00);
+		b43_write32(dev, B43_MMIO_MACCTL,
+			b43_read32(dev, B43_MMIO_MACCTL) &
+			~B43_MACCTL_GPOUTSMSK);
+		b43_write16(dev, B43_MMIO_GPIO_MASK,
+			b43_read16(dev, B43_MMIO_GPIO_MASK) | 0xFC00);
+		b43_write16(dev, B43_MMIO_GPIO_CONTROL,
+			b43_read16(dev, B43_MMIO_GPIO_CONTROL) & ~0xFC00);
+
+		if (init) {
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);
+		}
+	}
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/classifier */
 static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
 {
@@ -3116,7 +3151,7 @@ int b43_phy_initn(struct b43_wldev *dev)
 			target = b43_nphy_get_tx_gains(dev);
 
 			if (nphy->antsel_type == 2)
-				;/*TODO NPHY Superswitch Init with argument 1*/
+				b43_nphy_superswitch_init(dev, true);
 			if (nphy->perical != 2) {
 				b43_nphy_rssi_cal(dev);
 				if (phy->rev >= 3) {
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:35 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:35 +0100
Subject: [PATCH 03/11] b43: N-PHY: turn radio on/off (rfkill)
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   50 ++++++++++++++++++++++++++++----------
 1 files changed, 37 insertions(+), 13 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2d8eda1..dd81e8a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -218,7 +218,10 @@ static void b43_radio_init2055_post(struct b43_wldev *dev)
 	b43_radio_write16(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
 }
 
-/* Initialize a Broadcom 2055 N-radio */
+/*
+ * Initialize a Broadcom 2055 N-radio
+ * http://bcm-v4.sipsolutions.net/802.11/Radio/2055/Init
+ */
 static void b43_radio_init2055(struct b43_wldev *dev)
 {
 	b43_radio_init2055_pre(dev);
@@ -229,17 +232,6 @@ static void b43_radio_init2055(struct b43_wldev *dev)
 	b43_radio_init2055_post(dev);
 }
 
-void b43_nphy_radio_turn_on(struct b43_wldev *dev)
-{
-	b43_radio_init2055(dev);
-}
-
-void b43_nphy_radio_turn_off(struct b43_wldev *dev)
-{
-	b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
-		     ~B43_NPHY_RFCTL_CMD_EN);
-}
-
 /*
  * Upload the N-PHY tables.
  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
@@ -3277,9 +3269,41 @@ static void b43_nphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)
 	b43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/Radio/Switch%20Radio */
 static void b43_nphy_op_software_rfkill(struct b43_wldev *dev,
 					bool blocked)
-{//TODO
+{
+	if (b43_read32(dev, B43_MMIO_MACCTL) & B43_MACCTL_ENABLED)
+		b43err(dev->wl, "MAC not suspended\n");
+
+	if (blocked) {
+		b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
+				~B43_NPHY_RFCTL_CMD_CHIP0PU);
+		if (dev->phy.rev >= 3) {
+			b43_radio_mask(dev, 0x09, ~0x2);
+
+			b43_radio_write(dev, 0x204D, 0);
+			b43_radio_write(dev, 0x2053, 0);
+			b43_radio_write(dev, 0x2058, 0);
+			b43_radio_write(dev, 0x205E, 0);
+			b43_radio_mask(dev, 0x2062, ~0xF0);
+			b43_radio_write(dev, 0x2064, 0);
+
+			b43_radio_write(dev, 0x304D, 0);
+			b43_radio_write(dev, 0x3053, 0);
+			b43_radio_write(dev, 0x3058, 0);
+			b43_radio_write(dev, 0x305E, 0);
+			b43_radio_mask(dev, 0x3062, ~0xF0);
+			b43_radio_write(dev, 0x3064, 0);
+		}
+	} else {
+		if (dev->phy.rev >= 3) {
+			/* TODO: b43_radio_init2056(dev); */
+			/* TODO: PHY Set Channel Spec (dev, radio_chanspec) */
+		} else {
+			b43_radio_init2055(dev);
+		}
+	}
 }
 
 static void b43_nphy_op_switch_analog(struct b43_wldev *dev, bool on)
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:36 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:36 +0100
Subject: [PATCH 04/11] b43: N-PHY: update writing channel-specific radio
	registers
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   54 ++++++++++++++++++++++---------------
 1 files changed, 32 insertions(+), 22 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index dd81e8a..ebb9632 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -90,28 +90,38 @@ static enum b43_txpwr_result b43_nphy_op_recalc_txpower(struct b43_wldev *dev,
 static void b43_chantab_radio_upload(struct b43_wldev *dev,
 				     const struct b43_nphy_channeltab_entry *e)
 {
-	b43_radio_write16(dev, B2055_PLL_REF, e->radio_pll_ref);
-	b43_radio_write16(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);
-	b43_radio_write16(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);
-	b43_radio_write16(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);
-	b43_radio_write16(dev, B2055_VCO_CAL1, e->radio_vco_cal1);
-	b43_radio_write16(dev, B2055_VCO_CAL2, e->radio_vco_cal2);
-	b43_radio_write16(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);
-	b43_radio_write16(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);
-	b43_radio_write16(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);
-	b43_radio_write16(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);
-	b43_radio_write16(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);
-	b43_radio_write16(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);
-	b43_radio_write16(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);
-	b43_radio_write16(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);
-	b43_radio_write16(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);
-	b43_radio_write16(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);
-	b43_radio_write16(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);
-	b43_radio_write16(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);
-	b43_radio_write16(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);
-	b43_radio_write16(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);
-	b43_radio_write16(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);
-	b43_radio_write16(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);
+	b43_radio_write(dev, B2055_PLL_REF, e->radio_pll_ref);
+	b43_radio_write(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);
+	b43_radio_write(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);
+	b43_radio_write(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_VCO_CAL1, e->radio_vco_cal1);
+	b43_radio_write(dev, B2055_VCO_CAL2, e->radio_vco_cal2);
+	b43_radio_write(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);
+	b43_radio_write(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);
+	b43_radio_write(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);
+	b43_radio_write(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);
+	b43_radio_write(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);
+	b43_radio_write(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);
+	b43_radio_write(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);
+	b43_radio_write(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);
+	b43_radio_write(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);
+	b43_radio_write(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);
+	b43_radio_write(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);
+	b43_radio_write(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);
 }
 
 static void b43_chantab_phy_upload(struct b43_wldev *dev,
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:37 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:37 +0100
Subject: [PATCH 05/11] b43: N-PHY: update post init of 2055 radio
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-6-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   61 +++++++++++++++++++++----------------
 1 files changed, 35 insertions(+), 26 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index ebb9632..2f45817 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -183,49 +183,58 @@ static void b43_radio_init2055_pre(struct b43_wldev *dev)
 
 static void b43_radio_init2055_post(struct b43_wldev *dev)
 {
+	struct b43_phy_n *nphy = dev->phy.n;
 	struct ssb_sprom *sprom = &(dev->dev->bus->sprom);
 	struct ssb_boardinfo *binfo = &(dev->dev->bus->boardinfo);
 	int i;
 	u16 val;
+	bool workaround = false;
+
+	if (sprom->revision < 4)
+		workaround = (binfo->vendor != PCI_VENDOR_ID_BROADCOM ||
+				binfo->type != 0x46D ||
+				binfo->rev < 0x41);
+	else
+		workaround = ((sprom->boardflags_hi & B43_BFH_NOPA) == 0);
 
 	b43_radio_mask(dev, B2055_MASTER1, 0xFFF3);
-	msleep(1);
-	if ((sprom->revision != 4) ||
-	   !(sprom->boardflags_hi & B43_BFH_RSSIINV)) {
-		if ((binfo->vendor != PCI_VENDOR_ID_BROADCOM) ||
-		    (binfo->type != 0x46D) ||
-		    (binfo->rev < 0x41)) {
-			b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
-			b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
-			msleep(1);
-		}
+	if (workaround) {
+		b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
+		b43_radio_mask(dev, B2055_C2_RX_BB_REG, 0x7F);
 	}
-	b43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0x3F, 0x2C);
-	msleep(1);
-	b43_radio_write16(dev, B2055_CAL_MISC, 0x3C);
-	msleep(1);
+	b43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0xFFC0, 0x2C);
+	b43_radio_write(dev, B2055_CAL_MISC, 0x3C);
 	b43_radio_mask(dev, B2055_CAL_MISC, 0xFFBE);
-	msleep(1);
 	b43_radio_set(dev, B2055_CAL_LPOCTL, 0x80);
-	msleep(1);
 	b43_radio_set(dev, B2055_CAL_MISC, 0x1);
 	msleep(1);
 	b43_radio_set(dev, B2055_CAL_MISC, 0x40);
-	msleep(1);
-	for (i = 0; i < 100; i++) {
-		val = b43_radio_read16(dev, B2055_CAL_COUT2);
-		if (val & 0x80)
+	for (i = 0; i < 200; i++) {
+		val = b43_radio_read(dev, B2055_CAL_COUT2);
+		if (val & 0x80) {
+			i = 0;
 			break;
+		}
 		udelay(10);
 	}
-	msleep(1);
+	if (i)
+		b43err(dev->wl, "radio post init timeout\n");
 	b43_radio_mask(dev, B2055_CAL_LPOCTL, 0xFF7F);
-	msleep(1);
 	nphy_channel_switch(dev, dev->phy.channel);
-	b43_radio_write16(dev, B2055_C1_RX_BB_LPF, 0x9);
-	b43_radio_write16(dev, B2055_C2_RX_BB_LPF, 0x9);
-	b43_radio_write16(dev, B2055_C1_RX_BB_MIDACHP, 0x83);
-	b43_radio_write16(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
+	b43_radio_write(dev, B2055_C1_RX_BB_LPF, 0x9);
+	b43_radio_write(dev, B2055_C2_RX_BB_LPF, 0x9);
+	b43_radio_write(dev, B2055_C1_RX_BB_MIDACHP, 0x83);
+	b43_radio_write(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
+	b43_radio_maskset(dev, B2055_C1_LNA_GAINBST, 0xFFF8, 0x6);
+	b43_radio_maskset(dev, B2055_C2_LNA_GAINBST, 0xFFF8, 0x6);
+	if (!nphy->gain_boost) {
+		b43_radio_set(dev, B2055_C1_RX_RFSPC1, 0x2);
+		b43_radio_set(dev, B2055_C2_RX_RFSPC1, 0x2);
+	} else {
+		b43_radio_mask(dev, B2055_C1_RX_RFSPC1, 0xFFFD);
+		b43_radio_mask(dev, B2055_C2_RX_RFSPC1, 0xFFFD);
+	}
+	udelay(2);
 }
 
 /*
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:38 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:38 +0100
Subject: [PATCH 06/11] b43: N-PHY: switch to chanspec struct
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-7-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   45 +++++++++++++++++++++++++------------
 drivers/net/wireless/b43/phy_n.h |   11 +++++----
 2 files changed, 36 insertions(+), 20 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2f45817..4ff09b8 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -73,6 +73,21 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
 						u16 value, u8 core);
 
+static inline bool b43_empty_chanspec(struct b43_chanspec *chanspec)
+{
+	return !chanspec->channel && !chanspec->sideband &&
+		!chanspec->b_width && !chanspec->b_freq;
+}
+
+static inline bool b43_eq_chanspecs(struct b43_chanspec *chanspec1,
+					struct b43_chanspec *chanspec2)
+{
+	return (chanspec1->channel == chanspec2->channel &&
+		chanspec1->sideband == chanspec2->sideband &&
+		chanspec1->b_width == chanspec2->b_width &&
+		chanspec1->b_freq == chanspec2->b_freq);
+}
+
 void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
 {//TODO
 }
@@ -768,7 +783,7 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy = dev->phy.n;
 
-	unsigned int channel;
+	u8 channel = nphy->radio_chanspec.channel;
 	int tone[2] = { 57, 58 };
 	u32 noise[2] = { 0x3FF, 0x3FF };
 
@@ -777,8 +792,6 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 	if (nphy->hang_avoid)
 		b43_nphy_stay_in_carrier_search(dev, 1);
 
-	/* FIXME: channel = radio_chanspec */
-
 	if (nphy->gband_spurwar_en) {
 		/* TODO: N PHY Adjust Analog Pfbw (7) */
 		if (channel == 11 && dev->phy.is_40mhz)
@@ -2015,12 +2028,12 @@ static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
 	u16 *rssical_phy_regs = NULL;
 
 	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
-		if (!nphy->rssical_chanspec_2G)
+		if (b43_empty_chanspec(&nphy->rssical_chanspec_2G))
 			return;
 		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;
 		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;
 	} else {
-		if (!nphy->rssical_chanspec_5G)
+		if (b43_empty_chanspec(&nphy->rssical_chanspec_5G))
 			return;
 		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;
 		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;
@@ -2440,7 +2453,7 @@ static void b43_nphy_save_cal(struct b43_wldev *dev)
 
 	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
 	u16 *txcal_radio_regs = NULL;
-	u8 *iqcal_chanspec;
+	struct b43_chanspec *iqcal_chanspec;
 	u16 *table = NULL;
 
 	if (nphy->hang_avoid)
@@ -2496,12 +2509,12 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
 	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
 
 	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
-		if (nphy->iqcal_chanspec_2G == 0)
+		if (b43_empty_chanspec(&nphy->iqcal_chanspec_2G))
 			return;
 		table = nphy->cal_cache.txcal_coeffs_2G;
 		loft = &nphy->cal_cache.txcal_coeffs_2G[5];
 	} else {
-		if (nphy->iqcal_chanspec_5G == 0)
+		if (b43_empty_chanspec(&nphy->iqcal_chanspec_5G))
 			return;
 		table = nphy->cal_cache.txcal_coeffs_5G;
 		loft = &nphy->cal_cache.txcal_coeffs_5G[5];
@@ -2746,8 +2759,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
 						nphy->txiqlocal_bestc);
 			nphy->txiqlocal_coeffsvalid = true;
-			/* TODO: Set nphy->txiqlocal_chanspec to
-				the current channel */
+			nphy->txiqlocal_chanspec = nphy->radio_chanspec;
 		} else {
 			length = 11;
 			if (dev->phy.rev < 3)
@@ -2782,7 +2794,8 @@ static void b43_nphy_reapply_tx_cal_coeffs(struct b43_wldev *dev)
 	u16 buffer[7];
 	bool equal = true;
 
-	if (!nphy->txiqlocal_coeffsvalid || 1 /* FIXME */)
+	if (!nphy->txiqlocal_coeffsvalid ||
+	    b43_eq_chanspecs(&nphy->txiqlocal_chanspec, &nphy->radio_chanspec))
 		return;
 
 	b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);
@@ -3137,9 +3150,11 @@ int b43_phy_initn(struct b43_wldev *dev)
 	do_rssi_cal = false;
 	if (phy->rev >= 3) {
 		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
-			do_rssi_cal = (nphy->rssical_chanspec_2G == 0);
+			do_rssi_cal =
+				b43_empty_chanspec(&nphy->rssical_chanspec_2G);
 		else
-			do_rssi_cal = (nphy->rssical_chanspec_5G == 0);
+			do_rssi_cal =
+				b43_empty_chanspec(&nphy->rssical_chanspec_5G);
 
 		if (do_rssi_cal)
 			b43_nphy_rssi_cal(dev);
@@ -3151,9 +3166,9 @@ int b43_phy_initn(struct b43_wldev *dev)
 
 	if (!((nphy->measure_hold & 0x6) != 0)) {
 		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
-			do_cal = (nphy->iqcal_chanspec_2G == 0);
+			do_cal = b43_empty_chanspec(&nphy->iqcal_chanspec_2G);
 		else
-			do_cal = (nphy->iqcal_chanspec_5G == 0);
+			do_cal = b43_empty_chanspec(&nphy->iqcal_chanspec_5G);
 
 		if (nphy->mute)
 			do_cal = false;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 47d20dc..e7acae2 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -984,7 +984,7 @@ struct b43_phy_n {
 	u16 papd_epsilon_offset[2];
 	s32 preamble_override;
 	u32 bb_mult_save;
-	u16 radio_chanspec;
+	struct b43_chanspec radio_chanspec;
 
 	bool gain_boost;
 	bool elna_gain_config;
@@ -1000,6 +1000,7 @@ struct b43_phy_n {
 	u16 txiqlocal_bestc[11];
 	bool txiqlocal_coeffsvalid;
 	struct b43_phy_n_txpwrindex txpwrindex[2];
+	struct b43_chanspec txiqlocal_chanspec;
 
 	u8 txrx_chain;
 	u16 tx_rx_cal_phy_saveregs[11];
@@ -1015,12 +1016,12 @@ struct b43_phy_n {
 	bool gband_spurwar_en;
 
 	bool ipa2g_on;
-	u8 iqcal_chanspec_2G;
-	u8 rssical_chanspec_2G;
+	struct b43_chanspec iqcal_chanspec_2G;
+	struct b43_chanspec rssical_chanspec_2G;
 
 	bool ipa5g_on;
-	u8 iqcal_chanspec_5G;
-	u8 rssical_chanspec_5G;
+	struct b43_chanspec iqcal_chanspec_5G;
+	struct b43_chanspec rssical_chanspec_5G;
 
 	struct b43_phy_n_rssical_cache rssical_cache;
 	struct b43_phy_n_cal_cache cal_cache;
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:39 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:39 +0100
Subject: [PATCH 07/11] b43: N-PHY: adjust gain table
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-8-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   58 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 57 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 4ff09b8..835d0da 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -837,6 +837,62 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/AdjustLnaGainTbl */
+static void b43_nphy_adjust_lna_gain_table(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u8 i;
+	s16 tmp;
+	u16 data[4];
+	s16 gain[2];
+	u16 minmax[2];
+	u16 lna_gain[4] = { -2, 10, 19, 25 };
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	if (nphy->gain_boost) {
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+			gain[0] = 6;
+			gain[1] = 6;
+		} else {
+			tmp = 40370 - 315 * nphy->radio_chanspec.channel;
+			gain[0] = ((tmp >> 13) + ((tmp >> 12) & 1));
+			tmp = 23242 - 224 * nphy->radio_chanspec.channel;
+			gain[1] = ((tmp >> 13) + ((tmp >> 12) & 1));
+		}
+	} else {
+		gain[0] = 0;
+		gain[1] = 0;
+	}
+
+	for (i = 0; i < 2; i++) {
+		if (nphy->elna_gain_config) {
+			data[0] = 19 + gain[i];
+			data[1] = 25 + gain[i];
+			data[2] = 25 + gain[i];
+			data[3] = 25 + gain[i];
+		} else {
+			data[0] = lna_gain[0] + gain[i];
+			data[1] = lna_gain[1] + gain[i];
+			data[2] = lna_gain[2] + gain[i];
+			data[3] = lna_gain[3] + gain[i];
+		}
+		b43_ntab_write_bulk(dev, B43_NTAB16(10, 8), 4, data);
+
+		minmax[i] = 23 + gain[i];
+	}
+
+	b43_phy_maskset(dev, B43_NPHY_C1_MINMAX_GAIN, ~B43_NPHY_C1_MINGAIN,
+				minmax[0] << B43_NPHY_C1_MINGAIN_SHIFT);
+	b43_phy_maskset(dev, B43_NPHY_C2_MINMAX_GAIN, ~B43_NPHY_C2_MINGAIN,
+				minmax[1] << B43_NPHY_C2_MINGAIN_SHIFT);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */
 static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 {
@@ -921,7 +977,7 @@ static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 		b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
 					(code << 8 | 0x7C));
 
-		/* TODO: b43_nphy_adjust_lna_gain_table(dev); */
+		b43_nphy_adjust_lna_gain_table(dev);
 
 		if (nphy->elna_gain_config) {
 			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0808);
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:40 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:40 +0100
Subject: [PATCH 08/11] b43: implement writing to MMIO shared memory
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-9-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_common.c |   11 +++++++++++
 drivers/net/wireless/b43/phy_common.h |    2 ++
 2 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
index 8f7d7ef..0b0f9df 100644
--- a/drivers/net/wireless/b43/phy_common.c
+++ b/drivers/net/wireless/b43/phy_common.c
@@ -466,3 +466,14 @@ struct b43_c32 b43_cordic(int theta)
 
 	return ret;
 }
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/BmacWriteShm */
+void b43_bmac_write_shm(struct b43_wldev *dev, u32 offset, u16 value)
+{
+	b43_write32(dev, B43_MMIO_SHM_CONTROL, 0x00010000 | (offset >> 2));
+	b43_read32(dev, B43_MMIO_SHM_CONTROL);
+	if (offset & 2)
+		b43_write16(dev, 0x165, value);
+	else
+		b43_write16(dev, B43_MMIO_SHM_DATA, value);
+}
diff --git a/drivers/net/wireless/b43/phy_common.h b/drivers/net/wireless/b43/phy_common.h
index bd480b4..484d4d7 100644
--- a/drivers/net/wireless/b43/phy_common.h
+++ b/drivers/net/wireless/b43/phy_common.h
@@ -429,4 +429,6 @@ void b43_phyop_switch_analog_generic(struct b43_wldev *dev, bool on);
 
 struct b43_c32 b43_cordic(int theta);
 
+void b43_bmac_write_shm(struct b43_wldev *dev, u32 offset, u16 value);
+
 #endif /* LINUX_B43_PHY_COMMON_H_ */
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:41 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:41 +0100
Subject: [PATCH 09/11] b43: N-PHY: isloate 2055 radio setup
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-10-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   24 ++++++++++++++++++------
 1 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 835d0da..631e01f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -155,6 +155,23 @@ static void b43_nphy_tx_power_fix(struct b43_wldev *dev)
 	//TODO
 }
 
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2055Setup */
+static void b43_radio_2055_setup(struct b43_wldev *dev,
+				const struct b43_nphy_channeltab_entry *e)
+{
+	B43_WARN_ON(dev->phy.rev >= 3);
+
+	b43_chantab_radio_upload(dev, e);
+	udelay(50);
+	b43_radio_write(dev, B2055_VCO_CAL10, 5);
+	b43_radio_write(dev, B2055_VCO_CAL10, 45);
+	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
+		b43_read32(dev, B43_MMIO_MACCTL);
+	b43_radio_write(dev, B2055_VCO_CAL10, 65);
+	udelay(300);
+}
+
 /* Tune the hardware to a new channel. */
 static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
 {
@@ -169,12 +186,7 @@ static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
 		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x20);
 	else
 		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x50);
-	b43_chantab_radio_upload(dev, tabent);
-	udelay(50);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 5);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 45);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 65);
-	udelay(300);
+	b43_radio_2055_setup(dev, tabent);
 	if (0 /*FIXME 5Ghz*/)
 		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
 	else
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:42 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:42 +0100
Subject: [PATCH 10/11] b43: N-PHY: implement chanspec setup
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-11-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   62 ++++++++++++++++++++++++++++++++++++++
 1 files changed, 62 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 631e01f..19d4f11 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -3283,6 +3283,68 @@ int b43_phy_initn(struct b43_wldev *dev)
 	return 0;
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ChanspecSetup */
+static void b43_nphy_chanspec_setup(struct b43_wldev *dev,
+				const struct b43_nphy_channeltab_entry *e,
+				struct b43_chanspec chanspec)
+{
+	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 tmp;
+	u32 tmp32;
+
+	tmp = b43_phy_read(dev, B43_NPHY_BANDCTL) & B43_NPHY_BANDCTL_5GHZ;
+	if (chanspec.b_freq == 1 && tmp == 0) {
+		tmp32 = b43_read32(dev, B43_MMIO_PSM_PHY_HDR);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32 | 4);
+		b43_phy_set(dev, B43_PHY_B_BBCFG, 0xC000);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32);
+		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
+	} else if (chanspec.b_freq == 1) {
+		b43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);
+		tmp32 = b43_read32(dev, B43_MMIO_PSM_PHY_HDR);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32 | 4);
+		b43_phy_mask(dev, B43_PHY_B_BBCFG, (u16)~0xC000);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32);
+	}
+
+	b43_chantab_phy_upload(dev, e);
+
+	tmp = chanspec.channel;
+	if (chanspec.b_freq == 1)
+		tmp |= 0x0100;
+	if (chanspec.b_width == 3)
+		tmp |= 0x0200;
+	b43_bmac_write_shm(dev, 0xA0, tmp);
+
+	if (nphy->radio_chanspec.channel == 14) {
+		b43_nphy_classifier(dev, 2, 0);
+		b43_phy_set(dev, B43_PHY_B_TEST, 0x0800);
+	} else {
+		b43_nphy_classifier(dev, 2, 2);
+		if (chanspec.b_freq == 2)
+			b43_phy_mask(dev, B43_PHY_B_TEST, ~0x840);
+	}
+
+	if (nphy->txpwrctrl)
+		b43_nphy_tx_power_fix(dev);
+
+	if (dev->phy.rev < 3)
+		b43_nphy_adjust_lna_gain_table(dev);
+
+	b43_nphy_tx_lp_fbw(dev);
+
+	if (dev->phy.rev >= 3 && 0) {
+		/* TODO */
+	}
+
+	b43_phy_write(dev, B43_NPHY_NDATAT_DUP40, 0x3830);
+
+	if (phy->rev >= 3)
+		b43_nphy_spur_workaround(dev);
+}
+
 static int b43_nphy_op_allocate(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy;
-- 
1.6.4.2



From zajec5 at gmail.com  Tue Feb  9 21:04:43 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Tue,  9 Feb 2010 21:04:43 +0100
Subject: [PATCH 11/11] b43: N-PHY: switch to chanspec ops
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <1265745883-3392-12-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   87 +++++++++++++++++++++++++++-----------
 drivers/net/wireless/b43/phy_n.h |    1 +
 2 files changed, 63 insertions(+), 25 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 19d4f11..49256bf 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -72,6 +72,7 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 						u16 value, u8 core, bool off);
 static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
 						u16 value, u8 core);
+static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel);
 
 static inline bool b43_empty_chanspec(struct b43_chanspec *chanspec)
 {
@@ -172,31 +173,6 @@ static void b43_radio_2055_setup(struct b43_wldev *dev,
 	udelay(300);
 }
 
-/* Tune the hardware to a new channel. */
-static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
-{
-	const struct b43_nphy_channeltab_entry *tabent;
-
-	tabent = b43_nphy_get_chantabent(dev, channel);
-	if (!tabent)
-		return -ESRCH;
-
-	//FIXME enable/disable band select upper20 in RXCTL
-	if (0 /*FIXME 5Ghz*/)
-		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x20);
-	else
-		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x50);
-	b43_radio_2055_setup(dev, tabent);
-	if (0 /*FIXME 5Ghz*/)
-		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
-	else
-		b43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);
-	b43_chantab_phy_upload(dev, tabent);
-	b43_nphy_tx_power_fix(dev);
-
-	return 0;
-}
-
 static void b43_radio_init2055_pre(struct b43_wldev *dev)
 {
 	b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
@@ -3345,6 +3321,67 @@ static void b43_nphy_chanspec_setup(struct b43_wldev *dev,
 		b43_nphy_spur_workaround(dev);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetChanspec */
+static int b43_nphy_set_chanspec(struct b43_wldev *dev,
+					struct b43_chanspec chanspec)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	const struct b43_nphy_channeltab_entry *tabent;
+
+	u8 tmp;
+	u8 channel = chanspec.channel;
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	}
+
+	nphy->radio_chanspec = chanspec;
+
+	if (chanspec.b_width != nphy->b_widht)
+		; /* TODO: BMAC BW Set (chanspec.b_width) */
+
+	/* TODO: use defines */
+	if (chanspec.b_width == 3) {
+		if (chanspec.sideband == 2)
+			b43_phy_set(dev, B43_NPHY_RXCTL,
+					B43_NPHY_RXCTL_BSELU20);
+		else
+			b43_phy_mask(dev, B43_NPHY_RXCTL,
+					~B43_NPHY_RXCTL_BSELU20);
+	}
+
+	if (dev->phy.rev >= 3) {
+		tmp = (chanspec.b_freq == 1) ? 4 : 0;
+		b43_radio_maskset(dev, 0x08, 0xFFFB, tmp);
+		/* TODO: PHY Radio2056 Setup (chan_info_ptr[i]) */
+		/* TODO: N PHY Chanspec Setup (chan_info_ptr[i]) */
+	} else {
+		tabent = b43_nphy_get_chantabent(dev, channel);
+		if (!tabent)
+			return -ESRCH;
+
+		tmp = (chanspec.b_freq == 1) ? 0x0020 : 0x0050;
+		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, tmp);
+		b43_radio_2055_setup(dev, tabent);
+		b43_nphy_chanspec_setup(dev, tabent, chanspec);
+	}
+
+	return 0;
+}
+
+/* Tune the hardware to a new channel */
+static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	struct b43_chanspec chanspec;
+	chanspec = nphy->radio_chanspec;
+	chanspec.channel = channel;
+
+	return b43_nphy_set_chanspec(dev, chanspec);
+}
+
 static int b43_nphy_op_allocate(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e7acae2..26d01fe 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -984,6 +984,7 @@ struct b43_phy_n {
 	u16 papd_epsilon_offset[2];
 	s32 preamble_override;
 	u32 bb_mult_save;
+	u8 b_widht;
 	struct b43_chanspec radio_chanspec;
 
 	bool gain_boost;
-- 
1.6.4.2



From Larry.Finger at lwfinger.net  Tue Feb  9 21:23:06 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 09 Feb 2010 14:23:06 -0600
Subject: [PATCH 11/11] b43: N-PHY: switch to chanspec ops
In-Reply-To: <1265745883-3392-12-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<1265745883-3392-12-git-send-email-zajec5@gmail.com>
Message-ID: <4B71C42A.3090707@lwfinger.net>

On 02/09/2010 02:04 PM, Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
>  drivers/net/wireless/b43/phy_n.c |   87 +++++++++++++++++++++++++++-----------
>  drivers/net/wireless/b43/phy_n.h |    1 +
>  2 files changed, 63 insertions(+), 25 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
> index 19d4f11..49256bf 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -72,6 +72,7 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
>  						u16 value, u8 core, bool off);
>  static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
>  						u16 value, u8 core);
> +static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel);
>  
>  static inline bool b43_empty_chanspec(struct b43_chanspec *chanspec)
>  {
> @@ -172,31 +173,6 @@ static void b43_radio_2055_setup(struct b43_wldev *dev,
>  	udelay(300);
>  }
>  
> -/* Tune the hardware to a new channel. */
> -static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
> -{
> -	const struct b43_nphy_channeltab_entry *tabent;
> -
> -	tabent = b43_nphy_get_chantabent(dev, channel);
> -	if (!tabent)
> -		return -ESRCH;
> -
> -	//FIXME enable/disable band select upper20 in RXCTL
> -	if (0 /*FIXME 5Ghz*/)
> -		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x20);
> -	else
> -		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x50);
> -	b43_radio_2055_setup(dev, tabent);
> -	if (0 /*FIXME 5Ghz*/)
> -		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
> -	else
> -		b43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);
> -	b43_chantab_phy_upload(dev, tabent);
> -	b43_nphy_tx_power_fix(dev);
> -
> -	return 0;
> -}
> -
>  static void b43_radio_init2055_pre(struct b43_wldev *dev)
>  {
>  	b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
> @@ -3345,6 +3321,67 @@ static void b43_nphy_chanspec_setup(struct b43_wldev *dev,
>  		b43_nphy_spur_workaround(dev);
>  }
>  
> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetChanspec */
> +static int b43_nphy_set_chanspec(struct b43_wldev *dev,
> +					struct b43_chanspec chanspec)
> +{
> +	struct b43_phy_n *nphy = dev->phy.n;
> +
> +	const struct b43_nphy_channeltab_entry *tabent;
> +
> +	u8 tmp;
> +	u8 channel = chanspec.channel;
> +
> +	if (dev->phy.rev >= 3) {
> +		/* TODO */
> +	}
> +
> +	nphy->radio_chanspec = chanspec;
> +
> +	if (chanspec.b_width != nphy->b_widht)
> +		; /* TODO: BMAC BW Set (chanspec.b_width) */
> +
> +	/* TODO: use defines */
> +	if (chanspec.b_width == 3) {
> +		if (chanspec.sideband == 2)
> +			b43_phy_set(dev, B43_NPHY_RXCTL,
> +					B43_NPHY_RXCTL_BSELU20);
> +		else
> +			b43_phy_mask(dev, B43_NPHY_RXCTL,
> +					~B43_NPHY_RXCTL_BSELU20);
> +	}
> +
> +	if (dev->phy.rev >= 3) {
> +		tmp = (chanspec.b_freq == 1) ? 4 : 0;
> +		b43_radio_maskset(dev, 0x08, 0xFFFB, tmp);
> +		/* TODO: PHY Radio2056 Setup (chan_info_ptr[i]) */
> +		/* TODO: N PHY Chanspec Setup (chan_info_ptr[i]) */
> +	} else {
> +		tabent = b43_nphy_get_chantabent(dev, channel);
> +		if (!tabent)
> +			return -ESRCH;
> +
> +		tmp = (chanspec.b_freq == 1) ? 0x0020 : 0x0050;
> +		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, tmp);
> +		b43_radio_2055_setup(dev, tabent);
> +		b43_nphy_chanspec_setup(dev, tabent, chanspec);
> +	}
> +
> +	return 0;
> +}
> +
> +/* Tune the hardware to a new channel */
> +static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
> +{
> +	struct b43_phy_n *nphy = dev->phy.n;
> +
> +	struct b43_chanspec chanspec;
> +	chanspec = nphy->radio_chanspec;
> +	chanspec.channel = channel;
> +
> +	return b43_nphy_set_chanspec(dev, chanspec);
> +}
> +
>  static int b43_nphy_op_allocate(struct b43_wldev *dev)
>  {
>  	struct b43_phy_n *nphy;
> diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
> index e7acae2..26d01fe 100644
> --- a/drivers/net/wireless/b43/phy_n.h
> +++ b/drivers/net/wireless/b43/phy_n.h
> @@ -984,6 +984,7 @@ struct b43_phy_n {
>  	u16 papd_epsilon_offset[2];
>  	s32 preamble_override;
>  	u32 bb_mult_save;
> +	u8 b_widht;

Typo here?

>  	struct b43_chanspec radio_chanspec;
>  
>  	bool gain_boost;



From mb at bu3sch.de  Tue Feb  9 23:59:23 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 9 Feb 2010 23:59:23 +0100
Subject: [PATCH 08/11] b43: implement writing to MMIO shared memory
In-Reply-To: <1265745883-3392-9-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<1265745883-3392-9-git-send-email-zajec5@gmail.com>
Message-ID: <201002092359.24301.mb@bu3sch.de>

On Tuesday 09 February 2010 21:04:40 Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
>  drivers/net/wireless/b43/phy_common.c |   11 +++++++++++
>  drivers/net/wireless/b43/phy_common.h |    2 ++
>  2 files changed, 13 insertions(+), 0 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
> index 8f7d7ef..0b0f9df 100644
> --- a/drivers/net/wireless/b43/phy_common.c
> +++ b/drivers/net/wireless/b43/phy_common.c
> @@ -466,3 +466,14 @@ struct b43_c32 b43_cordic(int theta)
>  
>  	return ret;
>  }
> +
> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/BmacWriteShm */
> +void b43_bmac_write_shm(struct b43_wldev *dev, u32 offset, u16 value)
> +{
> +	b43_write32(dev, B43_MMIO_SHM_CONTROL, 0x00010000 | (offset >> 2));
> +	b43_read32(dev, B43_MMIO_SHM_CONTROL);
> +	if (offset & 2)
> +		b43_write16(dev, 0x165, value);
> +	else
> +		b43_write16(dev, B43_MMIO_SHM_DATA, value);
> +}

I'd like to put a biiiig questionmark on this.
We already have SHM access. Your function does exactly the same, except that it
accesses the bullshit register h165.

-- 
Greetings, Michael.


From mb at bu3sch.de  Wed Feb 10 00:01:00 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 10 Feb 2010 00:01:00 +0100
Subject: [PATCH 09/11] b43: N-PHY: isloate 2055 radio setup
In-Reply-To: <1265745883-3392-10-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<1265745883-3392-10-git-send-email-zajec5@gmail.com>
Message-ID: <201002100001.00411.mb@bu3sch.de>

On Tuesday 09 February 2010 21:04:41 Rafa? Mi?ecki wrote:
> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> ---
>  drivers/net/wireless/b43/phy_n.c |   24 ++++++++++++++++++------
>  1 files changed, 18 insertions(+), 6 deletions(-)
> 
> diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
> index 835d0da..631e01f 100644
> --- a/drivers/net/wireless/b43/phy_n.c
> +++ b/drivers/net/wireless/b43/phy_n.c
> @@ -155,6 +155,23 @@ static void b43_nphy_tx_power_fix(struct b43_wldev *dev)
>  	//TODO
>  }
>  
> +
> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2055Setup */
> +static void b43_radio_2055_setup(struct b43_wldev *dev,
> +				const struct b43_nphy_channeltab_entry *e)
> +{
> +	B43_WARN_ON(dev->phy.rev >= 3);
> +
> +	b43_chantab_radio_upload(dev, e);
> +	udelay(50);
> +	b43_radio_write(dev, B2055_VCO_CAL10, 5);
> +	b43_radio_write(dev, B2055_VCO_CAL10, 45);
> +	if (dev->dev->bus->bustype == SSB_BUSTYPE_PCI)
> +		b43_read32(dev, B43_MMIO_MACCTL);

Just read MACCTL unconditionally. It obviously is just used for bus posting.
We usually also add a comment.

	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */

-- 
Greetings, Michael.


From mb at bu3sch.de  Wed Feb 10 00:02:11 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 10 Feb 2010 00:02:11 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs
	definitions
In-Reply-To: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
Message-ID: <201002100002.11369.mb@bu3sch.de>

On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
> +#define B43_MMIO_PSM_PHY_HDR		0x492	/* programmable state machine */

The comment doesn't make a lot of sense.
In case you don't know, the PSM is the part of the hardware
that executes the firmware.

-- 
Greetings, Michael.


From linville at tuxdriver.com  Mon Feb 15 20:30:43 2010
From: linville at tuxdriver.com (John W. Linville)
Date: Mon, 15 Feb 2010 14:30:43 -0500
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs
	definitions
In-Reply-To: <201002100002.11369.mb@bu3sch.de>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002100002.11369.mb@bu3sch.de>
Message-ID: <20100215193042.GA10665@tuxdriver.com>

On Wed, Feb 10, 2010 at 12:02:11AM +0100, Michael Buesch wrote:
> On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
> > +#define B43_MMIO_PSM_PHY_HDR		0x492	/* programmable state machine */
> 
> The comment doesn't make a lot of sense.
> In case you don't know, the PSM is the part of the hardware
> that executes the firmware.

Rafa?,

Are you going to repost this series and/or respond to Michael's
comments?  I tried to apply some of the ones Michael didn't comment
upon, but they seem to depend on the ones in question.

Thanks,

John
-- 
John W. Linville		Someday the world will need a hero, and you
linville at tuxdriver.com			might be all we have.  Be ready.


From info at lategoodbye.de  Fri Feb 19 07:47:53 2010
From: info at lategoodbye.de (Stefan Wahren)
Date: Fri, 19 Feb 2010 07:47:53 +0100
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <4B6D4365.2040803@lategoodbye.de>
References: <4B6D4365.2040803@lategoodbye.de>
Message-ID: <4B7E3419.9090603@lategoodbye.de>

Hi,

it's me again. The problem still exists. I had no idea to get it better
reproduceable. Please tell me what information do you need to fix it.

Thanks in advice.

Stefan

Stefan Wahren schrieb:
> Hi,
> 
> i'm using OpenWRT on an ASUS WL-500gP V2 with the built-in Broadcom
> BCM3302. After a few hours the b43 driver crashes with a skb_over_panic
> and i need to reboot the device. The crash happend also, if there is no
> traffic over the wireless interface. The wireless interface is
> configured in AP mode and the encryption psk2.
> 
> The used kernel (Linux OpenWrt 2.6.30.10 #1 Tue Feb 2 01:15:42 CET 2010
> mips GNU/Linux) throws the following output:
> 
> skb_over_panic: text:80c9a8e4 len:2374 put:2374 head:80e79000
> data:80e79040 tail:0x80e79986 end:0x80e79980 dev:<NULL>
> Kernel bug detected[#1]:
> Cpu 0
> $ 0   : 00000000 1000f800 00000079 00000001
> $ 4   : 802880c0 0000271f ffffffff 0000271f
> $ 8   : 00004000 00000000 802959b0 00000001
> $12   : 0000000f 8022a1d0 ffffffff 7ffb537b
> $16   : 00e79040 80e79040 00000928 80e9a9a0
> $20   : 80d84c80 00000019 a0df7190 80ca1518
> $24   : 00000002 80151108
> $28   : 80ea0000 80ea1e60 0000001b 8018c2d4
> Hi    : 00000000
> Lo    : 00000077
> epc   : 8018c2d4 skb_put+0x74/0x90
>     Not tainted
> ra    : 8018c2d4 skb_put+0x74/0x90
> Status: 1000f803    KERNEL EXL IE
> Cause : 00800024
> PrId  : 00029029 (Broadcom BCM3302)
> Modules linked in: pl2303 option ftdi_sio usb_storage usbserial ohci_hcd
> nf_nat_
> tftp nf_conntrack_tftp nf_nat_irc nf_conntrack_irc nf_nat_ftp
> nf_conntrack_ftp i
> pt_MASQUERADE iptable_nat nf_nat xt_NOTRACK iptable_raw xt_state
> nf_conntrack_ip
> v4 nf_defrag_ipv4 nf_conntrack ehci_hcd sd_mod pppoe pppox ipt_REJECT
> xt_TCPMSS
>           ipt_LOG xt_multiport xt_mac xt_limit iptable_mangle
> iptable_filter ip_tables xt_
>                             tcpudp x_tables ext2 ext3 jbd tun ppp_async
> ppp_generic slhc vfat fat b43 nls_ut
>                                     f8 nls_iso8859_15 nls_iso8859_1
> nls_cp850 nls_cp437 usbcore scsi_mod nls_base ma
>                                                 c80211 cfg80211
> compat_firmware_class compat crc_ccitt arc4 aes_generic deflate
>                                                                 ecb cbc
> switch_robo switch_core diag
> Process compirq/5-b43 (pid: 812, threadinfo=80ea0000, task=81f19188,
> tls=0000000
>            0)
> Stack : 00000000 80c9a8e4 00000946 00000946 80e79000 80e79040 80e79986
> 80e79980
>         80266f84 80d84c80 00000019 80c9a8e4 80287b88 80286170 1000f800
> ffff00fe
>         80ea1fe0 0000f800 80d92d2c 80284000 80ca1518 7f816db4 00010000
> 80c7f400
>         00008000 00010000 fffffffc 802c7860 00010000 fffffffe efffffff
> 80c87420
>         81f19188 80c80000 80e9ee08 8001c63c 80ea0000 80ea1f18 8021db88
> 00000000
>         ...
> Call Trace:
> [<8018c2d4>] skb_put+0x74/0x90
> [<80c9a8e4>] b43_dma_rx+0x338/0x444 [b43]
> [<80c87420>] b43_controller_restart+0x7a0/0x974 [b43]
> 
> 
> Code: afab001c  0c00268d  afa20020 <0200000d> 080630b6  00000000
> 8fbf002c  0120
>               1021  03e00008
> Disabling lock debugging due to kernel taint
> 
> 
> Stefan
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 



From Larry.Finger at lwfinger.net  Fri Feb 19 16:40:40 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Feb 2010 09:40:40 -0600
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <4B7E3419.9090603@lategoodbye.de>
References: <4B6D4365.2040803@lategoodbye.de> <4B7E3419.9090603@lategoodbye.de>
Message-ID: <4B7EB0F8.3000100@lwfinger.net>

On 02/19/2010 12:47 AM, Stefan Wahren wrote:
> Hi,
> 
> it's me again. The problem still exists. I had no idea to get it better
> reproduceable. Please tell me what information do you need to fix it.
> 
> Thanks in advice.
> 
> Stefan
> 
> Stefan Wahren schrieb:
>> Hi,
>>
>> i'm using OpenWRT on an ASUS WL-500gP V2 with the built-in Broadcom
>> BCM3302. After a few hours the b43 driver crashes with a skb_over_panic
>> and i need to reboot the device. The crash happend also, if there is no
>> traffic over the wireless interface. The wireless interface is
>> configured in AP mode and the encryption psk2.
>>
>> The used kernel (Linux OpenWrt 2.6.30.10 #1 Tue Feb 2 01:15:42 CET 2010
>> mips GNU/Linux) throws the following output:
>>
>> skb_over_panic: text:80c9a8e4 len:2374 put:2374 head:80e79000
>> data:80e79040 tail:0x80e79986 end:0x80e79980 dev:<NULL>
>> Kernel bug detected[#1]:
>> Cpu 0
>> $ 0   : 00000000 1000f800 00000079 00000001
>> $ 4   : 802880c0 0000271f ffffffff 0000271f
>> $ 8   : 00004000 00000000 802959b0 00000001
>> $12   : 0000000f 8022a1d0 ffffffff 7ffb537b
>> $16   : 00e79040 80e79040 00000928 80e9a9a0
>> $20   : 80d84c80 00000019 a0df7190 80ca1518
>> $24   : 00000002 80151108
>> $28   : 80ea0000 80ea1e60 0000001b 8018c2d4
>> Hi    : 00000000
>> Lo    : 00000077
>> epc   : 8018c2d4 skb_put+0x74/0x90
>>     Not tainted
>> ra    : 8018c2d4 skb_put+0x74/0x90
>> Status: 1000f803    KERNEL EXL IE
>> Cause : 00800024
>> PrId  : 00029029 (Broadcom BCM3302)
>> Modules linked in: pl2303 option ftdi_sio usb_storage usbserial ohci_hcd
>> nf_nat_
>> tftp nf_conntrack_tftp nf_nat_irc nf_conntrack_irc nf_nat_ftp
>> nf_conntrack_ftp i
>> pt_MASQUERADE iptable_nat nf_nat xt_NOTRACK iptable_raw xt_state
>> nf_conntrack_ip
>> v4 nf_defrag_ipv4 nf_conntrack ehci_hcd sd_mod pppoe pppox ipt_REJECT
>> xt_TCPMSS
>>           ipt_LOG xt_multiport xt_mac xt_limit iptable_mangle
>> iptable_filter ip_tables xt_
>>                             tcpudp x_tables ext2 ext3 jbd tun ppp_async
>> ppp_generic slhc vfat fat b43 nls_ut
>>                                     f8 nls_iso8859_15 nls_iso8859_1
>> nls_cp850 nls_cp437 usbcore scsi_mod nls_base ma
>>                                                 c80211 cfg80211
>> compat_firmware_class compat crc_ccitt arc4 aes_generic deflate
>>                                                                 ecb cbc
>> switch_robo switch_core diag
>> Process compirq/5-b43 (pid: 812, threadinfo=80ea0000, task=81f19188,
>> tls=0000000
>>            0)
>> Stack : 00000000 80c9a8e4 00000946 00000946 80e79000 80e79040 80e79986
>> 80e79980
>>         80266f84 80d84c80 00000019 80c9a8e4 80287b88 80286170 1000f800
>> ffff00fe
>>         80ea1fe0 0000f800 80d92d2c 80284000 80ca1518 7f816db4 00010000
>> 80c7f400
>>         00008000 00010000 fffffffc 802c7860 00010000 fffffffe efffffff
>> 80c87420
>>         81f19188 80c80000 80e9ee08 8001c63c 80ea0000 80ea1f18 8021db88
>> 00000000
>>         ...
>> Call Trace:
>> [<8018c2d4>] skb_put+0x74/0x90
>> [<80c9a8e4>] b43_dma_rx+0x338/0x444 [b43]
>> [<80c87420>] b43_controller_restart+0x7a0/0x974 [b43]
>>

The traceback indicates a controller restart. Does your log show any reason for
that event? That may help me understand why skb->tail is past skb->end.

Larry



From zajec5 at gmail.com  Fri Feb 19 17:12:59 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Fri, 19 Feb 2010 17:12:59 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs 
	definitions
In-Reply-To: <20100215193042.GA10665@tuxdriver.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002100002.11369.mb@bu3sch.de>
	<20100215193042.GA10665@tuxdriver.com>
Message-ID: <b170af451002190812m9209a1cja236c199da9a019a@mail.gmail.com>

2010/2/15 John W. Linville <linville at tuxdriver.com>:
> On Wed, Feb 10, 2010 at 12:02:11AM +0100, Michael Buesch wrote:
>> On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
>> > +#define B43_MMIO_PSM_PHY_HDR ? ? ? ? ? ? ? 0x492 ? /* programmable state machine */
>>
>> The comment doesn't make a lot of sense.
>> In case you don't know, the PSM is the part of the hardware
>> that executes the firmware.
>
> Rafa?,
>
> Are you going to repost this series and/or respond to Michael's
> comments? ?I tried to apply some of the ones Michael didn't comment
> upon, but they seem to depend on the ones in question.

I got some exams recently and today I got one more for recrucation for
new studies level. Will fix patches this week.

-- 
Rafa?


From Larry.Finger at lwfinger.net  Fri Feb 19 19:02:44 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Feb 2010 12:02:44 -0600
Subject: [PATCH] ssb: Add PCI ID 0x4322 to PHU handling
Message-ID: <4b7ed244.kkOlTpyZEarNKwxu%Larry.Finger@lwfinger.net>

Some of the N PHYs need a revision in the handling of the PMU.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This will be needed for some of the N PHY devices - 2.6.34 amterial.

Larry
---

Index: wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
===================================================================
--- wireless-testing.orig/drivers/ssb/driver_chipcommon_pmu.c
+++ wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
@@ -332,6 +332,12 @@ static void ssb_pmu_pll_init(struct ssb_
 	case 0x5354:
 		ssb_pmu0_pllinit_r0(cc, crystalfreq);
 		break;
+	case 0x4322:
+		if (cc->pmu.rev == 2) {
+			chipco_write32(cc, SSB_CHIPCO_PLLCTL_ADDR, 0x0000000A);
+			chipco_write32(cc, SSB_CHIPCO_PLLCTL_DATA, 0x380005C0);
+		}
+		break;
 	default:
 		ssb_printk(KERN_ERR PFX
 			   "ERROR: PLL init unknown for device %04X\n",
@@ -417,6 +423,7 @@ static void ssb_pmu_resources_init(struc
 
 	switch (bus->chip_id) {
 	case 0x4312:
+	case 0x4322:
 		/* We keep the default settings:
 		 * min_msk = 0xCBB
 		 * max_msk = 0x7FFFF


From mb at bu3sch.de  Fri Feb 19 19:25:08 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 19 Feb 2010 19:25:08 +0100
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <4B7EB0F8.3000100@lwfinger.net>
References: <4B6D4365.2040803@lategoodbye.de> <4B7E3419.9090603@lategoodbye.de>
	<4B7EB0F8.3000100@lwfinger.net>
Message-ID: <201002191925.08642.mb@bu3sch.de>

On Friday 19 February 2010 16:40:40 Larry Finger wrote:
> >> [<8018c2d4>] skb_put+0x74/0x90
> >> [<80c9a8e4>] b43_dma_rx+0x338/0x444 [b43]
> >> [<80c87420>] b43_controller_restart+0x7a0/0x974 [b43]
> >>
> 
> The traceback indicates a controller restart. Does your log show any reason for
> that event? That may help me understand why skb->tail is past skb->end.

Note that on bcm47xx backtraces are _extremely_ unreliable.
As b43_controller_restart does not call b43_dma_rx, yet it shows it
this way in the backtrace, I think that line is just invalid.

-- 
Greetings, Michael.


From info at lategoodbye.de  Fri Feb 19 21:28:01 2010
From: info at lategoodbye.de (Stefan Wahren)
Date: Fri, 19 Feb 2010 21:28:01 +0100
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <201002191925.08642.mb@bu3sch.de>
References: <4B6D4365.2040803@lategoodbye.de> <4B7E3419.9090603@lategoodbye.de>
	<4B7EB0F8.3000100@lwfinger.net> <201002191925.08642.mb@bu3sch.de>
Message-ID: <4B7EF451.1070701@lategoodbye.de>

> On Friday 19 February 2010 16:40:40 Larry Finger wrote:
>>>> [<8018c2d4>] skb_put+0x74/0x90
>>>> [<80c9a8e4>] b43_dma_rx+0x338/0x444 [b43]
>>>> [<80c87420>] b43_controller_restart+0x7a0/0x974 [b43]
>>>>
>> The traceback indicates a controller restart. Does your log show any reason for
>> that event? That may help me understand why skb->tail is past skb->end.

@Larry: I activated CONFIG_KERNEL_KALLSYMS in the build settings of
OpenWRT as told in an old ticker to get this traceback. Poorly, there is
no more output from the kernel than this.

> Note that on bcm47xx backtraces are _extremely_ unreliable.
> As b43_controller_restart does not call b43_dma_rx, yet it shows it
> this way in the backtrace, I think that line is just invalid.
> 

@Michael: Okay, is there any method to get more reliable information
about the kernel panic (strace, ...) or a idea to faster reproduce the
kernel panic than waiting?

Stefan


From mb at bu3sch.de  Fri Feb 19 21:55:17 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 19 Feb 2010 21:55:17 +0100
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <4B7EF451.1070701@lategoodbye.de>
References: <4B6D4365.2040803@lategoodbye.de> <201002191925.08642.mb@bu3sch.de>
	<4B7EF451.1070701@lategoodbye.de>
Message-ID: <201002192155.17579.mb@bu3sch.de>

On Friday 19 February 2010 21:28:01 Stefan Wahren wrote:
> @Michael: Okay, is there any method to get more reliable information
> about the kernel panic (strace, ...) or a idea to faster reproduce the
> kernel panic than waiting?

I think the backtrace is pretty good as-is, if you ignore the controller_restart
line. It's pretty obvious that this is an skb overflow panic caused by a
received packet. There's nothing in the trace that falsifies this, as far as I
can see.
So what if you set up another device in monitor mode and simply capture all packets
until the error happens again? If the panic happened by receiving a malformed
packet, it should be obvious to see then.

-- 
Greetings, Michael.


From info at lategoodbye.de  Fri Feb 19 22:58:37 2010
From: info at lategoodbye.de (Stefan Wahren)
Date: Fri, 19 Feb 2010 22:58:37 +0100
Subject: skb_over_panic from b43 after a few hours
In-Reply-To: <201002192155.17579.mb@bu3sch.de>
References: <4B6D4365.2040803@lategoodbye.de> <201002191925.08642.mb@bu3sch.de>
	<4B7EF451.1070701@lategoodbye.de> <201002192155.17579.mb@bu3sch.de>
Message-ID: <4B7F098D.5050503@lategoodbye.de>

> I think the backtrace is pretty good as-is, if you ignore the controller_restart
> line. It's pretty obvious that this is an skb overflow panic caused by a
> received packet. There's nothing in the trace that falsifies this, as far as I
> can see.
> So what if you set up another device in monitor mode and simply capture all packets
> until the error happens again? If the panic happened by receiving a malformed
> packet, it should be obvious to see then.
> 

Okay, i will try it and post the results.

Stefan


From netrolller.3d at gmail.com  Sat Feb 20 18:36:40 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 20 Feb 2010 18:36:40 +0100
Subject: [PATCH] ssb: Add PCI ID 0x4322 to PHU handling
In-Reply-To: <4b7ed244.kkOlTpyZEarNKwxu%Larry.Finger@lwfinger.net>
References: <4b7ed244.kkOlTpyZEarNKwxu%Larry.Finger@lwfinger.net>
Message-ID: <69e28c911002200936y33e2e9duc9c3f40253acf473@mail.gmail.com>

On Fri, Feb 19, 2010 at 7:02 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> Some of the N PHYs need a revision in the handling of the PMU.
>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
>
> John,
>
> This will be needed for some of the N PHY devices - 2.6.34 amterial.
>
> Larry
> ---
>
> Index: wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
> ===================================================================
> --- wireless-testing.orig/drivers/ssb/driver_chipcommon_pmu.c
> +++ wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
> @@ -332,6 +332,12 @@ static void ssb_pmu_pll_init(struct ssb_
> ? ? ? ?case 0x5354:
> ? ? ? ? ? ? ? ?ssb_pmu0_pllinit_r0(cc, crystalfreq);
> ? ? ? ? ? ? ? ?break;
> + ? ? ? case 0x4322:
> + ? ? ? ? ? ? ? if (cc->pmu.rev == 2) {
> + ? ? ? ? ? ? ? ? ? ? ? chipco_write32(cc, SSB_CHIPCO_PLLCTL_ADDR, 0x0000000A);
> + ? ? ? ? ? ? ? ? ? ? ? chipco_write32(cc, SSB_CHIPCO_PLLCTL_DATA, 0x380005C0);
> + ? ? ? ? ? ? ? }
> + ? ? ? ? ? ? ? break;
> ? ? ? ?default:
> ? ? ? ? ? ? ? ?ssb_printk(KERN_ERR PFX
> ? ? ? ? ? ? ? ? ? ? ? ? ? "ERROR: PLL init unknown for device %04X\n",
> @@ -417,6 +423,7 @@ static void ssb_pmu_resources_init(struc
>
> ? ? ? ?switch (bus->chip_id) {
> ? ? ? ?case 0x4312:
> + ? ? ? case 0x4322:
> ? ? ? ? ? ? ? ?/* We keep the default settings:
> ? ? ? ? ? ? ? ? * min_msk = 0xCBB
> ? ? ? ? ? ? ? ? * max_msk = 0x7FFFF
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

Typo in title - PHU should be PMU.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Sat Feb 20 20:49:09 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 20 Feb 2010 13:49:09 -0600
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
Message-ID: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>

Some of the N PHYs need a revision in the handling of the PMU.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This will be needed for some of the N PHY devices - 2.6.34 amterial.

Larry
---

V2 - Fix typo in subject line of commit message.

Index: wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
===================================================================
--- wireless-testing.orig/drivers/ssb/driver_chipcommon_pmu.c
+++ wireless-testing/drivers/ssb/driver_chipcommon_pmu.c
@@ -332,6 +332,12 @@ static void ssb_pmu_pll_init(struct ssb_
 	case 0x5354:
 		ssb_pmu0_pllinit_r0(cc, crystalfreq);
 		break;
+	case 0x4322:
+		if (cc->pmu.rev == 2) {
+			chipco_write32(cc, SSB_CHIPCO_PLLCTL_ADDR, 0x0000000A);
+			chipco_write32(cc, SSB_CHIPCO_PLLCTL_DATA, 0x380005C0);
+		}
+		break;
 	default:
 		ssb_printk(KERN_ERR PFX
 			   "ERROR: PLL init unknown for device %04X\n",
@@ -417,6 +423,7 @@ static void ssb_pmu_resources_init(struc
 
 	switch (bus->chip_id) {
 	case 0x4312:
+	case 0x4322:
 		/* We keep the default settings:
 		 * min_msk = 0xCBB
 		 * max_msk = 0x7FFFF


From strk at keybit.net  Sun Feb 21 01:49:41 2010
From: strk at keybit.net (strk)
Date: Sun, 21 Feb 2010 01:49:41 +0100
Subject: b43legacy-phy3: Radio hardware status changed to XXX
In-Reply-To: <20100207164530.GH89844@keybit.net>
References: <20100206190837.GR48563@keybit.net>
	<201002071548.12268.mb@bu3sch.de>
	<20100207145953.GE89844@keybit.net>
	<201002071605.25568.mb@bu3sch.de>
	<b170af451002070727y492bbe2fof69002bdbaf8c25f@mail.gmail.com>
	<20100207164530.GH89844@keybit.net>
Message-ID: <20100221004941.GX31772@keybit.net>

On Sun, Feb 07, 2010 at 05:45:30PM +0100, strk wrote:
> On Sun, Feb 07, 2010 at 04:27:02PM +0100, Rafa?? Mi??ecki wrote:
> > 2010/2/7 Michael Buesch <mb at bu3sch.de>:
> > >
> > > We are not going to add module options to workaround bugs. We fix the bug instead.
> > 
> > ++
> > 
> > Please test first if it actually changes anything.

Alright guys, I'm back up to speed with my laptop
and in the process of rebuilding the module with RFKILL switch
support disabled at compile time.

Meanwhile (it's an old laptop) I've found a report of someone else
having the same problem with the same laptop who "fixed" it by
doing exactly that (disable the RFKILL compile-time):

http://ubuntuforums.org/showthread.php?t=1368106

Report is of less then two months ago, maybe you may be interested
in tracking that forum..

--strk; 

  ()   Free GIS & Flash consultant/developer
  /\   http://foo.keybit.net/~strk/services.html


From luckyjs at gmail.com  Sun Feb 21 09:06:43 2010
From: luckyjs at gmail.com (jun)
Date: Sun, 21 Feb 2010 02:06:43 -0600
Subject: Unexpected behavior observed in handling IEEE80211_FCTL_PM bit with 
	b43 driver
Message-ID: <ce50f2e21002210006g134f5e02ua38ca094d455e5c1@mail.gmail.com>

Hi All,

mac80211/scan.c uses a NULL frame with IEEE80211_FCTL_PM to switches
between active and powersave mode. I'm test this feature with b43
driver.

However, in the outgoing packets captured by kismet, I found that
IEEE80211_FCTL_PM is always 0, NOT 1. To narrow down the scope for
debugging, I printed out the frame_control of outgoing frames in
b43_dma_tx, right before the packets is sent via DMA.  As expected,
the printout shows that IEEE80211_FCTL_PM is set correctly (0x48
0x11).

Does this mean that firmware/hardware is changing the
IEEE80211_FCTL_PM bit later by itself? If that's the case, do I need
to send some additional control flags to firmware/hardware to avoid
that?

Thank you for your time,

Jun


From mb at bu3sch.de  Sun Feb 21 10:05:53 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 21 Feb 2010 10:05:53 +0100
Subject: Unexpected behavior observed in handling IEEE80211_FCTL_PM bit
	with b43 driver
In-Reply-To: <ce50f2e21002210006g134f5e02ua38ca094d455e5c1@mail.gmail.com>
References: <ce50f2e21002210006g134f5e02ua38ca094d455e5c1@mail.gmail.com>
Message-ID: <201002211005.54295.mb@bu3sch.de>

PS is currently not supported on b43.

-- 
Greetings, Michael.


From zajec5 at gmail.com  Sun Feb 21 11:49:27 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 21 Feb 2010 11:49:27 +0100
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
In-Reply-To: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>
References: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>
Message-ID: <b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>

2010/2/20 Larry Finger <Larry.Finger at lwfinger.net>:
> Some of the N PHYs need a revision in the handling of the PMU.
>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
>
> John,
>
> This will be needed for some of the N PHY devices - 2.6.34 amterial.
>
> Larry
> ---
>
> V2 - Fix typo in subject line of commit message.

amterial you say? ;)

-- 
Rafa?


From netrolller.3d at gmail.com  Sun Feb 21 11:53:31 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 21 Feb 2010 11:53:31 +0100
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
In-Reply-To: <b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>
References: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net> 
	<b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>
Message-ID: <69e28c911002210253v8150259s718d2ba68372f9d1@mail.gmail.com>

2010/2/21 Rafa? Mi?ecki <zajec5 at gmail.com>:
> 2010/2/20 Larry Finger <Larry.Finger at lwfinger.net>:
>> Some of the N PHYs need a revision in the handling of the PMU.
>>
>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>> ---
>>
>> John,
>>
>> This will be needed for some of the N PHY devices - 2.6.34 amterial.
>>
>> Larry
>> ---
>>
>> V2 - Fix typo in subject line of commit message.
>
> amterial you say? ;)

Taht's not prat of the cimmot megasse, it is olny a ntoe to Jhon.
Deons't mtater eevn if it is cmolpelety jmulbed up.

>
> --
> Rafa?
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From johannes at sipsolutions.net  Sun Feb 21 11:55:13 2010
From: johannes at sipsolutions.net (Johannes Berg)
Date: Sun, 21 Feb 2010 11:55:13 +0100
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
In-Reply-To: <69e28c911002210253v8150259s718d2ba68372f9d1@mail.gmail.com>
References: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>
	<b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>
	<69e28c911002210253v8150259s718d2ba68372f9d1@mail.gmail.com>
Message-ID: <1266749713.5468.2.camel@jlt3.sipsolutions.net>

On Sun, 2010-02-21 at 11:53 +0100, G?bor Stefanik wrote:
> 2010/2/21 Rafa? Mi?ecki <zajec5 at gmail.com>:
> > 2010/2/20 Larry Finger <Larry.Finger at lwfinger.net>:
> >> Some of the N PHYs need a revision in the handling of the PMU.
> >>
> >> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> >> ---
> >>
> >> John,
> >>
> >> This will be needed for some of the N PHY devices - 2.6.34
> amterial.
> >>
> >> Larry
> >> ---
> >>
> >> V2 - Fix typo in subject line of commit message.
> >
> > amterial you say? ;)
> 
> Taht's not prat of the cimmot megasse, it is olny a ntoe to Jhon.
> Deons't mtater eevn if it is cmolpelety jmulbed up.

Geez. The patch is already in the tree anyway, with the original typo.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100221/c9823309/attachment.pgp>

From Larry.Finger at lwfinger.net  Sun Feb 21 18:12:35 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 21 Feb 2010 11:12:35 -0600
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
In-Reply-To: <1266749713.5468.2.camel@jlt3.sipsolutions.net>
References: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>	
	<b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>	
	<69e28c911002210253v8150259s718d2ba68372f9d1@mail.gmail.com>
	<1266749713.5468.2.camel@jlt3.sipsolutions.net>
Message-ID: <4B816983.2050006@lwfinger.net>

On 02/21/2010 04:55 AM, Johannes Berg wrote:
> On Sun, 2010-02-21 at 11:53 +0100, G?bor Stefanik wrote:
>> 2010/2/21 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>> 2010/2/20 Larry Finger <Larry.Finger at lwfinger.net>:
>>>> Some of the N PHYs need a revision in the handling of the PMU.
>>>>
>>>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>>>> ---
>>>>
>>>> John,
>>>>
>>>> This will be needed for some of the N PHY devices - 2.6.34
>> amterial.
>>>>
>>>> Larry
>>>> ---
>>>>
>>>> V2 - Fix typo in subject line of commit message.
>>>
>>> amterial you say? ;)
>>
>> Taht's not prat of the cimmot megasse, it is olny a ntoe to Jhon.
>> Deons't mtater eevn if it is cmolpelety jmulbed up.
> 
> Geez. The patch is already in the tree anyway, with the original typo.

I may be getting old and decrepit, but it's OK if the boys just want to have fun
with me.

Larry


From yan at seiner.com  Mon Feb 22 21:03:54 2010
From: yan at seiner.com (Yan Seiner)
Date: Mon, 22 Feb 2010 20:03:54 -0000 (UTC)
Subject: b43 and WPA-PSK
Message-ID: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>

I'm trying to get the b43 driver working on a Linksys WRTSL54GS router. 
It's running Openwrt with the 2.6.32 kernel.  The good news is that the
driver picks up a lot of APs with ease, far more than the binary blob. 
The bad news is that I can't get encryption working.  The output from
iwlist scan is here:

https://forum.openwrt.org/viewtopic.php?pid=103469#p103469

I can't configure it to use WPA-PSK or WPA-PSK2; it simply doesn't see
encryption.  I don't have any WEP APs around so I can't test around those.
 It connects to open APs quite well.  (I haven't tested it much as the
open AP is one of my neighbors, and I really don't want to steal his
broadband.)

Here's a description of the router:

http://oldwiki.openwrt.org/OpenWrtDocs(2f)Hardware(2f)Linksys(2f)WRTSL54GS.html

I would appreciate any suggestions on this.

-- 
If you have eight hours to chop down a tree
spend six sharpening your axe.
--Abraham Lincoln



From zajec5 at gmail.com  Mon Feb 22 23:59:24 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Mon, 22 Feb 2010 23:59:24 +0100
Subject: [PATCH V2] ssb: Add PCI ID 0x4322 to PMU handling
In-Reply-To: <4B816983.2050006@lwfinger.net>
References: <4b803cb5.tZQnvqGy2KfItgOq%Larry.Finger@lwfinger.net>
	<b170af451002210249t5adfa274s6bee0003c1afa497@mail.gmail.com>
	<69e28c911002210253v8150259s718d2ba68372f9d1@mail.gmail.com>
	<1266749713.5468.2.camel@jlt3.sipsolutions.net>
	<4B816983.2050006@lwfinger.net>
Message-ID: <b170af451002221459t1f957e90nf8016ca6ec0d4d53@mail.gmail.com>

2010/2/21 Larry Finger <Larry.Finger at lwfinger.net>:
> On 02/21/2010 04:55 AM, Johannes Berg wrote:
>> On Sun, 2010-02-21 at 11:53 +0100, G?bor Stefanik wrote:
>>> 2010/2/21 Rafa? Mi?ecki <zajec5 at gmail.com>:
>>>> 2010/2/20 Larry Finger <Larry.Finger at lwfinger.net>:
>>>>> Some of the N PHYs need a revision in the handling of the PMU.
>>>>>
>>>>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>>>>> ---
>>>>>
>>>>> John,
>>>>>
>>>>> This will be needed for some of the N PHY devices - 2.6.34
>>> amterial.
>>>>>
>>>>> Larry
>>>>> ---
>>>>>
>>>>> V2 - Fix typo in subject line of commit message.
>>>>
>>>> amterial you say? ;)
>>>
>>> Taht's not prat of the cimmot megasse, it is olny a ntoe to Jhon.
>>> Deons't mtater eevn if it is cmolpelety jmulbed up.
>>
>> Geez. The patch is already in the tree anyway, with the original typo.
>
> I may be getting old and decrepit, but it's OK if the boys just want to have fun
> with me.

And now when typo-ed patch gone git... everyone will see it for ever ;) :P

-- 
Rafa?


From Larry.Finger at lwfinger.net  Tue Feb 23 17:57:11 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Feb 2010 10:57:11 -0600
Subject: b43 and WPA-PSK
In-Reply-To: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>
References: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>
Message-ID: <4B8408E7.2090809@lwfinger.net>

On 02/22/2010 02:03 PM, Yan Seiner wrote:
> I'm trying to get the b43 driver working on a Linksys WRTSL54GS router. 
> It's running Openwrt with the 2.6.32 kernel.  The good news is that the
> driver picks up a lot of APs with ease, far more than the binary blob. 
> The bad news is that I can't get encryption working.  The output from
> iwlist scan is here:
> 
> https://forum.openwrt.org/viewtopic.php?pid=103469#p103469
> 
> I can't configure it to use WPA-PSK or WPA-PSK2; it simply doesn't see
> encryption.  I don't have any WEP APs around so I can't test around those.
>  It connects to open APs quite well.  (I haven't tested it much as the
> open AP is one of my neighbors, and I really don't want to steal his
> broadband.)

I was hoping someone else would answer your mail, but as no one has come
forward, I will try.

I am not an expert on openWRT. I am using the version of Kamikaze with a 2.4
kernel on a WRT54GL, but the firmware is out of the box.

What I do know is that the BCM4318 does work with WPA/WPA2, although my device
is Cardbus format in an old laptop. Using Broadcom's proprietary firmware, as
you seem to be doing, the encryption/decryption is done in the hardware.

I'm a little confused on your usage of the device. As an AP, I see no need to
scan. Are you using it as a station, or as a wireless bridge? In these modes,
would not the bridging code to eth0 get in the way?

Larry


From yan at seiner.com  Tue Feb 23 21:24:10 2010
From: yan at seiner.com (Yan Seiner)
Date: Tue, 23 Feb 2010 20:24:10 -0000 (UTC)
Subject: b43 and WPA-PSK
In-Reply-To: <4B8408E7.2090809@lwfinger.net>
References: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>
	<4B8408E7.2090809@lwfinger.net>
Message-ID: <df226b85d1465daa7e090d97d3978f88.squirrel@mail.seiner.com>


On Tue, February 23, 2010 4:57 pm, Larry Finger wrote:
>
> What I do know is that the BCM4318 does work with WPA/WPA2, although my
> device
> is Cardbus format in an old laptop. Using Broadcom's proprietary firmware,
> as
> you seem to be doing, the encryption/decryption is done in the hardware.

The issues seems to be with the version of wireless utils in the latest
openwrt snapshot.  Sure looked like a driver issue,though.

>
> I'm a little confused on your usage of the device. As an AP, I see no need
> to
> scan. Are you using it as a station, or as a wireless bridge? In these
> modes,
> would not the bridging code to eth0 get in the way?

I am using it in STA mode.

I set up a separate network for the wireless and do not use bridging.  I
have to "wan" ports in effect - one for the wireless and one for wired.  I
don't use the wired port.

It works quite well (or did, until I tried the b43 drivers at which point
I also got the broken version of iwconfig/iwlist.)

--Yan

-- 
If you have eight hours to chop down a tree
spend six sharpening your axe.
--Abraham Lincoln



From hauke at hauke-m.de  Tue Feb 23 21:38:38 2010
From: hauke at hauke-m.de (Hauke Mehrtens)
Date: Tue, 23 Feb 2010 21:38:38 +0100
Subject: b43 and WPA-PSK
In-Reply-To: <df226b85d1465daa7e090d97d3978f88.squirrel@mail.seiner.com>
References: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>	<4B8408E7.2090809@lwfinger.net>
	<df226b85d1465daa7e090d97d3978f88.squirrel@mail.seiner.com>
Message-ID: <4B843CCE.3060708@hauke-m.de>

Yan Seiner wrote:
> On Tue, February 23, 2010 4:57 pm, Larry Finger wrote:
>> What I do know is that the BCM4318 does work with WPA/WPA2, although my
>> device
>> is Cardbus format in an old laptop. Using Broadcom's proprietary firmware,
>> as
>> you seem to be doing, the encryption/decryption is done in the hardware.
> 
> The issues seems to be with the version of wireless utils in the latest
> openwrt snapshot.  Sure looked like a driver issue,though.
> 
>> I'm a little confused on your usage of the device. As an AP, I see no need
>> to
>> scan. Are you using it as a station, or as a wireless bridge? In these
>> modes,
>> would not the bridging code to eth0 get in the way?
> 
> I am using it in STA mode.
> 
> I set up a separate network for the wireless and do not use bridging.  I
> have to "wan" ports in effect - one for the wireless and one for wired.  I
> don't use the wired port.
> 
> It works quite well (or did, until I tried the b43 drivers at which point
> I also got the broken version of iwconfig/iwlist.)
> 
> --Yan
> 
Hi,

Someone reports that the station mode is not working for him in OpenWRT
with ath9k driver after the last update of compat-wireless in OpenWRT.
It was reported in https://dev.openwrt.org/ticket/6712 probably this is
not an issue in the ath9k/b43 driver but in some other part of OpenWRT.

Please try if it helps using an older version of compat-wireless or
using an older version of the hostapd/wpa-supplicant combination. (Just
go back some revisions in the svn for that directories)

Hauke

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 898 bytes
Desc: OpenPGP digital signature
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100223/92387d74/attachment.pgp>

From yan at seiner.com  Tue Feb 23 21:48:55 2010
From: yan at seiner.com (Yan Seiner)
Date: Tue, 23 Feb 2010 20:48:55 -0000 (UTC)
Subject: b43 and WPA-PSK
In-Reply-To: <4B843CCE.3060708@hauke-m.de>
References: <eaa0e1725868d594bdf61e8328c0f9c7.squirrel@mail.seiner.com>
	<4B8408E7.2090809@lwfinger.net>
	<df226b85d1465daa7e090d97d3978f88.squirrel@mail.seiner.com>
	<4B843CCE.3060708@hauke-m.de>
Message-ID: <413e723e8d498ff02026de83cff07188.squirrel@mail.seiner.com>


On Tue, February 23, 2010 8:38 pm, Hauke Mehrtens wrote:
> Yan Seiner wrote:
>> On Tue, February 23, 2010 4:57 pm, Larry Finger wrote:
>>> What I do know is that the BCM4318 does work with WPA/WPA2, although my
>>> device
>>> is Cardbus format in an old laptop. Using Broadcom's proprietary
>>> firmware,
>>> as
>>> you seem to be doing, the encryption/decryption is done in the
>>> hardware.
>>
>> The issues seems to be with the version of wireless utils in the latest
>> openwrt snapshot.  Sure looked like a driver issue,though.
>>
>>> I'm a little confused on your usage of the device. As an AP, I see no
>>> need
>>> to
>>> scan. Are you using it as a station, or as a wireless bridge? In these
>>> modes,
>>> would not the bridging code to eth0 get in the way?
>>
>> I am using it in STA mode.
>>
>> I set up a separate network for the wireless and do not use bridging.  I
>> have to "wan" ports in effect - one for the wireless and one for wired.
>> I
>> don't use the wired port.
>>
>> It works quite well (or did, until I tried the b43 drivers at which
>> point
>> I also got the broken version of iwconfig/iwlist.)
>>
>> --Yan
>>
> Hi,
>
> Someone reports that the station mode is not working for him in OpenWRT
> with ath9k driver after the last update of compat-wireless in OpenWRT.
> It was reported in https://dev.openwrt.org/ticket/6712 probably this is
> not an issue in the ath9k/b43 driver but in some other part of OpenWRT.
>
> Please try if it helps using an older version of compat-wireless or
> using an older version of the hostapd/wpa-supplicant combination. (Just
> go back some revisions in the svn for that directories)

Yes, that is the conclusion I came to.  I opened a ticket earlier today.

https://dev.openwrt.org/ticket/6732

I'll attach it to the other ticket.


-- 
If you have eight hours to chop down a tree
spend six sharpening your axe.
--Abraham Lincoln



From diegogeid at gmail.com  Wed Feb 24 03:43:37 2010
From: diegogeid at gmail.com (D1e6o!)
Date: Tue, 23 Feb 2010 23:43:37 -0300
Subject: Turn broadcom 4311 into master mode
Message-ID: <8592e0921002231843u4d07cdb0u95c6abafce36ef23@mail.gmail.com>

Hello, I'm getting problems to turn my laptop in master mode.

When I try to change the mode I get an error:

sudo iwconfig wlan0 mode master
Error for wireless request "Set Mode" (8B06) :
    SET failed on device wlan0 ; Invalid argument.

I followed the guide to install the drivers and the problem persists
(http://linuxwireless.org/en/users/Drivers/b43/devices), also tried to
use the drivers installed from repositories of ubuntu karmic desktop,
with and without networkmanager running

The board is running fine, I have an broadcom 4311 rev 2 and running
the driver b43

The kernel is from ubuntu, do I need any special compilation of it?

lsmod | grep b43
b43                   136552  0
ssb                    40944  1 b43
mac80211              209912  1 b43
cfg80211              109144  2 b43,mac80211
led_class               5256  1 b43

The driver creates two interfaces, with iwconfig:
(other interfaces of my computer)
...
wmaster0  no wireless extensions.

wlan0     IEEE 802.11bg  ESSID:""
         Mode:Managed  Frequency:2.412 GHz  Access Point: Not-Associated
         Tx-Power=20 dBm
         Retry  long limit:7   RTS thr:off   Fragment thr:off
         Encryption key:off
         Power Management:off
         Link Quality:0  Signal level:0  Noise level:0
         Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
         Tx excessive retries:0  Invalid misc:0   Missed beacon:0

Why I get "Invalid Argument"? The argument Isn't recognized...

Thanks!


From Larry.Finger at lwfinger.net  Wed Feb 24 04:54:15 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Feb 2010 21:54:15 -0600
Subject: Turn broadcom 4311 into master mode
In-Reply-To: <8592e0921002231843u4d07cdb0u95c6abafce36ef23@mail.gmail.com>
References: <8592e0921002231843u4d07cdb0u95c6abafce36ef23@mail.gmail.com>
Message-ID: <4B84A2E7.4050706@lwfinger.net>

On 02/23/2010 08:43 PM, D1e6o! wrote:
> Hello, I'm getting problems to turn my laptop in master mode.
> 
> When I try to change the mode I get an error:
> 
> sudo iwconfig wlan0 mode master
> Error for wireless request "Set Mode" (8B06) :
>     SET failed on device wlan0 ; Invalid argument.
> 
> I followed the guide to install the drivers and the problem persists
> (http://linuxwireless.org/en/users/Drivers/b43/devices), also tried to
> use the drivers installed from repositories of ubuntu karmic desktop,
> with and without networkmanager running
> 
> The board is running fine, I have an broadcom 4311 rev 2 and running
> the driver b43
> 
> The kernel is from ubuntu, do I need any special compilation of it?
> 
> lsmod | grep b43
> b43                   136552  0
> ssb                    40944  1 b43
> mac80211              209912  1 b43
> cfg80211              109144  2 b43,mac80211
> led_class               5256  1 b43
> 
> The driver creates two interfaces, with iwconfig:
> (other interfaces of my computer)
> ...
> wmaster0  no wireless extensions.
> 
> wlan0     IEEE 802.11bg  ESSID:""
>          Mode:Managed  Frequency:2.412 GHz  Access Point: Not-Associated
>          Tx-Power=20 dBm
>          Retry  long limit:7   RTS thr:off   Fragment thr:off
>          Encryption key:off
>          Power Management:off
>          Link Quality:0  Signal level:0  Noise level:0
>          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> Why I get "Invalid Argument"? The argument Isn't recognized...

That is not the correct way to set master or AP mode. One way is described in
the first post in the openSYSE Wireless Forum at http://tinyurl.com/yzlp7nm. It
contains the scripts needed to implement an AP using hostapd and DHCP. The
firewall is left to you. This way will work with b43 as long as hostapd is 0.6.0
or later. Version 0.5.X will not work.

Larry



From peter at stuge.se  Wed Feb 24 13:22:47 2010
From: peter at stuge.se (Peter Stuge)
Date: Wed, 24 Feb 2010 13:22:47 +0100
Subject: Turn broadcom 4311 into master mode
In-Reply-To: <4B84A2E7.4050706@lwfinger.net>
References: <8592e0921002231843u4d07cdb0u95c6abafce36ef23@mail.gmail.com>
	<4B84A2E7.4050706@lwfinger.net>
Message-ID: <20100224122247.1928.qmail@stuge.se>

Larry Finger wrote:
> will work with b43 as long as hostapd is 0.6.0 or later.

Would you suggest using b43 when creating an access point today?

I've looked into ath9k to get agn, but it is very buggy for me and
Atheros remains unresponsive.

5GHz is very desirable, but reliability much more so...

Thanks!


//Peter


From Larry.Finger at lwfinger.net  Wed Feb 24 14:09:37 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Feb 2010 07:09:37 -0600
Subject: Turn broadcom 4311 into master mode
In-Reply-To: <20100224122247.1928.qmail@stuge.se>
References: <8592e0921002231843u4d07cdb0u95c6abafce36ef23@mail.gmail.com>	<4B84A2E7.4050706@lwfinger.net>
	<20100224122247.1928.qmail@stuge.se>
Message-ID: <4B852511.5040503@lwfinger.net>

On 02/24/2010 06:22 AM, Peter Stuge wrote:
> Larry Finger wrote:
>> will work with b43 as long as hostapd is 0.6.0 or later.
> 
> Would you suggest using b43 when creating an access point today?
> 
> I've looked into ath9k to get agn, but it is very buggy for me and
> Atheros remains unresponsive.
> 
> 5GHz is very desirable, but reliability much more so...

The current b43 is very stable. Performance will depend on which model you have.
BCM4311's run at speeds close to 802.11g maximum. BCM4306's are not that good.
BCM4318 units are in between.

I would not use my $500 laptop to do what a $40 AP/router does just as well or
better. I wrote the article to show that it could be done, not that I planned to
set up an AP.

Larry


From netrolller.3d at gmail.com  Fri Feb 26 10:23:07 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 10:23:07 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002252333h77f0213egfd6bfadf92b231b1@mail.gmail.com>
References: <a221c0101002252333h77f0213egfd6bfadf92b231b1@mail.gmail.com>
Message-ID: <69e28c911002260123v27634224w6b32c58a9dda1ed@mail.gmail.com>

On Fri, Feb 26, 2010 at 8:33 AM, Nathan Schulte <reklipz at gmail.com> wrote:
> 2010/1/25 G?bor Stefanik <netrolller... at gmail.com>
>
>> A few things to check:
>>
>> -Is this on PhoenixBios?
> I have the same laptop as Lucas, a Dell Vostro 1510. ?As Lucas has
> mentioned, this is indeed a PhoenixBIOS
>
>> -Does loading wl, doing a warm reboot and loading b43 make b43 work?
> I am running Debian Squeeze with the latest stock kernel (linux 2.6.32-5).
> I cold booted with b43 and ssb blacklisted, and loaded the wl module.
> I confirmed that it operated correctly, unloaded the wl module, and
> loaded b43 (and subsequently required modules).
> This did indeed make b43 work, contrary to Lucas's claim, at least for me.
>
>> -Try updating the firmware to v478. (AFAIK there was someone on the
>> list before with a DMA error on a non-ULV, and it was solved by
>> updating the firmware. Broadcom's wl.ko uses a v5xx firmware for the
>> record.)
> I am using the 4.178.10.4 driver as suggested on the linuxwireless
> page (http://downloads.openwrt.org/sources/broadcom-wl-4.178.10.4.tar.bz2),
> which it claims is actually 4.174.64.19.
> My logs state -- Loading firmware version 478.104.

The firmware version included in 4.174.64.19 is 478.104 (notice that
is is not 4178.104, but 478.104 - the driver and firmware versions are
not related!).

>
> <snip>
>
> And the Fatal DMA error: 0x400 repeats from there.
>
> -Nate
>

Hi!

Could you post an mmiotrace of the following?
 - ssb+b43 failing on cold boot
 - wl loaded on cold boot
 - wl loaded on warm boot (with wl having been loaded prior to reboot)
 - ssb+b43 working on warm boot (same as above)

Thanks,
G?bor

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb 26 12:41:32 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 12:41:32 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 
	Duo?!?!!??!
In-Reply-To: <0016e6498a5c3849b404807efa5a@google.com>
References: <69e28c911002260123v27634224w6b32c58a9dda1ed@mail.gmail.com> 
	<0016e6498a5c3849b404807efa5a@google.com>
Message-ID: <69e28c911002260341t2ee4ffdei2409ed86e6632589@mail.gmail.com>

On Fri, Feb 26, 2010 at 12:12 PM,  <ReKlipz at gmail.com> wrote:
> On Feb 26, 2010 3:23am, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> The firmware version included in 4.174.64.19 is 478.104 (notice that
>> is is not 4178.104, but 478.104 - the driver and firmware versions are
>> not related!).
>>
> Ah yes, sorry for my confusion.
>
>> Hi!
> Hello there! Thanks for the speedy reply, hopefully I can help get to the
> bottom of this.
>
>> Could you post an mmiotrace of the following?
> Certainly. As the stock Debian kernel doesn't appear to have the MMIO tracer
> enabled, these are from a fresh linux 2.6.33 mainline build (with
> CONFIG_B43_DEBUG=y and CONFIG_B43_FORCE_PIO=n)
>
> (some time passes)
>
> Err... I seem to be having issues getting the driver to fail as before. I
> have had the driver fail on a 2.6.33 build just hours ago, but with my new
> configuration, it is not.
>

Make sure to actually cut power to the system & discharge any stray
voltages by pressing the Power On button with the powrer still cut
before "cold boot" tests. The effect of wl seems to survive reboots.

> I will test using the stock kernel config with mmiotracer enabled.
>
>> Thanks,
>> G?bor
>
> -Nate



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb 26 15:49:37 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 15:49:37 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 
	Duo?!?!!??!
In-Reply-To: <a221c0101002260535q6f11fa58nd6941e31f4224707@mail.gmail.com>
References: <69e28c911002260123v27634224w6b32c58a9dda1ed@mail.gmail.com> 
	<0016e6498a5c3849b404807efa5a@google.com>
	<69e28c911002260341t2ee4ffdei2409ed86e6632589@mail.gmail.com> 
	<a221c0101002260459x60134688uaf28bc2db671fd8@mail.gmail.com> 
	<a221c0101002260509w6940f0d6n4f8aa5dee58a0cc@mail.gmail.com> 
	<a221c0101002260535q6f11fa58nd6941e31f4224707@mail.gmail.com>
Message-ID: <69e28c911002260649m7946bb96mc7e3975e983a223@mail.gmail.com>

2010/2/26 Nathan Schulte <reklipz at gmail.com>:
> I apologize for so many messages. I wanted to note that the reasoning
> for lsmod only showing the ntfs module, is due the fact that ntfs (and
> b43 and ssb) are the only drivers compiled as modules.
>
> When loading b43 without mmiotrace running, I receive a Fatal DMA
> error: 0x800 within a few seconds.
> I receive no other errors following, but I am unable to associate with
> an access point.
> If I then unload b43 and ssb, and reload it, I receive a Fatal DMA
> error: 0x400 (and can generate one for every ifconfig wlan0 down/up I
> perform).
>
> The archive http://vulcan.ist.unomaha.edu/~nmschulte/traces.tar.bz2
> contains two traces. ?The first trace (one) is after a cold boot,
> loading b43, associating with an access point, issuing ifconfig wlan0
> down, ifconfig wlan0 up, and then stopping the trace. ?Immediately
> after stopping the trace, I receive a 0x800 error in my logs. ?I then
> unloaded b43 and ssb, and started a new mmiotrace (two). ?I then
> loaded b43, issued ifconfig wlan0 down, ifconfig wlan0 up, and again
> issued ifconfig wlan0 down/up (preceeded by trace markers denoting
> such), and then stopped the trace.
>

It is expected that you only get a single DMA error with 2.6.33, as
the driver was modified in 2.6.33 to give up after a single failure.
The controller restart mechanism has yet to show a successful error
recovery for any card, OTOH the repeated retries had nasty side
effects on some machines (including lockups and crashes), so the
entire retry mechanism was removed.

However, you did not do what I requested - before the 2nd mmiotrace,
load and unload wl (the hybrid driver), not b43 - it is wl that
appears to make the card work.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb 26 16:08:11 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 16:08:11 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 
	Duo?!?!!??!
In-Reply-To: <0016e64e56b2f2aa4b04808238b2@google.com>
References: <69e28c911002260649m7946bb96mc7e3975e983a223@mail.gmail.com> 
	<0016e64e56b2f2aa4b04808238b2@google.com>
Message-ID: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>

On Fri, Feb 26, 2010 at 4:04 PM,  <ReKlipz at gmail.com> wrote:
> On Feb 26, 2010 8:49am, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> However, you did not do what I requested - before the 2nd mmiotrace,
>> load and unload wl (the hybrid driver), not b43 - it is wl that
>> appears to make the card work.
> Correct, I did not do this. This is because (the current available version
> of) the hybrid driver does not build against 2.6.33. I need to build 2.6.32
> vanilla, or the stock kernel. I will do that now.
>
> However, I thought it significant that using b43 from a cold boot works, so
> long as one is performing an mmiotrace. This is why I linked the
> tracers.tar.gz.

That's odd... the error only occurs when you stop the mmiotrace?!

BTW no need to load wl and b43 on the same kernel - the effect of
loading wl survives a reboot or a kexec.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Fri Feb 26 16:27:26 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 16:27:26 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 
	Duo?!?!!??!
In-Reply-To: <001485eba6885d1883048082565d@google.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<001485eba6885d1883048082565d@google.com>
Message-ID: <69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>

On Fri, Feb 26, 2010 at 4:13 PM,  <ReKlipz at gmail.com> wrote:
> On Feb 26, 2010 9:08am, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> That's odd... the error only occurs when you stop the mmiotrace?!
> Yes, the error only occurs when I stop the mmiotrace with b43 loaded, or if
> I load b43 outside of an mmiotrace.
>
>> BTW no need to load wl and b43 on the same kernel - the effect of
>> loading wl survives a reboot or a kexec.
> But then I cannot get you the mmiotrace as you requested. If all you're
> after is the mmiotrace of b43 from cold and b43 from warm with wl magic, I
> can do that now. I don't know how helpful this will be given that b43
> appears to work so long as an mmiotrace is being performed.

The differences will still be there in the dump, even if something
related to mmiotrace seemingly works around the bug.
However, the most helpful logs would be the ones produced by wl
itself, on a cold boot.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Feb 26 18:02:58 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Feb 2010 11:02:58 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 	Duo?!?!!??!
In-Reply-To: <69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
Message-ID: <4B87FEC2.2000503@lwfinger.net>

On 02/26/2010 09:27 AM, G?bor Stefanik wrote:
> On Fri, Feb 26, 2010 at 4:13 PM,  <ReKlipz at gmail.com> wrote:
>> On Feb 26, 2010 9:08am, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>>> That's odd... the error only occurs when you stop the mmiotrace?!
>> Yes, the error only occurs when I stop the mmiotrace with b43 loaded, or if
>> I load b43 outside of an mmiotrace.
>>
>>> BTW no need to load wl and b43 on the same kernel - the effect of
>>> loading wl survives a reboot or a kexec.
>> But then I cannot get you the mmiotrace as you requested. If all you're
>> after is the mmiotrace of b43 from cold and b43 from warm with wl magic, I
>> can do that now. I don't know how helpful this will be given that b43
>> appears to work so long as an mmiotrace is being performed.
> 
> The differences will still be there in the dump, even if something
> related to mmiotrace seemingly works around the bug.
> However, the most helpful logs would be the ones produced by wl
> itself, on a cold boot.

This thread is most interesting. Thanks for keeping it on the list, even though
the OP doesn't seem to know about "Reply All".

The fact that the 4315 doesn't get the DMA errors until MMIO tracing is turned
off suggests some kind of subtle timing difference. I'll look at the Broadcom
code to see if there are some delay statements in the interrupt handling, or if
their processing does things in a different order.

Larry



From netrolller.3d at gmail.com  Fri Feb 26 18:22:26 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 18:22:26 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B87FEC2.2000503@lwfinger.net>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com> 
	<4B87FEC2.2000503@lwfinger.net>
Message-ID: <69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>

2010/2/26 Larry Finger <Larry.Finger at lwfinger.net>:
> On 02/26/2010 09:27 AM, G?bor Stefanik wrote:
>> On Fri, Feb 26, 2010 at 4:13 PM, ?<ReKlipz at gmail.com> wrote:
>>> On Feb 26, 2010 9:08am, G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>>>> That's odd... the error only occurs when you stop the mmiotrace?!
>>> Yes, the error only occurs when I stop the mmiotrace with b43 loaded, or if
>>> I load b43 outside of an mmiotrace.
>>>
>>>> BTW no need to load wl and b43 on the same kernel - the effect of
>>>> loading wl survives a reboot or a kexec.
>>> But then I cannot get you the mmiotrace as you requested. If all you're
>>> after is the mmiotrace of b43 from cold and b43 from warm with wl magic, I
>>> can do that now. I don't know how helpful this will be given that b43
>>> appears to work so long as an mmiotrace is being performed.
>>
>> The differences will still be there in the dump, even if something
>> related to mmiotrace seemingly works around the bug.
>> However, the most helpful logs would be the ones produced by wl
>> itself, on a cold boot.
>
> This thread is most interesting. Thanks for keeping it on the list, even though
> the OP doesn't seem to know about "Reply All".
>
> The fact that the 4315 doesn't get the DMA errors until MMIO tracing is turned
> off suggests some kind of subtle timing difference. I'll look at the Broadcom
> code to see if there are some delay statements in the interrupt handling, or if
> their processing does things in a different order.
>
> Larry
>
>

Note that enabling MMIO trace touches quite a few areas of the kernel
rather hard - for example, it AFAIK disables SMP. I wonder if acpi=off
or blacklisting "processor" would have an effect here...

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Fri Feb 26 21:28:58 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Feb 2010 14:28:58 -0600
Subject: [PATCH] b43: Make driver fall back gracefully to PIO mode after
	fatal DMA errors
Message-ID: <4b882f0a.mh6Uqo07p1AwjuBv%Larry.Finger@lwfinger.net>

Subject: Make b43 driver fall back gracefully to PIO mode after fatal DMA errors
From: Linus Torvalds <torvalds at linux-foundation.org>
Date: Fri, 26 Feb 2010 10:34:27 -0800 (PST)

This makes the b43 driver just automatically fall back to PIO mode when 
DMA doesn't work.

The driver already told the user to do it, so rather than have the user 
reload the module with a new flag, just make the driver do it 
automatically. We keep the message as an indication that something is 
wrong, but now just automatically fall back to the hopefully working PIO 
case.

Signed-off-by: Linus Torvalds <torvalds at linux-foundation.org>
---

John,

This version will work with wireless-testing.

Larry
---

Index: wireless-testing/drivers/net/wireless/b43/Kconfig
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/Kconfig
+++ wireless-testing/drivers/net/wireless/b43/Kconfig
@@ -3,7 +3,6 @@ config B43
 	depends on SSB_POSSIBLE && MAC80211 && HAS_DMA
 	select SSB
 	select FW_LOADER
-	select SSB_BLOCKIO
 	---help---
 	  b43 is a driver for the Broadcom 43xx series wireless devices.
 
@@ -79,6 +78,14 @@ config B43_SDIO
 
 	  If unsure, say N.
 
+#Data transfers to the device via PIO. We want it as a fallback even
+# if we can do DMA.
+config B43_PIO
+	bool
+	depends on B43
+	select SSB_BLOCKIO
+	default y
+
 config B43_NPHY
 	bool "Pre IEEE 802.11n support (BROKEN)"
 	depends on B43 && EXPERIMENTAL && BROKEN
@@ -130,4 +137,12 @@ config B43_DEBUG
 	  for production use.
 	  Only say Y, if you are debugging a problem in the b43 driver sourcecode.
 
-
+config B43_FORCE_PIO
+	bool "Force usage of PIO instead of DMA"
+	depends on B43 && B43_DEBUG
+	---help---
+	  This will disable DMA and always enable PIO instead.
+
+	  Say N!
+	  This is only for debugging the PIO engine code. You do
+	  _NOT_ want to enable this.
Index: wireless-testing/drivers/net/wireless/b43/main.c
===================================================================
--- wireless-testing.orig/drivers/net/wireless/b43/main.c
+++ wireless-testing/drivers/net/wireless/b43/main.c
@@ -107,9 +107,9 @@ int b43_modparam_verbose = B43_VERBOSITY
 module_param_named(verbose, b43_modparam_verbose, int, 0644);
 MODULE_PARM_DESC(verbose, "Log message verbosity: 0=error, 1=warn, 2=info(default), 3=debug");
 
-static int modparam_pio;
-module_param_named(pio, modparam_pio, int, 0444);
-MODULE_PARM_DESC(pio, "enable(1) / disable(0) PIO mode");
+int b43_modparam_pio = B43_PIO_DEFAULT;
+module_param_named(pio, b43_modparam_pio, int, 0644);
+MODULE_PARM_DESC(pio, "Use PIO accesses by default: 0=DMA, 1=PIO");
 
 static const struct ssb_device_id b43_ssb_tbl[] = {
 	SSB_DEVICE(SSB_VENDOR_BROADCOM, SSB_DEV_80211, 5),
@@ -1804,8 +1804,9 @@ static void b43_do_interrupt_thread(stru
 			       dma_reason[4], dma_reason[5]);
 			b43err(dev->wl, "This device does not support DMA "
 			       "on your system. Please use PIO instead.\n");
-			b43err(dev->wl, "Unload the b43 module and reload "
-			       "with 'pio=1'\n");
+			/* Fall back to PIO transfers if we get fatal DMA errors! */
+			dev->use_pio = 1;
+			b43_controller_restart(dev, "DMA error");
 			return;
 		}
 		if (merged_dma_reason & B43_DMAIRQ_NONFATALMASK) {
@@ -4357,7 +4358,7 @@ static int b43_wireless_core_init(struct
 
 	if ((dev->dev->bus->bustype == SSB_BUSTYPE_PCMCIA) ||
 	    (dev->dev->bus->bustype == SSB_BUSTYPE_SDIO) ||
-	    modparam_pio) {
+	    dev->use_pio) {
 		dev->__using_pio_transfers = 1;
 		err = b43_pio_init(dev);
 	} else {
@@ -4824,6 +4825,7 @@ static int b43_one_core_attach(struct ss
 	if (!wldev)
 		goto out;
 
+	wldev->use_pio = b43_modparam_pio;
 	wldev->dev = dev;
 	wldev->wl = wl;
 	b43_set_status(wldev, B43_STAT_UNINIT);


From netrolller.3d at gmail.com  Fri Feb 26 23:03:28 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Fri, 26 Feb 2010 23:03:28 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <20100226215726.74483011@boulder.homenet>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com> 
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com> 
	<20100226215726.74483011@boulder.homenet>
Message-ID: <69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>

2010/2/26 Chris Vine <chris at cvine.freeserve.co.uk>:
> On Fri, 26 Feb 2010 18:22:26 +0100
> G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> Note that enabling MMIO trace touches quite a few areas of the kernel
>> rather hard - for example, it AFAIK disables SMP. I wonder if acpi=off
>> or blacklisting "processor" would have an effect here...
>
> I have reported previously (some months ago) that this delays the onset
> of DMA errors, but it just masks the problem. ?It has the same effect as
> the earlier pm_qos patch. ?The real issue appears to lie somewhere
> else: it is noise introduced by timing differences.
>
> Chris

I suspect that timing is not the true reason for the problem, rather,
there is a race condition between PhoenixBIOS and b43, for which wl
probably uses a (firmware?) workaround.

BTW there is an interesting difference in the early init between wl
and b43: b43 sets bit 0x200 in core register 0x600, while wl sets
0x8000 in register 0x280a - an undocumented register. Larry, do you
have any info on this?

--
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From chris at cvine.freeserve.co.uk  Fri Feb 26 22:57:26 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Fri, 26 Feb 2010 21:57:26 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>
Message-ID: <20100226215726.74483011@boulder.homenet>

On Fri, 26 Feb 2010 18:22:26 +0100
G?bor Stefanik <netrolller.3d at gmail.com> wrote:
> Note that enabling MMIO trace touches quite a few areas of the kernel
> rather hard - for example, it AFAIK disables SMP. I wonder if acpi=off
> or blacklisting "processor" would have an effect here...

I have reported previously (some months ago) that this delays the onset
of DMA errors, but it just masks the problem.  It has the same effect as
the earlier pm_qos patch.  The real issue appears to lie somewhere
else: it is noise introduced by timing differences.

Chris




From chris at cvine.freeserve.co.uk  Fri Feb 26 23:12:47 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Fri, 26 Feb 2010 22:12:47 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
Message-ID: <20100226221247.5dc996ac@boulder.homenet>

On Fri, 26 Feb 2010 23:03:28 +0100
G?bor Stefanik <netrolller.3d at gmail.com> wrote:
> I suspect that timing is not the true reason for the problem, rather,
> there is a race condition between PhoenixBIOS and b43, for which wl
> probably uses a (firmware?) workaround.

I meant that it is the reason for the masking of the DMA errors, rather
than their cause.  (That is not to say that your diagnosis of the
problem may not be right.)

Chris




From van77live at gmail.com  Sat Feb 27 01:10:43 2010
From: van77live at gmail.com (van77live at gmail.com)
Date: Sat, 27 Feb 2010 01:10:43 +0100
Subject: "Direct probe to AP ... timed out" with b43legacy
Message-ID: <4B886303.9040701@gmail.com>

Hello,
I am trying to reuse an old HP zd7055ea laptop, which has a BCM4303 card. I am 
using Ubuntu 9.10 (Karmic). It detected the card on its restricted drivers 
manager, and installed it correctly. NetworkManager detects the card and lists 
the detected APs.

But it doesn't connect, and then it asks me again for the password. The output 
of dmesg shows this when trying to associate:

[  326.516070] wlan0: direct probe to AP <AP mac> try 1
[  326.716054] wlan0: direct probe to AP <AP mac> try 2
[  326.916054] wlan0: direct probe to AP <AP mac> try 3
[  327.116048] wlan0: direct probe to AP <AP mac> timed out
  (... repeated dozens of times ...)

The AP is using WPA-PSK encryption, although I've already tried with WEP, 
without any encryption, enabling b/g, only b, but everything gives the same result.

I also tried to compile fwcutter and download the firmware following the 
instructions on the site, but I got the same.

The router itself is a Thomson SpeedTouch 565v6, which have been working without 
any problems for long. I am using 2.6.31-19-generic kernel.

Maybe somebody can give me a clue on what should I try next? Thank you.

Some more info:

$ lspci | grep BCM
02:03.0 Network controller: Broadcom Corporation BCM4303 802.11b Wireless LAN 
Controller (rev 02)

$ lspci -n | grep 14e4
02:03.0 0280: 14e4:4301 (rev 02)

$ lsmod | grep 43
b43legacy             115128  0
mac80211              178036  1 b43legacy
cfg80211               91260  2 b43legacy,mac80211
led_class               4160  1 b43legacy
ssb                    35140  2 b43legacy,b44

$ dmesg | grep b43
[    1.497455] b43-pci-bridge 0000:02:03.0: PCI INT A -> GSI 21 (level, low) -> 
IRQ 21
[  311.701016] b43legacy-phy0: Broadcom 4301 WLAN found
[  311.724023] b43legacy-phy0 debug: Found PHY: Analog 0, Type 1, Revision 4
[  311.724047] b43legacy-phy0 debug: Found Radio: Manuf 0x17F, Version 0x2050, 
Revision 2
[  311.748030] b43legacy-phy0 debug: Radio initialized
[  311.856061] b43legacy ssb0:0: firmware: requesting b43legacy/ucode2.fw
[  311.908560] b43legacy ssb0:0: firmware: requesting b43legacy/pcm4.fw
[  311.916235] b43legacy ssb0:0: firmware: requesting b43legacy/b0g0initvals2.fw
[  312.024034] b43legacy-phy0: Loading firmware version 0x127, patch level 14 
(2005-04-18 02:36:27)
[  312.124428] b43legacy-phy0 debug: Chip initialized
[  312.124656] b43legacy-phy0 debug: 30-bit DMA initialized
[  312.124836] Registered led device: b43legacy-phy0::tx
[  312.124885] Registered led device: b43legacy-phy0::rx
[  312.124925] Registered led device: b43legacy-phy0::radio
[  312.124985] b43legacy-phy0 debug: Wireless interface started
[  312.124999] b43legacy-phy0 debug: Adding Interface type 2


Thanks,
Martin


From netrolller.3d at gmail.com  Sat Feb 27 02:41:48 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 27 Feb 2010 02:41:48 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <20100226221247.5dc996ac@boulder.homenet>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com> 
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com> 
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com> 
	<20100226221247.5dc996ac@boulder.homenet>
Message-ID: <69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>

Someone should test the following:
-Open drivers/ssb/driver_chipcommon_pmu.c
-In ssb_pmu_init, replace 0x4325 with 0x4312. (This is not the correct
way to fix this, but should be enough for a test. The correct fix
would be special-casing for both 4312 and 4325, at least according to
the MMIO trace produced using wl. Or maybe the if-branch is the
wrong-way around - only Larry can tell.)

BTW does anyone know of a way to trace pci_read/write_config_dword
calls? Mmiotrace doesn't capture these.

2010/2/26 Chris Vine <chris at cvine.freeserve.co.uk>:
> On Fri, 26 Feb 2010 23:03:28 +0100
> G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> I suspect that timing is not the true reason for the problem, rather,
>> there is a race condition between PhoenixBIOS and b43, for which wl
>> probably uses a (firmware?) workaround.
>
> I meant that it is the reason for the masking of the DMA errors, rather
> than their cause. ?(That is not to say that your diagnosis of the
> problem may not be right.)
>
> Chris
>
>
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From Larry.Finger at lwfinger.net  Sat Feb 27 06:34:27 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Feb 2010 23:34:27 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
	<20100226221247.5dc996ac@boulder.homenet>
	<69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
Message-ID: <4B88AEE3.5040005@lwfinger.net>

On 02/26/2010 07:41 PM, G?bor Stefanik wrote:
> Someone should test the following:
> -Open drivers/ssb/driver_chipcommon_pmu.c
> -In ssb_pmu_init, replace 0x4325 with 0x4312. (This is not the correct
> way to fix this, but should be enough for a test. The correct fix
> would be special-casing for both 4312 and 4325, at least according to
> the MMIO trace produced using wl. Or maybe the if-branch is the
> wrong-way around - only Larry can tell.)

The latest Broadcom driver has changed this section. The new specs should be:

 1. If the pmu revision is 1
   a. Clear bit 0x200 in the PMU control register
 1. Otherwise
   a. Set bit 0x200 in the PMU control register

> BTW does anyone know of a way to trace pci_read/write_config_dword
> calls? Mmiotrace doesn't capture these.

The attached patch will log PCI config reads/writes to the system logs.

Larry

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: log_pciconfig
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100226/7580c682/attachment.ksh>

From chris at cvine.freeserve.co.uk  Sat Feb 27 11:41:14 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sat, 27 Feb 2010 10:41:14 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<001485eba6885d1883048082565d@google.com>
	<69e28c911002260727h5dabc409i5a010c240a4a569f@mail.gmail.com>
	<4B87FEC2.2000503@lwfinger.net>
	<69e28c911002260922h1bc905f5udc5cd3feb7e67614@mail.gmail.com>
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
	<20100226221247.5dc996ac@boulder.homenet>
	<69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
Message-ID: <20100227104114.3f1988f3@boulder.homenet>

On Sat, 27 Feb 2010 02:41:48 +0100
G?bor Stefanik <netrolller.3d at gmail.com> wrote:
> Someone should test the following:
> -Open drivers/ssb/driver_chipcommon_pmu.c
> -In ssb_pmu_init, replace 0x4325 with 0x4312. (This is not the correct
> way to fix this, but should be enough for a test. The correct fix
> would be special-casing for both 4312 and 4325, at least according to
> the MMIO trace produced using wl. Or maybe the if-branch is the
> wrong-way around - only Larry can tell.)

For what it is worth, this does not solve the problem on my netbook.

Chris




From zajec5 at gmail.com  Sat Feb 27 12:09:30 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 27 Feb 2010 12:09:30 +0100
Subject: [PATCH 08/11] b43: implement writing to MMIO shared memory
In-Reply-To: <201002092359.24301.mb@bu3sch.de>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<1265745883-3392-9-git-send-email-zajec5@gmail.com>
	<201002092359.24301.mb@bu3sch.de>
Message-ID: <b170af451002270309l1cbc880et100fc4e468386934@mail.gmail.com>

2010/2/9 Michael Buesch <mb at bu3sch.de>:
> On Tuesday 09 February 2010 21:04:40 Rafa? Mi?ecki wrote:
>> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
>> ---
>> ?drivers/net/wireless/b43/phy_common.c | ? 11 +++++++++++
>> ?drivers/net/wireless/b43/phy_common.h | ? ?2 ++
>> ?2 files changed, 13 insertions(+), 0 deletions(-)
>>
>> diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
>> index 8f7d7ef..0b0f9df 100644
>> --- a/drivers/net/wireless/b43/phy_common.c
>> +++ b/drivers/net/wireless/b43/phy_common.c
>> @@ -466,3 +466,14 @@ struct b43_c32 b43_cordic(int theta)
>>
>> ? ? ? return ret;
>> ?}
>> +
>> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/BmacWriteShm */
>> +void b43_bmac_write_shm(struct b43_wldev *dev, u32 offset, u16 value)
>> +{
>> + ? ? b43_write32(dev, B43_MMIO_SHM_CONTROL, 0x00010000 | (offset >> 2));
>> + ? ? b43_read32(dev, B43_MMIO_SHM_CONTROL);
>> + ? ? if (offset & 2)
>> + ? ? ? ? ? ? b43_write16(dev, 0x165, value);
>> + ? ? else
>> + ? ? ? ? ? ? b43_write16(dev, B43_MMIO_SHM_DATA, value);
>> +}
>
> I'd like to put a biiiig questionmark on this.
> We already have SHM access. Your function does exactly the same, except that it
> accesses the bullshit register h165.

Yeah, that 0x165 is really crappy. Let's hope it really should be
0x166 (B43_MMIO_SHM_DATA_UNALIGNED).

Do you think we should add dummy-read to b43_shm_control_word as
BmacWriteShm does? Currently we do not perform that.

-- 
Rafa?


From zajec5 at gmail.com  Sat Feb 27 12:12:23 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sat, 27 Feb 2010 12:12:23 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs 
	definitions
In-Reply-To: <201002100002.11369.mb@bu3sch.de>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002100002.11369.mb@bu3sch.de>
Message-ID: <b170af451002270312y304b9c81mc6223a6e28608f3a@mail.gmail.com>

2010/2/10 Michael Buesch <mb at bu3sch.de>:
> On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
>> +#define B43_MMIO_PSM_PHY_HDR ? ? ? ? 0x492 ? /* programmable state machine */
>
> The comment doesn't make a lot of sense.
> In case you don't know, the PSM is the part of the hardware
> that executes the firmware.

Well, guess you're right. It was me hearing for the first time "PSM"
so decided to write it. Guess it's pretty obvious for every device
driver developer :)

-- 
Rafa?


From zajec5 at gmail.com  Sat Feb 27 13:03:31 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:31 +0100
Subject: [PATCH 00/10] b43: more N-PHY patches, try #2
Message-ID: <1267272221-1873-1-git-send-email-zajec5@gmail.com>

John: there is one patch less in comparision to first patchset, previous try
was some time ago, so fianlly I decided to resend all patches. I guess half
of them did not really changed. Are you fine with this?

Rafa? Mi?ecki (10):
  b43: N-PHY: add some registers and structs definitions
  b43: N-PHY: initialize super switch
  b43: N-PHY: turn radio on/off (rfkill)
  b43: N-PHY: update writing channel-specific radio registers
  b43: N-PHY: update post init of 2055 radio
  b43: N-PHY: switch to chanspec struct
  b43: N-PHY: adjust gain table
  b43: N-PHY: isloate 2055 radio setup
  b43: N-PHY: implement chanspec setup
  b43: N-PHY: switch to chanspec ops

 drivers/net/wireless/b43/b43.h         |    1 +
 drivers/net/wireless/b43/phy_n.c       |  463 +++++++++++++++++++++++++-------
 drivers/net/wireless/b43/phy_n.h       |   21 ++-
 drivers/net/wireless/b43/tables_nphy.h |    9 +
 4 files changed, 387 insertions(+), 107 deletions(-)



From zajec5 at gmail.com  Sat Feb 27 13:03:33 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:33 +0100
Subject: [PATCH V2 02/10] b43: N-PHY: initialize super switch
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-3-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   37 ++++++++++++++++++++++++++++++++++++-
 1 files changed, 36 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 795bb1e..2d8eda1 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -646,6 +646,41 @@ static void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *clip_st)
 	clip_st[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SuperSwitchInit */
+static void b43_nphy_superswitch_init(struct b43_wldev *dev, bool init)
+{
+	if (dev->phy.rev >= 3) {
+		if (!init)
+			return;
+		if (0 /* FIXME */) {
+			b43_ntab_write(dev, B43_NTAB16(9, 2), 0x211);
+			b43_ntab_write(dev, B43_NTAB16(9, 3), 0x222);
+			b43_ntab_write(dev, B43_NTAB16(9, 8), 0x144);
+			b43_ntab_write(dev, B43_NTAB16(9, 12), 0x188);
+		}
+	} else {
+		b43_phy_write(dev, B43_NPHY_GPIO_LOOEN, 0);
+		b43_phy_write(dev, B43_NPHY_GPIO_HIOEN, 0);
+
+		ssb_chipco_gpio_control(&dev->dev->bus->chipco, 0xFC00,
+					0xFC00);
+		b43_write32(dev, B43_MMIO_MACCTL,
+			b43_read32(dev, B43_MMIO_MACCTL) &
+			~B43_MACCTL_GPOUTSMSK);
+		b43_write16(dev, B43_MMIO_GPIO_MASK,
+			b43_read16(dev, B43_MMIO_GPIO_MASK) | 0xFC00);
+		b43_write16(dev, B43_MMIO_GPIO_CONTROL,
+			b43_read16(dev, B43_MMIO_GPIO_CONTROL) & ~0xFC00);
+
+		if (init) {
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);
+			b43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);
+		}
+	}
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/classifier */
 static u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)
 {
@@ -3116,7 +3151,7 @@ int b43_phy_initn(struct b43_wldev *dev)
 			target = b43_nphy_get_tx_gains(dev);
 
 			if (nphy->antsel_type == 2)
-				;/*TODO NPHY Superswitch Init with argument 1*/
+				b43_nphy_superswitch_init(dev, true);
 			if (nphy->perical != 2) {
 				b43_nphy_rssi_cal(dev);
 				if (phy->rev >= 3) {
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:34 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:34 +0100
Subject: [PATCH V2 03/10] b43: N-PHY: turn radio on/off (rfkill)
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-4-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   50 ++++++++++++++++++++++++++++----------
 1 files changed, 37 insertions(+), 13 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2d8eda1..dd81e8a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -218,7 +218,10 @@ static void b43_radio_init2055_post(struct b43_wldev *dev)
 	b43_radio_write16(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
 }
 
-/* Initialize a Broadcom 2055 N-radio */
+/*
+ * Initialize a Broadcom 2055 N-radio
+ * http://bcm-v4.sipsolutions.net/802.11/Radio/2055/Init
+ */
 static void b43_radio_init2055(struct b43_wldev *dev)
 {
 	b43_radio_init2055_pre(dev);
@@ -229,17 +232,6 @@ static void b43_radio_init2055(struct b43_wldev *dev)
 	b43_radio_init2055_post(dev);
 }
 
-void b43_nphy_radio_turn_on(struct b43_wldev *dev)
-{
-	b43_radio_init2055(dev);
-}
-
-void b43_nphy_radio_turn_off(struct b43_wldev *dev)
-{
-	b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
-		     ~B43_NPHY_RFCTL_CMD_EN);
-}
-
 /*
  * Upload the N-PHY tables.
  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables
@@ -3277,9 +3269,41 @@ static void b43_nphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)
 	b43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/Radio/Switch%20Radio */
 static void b43_nphy_op_software_rfkill(struct b43_wldev *dev,
 					bool blocked)
-{//TODO
+{
+	if (b43_read32(dev, B43_MMIO_MACCTL) & B43_MACCTL_ENABLED)
+		b43err(dev->wl, "MAC not suspended\n");
+
+	if (blocked) {
+		b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
+				~B43_NPHY_RFCTL_CMD_CHIP0PU);
+		if (dev->phy.rev >= 3) {
+			b43_radio_mask(dev, 0x09, ~0x2);
+
+			b43_radio_write(dev, 0x204D, 0);
+			b43_radio_write(dev, 0x2053, 0);
+			b43_radio_write(dev, 0x2058, 0);
+			b43_radio_write(dev, 0x205E, 0);
+			b43_radio_mask(dev, 0x2062, ~0xF0);
+			b43_radio_write(dev, 0x2064, 0);
+
+			b43_radio_write(dev, 0x304D, 0);
+			b43_radio_write(dev, 0x3053, 0);
+			b43_radio_write(dev, 0x3058, 0);
+			b43_radio_write(dev, 0x305E, 0);
+			b43_radio_mask(dev, 0x3062, ~0xF0);
+			b43_radio_write(dev, 0x3064, 0);
+		}
+	} else {
+		if (dev->phy.rev >= 3) {
+			/* TODO: b43_radio_init2056(dev); */
+			/* TODO: PHY Set Channel Spec (dev, radio_chanspec) */
+		} else {
+			b43_radio_init2055(dev);
+		}
+	}
 }
 
 static void b43_nphy_op_switch_analog(struct b43_wldev *dev, bool on)
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:36 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:36 +0100
Subject: [PATCH V2 05/10] b43: N-PHY: update post init of 2055 radio
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-6-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   61 +++++++++++++++++++++----------------
 1 files changed, 35 insertions(+), 26 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 2c592d2..6774897 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -183,49 +183,58 @@ static void b43_radio_init2055_pre(struct b43_wldev *dev)
 
 static void b43_radio_init2055_post(struct b43_wldev *dev)
 {
+	struct b43_phy_n *nphy = dev->phy.n;
 	struct ssb_sprom *sprom = &(dev->dev->bus->sprom);
 	struct ssb_boardinfo *binfo = &(dev->dev->bus->boardinfo);
 	int i;
 	u16 val;
+	bool workaround = false;
+
+	if (sprom->revision < 4)
+		workaround = (binfo->vendor != PCI_VENDOR_ID_BROADCOM ||
+				binfo->type != 0x46D ||
+				binfo->rev < 0x41);
+	else
+		workaround = ((sprom->boardflags_hi & B43_BFH_NOPA) == 0);
 
 	b43_radio_mask(dev, B2055_MASTER1, 0xFFF3);
-	msleep(1);
-	if ((sprom->revision != 4) ||
-	   !(sprom->boardflags_hi & B43_BFH_RSSIINV)) {
-		if ((binfo->vendor != PCI_VENDOR_ID_BROADCOM) ||
-		    (binfo->type != 0x46D) ||
-		    (binfo->rev < 0x41)) {
-			b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
-			b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
-			msleep(1);
-		}
+	if (workaround) {
+		b43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);
+		b43_radio_mask(dev, B2055_C2_RX_BB_REG, 0x7F);
 	}
-	b43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0x3F, 0x2C);
-	msleep(1);
-	b43_radio_write16(dev, B2055_CAL_MISC, 0x3C);
-	msleep(1);
+	b43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0xFFC0, 0x2C);
+	b43_radio_write(dev, B2055_CAL_MISC, 0x3C);
 	b43_radio_mask(dev, B2055_CAL_MISC, 0xFFBE);
-	msleep(1);
 	b43_radio_set(dev, B2055_CAL_LPOCTL, 0x80);
-	msleep(1);
 	b43_radio_set(dev, B2055_CAL_MISC, 0x1);
 	msleep(1);
 	b43_radio_set(dev, B2055_CAL_MISC, 0x40);
-	msleep(1);
-	for (i = 0; i < 100; i++) {
-		val = b43_radio_read16(dev, B2055_CAL_COUT2);
-		if (val & 0x80)
+	for (i = 0; i < 200; i++) {
+		val = b43_radio_read(dev, B2055_CAL_COUT2);
+		if (val & 0x80) {
+			i = 0;
 			break;
+		}
 		udelay(10);
 	}
-	msleep(1);
+	if (i)
+		b43err(dev->wl, "radio post init timeout\n");
 	b43_radio_mask(dev, B2055_CAL_LPOCTL, 0xFF7F);
-	msleep(1);
 	nphy_channel_switch(dev, dev->phy.channel);
-	b43_radio_write16(dev, B2055_C1_RX_BB_LPF, 0x9);
-	b43_radio_write16(dev, B2055_C2_RX_BB_LPF, 0x9);
-	b43_radio_write16(dev, B2055_C1_RX_BB_MIDACHP, 0x83);
-	b43_radio_write16(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
+	b43_radio_write(dev, B2055_C1_RX_BB_LPF, 0x9);
+	b43_radio_write(dev, B2055_C2_RX_BB_LPF, 0x9);
+	b43_radio_write(dev, B2055_C1_RX_BB_MIDACHP, 0x83);
+	b43_radio_write(dev, B2055_C2_RX_BB_MIDACHP, 0x83);
+	b43_radio_maskset(dev, B2055_C1_LNA_GAINBST, 0xFFF8, 0x6);
+	b43_radio_maskset(dev, B2055_C2_LNA_GAINBST, 0xFFF8, 0x6);
+	if (!nphy->gain_boost) {
+		b43_radio_set(dev, B2055_C1_RX_RFSPC1, 0x2);
+		b43_radio_set(dev, B2055_C2_RX_RFSPC1, 0x2);
+	} else {
+		b43_radio_mask(dev, B2055_C1_RX_RFSPC1, 0xFFFD);
+		b43_radio_mask(dev, B2055_C2_RX_RFSPC1, 0xFFFD);
+	}
+	udelay(2);
 }
 
 /*
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:37 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:37 +0100
Subject: [PATCH V2 06/10] b43: N-PHY: switch to chanspec struct
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-7-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   45 +++++++++++++++++++++++++------------
 drivers/net/wireless/b43/phy_n.h |   11 +++++----
 2 files changed, 36 insertions(+), 20 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 6774897..1952acc 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -73,6 +73,21 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
 						u16 value, u8 core);
 
+static inline bool b43_empty_chanspec(struct b43_chanspec *chanspec)
+{
+	return !chanspec->channel && !chanspec->sideband &&
+		!chanspec->b_width && !chanspec->b_freq;
+}
+
+static inline bool b43_eq_chanspecs(struct b43_chanspec *chanspec1,
+					struct b43_chanspec *chanspec2)
+{
+	return (chanspec1->channel == chanspec2->channel &&
+		chanspec1->sideband == chanspec2->sideband &&
+		chanspec1->b_width == chanspec2->b_width &&
+		chanspec1->b_freq == chanspec2->b_freq);
+}
+
 void b43_nphy_set_rxantenna(struct b43_wldev *dev, int antenna)
 {//TODO
 }
@@ -768,7 +783,7 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy = dev->phy.n;
 
-	unsigned int channel;
+	u8 channel = nphy->radio_chanspec.channel;
 	int tone[2] = { 57, 58 };
 	u32 noise[2] = { 0x3FF, 0x3FF };
 
@@ -777,8 +792,6 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 	if (nphy->hang_avoid)
 		b43_nphy_stay_in_carrier_search(dev, 1);
 
-	/* FIXME: channel = radio_chanspec */
-
 	if (nphy->gband_spurwar_en) {
 		/* TODO: N PHY Adjust Analog Pfbw (7) */
 		if (channel == 11 && dev->phy.is_40mhz)
@@ -2015,12 +2028,12 @@ static void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)
 	u16 *rssical_phy_regs = NULL;
 
 	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
-		if (!nphy->rssical_chanspec_2G)
+		if (b43_empty_chanspec(&nphy->rssical_chanspec_2G))
 			return;
 		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;
 		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;
 	} else {
-		if (!nphy->rssical_chanspec_5G)
+		if (b43_empty_chanspec(&nphy->rssical_chanspec_5G))
 			return;
 		rssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;
 		rssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;
@@ -2440,7 +2453,7 @@ static void b43_nphy_save_cal(struct b43_wldev *dev)
 
 	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
 	u16 *txcal_radio_regs = NULL;
-	u8 *iqcal_chanspec;
+	struct b43_chanspec *iqcal_chanspec;
 	u16 *table = NULL;
 
 	if (nphy->hang_avoid)
@@ -2496,12 +2509,12 @@ static void b43_nphy_restore_cal(struct b43_wldev *dev)
 	struct b43_phy_n_iq_comp *rxcal_coeffs = NULL;
 
 	if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
-		if (nphy->iqcal_chanspec_2G == 0)
+		if (b43_empty_chanspec(&nphy->iqcal_chanspec_2G))
 			return;
 		table = nphy->cal_cache.txcal_coeffs_2G;
 		loft = &nphy->cal_cache.txcal_coeffs_2G[5];
 	} else {
-		if (nphy->iqcal_chanspec_5G == 0)
+		if (b43_empty_chanspec(&nphy->iqcal_chanspec_5G))
 			return;
 		table = nphy->cal_cache.txcal_coeffs_5G;
 		loft = &nphy->cal_cache.txcal_coeffs_5G[5];
@@ -2746,8 +2759,7 @@ static int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,
 			b43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,
 						nphy->txiqlocal_bestc);
 			nphy->txiqlocal_coeffsvalid = true;
-			/* TODO: Set nphy->txiqlocal_chanspec to
-				the current channel */
+			nphy->txiqlocal_chanspec = nphy->radio_chanspec;
 		} else {
 			length = 11;
 			if (dev->phy.rev < 3)
@@ -2782,7 +2794,8 @@ static void b43_nphy_reapply_tx_cal_coeffs(struct b43_wldev *dev)
 	u16 buffer[7];
 	bool equal = true;
 
-	if (!nphy->txiqlocal_coeffsvalid || 1 /* FIXME */)
+	if (!nphy->txiqlocal_coeffsvalid ||
+	    b43_eq_chanspecs(&nphy->txiqlocal_chanspec, &nphy->radio_chanspec))
 		return;
 
 	b43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);
@@ -3137,9 +3150,11 @@ int b43_phy_initn(struct b43_wldev *dev)
 	do_rssi_cal = false;
 	if (phy->rev >= 3) {
 		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
-			do_rssi_cal = (nphy->rssical_chanspec_2G == 0);
+			do_rssi_cal =
+				b43_empty_chanspec(&nphy->rssical_chanspec_2G);
 		else
-			do_rssi_cal = (nphy->rssical_chanspec_5G == 0);
+			do_rssi_cal =
+				b43_empty_chanspec(&nphy->rssical_chanspec_5G);
 
 		if (do_rssi_cal)
 			b43_nphy_rssi_cal(dev);
@@ -3151,9 +3166,9 @@ int b43_phy_initn(struct b43_wldev *dev)
 
 	if (!((nphy->measure_hold & 0x6) != 0)) {
 		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)
-			do_cal = (nphy->iqcal_chanspec_2G == 0);
+			do_cal = b43_empty_chanspec(&nphy->iqcal_chanspec_2G);
 		else
-			do_cal = (nphy->iqcal_chanspec_5G == 0);
+			do_cal = b43_empty_chanspec(&nphy->iqcal_chanspec_5G);
 
 		if (nphy->mute)
 			do_cal = false;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 47d20dc..e7acae2 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -984,7 +984,7 @@ struct b43_phy_n {
 	u16 papd_epsilon_offset[2];
 	s32 preamble_override;
 	u32 bb_mult_save;
-	u16 radio_chanspec;
+	struct b43_chanspec radio_chanspec;
 
 	bool gain_boost;
 	bool elna_gain_config;
@@ -1000,6 +1000,7 @@ struct b43_phy_n {
 	u16 txiqlocal_bestc[11];
 	bool txiqlocal_coeffsvalid;
 	struct b43_phy_n_txpwrindex txpwrindex[2];
+	struct b43_chanspec txiqlocal_chanspec;
 
 	u8 txrx_chain;
 	u16 tx_rx_cal_phy_saveregs[11];
@@ -1015,12 +1016,12 @@ struct b43_phy_n {
 	bool gband_spurwar_en;
 
 	bool ipa2g_on;
-	u8 iqcal_chanspec_2G;
-	u8 rssical_chanspec_2G;
+	struct b43_chanspec iqcal_chanspec_2G;
+	struct b43_chanspec rssical_chanspec_2G;
 
 	bool ipa5g_on;
-	u8 iqcal_chanspec_5G;
-	u8 rssical_chanspec_5G;
+	struct b43_chanspec iqcal_chanspec_5G;
+	struct b43_chanspec rssical_chanspec_5G;
 
 	struct b43_phy_n_rssical_cache rssical_cache;
 	struct b43_phy_n_cal_cache cal_cache;
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:38 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:38 +0100
Subject: [PATCH V2 07/10] b43: N-PHY: adjust gain table
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-8-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
 drivers/net/wireless/b43/phy_n.c |   58 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 57 insertions(+), 1 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 1952acc..30f8bf2 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -837,6 +837,62 @@ static void b43_nphy_spur_workaround(struct b43_wldev *dev)
 		b43_nphy_stay_in_carrier_search(dev, 0);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/AdjustLnaGainTbl */
+static void b43_nphy_adjust_lna_gain_table(struct b43_wldev *dev)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u8 i;
+	s16 tmp;
+	u16 data[4];
+	s16 gain[2];
+	u16 minmax[2];
+	u16 lna_gain[4] = { -2, 10, 19, 25 };
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 1);
+
+	if (nphy->gain_boost) {
+		if (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {
+			gain[0] = 6;
+			gain[1] = 6;
+		} else {
+			tmp = 40370 - 315 * nphy->radio_chanspec.channel;
+			gain[0] = ((tmp >> 13) + ((tmp >> 12) & 1));
+			tmp = 23242 - 224 * nphy->radio_chanspec.channel;
+			gain[1] = ((tmp >> 13) + ((tmp >> 12) & 1));
+		}
+	} else {
+		gain[0] = 0;
+		gain[1] = 0;
+	}
+
+	for (i = 0; i < 2; i++) {
+		if (nphy->elna_gain_config) {
+			data[0] = 19 + gain[i];
+			data[1] = 25 + gain[i];
+			data[2] = 25 + gain[i];
+			data[3] = 25 + gain[i];
+		} else {
+			data[0] = lna_gain[0] + gain[i];
+			data[1] = lna_gain[1] + gain[i];
+			data[2] = lna_gain[2] + gain[i];
+			data[3] = lna_gain[3] + gain[i];
+		}
+		b43_ntab_write_bulk(dev, B43_NTAB16(10, 8), 4, data);
+
+		minmax[i] = 23 + gain[i];
+	}
+
+	b43_phy_maskset(dev, B43_NPHY_C1_MINMAX_GAIN, ~B43_NPHY_C1_MINGAIN,
+				minmax[0] << B43_NPHY_C1_MINGAIN_SHIFT);
+	b43_phy_maskset(dev, B43_NPHY_C2_MINMAX_GAIN, ~B43_NPHY_C2_MINGAIN,
+				minmax[1] << B43_NPHY_C2_MINGAIN_SHIFT);
+
+	if (nphy->hang_avoid)
+		b43_nphy_stay_in_carrier_search(dev, 0);
+}
+
 /* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */
 static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 {
@@ -921,7 +977,7 @@ static void b43_nphy_gain_crtl_workarounds(struct b43_wldev *dev)
 		b43_phy_write(dev, B43_NPHY_TABLE_DATALO,
 					(code << 8 | 0x7C));
 
-		/* TODO: b43_nphy_adjust_lna_gain_table(dev); */
+		b43_nphy_adjust_lna_gain_table(dev);
 
 		if (nphy->elna_gain_config) {
 			b43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0808);
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:39 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:39 +0100
Subject: [PATCH V2 08/10] b43: N-PHY: isloate 2055 radio setup
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-9-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: unconditional flush
---
 drivers/net/wireless/b43/phy_n.c |   23 +++++++++++++++++------
 1 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 30f8bf2..ffe2622 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -155,6 +155,22 @@ static void b43_nphy_tx_power_fix(struct b43_wldev *dev)
 	//TODO
 }
 
+
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2055Setup */
+static void b43_radio_2055_setup(struct b43_wldev *dev,
+				const struct b43_nphy_channeltab_entry *e)
+{
+	B43_WARN_ON(dev->phy.rev >= 3);
+
+	b43_chantab_radio_upload(dev, e);
+	udelay(50);
+	b43_radio_write(dev, B2055_VCO_CAL10, 5);
+	b43_radio_write(dev, B2055_VCO_CAL10, 45);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+	b43_radio_write(dev, B2055_VCO_CAL10, 65);
+	udelay(300);
+}
+
 /* Tune the hardware to a new channel. */
 static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
 {
@@ -169,12 +185,7 @@ static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
 		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x20);
 	else
 		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x50);
-	b43_chantab_radio_upload(dev, tabent);
-	udelay(50);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 5);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 45);
-	b43_radio_write16(dev, B2055_VCO_CAL10, 65);
-	udelay(300);
+	b43_radio_2055_setup(dev, tabent);
 	if (0 /*FIXME 5Ghz*/)
 		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
 	else
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:40 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:40 +0100
Subject: [PATCH V2 09/10] b43: N-PHY: implement chanspec setup
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-10-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: use general SHM write
---
 drivers/net/wireless/b43/phy_n.c |   62 ++++++++++++++++++++++++++++++++++++++
 1 files changed, 62 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index ffe2622..862223f 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -3282,6 +3282,68 @@ int b43_phy_initn(struct b43_wldev *dev)
 	return 0;
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ChanspecSetup */
+static void b43_nphy_chanspec_setup(struct b43_wldev *dev,
+				const struct b43_nphy_channeltab_entry *e,
+				struct b43_chanspec chanspec)
+{
+	struct b43_phy *phy = &dev->phy;
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	u16 tmp;
+	u32 tmp32;
+
+	tmp = b43_phy_read(dev, B43_NPHY_BANDCTL) & B43_NPHY_BANDCTL_5GHZ;
+	if (chanspec.b_freq == 1 && tmp == 0) {
+		tmp32 = b43_read32(dev, B43_MMIO_PSM_PHY_HDR);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32 | 4);
+		b43_phy_set(dev, B43_PHY_B_BBCFG, 0xC000);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32);
+		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
+	} else if (chanspec.b_freq == 1) {
+		b43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);
+		tmp32 = b43_read32(dev, B43_MMIO_PSM_PHY_HDR);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32 | 4);
+		b43_phy_mask(dev, B43_PHY_B_BBCFG, (u16)~0xC000);
+		b43_write32(dev, B43_MMIO_PSM_PHY_HDR, tmp32);
+	}
+
+	b43_chantab_phy_upload(dev, e);
+
+	tmp = chanspec.channel;
+	if (chanspec.b_freq == 1)
+		tmp |= 0x0100;
+	if (chanspec.b_width == 3)
+		tmp |= 0x0200;
+	b43_shm_write16(dev, B43_SHM_SHARED, 0xA0, tmp);
+
+	if (nphy->radio_chanspec.channel == 14) {
+		b43_nphy_classifier(dev, 2, 0);
+		b43_phy_set(dev, B43_PHY_B_TEST, 0x0800);
+	} else {
+		b43_nphy_classifier(dev, 2, 2);
+		if (chanspec.b_freq == 2)
+			b43_phy_mask(dev, B43_PHY_B_TEST, ~0x840);
+	}
+
+	if (nphy->txpwrctrl)
+		b43_nphy_tx_power_fix(dev);
+
+	if (dev->phy.rev < 3)
+		b43_nphy_adjust_lna_gain_table(dev);
+
+	b43_nphy_tx_lp_fbw(dev);
+
+	if (dev->phy.rev >= 3 && 0) {
+		/* TODO */
+	}
+
+	b43_phy_write(dev, B43_NPHY_NDATAT_DUP40, 0x3830);
+
+	if (phy->rev >= 3)
+		b43_nphy_spur_workaround(dev);
+}
+
 static int b43_nphy_op_allocate(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy;
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:41 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:41 +0100
Subject: [PATCH V2 10/10] b43: N-PHY: switch to chanspec ops
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-11-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: fix typo
---
 drivers/net/wireless/b43/phy_n.c |   87 +++++++++++++++++++++++++++-----------
 drivers/net/wireless/b43/phy_n.h |    1 +
 2 files changed, 63 insertions(+), 25 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index 862223f..6fd140a 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -72,6 +72,7 @@ static void b43_nphy_rf_control_override(struct b43_wldev *dev, u16 field,
 						u16 value, u8 core, bool off);
 static void b43_nphy_rf_control_intc_override(struct b43_wldev *dev, u8 field,
 						u16 value, u8 core);
+static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel);
 
 static inline bool b43_empty_chanspec(struct b43_chanspec *chanspec)
 {
@@ -171,31 +172,6 @@ static void b43_radio_2055_setup(struct b43_wldev *dev,
 	udelay(300);
 }
 
-/* Tune the hardware to a new channel. */
-static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
-{
-	const struct b43_nphy_channeltab_entry *tabent;
-
-	tabent = b43_nphy_get_chantabent(dev, channel);
-	if (!tabent)
-		return -ESRCH;
-
-	//FIXME enable/disable band select upper20 in RXCTL
-	if (0 /*FIXME 5Ghz*/)
-		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x20);
-	else
-		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, 0x50);
-	b43_radio_2055_setup(dev, tabent);
-	if (0 /*FIXME 5Ghz*/)
-		b43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);
-	else
-		b43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);
-	b43_chantab_phy_upload(dev, tabent);
-	b43_nphy_tx_power_fix(dev);
-
-	return 0;
-}
-
 static void b43_radio_init2055_pre(struct b43_wldev *dev)
 {
 	b43_phy_mask(dev, B43_NPHY_RFCTL_CMD,
@@ -3344,6 +3320,67 @@ static void b43_nphy_chanspec_setup(struct b43_wldev *dev,
 		b43_nphy_spur_workaround(dev);
 }
 
+/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetChanspec */
+static int b43_nphy_set_chanspec(struct b43_wldev *dev,
+					struct b43_chanspec chanspec)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	const struct b43_nphy_channeltab_entry *tabent;
+
+	u8 tmp;
+	u8 channel = chanspec.channel;
+
+	if (dev->phy.rev >= 3) {
+		/* TODO */
+	}
+
+	nphy->radio_chanspec = chanspec;
+
+	if (chanspec.b_width != nphy->b_width)
+		; /* TODO: BMAC BW Set (chanspec.b_width) */
+
+	/* TODO: use defines */
+	if (chanspec.b_width == 3) {
+		if (chanspec.sideband == 2)
+			b43_phy_set(dev, B43_NPHY_RXCTL,
+					B43_NPHY_RXCTL_BSELU20);
+		else
+			b43_phy_mask(dev, B43_NPHY_RXCTL,
+					~B43_NPHY_RXCTL_BSELU20);
+	}
+
+	if (dev->phy.rev >= 3) {
+		tmp = (chanspec.b_freq == 1) ? 4 : 0;
+		b43_radio_maskset(dev, 0x08, 0xFFFB, tmp);
+		/* TODO: PHY Radio2056 Setup (chan_info_ptr[i]) */
+		/* TODO: N PHY Chanspec Setup (chan_info_ptr[i]) */
+	} else {
+		tabent = b43_nphy_get_chantabent(dev, channel);
+		if (!tabent)
+			return -ESRCH;
+
+		tmp = (chanspec.b_freq == 1) ? 0x0020 : 0x0050;
+		b43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, tmp);
+		b43_radio_2055_setup(dev, tabent);
+		b43_nphy_chanspec_setup(dev, tabent, chanspec);
+	}
+
+	return 0;
+}
+
+/* Tune the hardware to a new channel */
+static int nphy_channel_switch(struct b43_wldev *dev, unsigned int channel)
+{
+	struct b43_phy_n *nphy = dev->phy.n;
+
+	struct b43_chanspec chanspec;
+	chanspec = nphy->radio_chanspec;
+	chanspec.channel = channel;
+
+	return b43_nphy_set_chanspec(dev, chanspec);
+}
+
 static int b43_nphy_op_allocate(struct b43_wldev *dev)
 {
 	struct b43_phy_n *nphy;
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index e7acae2..8b6d570 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -984,6 +984,7 @@ struct b43_phy_n {
 	u16 papd_epsilon_offset[2];
 	s32 preamble_override;
 	u32 bb_mult_save;
+	u8 b_width;
 	struct b43_chanspec radio_chanspec;
 
 	bool gain_boost;
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:32 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:32 +0100
Subject: [PATCH V2 01/10] b43: N-PHY: add some registers and structs
	definitions
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-2-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: dropped obvious comment
---
 drivers/net/wireless/b43/b43.h         |    1 +
 drivers/net/wireless/b43/phy_n.h       |    9 +++++++++
 drivers/net/wireless/b43/tables_nphy.h |    9 +++++++++
 3 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/b43/b43.h b/drivers/net/wireless/b43/b43.h
index b8807fb..3a003e6 100644
--- a/drivers/net/wireless/b43/b43.h
+++ b/drivers/net/wireless/b43/b43.h
@@ -104,6 +104,7 @@
 #define B43_MMIO_MACFILTER_CONTROL	0x420
 #define B43_MMIO_MACFILTER_DATA		0x422
 #define B43_MMIO_RCMTA_COUNT		0x43C
+#define B43_MMIO_PSM_PHY_HDR		0x492
 #define B43_MMIO_RADIO_HWENABLED_LO	0x49A
 #define B43_MMIO_GPIO_CONTROL		0x49C
 #define B43_MMIO_GPIO_MASK		0x49E
diff --git a/drivers/net/wireless/b43/phy_n.h b/drivers/net/wireless/b43/phy_n.h
index 403aad3..47d20dc 100644
--- a/drivers/net/wireless/b43/phy_n.h
+++ b/drivers/net/wireless/b43/phy_n.h
@@ -711,6 +711,8 @@
 #define B43_NPHY_PAPD_EN1			B43_PHY_N(0x29B) /* PAPD Enable1 TBD */
 #define B43_NPHY_EPS_TABLE_ADJ1			B43_PHY_N(0x29C) /* EPS Table Adj1 TBD */
 
+#define B43_PHY_B_BBCFG				B43_PHY_N_BMODE(0x001) /* BB config */
+#define B43_PHY_B_TEST				B43_PHY_N_BMODE(0x00A)
 
 
 /* Broadcom 2055 radio registers */
@@ -924,6 +926,13 @@
 
 struct b43_wldev;
 
+struct b43_chanspec {
+	u8 channel;
+	u8 sideband;
+	u8 b_width;
+	u8 b_freq;
+};
+
 struct b43_phy_n_iq_comp {
 	s16 a0;
 	s16 b0;
diff --git a/drivers/net/wireless/b43/tables_nphy.h b/drivers/net/wireless/b43/tables_nphy.h
index 9c1c6ec..b23036f 100644
--- a/drivers/net/wireless/b43/tables_nphy.h
+++ b/drivers/net/wireless/b43/tables_nphy.h
@@ -4,6 +4,15 @@
 #include <linux/types.h>
 
 
+struct b43_phy_n_sfo_cfg {
+	u16 phy_bw1a;
+	u16 phy_bw2;
+	u16 phy_bw3;
+	u16 phy_bw4;
+	u16 phy_bw5;
+	u16 phy_bw6;
+};
+
 struct b43_nphy_channeltab_entry {
 	/* The channel number */
 	u8 channel;
-- 
1.6.4.2



From zajec5 at gmail.com  Sat Feb 27 13:03:35 2010
From: zajec5 at gmail.com (=?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?=)
Date: Sat, 27 Feb 2010 13:03:35 +0100
Subject: [PATCH V2 04/10] b43: N-PHY: update writing channel-specific radio
	registers
In-Reply-To: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
References: <1267272221-1873-1-git-send-email-zajec5@gmail.com>
Message-ID: <1267272221-1873-5-git-send-email-zajec5@gmail.com>

Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
---
V2: unconditional flushes
---
 drivers/net/wireless/b43/phy_n.c |   54 ++++++++++++++++++++++---------------
 1 files changed, 32 insertions(+), 22 deletions(-)

diff --git a/drivers/net/wireless/b43/phy_n.c b/drivers/net/wireless/b43/phy_n.c
index dd81e8a..2c592d2 100644
--- a/drivers/net/wireless/b43/phy_n.c
+++ b/drivers/net/wireless/b43/phy_n.c
@@ -90,28 +90,38 @@ static enum b43_txpwr_result b43_nphy_op_recalc_txpower(struct b43_wldev *dev,
 static void b43_chantab_radio_upload(struct b43_wldev *dev,
 				     const struct b43_nphy_channeltab_entry *e)
 {
-	b43_radio_write16(dev, B2055_PLL_REF, e->radio_pll_ref);
-	b43_radio_write16(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);
-	b43_radio_write16(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);
-	b43_radio_write16(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);
-	b43_radio_write16(dev, B2055_VCO_CAL1, e->radio_vco_cal1);
-	b43_radio_write16(dev, B2055_VCO_CAL2, e->radio_vco_cal2);
-	b43_radio_write16(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);
-	b43_radio_write16(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);
-	b43_radio_write16(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);
-	b43_radio_write16(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);
-	b43_radio_write16(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);
-	b43_radio_write16(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);
-	b43_radio_write16(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);
-	b43_radio_write16(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);
-	b43_radio_write16(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);
-	b43_radio_write16(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);
-	b43_radio_write16(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);
-	b43_radio_write16(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);
-	b43_radio_write16(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);
-	b43_radio_write16(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);
-	b43_radio_write16(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);
-	b43_radio_write16(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);
+	b43_radio_write(dev, B2055_PLL_REF, e->radio_pll_ref);
+	b43_radio_write(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);
+	b43_radio_write(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);
+	b43_radio_write(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+
+	b43_radio_write(dev, B2055_VCO_CAL1, e->radio_vco_cal1);
+	b43_radio_write(dev, B2055_VCO_CAL2, e->radio_vco_cal2);
+	b43_radio_write(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);
+	b43_radio_write(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+
+	b43_radio_write(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);
+	b43_radio_write(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);
+	b43_radio_write(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);
+	b43_radio_write(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+
+	b43_radio_write(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);
+	b43_radio_write(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);
+	b43_radio_write(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);
+	b43_radio_write(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+
+	b43_radio_write(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);
+	b43_radio_write(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);
+	b43_radio_write(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);
+	b43_radio_write(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);
+	b43_read32(dev, B43_MMIO_MACCTL); /* flush writes */
+
+	b43_radio_write(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);
+	b43_radio_write(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);
 }
 
 static void b43_chantab_phy_upload(struct b43_wldev *dev,
-- 
1.6.4.2



From mb at bu3sch.de  Sat Feb 27 16:16:52 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 16:16:52 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
Message-ID: <201002271616.53255.mb@bu3sch.de>

On Friday 26 February 2010 23:03:28 G?bor Stefanik wrote:
> BTW there is an interesting difference in the early init between wl
> and b43: b43 sets bit 0x200 in core register 0x600, while wl sets
> 0x8000 in register 0x280a - an undocumented register.

Well, it is not only undocumented, it's also far beyond the address space.
SSB core address space goes from 0-0xFFF. And (more important!) the PCI address
space for MMIO is only 8k wide (I think there also are 4k devices).
Are you really sure your dumping is correct? I suspect a bug in your mmio
dumping tools.
I'd say the "undocumented" register is a completely unrelated hardware access
in a completely different device that just happens to be mapped right after ssb.

-- 
Greetings, Michael.


From mb at bu3sch.de  Sat Feb 27 16:20:31 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 16:20:31 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<20100226221247.5dc996ac@boulder.homenet>
	<69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
Message-ID: <201002271620.31410.mb@bu3sch.de>

On Saturday 27 February 2010 02:41:48 G?bor Stefanik wrote:
> Someone should test the following:
> -Open drivers/ssb/driver_chipcommon_pmu.c
> -In ssb_pmu_init, replace 0x4325 with 0x4312.

Uh, wait a second. Do _all_ cards that show the behavior have a PMU on the SSB?
If so, you should really make sure the PMU setup is correct. If the PMU
cuts power to the device at inappropriate times, it sure does result in DMA errors (and
silent MMIO errors).

-- 
Greetings, Michael.


From mb at bu3sch.de  Sat Feb 27 15:51:25 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 15:51:25 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs
	definitions
In-Reply-To: <b170af451002270312y304b9c81mc6223a6e28608f3a@mail.gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002100002.11369.mb@bu3sch.de>
	<b170af451002270312y304b9c81mc6223a6e28608f3a@mail.gmail.com>
Message-ID: <201002271551.26126.mb@bu3sch.de>

On Saturday 27 February 2010 12:12:23 Rafa? Mi?ecki wrote:
> 2010/2/10 Michael Buesch <mb at bu3sch.de>:
> > On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
> >> +#define B43_MMIO_PSM_PHY_HDR ? ? ? ? 0x492 ? /* programmable state machine */
> >
> > The comment doesn't make a lot of sense.
> > In case you don't know, the PSM is the part of the hardware
> > that executes the firmware.
> 
> Well, guess you're right. It was me hearing for the first time "PSM"
> so decided to write it. Guess it's pretty obvious for every device
> driver developer :)
> 

Well, what I wanted to say is that it's more important to explain
what PHY_HDR means. Something like /* PSM PHY header */ ?

-- 
Greetings, Michael.


From mb at bu3sch.de  Sat Feb 27 15:50:19 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 15:50:19 +0100
Subject: [PATCH 08/11] b43: implement writing to MMIO shared memory
In-Reply-To: <b170af451002270309l1cbc880et100fc4e468386934@mail.gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002092359.24301.mb@bu3sch.de>
	<b170af451002270309l1cbc880et100fc4e468386934@mail.gmail.com>
Message-ID: <201002271550.19350.mb@bu3sch.de>

On Saturday 27 February 2010 12:09:30 Rafa? Mi?ecki wrote:
> 2010/2/9 Michael Buesch <mb at bu3sch.de>:
> > On Tuesday 09 February 2010 21:04:40 Rafa? Mi?ecki wrote:
> >> Signed-off-by: Rafa? Mi?ecki <zajec5 at gmail.com>
> >> ---
> >> ?drivers/net/wireless/b43/phy_common.c | ? 11 +++++++++++
> >> ?drivers/net/wireless/b43/phy_common.h | ? ?2 ++
> >> ?2 files changed, 13 insertions(+), 0 deletions(-)
> >>
> >> diff --git a/drivers/net/wireless/b43/phy_common.c b/drivers/net/wireless/b43/phy_common.c
> >> index 8f7d7ef..0b0f9df 100644
> >> --- a/drivers/net/wireless/b43/phy_common.c
> >> +++ b/drivers/net/wireless/b43/phy_common.c
> >> @@ -466,3 +466,14 @@ struct b43_c32 b43_cordic(int theta)
> >>
> >> ? ? ? return ret;
> >> ?}
> >> +
> >> +/* http://bcm-v4.sipsolutions.net/802.11/PHY/BmacWriteShm */
> >> +void b43_bmac_write_shm(struct b43_wldev *dev, u32 offset, u16 value)
> >> +{
> >> + ? ? b43_write32(dev, B43_MMIO_SHM_CONTROL, 0x00010000 | (offset >> 2));
> >> + ? ? b43_read32(dev, B43_MMIO_SHM_CONTROL);
> >> + ? ? if (offset & 2)
> >> + ? ? ? ? ? ? b43_write16(dev, 0x165, value);
> >> + ? ? else
> >> + ? ? ? ? ? ? b43_write16(dev, B43_MMIO_SHM_DATA, value);
> >> +}
> >
> > I'd like to put a biiiig questionmark on this.
> > We already have SHM access. Your function does exactly the same, except that it
> > accesses the bullshit register h165.
> 
> Yeah, that 0x165 is really crappy. Let's hope it really should be
> 0x166 (B43_MMIO_SHM_DATA_UNALIGNED).
> 
> Do you think we should add dummy-read to b43_shm_control_word as
> BmacWriteShm does? Currently we do not perform that.

That doesn't hurt.
It probably won't help much either, as the whole driver depends on implicit write posting.
But I don't care whether you add it or not.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Sat Feb 27 16:55:09 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Feb 2010 09:55:09 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <201002271616.53255.mb@bu3sch.de>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<20100226215726.74483011@boulder.homenet>
	<69e28c911002261403q49b91b4cj6bae776371eedd1e@mail.gmail.com>
	<201002271616.53255.mb@bu3sch.de>
Message-ID: <4B89405D.3040608@lwfinger.net>

On 02/27/2010 09:16 AM, Michael Buesch wrote:
> On Friday 26 February 2010 23:03:28 G?bor Stefanik wrote:
>> BTW there is an interesting difference in the early init between wl
>> and b43: b43 sets bit 0x200 in core register 0x600, while wl sets
>> 0x8000 in register 0x280a - an undocumented register.
> 
> Well, it is not only undocumented, it's also far beyond the address space.
> SSB core address space goes from 0-0xFFF. And (more important!) the PCI address
> space for MMIO is only 8k wide (I think there also are 4k devices).
> Are you really sure your dumping is correct? I suspect a bug in your mmio
> dumping tools.
> I'd say the "undocumented" register is a completely unrelated hardware access
> in a completely different device that just happens to be mapped right after ssb.

There are definite instances where the vendor driver writes beyond 0xFFF. I'm
pretty sure that some models shadow EEPROM above 0x1000. I don't know about 0x280A.

Larry



From Larry.Finger at lwfinger.net  Sat Feb 27 17:05:41 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Feb 2010 10:05:41 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <201002271620.31410.mb@bu3sch.de>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>	<20100226221247.5dc996ac@boulder.homenet>	<69e28c911002261741p6e835a64wdc553b1aa45ec8f@mail.gmail.com>
	<201002271620.31410.mb@bu3sch.de>
Message-ID: <4B8942D5.5020502@lwfinger.net>

On 02/27/2010 09:20 AM, Michael Buesch wrote:
> On Saturday 27 February 2010 02:41:48 G?bor Stefanik wrote:
>> Someone should test the following:
>> -Open drivers/ssb/driver_chipcommon_pmu.c
>> -In ssb_pmu_init, replace 0x4325 with 0x4312.
> 
> Uh, wait a second. Do _all_ cards that show the behavior have a PMU on the SSB?
> If so, you should really make sure the PMU setup is correct. If the PMU
> cuts power to the device at inappropriate times, it sure does result in DMA errors (and
> silent MMIO errors).

Yes, all of the LP PHY 14e4:4315 devices have a PMU. Mine shows "Found rev 1 PMU
(capabilities 0x02A62F01)". As I recall, at least one of the problem devices
shows the same capabilities.

Larry


From mb at bu3sch.de  Sat Feb 27 17:06:52 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 17:06:52 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B89405D.3040608@lwfinger.net>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271616.53255.mb@bu3sch.de> <4B89405D.3040608@lwfinger.net>
Message-ID: <201002271706.53060.mb@bu3sch.de>

On Saturday 27 February 2010 16:55:09 Larry Finger wrote:
> On 02/27/2010 09:16 AM, Michael Buesch wrote:
> > On Friday 26 February 2010 23:03:28 G?bor Stefanik wrote:
> >> BTW there is an interesting difference in the early init between wl
> >> and b43: b43 sets bit 0x200 in core register 0x600, while wl sets
> >> 0x8000 in register 0x280a - an undocumented register.
> > 
> > Well, it is not only undocumented, it's also far beyond the address space.
> > SSB core address space goes from 0-0xFFF. And (more important!) the PCI address
> > space for MMIO is only 8k wide (I think there also are 4k devices).
> > Are you really sure your dumping is correct? I suspect a bug in your mmio
> > dumping tools.
> > I'd say the "undocumented" register is a completely unrelated hardware access
> > in a completely different device that just happens to be mapped right after ssb.
> 
> There are definite instances where the vendor driver writes beyond 0xFFF. I'm
> pretty sure that some models shadow EEPROM above 0x1000. I don't know about 0x280A.

Well, writing beyond 0xFFF is one thing. But writing beyond 0x2000 is another.
The latter one writes beyond the mapped PCI space. Which basically writes to random
memory or whatever happens to be mapped there (arch dependent).

I would also not rule out typos in the vendor driver.
So, you might try if that particular write fixes the problem. But I doubt it can do so.
And if it doesn't, we should not apply it, because it's obviously incorrect.

-- 
Greetings, Michael.


From mb at bu3sch.de  Sat Feb 27 17:08:29 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 17:08:29 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B8942D5.5020502@lwfinger.net>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net>
Message-ID: <201002271708.29817.mb@bu3sch.de>

On Saturday 27 February 2010 17:05:41 Larry Finger wrote:
> On 02/27/2010 09:20 AM, Michael Buesch wrote:
> > On Saturday 27 February 2010 02:41:48 G?bor Stefanik wrote:
> >> Someone should test the following:
> >> -Open drivers/ssb/driver_chipcommon_pmu.c
> >> -In ssb_pmu_init, replace 0x4325 with 0x4312.
> > 
> > Uh, wait a second. Do _all_ cards that show the behavior have a PMU on the SSB?
> > If so, you should really make sure the PMU setup is correct. If the PMU
> > cuts power to the device at inappropriate times, it sure does result in DMA errors (and
> > silent MMIO errors).
> 
> Yes, all of the LP PHY 14e4:4315 devices have a PMU. Mine shows "Found rev 1 PMU
> (capabilities 0x02A62F01)". As I recall, at least one of the problem devices
> shows the same capabilities.

*HINT HINT HINT* ;)
Please make sure the PMU code really is correct.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Sat Feb 27 17:37:53 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Feb 2010 10:37:53 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <201002271708.29817.mb@bu3sch.de>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net>
	<201002271708.29817.mb@bu3sch.de>
Message-ID: <4B894A61.1070302@lwfinger.net>

On 02/27/2010 10:08 AM, Michael Buesch wrote:
> On Saturday 27 February 2010 17:05:41 Larry Finger wrote:
>> On 02/27/2010 09:20 AM, Michael Buesch wrote:
>>> On Saturday 27 February 2010 02:41:48 G?bor Stefanik wrote:
>>>> Someone should test the following:
>>>> -Open drivers/ssb/driver_chipcommon_pmu.c
>>>> -In ssb_pmu_init, replace 0x4325 with 0x4312.
>>>
>>> Uh, wait a second. Do _all_ cards that show the behavior have a PMU on the SSB?
>>> If so, you should really make sure the PMU setup is correct. If the PMU
>>> cuts power to the device at inappropriate times, it sure does result in DMA errors (and
>>> silent MMIO errors).
>>
>> Yes, all of the LP PHY 14e4:4315 devices have a PMU. Mine shows "Found rev 1 PMU
>> (capabilities 0x02A62F01)". As I recall, at least one of the problem devices
>> shows the same capabilities.
> 
> *HINT HINT HINT* ;)
> Please make sure the PMU code really is correct.

Where are the specs that were used to write the original code? I cannot find
them in either the V3 or V4 pages.

Larry


From netrolller.3d at gmail.com  Sat Feb 27 20:45:50 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 27 Feb 2010 20:45:50 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B894A61.1070302@lwfinger.net>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net>
Message-ID: <69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>

On Sat, Feb 27, 2010 at 5:37 PM, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> On 02/27/2010 10:08 AM, Michael Buesch wrote:
>> On Saturday 27 February 2010 17:05:41 Larry Finger wrote:
>>> On 02/27/2010 09:20 AM, Michael Buesch wrote:
>>>> On Saturday 27 February 2010 02:41:48 G?bor Stefanik wrote:
>>>>> Someone should test the following:
>>>>> -Open drivers/ssb/driver_chipcommon_pmu.c
>>>>> -In ssb_pmu_init, replace 0x4325 with 0x4312.
>>>>
>>>> Uh, wait a second. Do _all_ cards that show the behavior have a PMU on the SSB?
>>>> If so, you should really make sure the PMU setup is correct. If the PMU
>>>> cuts power to the device at inappropriate times, it sure does result in DMA errors (and
>>>> silent MMIO errors).
>>>
>>> Yes, all of the LP PHY 14e4:4315 devices have a PMU. Mine shows "Found rev 1 PMU
>>> (capabilities 0x02A62F01)". As I recall, at least one of the problem devices
>>> shows the same capabilities.
>>
>> *HINT HINT HINT* ;)
>> Please make sure the PMU code really is correct.
>
> Where are the specs that were used to write the original code? I cannot find
> them in either the V3 or V4 pages.
>
> Larry
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>

So, a quick status update, from what I've found yesterday:

    1. We get the PMU setup wrong. Bit 0x200 is being set, despite the
PMU being rev1. Also, PMU setup is done too early - at least wl reads
the SPROM before setting up the PMU. A write of 0xcbb to offset 0x618
is also missing - I seem to remember that this change has been tried
already, to no avail; but it may be a prerequisite of the real fix.
    2. Just before the SPROM readout, we are missing a "Set 0x8000 in
MMIO offset 0x280a". This looks curiously like "PCI-E Miscellaneous
Configuration", from http://bcm-v4.sipsolutions.net/PCI-E - and
indeed, the value read out from 0x280a is identical to offset 0xa in
my SPROM. So, the right thing to do here is probably "Switch to the
PCIE core, set 0x8000 in MIMO offset 0x80a (or maybe 0x1000a?), switch
back to ChipCommon". I don't know what core is active during this
write, as mmiotrace doesn't catch pci_read/write_config_dword calls.
Larry, do you know a way to monitor PCI config space access in a way
that can be matched (e.g. using timestamps) to the MMIO trace?
    3. Right after the SPROM is read, wl writes zeros to MMIO offsets
0x58 and 0x5c (32-bit), then does the PMU setup. These are not valid
registers for ChipCommon and PCIE, but for 802.11, they fall directly
into the DMA area! So, if these writes happened with the 802.11 core
active, they are probably significant.

I second Larry's question: where are the specs for the PMU init code?

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Sat Feb 27 22:10:42 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sat, 27 Feb 2010 22:10:42 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002271239n3e560c9aq1e386c7b96c2e4c2@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<a221c0101002271239n3e560c9aq1e386c7b96c2e4c2@mail.gmail.com>
Message-ID: <69e28c911002271310g59b3f5cqd5249944215b1a65@mail.gmail.com>

2010/2/27 Nathan Schulte <reklipz at gmail.com>:
> I've been following along with the linux-wireless thread, and wanted
> to bring up a few points.
>
> 1) If the report in reference by G?bor: "Well, we have a report from
> someone with an Intel T7250, ..." is mine, note that my processor is
> actually a T5670 @ 1.8GHz, not a T7250 @ 2.0GHz. ?Just for the record.

I was referring to Lucas, he has a T7250 AFAIK.

>
> 2) My BIOS setup has only one option related to the chip: "WLAN
> control: enabled/disabled", which just enables or disables the card.

That's basically RFKILL, were it misconfigured, you wouldn't even get
to the point where a DMA error can occur.

>
> 2) In regard to Michael's statement about having someone with the
> hardware who can do some real debug work; ?I have the hardware, I like
> to think I've got a fairly good idea of what's going on (I'm able to
> follow along), I can read and understand the src (but as mentioned,
> there is a lot of indirection, I have little idea what is actually
> happening when). ?I'm more than willing to help, but learning the ssb
> and b43 drivers in and out is quite a large task.
>
> Just my thoughts, hope I'm not just getting in the way.
>
> -Nate
>

Thanks - but currently I'm still trying to find out how you can trace
PCI config space accesses (pci_config_read/write_(d)word - if you have
an idea on this, please post it). However, I will probably have a few
test patches for you soon.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sat Feb 27 22:39:25 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Feb 2010 22:39:25 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
Message-ID: <201002272239.26257.mb@bu3sch.de>

On Saturday 27 February 2010 20:45:50 G?bor Stefanik wrote:
>     2. Just before the SPROM readout, we are missing a "Set 0x8000 in
> MMIO offset 0x280a". This looks curiously like "PCI-E Miscellaneous
> Configuration", from http://bcm-v4.sipsolutions.net/PCI-E - and
> indeed, the value read out from 0x280a is identical to offset 0xa in
> my SPROM. So, the right thing to do here is probably "Switch to the
> PCIE core, set 0x8000 in MIMO offset 0x80a (or maybe 0x1000a?), switch
> back to ChipCommon". I don't know what core is active during this

Well, 0x280a and 0x80a basically is not the same in my part of the world.
To ask it again: Is it possible that the 0x2000 bit of the address comes from
some random burp/bug in the tracing code? It _really_ doesn't make any sense,
because it's beyond the mapped space of the device.

> write, as mmiotrace doesn't catch pci_read/write_config_dword calls.
> Larry, do you know a way to monitor PCI config space access in a way
> that can be matched (e.g. using timestamps) to the MMIO trace?
>     3. Right after the SPROM is read, wl writes zeros to MMIO offsets
> 0x58 and 0x5c (32-bit), then does the PMU setup. These are not valid
> registers for ChipCommon and PCIE, but for 802.11, they fall directly
> into the DMA area!

The writes (_if_ they happen on the 802.11 core) fall into the
interrupt status and masks of the 8th DMA engine (they do not fall into the
MMIO of the DMA engines).
We don't use the 8th engine. It probably is a good idea to write zeros
to the mask register anyway, so I'll spin up a quick test patch.

-- 
Greetings, Michael.


From Larry.Finger at lwfinger.net  Sat Feb 27 23:33:07 2010
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Feb 2010 16:33:07 -0600
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net>
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
Message-ID: <4B899DA3.4030100@lwfinger.net>

On 02/27/2010 01:45 PM, G?bor Stefanik wrote:
> 
> So, a quick status update, from what I've found yesterday:
> 
>     1. We get the PMU setup wrong. Bit 0x200 is being set, despite the
> PMU being rev1. Also, PMU setup is done too early - at least wl reads
> the SPROM before setting up the PMU. A write of 0xcbb to offset 0x618
> is also missing - I seem to remember that this change has been tried
> already, to no avail; but it may be a prerequisite of the real fix.
>     2. Just before the SPROM readout, we are missing a "Set 0x8000 in
> MMIO offset 0x280a". This looks curiously like "PCI-E Miscellaneous
> Configuration", from http://bcm-v4.sipsolutions.net/PCI-E - and
> indeed, the value read out from 0x280a is identical to offset 0xa in
> my SPROM. So, the right thing to do here is probably "Switch to the
> PCIE core, set 0x8000 in MIMO offset 0x80a (or maybe 0x1000a?), switch
> back to ChipCommon". I don't know what core is active during this
> write, as mmiotrace doesn't catch pci_read/write_config_dword calls.
> Larry, do you know a way to monitor PCI config space access in a way
> that can be matched (e.g. using timestamps) to the MMIO trace?

The printk's I sent yesterday can have timing info, but the timestamps would not
be exactly coordinated - printk values seem to be generated when logged, not
when requested.

>     3. Right after the SPROM is read, wl writes zeros to MMIO offsets
> 0x58 and 0x5c (32-bit), then does the PMU setup. These are not valid
> registers for ChipCommon and PCIE, but for 802.11, they fall directly
> into the DMA area! So, if these writes happened with the 802.11 core
> active, they are probably significant.

That sounds promising. I think I found the section, which will have the
following specs:

 1. If the Chip Common revision >= 20
  a. Save the current core index
  a. Set core to chip common
  a. Write 0 to GPIO Pullup (register 0x58)
  a. Write 0 to GPIO Pulldown (register 0x5C)
  a. Restore the original core
 1. If PMU Control Enabled
  a. Init the PMU
  ...

A quick look ar the code suggests this should go into ssb_chipcommon_init() just
after the return for not having a chip common. In addition, chip common will
already be selected, thus that part can be skipped.


> I second Larry's question: where are the specs for the PMU init code?

>From what Michael replied, they do not exist in a public place other that the
reference code for embedded systems. I have started them - there is now a PMU
Init page and I'll fill them in as I can. If you have a specific routine, let me
know.

Larry




From netrolller.3d at gmail.com  Sun Feb 28 00:34:45 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 00:34:45 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B899DA3.4030100@lwfinger.net>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
Message-ID: <69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>

2010/2/27 Larry Finger <Larry.Finger at lwfinger.net>:
>
>> ? ? 3. Right after the SPROM is read, wl writes zeros to MMIO offsets
>> 0x58 and 0x5c (32-bit), then does the PMU setup. These are not valid
>> registers for ChipCommon and PCIE, but for 802.11, they fall directly
>> into the DMA area! So, if these writes happened with the 802.11 core
>> active, they are probably significant.
>
> That sounds promising. I think I found the section, which will have the
> following specs:
>
> ?1. If the Chip Common revision >= 20
> ?a. Save the current core index
> ?a. Set core to chip common
> ?a. Write 0 to GPIO Pullup (register 0x58)
> ?a. Write 0 to GPIO Pulldown (register 0x5C)
> ?a. Restore the original core
> ?1. If PMU Control Enabled
> ?a. Init the PMU
> ?...
>
> A quick look ar the code suggests this should go into ssb_chipcommon_init() just
> after the return for not having a chip common. In addition, chip common will
> already be selected, thus that part can be skipped.
>

OK, I whipped up a quick test patch with changes found so far
implemented. Please test if this improves the situation.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Sun Feb 28 00:44:58 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 00:44:58 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
Message-ID: <69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>

2010/2/28 Nathan Schulte <reklipz at gmail.com>:
> 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
>> OK, I whipped up a quick test patch with changes found so far
>> implemented. Please test if this improves the situation.
> Where can I find this patch?
>
> -Nate
>

Oops... yes, I forgot it. Here it is!

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: lpphy-test.patch
Type: application/octet-stream
Size: 2437 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100228/a07ad7e1/attachment.obj>

From chris at cvine.freeserve.co.uk  Sun Feb 28 01:16:55 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sun, 28 Feb 2010 00:16:55 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net>
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
Message-ID: <20100228001655.4c9fd9ce@boulder.homenet>

On Sun, 28 Feb 2010 00:44:58 +0100
G?bor Stefanik <netrolller.3d at gmail.com> wrote:
> 2010/2/28 Nathan Schulte <reklipz at gmail.com>:
> > 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
> >> OK, I whipped up a quick test patch with changes found so far
> >> implemented. Please test if this improves the situation.
> > Where can I find this patch?
> >
> > -Nate
> >
> 
> Oops... yes, I forgot it. Here it is!

This doesn't help on my netbook, I am afraid.

Chris




From netrolller.3d at gmail.com  Sun Feb 28 01:26:10 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 01:26:10 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002271620g7e21d245icdd5c6d0178c2a8a@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<4B8942D5.5020502@lwfinger.net> <201002271708.29817.mb@bu3sch.de> 
	<4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com> 
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com> 
	<a221c0101002271620g7e21d245icdd5c6d0178c2a8a@mail.gmail.com>
Message-ID: <69e28c911002271626r358424c9mf6ec0b901bbcd7e4@mail.gmail.com>

2010/2/28 Nathan Schulte <reklipz at gmail.com>:
> 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
>> Oops... yes, I forgot it. Here it is!
> No luck from me either.
>
> And by the way, Lucas and I have the exact same hardware, so his is
> indeed a T5670 as well.
>
> -Nate
>

Are you sure it is exactly the same? There are usually multiple
configurations of the same laptop model available, e.g. I have an Acer
5720ZG with Pentium E2330, but it is also available with e.g. Pentium
E2370.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Sun Feb 28 01:35:03 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 01:35:03 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002271631g7e194917haa770124b85962ea@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com> 
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com> 
	<a221c0101002271620g7e21d245icdd5c6d0178c2a8a@mail.gmail.com> 
	<69e28c911002271626r358424c9mf6ec0b901bbcd7e4@mail.gmail.com> 
	<a221c0101002271631g7e194917haa770124b85962ea@mail.gmail.com>
Message-ID: <69e28c911002271635n1d55c020n5a61a72142112008@mail.gmail.com>

2010/2/28 Nathan Schulte <reklipz at gmail.com>:
> 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
>> Are you sure it is exactly the same? There are usually multiple
>> configurations of the same laptop model available, e.g. I have an Acer
>> 5720ZG with Pentium E2330, but it is also available with e.g. Pentium
>> E2370.
> Yes, I am 100% certain, I spoke with him Friday morning in person.
>
> -Nate
>

Sorry for the confusion then - just checked my mail archive, and
indeed, Lucas wasn't the one with the 7250 - it was Thomas Backlund.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From zajec5 at gmail.com  Sun Feb 28 02:37:21 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 28 Feb 2010 02:37:21 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs 
	definitions
In-Reply-To: <201002271551.26126.mb@bu3sch.de>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002100002.11369.mb@bu3sch.de>
	<b170af451002270312y304b9c81mc6223a6e28608f3a@mail.gmail.com>
	<201002271551.26126.mb@bu3sch.de>
Message-ID: <b170af451002271737l955b819n582b9dd4c12ab747@mail.gmail.com>

W dniu 27 lutego 2010 15:51 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> On Saturday 27 February 2010 12:12:23 Rafa? Mi?ecki wrote:
>> 2010/2/10 Michael Buesch <mb at bu3sch.de>:
>> > On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
>> >> +#define B43_MMIO_PSM_PHY_HDR ? ? ? ? 0x492 ? /* programmable state machine */
>> >
>> > The comment doesn't make a lot of sense.
>> > In case you don't know, the PSM is the part of the hardware
>> > that executes the firmware.
>>
>> Well, guess you're right. It was me hearing for the first time "PSM"
>> so decided to write it. Guess it's pretty obvious for every device
>> driver developer :)
>>
>
> Well, what I wanted to say is that it's more important to explain
> what PHY_HDR means. Something like /* PSM PHY header */ ?

Sure, explaining HDR sounds great, but do you actually know it's
header? Personally I have no idea, so I am not sure if you know that
with nice probability of being right, or are you just guessing? :)


-- 
Rafa?


From zajec5 at gmail.com  Sun Feb 28 02:43:09 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 28 Feb 2010 02:43:09 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002271635n1d55c020n5a61a72142112008@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
	<a221c0101002271620g7e21d245icdd5c6d0178c2a8a@mail.gmail.com>
	<69e28c911002271626r358424c9mf6ec0b901bbcd7e4@mail.gmail.com>
	<a221c0101002271631g7e194917haa770124b85962ea@mail.gmail.com>
	<69e28c911002271635n1d55c020n5a61a72142112008@mail.gmail.com>
Message-ID: <b170af451002271743u30d38248ve092d84493d08c1@mail.gmail.com>

2010/2/28 G?bor Stefanik <netrolller.3d at gmail.com>:
> 2010/2/28 Nathan Schulte <reklipz at gmail.com>:
>> 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
>>> Are you sure it is exactly the same? There are usually multiple
>>> configurations of the same laptop model available, e.g. I have an Acer
>>> 5720ZG with Pentium E2330, but it is also available with e.g. Pentium
>>> E2370.
>> Yes, I am 100% certain, I spoke with him Friday morning in person.
>>
>> -Nate
>>
>
> Sorry for the confusion then - just checked my mail archive, and
> indeed, Lucas wasn't the one with the 7250 - it was Thomas Backlund.

Nate/Nathan please learn using "Reply to all". That's quite annoying
to get you answers from G?bor's citations only.

-- 
Rafa?


From netrolller3d at users.sourceforge.net  Sun Feb 28 09:42:47 2010
From: netrolller3d at users.sourceforge.net (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 09:42:47 +0100
Subject: Mailing list test, please ignore
Message-ID: <69e28c911002280042s78a2aa18h78ed6e0e18b92ee1@mail.gmail.com>

Mailing list test, please ignore.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sun Feb 28 12:46:15 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Feb 2010 12:46:15 +0100
Subject: [PATCH 01/11] b43: N-PHY: add some registers and structs
	definitions
In-Reply-To: <b170af451002271737l955b819n582b9dd4c12ab747@mail.gmail.com>
References: <1265745883-3392-2-git-send-email-zajec5@gmail.com>
	<201002271551.26126.mb@bu3sch.de>
	<b170af451002271737l955b819n582b9dd4c12ab747@mail.gmail.com>
Message-ID: <201002281246.15965.mb@bu3sch.de>

On Sunday 28 February 2010 02:37:21 Rafa? Mi?ecki wrote:
> W dniu 27 lutego 2010 15:51 u?ytkownik Michael Buesch <mb at bu3sch.de> napisa?:
> > On Saturday 27 February 2010 12:12:23 Rafa? Mi?ecki wrote:
> >> 2010/2/10 Michael Buesch <mb at bu3sch.de>:
> >> > On Tuesday 09 February 2010 21:04:33 Rafa? Mi?ecki wrote:
> >> >> +#define B43_MMIO_PSM_PHY_HDR ? ? ? ? 0x492 ? /* programmable state machine */
> >> >
> >> > The comment doesn't make a lot of sense.
> >> > In case you don't know, the PSM is the part of the hardware
> >> > that executes the firmware.
> >>
> >> Well, guess you're right. It was me hearing for the first time "PSM"
> >> so decided to write it. Guess it's pretty obvious for every device
> >> driver developer :)
> >>
> >
> > Well, what I wanted to say is that it's more important to explain
> > what PHY_HDR means. Something like /* PSM PHY header */ ?
> 
> Sure, explaining HDR sounds great, but do you actually know it's
> header? Personally I have no idea, so I am not sure if you know that
> with nice probability of being right, or are you just guessing? :)

Well, I assumed you could deduce the meaning from the code. If not, it's
better to leave it without a comment. I don't know for sure what this means.
But declaring the definition as "Programmable State Machine" is also
wrong. So let's simply leave it without a comment.


-- 
Greetings, Michael.


From netrolller.3d at gmail.com  Sun Feb 28 17:14:32 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 17:14:32 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <a221c0101002271828ye265d72y774320c08a4a15da@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271620.31410.mb@bu3sch.de> <4B8942D5.5020502@lwfinger.net> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<a221c0101002271703p3f344ec4t78d5c8b77c6d1290@mail.gmail.com> 
	<a221c0101002271828ye265d72y774320c08a4a15da@mail.gmail.com>
Message-ID: <69e28c911002280814v56f2f553x847c8bae94e6aaab@mail.gmail.com>

2010/2/28 Nathan Schulte <reklipz at gmail.com>:
> On Sat, Feb 27, 2010 at 7:03 PM, Nathan Schulte <reklipz at gmail.com> wrote:
>> 2010/2/27 Larry Finger <Larry.Finger at lwfinger.net>:
>>> The printk's I sent yesterday can have timing info, but the timestamps would not
>>> be exactly coordinated - printk values seem to be generated when logged, not
>>> when requested.
>> I modified mmiotrace to log via printk as well, which should give the
>> desired results.
>>
>> I will post the same mmiotraces as requested before, once I complete them.
> http://vulcan.ist.unomaha.edu/~nmschulte/mmiotraces_syslog.tar.bz2
>
> *_syslog contains mmiotrace and pci read/write synchronously merged
> via printk to syslog. ?The log messages were prefixed with ~~, and are
> in context with the rest of syslog. ?A simple awk should be able to
> remove the context, but there's not much of it (and what there is is
> relevant to the drivers in question), so I left it in.
>
> -Nate
>

OK, this dump shows the 0x280a write happening with core 3, i.e. PCIE,
active. So, it is indeed probably the "PCIE misc configuration"
routine. Why it's 0x280a is still a mystery to me, it should be 0x100a
according to the specs.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From toekimov at gmail.com  Sun Feb 28 18:25:12 2010
From: toekimov at gmail.com (Ekimov Alexandr)
Date: Sun, 28 Feb 2010 20:25:12 +0300
Subject: card 4318 rev2 doesn't work at ad-hoc with kernel 2.6.32
Message-ID: <201002282025.12593.toekimov@gmail.com>

Hello,
My broadcom card works fine with kernel 2.6.30 and it doesn't with  kernel 
2.6.32.
Card works at ad-hoc mode without encryption. Other device can see point, can 
connect to it. Connection takes long time, about 20-30 secs. But no ping, 
nothing.

Details
dmesg output in attach.
OS: Debian Linux testing 2.6.32-trunk-amd64
Card:  Broadcom Corporation BCM4318 [AirForce One 54g] 802.11g Wireless LAN 
Controller (rev 02)
        Subsystem: ASUSTeK Computer Inc. WL-138G V2 802.11g WLAN PCI Card
04:06.0 0280: 14e4:4318 (rev 02)
        Subsystem: 1043:100f
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
Stepping- SERR+ FastB2B- DisINTx-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- 
<TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 64
        Interrupt: pin A routed to IRQ 21
        Region 0: Memory at fbffc000 (32-bit, non-prefetchable) [size=8K]
        Kernel driver in use: b43-pci-bridge
--
Ekimov Alexander
-------------- next part --------------
[    0.000000] Initializing cgroup subsys cpuset                                     
[    0.000000] Initializing cgroup subsys cpu                                        
[    0.000000] Linux version 2.6.32-trunk-amd64 (Debian 2.6.32-5) (ben at decadent.org.uk) (gcc version 4.3.4 (Debian 4.3.4-6) ) #1 SMP Sun Jan 10 22:40:40 UTC 2010                                                                                                                                                         
[    0.000000] Command line: BOOT_IMAGE=//vmlinuz-2.6.32-trunk-amd64 root=UUID=6bb1bace-a4ca-4fed-98b9-b6d64aca7cbe ro quiet                                 
[    0.000000] KERNEL supported cpus:                                                                                                                        
[    0.000000]   Intel GenuineIntel                                                                                                                          
[    0.000000]   AMD AuthenticAMD                                                                                                                            
[    0.000000]   Centaur CentaurHauls                                                                                                                        
[    0.000000] BIOS-provided physical RAM map:                                                                                                               
[    0.000000]  BIOS-e820: 0000000000000000 - 000000000009fc00 (usable)                                                                                      
[    0.000000]  BIOS-e820: 000000000009fc00 - 00000000000a0000 (reserved)                                                                                    
[    0.000000]  BIOS-e820: 00000000000e6000 - 0000000000100000 (reserved)                                                                                    
[    0.000000]  BIOS-e820: 0000000000100000 - 000000007ff90000 (usable)                                                                                      
[    0.000000]  BIOS-e820: 000000007ff90000 - 000000007ffa8000 (ACPI data)                                                                                   
[    0.000000]  BIOS-e820: 000000007ffa8000 - 000000007ffd0000 (ACPI NVS)                                                                                    
[    0.000000]  BIOS-e820: 000000007ffd0000 - 0000000080000000 (reserved)                                                                                    
[    0.000000]  BIOS-e820: 00000000fff00000 - 0000000100000000 (reserved)                                                                                    
[    0.000000] DMI present.                                                                                                                                  
[    0.000000] AMI BIOS detected: BIOS may corrupt low RAM, working around it.                                                                               
[    0.000000] e820 update range: 0000000000000000 - 0000000000010000 (usable) ==> (reserved)                                                                
[    0.000000] last_pfn = 0x7ff90 max_arch_pfn = 0x400000000                                                                                                 
[    0.000000] MTRR default type: uncachable                                                                                                                 
[    0.000000] MTRR fixed ranges enabled:                                                                                                                    
[    0.000000]   00000-9FFFF write-back                                                                                                                      
[    0.000000]   A0000-EFFFF uncachable                                                                                                                      
[    0.000000]   F0000-FFFFF write-protect                                                                                                                   
[    0.000000] MTRR variable ranges enabled:                                                                                                                 
[    0.000000]   0 base 000000000000 mask FFFF80000000 write-back                                                                                            
[    0.000000]   1 disabled                                                                                                                                  
[    0.000000]   2 disabled                                                                                                                                  
[    0.000000]   3 disabled                                                                                                                                  
[    0.000000]   4 disabled                                                                                                                                  
[    0.000000]   5 disabled                                                                                                                                  
[    0.000000]   6 disabled                                                                                                                                  
[    0.000000]   7 disabled                                                                                                                                  
[    0.000000] x86 PAT enabled: cpu 0, old 0x7040600070406, new 0x7010600070106                                                                              
[    0.000000] initial memory mapped : 0 - 20000000                                                                                                          
[    0.000000] Using GB pages for direct mapping                                                                                                             
[    0.000000] init_memory_mapping: 0000000000000000-000000007ff90000                                                                                        
[    0.000000]  0000000000 - 0040000000 page 1G                                                                                                              
[    0.000000]  0040000000 - 007fe00000 page 2M                                                                                                              
[    0.000000]  007fe00000 - 007ff90000 page 4k                                                                                                              
[    0.000000] kernel direct mapping tables up to 7ff90000 @ 10000-13000                                                                                     
[    0.000000] RAMDISK: 376e5000 - 37fef8a5                                                                                                                  
[    0.000000] ACPI: RSDP 00000000000fb8b0 00014 (v00 ACPIAM)                                                                                                
[    0.000000] ACPI: RSDT 000000007ff90000 00038 (v01 091109 RSDT1219 20090911 MSFT 00000097)                                                                
[    0.000000] ACPI: FACP 000000007ff90200 00084 (v01 091109 FACP1219 20090911 MSFT 00000097)                                                                
[    0.000000] ACPI Warning: Optional field Pm2ControlBlock has zero address or length: 0000000000000000/1 (20090903/tbfadt-557)                             
[    0.000000] ACPI: DSDT 000000007ff90440 0E774 (v01  A1152 A1152000 00000000 INTL 20060113)                                                                
[    0.000000] ACPI: FACS 000000007ffa8000 00040                                                                                                             
[    0.000000] ACPI: APIC 000000007ff90390 0006C (v01 091109 APIC1219 20090911 MSFT 00000097)                                                                
[    0.000000] ACPI: MCFG 000000007ff90400 0003C (v01 091109 OEMMCFG  20090911 MSFT 00000097)                                                                
[    0.000000] ACPI: OEMB 000000007ffa8040 00072 (v01 091109 OEMB1219 20090911 MSFT 00000097)                                                                
[    0.000000] ACPI: HPET 000000007ff9f440 00038 (v01 091109 OEMHPET  20090911 MSFT 00000097)                                                                
[    0.000000] ACPI: Local APIC address 0xfee00000                                                                                                           
[    0.000000] Scanning NUMA topology in Northbridge 24                                                                                                      
[    0.000000] No NUMA configuration found                                                                                                                   
[    0.000000] Faking a node at 0000000000000000-000000007ff90000                                                                                            
[    0.000000] Bootmem setup node 0 0000000000000000-000000007ff90000                                                                                        
[    0.000000]   NODE_DATA [0000000000012000 - 0000000000019fff]                                                                                             
[    0.000000]   bootmap [000000000001a000 -  0000000000029ff7] pages 10                                                                                     
[    0.000000] (7 early reservations) ==> bootmem [0000000000 - 007ff90000]                                                                                  
[    0.000000]   #0 [0000000000 - 0000001000]   BIOS data page ==> [0000000000 - 0000001000]                                                                 
[    0.000000]   #1 [0000006000 - 0000008000]       TRAMPOLINE ==> [0000006000 - 0000008000]                                                                 
[    0.000000]   #2 [0001000000 - 000165d9d4]    TEXT DATA BSS ==> [0001000000 - 000165d9d4]                                                                 
[    0.000000]   #3 [00376e5000 - 0037fef8a5]          RAMDISK ==> [00376e5000 - 0037fef8a5]                                                                 
[    0.000000]   #4 [000009fc00 - 0000100000]    BIOS reserved ==> [000009fc00 - 0000100000]                                                                 
[    0.000000]   #5 [000165e000 - 000165e290]              BRK ==> [000165e000 - 000165e290]                                                                 
[    0.000000]   #6 [0000010000 - 0000012000]          PGTABLE ==> [0000010000 - 0000012000]                                                                 
[    0.000000] found SMP MP-table at [ffff8800000ff780] ff780                                                                                                
[    0.000000]  [ffffea0000000000-ffffea0001bfffff] PMD -> [ffff880001c00000-ffff8800037fffff] on node 0                                                     
[    0.000000] Zone PFN ranges:                                                                                                                              
[    0.000000]   DMA      0x00000010 -> 0x00001000                                                                                                           
[    0.000000]   DMA32    0x00001000 -> 0x00100000                                                                                                           
[    0.000000]   Normal   0x00100000 -> 0x00100000                                                                                                           
[    0.000000] Movable zone start PFN for each node                                                                                                          
[    0.000000] early_node_map[2] active PFN ranges                                                                                                           
[    0.000000]     0: 0x00000010 -> 0x0000009f                                                                                                               
[    0.000000]     0: 0x00000100 -> 0x0007ff90                                                                                                               
[    0.000000] On node 0 totalpages: 524063                                                                                                                  
[    0.000000]   DMA zone: 56 pages used for memmap                                                                                                          
[    0.000000]   DMA zone: 101 pages reserved                                                                                                                
[    0.000000]   DMA zone: 3826 pages, LIFO batch:0                                                                                                          
[    0.000000]   DMA32 zone: 7111 pages used for memmap                                                                                                      
[    0.000000]   DMA32 zone: 512969 pages, LIFO batch:31                                                                                                     
[    0.000000] ACPI: PM-Timer IO Port: 0x808                                                                                                                 
[    0.000000] ACPI: Local APIC address 0xfee00000                                                                                                           
[    0.000000] ACPI: LAPIC (acpi_id[0x01] lapic_id[0x00] enabled)                                                                                            
[    0.000000] ACPI: LAPIC (acpi_id[0x02] lapic_id[0x01] enabled)                                                                                            
[    0.000000] ACPI: LAPIC (acpi_id[0x03] lapic_id[0x02] enabled)                                                                                            
[    0.000000] ACPI: LAPIC (acpi_id[0x04] lapic_id[0x83] disabled)                                                                                           
[    0.000000] ACPI: IOAPIC (id[0x03] address[0xfec00000] gsi_base[0])                                                                                       
[    0.000000] IOAPIC[0]: apic_id 3, version 33, address 0xfec00000, GSI 0-23                                                                                
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 0 global_irq 2 dfl dfl)                                                                                      
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 9 low level)                                                                                    
[    0.000000] ACPI: IRQ0 used by override.                                                                                                                  
[    0.000000] ACPI: IRQ2 used by override.                                                                                                                  
[    0.000000] ACPI: IRQ9 used by override.                                                                                                                  
[    0.000000] Using ACPI (MADT) for SMP configuration information                                                                                           
[    0.000000] ACPI: HPET id: 0x8300 base: 0xfed00000                                                                                                        
[    0.000000] SMP: Allowing 4 CPUs, 1 hotplug CPUs                                                                                                          
[    0.000000] nr_irqs_gsi: 24                                                                                                                               
[    0.000000] PM: Registered nosave memory: 000000000009f000 - 00000000000a0000                                                                             
[    0.000000] PM: Registered nosave memory: 00000000000a0000 - 00000000000e6000                                                                             
[    0.000000] PM: Registered nosave memory: 00000000000e6000 - 0000000000100000                                                                             
[    0.000000] Allocating PCI resources starting at 80000000 (gap: 80000000:7ff00000)                                                                        
[    0.000000] Booting paravirtualized kernel on bare hardware                                                                                               
[    0.000000] NR_CPUS:512 nr_cpumask_bits:512 nr_cpu_ids:4 nr_node_ids:1                                                                                    
[    0.000000] PERCPU: Embedded 29 pages/cpu @ffff880001800000 s89880 r8192 d20712 u524288                                                                   
[    0.000000] pcpu-alloc: s89880 r8192 d20712 u524288 alloc=1*2097152                                                                                       
[    0.000000] pcpu-alloc: [0] 0 1 2 3                                                                                                                       
[    0.000000] Built 1 zonelists in Node order, mobility grouping on.  Total pages: 516795                                                                   
[    0.000000] Policy zone: DMA32                                                                                                                            
[    0.000000] Kernel command line: BOOT_IMAGE=//vmlinuz-2.6.32-trunk-amd64 root=UUID=6bb1bace-a4ca-4fed-98b9-b6d64aca7cbe ro quiet                          
[    0.000000] PID hash table entries: 4096 (order: 3, 32768 bytes)                                                                                          
[    0.000000] Initializing CPU#0                                                                                                                            
[    0.000000] Checking aperture...                                                                                                                          
[    0.000000] No AGP bridge found                                                                                                                           
[    0.000000] Node 0: aperture @ 222000000 size 32 MB                                                                                                       
[    0.000000] Aperture beyond 4GB. Ignoring.                                                                                                                
[    0.000000] Memory: 2051016k/2096704k available (2981k kernel code, 452k absent, 45236k reserved, 1843k data, 576k init)                                  
[    0.000000] SLUB: Genslabs=14, HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1                                                                       
[    0.000000] Hierarchical RCU implementation.                                                                                                              
[    0.000000] NR_IRQS:4352 nr_irqs:440                                                                                                                      
[    0.000000] spurious 8259A interrupt: IRQ7.                                                                                                               
[    0.000000] Console: colour VGA+ 80x25                                                                                                                    
[    0.000000] console [tty0] enabled                                                                                                                        
[    0.000000] hpet clockevent registered                                                                                                                    
[    0.000000]   alloc irq_desc for 24 on node 0                                                                                                             
[    0.000000]   alloc kstat_irqs on node 0                                                                                                                  
[    0.000000] HPET: 4 timers in total, 1 timers will be used for per-cpu timer                                                                              
[    0.000000] Fast TSC calibration using PIT                                                                                                                
[    0.000000] Detected 2608.543 MHz processor.                                                                                                              
[    0.008004] Calibrating delay loop (skipped), value calculated using timer frequency.. 5217.07 BogoMIPS (lpj=10434156)                                    
[    0.008021] Security Framework initialized                                                                                                                
[    0.008025] SELinux:  Disabled at boot.                                                                                                                   
[    0.008144] Dentry cache hash table entries: 262144 (order: 9, 2097152 bytes)                                                                             
[    0.008760] Inode-cache hash table entries: 131072 (order: 8, 1048576 bytes)                                                                              
[    0.009043] Mount-cache hash table entries: 256                                                                                                           
[    0.009137] Initializing cgroup subsys ns                                                                                                                 
[    0.009140] Initializing cgroup subsys cpuacct                                                                                                            
[    0.009143] Initializing cgroup subsys devices                                                                                                            
[    0.009145] Initializing cgroup subsys freezer                                                                                                            
[    0.009146] Initializing cgroup subsys net_cls                                                                                                            
[    0.009160] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)                                                                             
[    0.009162] CPU: L2 Cache: 512K (64 bytes/line)                                                                                                           
[    0.009164] CPU 0/0x0 -> Node 0                                                                                                                           
[    0.009166] tseg: 0000000000                                                                                                                              
[    0.009175] CPU: Physical Processor ID: 0                                                                                                                 
[    0.009176] CPU: Processor Core ID: 0                                                                                                                     
[    0.009178] mce: CPU supports 6 MCE banks                                                                                                                 
[    0.009185] using C1E aware idle routine                                                                                                                  
[    0.009187] Performance Events: AMD PMU driver.                                                                                                           
[    0.009190] ... version:                0                                                                                                                 
[    0.009191] ... bit width:              48                                                                                                                
[    0.009193] ... generic registers:      4                                                                                                                 
[    0.009194] ... value mask:             0000ffffffffffff                                                                                                  
[    0.009195] ... max period:             00007fffffffffff                                                                                                  
[    0.009197] ... fixed-purpose events:   0                                                                                                                 
[    0.009198] ... event mask:             000000000000000f                                                                                                  
[    0.009771] ACPI: Core revision 20090903                                                                                                                  
[    0.028045] Setting APIC routing to flat                                                                                                                  
[    0.032263] ..TIMER: vector=0x30 apic1=0 pin1=2 apic2=-1 pin2=-1                                                                                          
[    0.071946] CPU0: AMD Phenom(tm) II X3 710 Processor stepping 02                                                                                          
[    0.072001] Booting processor 1 APIC 0x1 ip 0x6000                                                                                                        
[    0.012000] Initializing CPU#1                                                                                                                            
[    0.012000] Calibrating delay using timer specific routine.. 5217.59 BogoMIPS (lpj=10435193)                                                              
[    0.012000] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)                                                                             
[    0.012000] CPU: L2 Cache: 512K (64 bytes/line)                                                                                                           
[    0.012000] CPU 1/0x1 -> Node 0                                                                                                                           
[    0.012000] CPU: Physical Processor ID: 0                                                                                                                 
[    0.012000] CPU: Processor Core ID: 1                                                                                                                     
[    0.156077] CPU1: AMD Phenom(tm) II X3 710 Processor stepping 02                                                                                          
[    0.156083] checking TSC synchronization [CPU#0 -> CPU#1]: passed.                                                                                        
[    0.160044] Booting processor 2 APIC 0x2 ip 0x6000                                                                                                        
[    0.012000] Initializing CPU#2                                                                                                                            
[    0.012000] Calibrating delay using timer specific routine.. 5217.58 BogoMIPS (lpj=10435166)                                                              
[    0.012000] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)                                                                             
[    0.012000] CPU: L2 Cache: 512K (64 bytes/line)                                                                                                           
[    0.012000] CPU 2/0x2 -> Node 0                                                                                                                           
[    0.012000] CPU: Physical Processor ID: 0                                                                                                                 
[    0.012000] CPU: Processor Core ID: 2                                                                                                                     
[    0.248082] CPU2: AMD Phenom(tm) II X3 710 Processor stepping 02                                                                                          
[    0.248087] checking TSC synchronization [CPU#0 -> CPU#2]: passed.                                                                                        
[    0.252015] Brought up 3 CPUs                                                                                                                             
[    0.252017] Total of 3 processors activated (15652.25 BogoMIPS).                                                                                          
[    0.253230] CPU0 attaching sched-domain:                                                                                                                  
[    0.253232]  domain 0: span 0-2 level MC                                                                                                                  
[    0.253234]   groups: 0 1 2                                                                                                                               
[    0.253239] CPU1 attaching sched-domain:                                                                                                                  
[    0.253240]  domain 0: span 0-2 level MC                                                                                                                  
[    0.253242]   groups: 1 2 0                                                                                                                               
[    0.253245] CPU2 attaching sched-domain:                                                                                                                  
[    0.253247]  domain 0: span 0-2 level MC                                                                                                                  
[    0.253248]   groups: 2 0 1                                                                                                                               
[    0.253361] devtmpfs: initialized                                                                                                                         
[    0.256356] regulator: core version 0.5                                                                                                                   
[    0.256390] NET: Registered protocol family 16                                                                                                            
[    0.256450] node 0 link 0: io port [1000, ffffff]                                                                                                         
[    0.256452] TOM: 0000000080000000 aka 2048M                                                                                                               
[    0.256454] Fam 10h mmconf [e0000000, efffffff]                                                                                                           
[    0.256456] node 0 link 0: mmio [a0000, bffff]                                                                                                            
[    0.256458] node 0 link 0: mmio [80000000, dfffffff]                                                                                                      
[    0.256460] node 0 link 0: mmio [e0000000, efffffff] ==> none                                                                                             
[    0.256462] node 0 link 0: mmio [f0000000, fbafffff]                                                                                                      
[    0.256464] node 0 link 0: mmio [fbb00000, fbcfffff]                                                                                                      
[    0.256466] node 0 link 0: mmio [fbd00000, ffefffff]                                                                                                      
[    0.256468] bus: [00,07] on node 0 link 0                                                                                                                 
[    0.256470] bus: 00 index 0 io port: [0, ffff]                                                                                                            
[    0.256471] bus: 00 index 1 mmio: [a0000, bffff]                                                                                                          
[    0.256473] bus: 00 index 2 mmio: [80000000, dfffffff]                                                                                                    
[    0.256475] bus: 00 index 3 mmio: [f0000000, fcffffffff]                                                                                                  
[    0.256482] ACPI: bus type pci registered                                                                                                                 
[    0.256526] PCI: MCFG configuration 0: base e0000000 segment 0 buses 0 - 255                                                                              
[    0.256529] PCI: Not using MMCONFIG.                                                                                                                      
[    0.256530] PCI: Using configuration type 1 for base access                                                                                               
[    0.256531] PCI: Using configuration type 1 for extended access                                                                                           
[    0.256573] mtrr: your CPUs had inconsistent fixed MTRR settings                                                                                          
[    0.256575] mtrr: probably your BIOS does not setup all CPUs.                                                                                             
[    0.256576] mtrr: corrected configuration.                                                                                                                
[    0.256801] bio: create slab <bio-0> at 0                                                                                                                 
[    0.257334] ACPI: EC: Look up EC in DSDT                                                                                                                  
[    0.259348] ACPI Error (psargs-0359): [ECEN] Namespace lookup failure, AE_NOT_FOUND                                                                       
[    0.259352] ACPI Error (psparse-0537): Method parse/execution failed [\] (Node ffffffff81640fc0), AE_NOT_FOUND                                            
[    0.259441] ACPI: Executed 3 blocks of module-level executable AML code                                                                                   
[    0.342725] ACPI: Interpreter enabled                                                                                                                     
[    0.342730] ACPI: (supports S0 S1 S3 S4 S5)                                                                                                               
[    0.342752] ACPI: Using IOAPIC for interrupt routing                                                                                                      
[    0.342804] PCI: MCFG configuration 0: base e0000000 segment 0 buses 0 - 255                                                                              
[    0.346969] PCI: MCFG area at e0000000 reserved in ACPI motherboard resources                                                                             
[    0.350151] PCI: Using MMCONFIG at e0000000 - efffffff                                                                                                    
[    0.356940] ACPI Warning: Incorrect checksum in table [OEMB] - 22, should be 19 (20090903/tbutils-314)                                                    
[    0.357036] ACPI: No dock devices found.                                                                                                                  
[    0.357181] ACPI: PCI Root Bridge [PCI0] (0000:00)                                                                                                        
[    0.357285] pci 0000:00:06.0: PME# supported from D0 D3hot D3cold                                                                                         
[    0.357288] pci 0000:00:06.0: PME# disabled                                                                                                               
[    0.357315] pci 0000:00:07.0: PME# supported from D0 D3hot D3cold                                                                                         
[    0.357318] pci 0000:00:07.0: PME# disabled                                                                                                               
[    0.357359] pci 0000:00:11.0: reg 10 io port: [0xa000-0xa007]                                                                                             
[    0.357366] pci 0000:00:11.0: reg 14 io port: [0x9000-0x9003]                                                                                             
[    0.357372] pci 0000:00:11.0: reg 18 io port: [0x8000-0x8007]                                                                                             
[    0.357378] pci 0000:00:11.0: reg 1c io port: [0x7000-0x7003]                                                                                             
[    0.357384] pci 0000:00:11.0: reg 20 io port: [0x6000-0x600f]                                                                                             
[    0.357391] pci 0000:00:11.0: reg 24 32bit mmio: [0xfbaffc00-0xfbafffff]                                                                                  
[    0.357432] pci 0000:00:12.0: reg 10 32bit mmio: [0xfbafd000-0xfbafdfff]                                                                                  
[    0.357481] pci 0000:00:12.1: reg 10 32bit mmio: [0xfbafe000-0xfbafefff]                                                                                  
[    0.357547] pci 0000:00:12.2: reg 10 32bit mmio: [0xfbaff800-0xfbaff8ff]                                                                                  
[    0.357594] pci 0000:00:12.2: supports D1 D2                                                                                                              
[    0.357596] pci 0000:00:12.2: PME# supported from D0 D1 D2 D3hot                                                                                          
[    0.357599] pci 0000:00:12.2: PME# disabled                                                                                                               
[    0.357629] pci 0000:00:13.0: reg 10 32bit mmio: [0xfbafb000-0xfbafbfff]                                                                                  
[    0.357678] pci 0000:00:13.1: reg 10 32bit mmio: [0xfbafc000-0xfbafcfff]                                                                                  
[    0.357744] pci 0000:00:13.2: reg 10 32bit mmio: [0xfbaff400-0xfbaff4ff]                                                                                  
[    0.357791] pci 0000:00:13.2: supports D1 D2                                                                                                              
[    0.357792] pci 0000:00:13.2: PME# supported from D0 D1 D2 D3hot                                                                                          
[    0.357796] pci 0000:00:13.2: PME# disabled                                                                                                               
[    0.357901] pci 0000:00:14.1: reg 10 io port: [0x00-0x07]                                                                                                 
[    0.357907] pci 0000:00:14.1: reg 14 io port: [0x00-0x03]                                                                                                 
[    0.357913] pci 0000:00:14.1: reg 18 io port: [0x00-0x07]                                                                                                 
[    0.357919] pci 0000:00:14.1: reg 1c io port: [0x00-0x03]                                                                                                 
[    0.357925] pci 0000:00:14.1: reg 20 io port: [0xff00-0xff0f]                                                                                             
[    0.357984] pci 0000:00:14.2: reg 10 64bit mmio: [0xfbaf4000-0xfbaf7fff]                                                                                  
[    0.358023] pci 0000:00:14.2: PME# supported from D0 D3hot D3cold                                                                                         
[    0.358027] pci 0000:00:14.2: PME# disabled                                                                                                               
[    0.358122] pci 0000:00:14.5: reg 10 32bit mmio: [0xfbafa000-0xfbafafff]                                                                                  
[    0.358238] pci 0000:01:05.0: reg 10 32bit mmio pref: [0xd0000000-0xdfffffff]                                                                             
[    0.358242] pci 0000:01:05.0: reg 14 io port: [0xb000-0xb0ff]                                                                                             
[    0.358245] pci 0000:01:05.0: reg 18 32bit mmio: [0xfbce0000-0xfbceffff]                                                                                  
[    0.358251] pci 0000:01:05.0: reg 24 32bit mmio: [0xfbb00000-0xfbbfffff]                                                                                  
[    0.358260] pci 0000:01:05.0: supports D1 D2                                                                                                              
[    0.358275] pci 0000:01:05.1: reg 10 32bit mmio: [0xfbcfc000-0xfbcfffff]                                                                                  
[    0.358290] pci 0000:01:05.1: supports D1 D2                                                                                                              
[    0.358326] pci 0000:00:01.0: bridge io port: [0xb000-0xbfff]                                                                                             
[    0.358329] pci 0000:00:01.0: bridge 32bit mmio: [0xfbb00000-0xfbcfffff]                                                                                  
[    0.358332] pci 0000:00:01.0: bridge 64bit mmio pref: [0xd0000000-0xdfffffff]                                                                             
[    0.358375] pci 0000:02:00.0: reg 10 64bit mmio: [0xfbdc0000-0xfbdfffff]                                                                                  
[    0.358381] pci 0000:02:00.0: reg 18 io port: [0xcc00-0xcc7f]                                                                                             
[    0.358429] pci 0000:02:00.0: PME# supported from D3hot D3cold                                                                                            
[    0.358433] pci 0000:02:00.0: PME# disabled                                                                                                               
[    0.358484] pci 0000:00:06.0: bridge io port: [0xc000-0xcfff]                                                                                             
[    0.358487] pci 0000:00:06.0: bridge 32bit mmio: [0xfbd00000-0xfbdfffff]                                                                                  
[    0.358550] pci 0000:03:00.0: reg 10 64bit mmio: [0xfbeff800-0xfbefffff]                                                                                  
[    0.358560] pci 0000:03:00.0: reg 18 io port: [0xd800-0xd8ff]                                                                                             
[    0.358633] pci 0000:03:00.0: supports D2                                                                                                                 
[    0.358634] pci 0000:03:00.0: PME# supported from D2 D3hot D3cold                                                                                         
[    0.358640] pci 0000:03:00.0: PME# disabled                                                                                                               
[    0.358700] pci 0000:00:07.0: bridge io port: [0xd000-0xdfff]                                                                                             
[    0.358702] pci 0000:00:07.0: bridge 32bit mmio: [0xfbe00000-0xfbefffff]                                                                                  
[    0.358771] pci 0000:04:05.0: reg 20 io port: [0xe880-0xe89f]                                                                                             
[    0.358804] pci 0000:04:05.0: supports D1 D2                                                                                                              
[    0.358806] pci 0000:04:05.0: PME# supported from D0 D1 D2 D3hot                                                                                          
[    0.358810] pci 0000:04:05.0: PME# disabled                                                                                                               
[    0.358871] pci 0000:04:05.1: reg 20 io port: [0xec00-0xec1f]                                                                                             
[    0.358904] pci 0000:04:05.1: supports D1 D2                                                                                                              
[    0.358906] pci 0000:04:05.1: PME# supported from D0 D1 D2 D3hot                                                                                          
[    0.358910] pci 0000:04:05.1: PME# disabled                                                                                                               
[    0.358949] pci 0000:04:05.2: reg 10 32bit mmio: [0xfbfffc00-0xfbfffcff]                                                                                  
[    0.359004] pci 0000:04:05.2: supports D1 D2                                                                                                              
[    0.359006] pci 0000:04:05.2: PME# supported from D0 D1 D2 D3hot                                                                                          
[    0.359010] pci 0000:04:05.2: PME# disabled                                                                                                               
[    0.359043] pci 0000:04:06.0: reg 10 32bit mmio: [0xfbffc000-0xfbffdfff]                                                                                  
[    0.359124] pci 0000:00:14.4: transparent bridge                                                                                                          
[    0.359128] pci 0000:00:14.4: bridge io port: [0xe000-0xefff]                                                                                             
[    0.359132] pci 0000:00:14.4: bridge 32bit mmio: [0xfbf00000-0xfbffffff]                                                                                  
[    0.359148] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]                                                                                           
[    0.359344] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.P0P1._PRT]                                                                                      
[    0.359411] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCE6._PRT]                                                                                      
[    0.359463] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCE7._PRT]                                                                                      
[    0.359538] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.P0PC._PRT]                                                                                      
[    0.363947] ACPI: PCI Interrupt Link [LNKA] (IRQs 4 *7 10 11 12 14 15)                                                                                    
[    0.364066] ACPI: PCI Interrupt Link [LNKB] (IRQs 4 7 *10 11 12 14 15)                                                                                    
[    0.364177] ACPI: PCI Interrupt Link [LNKC] (IRQs 4 7 *10 11 12 14 15)                                                                                    
[    0.364285] ACPI: PCI Interrupt Link [LNKD] (IRQs 4 7 10 *11 12 14 15)                                                                                    
[    0.364393] ACPI: PCI Interrupt Link [LNKE] (IRQs 4 7 *10 11 12 14 15)                                                                                    
[    0.364501] ACPI: PCI Interrupt Link [LNKF] (IRQs 4 7 *10 11 12 14 15)                                                                                    
[    0.364608] ACPI: PCI Interrupt Link [LNKG] (IRQs 4 7 10 *11 12 14 15)                                                                                    
[    0.364716] ACPI: PCI Interrupt Link [LNKH] (IRQs 4 7 10 11 12 14 15) *0, disabled.                                                                       
[    0.364793] vgaarb: device added: PCI:0000:01:05.0,decodes=io+mem,owns=io+mem,locks=none                                                                  
[    0.364797] vgaarb: loaded                                                                                                                                
[    0.364839] PCI: Using ACPI for IRQ routing                                                                                                               
[    0.364990] hpet0: at MMIO 0xfed00000, IRQs 2, 8, 24, 0                                                                                                   
[    0.364994] hpet0: 4 comparators, 32-bit 14.318180 MHz counter                                                                                            
[    0.368022] hpet: hpet2 irq 24 for MSI                                                                                                                    
[    0.368042] Switching to clocksource tsc                                                                                                                  
[    0.368700] pnp: PnP ACPI init                                                                                                                            
[    0.368708] ACPI: bus type pnp registered                                                                                                                 
[    0.372391] pnp: PnP ACPI: found 14 devices                                                                                                               
[    0.372392] ACPI: ACPI bus type pnp unregistered                                                                                                          
[    0.372402] system 00:07: iomem range 0xfec00000-0xfec00fff could not be reserved                                                                         
[    0.372405] system 00:07: iomem range 0xfee00000-0xfee00fff has been reserved                                                                             
[    0.372409] system 00:08: ioport range 0x4d0-0x4d1 has been reserved                                                                                      
[    0.372411] system 00:08: ioport range 0x40b-0x40b has been reserved                                                                                      
[    0.372414] system 00:08: ioport range 0x4d6-0x4d6 has been reserved                                                                                      
[    0.372416] system 00:08: ioport range 0xc00-0xc01 has been reserved                                                                                      
[    0.372418] system 00:08: ioport range 0xc14-0xc14 has been reserved                                                                                      
[    0.372420] system 00:08: ioport range 0xc50-0xc51 has been reserved                                                                                      
[    0.372422] system 00:08: ioport range 0xc52-0xc52 has been reserved                                                                                      
[    0.372425] system 00:08: ioport range 0xc6c-0xc6c has been reserved                                                                                      
[    0.372427] system 00:08: ioport range 0xc6f-0xc6f has been reserved                                                                                      
[    0.372429] system 00:08: ioport range 0xcd0-0xcd1 has been reserved                                                                                      
[    0.372432] system 00:08: ioport range 0xcd2-0xcd3 has been reserved                                                                                      
[    0.372434] system 00:08: ioport range 0xcd4-0xcd5 has been reserved                                                                                      
[    0.372436] system 00:08: ioport range 0xcd6-0xcd7 has been reserved                                                                                      
[    0.372438] system 00:08: ioport range 0xcd8-0xcdf has been reserved                                                                                      
[    0.372440] system 00:08: ioport range 0xb00-0xb3f has been reserved                                                                                      
[    0.372442] system 00:08: ioport range 0x800-0x89f has been reserved                                                                                      
[    0.372444] system 00:08: ioport range 0xb00-0xb0f has been reserved                                                                                      
[    0.372446] system 00:08: ioport range 0xb20-0xb3f has been reserved                                                                                      
[    0.372448] system 00:08: ioport range 0x900-0x90f has been reserved                                                                                      
[    0.372451] system 00:08: ioport range 0x910-0x91f has been reserved                                                                                      
[    0.372453] system 00:08: ioport range 0xfe00-0xfefe has been reserved                                                                                    
[    0.372456] system 00:08: iomem range 0xffb80000-0xffbfffff has been reserved                                                                             
[    0.372458] system 00:08: iomem range 0xfec10000-0xfec1001f has been reserved                                                                             
[    0.372462] system 00:0b: ioport range 0x230-0x23f has been reserved                                                                                      
[    0.372464] system 00:0b: ioport range 0x290-0x29f has been reserved                                                                                      
[    0.372466] system 00:0b: ioport range 0xf40-0xf4f has been reserved                                                                                      
[    0.372468] system 00:0b: ioport range 0xa30-0xa3f has been reserved                                                                                      
[    0.372473] system 00:0c: iomem range 0xe0000000-0xefffffff has been reserved                                                                             
[    0.372477] system 00:0d: iomem range 0x0-0x9ffff could not be reserved                                                                                   
[    0.372479] system 00:0d: iomem range 0xc0000-0xcffff has been reserved                                                                                   
[    0.372481] system 00:0d: iomem range 0xe0000-0xfffff could not be reserved                                                                               
[    0.372483] system 00:0d: iomem range 0x100000-0x7fffffff could not be reserved                                                                           
[    0.372485] system 00:0d: iomem range 0xfec00000-0xffffffff could not be reserved                                                                         
[    0.377137] pci 0000:00:01.0: PCI bridge, secondary bus 0000:01                                                                                           
[    0.377139] pci 0000:00:01.0:   IO window: 0xb000-0xbfff                                                                                                  
[    0.377142] pci 0000:00:01.0:   MEM window: 0xfbb00000-0xfbcfffff                                                                                         
[    0.377145] pci 0000:00:01.0:   PREFETCH window: 0x000000d0000000-0x000000dfffffff                                                                        
[    0.377148] pci 0000:00:06.0: PCI bridge, secondary bus 0000:02                                                                                           
[    0.377150] pci 0000:00:06.0:   IO window: 0xc000-0xcfff                                                                                                  
[    0.377153] pci 0000:00:06.0:   MEM window: 0xfbd00000-0xfbdfffff                                                                                         
[    0.377155] pci 0000:00:06.0:   PREFETCH window: disabled                                                                                                 
[    0.377157] pci 0000:00:07.0: PCI bridge, secondary bus 0000:03                                                                                           
[    0.377159] pci 0000:00:07.0:   IO window: 0xd000-0xdfff                                                                                                  
[    0.377162] pci 0000:00:07.0:   MEM window: 0xfbe00000-0xfbefffff                                                                                         
[    0.377164] pci 0000:00:07.0:   PREFETCH window: disabled                                                                                                 
[    0.377167] pci 0000:00:14.4: PCI bridge, secondary bus 0000:04                                                                                           
[    0.377169] pci 0000:00:14.4:   IO window: 0xe000-0xefff                                                                                                  
[    0.377174] pci 0000:00:14.4:   MEM window: 0xfbf00000-0xfbffffff                                                                                         
[    0.377177] pci 0000:00:14.4:   PREFETCH window: disabled                                                                                                 
[    0.377187]   alloc irq_desc for 18 on node 0                                                                                                             
[    0.377188]   alloc kstat_irqs on node 0                                                                                                                  
[    0.377192] pci 0000:00:06.0: PCI INT A -> GSI 18 (level, low) -> IRQ 18                                                                                  
[    0.377195] pci 0000:00:06.0: setting latency timer to 64                                                                                                 
[    0.377199]   alloc irq_desc for 19 on node 0                                                                                                             
[    0.377200]   alloc kstat_irqs on node 0                                                                                                                  
[    0.377203] pci 0000:00:07.0: PCI INT A -> GSI 19 (level, low) -> IRQ 19                                                                                  
[    0.377205] pci 0000:00:07.0: setting latency timer to 64                                                                                                 
[    0.377211] pci_bus 0000:00: resource 0 io:  [0x00-0xffff]                                                                                                
[    0.377213] pci_bus 0000:00: resource 1 mem: [0x000000-0xffffffffffffffff]                                                                                
[    0.377215] pci_bus 0000:01: resource 0 io:  [0xb000-0xbfff]                                                                                              
[    0.377217] pci_bus 0000:01: resource 1 mem: [0xfbb00000-0xfbcfffff]                                                                                      
[    0.377219] pci_bus 0000:01: resource 2 pref mem [0xd0000000-0xdfffffff]                                                                                  
[    0.377221] pci_bus 0000:02: resource 0 io:  [0xc000-0xcfff]                                                                                              
[    0.377223] pci_bus 0000:02: resource 1 mem: [0xfbd00000-0xfbdfffff]                                                                                      
[    0.377225] pci_bus 0000:03: resource 0 io:  [0xd000-0xdfff]                                                                                              
[    0.377226] pci_bus 0000:03: resource 1 mem: [0xfbe00000-0xfbefffff]                                                                                      
[    0.377228] pci_bus 0000:04: resource 0 io:  [0xe000-0xefff]                                                                                              
[    0.377230] pci_bus 0000:04: resource 1 mem: [0xfbf00000-0xfbffffff]                                                                                      
[    0.377232] pci_bus 0000:04: resource 3 io:  [0x00-0xffff]                                                                                                
[    0.377234] pci_bus 0000:04: resource 4 mem: [0x000000-0xffffffffffffffff]                                                                                
[    0.377254] NET: Registered protocol family 2                                                                                                             
[    0.377339] IP route cache hash table entries: 65536 (order: 7, 524288 bytes)                                                                             
[    0.377816] TCP established hash table entries: 262144 (order: 10, 4194304 bytes)                                                                         
[    0.378866] TCP bind hash table entries: 65536 (order: 8, 1048576 bytes)                                                                                  
[    0.379161] TCP: Hash tables configured (established 262144 bind 65536)                                                                                   
[    0.379163] TCP reno registered                                                                                                                           
[    0.379233] NET: Registered protocol family 1                                                                                                             
[    0.523914] pci 0000:01:05.0: Boot video device                                                                                                           
[    0.524004] Unpacking initramfs...                                                                                                                        
[    0.683111] Freeing initrd memory: 9258k freed                                                                                                            
[    0.685954] audit: initializing netlink socket (disabled)                                                                                                 
[    0.685964] type=2000 audit(1266736910.683:1): initialized                                                                                                
[    0.686125] HugeTLB registered 2 MB page size, pre-allocated 0 pages                                                                                      
[    0.687097] VFS: Disk quotas dquot_6.5.2                                                                                                                  
[    0.687135] Dquot-cache hash table entries: 512 (order 0, 4096 bytes)                                                                                     
[    0.687199] msgmni has been set to 4023                                                                                                                   
[    0.687337] alg: No test for stdrng (krng)                                                                                                                
[    0.687373] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 253)                                                                          
[    0.687375] io scheduler noop registered                                                                                                                  
[    0.687377] io scheduler anticipatory registered                                                                                                          
[    0.687378] io scheduler deadline registered                                                                                                              
[    0.687400] io scheduler cfq registered (default)                                                                                                         
[    0.687507]   alloc irq_desc for 25 on node 0                                                                                                             
[    0.687509]   alloc kstat_irqs on node 0                                                                                                                  
[    0.687516] pcieport 0000:00:06.0: irq 25 for MSI/MSI-X                                                                                                   
[    0.687520] pcieport 0000:00:06.0: setting latency timer to 64                                                                                            
[    0.687587]   alloc irq_desc for 26 on node 0                                                                                                             
[    0.687589]   alloc kstat_irqs on node 0                                                                                                                  
[    0.687592] pcieport 0000:00:07.0: irq 26 for MSI/MSI-X                                                                                                   
[    0.687596] pcieport 0000:00:07.0: setting latency timer to 64                                                                                            
[    0.688603] Serial: 8250/16550 driver, 4 ports, IRQ sharing enabled                                                                                       
[    0.688699] serial8250: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A                                                                                          
[    0.688954] 00:09: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A                                                                                               
[    0.689079] input: Macintosh mouse button emulation as /devices/virtual/input/input0                                                                      
[    0.689119] PNP: No PS/2 controller found. Probing ports directly.                                                                                        
[    0.689501] serio: i8042 KBD port at 0x60,0x64 irq 1                                                                                                      
[    0.689510] serio: i8042 AUX port at 0x60,0x64 irq 12                                                                                                     
[    0.689598] mice: PS/2 mouse device common for all mice                                                                                                   
[    0.689613] Driver 'rtc_cmos' needs updating - please use bus_type methods                                                                                
[    0.689633] rtc_cmos 00:03: RTC can wake from S4                                                                                                          
[    0.689660] rtc_cmos 00:03: rtc core: registered rtc_cmos as rtc0                                                                                         
[    0.689683] rtc0: alarms up to one month, y3k, 114 bytes nvram, hpet irqs                                                                                 
[    0.689692] cpuidle: using governor ladder                                                                                                                
[    0.689694] cpuidle: using governor menu                                                                                                                  
[    0.689697] No iBFT detected.                                                                                                                             
[    0.689926] TCP cubic registered                                                                                                                          
[    0.690001] NET: Registered protocol family 10                                                                                                            
[    0.690370] lo: Disabled Privacy Extensions                                                                                                               
[    0.690582] Mobile IPv6                                                                                                                                   
[    0.690584] NET: Registered protocol family 17                                                                                                            
[    0.690641] registered taskstats version 1                                                                                                                
[    0.690995] rtc_cmos 00:03: setting system clock to 2010-02-21 07:21:51 UTC (1266736911)                                                                  
[    0.691030] Freeing unused kernel memory: 576k freed                                                                                                      
[    0.691172] Write protecting the kernel read-only data: 4096k                                                                                             
[    0.779616] firewire_ohci 0000:03:00.0: PCI INT A -> GSI 19 (level, low) -> IRQ 19                                                                        
[    0.779624] firewire_ohci 0000:03:00.0: setting latency timer to 64                                                                                       
[    0.791750] SCSI subsystem initialized                                                                                                                    
[    0.798020] usbcore: registered new interface driver usbfs                                                                                                
[    0.798041] usbcore: registered new interface driver hub                                                                                                  
[    0.798163] usbcore: registered new device driver usb                                                                                                     
[    0.799202] ehci_hcd: USB 2.0 'Enhanced' Host Controller (EHCI) Driver                                                                                    
[    0.799295]   alloc irq_desc for 17 on node 0                                                                                                             
[    0.799297]   alloc kstat_irqs on node 0                                                                                                                  
[    0.799304] ehci_hcd 0000:00:12.2: PCI INT B -> GSI 17 (level, low) -> IRQ 17                                                                             
[    0.799321] ehci_hcd 0000:00:12.2: EHCI Host Controller                                                                                                   
[    0.799343] ehci_hcd 0000:00:12.2: new USB bus registered, assigned bus number 1                                                                          
[    0.799364] ehci_hcd 0000:00:12.2: applying AMD SB600/SB700 USB freeze workaround                                                                         
[    0.799376] ehci_hcd 0000:00:12.2: debug port 1                                                                                                           
[    0.799396] ehci_hcd 0000:00:12.2: irq 17, io mem 0xfbaff800                                                                                              
[    0.805432] Uniform Multi-Platform E-IDE driver                                                                                                           
[    0.807412] ATL1E 0000:02:00.0: PCI INT A -> GSI 18 (level, low) -> IRQ 18                                                                                
[    0.807421] ATL1E 0000:02:00.0: setting latency timer to 64                                                                                               
[    0.807919] ehci_hcd 0000:00:12.2: USB 2.0 started, EHCI 1.00                                                                                             
[    0.807936] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002                                                                                 
[    0.807939] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    0.807940] usb usb1: Product: EHCI Host Controller                                                                                                       
[    0.807942] usb usb1: Manufacturer: Linux 2.6.32-trunk-amd64 ehci_hcd                                                                                     
[    0.807943] usb usb1: SerialNumber: 0000:00:12.2                                                                                                          
[    0.808004] usb usb1: configuration #1 chosen from 1 choice                                                                                               
[    0.808027] hub 1-0:1.0: USB hub found                                                                                                                    
[    0.808032] hub 1-0:1.0: 6 ports detected                                                                                                                 
[    0.808141] input: Power Button as /devices/LNXSYSTM:00/LNXSYBUS:00/PNP0C0C:00/input/input1                                                               
[    0.808151] ACPI: Power Button [PWRB]                                                                                                                     
[    0.808202] input: Power Button as /devices/LNXSYSTM:00/LNXPWRBN:00/input/input2                                                                          
[    0.808204] ACPI: Power Button [PWRF]                                                                                                                     
[    0.808610] atiixp 0000:00:14.1: IDE controller (0x1002:0x439c rev 0x00)                                                                                  
[    0.808617]   alloc irq_desc for 16 on node 0                                                                                                             
[    0.808619]   alloc kstat_irqs on node 0                                                                                                                  
[    0.808624] ATIIXP_IDE 0000:00:14.1: PCI INT A -> GSI 16 (level, low) -> IRQ 16                                                                           
[    0.808637] atiixp 0000:00:14.1: not 100% native mode: will probe irqs later                                                                              
[    0.808642]     ide0: BM-DMA at 0xff00-0xff07                                                                                                             
[    0.808646] atiixp 0000:00:14.1: simplex device: DMA disabled                                                                                             
[    0.808648] ide1: DMA disabled                                                                                                                            
[    0.808649] Probing IDE interface ide0...                                                                                                                 
[    0.831666]   alloc irq_desc for 21 on node 0                                                                                                             
[    0.831668]   alloc kstat_irqs on node 0                                                                                                                  
[    0.831672] b43-pci-bridge 0000:04:06.0: PCI INT A -> GSI 21 (level, low) -> IRQ 21                                                                       
[    0.831738] FDC 0 is a post-1991 82077                                                                                                                    
[    0.831813] libata version 3.00 loaded.                                                                                                                   
[    0.855934] firewire_ohci: Added fw-ohci device 0000:03:00.0, OHCI version 1.10                                                                           
[    0.887982] ssb: Sonics Silicon Backplane found on PCI device 0000:04:06.0                                                                                
[    1.060319] hda: Hitachi HDT725025VLAT80, ATA DISK drive                                                                                                  
[    1.308077] firewire_core: created device fw0: GUID 001e8c0001d42516, S400                                                                                
[    1.900023] hdb: Optiarc DVD RW AD-7203A, ATAPI CD/DVD-ROM drive                                                                                          
[    1.900056] hda: host max PIO4 wanted PIO255(auto-tune) selected PIO4                                                                                     
[    1.900207] hda: UDMA/100 mode selected                                                                                                                   
[    1.900356] hdb: host max PIO4 wanted PIO255(auto-tune) selected PIO4                                                                                     
[    1.900620] hdb: UDMA/66 mode selected                                                                                                                    
[    1.900948] Probing IDE interface ide1...                                                                                                                 
[    1.903923] ide1: no devices on the port                                                                                                                  
[    1.903957] ide0 at 0x1f0-0x1f7,0x3f6 on irq 14                                                                                                           
[    1.931370] ide1 at 0x170-0x177,0x376 on irq 15                                                                                                           
[    1.931492] ehci_hcd 0000:00:13.2: PCI INT B -> GSI 19 (level, low) -> IRQ 19                                                                             
[    1.931505] ehci_hcd 0000:00:13.2: EHCI Host Controller                                                                                                   
[    1.931514] ehci_hcd 0000:00:13.2: new USB bus registered, assigned bus number 2                                                                          
[    1.931531] ehci_hcd 0000:00:13.2: applying AMD SB600/SB700 USB freeze workaround                                                                         
[    1.931543] ehci_hcd 0000:00:13.2: debug port 1                                                                                                           
[    1.931554] ehci_hcd 0000:00:13.2: irq 19, io mem 0xfbaff400                                                                                              
[    1.940024] ehci_hcd 0000:00:13.2: USB 2.0 started, EHCI 1.00                                                                                             
[    1.940040] usb usb2: New USB device found, idVendor=1d6b, idProduct=0002                                                                                 
[    1.940042] usb usb2: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    1.940044] usb usb2: Product: EHCI Host Controller                                                                                                       
[    1.940045] usb usb2: Manufacturer: Linux 2.6.32-trunk-amd64 ehci_hcd                                                                                     
[    1.940047] usb usb2: SerialNumber: 0000:00:13.2                                                                                                          
[    1.940106] usb usb2: configuration #1 chosen from 1 choice                                                                                               
[    1.940127] hub 2-0:1.0: USB hub found                                                                                                                    
[    1.940131] hub 2-0:1.0: 6 ports detected                                                                                                                 
[    1.940211] ahci 0000:00:11.0: version 3.0                                                                                                                
[    1.940218]   alloc irq_desc for 22 on node 0                                                                                                             
[    1.940220]   alloc kstat_irqs on node 0                                                                                                                  
[    1.940224] ahci 0000:00:11.0: PCI INT A -> GSI 22 (level, low) -> IRQ 22                                                                                 
[    1.940326] ahci 0000:00:11.0: AHCI 0001.0100 32 slots 6 ports 3 Gbps 0x3f impl SATA mode                                                                 
[    1.940329] ahci 0000:00:11.0: flags: 64bit ncq sntf ilck pm led clo pmp pio slum part ccc                                                                
[    1.940619] ehci_hcd 0000:04:05.2: PCI INT C -> GSI 22 (level, low) -> IRQ 22                                                                             
[    1.940631] ehci_hcd 0000:04:05.2: EHCI Host Controller                                                                                                   
[    1.940642] ehci_hcd 0000:04:05.2: new USB bus registered, assigned bus number 3                                                                          
[    1.940676] ehci_hcd 0000:04:05.2: irq 22, io mem 0xfbfffc00                                                                                              
[    1.940688] scsi0 : ahci                                                                                                                                  
[    1.940757] scsi1 : ahci                                                                                                                                  
[    1.940797] scsi2 : ahci                                                                                                                                  
[    1.940834] scsi3 : ahci                                                                                                                                  
[    1.940872] scsi4 : ahci                                                                                                                                  
[    1.940911] scsi5 : ahci                                                                                                                                  
[    1.940942] ata1: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbaffd00 irq 22                                                                          
[    1.940946] ata2: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbaffd80 irq 22                                                                          
[    1.940949] ata3: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbaffe00 irq 22                                                                          
[    1.940951] ata4: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbaffe80 irq 22                                                                          
[    1.940954] ata5: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbafff00 irq 22                                                                          
[    1.940957] ata6: SATA max UDMA/133 abar m1024 at 0xfbaffc00 port 0xfbafff80 irq 22                                                                          
[    1.952024] ehci_hcd 0000:04:05.2: USB 2.0 started, EHCI 1.00                                                                                             
[    1.952042] usb usb3: New USB device found, idVendor=1d6b, idProduct=0002                                                                                 
[    1.952044] usb usb3: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    1.952046] usb usb3: Product: EHCI Host Controller                                                                                                       
[    1.952047] usb usb3: Manufacturer: Linux 2.6.32-trunk-amd64 ehci_hcd                                                                                     
[    1.952049] usb usb3: SerialNumber: 0000:04:05.2                                                                                                          
[    1.952098] usb usb3: configuration #1 chosen from 1 choice                                                                                               
[    1.952116] hub 3-0:1.0: USB hub found                                                                                                                    
[    1.952121] hub 3-0:1.0: 4 ports detected                                                                                                                 
[    2.010721] ohci_hcd: USB 1.1 'Open' Host Controller (OHCI) Driver                                                                                        
[    2.010800] ohci_hcd 0000:00:12.0: PCI INT A -> GSI 16 (level, low) -> IRQ 16                                                                             
[    2.010814] ohci_hcd 0000:00:12.0: OHCI Host Controller                                                                                                   
[    2.010825] ohci_hcd 0000:00:12.0: new USB bus registered, assigned bus number 4                                                                          
[    2.010848] ohci_hcd 0000:00:12.0: irq 16, io mem 0xfbafd000                                                                                              
[    2.022571] uhci_hcd: USB Universal Host Controller Interface driver                                                                                      
[    2.022630]   alloc irq_desc for 20 on node 0                                                                                                             
[    2.022633]   alloc kstat_irqs on node 0                                                                                                                  
[    2.022637] uhci_hcd 0000:04:05.0: PCI INT A -> GSI 20 (level, low) -> IRQ 20                                                                             
[    2.022645] uhci_hcd 0000:04:05.0: UHCI Host Controller                                                                                                   
[    2.022666] uhci_hcd 0000:04:05.0: new USB bus registered, assigned bus number 5                                                                          
[    2.022699] uhci_hcd 0000:04:05.0: irq 20, io base 0x0000e880                                                                                             
[    2.022730] usb usb5: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.022732] usb usb5: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.022733] usb usb5: Product: UHCI Host Controller                                                                                                       
[    2.022735] usb usb5: Manufacturer: Linux 2.6.32-trunk-amd64 uhci_hcd                                                                                     
[    2.022736] usb usb5: SerialNumber: 0000:04:05.0                                                                                                          
[    2.022787] usb usb5: configuration #1 chosen from 1 choice                                                                                               
[    2.022807] hub 5-0:1.0: USB hub found                                                                                                                    
[    2.022812] hub 5-0:1.0: 2 ports detected                                                                                                                 
[    2.022878] uhci_hcd 0000:04:05.1: PCI INT B -> GSI 21 (level, low) -> IRQ 21                                                                             
[    2.022884] uhci_hcd 0000:04:05.1: UHCI Host Controller                                                                                                   
[    2.022891] uhci_hcd 0000:04:05.1: new USB bus registered, assigned bus number 6                                                                          
[    2.022923] uhci_hcd 0000:04:05.1: irq 21, io base 0x0000ec00                                                                                             
[    2.022950] usb usb6: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.022952] usb usb6: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.022953] usb usb6: Product: UHCI Host Controller                                                                                                       
[    2.022955] usb usb6: Manufacturer: Linux 2.6.32-trunk-amd64 uhci_hcd                                                                                     
[    2.022956] usb usb6: SerialNumber: 0000:04:05.1                                                                                                          
[    2.022994] usb usb6: configuration #1 chosen from 1 choice                                                                                               
[    2.023013] hub 6-0:1.0: USB hub found                                                                                                                    
[    2.023017] hub 6-0:1.0: 2 ports detected                                                                                                                 
[    2.068018] usb usb4: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.068021] usb usb4: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.068023] usb usb4: Product: OHCI Host Controller                                                                                                       
[    2.068025] usb usb4: Manufacturer: Linux 2.6.32-trunk-amd64 ohci_hcd                                                                                     
[    2.068026] usb usb4: SerialNumber: 0000:00:12.0                                                                                                          
[    2.068081] usb usb4: configuration #1 chosen from 1 choice                                                                                               
[    2.068099] hub 4-0:1.0: USB hub found                                                                                                                    
[    2.068106] hub 4-0:1.0: 3 ports detected                                                                                                                 
[    2.068172] ohci_hcd 0000:00:12.1: PCI INT A -> GSI 16 (level, low) -> IRQ 16                                                                             
[    2.068185] ohci_hcd 0000:00:12.1: OHCI Host Controller                                                                                                   
[    2.068192] ohci_hcd 0000:00:12.1: new USB bus registered, assigned bus number 7                                                                          
[    2.068205] ohci_hcd 0000:00:12.1: irq 16, io mem 0xfbafe000                                                                                              
[    2.128085] usb usb7: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.128088] usb usb7: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.128089] usb usb7: Product: OHCI Host Controller                                                                                                       
[    2.128091] usb usb7: Manufacturer: Linux 2.6.32-trunk-amd64 ohci_hcd                                                                                     
[    2.128092] usb usb7: SerialNumber: 0000:00:12.1                                                                                                          
[    2.128146] usb usb7: configuration #1 chosen from 1 choice                                                                                               
[    2.128164] hub 7-0:1.0: USB hub found                                                                                                                    
[    2.128171] hub 7-0:1.0: 3 ports detected                                                                                                                 
[    2.128244] ohci_hcd 0000:00:13.0: PCI INT A -> GSI 18 (level, low) -> IRQ 18                                                                             
[    2.128256] ohci_hcd 0000:00:13.0: OHCI Host Controller                                                                                                   
[    2.128264] ohci_hcd 0000:00:13.0: new USB bus registered, assigned bus number 8                                                                          
[    2.128283] ohci_hcd 0000:00:13.0: irq 18, io mem 0xfbafb000                                                                                              
[    2.188032] usb usb8: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.188035] usb usb8: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.188037] usb usb8: Product: OHCI Host Controller                                                                                                       
[    2.188038] usb usb8: Manufacturer: Linux 2.6.32-trunk-amd64 ohci_hcd                                                                                     
[    2.188039] usb usb8: SerialNumber: 0000:00:13.0                                                                                                          
[    2.188099] usb usb8: configuration #1 chosen from 1 choice                                                                                               
[    2.188118] hub 8-0:1.0: USB hub found                                                                                                                    
[    2.188125] hub 8-0:1.0: 3 ports detected                                                                                                                 
[    2.188189] ohci_hcd 0000:00:13.1: PCI INT A -> GSI 18 (level, low) -> IRQ 18                                                                             
[    2.188201] ohci_hcd 0000:00:13.1: OHCI Host Controller                                                                                                   
[    2.188208] ohci_hcd 0000:00:13.1: new USB bus registered, assigned bus number 9                                                                          
[    2.188221] ohci_hcd 0000:00:13.1: irq 18, io mem 0xfbafc000                                                                                              
[    2.248031] usb usb9: New USB device found, idVendor=1d6b, idProduct=0001                                                                                 
[    2.248034] usb usb9: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                            
[    2.248036] usb usb9: Product: OHCI Host Controller                                                                                                       
[    2.248037] usb usb9: Manufacturer: Linux 2.6.32-trunk-amd64 ohci_hcd                                                                                     
[    2.248039] usb usb9: SerialNumber: 0000:00:13.1                                                                                                          
[    2.248093] usb usb9: configuration #1 chosen from 1 choice                                                                                               
[    2.248110] hub 9-0:1.0: USB hub found                                                                                                                    
[    2.248117] hub 9-0:1.0: 3 ports detected                                                                                                                 
[    2.248182] ohci_hcd 0000:00:14.5: PCI INT C -> GSI 18 (level, low) -> IRQ 18                                                                             
[    2.248194] ohci_hcd 0000:00:14.5: OHCI Host Controller                                                                                                   
[    2.248202] ohci_hcd 0000:00:14.5: new USB bus registered, assigned bus number 10                                                                         
[    2.248215] ohci_hcd 0000:00:14.5: irq 18, io mem 0xfbafa000                                                                                              
[    2.260040] ata2: SATA link down (SStatus 0 SControl 300)                                                                                                 
[    2.260067] ata6: SATA link down (SStatus 0 SControl 300)                                                                                                 
[    2.260110] ata5: SATA link down (SStatus 0 SControl 300)                                                                                                 
[    2.260133] ata1: SATA link down (SStatus 0 SControl 300)                                                                                                 
[    2.260157] ata3: SATA link down (SStatus 0 SControl 300)                                                                                                 
[    2.308020] usb usb10: New USB device found, idVendor=1d6b, idProduct=0001                                                                                
[    2.308022] usb usb10: New USB device strings: Mfr=3, Product=2, SerialNumber=1                                                                           
[    2.308024] usb usb10: Product: OHCI Host Controller                                                                                                      
[    2.308026] usb usb10: Manufacturer: Linux 2.6.32-trunk-amd64 ohci_hcd                                                                                    
[    2.308027] usb usb10: SerialNumber: 0000:00:14.5                                                                                                         
[    2.308079] usb usb10: configuration #1 chosen from 1 choice                                                                                              
[    2.308098] hub 10-0:1.0: USB hub found                                                                                                                   
[    2.308105] hub 10-0:1.0: 2 ports detected                                                                                                                
[    2.376028] usb 3-3: new high speed USB device using ehci_hcd and address 3                                                                               
[    2.424033] ata4: softreset failed (device not ready)                                                                                                     
[    2.424066] ata4: applying SB600 PMP SRST workaround and retrying                                                                                         
[    2.509856] usb 3-3: New USB device found, idVendor=04e8, idProduct=342e                                                                                  
[    2.509858] usb 3-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3                                                                             
[    2.509860] usb 3-3: Product: SCX-4300 Series                                                                                                             
[    2.509862] usb 3-3: Manufacturer: Samsung                                                                                                                
[    2.509863] usb 3-3: SerialNumber: 9N66BFGQ500068Y.                                                                                                       
[    2.509916] usb 3-3: configuration #1 chosen from 1 choice                                                                                                
[    2.588036] ata4: SATA link up 3.0 Gbps (SStatus 123 SControl 300)                                                                                        
[    2.589132] ata4.00: ATA-8: Hitachi HDT721075SLA360, ST4OA31B, max UDMA/133                                                                               
[    2.589135] ata4.00: 1465149168 sectors, multi 16: LBA48 NCQ (depth 31/32), AA                                                                            
[    2.590442] ata4.00: configured for UDMA/133                                                                                                              
[    2.604101] scsi 3:0:0:0: Direct-Access     ATA      Hitachi HDT72107 ST4O PQ: 0 ANSI: 5                                                                  
[    2.609927] sd 3:0:0:0: [sda] 1465149168 512-byte logical blocks: (750 GB/698 GiB)                                                                        
[    2.609954] sd 3:0:0:0: [sda] Write Protect is off                                                                                                        
[    2.609956] sd 3:0:0:0: [sda] Mode Sense: 00 3a 00 00                                                                                                     
[    2.609970] sd 3:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA                                                       
[    2.610048]  sda:                                                                                                                                         
[    2.611581] ide-gd driver 1.18                                                                                                                            
[    2.611605] hda: max request size: 512KiB                                                                                                                 
[    2.611771] hda: 488397168 sectors (250059 MB) w/7372KiB Cache, CHS=30401/255/63                                                                          
[    2.611921] hda: cache flushes supported                                                                                                                  
[    2.611950]  hda:                                                                                                                                         
[    2.613810] ide-cd driver 5.00                                                                                                                            
[    2.617026]  hda1 hda2                                                                                                                                    
[    2.617082]  sda1 sda2 sda3                                                                                                                               
[    2.618274] ide-cd: hdb: ATAPI 48X DVD-ROM DVD-R/RAM CD-R/RW drive, 2048kB Cache                                                                          
[    2.618279] Uniform CD-ROM driver Revision: 3.20                                                                                                          
[    2.627032] sd 3:0:0:0: [sda] Attached SCSI disk                                                                                                          
[    2.752026] usb 5-1: new full speed USB device using uhci_hcd and address 2                                                                               
[    2.903878] usb 5-1: New USB device found, idVendor=055f, idProduct=021e                                                                                  
[    2.903880] usb 5-1: New USB device strings: Mfr=0, Product=1, SerialNumber=0                                                                             
[    2.903883] usb 5-1: Product: USB Scanner                                                                                                                 
[    2.903947] usb 5-1: configuration #1 chosen from 1 choice                                                                                                
[    2.951970] device-mapper: uevent: version 1.0.3                                                                                                          
[    2.952090] device-mapper: ioctl: 4.15.0-ioctl (2009-04-01) initialised: dm-devel at redhat.com                                                              
[    2.956376] PM: Starting manual resume from disk                                                                                                          
[    2.960584] REISERFS (device sda3): found reiserfs format "3.6" with standard journal                                                                     
[    2.960596] REISERFS (device sda3): using ordered data mode                                                                                               
[    2.976021] REISERFS (device sda3): journal params: device sda3, size 8192, journal first block 18, max trans len 1024, max batch 900, max commit age 30, max trans age 30                                                                                                                                             
[    2.976450] REISERFS (device sda3): checking transaction log (sda3)                                                                                       
[    3.040029] usb 4-1: new low speed USB device using ohci_hcd and address 2                                                                                
[    3.225215] usb 4-1: New USB device found, idVendor=046e, idProduct=5503                                                                                  
[    3.225217] usb 4-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0                                                                             
[    3.225219] usb 4-1: Product: USB Multimedia Keyboard                                                                                                     
[    3.225221] usb 4-1: Manufacturer: BTC                                                                                                                    
[    3.225294] usb 4-1: configuration #1 chosen from 1 choice                                                                                                
[    3.242242] usbcore: registered new interface driver hiddev                                                                                               
[    3.253364] input: BTC USB Multimedia Keyboard as /devices/pci0000:00/0000:00:12.0/usb4/4-1/4-1:1.0/input/input3                                          
[    3.253396] generic-usb 0003:046E:5503.0001: input,hidraw0: USB HID v1.10 Keyboard [BTC USB Multimedia Keyboard] on usb-0000:00:12.0-1/input0             
[    3.286276] input: BTC USB Multimedia Keyboard as /devices/pci0000:00/0000:00:12.0/usb4/4-1/4-1:1.1/input/input4                                          
[    3.286333] generic-usb 0003:046E:5503.0002: input,hiddev96,hidraw1: USB HID v1.10 Device [BTC USB Multimedia Keyboard] on usb-0000:00:12.0-1/input1      
[    3.286349] usbcore: registered new interface driver usbhid                                                                                               
[    3.286351] usbhid: v2.6:USB HID core driver                                                                                                              
[    3.372033] usb 4-2: new low speed USB device using ohci_hcd and address 3                                                                                
[    3.544258] usb 4-2: New USB device found, idVendor=09da, idProduct=000a                                                                                  
[    3.544261] usb 4-2: New USB device strings: Mfr=1, Product=2, SerialNumber=0                                                                             
[    3.544263] usb 4-2: Product: PS/2+USB Mouse                                                                                                              
[    3.544264] usb 4-2: Manufacturer: A4Tech                                                                                                                 
[    3.544321] usb 4-2: configuration #1 chosen from 1 choice                                                                                                
[    3.555392] input: A4Tech PS/2+USB Mouse as /devices/pci0000:00/0000:00:12.0/usb4/4-2/4-2:1.0/input/input5                                                
[    3.555438] a4tech 0003:09DA:000A.0003: input,hidraw2: USB HID v1.10 Mouse [A4Tech PS/2+USB Mouse] on usb-0000:00:12.0-2/input0                           
[   11.560167] REISERFS (device sda3): replayed 513 transactions in 9 seconds                                                                                
[   11.560428] REISERFS (device sda3): Using r5 hash to sort names                                                                                           
[   13.738349] udev: starting version 150                                                                                                                    
[   15.032325] processor LNXCPU:00: registered as cooling_device0                                                                                            
[   15.032361] processor LNXCPU:01: registered as cooling_device1                                                                                            
[   15.032387] processor LNXCPU:02: registered as cooling_device2                                                                                            
[   15.999586] pci_hotplug: PCI Hot Plug PCI Core version: 0.5                                                                                               
[   16.001264] input: PC Speaker as /devices/platform/pcspkr/input/input6                                                                                    
[   16.357784] cfg80211: Using static regulatory domain info                                                                                                 
[   16.357786] cfg80211: Regulatory domain: US                                                                                                               
[   16.357788]  (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)                                                                            
[   16.357790]  (2402000 KHz - 2472000 KHz @ 40000 KHz), (600 mBi, 2700 mBm)                                                                                 
[   16.357792]  (5170000 KHz - 5190000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)                                                                                 
[   16.357794]  (5190000 KHz - 5210000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)                                                                                 
[   16.357796]  (5210000 KHz - 5230000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)                                                                                 
[   16.357798]  (5230000 KHz - 5330000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)                                                                                 
[   16.357800]  (5735000 KHz - 5835000 KHz @ 40000 KHz), (600 mBi, 3000 mBm)                                                                                 
[   16.357854] cfg80211: Calling CRDA for country: US                                                                                                        
[   16.373764] shpchp 0000:00:01.0: HPC vendor_id 1022 device_id 9602 ss_vid 0 ss_did 0                                                                      
[   16.373768] shpchp 0000:00:01.0: Cannot reserve MMIO region                                                                                               
[   16.373823] shpchp: Standard Hot Plug PCI Controller Driver version: 0.4                                                                                  
[   16.595676] EDAC MC: Ver: 2.1.0 Jan 10 2010                                                                                                               
[   16.610829] EDAC amd64_edac:  Ver: 3.2.0 Jan 10 2010                                                                                                      
[   16.610869] EDAC amd64: This node reports that Memory ECC is currently disabled, set F3x44[22] (0000:00:18.3).                                            
[   16.610875] EDAC amd64: WARNING: ECC is disabled by BIOS. Module will NOT be loaded.                                                                      
[   16.610876]  Either Enable ECC in the BIOS, or set 'ecc_enable_override'.                                                                                 
[   16.610877]  Also, use of the override can cause unknown side effects.                                                                                    
[   16.610885] amd64_edac: probe of 0000:00:18.2 failed with error -22                                                                                       
[   16.878865] usblp0: USB Bidirectional printer dev 3 if 1 alt 0 proto 2 vid 0x04E8 pid 0x342E                                                              
[   16.878882] usbcore: registered new interface driver usblp                                                                                                
[   16.885075] ACPI: I/O resource piix4_smbus [0xb00-0xb07] conflicts with ACPI region SOR1 [0xb00-0xb0f]                                                    
[   16.885112] ACPI: If an ACPI driver is available for this device, you should use it instead of the native driver                                          
[   17.243169] b43-phy0: Broadcom 4318 WLAN found (core revision 9)                                                                                          
[   17.245626] HDA Intel 0000:00:14.2: PCI INT A -> GSI 16 (level, low) -> IRQ 16                                                                            
[   17.305282] HDA Intel 0000:01:05.1: PCI INT B -> GSI 19 (level, low) -> IRQ 19                                                                            
[   17.305297] HDA Intel 0000:01:05.1: setting latency timer to 64                                                                                           
[   17.368101] phy0: Selected rate control algorithm 'minstrel'                                                                                              
[   17.368567] Registered led device: b43-phy0::tx                                                                                                           
[   17.368578] Registered led device: b43-phy0::rx                                                                                                           
[   17.368590] Registered led device: b43-phy0::assoc                                                                                                        
[   17.368609] Registered led device: b43-phy0::radio                                                                                                        
[   17.368641] Broadcom 43xx driver loaded [ Features: PMLS, Firmware-ID: FW13 ]                                                                             
[   18.704498] Adding 3903784k swap on /dev/sda2.  Priority:-1 extents:1 across:3903784k                                                                     
[   18.809005] REISERFS (device sda3): Removing [19 1057526 0x0 SD]..done                                                                                    
[   18.809049] REISERFS (device sda3): Removing [19 1057524 0x0 SD]..done                                                                                    
[   18.809244] REISERFS (device sda3): Removing [4 1056534 0x0 SD]..done                                                                                     
[   18.824661] REISERFS (device sda3): Removing [4 1056533 0x0 SD]..done                                                                                     
[   18.824755] REISERFS (device sda3): Removing [2690 819412 0x0 SD]..done                                                                                   
[   18.824773] REISERFS (device sda3): Removing [2690 819411 0x0 SD]..done                                                                                   
[   18.824789] REISERFS (device sda3): Removing [2690 819410 0x0 SD]..done                                                                                   
[   18.824805] REISERFS (device sda3): Removing [2690 819402 0x0 SD]..done                                                                                   
[   18.824821] REISERFS (device sda3): Removing [2690 819401 0x0 SD]..done                                                                                   
[   18.824837] REISERFS (device sda3): Removing [4 819129 0x0 SD]..done                                                                                      
[   18.825908] REISERFS (device sda3): Removing [4 819128 0x0 SD]..done                                                                                      
[   18.826001] REISERFS (device sda3): Removing [4 723561 0x0 SD]..done                                                                                      
[   18.832401] REISERFS (device sda3): Removing [4 723560 0x0 SD]..done                                                                                      
[   18.833591] REISERFS (device sda3): Removing [4 95108 0x0 SD]..done                                                                                       
[   18.834248] REISERFS (device sda3): Removing [4 95107 0x0 SD]..done                                                                                       
[   18.834354] REISERFS (device sda3): Removing [19 83405 0x0 SD]..done                                                                                      
[   18.834380] REISERFS (device sda3): Removing [98835 45468 0x0 SD]..done                                                                                   
[   18.850901] REISERFS (device sda3): There were 17 uncompleted unlinks/truncates. Completed                                                                
[   18.985744] loop: module loaded                                                                                                                           
[   19.112171] it87: Found IT8720F chip at 0x290, revision 2                                                                                                 
[   19.112183] it87: in3 is VCC (+5V)                                                                                                                        
[   19.112184] it87: in7 is VCCH (+5V Stand-By)                                                                                                              
[   19.112205] ACPI: I/O resource it87 [0x295-0x296] conflicts with ACPI region SIOE [0x290-0x2af]                                                           
[   19.112240] ACPI: If an ACPI driver is available for this device, you should use it instead of the native driver                                          
[   20.260992] fuse init (API version 7.13)                                                                                                                  
[   21.273738]   alloc irq_desc for 27 on node 0                                                                                                             
[   21.273740]   alloc kstat_irqs on node 0                                                                                                                  
[   21.273753] ATL1E 0000:02:00.0: irq 27 for MSI/MSI-X                                                                                                      
[   21.273889] ATL1E 0000:02:00.0: ATL1E: eth0 NIC Link is Up<100 Mbps Full Duplex>                                                                          
[   21.716049] b43 ssb0:0: firmware: requesting b43/ucode5.fw                                                                                                
[   21.843049] b43 ssb0:0: firmware: requesting b43/pcm5.fw                                                                                                  
[   22.090467] b43 ssb0:0: firmware: requesting b43/b0g0initvals5.fw                                                                                         
[   22.157513] b43 ssb0:0: firmware: requesting b43/b0g0bsinitvals5.fw                                                                                       
[   22.312035] b43-phy0: Loading firmware version 478.104 (2008-07-01 00:50:23)                                                                              
[   22.401592] wlan0: Trigger new scan to find an IBSS to join                                                                                               
[   24.256722] kvm: Nested Virtualization enabled                                                                                                            
[   24.256725] kvm: Nested Paging enabled                                                                                                                    
[   24.816028] wlan0: Trigger new scan to find an IBSS to join                                                                                               
[   28.820029] wlan0: Trigger new scan to find an IBSS to join                                                                                               
[   30.820033] wlan0: Creating new IBSS network, BSSID 0e:d3:45:41:76:8d                                                                                     
[   37.745495] lp: driver loaded but no devices found                                                                                                        
[   37.802841] ppdev: user-space parallel port driver                                                                                                        
[   41.564063] pci 0000:01:05.0: PCI INT A -> GSI 18 (level, low) -> IRQ 18                                                                                  
[   41.682817] lo: Disabled Privacy Extensions                                                                                                               
[   41.732930] Linux agpgart interface v0.103                                                                                                                
[   41.791292] [drm] Initialized drm 1.1.0 20060810                                                                                                          
[   41.933884] [drm] radeon defaulting to userspace modesetting.                                                                                             
[   41.934426] pci 0000:01:05.0: setting latency timer to 64                                                                                                 
[   41.934532] [drm] Initialized radeon 1.31.0 20080528 for 0000:01:05.0 on minor 0                                                                          
[   42.361229] [drm] Setting GART location based on new memory map                                                                                           
[   42.361393] [drm] Loading RS780 CP Microcode                                                                                                              
[   42.361445] platform r600_cp.0: firmware: requesting radeon/RS780_pfp.bin                                                                                 
[   42.532515] platform r600_cp.0: firmware: requesting radeon/RS780_me.bin                                                                                  
[   42.695009] [drm] Resetting GPU                                                                                                                           
[   42.695065] [drm] writeback test succeeded in 1 usecs                                                                                                     
[   46.553991] ip_tables: (C) 2000-2006 Netfilter Core Team                                                                                                  
[   46.605588] nf_conntrack version 0.5.0 (16384 buckets, 65536 max)                                                                                         
[   46.605740] CONFIG_NF_CT_ACCT is deprecated and will be removed soon. Please use                                                                          
[   46.605742] nf_conntrack.acct=1 kernel parameter, acct=1 nf_conntrack module option or                                                                    
[   46.605744] sysctl net.netfilter.nf_conntrack_acct=1 to enable it.                                                                                        
[   57.400450] CPU0 attaching NULL sched-domain.                                                                                                             
[   57.400453] CPU1 attaching NULL sched-domain.                                                                                                             
[   57.400455] CPU2 attaching NULL sched-domain.                                                                                                             
[   57.456065] CPU0 attaching sched-domain:                                                                                                                  
[   57.456068]  domain 0: span 0-2 level MC                                                                                                                  
[   57.456070]   groups: 0 1 2                                                                                                                               
[   57.456074] CPU1 attaching sched-domain:                                                                                                                  
[   57.456075]  domain 0: span 0-2 level MC                                                                                                                  
[   57.456077]   groups: 1 2 0                                                                                                                               
[   57.456081] CPU2 attaching sched-domain:                                                                                                                  
[   57.456082]  domain 0: span 0-2 level MC                                                                                                                  
[   57.456083]   groups: 2 0 1                                                                                                                               
[   70.210871] hda-intel: IRQ timing workaround is activated for card #1. Suggest a bigger bdl_pos_adj.

From william.bourque at polymtl.ca  Sun Feb 28 19:00:34 2010
From: william.bourque at polymtl.ca (William Bourque)
Date: Sun, 28 Feb 2010 13:00:34 -0500
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <20100228001655.4c9fd9ce@boulder.homenet>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>	<201002271620.31410.mb@bu3sch.de>
	<4B8942D5.5020502@lwfinger.net>	<201002271708.29817.mb@bu3sch.de>
	<4B894A61.1070302@lwfinger.net>	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>	<4B899DA3.4030100@lwfinger.net>	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
	<20100228001655.4c9fd9ce@boulder.homenet>
Message-ID: <4B8AAF42.8000602@polymtl.ca>



Chris Vine wrote:
> On Sun, 28 Feb 2010 00:44:58 +0100
> G?bor Stefanik <netrolller.3d at gmail.com> wrote:
>> 2010/2/28 Nathan Schulte <reklipz at gmail.com>:
>>> 2010/2/27 G?bor Stefanik <netrolller.3d at gmail.com>:
>>>> OK, I whipped up a quick test patch with changes found so far
>>>> implemented. Please test if this improves the situation.
>>> Where can I find this patch?
>>>
>>> -Nate
>>>
>> Oops... yes, I forgot it. Here it is!
> 
> This doesn't help on my netbook, I am afraid.
> 
I confirm, it still crashes on my notebook as well. However the new 
"fallback to PIO" behavior introduced earlier do a fine job getting it 
back on track.

Btw, you are often refering to some documentation that document the 
register for this device, where could I find it? I probably won't be 
able to do much, but I'm curious to see...

- William


From netrolller.3d at gmail.com  Sun Feb 28 19:10:04 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 19:10:04 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B8AAF42.8000602@polymtl.ca>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com> 
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com> 
	<20100228001655.4c9fd9ce@boulder.homenet> <4B8AAF42.8000602@polymtl.ca>
Message-ID: <69e28c911002281010y43bd7762sf8bbf7364427195a@mail.gmail.com>

On Sun, Feb 28, 2010 at 7:00 PM, William Bourque
<william.bourque at polymtl.ca> wrote:
> Chris Vine wrote:
>> This doesn't help on my netbook, I am afraid.
>>
> I confirm, it still crashes on my notebook as well. However the new
> "fallback to PIO" behavior introduced earlier do a fine job getting it back
> on track.
>
> Btw, you are often refering to some documentation that document the register
> for this device, where could I find it? I probably won't be able to do much,
> but I'm curious to see...
>
> - William

The documentation is available @ bcm-v4.sipsolutions.net - however,
this doesn't yet contain the SSB specs.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From netrolller.3d at gmail.com  Sun Feb 28 19:42:37 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 19:42:37 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B8AAF42.8000602@polymtl.ca>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com> 
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com> 
	<20100228001655.4c9fd9ce@boulder.homenet> <4B8AAF42.8000602@polymtl.ca>
Message-ID: <69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>

On Sun, Feb 28, 2010 at 7:00 PM, William Bourque
<william.bourque at polymtl.ca> wrote:
> I confirm, it still crashes on my notebook as well. However the new
> "fallback to PIO" behavior introduced earlier do a fine job getting it back
> on track.
>
> Btw, you are often refering to some documentation that document the register
> for this device, where could I find it? I probably won't be able to do much,
> but I'm curious to see...
>
> - William

Thanks!

New test patch attached.

Please CC linux-wireless at vger.kernel.org on further e-mails,
bcm43xx-dev appears to be having problems.

-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: lpphy-test.patch
Type: application/octet-stream
Size: 2991 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20100228/3eed3b73/attachment.obj>

From zajec5 at gmail.com  Sun Feb 28 19:47:42 2010
From: zajec5 at gmail.com (=?UTF-8?B?UmFmYcWCIE1pxYJlY2tp?=)
Date: Sun, 28 Feb 2010 19:47:42 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
	<20100228001655.4c9fd9ce@boulder.homenet>
	<4B8AAF42.8000602@polymtl.ca>
	<69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>
Message-ID: <b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>

2010/2/28 G?bor Stefanik <netrolller.3d at gmail.com>:
> On Sun, Feb 28, 2010 at 7:00 PM, William Bourque
> <william.bourque at polymtl.ca> wrote:
>> I confirm, it still crashes on my notebook as well. However the new
>> "fallback to PIO" behavior introduced earlier do a fine job getting it back
>> on track.
>>
>> Btw, you are often refering to some documentation that document the register
>> for this device, where could I find it? I probably won't be able to do much,
>> but I'm curious to see...
>>
> New test patch attached.

Patch adds this /incorrect/ ssb_write32 to 0x280a, right? By incorrect
I mean over range.

Would be nice to see if dumping tool generates same log about 0x280a
now (for wl and b43 patched).

-- 
Rafa?


From netrolller.3d at gmail.com  Sun Feb 28 19:52:53 2010
From: netrolller.3d at gmail.com (=?ISO-8859-1?Q?G=E1bor_Stefanik?=)
Date: Sun, 28 Feb 2010 19:52:53 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com> 
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com> 
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com> 
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com> 
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com> 
	<20100228001655.4c9fd9ce@boulder.homenet> <4B8AAF42.8000602@polymtl.ca>
	<69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com> 
	<b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>
Message-ID: <69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>

2010/2/28 Rafa? Mi?ecki <zajec5 at gmail.com>:
> 2010/2/28 G?bor Stefanik <netrolller.3d at gmail.com>:
>> On Sun, Feb 28, 2010 at 7:00 PM, William Bourque
>> <william.bourque at polymtl.ca> wrote:
>>> I confirm, it still crashes on my notebook as well. However the new
>>> "fallback to PIO" behavior introduced earlier do a fine job getting it back
>>> on track.
>>>
>>> Btw, you are often refering to some documentation that document the register
>>> for this device, where could I find it? I probably won't be able to do much,
>>> but I'm curious to see...
>>>
>> New test patch attached.
>
> Patch adds this /incorrect/ ssb_write32 to 0x280a, right? By incorrect
> I mean over range.
>
> Would be nice to see if dumping tool generates same log about 0x280a
> now (for wl and b43 patched).

I added both the "incorrect" 0x280a and the "correct" 0x80a here - it
is possible that the 0x280a one takes advantage of an undocumented
feature in PhoenixBIOS.

>
> --
> Rafa?
>



-- 
Vista: [V]iruses, [I]ntruders, [S]pyware, [T]rojans and [A]dware. :-)


From mb at bu3sch.de  Sun Feb 28 19:58:11 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Feb 2010 19:58:11 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>
	<69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>
Message-ID: <201002281958.12607.mb@bu3sch.de>

On Sunday 28 February 2010 19:52:53 G?bor Stefanik wrote:
> 2010/2/28 Rafa? Mi?ecki <zajec5 at gmail.com>:
> > 2010/2/28 G?bor Stefanik <netrolller.3d at gmail.com>:
> >> On Sun, Feb 28, 2010 at 7:00 PM, William Bourque
> >> <william.bourque at polymtl.ca> wrote:
> >>> I confirm, it still crashes on my notebook as well. However the new
> >>> "fallback to PIO" behavior introduced earlier do a fine job getting it back
> >>> on track.
> >>>
> >>> Btw, you are often refering to some documentation that document the register
> >>> for this device, where could I find it? I probably won't be able to do much,
> >>> but I'm curious to see...
> >>>
> >> New test patch attached.
> >
> > Patch adds this /incorrect/ ssb_write32 to 0x280a, right? By incorrect
> > I mean over range.
> >
> > Would be nice to see if dumping tool generates same log about 0x280a
> > now (for wl and b43 patched).
> 
> I added both the "incorrect" 0x280a and the "correct" 0x80a here - it
> is possible that the 0x280a one takes advantage of an undocumented
> feature in PhoenixBIOS.

Hell, it is pure luck that this does not blow up the whole machine.

Please check the memory region of your wireless card with lspci -vvnn:

0001:10:12.0 Network controller [0280]: Broadcom Corporation BCM4306 802.11b/g Wireless LAN Controller [14e4:4320] (rev 03)
        Subsystem: Apple Computer Inc. AirPort Extreme [106b:004e]
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
        Latency: 16
        Interrupt: pin A routed to IRQ 52
        Region 0: Memory at a0006000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: <access denied>
        Kernel driver in use: b43-pci-bridge
        Kernel modules: ssb

It says 8k for all of my devices there. So an MMIO write to 0x2000 and above
writes to completely random memory.

-- 
Greetings, Michael.


From william.bourque at polymtl.ca  Sun Feb 28 20:44:12 2010
From: william.bourque at polymtl.ca (William Bourque)
Date: Sun, 28 Feb 2010 14:44:12 -0500
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
	<20100228001655.4c9fd9ce@boulder.homenet>
	<4B8AAF42.8000602@polymtl.ca>
	<69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>
Message-ID: <4B8AC78C.80505@polymtl.ca>


> New test patch attached.
> 
> Please CC linux-wireless at vger.kernel.org on further e-mails,
> bcm43xx-dev appears to be having problems.
> 

Hmm... I don't know if it is only coincidence, but this one seems to 
help somehow.

The driver raised the DMA error again, but instead of being as soon as I 
brought up the interface, I had to stresstest (to transfert a file at 
full speed from my LAN) to make it happens. Before that I was able to 
DMA normally (loading web page ...).

- William


From chris at cvine.freeserve.co.uk  Sun Feb 28 21:03:11 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sun, 28 Feb 2010 20:03:11 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B8AC78C.80505@polymtl.ca>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002271708.29817.mb@bu3sch.de> <4B894A61.1070302@lwfinger.net>
	<69e28c911002271145s590df31en9d2f8b2c47932451@mail.gmail.com>
	<4B899DA3.4030100@lwfinger.net>
	<69e28c911002271534o8cab111vf7fcc1b93b6c4b47@mail.gmail.com>
	<a221c0101002271542o5d928e56n8a22602860aeb761@mail.gmail.com>
	<69e28c911002271544y62c93255k8a6dbb0adb2b5928@mail.gmail.com>
	<20100228001655.4c9fd9ce@boulder.homenet>
	<4B8AAF42.8000602@polymtl.ca>
	<69e28c911002281042g15808a2cm81bd9528a30d2f85@mail.gmail.com>
	<4B8AC78C.80505@polymtl.ca>
Message-ID: <20100228200311.4ca24d95@boulder.homenet>

On Sun, 28 Feb 2010 14:44:12 -0500
William Bourque <william.bourque at polymtl.ca> wrote:
> > New test patch attached.
> > 
> > Please CC linux-wireless at vger.kernel.org on further e-mails,
> > bcm43xx-dev appears to be having problems.
> > 
> 
> Hmm... I don't know if it is only coincidence, but this one seems to 
> help somehow.
> 
> The driver raised the DMA error again, but instead of being as soon
> as I brought up the interface, I had to stresstest (to transfert a
> file at full speed from my LAN) to make it happens. Before that I was
> able to DMA normally (loading web page ...).

I also found that it stayed up marginally longer (ie about 2 seconds
longer in my case) but I think this is probably co-incidence.

On commenting out the line setting the 0x280a memory location, and
leaving the line setting the 0x80a memory location, it failed
immediately; but these difference may just be random effects.

Chris




From chris at cvine.freeserve.co.uk  Sun Feb 28 21:30:38 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sun, 28 Feb 2010 20:30:38 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <201002281958.12607.mb@bu3sch.de>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>
	<69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>
	<201002281958.12607.mb@bu3sch.de>
Message-ID: <20100228203038.456b9016@boulder.homenet>

On Sun, 28 Feb 2010 19:58:11 +0100
Michael Buesch <mb at bu3sch.de> wrote:
> It says 8k for all of my devices there. So an MMIO write to 0x2000
> and above writes to completely random memory.
> 
My BCM4312 device is 16K:

  Region 0: Memory at f8000000 (64-bit, non-prefetchable) [size=16K]

Chris




From mb at bu3sch.de  Sun Feb 28 21:33:10 2010
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Feb 2010 21:33:10 +0100
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <20100228203038.456b9016@boulder.homenet>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<201002281958.12607.mb@bu3sch.de>
	<20100228203038.456b9016@boulder.homenet>
Message-ID: <201002282133.10981.mb@bu3sch.de>

On Sunday 28 February 2010 21:30:38 Chris Vine wrote:
> On Sun, 28 Feb 2010 19:58:11 +0100
> Michael Buesch <mb at bu3sch.de> wrote:
> > It says 8k for all of my devices there. So an MMIO write to 0x2000
> > and above writes to completely random memory.
> > 
> My BCM4312 device is 16K:
> 
>   Region 0: Memory at f8000000 (64-bit, non-prefetchable) [size=16K]

Ok, then this write is _clearly_ not to be done unconditionally.

-- 
Greetings, Michael.


From william.bourque at polymtl.ca  Sun Feb 28 21:51:14 2010
From: william.bourque at polymtl.ca (William Bourque)
Date: Sun, 28 Feb 2010 15:51:14 -0500
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <20100228203038.456b9016@boulder.homenet>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>	<b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>	<69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>	<201002281958.12607.mb@bu3sch.de>
	<20100228203038.456b9016@boulder.homenet>
Message-ID: <4B8AD742.9000201@polymtl.ca>

Chris Vine wrote:
> On Sun, 28 Feb 2010 19:58:11 +0100
> Michael Buesch <mb at bu3sch.de> wrote:
>> It says 8k for all of my devices there. So an MMIO write to 0x2000
>> and above writes to completely random memory.
>>
> My BCM4312 device is 16K:
> 
>   Region 0: Memory at f8000000 (64-bit, non-prefetchable) [size=16K]


Now that you mention it, mine as well :

01:00.0 Network controller: Broadcom Corporation BCM4312 802.11b/g (rev 01)
         Subsystem: Hewlett-Packard Company Device 1507
         Flags: bus master, fast devsel, latency 0, IRQ 16
         Memory at feafc000 (64-bit, non-prefetchable) [size=16K]

Are all the failing devices have a 16k mem space?

- William


From chris at cvine.freeserve.co.uk  Sun Feb 28 21:54:58 2010
From: chris at cvine.freeserve.co.uk (Chris Vine)
Date: Sun, 28 Feb 2010 20:54:58 +0000
Subject: LP-PHY Fatal DMA error 0x00000800 on non-ULV Core 2 Duo?!?!!??!
In-Reply-To: <4B8AD742.9000201@polymtl.ca>
References: <69e28c911002260708g45d3c0f7u6abf13b1babe549f@mail.gmail.com>
	<b170af451002281047s1cbb9168g61178c5bc06ad428@mail.gmail.com>
	<69e28c911002281052p417fcd42n74552ad3ac0106a2@mail.gmail.com>
	<201002281958.12607.mb@bu3sch.de>
	<20100228203038.456b9016@boulder.homenet>
	<4B8AD742.9000201@polymtl.ca>
Message-ID: <20100228205458.3e06dd35@boulder.homenet>

On Sun, 28 Feb 2010 15:51:14 -0500
William Bourque <william.bourque at polymtl.ca> wrote:
> Chris Vine wrote:
> > On Sun, 28 Feb 2010 19:58:11 +0100
> > Michael Buesch <mb at bu3sch.de> wrote:
> >> It says 8k for all of my devices there. So an MMIO write to 0x2000
> >> and above writes to completely random memory.
> >>
> > My BCM4312 device is 16K:
> > 
> >   Region 0: Memory at f8000000 (64-bit, non-prefetchable) [size=16K]
> 
> 
> Now that you mention it, mine as well :
> 
> 01:00.0 Network controller: Broadcom Corporation BCM4312 802.11b/g
> (rev 01) Subsystem: Hewlett-Packard Company Device 1507
>          Flags: bus master, fast devsel, latency 0, IRQ 16
>          Memory at feafc000 (64-bit, non-prefetchable) [size=16K]
> 
> Are all the failing devices have a 16k mem space?

And with 64-bit layout?  (Michael's was 32-bit.)

Chris




