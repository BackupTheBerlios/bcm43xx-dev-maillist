From st3 at riseup.net  Fri Jan 19 12:46:08 2007
From: st3 at riseup.net (Stefano Brivio)
Date: Fri, 19 Jan 2007 12:46:08 +0100
Subject: Problems with 4309 card under 2.6.16-rc2 w/
 bcm43xx-060217__forlinux2.6.16-rc2__.patch
In-Reply-To: <43F80B2E.30003@richardharman.com>
References: <43F80B2E.30003@richardharman.com>
Message-ID: <20070119124608.3d086d85@localhost>

On Sun, 19 Feb 2006 01:07:42 -0500
Richard Harman <bcm43xx at richardharman.com> wrote:

> I'm still having problems with my 4309 a/b/g card -- below is the output
> of dmesg when I loaded the kernel module in single user mode.

Did you try the patch I made for you some time ago? How did it go?


--
ciao
st3


From dan.pasanen at gmail.com  Tue Jan  2 07:21:01 2007
From: dan.pasanen at gmail.com (Dan Pasanen)
Date: Tue, 2 Jan 2007 00:21:01 -0600
Subject: bcm4311
Message-ID: <4f8d9c0c0701012221j1bcfae26tdd9cb8464cbd807d@mail.gmail.com>

im not too sure if anything has been done about this, but i have a broadcom
4311 (notice the subject :) ) but its actually a dell mini-pci 1390. im
using kernel 2.6.20-rc3...i have the bcm43xx built into my kernel, along
with softmac, and the whole shabang...when it gets loaded at boot, it says
this according to dmesg:

bcm43xx driver
ACPI: PCI Interrupt Link [LK2E] enabled at IRQ 19
ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19 (level, high)
-> IRQ $
PCI: Setting latency timer of device 0000:01:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off

later in dmesg it shows this:
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)


everytime i switch my card on or off it shows:
ACPI: EC: evaluationg _Q10
but the led for the wifi card doesnt change, its still orange (off)

ifconfig eth1 up gives me this:
SIOCSIFFLAGS: No such device

iwlist eth1 scan
eth1      No scan results

iwconfig

eth1   IEEE 802.11b/g  ESSID:"essid"  Nickname:"bcm4311"
          Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
          Bit Rate=1 Mb/s
          RTS thr:off   Fragment thr:off
          Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


i got my firmware from http://bu3sch.de/bcm43xx_fw.php and extracted with
bcm43xx-fwcutter and put them in /lib/firmware (used v3.x)

any help would be greatly apprecitated!
thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070102/a6a45e29/attachment.html>

From heise2k at gmail.com  Wed Jan  3 05:08:55 2007
From: heise2k at gmail.com (Bob Heise)
Date: Tue, 2 Jan 2007 23:08:55 -0500
Subject: >1GB Bug
Message-ID: <200701022308.55570.heise2k@gmail.com>

Hello,

I am using 2.6.19.1 + wireless-dev git kernel, bcm43xx driver with v.3 
firmware on an HP zv5000z amd64 with 2GB RAM.

lspci -n
02:02.0 Class 0280: 14e4:4320 (rev 03)

lspci -vv
02:02.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless 
LAN Controller (rev 03)
        Subsystem: Hewlett-Packard Company NX9500 Built-in Wireless
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
Stepping- SERR+ FastB2B-
        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- 
<TAbort- <MAbort- >SERR- <PERR-
        Latency: 64
        Interrupt: pin A routed to IRQ 17
        Region 0: Memory at e0104000 (32-bit, non-prefetchable) [size=8K]


This setup works if I limit the system RAM with mem=1024M on the boot prompt, 
but with all the RAM it let's me modprobe but if I try to set the essid or do 
a iwlist eth4 scanning etc., it deadlocks. I tried Larry's dma_over_1GB patch 
from 01 December 
<https://lists.berlios.de/pipermail/bcm43xx-dev/2006-December/003244.html>, 
but the system still hangs. I could not get netconsole to work, but attached 
is most of the dmesg + tail -f /var/messages which I captured via ssh. Also 
included is a picture of the kernel panic, which did not make it across ssh.

-Bob

-------------- next part --------------
[   13.628917]       soft-irq read-recursion/312:  ok  |
[   13.629552]       hard-irq read-recursion/321:  ok  |
[   13.630150]       soft-irq read-recursion/321:  ok  |
[   13.630800] -------------------------------------------------------
[   13.630813] Good, all 218 testcases passed! |
[   13.630825] ---------------------------------
[   13.633720] Dentry cache hash table entries: 262144 (order: 9, 2097152 bytes)
[   13.637274] Inode-cache hash table entries: 131072 (order: 8, 1048576 bytes)
[   13.637978] Checking aperture...
[   13.637996] CPU 0: aperture @ e8000000 size 128 MB
[   13.683197] Memory: 2049964k/2096576k available (1936k kernel code, 45824k reserved, 1472k data, 196k init)
[   13.762318] Calibrating delay using timer specific routine.. 1598.16 BogoMIPS (lpj=3196339)
[   13.762621] Security Framework v1.0.0 initialized
[   13.762939] Mount-cache hash table entries: 256
[   13.770262] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)
[   13.770281] CPU: L2 Cache: 1024K (64 bytes/line)
[   13.770358] CPU: AMD Athlon(tm) 64 Processor 3200+ stepping 08
[   13.770387] ACPI: Core revision 20060707
[   13.839790] Using local APIC timer interrupts.
[   13.965101] result 12467989
[   13.965113] Detected 12.467 MHz APIC timer.
[   13.966286] testing NMI watchdog ... OK.
[   14.008228] checking if image is initramfs... it is
[   15.181634] Freeing initrd memory: 6062k freed
[   15.191413] NET: Registered protocol family 16
[   15.193533] ACPI: bus type pci registered
[   15.193558] PCI: Using configuration type 1
[   15.202668] ACPI: Interpreter enabled
[   15.202686] ACPI: Using IOAPIC for interrupt routing
[   15.205042] ACPI: PCI Root Bridge [PCI0] (0000:00)
[   15.205407] PCI: Probing PCI hardware (bus 00)
[   15.237385] PCI: Bus #03 (-#06) is hidden behind  bridge #02 (-#02) (try 'pci=assign-busses')
[   15.237410] Please report the result to linux-kernel to fix this permanently
[   15.237629] PCI: Bus #07 (-#0a) is hidden behind  bridge #02 (-#02) (try 'pci=assign-busses')
[   15.237652] Please report the result to linux-kernel to fix this permanently
[   15.237959] Boot video device is 0000:01:00.0
[   15.238118] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
[   15.324202] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.P2P0._PRT]
[   15.324955] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.AGP0._PRT]
[   15.327362] ACPI: PCI Interrupt Link [LNK1] (IRQs 16 18 19) *0
[   15.328339] ACPI: PCI Interrupt Link [LNK2] (IRQs 16 18 19) *0
[   15.329307] ACPI: PCI Interrupt Link [LNK3] (IRQs 17) *0
[   15.330325] ACPI: PCI Interrupt Link [LNK4] (IRQs 16 18 19) *0, disabled.
[   15.331282] ACPI: PCI Interrupt Link [LNK5] (IRQs 16 18 19) *0
[   15.332235] ACPI: PCI Interrupt Link [LSMB] (IRQs 20 21 22) *0
[   15.333165] ACPI: PCI Interrupt Link [LUS0] (IRQs 20 21 22) *0
[   15.334106] ACPI: PCI Interrupt Link [LUS1] (IRQs 20 21 22) *0
[   15.335053] ACPI: PCI Interrupt Link [LUS2] (IRQs 20 21 22) *0
[   15.335995] ACPI: PCI Interrupt Link [LMAC] (IRQs 20 21 22) *0, disabled.
[   15.336927] ACPI: PCI Interrupt Link [LACI] (IRQs 20 21 22) *0
[   15.337891] ACPI: PCI Interrupt Link [LMCI] (IRQs 20 21 22) *0
[   15.338896] ACPI: PCI Interrupt Link [LPID] (IRQs 20 21 22) *0, disabled.
[   15.339859] ACPI: PCI Interrupt Link [LTID] (IRQs 20 21 22) *0, disabled.
[   15.340324] Linux Plug and Play Support v0.97 (c) Adam Belay
[   15.340406] pnp: PnP ACPI init
[   15.370373] pnp: PnP ACPI: found 12 devices
[   15.371160] PCI: Using ACPI for IRQ routing
[   15.371179] PCI: If a device doesn't work, try "pci=routeirq".  If it helps, post a report
[   15.371219] PCI: Cannot allocate resource region 0 of device 0000:00:00.0
[   15.372107] agpgart: Detected AGP bridge 0
[   15.372135] agpgart: Setting up Nforce3 AGP.
[   15.380699] agpgart: AGP aperture is 128M @ 0xe8000000
[   15.381058] PCI-DMA: Disabling IOMMU.
[   15.383218] pnp: 00:01: ioport range 0x8000-0x807f could not be reserved
[   15.383240] pnp: 00:01: ioport range 0x8080-0x80ff has been reserved
[   15.383257] pnp: 00:01: ioport range 0x8400-0x847f has been reserved
[   15.383274] pnp: 00:01: ioport range 0x8480-0x84ff could not be reserved
[   15.383290] pnp: 00:01: ioport range 0x8800-0x887f has been reserved
[   15.383306] pnp: 00:01: ioport range 0x8880-0x88ff has been reserved
[   15.383322] pnp: 00:01: ioport range 0x2040-0x207f has been reserved
[   15.383338] pnp: 00:01: ioport range 0x2000-0x203f has been reserved
[   15.384929] PCI: Failed to allocate mem resource #10:2000000 at e2000000 for 0000:02:04.0
[   15.384958] PCI: Failed to allocate mem resource #10:2000000 at e2000000 for 0000:02:04.1
[   15.384983] PCI: Bus 3, cardbus bridge: 0000:02:04.0
[   15.384997]   IO window: 00003000-000030ff
[   15.385014]   IO window: 00003400-000034ff
[   15.385033]   PREFETCH window: 88000000-89ffffff
[   15.385050] PCI: Bus 7, cardbus bridge: 0000:02:04.1
[   15.385063]   IO window: 00003800-000038ff
[   15.385080]   IO window: 00003c00-00003cff
[   15.385098]   PREFETCH window: 8a000000-8bffffff
[   15.385115] PCI: Bridge: 0000:00:0a.0
[   15.385129]   IO window: 3000-7fff
[   15.385148]   MEM window: e0100000-e17fffff
[   15.385166]   PREFETCH window: 88000000-8bffffff
[   15.385187] PCI: Bridge: 0000:00:0b.0
[   15.385198]   IO window: disabled.
[   15.385218]   MEM window: e2000000-e2ffffff
[   15.385237]   PREFETCH window: f0000000-f80fffff
[   15.385270] PCI: Setting latency timer of device 0000:00:0a.0 to 64
[   15.386262] ACPI: PCI Interrupt Link [LNK1] enabled at IRQ 19
[   15.386292] ACPI: PCI Interrupt 0000:02:04.0[A] -> Link [LNK1] -> GSI 19 (level, low) -> IRQ 19
[   15.387237] ACPI: PCI Interrupt Link [LNK2] enabled at IRQ 18
[   15.387262] ACPI: PCI Interrupt 0000:02:04.1[B] -> Link [LNK2] -> GSI 18 (level, low) -> IRQ 18
[   15.387368] NET: Registered protocol family 2
[   15.426751] IP route cache hash table entries: 65536 (order: 7, 524288 bytes)
[   15.428383] TCP established hash table entries: 32768 (order: 9, 2359296 bytes)
[   15.435710] TCP bind hash table entries: 16384 (order: 8, 1310720 bytes)
[   15.440653] TCP: Hash tables configured (established 32768 bind 16384)
[   15.440826] TCP reno registered
[   15.441748] Simple Boot Flag at 0x37 set to 0x1
[   15.444750] audit: initializing netlink socket (disabled)
[   15.444884] audit(1167791442.824:1): initialized
[   15.445106] Total HugeTLB memory allocated, 0
[   15.447455] VFS: Disk quotas dquot_6.5.1
[   15.447515] Dquot-cache hash table entries: 512 (order 0, 4096 bytes)
[   15.451588] io scheduler noop registered
[   15.451631] io scheduler cfq registered (default)
[   15.453552] vesafb: framebuffer at 0xf0000000, mapped to 0xffffc20000100000, using 3072k, total 65536k
[   15.453584] vesafb: mode is 1024x768x16, linelength=2048, pages=1
[   15.453597] vesafb: scrolling: redraw
[   15.453610] vesafb: Truecolor: size=0:5:6:5, shift=0:11:5:0
[   15.477193] Console: switching to colour frame buffer device 128x48
[   15.495540] fb0: VESA VGA frame buffer device
[   15.507005] Real Time Clock Driver v1.12ac
[   15.507373] Linux agpgart interface v0.101 (c) Dave Jones
[   15.507593] Serial: 8250/16550 driver $Revision: 1.90 $ 4 ports, IRQ sharing disabled
[   15.512521] ACPI: PCI Interrupt Link [LMCI] enabled at IRQ 22
[   15.512759] ACPI: PCI Interrupt 0000:00:06.1[B] -> Link [LMCI] -> GSI 22 (level, low) -> IRQ 22
[   15.513119] ACPI: PCI interrupt for device 0000:00:06.1 disabled
[   15.517181] RAMDISK driver initialized: 16 RAM disks of 128000K size 1024 blocksize
[   15.521191] PNP: PS/2 Controller [PNP0303:PS2K,PNP0f13:PS2M] at 0x60,0x64 irq 1,12
[   15.532600] i8042.c: Detected active multiplexing controller, rev 1.1.
[   15.540745] serio: i8042 KBD port at 0x60,0x64 irq 1
[   15.542545] serio: i8042 AUX0 port at 0x60,0x64 irq 12
[   15.543044] serio: i8042 AUX1 port at 0x60,0x64 irq 12
[   15.543549] serio: i8042 AUX2 port at 0x60,0x64 irq 12
[   15.544146] serio: i8042 AUX3 port at 0x60,0x64 irq 12
[   15.544990] mice: PS/2 mouse device common for all mice
[   15.547632] input: PC Speaker as /class/input/input0
[   15.572097] input: AT Translated Set 2 keyboard as /class/input/input1
[   15.928753] input: PS/2 Mouse as /class/input/input2
[   15.957997] input: AlpsPS/2 ALPS GlidePoint as /class/input/input3
[   15.966559] NET: Registered protocol family 1
[   15.971956] ACPI: (supports S0 S3 S4 S5)
[   15.976307] Freeing unused kernel memory: 196k freed
[   16.284772] Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
[   16.289900] ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
[   16.369103] ACPI: CPU0 (power states: C1[C1] C2[C2])
[   16.529600] ACPI Exception (acpi_thermal-0412): AE_NOT_FOUND, Invalid active threshold [0] [20060707]
[   16.618059] ACPI: Thermal Zone [THRM] (39 C)
[   16.679494] NFORCE3-150: IDE controller at PCI slot 0000:00:08.0
[   16.686394] NFORCE3-150: chipset revision 165
[   16.693277] NFORCE3-150: not 100% native mode: will probe irqs later
[   16.700380] NFORCE3-150: BIOS didn't set cable bits correctly. Enabling workaround.
[   16.707762] NFORCE3-150: 0000:00:08.0 (rev a5) UDMA133 controller
[   16.715236]     ide0: BM-DMA at 0x2080-0x2087, BIOS settings: hda:DMA, hdb:pio
[   16.722818]     ide1: BM-DMA at 0x2088-0x208f, BIOS settings: hdc:DMA, hdd:pio
[   16.730222] Probing IDE interface ide0...
[   17.017833] hda: ST94019A, ATA DISK drive
[   17.694353] ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
[   17.703037] hda: max request size: 512KiB
[   17.712438] hda: 78140160 sectors (40007 MB) w/2048KiB Cache, CHS=16383/255/63, UDMA(100)
[   17.720193] hda: cache flushes supported
[   17.730553]  hda: hda1 hda2 hda3 hda4
[   17.761927] Probing IDE interface ide1...
[   18.501569] hdc: SD-R2512, ATAPI CD/DVD-ROM drive
[   19.230822] ide1 at 0x170-0x177,0x376 on irq 15
[   19.300058] device-mapper: ioctl: 4.10.0-ioctl (2006-09-14) initialised: dm-devel at redhat.com
[   19.531409] Attempting manual resume
[   20.082802] kjournald starting.  Commit interval 5 seconds
[   20.093479] EXT3 FS on dm-0, internal journal
[   20.102231] EXT3-fs: mounted filesystem with ordered data mode.
[   24.139771] parport: PnPBIOS parport detected.
[   24.146688] parport0: PC-style at 0x378 (0x778), irq 7, dma 1 [PCSPP,TRISTATE,COMPAT,ECP,DMA]
[   24.257430] lp0: using parport0 (interrupt-driven).
[   26.239449] usbcore: registered new interface driver usbfs
[   26.247354] usbcore: registered new interface driver hub
[   26.254673] usbcore: registered new device driver usb
[   26.261329] Losing some ticks... checking if CPU frequency changed.
[   26.311490] ohci_hcd: 2006 August 04 USB 1.1 'Open' Host Controller (OHCI) Driver (PCI)
[   26.311618] PCI: Enabling device 0000:00:02.0 (0004 -> 0006)
[   26.319369] ACPI: PCI Interrupt Link [LUS0] enabled at IRQ 21
[   26.326074] ACPI: PCI Interrupt 0000:00:02.0[A] -> Link [LUS0] -> GSI 21 (level, low) -> IRQ 21
[   26.333347] PCI: Setting latency timer of device 0000:00:02.0 to 64
[   26.333361] ohci_hcd 0000:00:02.0: OHCI Host Controller
[   26.342512] ohci_hcd 0000:00:02.0: new USB bus registered, assigned bus number 1
[   26.556120] ohci_hcd 0000:00:02.0: irq 21, io mem 0xe0000000
[   26.622897] usb usb1: configuration #1 chosen from 1 choice
[   26.631960] hub 1-0:1.0: USB hub found
[   26.639577] hub 1-0:1.0: 3 ports detected
[   26.756381] PCI: Enabling device 0000:00:02.1 (0004 -> 0006)
[   26.764204] ACPI: PCI Interrupt Link [LUS1] enabled at IRQ 20
[   26.771062] ACPI: PCI Interrupt 0000:00:02.1[B] -> Link [LUS1] -> GSI 20 (level, low) -> IRQ 20
[   26.778550] PCI: Setting latency timer of device 0000:00:02.1 to 64
[   26.778565] ohci_hcd 0000:00:02.1: OHCI Host Controller
[   26.786278] ohci_hcd 0000:00:02.1: new USB bus registered, assigned bus number 2
[   26.995992] ohci_hcd 0000:00:02.1: irq 20, io mem 0xe0001000
[   27.058976] usb usb2: configuration #1 chosen from 1 choice
[   27.066556] hub 2-0:1.0: USB hub found
[   27.073827] hub 2-0:1.0: 3 ports detected
[   27.635482] i2c_adapter i2c-0: nForce2 SMBus adapter at 0x2040
[   27.643324] i2c_adapter i2c-1: nForce2 SMBus adapter at 0x2000
[   27.985296] ACPI: PCI Interrupt Link [LUS2] enabled at IRQ 22
[   27.992886] ACPI: PCI Interrupt 0000:00:02.2[C] -> Link [LUS2] -> GSI 22 (level, low) -> IRQ 22
[   28.000679] PCI: Setting latency timer of device 0000:00:02.2 to 64
[   28.000694] ehci_hcd 0000:00:02.2: EHCI Host Controller
[   28.008131] ehci_hcd 0000:00:02.2: new USB bus registered, assigned bus number 3
[   28.015388] PCI: cache line size of 64 is not supported by device 0000:00:02.2
[   28.015416] ehci_hcd 0000:00:02.2: irq 22, io mem 0xe0004000
[   28.022510] ehci_hcd 0000:00:02.2: USB 2.0 started, EHCI 1.00, driver 10 Dec 2004
[   28.030581] usb usb3: configuration #1 chosen from 1 choice
[   28.037889] hub 3-0:1.0: USB hub found
[   28.046123] hub 3-0:1.0: 6 ports detected
[   28.778858] ieee1394: Initialized config rom entry `ip1394'
[   28.825109] Yenta: CardBus bridge found at 0000:02:04.0 [103c:006d]
[   28.832324] PCI: Bus 3, cardbus bridge: 0000:02:04.0
[   28.839260]   IO window: 00003000-000030ff
[   28.846150]   IO window: 00003400-000034ff
[   28.853340]   PREFETCH window: 88000000-89ffffff
[   28.860240]   MEM window: e0400000-e07fffff
[   28.867268] Yenta: Enabling burst memory read transactions
[   28.874413] Yenta: Using CSCINT to route CSC interrupts to PCI
[   28.881355] Yenta: Routing CardBus interrupts to PCI
[   28.888109] Yenta TI: socket 0000:02:04.0, mfunc 0x01111d22, devctl 0x64
[   29.028314] ieee80211_crypt: registered algorithm 'NULL'
[   29.124912] Yenta: ISA IRQ mask 0x0c38, PCI irq 19
[   29.131978] Socket status: 30000086
[   29.138701] Yenta: Raising subordinate bus# of parent bus (#02) from #02 to #06
[   29.146003] pcmcia: parent PCI bridge I/O window: 0x3000 - 0x7fff
[   29.153308] pcmcia: parent PCI bridge Memory window: 0xe0100000 - 0xe17fffff
[   29.160288] pcmcia: parent PCI bridge Memory window: 0x88000000 - 0x8bffffff
[   29.169223] Yenta: CardBus bridge found at 0000:02:04.1 [103c:006d]
[   29.176010] Yenta: Using CSCINT to route CSC interrupts to PCI
[   29.182803] Yenta: Routing CardBus interrupts to PCI
[   29.189694] Yenta TI: socket 0000:02:04.1, mfunc 0x01111d22, devctl 0x64
[   29.266582] ieee80211: 802.11 data/management/control stack, git-1.1.13
[   29.273670] ieee80211: Copyright (C) 2004-2005 Intel Corporation <jketreno at linux.intel.com>
[   29.428887] Yenta: ISA IRQ mask 0x0c38, PCI irq 18
[   29.435963] Socket status: 30000006
[   29.443133] Yenta: Raising subordinate bus# of parent bus (#02) from #06 to #0a
[   29.450242] pcmcia: parent PCI bridge I/O window: 0x3000 - 0x7fff
[   29.457266] pcmcia: parent PCI bridge Memory window: 0xe0100000 - 0xe17fffff
[   29.464624] pcmcia: parent PCI bridge Memory window: 0x88000000 - 0x8bffffff
[   29.478981] ACPI: PCI Interrupt 0000:02:00.0[A] -> Link [LNK1] -> GSI 19 (level, low) -> IRQ 19
[   29.534190] ACPI: PCI Interrupt Link [LACI] enabled at IRQ 21
[   29.541240] ACPI: PCI Interrupt 0000:00:06.0[A] -> Link [LACI] -> GSI 21 (level, low) -> IRQ 21
[   29.549079] PCI: Setting latency timer of device 0000:00:06.0 to 64
[   29.570591] ohci1394: fw-host0: OHCI-1394 1.1 (PCI): IRQ=[19]  MMIO=[e0108000-e01087ff]  Max Packet=[2048]  IR/IT contexts=[4/8]
[   29.612477] 8139too Fast Ethernet driver 0.9.28
[   29.695573] AC'97 0 analog subsections not ready
[   29.775523] bcm43xx driver
[   29.914517] hdc: ATAPI 24X DVD-ROM CD-R/RW drive, 2048kB Cache, DMA
[   29.922070] Uniform CD-ROM driver Revision: 3.20
[   30.271396] intel8x0_measure_ac97_clock: measured 53570 usecs
[   30.278952] intel8x0: clocking to 47471
[   30.294589] ACPI: PCI Interrupt 0000:02:01.0[A] -> Link [LNK2] -> GSI 18 (level, low) -> IRQ 18
[   30.330027] eth0: RealTek RTL8139 at 0xffffc20000058800, 00:02:3f:24:7f:e8, IRQ 18
[   30.337871] eth0:  Identified 8139 chip type 'RTL-8101'
[   30.341996] ACPI: PCI Interrupt Link [LNK3] enabled at IRQ 17
[   30.349805] ACPI: PCI Interrupt 0000:02:02.0[A] -> Link [LNK3] -> GSI 17 (level, low) -> IRQ 17
[   30.358117] bcm43xx: Chip ID 0x4306, rev 0x3
[   30.366022] bcm43xx: Number of cores: 5
[   30.373922] bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243, enabled
[   30.381975] bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243, disabled
[   30.390042] bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243, enabled
[   30.398099] bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243, disabled
[   30.405921] bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243, enabled
[   30.416915] bcm43xx: PHY connected
[   30.424486] bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
[   30.432127] bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
[   30.439848] bcm43xx: Radio turned off
[   30.447412] bcm43xx: Radio turned off
[   30.864208] ieee1394: Host added: ID:BUS[0-00:1023]  GUID[453f0200453f0200]
[   32.814719] Adding 787176k swap on /dev/hda2.  Priority:-1 extents:1 across:787176k
[   36.817855] loop: loaded (max 8 devices)
[   50.626152] ACPI: AC Adapter [ACAD] (on-line)
[   51.122657] ACPI: Battery Slot [BAT1] (battery present)
[   51.520613] ACPI: Power Button (FF) [PWRF]
[   51.526905] ACPI: Power Button (CM) [PWRB]
[   51.533031] ACPI: Lid Switch [LID]
[   54.688259] powernow-k8: Found 1 AMD Athlon(tm) 64 Processor 3200+ processors (version 2.00.00)
[   54.697191] powernow-k8:    0 : fid 0xc (2000 MHz), vid 0x2
[   54.703734] powernow-k8:    1 : fid 0x8 (1600 MHz), vid 0xa
[   54.710293] powernow-k8:    2 : fid 0x0 (800 MHz), vid 0x12
[   60.591351] eth0: link up, 100Mbps, full-duplex, lpa 0x45E1
[   63.831077] NET: Registered protocol family 17
[   73.716272] audit(1167791490.121:2): audit_pid=3355 old=0 by auid=4294967295
[   74.044469] NET: Registered protocol family 10
[   74.045606] lo: Disabled Privacy Extensions
[   77.645216] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   78.204474] IPv6 addrconf: prefix with wrong length 127
[   80.158821] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   82.658537] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   85.157663] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   87.571761] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   89.574917] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   90.590674] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   91.590438] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   92.594250] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   93.598073] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   94.601893] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[   99.606519] printk: 4 messages suppressed.
[   99.606532] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  106.547028] printk: 3 messages suppressed.
[  106.547044] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  113.280097] printk: 4 messages suppressed.
[  113.280109] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  118.346823] printk: 4 messages suppressed.
[  118.346836] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  123.349920] printk: 4 messages suppressed.
[  123.349932] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  128.354650] printk: 4 messages suppressed.
[  128.354661] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  133.357829] printk: 4 messages suppressed.
[  133.357840] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  138.361242] printk: 4 messages suppressed.
[  138.361253] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  143.363901] printk: 4 messages suppressed.
[  143.363914] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  148.366169] printk: 4 messages suppressed.
[  148.366183] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  153.364695] printk: 4 messages suppressed.
[  153.364708] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  158.367676] printk: 4 messages suppressed.
[  158.367688] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  163.372573] printk: 4 messages suppressed.
[  163.372584] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  168.376067] printk: 4 messages suppressed.
[  168.376079] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  173.378652] printk: 4 messages suppressed.
[  173.378663] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  178.381944] printk: 4 messages suppressed.
[  178.381956] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  183.383210] printk: 4 messages suppressed.
[  183.383222] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  188.386705] printk: 4 messages suppressed.
[  188.386718] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  193.394091] printk: 4 messages suppressed.
[  193.394104] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  198.398225] printk: 4 messages suppressed.
[  198.398237] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  203.401420] printk: 4 messages suppressed.
[  203.401432] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  208.404489] printk: 4 messages suppressed.
[  208.404500] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  213.407940] printk: 4 messages suppressed.
[  213.407951] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  218.410347] printk: 4 messages suppressed.
[  218.410358] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
[  223.414001] printk: 4 messages suppressed.
[  223.414014] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
karnkraft:~ # tail -f /var/log/messages
Jan  2 21:33:41 karnkraft kernel: [  218.410347] printk: 4 messages suppressed.
Jan  2 21:33:41 karnkraft kernel: [  218.410358] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:33:46 karnkraft kernel: [  223.414001] printk: 4 messages suppressed.
Jan  2 21:33:46 karnkraft kernel: [  223.414014] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:33:51 karnkraft kernel: [  228.417005] printk: 4 messages suppressed.
Jan  2 21:33:51 karnkraft kernel: [  228.417017] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:33:56 karnkraft kernel: [  233.420097] printk: 4 messages suppressed.
Jan  2 21:33:56 karnkraft kernel: [  233.420109] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:01 karnkraft kernel: [  238.423181] printk: 4 messages suppressed.
Jan  2 21:34:01 karnkraft kernel: [  238.423193] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:06 karnkraft kernel: [  243.426448] printk: 4 messages suppressed.
Jan  2 21:34:06 karnkraft kernel: [  243.426461] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:11 karnkraft kernel: [  248.430079] printk: 4 messages suppressed.
Jan  2 21:34:11 karnkraft kernel: [  248.430090] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:15 karnkraft kernel: [  252.969057] ACPI: PCI interrupt for device 0000:02:02.0 disabled
Jan  2 21:34:16 karnkraft ifdown:     eth3      
Jan  2 21:34:16 karnkraft ifdown:     eth3      configuration: wlan-id-00:90:4b:51:af:da
Jan  2 21:34:23 karnkraft kernel: [  262.366933] bcm43xx driver
Jan  2 21:34:23 karnkraft kernel: [  262.372783] ACPI: PCI Interrupt 0000:02:02.0[A] -> Link [LNK3] -> GSI 17 (level, low) -> IRQ 17
Jan  2 21:34:23 karnkraft kernel: [  262.380164] bcm43xx: Chip ID 0x4306, rev 0x3
Jan  2 21:34:23 karnkraft kernel: [  262.380931] bcm43xx: Number of cores: 5
Jan  2 21:34:23 karnkraft kernel: [  262.381447] bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243, enabled
Jan  2 21:34:23 karnkraft kernel: [  262.381991] bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243, disabled
Jan  2 21:34:23 karnkraft kernel: [  262.382534] bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243, enabled
Jan  2 21:34:23 karnkraft kernel: [  262.383071] bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243, disabled
Jan  2 21:34:23 karnkraft kernel: [  262.383609] bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243, enabled
Jan  2 21:34:23 karnkraft kernel: [  262.387435] bcm43xx: PHY connected
Jan  2 21:34:23 karnkraft kernel: [  262.387958] bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
Jan  2 21:34:23 karnkraft kernel: [  262.388501] bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
Jan  2 21:34:23 karnkraft kernel: [  262.389044] bcm43xx: Radio turned off
Jan  2 21:34:23 karnkraft kernel: [  262.389555] bcm43xx: Radio turned off
Jan  2 21:34:23 karnkraft rename_netiface: oldname eth1 does not exist
Jan  2 21:34:24 karnkraft ifup:     eth3      device: Broadcom Corporation BCM4306 802.11b/g Wireless LAN Controller (rev 03)
Jan  2 21:34:24 karnkraft ifup:     eth3      configuration: wlan-id-00:90:4b:51:af:da
Jan  2 21:34:24 karnkraft ifup:     eth3      Startmode is 'manual'
Jan  2 21:34:24 karnkraft kernel: [  263.314157] printk: 4 messages suppressed.
Jan  2 21:34:24 karnkraft kernel: [  263.314170] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:24 karnkraft kernel: [  263.315440] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:26 karnkraft kernel: [  267.174806] printk: 1 messages suppressed.
Jan  2 21:34:26 karnkraft kernel: [  267.174817] SoftMAC: ASSERTION FAILED (0) at: net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan  2 21:34:29 karnkraft kernel: [  270.306354] bcm43xx: PHY connected
Jan  2 21:34:29 karnkraft kernel: [  270.610053] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
Jan  2 21:34:29 karnkraft kernel: [  270.619481] bcm43xx: Radio turned on
Jan  2 21:34:30 karnkraft kernel: [  270.782035] bcm43xx: Chip initialized
Jan  2 21:34:30 karnkraft kernel: [  270.783990] bcm43xx:    Level 2 pci_map_single at 0x0
Jan  2 21:34:30 karnkraft kernel: [  270.784522] 
Jan  2 21:34:30 karnkraft kernel: [  270.784525] Call Trace:
Jan  2 21:34:30 karnkraft kernel: [  270.786431]  [<ffffffff802659c0>] dump_trace+0xb4/0x3c9
Jan  2 21:34:30 karnkraft kernel: [  270.786858]  [<ffffffff80265d11>] show_trace+0x3c/0x52
Jan  2 21:34:30 karnkraft kernel: [  270.787045]  [<ffffffff80265d3c>] dump_stack+0x15/0x17
Jan  2 21:34:30 karnkraft kernel: [  270.788211]  [<ffffffff881ff922>] :bcm43xx:setup_rx_descbuffer+0x245/0x2c5
Jan  2 21:34:30 karnkraft kernel: [  270.791103]  [<ffffffff8820095e>] :bcm43xx:bcm43xx_setup_dmaring+0x35d/0x51f
Jan  2 21:34:30 karnkraft kernel: [  270.791375]  [<ffffffff88200e2f>] :bcm43xx:bcm43xx_dma_init+0x223/0x330
Jan  2 21:34:30 karnkraft kernel: [  270.792148]  [<ffffffff881ebee9>] :bcm43xx:wireless_core_up+0x602/0x706
Jan  2 21:34:30 karnkraft kernel: [  270.795357]  [<ffffffff881ec3c7>] :bcm43xx:bcm43xx_select_wireless_core+0x3da/0x58d
Jan  2 21:34:30 karnkraft kernel: [  270.795599]  [<ffffffff881ec68e>] :bcm43xx:bcm43xx_init_board+0x5e/0x12f
Jan  2 21:34:30 karnkraft kernel: [  270.796355]  [<ffffffff881eceda>] :bcm43xx:bcm43xx_net_open+0x10/0x12
Jan  2 21:34:30 karnkraft kernel: [  270.796953]  [<ffffffff80398b86>] dev_open+0x36/0x76
Jan  2 21:34:30 karnkraft kernel: [  270.800277]  [<ffffffff803971ae>] dev_change_flags+0x5d/0x122
Jan  2 21:34:30 karnkraft kernel: [  270.800636]  [<ffffffff803c9480>] devinet_ioctl+0x25a/0x5ee
Jan  2 21:34:30 karnkraft kernel: [  270.800819]  [<ffffffff803c9f30>] inet_ioctl+0x71/0x8f
Jan  2 21:34:30 karnkraft kernel: [  270.800996]  [<ffffffff8038fa88>] sock_ioctl+0x1da/0x203
Jan  2 21:34:30 karnkraft kernel: [  270.801176]  [<ffffffff8023f708>] do_ioctl+0x2a/0x77
Jan  2 21:34:30 karnkraft kernel: [  270.802105]  [<ffffffff8022da49>] vfs_ioctl+0x264/0x281
Jan  2 21:34:30 karnkraft kernel: [  270.802695]  [<ffffffff80248f5e>] sys_ioctl+0x5f/0x82
Jan  2 21:34:30 karnkraft kernel: [  270.806109]  [<ffffffff8025a11e>] system_call+0x7e/0x83
Jan  2 21:34:30 karnkraft kernel: [  270.806309]  [<00002b54c1fd5997>]
Jan  2 21:34:30 karnkraft kernel: [  270.806462] 
Jan  2 21:34:30 karnkraft kernel: [  270.807137] bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.810474] bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.812862] bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.813698] bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.814537] bcm43xx: DMA-32 0x0220 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.815369] bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
Jan  2 21:34:30 karnkraft kernel: [  270.816397] bcm43xx: Keys cleared
Jan  2 21:34:30 karnkraft kernel: [  270.817528] bcm43xx: Selected 802.11 core (phytype 2)
Jan  2 21:34:30 karnkraft kernel: [  270.842451] ADDRCONF(NETDEV_UP): eth3: link is not ready
Jan  2 21:35:12 karnkraft kernel: [  312.878016] SoftMAC: Associate: Scanning for networks first.
Jan  2 21:35:12 karnkraft kernel: [  312.878177] SoftMAC: Start scanning with channel: 1
Jan  2 21:35:12 karnkraft kernel: [  312.878184] SoftMAC: Scanning 14 channels
Jan  2 21:35:12 karnkraft kernel: [  312.886828] Unable to handle kernel NULL pointer dereference at 0000000000000040 RIP: 
Jan  2 21:35:12 karnkraft kernel: [  312.887058]  [<ffffffff881ffe00>] :bcm43xx:bcm43xx_dma_tx+0x92/0x654
Jan  2 21:35:12 karnkraft kernel: [  312.887439] PGD 77977067 PUD 772c9067 PMD 0 
Jan  2 21:35:12 karnkraft kernel: [  312.887625] Oops: 0000 [1] PREEMPT 
Jan  2 21:35:12 karnkraft kernel: [  312.887773] CPU 0 
Jan  2 21:35:12 karnkraft kernel: [  312.887858] Modules linked in: bcm43xx ipv6 af_packet cpufreq_conservative cpufreq_ondemand cpufreq_userspace cpufreq_powersave powernow_k8 freq_table snd_pcm_oss snd_mixer_oss snd_seq snd_seq_device button battery ac ext2 loop pcmcia ide_cd cdrom 8139too k8temp firmware_class hwmon ieee80211softmac mii ieee80211 snd_intel8x0 ieee80211_crypt ohci1394 snd_ac97_codec snd_ac97_bus yenta_socket rsrc_nonstatic ieee1394 snd_pcm snd_timer pcmcia_core snd ehci_hcd soundcore i2c_nforce2 i2c_core snd_page_alloc ohci_hcd usbcore parport_pc lp parport ext3 mbcache jbd dm_snapshot dm_mod fan amd74xx thermal processor ide_disk ide_core
Jan  2 21:35:12 karnkraft kernel: [  312.890355] Pid: 3, comm: events/0 Not tainted 2.6.19.1-wireless+1GB #5
Jan  2 21:35:12 karnkraft kernel: [  312.890610] RIP: 0010:[<ffffffff881ffe00>]  [<ffffffff881ffe00>] :bcm43xx:bcm43xx_dma_tx+0x92/0x654
Jan  2 21:35:12 karnkraft kernel: [  312.890995] RSP: 0018:ffff810037f39c90  EFLAGS: 00010046
Jan  2 21:35:12 karnkraft kernel: [  312.891203] RAX: ffff81007431f678 RBX: ffff81007431f328 RCX: 0000000000000355
Jan  2 21:35:12 karnkraft kernel: [  312.891479] RDX: 0000000000000001 RSI: ffff810077fbc5e0 RDI: ffff81007431f328
Jan  2 21:35:12 karnkraft kernel: [  312.891754] RBP: ffff810037f39cf0 R08: 0000000000000002 R09: 0000000000000001
Jan  2 21:35:12 karnkraft kernel: [  312.892027] R10: 0000000000000003 R11: 0000000000000046 R12: 0000000000000000
Jan  2 21:35:12 karnkraft kernel: [  312.892304] R13: ffff810077fbc5e0 R14: ffff81007431f358 R15: 0000000000000286
Jan  2 21:35:12 karnkraft kernel: [  312.892580] FS:  00002ae3eb4dfdd0(0000) GS:ffffffff80555000(0000) knlGS:0000000000000000
Jan  2 21:35:12 karnkraft kernel: [  312.892891] CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
Jan  2 21:35:12 karnkraft kernel: [  312.893113] CR2: 0000000000000040 CR3: 000000007589e000 CR4: 00000000000006e0
Jan  2 21:35:12 karnkraft kernel: [  312.893390] Process events/0 (pid: 3, threadinfo ffff810037f38000, task ffff810037fef0c0)
Jan  2 21:35:12 karnkraft kernel: [  312.893701] Stack:  ffffffff881ecdbb ffff810077fbc5e0 ffff81007431f388 ffff81007431f358
Jan  2 21:35:12 karnkraft kernel: [  312.894048]  ffff81007431f358 0000000000000286 ffff810077fbc5e0 ffff81007431f328
Jan  2 21:35:12 karnkraft kernel: [  312.894361]  00000000ffffffed ffff810077fbc5e0 ffff81007431f358 0000000000000286
Jan  2 21:35:12 karnkraft kernel: [  312.894666] Call Trace:
Jan  2 21:35:12 karnkraft kernel: [  312.894824]  [<ffffffff881ecdea>] :bcm43xx:bcm43xx_ieee80211_hard_start_xmit+0x5f/0x94
Jan  2 21:35:12 karnkraft kernel: [  312.895154]  [<ffffffff881b96c3>] :ieee80211:ieee80211_tx_frame+0x254/0x269
Jan  2 21:35:12 karnkraft kernel: [  312.904498]  [<ffffffff881c9649>] :ieee80211softmac:ieee80211softmac_send_mgt_frame+0x3a5/0x3c4
Jan  2 21:35:12 karnkraft kernel: [  312.914041]  [<ffffffff881cae8e>] :ieee80211softmac:ieee80211softmac_scan+0x55/0x155
Jan  2 21:35:12 karnkraft kernel: [  312.923602]  [<ffffffff80249fc2>] run_workqueue+0xa3/0xf9
Jan  2 21:35:12 karnkraft kernel: [  312.933243]  [<ffffffff802469bb>] worker_thread+0xe6/0x119
Jan  2 21:35:12 karnkraft kernel: [  312.942863]  [<ffffffff80230134>] kthread+0xce/0x101
Jan  2 21:35:12 karnkraft kernel: [  312.952493]  [<ffffffff8025ab18>] child_rip+0xa/0x12
Jan  2 21:35:12 karnkraft kernel: [  312.962119] 
Jan  2 21:35:12 karnkraft kernel: [  312.971665] 
Jan  2 21:35:12 karnkraft kernel: [  312.971667] Code: 41 80 7c 24 40 00 75 28 49 c7 c0 e3 47 20 88 b9 e9 03 00 00 
Jan  2 21:35:12 karnkraft kernel: [  312.990914] RIP  [<ffffffff881ffe00>] :bcm43xx:bcm43xx_dma_tx+0x92/0x654
Jan  2 21:35:12 karnkraft kernel: [  313.000622]  RSP <ffff810037f39c90>
Jan  2 21:35:12 karnkraft kernel: [  313.010262] CR2: 0000000000000040
Jan  2 21:35:12 karnkraft kernel: [  313.019874]  <6>note: events/0[3] exited with preempt_count 1
Jan  2 21:35:12 karnkraft kernel: [  313.029567] BUG: sleeping function called from invalid context at mm/slab.c:3007
Jan  2 21:35:12 karnkraft kernel: [  313.039345] in_atomic():1, irqs_disabled():1
Jan  2 21:35:12 karnkraft kernel: [  313.049056] 
Jan  2 21:35:12 karnkraft kernel: [  313.049058] Call Trace:
Jan  2 21:35:12 karnkraft kernel: [  313.068160]  [<ffffffff802659c0>] dump_trace+0xb4/0x3c9
Jan  2 21:35:12 karnkraft kernel: [  313.077835]  [<ffffffff80265d11>] show_trace+0x3c/0x52
Jan  2 21:35:12 karnkraft kernel: [  313.087424]  [<ffffffff80265d3c>] dump_stack+0x15/0x17
Jan  2 21:35:12 karnkraft kernel: [  313.096799]  [<ffffffff8020b53f>] __might_sleep+0xb2/0xb4
Jan  2 21:35:12 karnkraft kernel: [  313.106036]  [<ffffffff802ba25b>] kmem_cache_zalloc+0x29/0xa1
Jan  2 21:35:12 karnkraft kernel: [  313.115218]  [<ffffffff802a9b69>] taskstats_exit_alloc+0x28/0x68
Jan  2 21:35:12 karnkraft kernel: [  313.124434]  [<ffffffff80213e46>] do_exit+0x152/0x916
Jan  2 21:35:12 karnkraft kernel: [  313.133671]  [<ffffffff8020aa01>] do_page_fault+0x732/0x7bd
Jan  2 21:35:12 karnkraft kernel: [  313.142683]  [<ffffffff80261c3d>] error_exit+0x0/0x96
Jan  2 21:35:12 karnkraft kernel: [  313.151413]  [<ffffffff881ffe00>] :bcm43xx:bcm43xx_dma_tx+0x92/0x654
Jan  2 21:35:12 karnkraft kernel: [  313.159977]  [<ffffffff881ecdea>] :bcm43xx:bcm43xx_ieee80211_hard_start_xmit+0x5f/0x94
Jan  2 21:35:12 karnkraft kernel: [  313.168304]  [<ffffffff881b96c3>] :ieee80211:ieee80211_tx_frame+0x254/0x269
Jan  2 21:35:12 karnkraft kernel: [  313.176389]  [<ffffffff881c9649>] :ieee80211softmac:ieee80211softmac_send_mgt_frame+0x3a5/0x3c4
Jan  2 21:35:12 karnkraft kernel: [  313.184369]  [<ffffffff881cae8e>] :ieee80211softmac:ieee80211softmac_scan+0x55/0x155
Jan  2 21:35:12 karnkraft kernel: [  313.192131]  [<ffffffff80249fc2>] run_workqueue+0xa3/0xf9
Jan  2 21:35:12 karnkraft kernel: [  313.199742]  [<ffffffff802469bb>] worker_thread+0xe6/0x119
Jan  2 21:35:12 karnkraft kernel: [  313.207234]  [<ffffffff80230134>] kthread+0xce/0x101
Jan  2 21:35:12 karnkraft kernel: [  313.214684]  [<ffffffff8025ab18>] child_rip+0xa/0x12
Jan  2 21:35:12 karnkraft kernel: [  313.222054] 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dma_over_1GB_panic.png
Type: image/png
Size: 128328 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070102/fb5629fa/attachment.png>

From larry.finger at lwfinger.net  Thu Jan  4 05:42:50 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 03 Jan 2007 22:42:50 -0600
Subject: bcm4311
In-Reply-To: <4f8d9c0c0701012221j1bcfae26tdd9cb8464cbd807d@mail.gmail.com>
References: <4f8d9c0c0701012221j1bcfae26tdd9cb8464cbd807d@mail.gmail.com>
Message-ID: <459C85CA.2080301@lwfinger.net>

Dan Pasanen wrote:
> im not too sure if anything has been done about this, but i have a
> broadcom 4311 (notice the subject :) ) but its actually a dell mini-pci
> 1390. im using kernel 2.6.20-rc3...i have the bcm43xx built into my
> kernel, along with softmac, and the whole shabang...when it gets loaded
> at boot, it says this according to dmesg:
> 
> bcm43xx driver
> ACPI: PCI Interrupt Link [LK2E] enabled at IRQ 19
> ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19 (level,
> high) -> IRQ $
> PCI: Setting latency timer of device 0000:01:00.0 to 64
> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> 
> later in dmesg it shows this:
> bcm43xx: IRQ_READY timeout
> bcm43xx: core_up for active 802.11 core failed (-19)
> bcm43xx: IRQ_READY timeout
> bcm43xx: core_up for active 802.11 core failed (-19)
> bcm43xx: IRQ_READY timeout
> bcm43xx: core_up for active 802.11 core failed (-19)
> 
> 
> everytime i switch my card on or off it shows:
> ACPI: EC: evaluationg _Q10
> but the led for the wifi card doesnt change, its still orange (off)
> 
> ifconfig eth1 up gives me this:
> SIOCSIFFLAGS: No such device
> 
> iwlist eth1 scan
> eth1      No scan results
> 
> iwconfig
> 
> eth1   IEEE 802.11b/g  ESSID:"essid"  Nickname:"bcm4311"
>           Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
>           Bit Rate=1 Mb/s
>           RTS thr:off   Fragment thr:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> 
> i got my firmware from http://bu3sch.de/bcm43xx_fw.php
> <http://bu3sch.de/bcm43xx_fw.php> and extracted with bcm43xx-fwcutter
> and put them in /lib/firmware (used v3.x)
> 
> any help would be greatly apprecitated!
> thanks!

Just at the end of December, I got a computer with the same interface _AND_ the same problem. There
is a problem with TX DMA with PCI-E cards. You can either use the kernel from the wireless-dev git
tree, or you can use PIO mode for the card. I have been out of town and have not had a chance to
find the problem, but wuill post a fix ASAP.

Larry


From larry.finger at lwfinger.net  Thu Jan  4 18:33:52 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 04 Jan 2007 11:33:52 -0600
Subject: >1GB Bug
In-Reply-To: <200701022308.55570.heise2k@gmail.com>
References: <200701022308.55570.heise2k@gmail.com>
Message-ID: <459D3A80.1050900@lwfinger.net>

Bob Heise wrote:
> Hello,
> 
> I am using 2.6.19.1 + wireless-dev git kernel, bcm43xx driver with v.3 
> firmware on an HP zv5000z amd64 with 2GB RAM.
> 
> lspci -n
> 02:02.0 Class 0280: 14e4:4320 (rev 03)
> 
> lspci -vv
> 02:02.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless 
> LAN Controller (rev 03)
>         Subsystem: Hewlett-Packard Company NX9500 Built-in Wireless
>         Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- 
> Stepping- SERR+ FastB2B-
>         Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- 
> <TAbort- <MAbort- >SERR- <PERR-
>         Latency: 64
>         Interrupt: pin A routed to IRQ 17
>         Region 0: Memory at e0104000 (32-bit, non-prefetchable) [size=8K]
> 
> 
> This setup works if I limit the system RAM with mem=1024M on the boot prompt, 
> but with all the RAM it let's me modprobe but if I try to set the essid or do 
> a iwlist eth4 scanning etc., it deadlocks. I tried Larry's dma_over_1GB patch 
> from 01 December 
> <https://lists.berlios.de/pipermail/bcm43xx-dev/2006-December/003244.html>, 
> but the system still hangs. I could not get netconsole to work, but attached 
> is most of the dmesg + tail -f /var/messages which I captured via ssh. Also 
> included is a picture of the kernel panic, which did not make it across ssh.

Thanks for your report. It seems that the dma_over_1GB patch works on some systems, but not on
others. I do not know why. I just got a new AMD 64 X2 computer with a motherboard capable of holding
2GB RAM. It currently has only 1GB with a Dell 1390 (BCM4311) that is capable of full 32-bit DMA.
I'm trying to decide if I could do any debugging of the problem if I got more memory and tricked the
program into thinking I had only 30-bit DMA capability. There is one other problem in that TX DMA
doesn't work with the PCI-E hardware with 2.6.20 or wireless-2.6 versions. I need to fix that
problem first.

Larry



From hijinks at gmail.com  Fri Jan  5 20:37:13 2007
From: hijinks at gmail.com (Mike Zupan)
Date: Fri, 5 Jan 2007 14:37:13 -0500
Subject: bcm4311 & 2.6.20-rc2
Message-ID: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>

I know that there are still issues with this card from IRC/forum and mailing
list.. but I applied the softmac patch and got this in my dmesg.

bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)


There is no led on.. but it seems the radio on.. but it can't scan..

I have done some kernel work but no work with wireless in the kernel but if
i could be any help, I idle all the time in the chatroom and would offer my
machine as a testing ground for new patches or such

Mike
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070105/742a67c4/attachment.html>

From badmuthahubbard at gmail.com  Fri Jan  5 23:58:38 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Fri, 5 Jan 2007 17:58:38 -0500
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
Message-ID: <8200bab70701051458w4b8757b7u4c54dd67903738c6@mail.gmail.com>

I have the 4311 too, and I would also be willing to help test.  I
don't know nothing about no kernel, though.

-Chuckk (chuckkh)

On 1/5/07, Mike Zupan <hijinks at gmail.com> wrote:
> I know that there are still issues with this card from IRC/forum and mailing
> list.. but I applied the softmac patch and got this in my dmesg.
>
> bcm43xx driver
> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
>
>
> There is no led on.. but it seems the radio on.. but it can't scan..
>
> I have done some kernel work but no work with wireless in the kernel but if
> i could be any help, I idle all the time in the chatroom and would offer my
> machine as a testing ground for new patches or such
>
> Mike
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
>


-- 
"Far and away the best prize that life has to offer is the chance to
work hard at work worth doing."
-Theodore Roosevelt


From ftoledo at docksud.com.ar  Sat Jan  6 00:12:02 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Fri, 05 Jan 2007 20:12:02 -0300
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <8200bab70701051458w4b8757b7u4c54dd67903738c6@mail.gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
	<8200bab70701051458w4b8757b7u4c54dd67903738c6@mail.gmail.com>
Message-ID: <459EDB42.7010800@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Chuckk Hubbard escribi?:
> I have the 4311 too, and I would also be willing to help test.  I
> don't know nothing about no kernel, though.
> 
> -Chuckk (chuckkh)
> 
> On 1/5/07, Mike Zupan <hijinks at gmail.com> wrote:
>> I know that there are still issues with this card from IRC/forum and mailing
>> list.. but I applied the softmac patch and got this in my dmesg.
>>
>> bcm43xx driver
>> bcm43xx: Chip ID 0x4311, rev 0x1
>> bcm43xx: Number of cores: 4
>> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
>> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
>> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
>> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
>> bcm43xx: PHY connected
>> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
>> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
>> bcm43xx: Radio turned off
>> bcm43xx: Radio turned off
>> bcm43xx: PHY connected
>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>> bcm43xx: Radio turned on
>> bcm43xx: Chip initialized
>> bcm43xx: 32-bit DMA initialized
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>>
>>
>> There is no led on.. but it seems the radio on.. but it can't scan..
>>
>> I have done some kernel work but no work with wireless in the kernel but if
>> i could be any help, I idle all the time in the chatroom and would offer my
>> machine as a testing ground for new patches or such
>>
>> Mike
>>
>> _______________________________________________
>> Bcm43xx-dev mailing list
>> Bcm43xx-dev at lists.berlios.de
>> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>>
>>
>>
> 
> 
most of 4311 pcie still dont work.
anybody have contact with broadcom people?
i send several mails to him and dont get response =(


-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFnttCz8H9Vs7bTsMRAtiSAKDkapiHW7B1He2dh1i1G3najei1NgCg2kTl
VJ1pb6HAhZ+yoNdWAOFRk68=
=6seh
-----END PGP SIGNATURE-----


From ftoledo at docksud.com.ar  Sat Jan  6 01:37:44 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Fri, 05 Jan 2007 21:37:44 -0300
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <8200bab70701051516k5edff958t6055983aee060052@mail.gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>	
	<8200bab70701051458w4b8757b7u4c54dd67903738c6@mail.gmail.com>	
	<459EDB42.7010800@docksud.com.ar>
	<8200bab70701051516k5edff958t6055983aee060052@mail.gmail.com>
Message-ID: <459EEF58.20806@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Chuckk Hubbard escribi?:
> I wouldn't expect them to care, they are so well-known for this
> attitude.  I'm sure they know people are angry.  I did not know there
> was even a way to write to them.  Could you email me the address?
> 
here has info:
http://www.broadcom.com/contact/?source=top

if anyone live in usa, please try to make a phone call.

if your do no have support , think about us, that living in the ass of
the world

=\

Saludos!



-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFnu9Xz8H9Vs7bTsMRAt8jAJ0fW1jwHITlu8mu/by+IfWhyigbOwCfZC4J
btbOihYAklzP2dqRwojl4G0=
=HjV3
-----END PGP SIGNATURE-----


From larry.finger at lwfinger.net  Sat Jan  6 02:00:23 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Jan 2007 19:00:23 -0600
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <459EEF58.20806@docksud.com.ar>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>		<8200bab70701051458w4b8757b7u4c54dd67903738c6@mail.gmail.com>		<459EDB42.7010800@docksud.com.ar>	<8200bab70701051516k5edff958t6055983aee060052@mail.gmail.com>
	<459EEF58.20806@docksud.com.ar>
Message-ID: <459EF4A7.4060300@lwfinger.net>

Fernando Toledo wrote:
> Chuckk Hubbard escribi?:
>> I wouldn't expect them to care, they are so well-known for this
>> attitude.  I'm sure they know people are angry.  I did not know there
>> was even a way to write to them.  Could you email me the address?
> 
> here has info:
> http://www.broadcom.com/contact/?source=top
> 
> if anyone live in usa, please try to make a phone call.
> 
> if your do no have support , think about us, that living in the ass of
> the world

Broadcom has made a conscious decision not to support Linux, which is the reason for this
reverse-engineering project. The usual reason is that an open-source driver would expose their
intellectual property to the competition. Writing or calling them will have no effect. They will say
that if you want to use their product, then you need to run OS X or Windows. Under Linux, you can
always use ndiswrapper. Of course, if you have a crash while running this way, you can kiss Linux
kernel support goodbye.

With respect to the 4311, you will be happy to learn that one of the developers (me) now has one. It
does not work with any of the mainline (2.6.20 or wireless-2.6) kernels, nor with stable (2.6.19).
It does work with the wireless-dev git tree, and I am trying to find the critical differences
between the two trees. When I get a fix, the patches will be posted here.

Larry



From heise2k at gmail.com  Sat Jan  6 02:35:12 2007
From: heise2k at gmail.com (Bob Heise)
Date: Fri, 5 Jan 2007 20:35:12 -0500
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <459EF4A7.4060300@lwfinger.net>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
	<459EEF58.20806@docksud.com.ar> <459EF4A7.4060300@lwfinger.net>
Message-ID: <200701052035.12831.heise2k@gmail.com>

fredag 05 januari 2007 20:00 skrev Larry Finger:
> Broadcom has made a conscious decision not to support Linux, which is the
> reason for this reverse-engineering project. The usual reason is that an
> open-source driver would expose their intellectual property to the
> competition. Writing or calling them will have no effect. They will say
> that if you want to use their product, then you need to run OS X or
> Windows. Under Linux, you can always use ndiswrapper. Of course, if you
> have a crash while running this way, you can kiss Linux kernel support
> goodbye.

That sucks. When the driver you guys have written works really well, people 
will buy broadcom's hardware because it has good linux support and 
unknowingly give broadcom tacit approval for these shenannigans, (no specs 
_and_ pci devices that use 30-bit DMA). Though I guess not having any useable 
driver is worse...

-Bob

>
> With respect to the 4311, you will be happy to learn that one of the
> developers (me) now has one. It does not work with any of the mainline
> (2.6.20 or wireless-2.6) kernels, nor with stable (2.6.19). It does work
> with the wireless-dev git tree, and I am trying to find the critical
> differences between the two trees. When I get a fix, the patches will be
> posted here.
>
> Larry
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev


From larry.finger at lwfinger.net  Sat Jan  6 02:56:10 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Jan 2007 19:56:10 -0600
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <200701052035.12831.heise2k@gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>	<459EEF58.20806@docksud.com.ar>
	<459EF4A7.4060300@lwfinger.net>
	<200701052035.12831.heise2k@gmail.com>
Message-ID: <459F01BA.3010504@lwfinger.net>

Bob Heise wrote:
> fredag 05 januari 2007 20:00 skrev Larry Finger:
>> Broadcom has made a conscious decision not to support Linux, which is the
>> reason for this reverse-engineering project. The usual reason is that an
>> open-source driver would expose their intellectual property to the
>> competition. Writing or calling them will have no effect. They will say
>> that if you want to use their product, then you need to run OS X or
>> Windows. Under Linux, you can always use ndiswrapper. Of course, if you
>> have a crash while running this way, you can kiss Linux kernel support
>> goodbye.
> 
> That sucks. When the driver you guys have written works really well, people 
> will buy broadcom's hardware because it has good linux support and 
> unknowingly give broadcom tacit approval for these shenannigans, (no specs 
> _and_ pci devices that use 30-bit DMA). Though I guess not having any useable 
> driver is worse...

I cannot blame them too much for the 30-bit DMA design defect. When the b4400 and the initial
bcm43xx chips came out, a main memory of more than 1 GB was hardly conceivable and 256 MB was
sufficient. Who knew that Windows would bloat to the point that 1 GB starts to become the minimum,
which pushed the motherboard makers to allow 2 GB or more. My 30-bit Linksys WPC54G V1 is at least 4
years old. By the time they got to V3, it had 32-bit DMA.

Larry


From Larry.Finger at lwfinger.net  Sat Jan  6 03:28:21 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 05 Jan 2007 20:28:21 -0600
Subject: BCM4311 problems
Message-ID: <459F0945.7080207@lwfinger.net>

Michael,

With your experience with the bcm43xx and other drivers, I hope you can help me. With my new Turion
64 X2 laptop with a Dell 1390 (BCM4311) wireless card, I am getting no transmissions. I don't know
about received data. If I let it try to scan long enough, I get lots of the following messages logged:

bcm43xx: Out of DMA descriptor slots!

When I shut the card down, I get the following slot usage:

bcm43xx: DMA-32 0x0200 (RX) max used slots: 0/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 512/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512

Obviously, the TX DMA is not getting through. I'm running an x86_64 system. The behavior is the same
whether I configure SMP or not. This card will not work in PIO mode, so I cannot test it that way.
I'm a little reluctant to reload an i386 system, but I could if necessary.

When I boot the wireless-dev kernel, it works. I have looked at the differences between wireless-2.6
and wireless-dev, but I don't see anything other than the obvious design differences.

Have you seen anything like this before? If so, where should I look? I didn't want to bother you,
but I'm not making any headway.

Larry


From caravena at ubuntu-cl.org  Sat Jan  6 15:43:31 2007
From: caravena at ubuntu-cl.org (Cristian Aravena Romero)
Date: Sat, 6 Jan 2007 11:43:31 -0300
Subject: [broadcom4318] Not work WiFi in Compaq Presario V2417LA (serie V2000)
	with kernel 2.6.20-RC2
Message-ID: <bbff98600701060643q3c3cf010r3b339f6a4e26bf20@mail.gmail.com>

Hello,

I read [0]web and send mail with info
[0]http://bcm43xx.berlios.de/?go=devices


=== Hardware ===
Notebook: https://wiki.ubuntu.com/LaptopTestingTeam/CompaqPresarioV2417LA/Hardware

$lspci -vn

[...]

05:02.0 0280: 14e4:4318 (rev 02)
        Subsystem: 103c:1356
        Flags: bus master, fast devsel, latency 64, IRQ 3
        Memory at d0204000 (32-bit, non-prefetchable) [size=8K]


=== Software ===

Distribution: Ubuntu Festy (Unstable)

Kernel version:
caravena at zeus:~$ uname -a
Linux zeus 2.6.20-4-generic #2 SMP Fri Jan 5 04:31:55 UTC 2007 i686 GNU/Linux


=== Comments ===

* Is have chipse Broadcom 4318[0]
* NOT WORK wiht driver native (I use PCMCIA with 06:00.0 Network
controller: RaLink RT2500 802.11g Cardbus/mini-PCI (rev 01) )
* I user chilean, my english is very, very bad : -(, and sorry.
[0] 05:02.0 Network controller: Broadcom Corporation BCM4318 [AirForce
One 54g] 802.11g Wireless LAN Controller (rev 02)

Thanks,
--
Cristian Aravena Romero


From mb at bu3sch.de  Sat Jan  6 18:00:13 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 6 Jan 2007 18:00:13 +0100
Subject: BCM4311 problems
In-Reply-To: <459F0945.7080207@lwfinger.net>
References: <459F0945.7080207@lwfinger.net>
Message-ID: <200701061800.13746.mb@bu3sch.de>

On Saturday 06 January 2007 03:28, Larry Finger wrote:
> Michael,
> 
> With your experience with the bcm43xx and other drivers, I hope you can help me. With my new Turion
> 64 X2 laptop with a Dell 1390 (BCM4311) wireless card, I am getting no transmissions. I don't know
> about received data. If I let it try to scan long enough, I get lots of the following messages logged:
> 
> bcm43xx: Out of DMA descriptor slots!
> 
> When I shut the card down, I get the following slot usage:
> 
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 0/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 512/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> 
> Obviously, the TX DMA is not getting through. I'm running an x86_64 system. The behavior is the same
> whether I configure SMP or not. This card will not work in PIO mode, so I cannot test it that way.
> I'm a little reluctant to reload an i386 system, but I could if necessary.

knoppix or something?

> When I boot the wireless-dev kernel, it works. I have looked at the differences between wireless-2.6
> and wireless-dev, but I don't see anything other than the obvious design differences.
> 
> Have you seen anything like this before? If so, where should I look? I didn't want to bother you,
> but I'm not making any headway.
> 

You aren't getting TX status interrupts. Why? Well, dunno. v4 firmware perhaps.

-- 
Greetings Michael.


From rdorsch at web.de  Sat Jan  6 19:25:03 2007
From: rdorsch at web.de (Rainer Dorsch)
Date: Sat, 6 Jan 2007 13:25:03 -0500
Subject: [Offtopic] Looking for USB WLAN Stick
Message-ID: <200701061325.03497.rdorsch@web.de>

Hello,

I am looking for an USB WLAN stick, which is supported by a native Linux 
driver. I want to plug it into an nslu2 (ARM cpu), and run it as access 
point, i.e. ndiswrapper is *not* an option.

Does anybody have recommendations?

Thanks,
Rainer

-- 
Rainer Dorsch
Alzentalstr. 28
D-71083 Herrenberg
07032-919495
jabber: rdorsch at jabber.org
GPG Fingerprint: 5966 C54C 2B3C 42CC 1F4F  8F59 E3A8 C538 7519 141E
Full GPG key: http://pgp.mit.edu/


From evanfoss at gmail.com  Sat Jan  6 19:57:16 2007
From: evanfoss at gmail.com (evan foss)
Date: Sat, 6 Jan 2007 13:57:16 -0500
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <4a55afb80701061055i18d064b6kbc5b1041b429612d@mail.gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
	<459EEF58.20806@docksud.com.ar> <459EF4A7.4060300@lwfinger.net>
	<200701052035.12831.heise2k@gmail.com> <459F01BA.3010504@lwfinger.net>
	<4a55afb80701061055i18d064b6kbc5b1041b429612d@mail.gmail.com>
Message-ID: <4a55afb80701061057v54a561d8vec68e979c647f09a@mail.gmail.com>

Sorry I ment to send this to the list.

On 1/6/07, evan foss <evanfoss at gmail.com> wrote:
> > > That sucks. When the driver you guys have written works really well, people
> > > will buy broadcom's hardware because it has good linux support and
> > > unknowingly give broadcom tacit approval for these shenannigans, (no specs
> > > _and_ pci devices that use 30-bit DMA). Though I guess not having any useable
> > > driver is worse...
>
> Hopefully some Linux/developer magazines will point out how badly
> Broadcom has made things once that happens. If we are lucky the
> community will have a longer term memory. Sadly we put up with the
> nVidia binary driver.
>
> --
> http://www.coe.neu.edu/~efoss/
> http://evanfoss.googlepages.com/
>


-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From badmuthahubbard at gmail.com  Sat Jan  6 20:10:33 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Sat, 6 Jan 2007 14:10:33 -0500
Subject: bcm4311 & 2.6.20-rc2
In-Reply-To: <8200bab70701061109m67915808gd62c846d9f6269e@mail.gmail.com>
References: <7227c6c70701051137p5d4e9de1xdfdc7b5e2c362770@mail.gmail.com>
	<459EEF58.20806@docksud.com.ar> <459EF4A7.4060300@lwfinger.net>
	<200701052035.12831.heise2k@gmail.com>
	<8200bab70701061109m67915808gd62c846d9f6269e@mail.gmail.com>
Message-ID: <8200bab70701061110s17aad38r49f766ba07805039@mail.gmail.com>

On 1/5/07, Bob Heise <heise2k at gmail.com> wrote:
> fredag 05 januari 2007 20:00 skrev Larry Finger:
> > Broadcom has made a conscious decision not to support Linux, which is the
> > reason for this reverse-engineering project. The usual reason is that an
> > open-source driver would expose their intellectual property to the
> > competition. Writing or calling them will have no effect. They will say
> > that if you want to use their product, then you need to run OS X or
> > Windows. Under Linux, you can always use ndiswrapper. Of course, if you
> > have a crash while running this way, you can kiss Linux kernel support
> > goodbye.
>
> That sucks. When the driver you guys have written works really well, people
> will buy broadcom's hardware because it has good linux support and
> unknowingly give broadcom tacit approval for these shenannigans, (no specs
> _and_ pci devices that use 30-bit DMA). Though I guess not having any useable
> driver is worse...

On the other hand, their reason is to try to make more money off
hardware before others learn how it works.  All useful technology that
is around long enough gets cheaper, and all who restrict such
intellectual property will find less and less demand for it.  That
isn't to say I wouldn't try to make money too; they must know this to
be that concerned with getting as much as they can from it before it's
completely commonplace/obsolete.
But in a way I think you're right.  If I had known about this
situation before buying I wouldn't have gotten Broadcom, but if I had
known about the situation and it had already been resolved by Linux
developers, I still would have gotten Broadcom.  On the OTHER hand,
what's to stop them from just coming out with more models that aren't
yet supported?

-Chuckk


-- 
"Far and away the best prize that life has to offer is the chance to
work hard at work worth doing."
-Theodore Roosevelt


From larry.finger at lwfinger.net  Sat Jan  6 20:54:23 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Jan 2007 13:54:23 -0600
Subject: BCM4311 problems
In-Reply-To: <200701061800.13746.mb@bu3sch.de>
References: <459F0945.7080207@lwfinger.net> <200701061800.13746.mb@bu3sch.de>
Message-ID: <459FFE6F.7060104@lwfinger.net>

Michael Buesch wrote:
>> I'm a little reluctant to reload an i386 system, but I could if necessary.
> 
> knoppix or something?

Knoppix would be a good choice, except that 5.1.1 has kernel 2.6.19.1 and does not support PCI-E.
> 
> 
> You aren't getting TX status interrupts. Why? Well, dunno. v4 firmware perhaps.
>

I'm not getting _ANY_ interrupts. The code setting them up looks OK, the mask is correct, but the
top half interrupt handler is never called. I have no idea why this should happen. My guess is that
it is not a V4 vs V3 firmware question, but ...

Larry





From ftoledo at docksud.com.ar  Sat Jan  6 21:38:02 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Sat, 06 Jan 2007 17:38:02 -0300
Subject: [Offtopic] Looking for USB WLAN Stick
In-Reply-To: <200701061325.03497.rdorsch@web.de>
References: <200701061325.03497.rdorsch@web.de>
Message-ID: <45A008AA.3070505@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Rainer Dorsch escribi?:
> Hello,
> 
> I am looking for an USB WLAN stick, which is supported by a native Linux 
> driver. I want to plug it into an nslu2 (ARM cpu), and run it as access 
> point, i.e. ndiswrapper is *not* an option.
> 
> Does anybody have recommendations?
> 
> Thanks,
> Rainer
> 

Hi Rainer, i have a iogear (zd1211 chipset) by Zydas
it is now in the mail kernel from 2.6.18 but still dont have master mode
support here
but you can use the comunity driver (based on zydas vendor driver) that
works fine
i dont remember if the arm cpu is supported, you can see more info in
http://zd1211.ath.cx

Saludos!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFoAipz8H9Vs7bTsMRAnFGAKCgDrbQFmYXPgVSbsiJ9AcNsP6OtQCg3Puv
IWm4Aj7A9evbiCl0GVlCDjU=
=uQks
-----END PGP SIGNATURE-----


From radarsat1 at gmail.com  Sat Jan  6 22:06:32 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Sat, 6 Jan 2007 16:06:32 -0500
Subject: bcm4311 & wireless-2.6
Message-ID: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>

>
> With respect to the 4311, you will be happy to learn that one of the
> developers (me) now has one. It
> does not work with any of the mainline (2.6.20 or wireless-2.6) kernels,
> nor with stable (2.6.19).
> It does work with the wireless-dev git tree, and I am trying to find the
> critical differences
> between the two trees. When I get a fix, the patches will be posted here.



For what it's worth, I'm using the bcm43xx driver with wireless-2.6 on my HP
laptop, which has a 4311 card, and it does work.
It's not perfect... it is quite a slow connection (feels like 802.11b), and
after some period of time the device always "resets" and I have to reboot
the laptop, and trying to unload the module causes a crash.  However, it
does work.

Note however that I did this quite a while ago now, I git-cloned
wireless-2.6 and applied a couple of patches about 5 or 6 months ago. Once I
got it working, I didn't keep trying new versions.  (I find kernel
development confusing enough that it takes a lot of energy for me to try
development patches...)

At this point I'd like to start trying again with the latest version of
bcm43xx, but I haven't gotten around to it yet.

Anyways, just to say, wireless-2.6 with 4311 works for me. I don't get that
DMA error you mentioned in the other thread.

Oh, I should mention, the computer as a 64-bit 2xTurion CPU, but I'm
actually running 32-bit Ubuntu, with firmware v3.


Steve
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070106/df998789/attachment.html>

From larry.finger at lwfinger.net  Sun Jan  7 05:28:49 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 06 Jan 2007 22:28:49 -0600
Subject: bcm4311 & wireless-2.6
In-Reply-To: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>
References: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>
Message-ID: <45A07701.3060909@lwfinger.net>

Stephen Sinclair wrote:
>     With respect to the 4311, you will be happy to learn that one of the
>     developers (me) now has one. It
>     does not work with any of the mainline (2.6.20 or wireless-2.6)
>     kernels, nor with stable (2.6.19).
>     It does work with the wireless-dev git tree, and I am trying to find
>     the critical differences
>     between the two trees. When I get a fix, the patches will be posted
>     here. 
> 
> 
> 
> For what it's worth, I'm using the bcm43xx driver with wireless-2.6 on
> my HP laptop, which has a 4311 card, and it does work.
> It's not perfect... it is quite a slow connection (feels like 802.11b),
> and after some period of time the device always "resets" and I have to
> reboot the laptop, and trying to unload the module causes a crash. 
> However, it does work.

No bcm43xx card works at higher than 11 MBs. Whenever any of the higher rates are selected, the TX
signal strength drops considerably.
> 
> Note however that I did this quite a while ago now, I git-cloned
> wireless-2.6 and applied a couple of patches about 5 or 6 months ago.
> Once I got it working, I didn't keep trying new versions.  (I find
> kernel development confusing enough that it takes a lot of energy for me
> to try development patches...)

As you have git cloned the wireless-2.6 tree, it is very simple to do a git pull to update your
source. You really should do that as a number of bugs that would cause your crashes and hangs have
been fixed in the past couple of months.
> 
> At this point I'd like to start trying again with the latest version of
> bcm43xx, but I haven't gotten around to it yet.
> 
> Anyways, just to say, wireless-2.6 with 4311 works for me. I don't get
> that DMA error you mentioned in the other thread.
> 
> Oh, I should mention, the computer as a 64-bit 2xTurion CPU, but I'm
> actually running 32-bit Ubuntu, with firmware v3.

I'm pretty sure the problem is with the x86_64 version that I'm running. No interrupts are delivered
to the software.

Larry


From akihana at gmail.com  Sun Jan  7 10:52:34 2007
From: akihana at gmail.com (Mike Mohr)
Date: Sun, 7 Jan 2007 01:52:34 -0800
Subject: [Offtopic] Looking for USB WLAN Stick
In-Reply-To: <45A008AA.3070505@docksud.com.ar>
References: <200701061325.03497.rdorsch@web.de>
	<45A008AA.3070505@docksud.com.ar>
Message-ID: <4746469c0701070152g143cb24emd4ccbf07a08638d8@mail.gmail.com>

Hi,

You might try the WUSB54GC.  Last I checked it had a ralink chipset,
which supports master mode very well AFAIK.  The official ralink
drivers do WPA and WEP in the driver.  The drivers are open-source,
provided by ralink itself.  There is also an unstable development tree
that supports hostapd+wpa_supplicant.

On 1/6/07, Fernando Toledo <ftoledo at docksud.com.ar> wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
>
> Rainer Dorsch escribi?:
> > Hello,
> >
> > I am looking for an USB WLAN stick, which is supported by a native Linux
> > driver. I want to plug it into an nslu2 (ARM cpu), and run it as access
> > point, i.e. ndiswrapper is *not* an option.
> >
> > Does anybody have recommendations?
> >
> > Thanks,
> > Rainer
> >
>
> Hi Rainer, i have a iogear (zd1211 chipset) by Zydas
> it is now in the mail kernel from 2.6.18 but still dont have master mode
> support here
> but you can use the comunity driver (based on zydas vendor driver) that
> works fine
> i dont remember if the arm cpu is supported, you can see more info in
> http://zd1211.ath.cx
>
> Saludos!
> -----BEGIN PGP SIGNATURE-----
> Version: GnuPG v1.4.6 (GNU/Linux)
> Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org
>
> iD8DBQFFoAipz8H9Vs7bTsMRAnFGAKCgDrbQFmYXPgVSbsiJ9AcNsP6OtQCg3Puv
> IWm4Aj7A9evbiCl0GVlCDjU=
> =uQks
> -----END PGP SIGNATURE-----
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>


From dbtsai at gmail.com  Wed Jan 10 20:46:25 2007
From: dbtsai at gmail.com (Tsai Dung-Bang)
Date: Thu, 11 Jan 2007 03:46:25 +0800
Subject: when will bcm43xx-d80211 merge into main kernel
Message-ID: <b5a848160701101146y1e69845fxae7f9f04dda3dd40@mail.gmail.com>

Dear All

As far as everyone know, the driver of dscape stack version  has more
future, such as support v4 firmware.

So I would like to know when will the dscape stack and bcm43xx-d80211
merge into main kernel.

Thanks for great work.

Tsai Dung-Bang


From johannes at sipsolutions.net  Wed Jan 10 20:55:44 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Wed, 10 Jan 2007 20:55:44 +0100
Subject: when will bcm43xx-d80211 merge into main kernel
In-Reply-To: <b5a848160701101146y1e69845fxae7f9f04dda3dd40@mail.gmail.com>
References: <b5a848160701101146y1e69845fxae7f9f04dda3dd40@mail.gmail.com>
Message-ID: <1168458944.8651.11.camel@johannes.berg>

On Thu, 2007-01-11 at 03:46 +0800, Tsai Dung-Bang wrote:
> Dear All
> 
> As far as everyone know, the driver of dscape stack version  has more
> future, such as support v4 firmware.
> 
> So I would like to know when will the dscape stack and bcm43xx-d80211
> merge into main kernel.

After d80211 itself, which will go in once we address all the todo items
and a bit more...

http://wireless.sipsolutions.net/ has a few of those items.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070110/a6e9adb6/attachment.pgp>

From radarsat1 at gmail.com  Thu Jan 11 06:34:58 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Thu, 11 Jan 2007 00:34:58 -0500
Subject: bcm4311 & wireless-2.6
In-Reply-To: <45A07701.3060909@lwfinger.net>
References: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>
	<45A07701.3060909@lwfinger.net>
Message-ID: <9b3e2dc20701102134m3f74be00x5a23f49be75cca83@mail.gmail.com>

> No bcm43xx card works at higher than 11 MBs. Whenever any
> of the higher rates are selected, the TX signal strength drops
> considerably.

Okay, I thought it was something similar.


> As you have git cloned the wireless-2.6 tree, it is very simple to do
> a git pull to update your source. You really should do that as a number
> of bugs that would cause your crashes and hangs have been fixed in the
> past couple of months.

I finally got around to it, thanks.  In fact, with my untrained git
skills I managed to mess it up due to the patches i'd applied earlier.
 (PCI-E and manually enabling 4311.)

Anyways, I ended up just re-cloning the wireless-2.6 tree using cg-clone.


> I'm pretty sure the problem is with the x86_64 version that I'm running
> No interrupts are delivered to the software.

I've been meaning to set up a partition with a 64-bit installation of
Ubuntu or something, so when I manage to do that I'll let you know.


On to the results:

I compiled and installed wireless-2.6 with no problems.  Bcm43xx was
detected, and you are right, it seems much more stable. Even the
radio-enable light turns on and off appropriately when I toggle the
switch.

Unfortunately, though, it acts as if it the radio is turned off.  I
cannot associate with any AP, and "iwlist eth2 scan" lists nothing.

Now that I'm on an untouched wireless-2.6 kernel, I'll try to git-pull
more often and test whenever updates are available.

(Is this the best method for testing the latest changes? I could apply
patches manually, but I'll have to learn how to "undo" those in git
properly.)


Anyways, I'll end this message with my "dmesg|grep bcm" output.

Thanks,
Steve


bcm43xx driver
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: set security called, .active_key = 0, .level = 1, .enabled =
1, .encryp t = 1


From larry.finger at lwfinger.net  Thu Jan 11 18:20:51 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 11 Jan 2007 11:20:51 -0600
Subject: bcm4311 & wireless-2.6
In-Reply-To: <9b3e2dc20701102134m3f74be00x5a23f49be75cca83@mail.gmail.com>
References: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>	
	<45A07701.3060909@lwfinger.net>
	<9b3e2dc20701102134m3f74be00x5a23f49be75cca83@mail.gmail.com>
Message-ID: <45A671F3.3080407@lwfinger.net>

Stephen Sinclair wrote:
>> No bcm43xx card works at higher than 11 MBs. Whenever any
>> of the higher rates are selected, the TX signal strength drops
>> considerably.
> 
> Okay, I thought it was something similar.
> 
> 
>> As you have git cloned the wireless-2.6 tree, it is very simple to do
>> a git pull to update your source. You really should do that as a number
>> of bugs that would cause your crashes and hangs have been fixed in the
>> past couple of months.
> 
> I finally got around to it, thanks.  In fact, with my untrained git
> skills I managed to mess it up due to the patches i'd applied earlier.
> (PCI-E and manually enabling 4311.)
> 
> Anyways, I ended up just re-cloning the wireless-2.6 tree using cg-clone.

For future reference, the command 'git checkout -F' will destroy any changes you have made and
revert your git tree to the last one pulled.

>> I'm pretty sure the problem is with the x86_64 version that I'm running
>> No interrupts are delivered to the software.
> 
> I've been meaning to set up a partition with a 64-bit installation of
> Ubuntu or something, so when I manage to do that I'll let you know.
> 
> 
> On to the results:
> 
> I compiled and installed wireless-2.6 with no problems.  Bcm43xx was
> detected, and you are right, it seems much more stable. Even the
> radio-enable light turns on and off appropriately when I toggle the
> switch.
> 
> Unfortunately, though, it acts as if it the radio is turned off.  I
> cannot associate with any AP, and "iwlist eth2 scan" lists nothing.

Please run 'cat /proc/wireless' to see if interrupts are being delivered to the bcm43xx.

> Now that I'm on an untouched wireless-2.6 kernel, I'll try to git-pull
> more often and test whenever updates are available.
> 
> (Is this the best method for testing the latest changes? I could apply
> patches manually, but I'll have to learn how to "undo" those in git
> properly.)

A good way to apply patches is with the use of quilt. You can use the 'quilt import filename' to add
a patch file to the quilt database. You then use 'quilt push' to apply the patch to the source tree.
If there is a problem, your source is not messed up. To remove that patch file, use 'quilt pop'. If
you want to roll your own patch, use 'quilt new some_descriptive_name', then change the source by
using 'quilt edit source_file_name'. Once you have the source the way you want it, do a 'quilt
refresh' to create the updated patch file.


Larry


From mb at bu3sch.de  Thu Jan 11 21:10:04 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 11 Jan 2007 21:10:04 +0100
Subject: What is in bcm43xx-wireless-dev.git?
Message-ID: <200701112110.04311.mb@bu3sch.de>

In case you wonder what's the future of bcm43xx, here's
a list of changes in my bcm43xx development tree:

      bcm43xx-d80211: Add some PHY register definitions.
      bcm43xx-d80211: Move ILT stuff to OFDM table stuff
      bcm43xx-d80211: Remove PHY OFDM routing bit, if we are on A-PHY.
      bcm43xx-d80211: Merge new LO-control code.
      bcm43xx-d80211: Fix compilation: Missing files for LO and VSTACK.
      bcm43xx-d80211: Rename struct bcm43xx_phyinfo to struct bcm43xx_phy
      bcm43xx-d80211: merge struct bcm43xx_radioinfo into struct bcm43xx_phy
      bcm43xx-d80211: Merge all "radio" stuff into phy.c
      bcm43xx-d80211: Fix antenna selection for TX and RX.
      bcm43xx-d80211: Fix bogus LO validation failure.
      bcm43xx-d80211: Remove netpoll and ethtool stuff.
      Remove obsolete SSB driver library.
      Implement new SSB subsystem.
      bcm43xx-d80211: Port driver to the new SSB subsystem.

Well, that doesn't tell you anything, right?
Let's explain it:

Most significant changes are the new "LO" code and
the completely rewritten "SSB" subsystem.

The LO calibration code is not yet finished and contains
a few bugs, so it works _worse_ that the LO calibration
code that's in mainline kernel. But it's the first step
in the direction to support hwpctl cards (4318).

The other major change is the new SSB subsystem. This is
a big step in the embedded direction. The new SSB subsystem
makes it possible to run an (almost) vanilla (vanilla, as in
my tree, which is supposed to get merged upstream some time :))
kernel on broadcom MIPS based embedded WLAN routers (openWRT).

bcm43xx works on the new subsystem. A working b44 port is
available, but not included here. We might probably want to
merge that through jeff directly once this is upstream.
The SSB subsystem is able to boot my Linksys WRT54G.
Wireless and LAN with SSB based chips basically works.

So, what to do?
Next think will be to fix the LO code to make it ready
for upstream merge. I don't know if that means "making
4318 usable", too. Hopefully it does. Let's see. ;)

If you want to test this, get it from my repository.
If you have a linville-wireless-dev tree around, please
_don't_ clone my tree, but simply pull my stuff into
a seperate branch of that tree:

git branch crazy_stuff
git checkout crazy_stuff
git pull http://bu3sch.de/git/wireless-dev.git master

That will save lots of bandwidth. (Yours and mine) Thanks! ;)

Here's also a bzipped patch between today's linville-wireless-dev
and my tree. Yeah, it's huge, so not attached. :)

http://bu3sch.de/misc/linville_to_buesch_20070111.patch.bz2

-- 
Greetings Michael.


From radarsat1 at gmail.com  Fri Jan 12 00:02:08 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Thu, 11 Jan 2007 18:02:08 -0500
Subject: bcm4311 & wireless-2.6
In-Reply-To: <45A671F3.3080407@lwfinger.net>
References: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>
	<45A07701.3060909@lwfinger.net>
	<9b3e2dc20701102134m3f74be00x5a23f49be75cca83@mail.gmail.com>
	<45A671F3.3080407@lwfinger.net>
Message-ID: <9b3e2dc20701111502re915efbt44a6206b77f44943@mail.gmail.com>

Hi,

> Please run 'cat /proc/wireless' to see if interrupts are being delivered to the bcm43xx.

Do you mean /proc/interrupts?  My system has no /proc/wireless.
In any case, you are right, the new wireless-2.6 kernel reports 0
interrupts for bcm43xx.  The old one (which I'm using to type this),
reports an ever-increasing number of interrupts.

Thanks for the git and quilt tips, I'll keep them in my toolbox. :)

I've been looking at differences between the current version of
bcm43xx_main.c and older versions to see what has changed that might
cause it not to receive interrupts, but nothing jumps out at me just
yet.

Comparing the dmesg output between the two versions, it is virtually
identical. (With the addition of the "enabled by hardware" message..)

Steve


From Larry.Finger at lwfinger.net  Fri Jan 12 05:52:04 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 11 Jan 2007 22:52:04 -0600
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
Message-ID: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>

The PCI-E modifications to bcm43xx do not set up the interrupt vector
correctly.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This fix should be applied to wireless-2.6 _AND_ pushed upstream to
2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.

Larry


Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -2704,7 +2704,7 @@ static int bcm43xx_probe_cores(struct bc
 		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
 
 		/* extract core_id, core_rev, core_vendor */
-		core_id = (sb_id_hi & 0xFFF0) >> 4;
+		core_id = (sb_id_hi & 0x8FF0) >> 4;
 		core_rev = (sb_id_hi & 0xF);
 		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
 
@@ -2717,7 +2717,7 @@ static int bcm43xx_probe_cores(struct bc
 		case BCM43xx_COREID_PCIE:
 			core = &bcm->core_pci;
 			if (core->available) {
-				printk(KERN_WARNING PFX "Multiple PCI cores found.\n");
+				printk(KERN_WARNING PFX "Multiple PCI/PCI-E cores found.\n");
 				continue;
 			}
 			break;
@@ -2872,11 +2872,14 @@ static int bcm43xx_wireless_core_init(st
 	u32 sbimconfiglow;
 	u8 limit;
 
-	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id != BCM43xx_COREID_PCIE) {
+	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id == BCM43xx_COREID_PCI) {
 		sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
 		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
 		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
-		sbimconfiglow |= 0x32;
+		if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
+			sbimconfiglow |= 0x32;
+		else
+			sbimconfiglow |= 0x53;
 		bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
 	}
 
@@ -3070,6 +3073,7 @@ static int bcm43xx_setup_backplane_pci_c
 	u32 backplane_flag_nr;
 	u32 value;
 	struct bcm43xx_coreinfo *old_core;
+	struct bcm43xx_coreinfo *pci_core = &bcm->core_pci ;
 	int err = 0;
 
 	value = bcm43xx_read32(bcm, BCM43xx_CIR_SBTPSFLAG);
@@ -3080,26 +3084,22 @@ static int bcm43xx_setup_backplane_pci_c
 	if (err)
 		goto out;
 
-	if (bcm->current_core->rev < 6 ||
-		bcm->current_core->id == BCM43xx_COREID_PCI) {
-		value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
-		value |= (1 << backplane_flag_nr);
-		bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
-	} else {
+	if ((pci_core->rev >= 6) || (pci_core->id == BCM43xx_COREID_PCIE)) {
 		err = bcm43xx_pci_read_config32(bcm, BCM43xx_PCICFG_ICR, &value);
-		if (err) {
-			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
+		if (err)
 			goto out_switch_back;
-		}
 		value |= core_mask << 8;
 		err = bcm43xx_pci_write_config32(bcm, BCM43xx_PCICFG_ICR, value);
-		if (err) {
-			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
+		if (err)
 			goto out_switch_back;
-		}
+	} else {
+                err = -EINVAL;
+                value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
+		value |= 1 << backplane_flag_nr;
+                bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
 	}
 
-	if (bcm->current_core->id == BCM43xx_COREID_PCI) {
+	if (pci_core->id == BCM43xx_COREID_PCI) {
 		value = bcm43xx_read32(bcm, BCM43xx_PCICORE_SBTOPCI2);
 		value |= BCM43xx_SBTOPCI2_PREFETCH | BCM43xx_SBTOPCI2_BURST;
 		bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
@@ -3118,21 +3118,21 @@ static int bcm43xx_setup_backplane_pci_c
 			value |= BCM43xx_SBTOPCI2_MEMREAD_MULTI;
 			bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
 		}
-	} else {
-		if (bcm->current_core->rev == 0 || bcm->current_core->rev == 1) {
+	} else if (pci_core->id == BCM43xx_COREID_PCIE) {
+		if (pci_core->rev == 0 || pci_core->rev == 1) {
 			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_TLP_WORKAROUND);
 			value |= 0x8;
 			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_TLP_WORKAROUND,
 					       value);
 		}
-		if (bcm->current_core->rev == 0) {
+		if (pci_core->rev == 0) {
 			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
 						BCM43xx_SERDES_RXTIMER, 0x8128);
 			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
 						BCM43xx_SERDES_CDR, 0x0100);
 			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
 						BCM43xx_SERDES_CDR_BW, 0x1466);
-		} else if (bcm->current_core->rev == 1) {
+		} else if (pci_core->rev == 1) {
 			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_DLLP_LINKCTL);
 			value |= 0x40;
 			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_DLLP_LINKCTL,
@@ -3141,6 +3141,7 @@ static int bcm43xx_setup_backplane_pci_c
 	}
 out_switch_back:
 	err = bcm43xx_switch_core(bcm, old_core);
+	printk(KERN_ERR PFX "Error: ICR setup failure!\n");
 out:
 	return err;
 }

---


From larry.finger at lwfinger.net  Fri Jan 12 05:53:58 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 11 Jan 2007 22:53:58 -0600
Subject: bcm4311 & wireless-2.6
In-Reply-To: <9b3e2dc20701111502re915efbt44a6206b77f44943@mail.gmail.com>
References: <9b3e2dc20701061306q73a1df94o23665828c5c171d1@mail.gmail.com>	
	<45A07701.3060909@lwfinger.net>	
	<9b3e2dc20701102134m3f74be00x5a23f49be75cca83@mail.gmail.com>	
	<45A671F3.3080407@lwfinger.net>
	<9b3e2dc20701111502re915efbt44a6206b77f44943@mail.gmail.com>
Message-ID: <45A71466.5060302@lwfinger.net>

Stephen Sinclair wrote:
> Hi,
> 
>> Please run 'cat /proc/wireless' to see if interrupts are being
>> delivered to the bcm43xx.
> 
> Do you mean /proc/interrupts?  My system has no /proc/wireless.
> In any case, you are right, the new wireless-2.6 kernel reports 0
> interrupts for bcm43xx.  The old one (which I'm using to type this),
> reports an ever-increasing number of interrupts.

Of course I meant /proc/interrupts. Sorry.

> Thanks for the git and quilt tips, I'll keep them in my toolbox. :)
> 
> I've been looking at differences between the current version of
> bcm43xx_main.c and older versions to see what has changed that might
> cause it not to receive interrupts, but nothing jumps out at me just
> yet.
> 
> Comparing the dmesg output between the two versions, it is virtually
> identical. (With the addition of the "enabled by hardware" message..)

I just pushed a patch to fix the PCI-E interrupt problems. I'm currently using my BCM4311 to write
this message.

Larry



From joerg at alea.gnuu.de  Fri Jan 12 14:13:28 2007
From: joerg at alea.gnuu.de (=?iso-8859-1?Q?J=F6rg?= Sommer)
Date: Fri, 12 Jan 2007 14:13:28 +0100
Subject: bcm4306: Can't connect with WPA-EAP-TTLS
Message-ID: <20070112131328.GA11582@alea.gnuu.de>

Hi,

I've an iBook G4 with an Airport Extreme card[1]. I would like to connect
to a network with WAP-EAP-TTLS[2], but I can't establish the
connection[3]. The wpa_supplicant people told me that it looks like the
accesspoint does not respond or go offline, but from the people around me
I can't tell this. Nobody complains about an offline accesspoint.

Now the question is, can you tell me if something is wrong? I've put the
kernel log at [4].

Bye, J?rg.

[1]
  # lspci -s 10:12 -v
  0001:10:12.0 Network controller: Broadcom Corporation BCM4306 802.11b/g
   Wireless LAN Controller (rev 03)
        Subsystem: Apple Computer Inc. AirPort Extreme
        Flags: bus master, fast devsel, latency 16, IRQ 52
        Memory at 80084000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: [40] Power Management version 2

[2] http://www.uni-jena.de/Linux_Fedora_Core___Scientific_Linux_4_x_mit_WPA_EAP_TTLS_PAP.html
[3] http://www.minet.uni-jena.de/~joergs/wlan14.txt
[4] http://www.minet.uni-jena.de/~joergs/wlan14.dmesg
-- 
Ein Narr, er sieht die Weisheit nicht
selbst wenn sie n?rrisch zu ihm spricht.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 481 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070112/145620d5/attachment.pgp>

From mb at bu3sch.de  Fri Jan 12 15:06:06 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 15:06:06 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <1168586733.19023.19.camel@dv>
References: <200701112110.04311.mb@bu3sch.de> <1168586733.19023.19.camel@dv>
Message-ID: <200701121506.06461.mb@bu3sch.de>

On Friday 12 January 2007 08:25, Pavel Roskin wrote:
> Hello, Michael!
> 
> I've tried the master branch of bcm43xx-wireless-dev.git for the first
> time.  The results are not encouraging so far (although I'm quite new to
> this chipset).
> 
> drivers/ssb/driver_mips/mips.c includes asm/time.h, which is missing on
> x86_64.  It also refers to struct ssb_serial_ports, which is not defined
> anywhere.

Yeah, CONFIG_SSB_MIPS should depend on the MIPS CPU.
Which kconfig option do you suggest to make a "depend" on?

> drivers/ssb/driver_pci/pcicore.c refers to SSB_PCICORE_SBTOPCI1_CFG1
> that is not defined anywhere in the kernel.

Yeah, could be a typo. I'll have a look at it.

> I could send you huge logs, but I think it's already a clear sign that
> you didn't compile-test the current tree with CONFIG_SSB_DRIVER_MIPS
> enabled.  Things are better if it is disabled.

It is tested. But obviously on MIPS platform.

> In case you haven't seen those warnings:
> 
> /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c:843: warning: 'bcm43xx_wireless_core_mark_inactive' defined but not used
> /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c:3032: warning: 'bcm43xx_bluetooth_coext_enable' defined but not used

I am very well aware of these warnings, as they mark
unimplemented features.

> I could compile the code, and it even loaded as a module, but the kernel
> oopsed once I brought wlan0 up by ifconfig.
> 
> bcm43xx_d80211: Adding Interface type 2
> bcm43xx_d80211: Found PHY: Version 4, Type 2, Revision 8
> bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> bcm43xx_d80211: Loading firmware version 351.126 (2006-07-29 05:54:02)
> bcm43xx_d80211: Radio turned on
> bcm43xx_d80211: FIXME: Possibly broken code in bcm43xx_phy_initg() at /home/proski/src/linux-2.6/drivers/net/wireless/d80211/bcm43xx/bcm43xx_phy.c:1650
> bcm43xx_d80211: Chip initialized
> Unable to handle kernel NULL pointer dereference at 0000000000000000 RIP: 
>  [<ffffffff8021eee6>] dma_alloc_coherent+0x52/0x23f
> PGD 50d1067 PUD 5201067 PMD 0 
> Oops: 0000 [1] SMP 
> CPU 1 
> Modules linked in: bcm43xx_d80211 ssb
> Pid: 2623, comm: ifconfig Not tainted 2.6.20-rc3 #5
> RIP: 0010:[<ffffffff8021eee6>]  [<ffffffff8021eee6>] dma_alloc_coherent+0x52/0x23f
> RSP: 0018:ffff810005127bd8  EFLAGS: 00010206
> RAX: 0000000000000000 RBX: 0000000000003500 RCX: 00000000000010d4
> RDX: 00000000ffffffff RSI: 0000000000001000 RDI: ffff81000196c3a8
> RBP: 00000000000010d0 R08: ffff81001f6d1600 R09: 0000000000000004
> R10: 0000000000000001 R11: ffff810001122c60 R12: 0000000000001000
> R13: ffff810001b96000 R14: ffff81000196c3a8 R15: 00000000ffffffff
> FS:  00002b411b2133b0(0000) GS:ffff810001827440(0000) knlGS:0000000000000000
> CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
> CR2: 0000000000000000 CR3: 0000000015fdf000 CR4: 00000000000006e0
> Process ifconfig (pid: 2623, threadinfo ffff810005126000, task ffff81001f58d180)
> Stack:  ffff81001ee6a3c0 ffff81001ee6a3e8 ffff810001b96000 0000000000003500
>  ffff81001ee6a3c0 0000000000000080 ffff810001b96000 0000000000000000
>  0000000000000000 ffffffff88019966 0000000000000005 0000000100000036
> Call Trace:
>  [<ffffffff88019966>] :bcm43xx_d80211:bcm43xx_setup_dmaring+0x1a7/0x460
>  [<ffffffff88019ea3>] :bcm43xx_d80211:bcm43xx_dma_init+0xc0/0x290
>  [<ffffffff88008131>] :bcm43xx_d80211:bcm43xx_wireless_core_init+0x78f/0x9f1
>  [<ffffffff8022885e>] mntput_no_expire+0x19/0x77
>  [<ffffffff8020a3c3>] do_page_fault+0x40b/0x74a
>  [<ffffffff88009f4e>] :bcm43xx_d80211:bcm43xx_add_interface+0x67/0xeb
>  [<ffffffff804378d2>] ieee80211_open+0x1c6/0x2c5
>  [<ffffffff803fd3ec>] dev_open+0x2f/0x6e
>  [<ffffffff803fbcd5>] dev_change_flags+0x5a/0x119
>  [<ffffffff80423bab>] devinet_ioctl+0x235/0x59c
>  [<ffffffff803f4bef>] sock_ioctl+0x1c8/0x1e5
>  [<ffffffff8023b862>] do_ioctl+0x21/0x6b
>  [<ffffffff8022b614>] vfs_ioctl+0x25c/0x275
>  [<ffffffff8024559b>] sys_ioctl+0x3c/0x5c
>  [<ffffffff802548ee>] system_call+0x7e/0x83
> 
> 
> Code: 4c 23 38 49 39 d7 0f 46 e9 49 8d 44 24 ff 83 ca ff 49 89 c5 
> RIP  [<ffffffff8021eee6>] dma_alloc_coherent+0x52/0x23f
>  RSP <ffff810005127bd8>
> CR2: 0000000000000000

Hm, not sure why this oopses. It works on PPC (can transmit data and so on).

> It's Fedora Core 6 x86_64 on a Dell Latitude with Core 2 Duo and an PCIe
> wireless card.  SMP is enabled.  From .config:

PCIe is a seperate issue and not really supported by bcm43xx.

> CONFIG_BCM43XX_D80211=m
> CONFIG_BCM43XX_D80211_PCI=y
> CONFIG_BCM43XX_D80211_DEBUG=y
> CONFIG_BCM43XX_D80211_DMA=y
> CONFIG_BCM43XX_D80211_PIO=y
> CONFIG_BCM43XX_D80211_DMA_AND_PIO_MODE=y
> # CONFIG_BCM43XX_D80211_DMA_MODE is not set
> # CONFIG_BCM43XX_D80211_PIO_MODE is not set
> [skip]
> CONFIG_SSB=m
> # CONFIG_SSB_SILENT is not set
> # CONFIG_SSB_DEBUG is not set
> CONFIG_SSB_DRIVER_EXTIF=y

You can disable that. I think that should probably depend
on CONFIG_SSB_DRIVER_MIPS. I'll take a look.

> # CONFIG_SSB_DRIVER_MIPS is not set
> 
> [root at localhost proski]# lspci -v -s 0c:00.0
> 0c:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
>         Subsystem: Dell Unknown device 0007
>         Flags: bus master, fast devsel, latency 0, IRQ 17
>         Memory at efdfc000 (32-bit, non-prefetchable) [size=16K]
>         Capabilities: [40] Power Management version 2
>         Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0 Enable-
>         Capabilities: [d0] Express Legacy Endpoint IRQ 0
>         Capabilities: [100] Advanced Error Reporting
>         Capabilities: [13c] Virtual Channel
> 
> [root at localhost proski]# lspci -n -s 0c:00.0
> 0c:00.0 0280: 14e4:4312 (rev 01)
> [root at localhost proski]#
> 
> P.S.  Second attempt, this time with "pio=1" parameter.  At least it
> didn't crash, but it would not work either:

Does it work with linville's tree (in DMA mode)?

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jan 12 15:17:40 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 15:17:40 +0100
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
Message-ID: <200701121517.40539.mb@bu3sch.de>

On Friday 12 January 2007 05:52, Larry Finger wrote:
> The PCI-E modifications to bcm43xx do not set up the interrupt vector
> correctly.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This fix should be applied to wireless-2.6 _AND_ pushed upstream to
> 2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
> 
> Larry
> 
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -2704,7 +2704,7 @@ static int bcm43xx_probe_cores(struct bc
>  		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>  
>  		/* extract core_id, core_rev, core_vendor */
> -		core_id = (sb_id_hi & 0xFFF0) >> 4;
> +		core_id = (sb_id_hi & 0x8FF0) >> 4;

ACK. That one fixes a bug.

>  		core_rev = (sb_id_hi & 0xF);

This is also buggy. Should be something like:

	core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));

>  		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
>  
> @@ -2717,7 +2717,7 @@ static int bcm43xx_probe_cores(struct bc
>  		case BCM43xx_COREID_PCIE:
>  			core = &bcm->core_pci;
>  			if (core->available) {
> -				printk(KERN_WARNING PFX "Multiple PCI cores found.\n");
> +				printk(KERN_WARNING PFX "Multiple PCI/PCI-E cores found.\n");
>  				continue;
>  			}
>  			break;
> @@ -2872,11 +2872,14 @@ static int bcm43xx_wireless_core_init(st
>  	u32 sbimconfiglow;
>  	u8 limit;
>  
> -	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id != BCM43xx_COREID_PCIE) {
> +	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id == BCM43xx_COREID_PCI) {

That's semantically equal.

>  		sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
> -		sbimconfiglow |= 0x32;
> +		if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
> +			sbimconfiglow |= 0x32;
> +		else
> +			sbimconfiglow |= 0x53;

That used to be there until someone ripped it out (not me). Not sure why.

>  		bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
>  	}
>  
> @@ -3070,6 +3073,7 @@ static int bcm43xx_setup_backplane_pci_c
>  	u32 backplane_flag_nr;
>  	u32 value;
>  	struct bcm43xx_coreinfo *old_core;
> +	struct bcm43xx_coreinfo *pci_core = &bcm->core_pci ;
>  	int err = 0;
>  
>  	value = bcm43xx_read32(bcm, BCM43xx_CIR_SBTPSFLAG);
> @@ -3080,26 +3084,22 @@ static int bcm43xx_setup_backplane_pci_c
>  	if (err)
>  		goto out;
>  
> -	if (bcm->current_core->rev < 6 ||
> -		bcm->current_core->id == BCM43xx_COREID_PCI) {
> -		value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
> -		value |= (1 << backplane_flag_nr);
> -		bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
> -	} else {
> +	if ((pci_core->rev >= 6) || (pci_core->id == BCM43xx_COREID_PCIE)) {
>  		err = bcm43xx_pci_read_config32(bcm, BCM43xx_PCICFG_ICR, &value);
> -		if (err) {
> -			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
> +		if (err)
>  			goto out_switch_back;
> -		}
>  		value |= core_mask << 8;
>  		err = bcm43xx_pci_write_config32(bcm, BCM43xx_PCICFG_ICR, value);
> -		if (err) {
> -			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
> +		if (err)
>  			goto out_switch_back;
> -		}
> +	} else {
> +                err = -EINVAL;
> +                value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
> +		value |= 1 << backplane_flag_nr;
> +                bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
>  	}

The above doesn't change semantics. Or am I simply not seeing it? :)
Seems that it just shuffles the code.

>  
> -	if (bcm->current_core->id == BCM43xx_COREID_PCI) {
> +	if (pci_core->id == BCM43xx_COREID_PCI) {

That's semantically equal.

>  		value = bcm43xx_read32(bcm, BCM43xx_PCICORE_SBTOPCI2);
>  		value |= BCM43xx_SBTOPCI2_PREFETCH | BCM43xx_SBTOPCI2_BURST;
>  		bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
> @@ -3118,21 +3118,21 @@ static int bcm43xx_setup_backplane_pci_c
>  			value |= BCM43xx_SBTOPCI2_MEMREAD_MULTI;
>  			bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
>  		}
> -	} else {
> -		if (bcm->current_core->rev == 0 || bcm->current_core->rev == 1) {
> +	} else if (pci_core->id == BCM43xx_COREID_PCIE) {

That's redundant. If it's not a PCI core, it must be a PCIE core.

> +		if (pci_core->rev == 0 || pci_core->rev == 1) {

Semantically equal.

>  			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_TLP_WORKAROUND);
>  			value |= 0x8;
>  			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_TLP_WORKAROUND,
>  					       value);
>  		}
> -		if (bcm->current_core->rev == 0) {
> +		if (pci_core->rev == 0) {

dito

>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>  						BCM43xx_SERDES_RXTIMER, 0x8128);
>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>  						BCM43xx_SERDES_CDR, 0x0100);
>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>  						BCM43xx_SERDES_CDR_BW, 0x1466);
> -		} else if (bcm->current_core->rev == 1) {
> +		} else if (pci_core->rev == 1) {

dito

>  			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_DLLP_LINKCTL);
>  			value |= 0x40;
>  			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_DLLP_LINKCTL,
> @@ -3141,6 +3141,7 @@ static int bcm43xx_setup_backplane_pci_c
>  	}
>  out_switch_back:
>  	err = bcm43xx_switch_core(bcm, old_core);
> +	printk(KERN_ERR PFX "Error: ICR setup failure!\n");
>  out:
>  	return err;
>  }
> 
> ---
> 
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Jan 12 17:36:36 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 10:36:36 -0600
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <200701121517.40539.mb@bu3sch.de>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
	<200701121517.40539.mb@bu3sch.de>
Message-ID: <45A7B914.4030804@lwfinger.net>

Michael Buesch wrote:

I have one general question before I address your comments. Does a BCM43xx chip always have either a
PCI or a PCI-E core? I've seen discussion on this list that makes me wonder. That is why I had some
explicit tests for PCI-E in the code.

> On Friday 12 January 2007 05:52, Larry Finger wrote:
>> The PCI-E modifications to bcm43xx do not set up the interrupt vector
>> correctly.
>>
>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>> ---
>>
>> John,
>>
>> This fix should be applied to wireless-2.6 _AND_ pushed upstream to
>> 2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
>>
>> Larry
>>
>>
>> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>> ===================================================================
>> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
>> @@ -2704,7 +2704,7 @@ static int bcm43xx_probe_cores(struct bc
>>  		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>>  
>>  		/* extract core_id, core_rev, core_vendor */
>> -		core_id = (sb_id_hi & 0xFFF0) >> 4;
>> +		core_id = (sb_id_hi & 0x8FF0) >> 4;
> 
> ACK. That one fixes a bug.
> 
>>  		core_rev = (sb_id_hi & 0xF);
> 
> This is also buggy. Should be something like:
> 
> 	core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));

Is this in the specs?

>>  		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
>>  
>> @@ -2717,7 +2717,7 @@ static int bcm43xx_probe_cores(struct bc
>>  		case BCM43xx_COREID_PCIE:
>>  			core = &bcm->core_pci;
>>  			if (core->available) {
>> -				printk(KERN_WARNING PFX "Multiple PCI cores found.\n");
>> +				printk(KERN_WARNING PFX "Multiple PCI/PCI-E cores found.\n");
>>  				continue;
>>  			}
>>  			break;
>> @@ -2872,11 +2872,14 @@ static int bcm43xx_wireless_core_init(st
>>  	u32 sbimconfiglow;
>>  	u8 limit;
>>  
>> -	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id != BCM43xx_COREID_PCIE) {
>> +	if (bcm->core_pci.rev <= 5 && bcm->core_pci.id == BCM43xx_COREID_PCI) {
> 
> That's semantically equal.

True, as long as a particular chip has one or the other core.

>>  		sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
>>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
>>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
>> -		sbimconfiglow |= 0x32;
>> +		if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
>> +			sbimconfiglow |= 0x32;
>> +		else
>> +			sbimconfiglow |= 0x53;
> 
> That used to be there until someone ripped it out (not me). Not sure why.

I'm not sure either. I just found it in the wireless-dev code and in the specs, but not here.

>>  		bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
>>  	}
>>  
>> @@ -3070,6 +3073,7 @@ static int bcm43xx_setup_backplane_pci_c
>>  	u32 backplane_flag_nr;
>>  	u32 value;
>>  	struct bcm43xx_coreinfo *old_core;
>> +	struct bcm43xx_coreinfo *pci_core = &bcm->core_pci ;
>>  	int err = 0;
>>  
>>  	value = bcm43xx_read32(bcm, BCM43xx_CIR_SBTPSFLAG);
>> @@ -3080,26 +3084,22 @@ static int bcm43xx_setup_backplane_pci_c
>>  	if (err)
>>  		goto out;
>>  
>> -	if (bcm->current_core->rev < 6 ||
>> -		bcm->current_core->id == BCM43xx_COREID_PCI) {
>> -		value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
>> -		value |= (1 << backplane_flag_nr);
>> -		bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
>> -	} else {
>> +	if ((pci_core->rev >= 6) || (pci_core->id == BCM43xx_COREID_PCIE)) {
>>  		err = bcm43xx_pci_read_config32(bcm, BCM43xx_PCICFG_ICR, &value);
>> -		if (err) {
>> -			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
>> +		if (err)
>>  			goto out_switch_back;
>> -		}
>>  		value |= core_mask << 8;
>>  		err = bcm43xx_pci_write_config32(bcm, BCM43xx_PCICFG_ICR, value);
>> -		if (err) {
>> -			printk(KERN_ERR PFX "Error: ICR setup failure!\n");
>> +		if (err)
>>  			goto out_switch_back;
>> -		}
>> +	} else {
>> +                err = -EINVAL;
>> +                value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
>> +		value |= 1 << backplane_flag_nr;
>> +                bcm43xx_write32(bcm, BCM43xx_CIR_SBINTVEC, value);
>>  	}
> 
> The above doesn't change semantics. Or am I simply not seeing it? :)
> Seems that it just shuffles the code.

I thought so too and skipped over this section many times while trying to find the bug, but this is
the change that makes the interface work.

If the original structure was

if A or B
    clause 1
else
    clause 2

My patch changed it into

if not A or not B
    clause 2
else
    clause 1

Obviously, clause 2 will be executed if A or B is false. Accordingly, the test can be restructured into

if A && B
    clause 1
else
    clause 2

Now we can see the bug in the original. I always knew that the course in symbolic logic that I took
many decades ago was useful.

>> -	if (bcm->current_core->id == BCM43xx_COREID_PCI) {
>> +	if (pci_core->id == BCM43xx_COREID_PCI) {
> 
> That's semantically equal.

True. I can pull the pci_core out and substitute bcm->current_core for it.

>>  		value = bcm43xx_read32(bcm, BCM43xx_PCICORE_SBTOPCI2);
>>  		value |= BCM43xx_SBTOPCI2_PREFETCH | BCM43xx_SBTOPCI2_BURST;
>>  		bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
>> @@ -3118,21 +3118,21 @@ static int bcm43xx_setup_backplane_pci_c
>>  			value |= BCM43xx_SBTOPCI2_MEMREAD_MULTI;
>>  			bcm43xx_write32(bcm, BCM43xx_PCICORE_SBTOPCI2, value);
>>  		}
>> -	} else {
>> -		if (bcm->current_core->rev == 0 || bcm->current_core->rev == 1) {
>> +	} else if (pci_core->id == BCM43xx_COREID_PCIE) {
> 
> That's redundant. If it's not a PCI core, it must be a PCIE core.
> 
>> +		if (pci_core->rev == 0 || pci_core->rev == 1) {
> 
> Semantically equal.

True.
> 
>>  			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_TLP_WORKAROUND);
>>  			value |= 0x8;
>>  			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_TLP_WORKAROUND,
>>  					       value);
>>  		}
>> -		if (bcm->current_core->rev == 0) {
>> +		if (pci_core->rev == 0) {
> 
> dito
> 
>>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>>  						BCM43xx_SERDES_RXTIMER, 0x8128);
>>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>>  						BCM43xx_SERDES_CDR, 0x0100);
>>  			bcm43xx_pcie_mdio_write(bcm, BCM43xx_MDIO_SERDES_RX,
>>  						BCM43xx_SERDES_CDR_BW, 0x1466);
>> -		} else if (bcm->current_core->rev == 1) {
>> +		} else if (pci_core->rev == 1) {
> 
> dito
> 
>>  			value = bcm43xx_pcie_reg_read(bcm, BCM43xx_PCIE_DLLP_LINKCTL);
>>  			value |= 0x40;
>>  			bcm43xx_pcie_reg_write(bcm, BCM43xx_PCIE_DLLP_LINKCTL,
>> @@ -3141,6 +3141,7 @@ static int bcm43xx_setup_backplane_pci_c
>>  	}
>>  out_switch_back:
>>  	err = bcm43xx_switch_core(bcm, old_core);
>> +	printk(KERN_ERR PFX "Error: ICR setup failure!\n");
>>  out:
>>  	return err;
>>  }
>>
>> ---
>>
>>
> 

I will submit a revised patch as soon as I sort out the core_rev situation.

Larry



From mb at bu3sch.de  Fri Jan 12 17:53:05 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 17:53:05 +0100
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45A7B914.4030804@lwfinger.net>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
	<200701121517.40539.mb@bu3sch.de> <45A7B914.4030804@lwfinger.net>
Message-ID: <200701121753.06014.mb@bu3sch.de>

On Friday 12 January 2007 17:36, Larry Finger wrote:
> Michael Buesch wrote:
> 
> I have one general question before I address your comments. Does a BCM43xx chip always have either a
> PCI or a PCI-E core? I've seen discussion on this list that makes me wonder. That is why I had some
> explicit tests for PCI-E in the code.

Ok, I see your point.
I don't think we have devices without PCI core.
BUT:
If you think there are devices without a PCI core, you
must not switch to it in the first place. So your check is
worthless nevertheless, because in case of no PCI core you
have crashed much earlier anyway. ;)

If we have a PCI core (and I think we always have), it can only
be PCI or PCIE.

-- 
Greetings Michael.


From radarsat1 at gmail.com  Fri Jan 12 18:54:34 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Fri, 12 Jan 2007 12:54:34 -0500
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <200701121517.40539.mb@bu3sch.de>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
	<200701121517.40539.mb@bu3sch.de>
Message-ID: <9b3e2dc20701120954p148be007o19e1b48a4032094@mail.gmail.com>

> That's redundant. If it's not a PCI core, it must be a PCIE core.

Not to be too blunt, but isn't that sort of sloppy logic?
Imho it's always better to check what something _is_ rather than what
something _isn't_.
The two are only semantically the same in a binary universe. (i.e.,
PCI vs. PCI-E)
Of course that's the case right now, but the former logic is more future-proof.

just my 2c.

Steve


From Larry.Finger at lwfinger.net  Fri Jan 12 19:08:50 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 12:08:50 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
Message-ID: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>

The PCI-E modifications to bcm43xx do not set up the interrupt vector
correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This fix should be applied to wireless-2.6 _AND_ pushed upstream to
2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
This version incorporates Michael Buesch's comments, and forgoes some
code clean-ups that were in the first version/

Larry


Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -2704,8 +2704,8 @@ static int bcm43xx_probe_cores(struct bc
 		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
 
 		/* extract core_id, core_rev, core_vendor */
-		core_id = (sb_id_hi & 0xFFF0) >> 4;
-		core_rev = (sb_id_hi & 0xF);
+		core_id = (sb_id_hi & 0x8FF0) >> 4;
+		core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
 		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
 
 		dprintk(KERN_INFO PFX "Core %d: ID 0x%x, rev 0x%x, vendor 0x%x\n",
@@ -2876,7 +2876,10 @@ static int bcm43xx_wireless_core_init(st
 		sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
 		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
 		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
-		sbimconfiglow |= 0x32;
+		if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
+			sbimconfiglow |= 0x32;
+		else
+			sbimconfiglow |= 0x53;
 		bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
 	}
 
@@ -3080,7 +3083,7 @@ static int bcm43xx_setup_backplane_pci_c
 	if (err)
 		goto out;
 
-	if (bcm->current_core->rev < 6 ||
+	if (bcm->current_core->rev < 6 &&
 		bcm->current_core->id == BCM43xx_COREID_PCI) {
 		value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
 		value |= (1 << backplane_flag_nr);

---


From radarsat1 at gmail.com  Fri Jan 12 19:50:44 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Fri, 12 Jan 2007 13:50:44 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
Message-ID: <9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>

> The PCI-E modifications to bcm43xx do not set up the interrupt vector
> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.

This was successful for me.  My 4311 is now getting interrupts, and I
was able to successfully associate with an AP.  (i386)


Steve


From mb at bu3sch.de  Fri Jan 12 19:53:44 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 19:53:44 +0100
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
Message-ID: <200701121953.44630.mb@bu3sch.de>

On Friday 12 January 2007 19:08, Larry Finger wrote:
> The PCI-E modifications to bcm43xx do not set up the interrupt vector
> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>

ACK.

> ---
> 
> John,
> 
> This fix should be applied to wireless-2.6 _AND_ pushed upstream to
> 2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
> This version incorporates Michael Buesch's comments, and forgoes some
> code clean-ups that were in the first version/
> 
> Larry
> 
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -2704,8 +2704,8 @@ static int bcm43xx_probe_cores(struct bc
>  		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>  
>  		/* extract core_id, core_rev, core_vendor */
> -		core_id = (sb_id_hi & 0xFFF0) >> 4;
> -		core_rev = (sb_id_hi & 0xF);
> +		core_id = (sb_id_hi & 0x8FF0) >> 4;
> +		core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
>  		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
>  
>  		dprintk(KERN_INFO PFX "Core %d: ID 0x%x, rev 0x%x, vendor 0x%x\n",
> @@ -2876,7 +2876,10 @@ static int bcm43xx_wireless_core_init(st
>  		sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
>  		sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
> -		sbimconfiglow |= 0x32;
> +		if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
> +			sbimconfiglow |= 0x32;
> +		else
> +			sbimconfiglow |= 0x53;

This hunk is OK, but I just want to point out that bustype is
always equal to BCM43xx_BUSTYPE_PCI ;)
The 0x53 timeouts are for an SSB-BUS.
So strictly said this hunk is a NOP.

The other hunks are OK, too. They fix real bugs.
Thanks for spotting them, Larry!

>  		bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
>  	}
>  
> @@ -3080,7 +3083,7 @@ static int bcm43xx_setup_backplane_pci_c
>  	if (err)
>  		goto out;
>  
> -	if (bcm->current_core->rev < 6 ||
> +	if (bcm->current_core->rev < 6 &&
>  		bcm->current_core->id == BCM43xx_COREID_PCI) {
>  		value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
>  		value |= (1 << backplane_flag_nr);
> 
> ---
> 
> 

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jan 12 19:59:45 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 19:59:45 +0100
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <9b3e2dc20701120954p148be007o19e1b48a4032094@mail.gmail.com>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
	<200701121517.40539.mb@bu3sch.de>
	<9b3e2dc20701120954p148be007o19e1b48a4032094@mail.gmail.com>
Message-ID: <200701121959.45756.mb@bu3sch.de>

On Friday 12 January 2007 18:54, Stephen Sinclair wrote:
> > That's redundant. If it's not a PCI core, it must be a PCIE core.
> 
> Not to be too blunt, but isn't that sort of sloppy logic?
> Imho it's always better to check what something _is_ rather than what
> something _isn't_.
> The two are only semantically the same in a binary universe. (i.e.,
> PCI vs. PCI-E)
> Of course that's the case right now, but the former logic is more future-proof.

Heh, well, I see your point, but I don't think explicitely
checking for PCI/E cores here does any good, because even if
we specialcase the two core types it will break as soon as
a new PCI-foobar core/bus is released. ;)
So it's broken in either way. Maybe your way is less broken
then mine, or not. But does that really matter, if it crashes
in either way? hehe :)

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jan 12 20:01:45 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 20:01:45 +0100
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
Message-ID: <200701122001.45546.mb@bu3sch.de>

On Friday 12 January 2007 19:50, Stephen Sinclair wrote:
> > The PCI-E modifications to bcm43xx do not set up the interrupt vector
> > correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
> 
> This was successful for me.  My 4311 is now getting interrupts, and I
> was able to successfully associate with an AP.  (i386)

That does the (i386) mean here?
Were you able to accociate with your PCI or PCI-E card?

-- 
Greetings Michael.


From evanfoss at gmail.com  Fri Jan 12 20:18:51 2007
From: evanfoss at gmail.com (evan foss)
Date: Fri, 12 Jan 2007 14:18:51 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <200701121953.44630.mb@bu3sch.de>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<200701121953.44630.mb@bu3sch.de>
Message-ID: <4a55afb80701121118r342ec98s8b3312b8c7e59e85@mail.gmail.com>

> This hunk is OK, but I just want to point out that bustype is
> always equal to BCM43xx_BUSTYPE_PCI ;)
> The 0x53 timeouts are for an SSB-BUS.
> So strictly said this hunk is a NOP.
>
> The other hunks are OK, too. They fix real bugs.
> Thanks for spotting them, Larry!

So then what fixed int's for Stephen Sinclair? Or did they already
work? I would gladly help test I knew it applied to me.

>> The PCI-E modifications to bcm43xx do not set up the interrupt vector
>> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
>
>This was successful for me.  My 4311 is now getting interrupts, and I
>was able to successfully associate with an AP.  (i386)


-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From Larry.Finger at lwfinger.net  Fri Jan 12 20:22:14 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 13:22:14 -0600
Subject: Various patches for PCI-E and radio-enable switches
Message-ID: <45A7DFE6.1060304@lwfinger.net>

As noted in this list earlier today, there is now a patch that makes PCI-E interfaces work. It has
only been tested with Dell Wireless 1390 cards (BCM4311), but should also work for BCM4312s. The
receive level for the 4311 is excellent, but the transmit levels are very weak. Copying of a test
file of mine takes 7 sec. with a BCM4306. With the BCM4311, it takes a little over 3 minutes given
the retransmits, etc. Now that the card works (?), my next step is to try to find why the radio has
such low power.

I just ordered additional memory for my laptop and will concentrate on the RAM > 1GB problem for
cards with 30-bit DMA. I tried to debug this remotely, but didn't get very far.

The corrected PCI-E patches have been uploaded to ftp://lwfinger.dynalias.org/patches. There are
versions for 2.6.18 and 2.6.19. That site also has the patches needed to operate the hardware radio
enable switch and the associated LED.

Larry


From larry.finger at lwfinger.net  Fri Jan 12 20:27:33 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 13:27:33 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <200701122001.45546.mb@bu3sch.de>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
	<200701122001.45546.mb@bu3sch.de>
Message-ID: <45A7E125.8030009@lwfinger.net>

Michael Buesch wrote:
> On Friday 12 January 2007 19:50, Stephen Sinclair wrote:
>>> The PCI-E modifications to bcm43xx do not set up the interrupt vector
>>> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
>> This was successful for me.  My 4311 is now getting interrupts, and I
>> was able to successfully associate with an AP.  (i386)
> 
> That does the (i386) mean here?
> Were you able to accociate with your PCI or PCI-E card?

Stephen has an i386 system with a PCI-E 4311. The PCI card on i386 was mine, which I tested to make
sure the logic change didn't break the old systems. The display on my old laptop died and wasn't
worth fixing; however, I ssh into it to test on a PCI system.

Larry




From larry.finger at lwfinger.net  Fri Jan 12 20:30:32 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 13:30:32 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <4a55afb80701121118r342ec98s8b3312b8c7e59e85@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>	<200701121953.44630.mb@bu3sch.de>
	<4a55afb80701121118r342ec98s8b3312b8c7e59e85@mail.gmail.com>
Message-ID: <45A7E1D8.40904@lwfinger.net>

evan foss wrote:
>> This hunk is OK, but I just want to point out that bustype is
>> always equal to BCM43xx_BUSTYPE_PCI ;)
>> The 0x53 timeouts are for an SSB-BUS.
>> So strictly said this hunk is a NOP.
>>
>> The other hunks are OK, too. They fix real bugs.
>> Thanks for spotting them, Larry!
> 
> So then what fixed int's for Stephen Sinclair? Or did they already
> work? I would gladly help test I knew it applied to me.

The lack of int's was due to the bugs mentioned above. His interface didn't work until he applied
the patch, which I hope fixes everyone's PCI-E problems. Please do test.

Larry



From mb at bu3sch.de  Fri Jan 12 20:42:57 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 20:42:57 +0100
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <45A7DFE6.1060304@lwfinger.net>
References: <45A7DFE6.1060304@lwfinger.net>
Message-ID: <200701122042.57409.mb@bu3sch.de>

On Friday 12 January 2007 20:22, Larry Finger wrote:
> As noted in this list earlier today, there is now a patch that makes PCI-E interfaces work. It has
> only been tested with Dell Wireless 1390 cards (BCM4311), but should also work for BCM4312s. The
> receive level for the 4311 is excellent, but the transmit levels are very weak. Copying of a test
> file of mine takes 7 sec. with a BCM4306. With the BCM4311, it takes a little over 3 minutes given
> the retransmits, etc. Now that the card works (?), my next step is to try to find why the radio has
> such low power.

It is the same problem as with the 4318 cards.

-- 
Greetings Michael.


From radarsat1 at gmail.com  Fri Jan 12 20:59:31 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Fri, 12 Jan 2007 14:59:31 -0500
Subject: [PATCH] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <200701121959.45756.mb@bu3sch.de>
References: <45a713f4.CVklfeegOYfmrIW+%Larry.Finger@lwfinger.net>
	<200701121517.40539.mb@bu3sch.de>
	<9b3e2dc20701120954p148be007o19e1b48a4032094@mail.gmail.com>
	<200701121959.45756.mb@bu3sch.de>
Message-ID: <9b3e2dc20701121159w7583c9c6v4455c581774bc977@mail.gmail.com>

> then mine, or not. But does that really matter, if it crashes
> in either way? hehe :)

Point taken. ;-)

Steve


From larry.finger at lwfinger.net  Fri Jan 12 21:26:27 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 14:26:27 -0600
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <200701122042.57409.mb@bu3sch.de>
References: <45A7DFE6.1060304@lwfinger.net> <200701122042.57409.mb@bu3sch.de>
Message-ID: <45A7EEF3.7000408@lwfinger.net>

Michael Buesch wrote:
> On Friday 12 January 2007 20:22, Larry Finger wrote:
>> As noted in this list earlier today, there is now a patch that makes PCI-E interfaces work. It has
>> only been tested with Dell Wireless 1390 cards (BCM4311), but should also work for BCM4312s. The
>> receive level for the 4311 is excellent, but the transmit levels are very weak. Copying of a test
>> file of mine takes 7 sec. with a BCM4306. With the BCM4311, it takes a little over 3 minutes given
>> the retransmits, etc. Now that the card works (?), my next step is to try to find why the radio has
>> such low power.
> 
> It is the same problem as with the 4318 cards.
> 

I think (and hope) so. I didn't get much time with the 4318 card before my laptop died, and I have
an Express Card slot on the new one, not a PCMCIA slot. Technology moves too quickly sometimes. I
can still test the 4318 in the old computer, but it won't be easy to debug there.

Do you have any thoughts/tentative fixes?

Larry



From mb at bu3sch.de  Fri Jan 12 21:35:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 12 Jan 2007 21:35:01 +0100
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <45A7EEF3.7000408@lwfinger.net>
References: <45A7DFE6.1060304@lwfinger.net> <200701122042.57409.mb@bu3sch.de>
	<45A7EEF3.7000408@lwfinger.net>
Message-ID: <200701122135.01223.mb@bu3sch.de>

On Friday 12 January 2007 21:26, Larry Finger wrote:
> Michael Buesch wrote:
> > On Friday 12 January 2007 20:22, Larry Finger wrote:
> >> As noted in this list earlier today, there is now a patch that makes PCI-E interfaces work. It has
> >> only been tested with Dell Wireless 1390 cards (BCM4311), but should also work for BCM4312s. The
> >> receive level for the 4311 is excellent, but the transmit levels are very weak. Copying of a test
> >> file of mine takes 7 sec. with a BCM4306. With the BCM4311, it takes a little over 3 minutes given
> >> the retransmits, etc. Now that the card works (?), my next step is to try to find why the radio has
> >> such low power.
> > 
> > It is the same problem as with the 4318 cards.
> > 
> 
> I think (and hope) so. I didn't get much time with the 4318 card before my laptop died, and I have
> an Express Card slot on the new one, not a PCMCIA slot. Technology moves too quickly sometimes. I
> can still test the 4318 in the old computer, but it won't be easy to debug there.
> 
> Do you have any thoughts/tentative fixes?

At the moment I am working on the new LO stuff in my tree.
It's horribly broken, but that's the way to fix it.
It seems to be completely non-working on my 4318. Let's see why...
I think there are a bunch of typos in the magic PHY register stuff.
Sometimes a single swapped number makes the operation completely broken.

-- 
Greetings Michael.


From clearscreen at lycantrope.com  Fri Jan 12 21:32:59 2007
From: clearscreen at lycantrope.com (Daniel)
Date: Fri, 12 Jan 2007 21:32:59 +0100
Subject: Various patches for PCI-E and radio-enable switches
References: <45A7DFE6.1060304@lwfinger.net> <200701122042.57409.mb@bu3sch.de>
	<45A7EEF3.7000408@lwfinger.net>
Message-ID: <000701c73688$da17e640$0601a8c0@daniel5234ab92>

I know it's working out of the box, but could I still make a developper 
happy with an asus wl-100g? Recently replaced it with a Netgear WG500T 



From ftoledo at docksud.com.ar  Fri Jan 12 21:52:17 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Fri, 12 Jan 2007 17:52:17 -0300
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
Message-ID: <45A7F501.9080202@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Stephen Sinclair escribi?:
>> The PCI-E modifications to bcm43xx do not set up the interrupt vector
>> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
> 
> This was successful for me.  My 4311 is now getting interrupts, and I
> was able to successfully associate with an AP.  (i386)
> 
> 
> Steve
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> 
succefully for me to!!!
i can see my blue led on for first time! =)

i apply the two patches from larry in the 2.6.19.1, the radio button now
works to (hp nx7400)

10:00.0 Network controller: Broadcom Corporation Dell Wireless 1390 WLAN
Mini-PCI Card (rev 01)
        Subsystem: Hewlett-Packard Company Unknown device 1364
        Flags: bus master, fast devsel, latency 0, IRQ 17
        Memory at f4000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit-
Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0


sometimes, still can't connect, the bit rate still 1MB, but then work
fine now.

thanks for the work.


-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFp/UBz8H9Vs7bTsMRAtUgAJ4oAqK1wfsYB0FKGpMgRNyaasRyUQCg1WME
4psNYaB/PTvte0/dRIf8xtQ=
=Gcgz
-----END PGP SIGNATURE-----


From larry.finger at lwfinger.net  Fri Jan 12 22:13:40 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 12 Jan 2007 15:13:40 -0600
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <000701c73688$da17e640$0601a8c0@daniel5234ab92>
References: <45A7DFE6.1060304@lwfinger.net>
	<200701122042.57409.mb@bu3sch.de>	<45A7EEF3.7000408@lwfinger.net>
	<000701c73688$da17e640$0601a8c0@daniel5234ab92>
Message-ID: <45A7FA04.60802@lwfinger.net>

Daniel wrote:
> I know it's working out of the box, but could I still make a developper 
> happy with an asus wl-100g? Recently replaced it with a Netgear WG500T 

What is the chip in the wl-100g? The web told me it is Broadcom, but not the flavor.

Larry


From radarsat1 at gmail.com  Fri Jan 12 22:27:18 2007
From: radarsat1 at gmail.com (Stephen Sinclair)
Date: Fri, 12 Jan 2007 16:27:18 -0500
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <45A7FA04.60802@lwfinger.net>
References: <45A7DFE6.1060304@lwfinger.net> <200701122042.57409.mb@bu3sch.de>
	<45A7EEF3.7000408@lwfinger.net>
	<000701c73688$da17e640$0601a8c0@daniel5234ab92>
	<45A7FA04.60802@lwfinger.net>
Message-ID: <9b3e2dc20701121327q42a1bb50x14f94ab4f356b638@mail.gmail.com>

On 1/12/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Daniel wrote:
> > I know it's working out of the box, but could I still make a developper
> > happy with an asus wl-100g? Recently replaced it with a Netgear WG500T
>
> What is the chip in the wl-100g? The web told me it is Broadcom, but not the flavor.


A couple of sites I saw reported that it uses 4306.

For example:
http://www.network-drivers.com/drivers/266/266693.htm

Steve


From clearscreen at lycantrope.com  Fri Jan 12 23:32:01 2007
From: clearscreen at lycantrope.com (Daniel)
Date: Fri, 12 Jan 2007 23:32:01 +0100
Subject: Various patches for PCI-E and radio-enable switches
References: <45A7DFE6.1060304@lwfinger.net>
	<200701122042.57409.mb@bu3sch.de><45A7EEF3.7000408@lwfinger.net><000701c73688$da17e640$0601a8c0@daniel5234ab92><45A7FA04.60802@lwfinger.net>
	<9b3e2dc20701121327q42a1bb50x14f94ab4f356b638@mail.gmail.com>
Message-ID: <000901c73699$7ac97df0$0601a8c0@daniel5234ab92>

http://bcm43xx.berlios.de/?go=devices
Shows me 4306 aswell, with 4306 PCI/Cardbus Supported. I guess it is not 
needed then?

----- Original Message ----- 
From: "Stephen Sinclair" <radarsat1 at gmail.com>
To: <bcm43xx-dev at lists.berlios.de>
Sent: Friday, January 12, 2007 10:27 PM
Subject: Re: Various patches for PCI-E and radio-enable switches


> On 1/12/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>> Daniel wrote:
>> > I know it's working out of the box, but could I still make a developper
>> > happy with an asus wl-100g? Recently replaced it with a Netgear WG500T
>>
>> What is the chip in the wl-100g? The web told me it is Broadcom, but not 
>> the flavor.
>
>
> A couple of sites I saw reported that it uses 4306.
>
> For example:
> http://www.network-drivers.com/drivers/266/266693.htm
>
> Steve
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev 



From evanfoss at gmail.com  Fri Jan 12 23:59:15 2007
From: evanfoss at gmail.com (evan foss)
Date: Fri, 12 Jan 2007 17:59:15 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45A7F501.9080202@docksud.com.ar>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
	<45A7F501.9080202@docksud.com.ar>
Message-ID: <4a55afb80701121459q4f23083t6f92a7e3bc85ccb1@mail.gmail.com>

>You can get the 2.6.18 patches from
ftp://lwfinger.dynalias.org/patches. You will need the PCI-E
>patch for 2.6.18.1, and will probably want the
patch_2.6.18.1_fix_leds and radio_hwenable_for_2.6.18
>patches if your radio has a switch.

Thank you I will try it when I get the time.

-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From gene.heskett at verizon.net  Sat Jan 13 04:15:27 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 12 Jan 2007 22:15:27 -0500
Subject: nm vs wireless on my lappy
In-Reply-To: <1168484438.19899.20.camel@dhollis-lnx.sunera.com>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701101955.51080.gene.heskett@verizon.net>
	<1168484438.19899.20.camel@dhollis-lnx.sunera.com>
Message-ID: <200701122215.27704.gene.heskett@verizon.net>


The following is a message I'd posted to the fedora list earlier, with few 
replies.

On Wednesday 10 January 2007 22:00, David Hollis wrote:
>On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
>> >On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
>> >> Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for
>> >> microcode
>> >> rev > 0x128
>> >
>> >I don't know anything about the bcm43xx driver, but this line does
>> > seem interesting.  Do you have the extracted firmware available?
>>
>> The 'extracted firmware' would be what is wrapped up in ndiswrapper.
>> There is also an alpha quality driver in the kernel tree, and that is
>> the one that is the src of that particular message.  The extracted
>> windows driver doesn't report that.
>
>Check out http://bcm43xx.berlios.de/
>
Hmm, it would appear we've /.'d them.

However, I believe I did that last spring, using the driver directly from 
the windows partition, and that all the files are now resident 
in /lib/firmware.  Here is a listing of that directory:

total 7352
-rwxrw-rw- 1 root root  757760 Nov 28  2005 bcm1xsup.dll
-rwxrw-rw- 1 root root    9948 Nov 28  2005 bcm43xx.cat
-rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval01.fw
-rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval02.fw
-rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval03.fw
-rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval04.fw
-rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval05.fw
-rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval06.fw
-rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval07.fw
-rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval08.fw
-rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval09.fw
-rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval10.fw
-rw-r--r-- 1 root root   20200 Jul  7  2006 bcm43xx_microcode2.fw
-rw-r--r-- 1 root root   22352 Jul  7  2006 bcm43xx_microcode4.fw
-rw-r--r-- 1 root root   23184 Jul  7  2006 bcm43xx_microcode5.fw
-rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm4.fw
-rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm5.fw
-rwxrw-rw- 1 root root  658896 Nov 28  2005 bcmwl5.inf
-rwxrw-rw- 1 root root  379840 Feb 14  2006 bcmwl5.PNF
-rwxrw-rw- 1 root root  424320 Nov 28  2005 bcmwl5.sys
-rwxrw-rw- 1 root root   81920 Nov 28  2005 bcmwliss.dll
-rwxrw-rw- 1 root root   33664 Nov 28  2005 bcmwlnpf.sys
-rwxrw-rw- 1 root root   69632 Nov 28  2005 bcmwlpkt.dll
-rwxrw-rw- 1 root root  122880 Nov 28  2005 bcmwls32.exe
-rwxrw-rw- 1 root root   22672 Nov 28  2005 bcmwls.ini
-rwxrw-rw- 1 root root  176128 Nov 28  2005 bcmwlu00.exe
-rwxrw-rw- 1 root root 2313329 Nov 28  2005 data1.cab
-rwxrw-rw- 1 root root   36304 Nov 28  2005 data1.hdr
-rwxrw-rw- 1 root root     512 Nov 28  2005 data2.cab
-rw-r--r-- 1 root root  658896 Apr 17  2006 gene.inf
-rwxrw-rw- 1 root root  346602 Nov 28  2005 ikernel.ex_
-rwxrw-rw- 1 root root    6200 Feb 14  2006 INFCACHE.1
-rwxrw-rw- 1 root root  168448 Nov 28  2005 is.exe
-rwxrw-rw- 1 root root  658896 Nov 28  2005 jene
-rwxrw-rw- 1 root root      28 Nov 28  2005 launcher.ini
-rwxrw-rw- 1 root root     417 Nov 28  2005 layout.bin
-rw-r--r-- 1 root root       0 Jan 10 22:29 ~lib-firm-dir-contents
-rwxrw-rw- 1 root root   45056 Nov 28  2005 setup.exe
-rwxrw-rw- 1 root root     595 Nov 28  2005 Setup.ini
-rwxrw-rw- 1 root root  162610 Nov 28  2005 setup.inx
-rwxrw-rw- 1 root root     628 Nov 28  2005 setup.iss
-rwxrw-rw- 1 root root    3485 Nov 28  2005 sp29842.cva


>You should find a bcm43xx-fwcutter utility (actually, it looks like its
>in Extras so you can yum it too).  Run that against the .SYS file you
>have from Windows to extract the firmware.  Then the bcm43xx driver
>should be able to operate and you can toss ndiswrapper out the window.

Does not the above satisfy the bcm43xx drivers firmware requirements?
Recall from the earlier post, that a "modprobe bcm43xx" returns no error 
on the cli, and that this is the log from that action:

Jan 10 16:04:21 diablo kernel: ieee80211: 802.11 data/management/control 
stack, git-1.1.13
Jan 10 16:04:21 diablo kernel: ieee80211: Copyright (C) 2004-2005 Intel 
Corporation <jketreno at linux.intel.com>
Jan 10 16:04:21 diablo kernel: bcm43xx driver
Jan 10 16:04:21 diablo kernel: ACPI: PCI Interrupt 0000:03:02.0[A] -> Link 
[LNKF] -> GSI 10 (level, low) -> IRQ 10
Jan 10 16:04:21 diablo kernel: bcm43xx: Chip ID 0x4318, rev 0x2
Jan 10 16:04:21 diablo kernel: bcm43xx: Number of cores: 4
Jan 10 16:04:21 diablo kernel: bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 
0x4243, enabled
Jan 10 16:04:21 diablo kernel: bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 
0x4243, disabled
Jan 10 16:04:21 diablo kernel: bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 
0x4243, enabled
Jan 10 16:04:21 diablo kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 
0x4243, enabled
Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
Jan 10 16:04:21 diablo kernel: bcm43xx: Detected PHY: Version: 3, Type 2, 
Revision 7
Jan 10 16:04:21 diablo kernel: bcm43xx: Detected Radio: ID: 8205017f 
(Manuf: 17f Ver: 2050 Rev: 8)
Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
Jan 10 16:04:21 diablo kernel: SoftMAC: ASSERTION FAILED (0) at: 
net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
Jan 10 16:04:21 diablo kernel: bcm43xx: set security called, .level = 
0, .enabled = 0, .encrypt = 0
Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: Scanning for networks 
first.
Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: failed to initiate 
scan. Is device up?
Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66 
(2005-10-15  22:46:19)
Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for microcode 
rev > 0x128
Jan 10 16:04:21 diablo kernel: bcm43xx: core_up for active 802.11 core 
failed (-1)
Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
Jan 10 16:04:38 diablo kernel: bcm43xx: set security called, .level = 
0, .enabled = 0, .encrypt = 0
Jan 10 16:04:38 diablo kernel: SoftMAC: Canceling existing associate 
request!
Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: Scanning for networks 
first.
Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: failed to initiate 
scan. Is device up?
Jan 10 16:04:38 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66 
(2005-10-15  22:46:19)
Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for microcode 
rev > 0x128
Jan 10 16:04:38 diablo kernel: bcm43xx: core_up for active 802.11 core 
failed (-1)


It was the 004-1.fc5 version of that utility I used at the time.  I have 
NDI where I got it at the time, but obviously from the 'fc5' in its name, 
it is probably the one from extras.

So what do I do next?

Thanks.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.



From larry.finger at lwfinger.net  Sat Jan 13 07:47:19 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 13 Jan 2007 00:47:19 -0600
Subject: nm vs wireless on my lappy
In-Reply-To: <200701122215.27704.gene.heskett@verizon.net>
References: <200701101648.24461.gene.heskett@verizon.net>	<200701101955.51080.gene.heskett@verizon.net>	<1168484438.19899.20.camel@dhollis-lnx.sunera.com>
	<200701122215.27704.gene.heskett@verizon.net>
Message-ID: <45A88077.3020807@lwfinger.net>

Gene Heskett wrote:
> The following is a message I'd posted to the fedora list earlier, with few 
> replies.
> 
> On Wednesday 10 January 2007 22:00, David Hollis wrote:
>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
>>>>> Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for
>>>>> microcode
>>>>> rev > 0x128
>>>> I don't know anything about the bcm43xx driver, but this line does
>>>> seem interesting.  Do you have the extracted firmware available?
>>> The 'extracted firmware' would be what is wrapped up in ndiswrapper.
>>> There is also an alpha quality driver in the kernel tree, and that is
>>> the one that is the src of that particular message.  The extracted
>>> windows driver doesn't report that.
>> Check out http://bcm43xx.berlios.de/
>>
> Hmm, it would appear we've /.'d them.
> 
> However, I believe I did that last spring, using the driver directly from 
> the windows partition, and that all the files are now resident 
> in /lib/firmware.  Here is a listing of that directory:
> 
> total 7352
> -rwxrw-rw- 1 root root  757760 Nov 28  2005 bcm1xsup.dll
> -rwxrw-rw- 1 root root    9948 Nov 28  2005 bcm43xx.cat
> -rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval01.fw
> -rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval02.fw
> -rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval03.fw
> -rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval04.fw
> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval05.fw
> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval06.fw
> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval07.fw
> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval08.fw
> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval09.fw
> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval10.fw
> -rw-r--r-- 1 root root   20200 Jul  7  2006 bcm43xx_microcode2.fw
> -rw-r--r-- 1 root root   22352 Jul  7  2006 bcm43xx_microcode4.fw
> -rw-r--r-- 1 root root   23184 Jul  7  2006 bcm43xx_microcode5.fw
> -rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm4.fw
> -rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm5.fw
> -rwxrw-rw- 1 root root  658896 Nov 28  2005 bcmwl5.inf
> -rwxrw-rw- 1 root root  379840 Feb 14  2006 bcmwl5.PNF
> -rwxrw-rw- 1 root root  424320 Nov 28  2005 bcmwl5.sys
> -rwxrw-rw- 1 root root   81920 Nov 28  2005 bcmwliss.dll
> -rwxrw-rw- 1 root root   33664 Nov 28  2005 bcmwlnpf.sys
> -rwxrw-rw- 1 root root   69632 Nov 28  2005 bcmwlpkt.dll
> -rwxrw-rw- 1 root root  122880 Nov 28  2005 bcmwls32.exe
> -rwxrw-rw- 1 root root   22672 Nov 28  2005 bcmwls.ini
> -rwxrw-rw- 1 root root  176128 Nov 28  2005 bcmwlu00.exe
> -rwxrw-rw- 1 root root 2313329 Nov 28  2005 data1.cab
> -rwxrw-rw- 1 root root   36304 Nov 28  2005 data1.hdr
> -rwxrw-rw- 1 root root     512 Nov 28  2005 data2.cab
> -rw-r--r-- 1 root root  658896 Apr 17  2006 gene.inf
> -rwxrw-rw- 1 root root  346602 Nov 28  2005 ikernel.ex_
> -rwxrw-rw- 1 root root    6200 Feb 14  2006 INFCACHE.1
> -rwxrw-rw- 1 root root  168448 Nov 28  2005 is.exe
> -rwxrw-rw- 1 root root  658896 Nov 28  2005 jene
> -rwxrw-rw- 1 root root      28 Nov 28  2005 launcher.ini
> -rwxrw-rw- 1 root root     417 Nov 28  2005 layout.bin
> -rw-r--r-- 1 root root       0 Jan 10 22:29 ~lib-firm-dir-contents
> -rwxrw-rw- 1 root root   45056 Nov 28  2005 setup.exe
> -rwxrw-rw- 1 root root     595 Nov 28  2005 Setup.ini
> -rwxrw-rw- 1 root root  162610 Nov 28  2005 setup.inx
> -rwxrw-rw- 1 root root     628 Nov 28  2005 setup.iss
> -rwxrw-rw- 1 root root    3485 Nov 28  2005 sp29842.cva
> 
> 
>> You should find a bcm43xx-fwcutter utility (actually, it looks like its
>> in Extras so you can yum it too).  Run that against the .SYS file you
>> have from Windows to extract the firmware.  Then the bcm43xx driver
>> should be able to operate and you can toss ndiswrapper out the window.
> 
> Does not the above satisfy the bcm43xx drivers firmware requirements?
> Recall from the earlier post, that a "modprobe bcm43xx" returns no error 
> on the cli, and that this is the log from that action:
> 
> Jan 10 16:04:21 diablo kernel: ieee80211: 802.11 data/management/control 
> stack, git-1.1.13
> Jan 10 16:04:21 diablo kernel: ieee80211: Copyright (C) 2004-2005 Intel 
> Corporation <jketreno at linux.intel.com>
> Jan 10 16:04:21 diablo kernel: bcm43xx driver
> Jan 10 16:04:21 diablo kernel: ACPI: PCI Interrupt 0000:03:02.0[A] -> Link 
> [LNKF] -> GSI 10 (level, low) -> IRQ 10
> Jan 10 16:04:21 diablo kernel: bcm43xx: Chip ID 0x4318, rev 0x2
> Jan 10 16:04:21 diablo kernel: bcm43xx: Number of cores: 4
> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 
> 0x4243, enabled
> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 
> 0x4243, disabled
> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 
> 0x4243, enabled
> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 
> 0x4243, enabled
> Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
> Jan 10 16:04:21 diablo kernel: bcm43xx: Detected PHY: Version: 3, Type 2, 
> Revision 7
> Jan 10 16:04:21 diablo kernel: bcm43xx: Detected Radio: ID: 8205017f 
> (Manuf: 17f Ver: 2050 Rev: 8)
> Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
> Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
> Jan 10 16:04:21 diablo kernel: SoftMAC: ASSERTION FAILED (0) at: 
> net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_get_rate()
> Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
> Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
> Jan 10 16:04:21 diablo kernel: bcm43xx: set security called, .level = 
> 0, .enabled = 0, .encrypt = 0
> Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: Scanning for networks 
> first.
> Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: failed to initiate 
> scan. Is device up?
> Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66 
> (2005-10-15  22:46:19)
> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for microcode 
> rev > 0x128
> Jan 10 16:04:21 diablo kernel: bcm43xx: core_up for active 802.11 core 
> failed (-1)
> Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
> Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
> Jan 10 16:04:38 diablo kernel: bcm43xx: set security called, .level = 
> 0, .enabled = 0, .encrypt = 0
> Jan 10 16:04:38 diablo kernel: SoftMAC: Canceling existing associate 
> request!
> Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: Scanning for networks 
> first.
> Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: failed to initiate 
> scan. Is device up?
> Jan 10 16:04:38 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66 
> (2005-10-15  22:46:19)
> Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for microcode 
> rev > 0x128

This rev level is V4 firmware, which is not supported by the mainline version of bcm43xx. Find a
copy of wl_apsta.o and re=extract the firmware from it. The version I have is rev 0x127, which is
the latest V3 firmware available,

> Jan 10 16:04:38 diablo kernel: bcm43xx: core_up for active 802.11 core 
> failed (-1)
> 
> 
> It was the 004-1.fc5 version of that utility I used at the time.  I have 
> NDI where I got it at the time, but obviously from the 'fc5' in its name, 
> it is probably the one from extras.
> 
> So what do I do next?

The "correct" firmware should let you get on-line. Be aware that 4318's have quite low transmit
power for unknown reasons, and the transmit rate will be quite low.

Larry



From gene.heskett at verizon.net  Sat Jan 13 08:41:06 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 13 Jan 2007 02:41:06 -0500
Subject: nm vs wireless on my lappy
In-Reply-To: <45A88077.3020807@lwfinger.net>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701122215.27704.gene.heskett@verizon.net>
	<45A88077.3020807@lwfinger.net>
Message-ID: <200701130241.06849.gene.heskett@verizon.net>

On Saturday 13 January 2007 01:47, Larry Finger wrote:
>Gene Heskett wrote:
>> The following is a message I'd posted to the fedora list earlier, with
>> few replies.
>>
>> On Wednesday 10 January 2007 22:00, David Hollis wrote:
>>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
>>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
>>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
>>>>>> Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for
>>>>>> microcode
>>>>>> rev > 0x128
>>>>>
>>>>> I don't know anything about the bcm43xx driver, but this line does
>>>>> seem interesting.  Do you have the extracted firmware available?
>>>>
>>>> The 'extracted firmware' would be what is wrapped up in ndiswrapper.
>>>> There is also an alpha quality driver in the kernel tree, and that
>>>> is the one that is the src of that particular message.  The
>>>> extracted windows driver doesn't report that.
>>>
>>> Check out http://bcm43xx.berlios.de/
>>
>> Hmm, it would appear we've /.'d them.
>>
>> However, I believe I did that last spring, using the driver directly
>> from the windows partition, and that all the files are now resident in
>> /lib/firmware.  Here is a listing of that directory:
>>
>> total 7352
>> -rwxrw-rw- 1 root root  757760 Nov 28  2005 bcm1xsup.dll
>> -rwxrw-rw- 1 root root    9948 Nov 28  2005 bcm43xx.cat
>> -rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval01.fw
>> -rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval02.fw
>> -rw-r--r-- 1 root root    3696 Jul  7  2006 bcm43xx_initval03.fw
>> -rw-r--r-- 1 root root      16 Jul  7  2006 bcm43xx_initval04.fw
>> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval05.fw
>> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval06.fw
>> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval07.fw
>> -rw-r--r-- 1 root root    2568 Jul  7  2006 bcm43xx_initval08.fw
>> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval09.fw
>> -rw-r--r-- 1 root root     248 Jul  7  2006 bcm43xx_initval10.fw
>> -rw-r--r-- 1 root root   20200 Jul  7  2006 bcm43xx_microcode2.fw
>> -rw-r--r-- 1 root root   22352 Jul  7  2006 bcm43xx_microcode4.fw
>> -rw-r--r-- 1 root root   23184 Jul  7  2006 bcm43xx_microcode5.fw
>> -rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm4.fw
>> -rw-r--r-- 1 root root    1312 Jul  7  2006 bcm43xx_pcm5.fw
>> -rwxrw-rw- 1 root root  658896 Nov 28  2005 bcmwl5.inf
>> -rwxrw-rw- 1 root root  379840 Feb 14  2006 bcmwl5.PNF
>> -rwxrw-rw- 1 root root  424320 Nov 28  2005 bcmwl5.sys
>> -rwxrw-rw- 1 root root   81920 Nov 28  2005 bcmwliss.dll
>> -rwxrw-rw- 1 root root   33664 Nov 28  2005 bcmwlnpf.sys
>> -rwxrw-rw- 1 root root   69632 Nov 28  2005 bcmwlpkt.dll
>> -rwxrw-rw- 1 root root  122880 Nov 28  2005 bcmwls32.exe
>> -rwxrw-rw- 1 root root   22672 Nov 28  2005 bcmwls.ini
>> -rwxrw-rw- 1 root root  176128 Nov 28  2005 bcmwlu00.exe
>> -rwxrw-rw- 1 root root 2313329 Nov 28  2005 data1.cab
>> -rwxrw-rw- 1 root root   36304 Nov 28  2005 data1.hdr
>> -rwxrw-rw- 1 root root     512 Nov 28  2005 data2.cab
>> -rw-r--r-- 1 root root  658896 Apr 17  2006 gene.inf
>> -rwxrw-rw- 1 root root  346602 Nov 28  2005 ikernel.ex_
>> -rwxrw-rw- 1 root root    6200 Feb 14  2006 INFCACHE.1
>> -rwxrw-rw- 1 root root  168448 Nov 28  2005 is.exe
>> -rwxrw-rw- 1 root root  658896 Nov 28  2005 jene
>> -rwxrw-rw- 1 root root      28 Nov 28  2005 launcher.ini
>> -rwxrw-rw- 1 root root     417 Nov 28  2005 layout.bin
>> -rw-r--r-- 1 root root       0 Jan 10 22:29 ~lib-firm-dir-contents
>> -rwxrw-rw- 1 root root   45056 Nov 28  2005 setup.exe
>> -rwxrw-rw- 1 root root     595 Nov 28  2005 Setup.ini
>> -rwxrw-rw- 1 root root  162610 Nov 28  2005 setup.inx
>> -rwxrw-rw- 1 root root     628 Nov 28  2005 setup.iss
>> -rwxrw-rw- 1 root root    3485 Nov 28  2005 sp29842.cva
>>
>>> You should find a bcm43xx-fwcutter utility (actually, it looks like
>>> its in Extras so you can yum it too).  Run that against the .SYS file
>>> you have from Windows to extract the firmware.  Then the bcm43xx
>>> driver should be able to operate and you can toss ndiswrapper out the
>>> window.
>>
>> Does not the above satisfy the bcm43xx drivers firmware requirements?
>> Recall from the earlier post, that a "modprobe bcm43xx" returns no
>> error on the cli, and that this is the log from that action:
>>
>> Jan 10 16:04:21 diablo kernel: ieee80211: 802.11
>> data/management/control stack, git-1.1.13
>> Jan 10 16:04:21 diablo kernel: ieee80211: Copyright (C) 2004-2005
>> Intel Corporation <jketreno at linux.intel.com>
>> Jan 10 16:04:21 diablo kernel: bcm43xx driver
>> Jan 10 16:04:21 diablo kernel: ACPI: PCI Interrupt 0000:03:02.0[A] ->
>> Link [LNKF] -> GSI 10 (level, low) -> IRQ 10
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Chip ID 0x4318, rev 0x2
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Number of cores: 4
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 0: ID 0x800, rev 0xd,
>> vendor 0x4243, enabled
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 1: ID 0x812, rev 0x9,
>> vendor 0x4243, disabled
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 2: ID 0x804, rev 0xc,
>> vendor 0x4243, enabled
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7,
>> vendor 0x4243, enabled
>> Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Detected PHY: Version: 3, Type
>> 2, Revision 7
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Detected Radio: ID: 8205017f
>> (Manuf: 17f Ver: 2050 Rev: 8)
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Radio turned off
>> Jan 10 16:04:21 diablo kernel: SoftMAC: ASSERTION FAILED (0) at:
>> net/ieee80211/softmac/ieee80211softmac_wx.c:306:ieee80211softmac_wx_ge
>>t_rate() Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
>> Jan 10 16:04:21 diablo kernel: SoftMAC: empty ratesinfo?
>> Jan 10 16:04:21 diablo kernel: bcm43xx: set security called, .level =
>> 0, .enabled = 0, .encrypt = 0
>> Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: Scanning for
>> networks first.
>> Jan 10 16:04:21 diablo kernel: SoftMAC: Associate: failed to initiate
>> scan. Is device up?
>> Jan 10 16:04:21 diablo kernel: bcm43xx: PHY connected
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66
>> (2005-10-15  22:46:19)
>> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for
>> microcode rev > 0x128
>> Jan 10 16:04:21 diablo kernel: bcm43xx: core_up for active 802.11 core
>> failed (-1)
>> Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
>> Jan 10 16:04:38 diablo kernel: SoftMAC: empty ratesinfo?
>> Jan 10 16:04:38 diablo kernel: bcm43xx: set security called, .level =
>> 0, .enabled = 0, .encrypt = 0
>> Jan 10 16:04:38 diablo kernel: SoftMAC: Canceling existing associate
>> request!
>> Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: Scanning for
>> networks first.
>> Jan 10 16:04:38 diablo kernel: SoftMAC: Associate: failed to initiate
>> scan. Is device up?
>> Jan 10 16:04:38 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66
>> (2005-10-15  22:46:19)
>> Jan 10 16:04:38 diablo kernel: bcm43xx: Firmware: no support for
>> microcode rev > 0x128
>
>This rev level is V4 firmware, which is not supported by the mainline
> version of bcm43xx. Find a copy of wl_apsta.o and re=extract the
> firmware from it. The version I have is rev 0x127, which is the latest
> V3 firmware available,
>
That's a bit confusing since the chip, from the way I'm reading that 
message, is revision 13f, and in comparing md5sums, what I have is either 
a miss-match from that chart (its late, the url escapes me ATM), the only 
matching md5sum is from a microcode "11" in that chart, but the length of 
the file is wrong by 200 bytes or so.  Those you see above were extracted 
from the installed and working flawlessly (much to my chagrin) Windows XP 
that came on that lappy and which I haven't recovered the disk space I 
left it. (yet)

I don't know if I have a wl_apsta.o available on that machine, but I do 
have a somewhat dated version on this box, in the form of:
/mnt/hdb/usr/src/DD-WRT/src/linux/brcm/linux.v24/drivers/net/wl/wl_apsta.o

but I'd need to setup a samba share to get it over there unless I can grab 
the latest dd-wrt src's from their site, downloaded directly to that 
machine.  I may try that just to get the more recent version.

>> Jan 10 16:04:38 diablo kernel: bcm43xx: core_up for active 802.11 core
>> failed (-1)
>>
>>
>> It was the 004-1.fc5 version of that utility I used at the time.  I
>> have NDI where I got it at the time, but obviously from the 'fc5' in
>> its name, it is probably the one from extras.
>>
>> So what do I do next?
>
>The "correct" firmware should let you get on-line. Be aware that 4318's
> have quite low transmit power for unknown reasons, and the transmit
> rate will be quite low.

When I did have it working back around the May/June timeframe, in a motel 
in upstate MI, using that exact same dir full of firmware and 
ndiswrapper, upload speed was not a problem, and I did send a few dozen 
nearly a meg each pictures out through it at speeds that I thought 
compared well to my dsl (1.5/256) connection here.  tx power atm is 
reported as about 25mw when I was playing earlier this evening.  This I 
think compares favorably with dd-wrt's report of 28mw from the atheros 
card in that box.  x86 version of dd-wrt, booting and running from a half 
gig compact flash card, no hard drive.

Its late & I'm going to sleep on this, thanks Larry.

>Larry

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From martin-langer at gmx.de  Sat Jan 13 12:20:42 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Sat, 13 Jan 2007 12:20:42 +0100
Subject: nm vs wireless on my lappy
In-Reply-To: <200701130241.06849.gene.heskett@verizon.net>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701122215.27704.gene.heskett@verizon.net>
	<45A88077.3020807@lwfinger.net>
	<200701130241.06849.gene.heskett@verizon.net>
Message-ID: <20070113112042.GA3329@tuba>

On Sat, Jan 13, 2007 at 02:41:06AM -0500, Gene Heskett wrote:
> On Saturday 13 January 2007 01:47, Larry Finger wrote:
> >Gene Heskett wrote:
> >> The following is a message I'd posted to the fedora list earlier, with
> >> few replies.
> >>
> >> On Wednesday 10 January 2007 22:00, David Hollis wrote:
> >>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
> >>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
> >>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:

> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl 0x66
> >> (2005-10-15  22:46:19)
> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for
> >> microcode rev > 0x128

Your bcm43xx driver wants to have an old v3 firmware. And if you feed 
it with newer v4 firmware you will get such a reaction.

> That's a bit confusing since the chip, from the way I'm reading that 
> message, is revision 13f, and in comparing md5sums, what I have is either 
> a miss-match from that chart (its late, the url escapes me ATM), the only 
> matching md5sum is from a microcode "11" in that chart, but the length of 
> the file is wrong by 200 bytes or so.  Those you see above were extracted 
> >from the installed and working flawlessly (much to my chagrin) Windows XP 
> that came on that lappy and which I haven't recovered the disk space I 
> left it. (yet)

The revision numbers (0x13f, 0x127) are not any chip revisions. These 
are microcode revisions and they are defined in the firmware. 

The md5sums which do not match was a bug in the old 004 version of 
fwcutter. The extraction parameters for some v4 bcmwl5.sys driver files 
(IIRC, it was 4.10.40.0 and 4.10.40.1) were wrong. But this was fixed in 
fwcutter release 005.


Martin


From gene.heskett at verizon.net  Sat Jan 13 12:49:50 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 13 Jan 2007 06:49:50 -0500
Subject: nm vs wireless on my lappy
In-Reply-To: <20070113112042.GA3329@tuba>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701130241.06849.gene.heskett@verizon.net>
	<20070113112042.GA3329@tuba>
Message-ID: <200701130649.51106.gene.heskett@verizon.net>

On Saturday 13 January 2007 06:20, Martin Langer wrote:
>On Sat, Jan 13, 2007 at 02:41:06AM -0500, Gene Heskett wrote:
>> On Saturday 13 January 2007 01:47, Larry Finger wrote:
>> >Gene Heskett wrote:
>> >> The following is a message I'd posted to the fedora list earlier,
>> >> with few replies.
>> >>
>> >> On Wednesday 10 January 2007 22:00, David Hollis wrote:
>> >>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
>> >>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
>> >>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
>> >>
>> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl
>> >> 0x66 (2005-10-15  22:46:19)
>> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for
>> >> microcode rev > 0x128
>
>Your bcm43xx driver wants to have an old v3 firmware. And if you feed
>it with newer v4 firmware you will get such a reaction.

So in this respect, ndiswrapper is ahead of bcm43xx then as it had no 
problem like this.  I have it connecting now with ndiswrapper loaded, but 
while ifconfig says the interface is up, apparently routes aren't being 
properly set to that interface.  And I was too tired to investigate 
further, still am in fact.

Could the low tx power Larry alluded to also be a bcm43xx problem?

Can you relate what was added in v4, and in v5?

>> That's a bit confusing since the chip, from the way I'm reading that
>> message, is revision 13f, and in comparing md5sums, what I have is
>> either a miss-match from that chart (its late, the url escapes me
>> ATM), the only matching md5sum is from a microcode "11" in that chart,
>> but the length of the file is wrong by 200 bytes or so.  Those you see
>> above were extracted
>>
>> >from the installed and working flawlessly (much to my chagrin)
>> > Windows XP
>>
>> that came on that lappy and which I haven't recovered the disk space I
>> left it. (yet)
>
>The revision numbers (0x13f, 0x127) are not any chip revisions. These
>are microcode revisions and they are defined in the firmware.
>
>The md5sums which do not match was a bug in the old 004 version of
>fwcutter.

I see.

>The extraction parameters for some v4 bcmwl5.sys driver files 
>(IIRC, it was 4.10.40.0 and 4.10.40.1) were wrong. But this was fixed in
>fwcutter release 005.

The rpms apparently do not maintain that fine a grain to the version 
numbers, all I get for the query --version is 004

And this is available as an rpm for FC5?  Where?  I have extras and 
updates-testing enabled in yum, but didn't see a new bcm43xx-fwcutter 
yesterday, nor do I now.

Thanks Martin.

>Martin

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From martin-langer at gmx.de  Sat Jan 13 13:20:41 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Sat, 13 Jan 2007 13:20:41 +0100
Subject: nm vs wireless on my lappy
In-Reply-To: <200701130649.51106.gene.heskett@verizon.net>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701130241.06849.gene.heskett@verizon.net>
	<20070113112042.GA3329@tuba>
	<200701130649.51106.gene.heskett@verizon.net>
Message-ID: <20070113122041.GB3329@tuba>

On Sat, Jan 13, 2007 at 06:49:50AM -0500, Gene Heskett wrote:
> On Saturday 13 January 2007 06:20, Martin Langer wrote:
> >On Sat, Jan 13, 2007 at 02:41:06AM -0500, Gene Heskett wrote:
> >> On Saturday 13 January 2007 01:47, Larry Finger wrote:
> >> >Gene Heskett wrote:
> >> >> The following is a message I'd posted to the fedora list earlier,
> >> >> with few replies.
> >> >>
> >> >> On Wednesday 10 January 2007 22:00, David Hollis wrote:
> >> >>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
> >> >>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
> >> >>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
> >> >>
> >> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl
> >> >> 0x66 (2005-10-15  22:46:19)
> >> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for
> >> >> microcode rev > 0x128
> >
> >Your bcm43xx driver wants to have an old v3 firmware. And if you feed
> >it with newer v4 firmware you will get such a reaction.
> 
> So in this respect, ndiswrapper is ahead of bcm43xx then as it had no 
> problem like this.  I have it connecting now with ndiswrapper loaded, but 
> while ifconfig says the interface is up, apparently routes aren't being 
> properly set to that interface.  And I was too tired to investigate 
> further, still am in fact.
> 
> Could the low tx power Larry alluded to also be a bcm43xx problem?

Yep, a problem with bcm4318 chips.

> >> That's a bit confusing since the chip, from the way I'm reading that
> >> message, is revision 13f, and in comparing md5sums, what I have is
> >> either a miss-match from that chart (its late, the url escapes me
> >> ATM), the only matching md5sum is from a microcode "11" in that chart,
> >> but the length of the file is wrong by 200 bytes or so.  Those you see
> >> above were extracted
> >>
> >> >from the installed and working flawlessly (much to my chagrin)
> >> > Windows XP
> >>
> >> that came on that lappy and which I haven't recovered the disk space I
> >> left it. (yet)
> >
> >The revision numbers (0x13f, 0x127) are not any chip revisions. These
> >are microcode revisions and they are defined in the firmware.
> >
> >The md5sums which do not match was a bug in the old 004 version of
> >fwcutter.
> 
> I see.
> 
> >The extraction parameters for some v4 bcmwl5.sys driver files 
> >(IIRC, it was 4.10.40.0 and 4.10.40.1) were wrong. But this was fixed in
> >fwcutter release 005.
> 
> The rpms apparently do not maintain that fine a grain to the version 
> numbers, all I get for the query --version is 004

If we say "v4" we mean the numbering scheme Broadcom uses "4.x.x.x". And 
OTOH we use 00x for our fwcutter version numbering. Don't compare 
them. They have nothing in common. Fwcutter versions 005 and 006 are 
the ones whith the fix inside. If you run a "bcm43xx-fwcutter -l" you 
can see the broadcom versions 3.x.x.x and 4.x.x.x which can be used for 
firmware extraction. 


Martin


From gene.heskett at verizon.net  Sat Jan 13 13:30:42 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 13 Jan 2007 07:30:42 -0500
Subject: nm vs wireless on my lappy
In-Reply-To: <20070113122041.GB3329@tuba>
References: <200701101648.24461.gene.heskett@verizon.net>
	<200701130649.51106.gene.heskett@verizon.net>
	<20070113122041.GB3329@tuba>
Message-ID: <200701130730.42331.gene.heskett@verizon.net>

On Saturday 13 January 2007 07:20, Martin Langer wrote:
>On Sat, Jan 13, 2007 at 06:49:50AM -0500, Gene Heskett wrote:
>> On Saturday 13 January 2007 06:20, Martin Langer wrote:
>> >On Sat, Jan 13, 2007 at 02:41:06AM -0500, Gene Heskett wrote:
>> >> On Saturday 13 January 2007 01:47, Larry Finger wrote:
>> >> >Gene Heskett wrote:
>> >> >> The following is a message I'd posted to the fedora list
>> >> >> earlier, with few replies.
>> >> >>
>> >> >> On Wednesday 10 January 2007 22:00, David Hollis wrote:
>> >> >>> On Wed, 2007-01-10 at 19:55 -0500, Gene Heskett wrote:
>> >> >>>> On Wednesday 10 January 2007 18:13, David Hollis wrote:
>> >> >>>>> On Wed, 2007-01-10 at 16:48 -0500, Gene Heskett wrote:
>> >> >>
>> >> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Microcode rev 0x13f, pl
>> >> >> 0x66 (2005-10-15  22:46:19)
>> >> >> Jan 10 16:04:21 diablo kernel: bcm43xx: Firmware: no support for
>> >> >> microcode rev > 0x128
>> >
>> >Your bcm43xx driver wants to have an old v3 firmware. And if you feed
>> >it with newer v4 firmware you will get such a reaction.
>>
>> So in this respect, ndiswrapper is ahead of bcm43xx then as it had no
>> problem like this.  I have it connecting now with ndiswrapper loaded,
>> but while ifconfig says the interface is up, apparently routes aren't
>> being properly set to that interface.  And I was too tired to
>> investigate further, still am in fact.
>>
>> Could the low tx power Larry alluded to also be a bcm43xx problem?
>
>Yep, a problem with bcm4318 chips.
[...]
>> The rpms apparently do not maintain that fine a grain to the version
>> numbers, all I get for the query --version is 004
>
>If we say "v4" we mean the numbering scheme Broadcom uses "4.x.x.x". And
>OTOH we use 00x for our fwcutter version numbering. Don't compare
>them. They have nothing in common. Fwcutter versions 005 and 006 are
>the ones whith the fix inside. If you run a "bcm43xx-fwcutter -l" you
>can see the broadcom versions 3.x.x.x and 4.x.x.x which can be used for
>firmware extraction.
>
I found an rpm of fwcutter 005 for FC6, but it needs rtld(GNU_HASH)
which yum can't find for FC5.

In the meantime I've dl'd the dd-wrt srcs, which should have the other 
driver in it.  I promise not to read the license...

Maybe 004 can extract it.  OTOH, if I could get cifs to accept a passwd 19 
chars long, I'd just copy my pix and music dirs to this box and install 
FC6 on the lappy.  That might simplify things in the long run.

Thanks Martin.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From mb at bu3sch.de  Sat Jan 13 15:09:26 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Jan 2007 15:09:26 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
References: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
Message-ID: <200701131509.26877.mb@bu3sch.de>

On Saturday 13 January 2007 08:45, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > > drivers/ssb/driver_mips/mips.c includes asm/time.h, which is missing on
> > > x86_64.  It also refers to struct ssb_serial_ports, which is not defined
> > > anywhere.
> >
> > Yeah, CONFIG_SSB_MIPS should depend on the MIPS CPU.
> > Which kconfig option do you suggest to make a "depend" on?
> 
> I try not to add artificial restrictions.  The driver should depend on the
> components providing the necessary API.

Ehm, it is clearly not artificial. The MIPS core depends on the MIPS
platform. Logically and technically. You must not enable it on
non-MIPS platforms, as it's tied with the internals of the MIPS
arch dependent code.

The only logical way to solve the compile issues are to make a dependency
on the MIPS platform.

> > > drivers/ssb/driver_pci/pcicore.c refers to SSB_PCICORE_SBTOPCI1_CFG1
> > > that is not defined anywhere in the kernel.
> >
> > Yeah, could be a typo. I'll have a look at it.
> 
> I only found it because the driver didn't depend on MIPS.  See what I mean?
> 
> This only manifests if CONFIG_SSB_PCICORE_HOSTMODE is defined, and it is only
> selected by CONFIG_SSB_DRIVER_MIPS.

HOSTMODE is not really tested, yet.
And HOSTMODE is _also_ very closely tied to the MIPS platform. So
it must depend on it, too (probably indirectly through the MIPS core driver).

To be honest, I did not even compiletest the HOSTMODE code, as I don't
even have a device for it. But I am going to fix that before pushing stuff
upstream.

> > Hm, not sure why this oopses. It works on PPC (can transmit data and so on).
> 
> My PPC machine is a venerable Blue&White G3, so it won't take PCIe.

I looked more closely at it, but I really can't see why it oopses.
Any idea what's happening there?

> > Does it work with linville's tree (in DMA mode)?
> 
> Yes, it does.  I couldn't connect to the AP, but it's a different story.  I may
> be doing things wrong.  At least I can scan and I see the APs around.

Well, ok. So it should work in my tree, too, once we fixed the DMA oops.

-- 
Greetings Michael.


From mb at bu3sch.de  Sat Jan 13 15:10:39 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Jan 2007 15:10:39 +0100
Subject: Various patches for PCI-E and radio-enable switches
In-Reply-To: <45A7FA04.60802@lwfinger.net>
References: <45A7DFE6.1060304@lwfinger.net>
	<000701c73688$da17e640$0601a8c0@daniel5234ab92>
	<45A7FA04.60802@lwfinger.net>
Message-ID: <200701131510.39221.mb@bu3sch.de>

On Friday 12 January 2007 22:13, Larry Finger wrote:
> Daniel wrote:
> > I know it's working out of the box, but could I still make a developper 
> > happy with an asus wl-100g? Recently replaced it with a Netgear WG500T 
> 
> What is the chip in the wl-100g? The web told me it is Broadcom, but not the flavor.

4306. I have one. It works pretty good.

-- 
Greetings Michael.


From gene.heskett at verizon.net  Sat Jan 13 20:35:39 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sat, 13 Jan 2007 14:35:39 -0500
Subject: New problem with wlan0
Message-ID: <200701131435.40000.gene.heskett@verizon.net>

Greetings;

I have bcm43xx setup now, and if I assign its address as opposed to using 
dhcp, it appears to work.

Appears is the correct word I think, because its not receiving anything 
although I can:

ssh into the dd-wrt and watch the packet counts rise with an ifconfig for 
both the ath0 and wifi0 interfaces.

run etherape on the lappy, which puts the interface wlan0 into promiscuous 
mode, and watch traffic, some of which seems to come to addresses only 
valid outside my local net.  There is currently a 239:255:255:250 address 
being displayed by etherape.  But I note that traffic to this machine 
seems to be missing the final e in this machines alias name.  OTOH, a 
ping -f from here to that machines address doesn't show up in the 
etherape display.  Also the routers hostname is missing the final 
character in the etherape display, so maybe that is an etherape bug.

This has the classic case of a bad route stamped all over it, but a 
route -n on the lappy shows:
Destination	Gateway		genmask		flags	Metric	Use	Iface
192.168.71.2	0.0.0.0		255.255.255.0	u	0	0	wlan0
0.0.0.0		192.168.71.2	0.0.0.0		ug	0	0	wlan0

which is correct.  The dd-wrt's address is 192.168.71.2 so it wouldn't 
clash with the old linksys at 192.168.71.1.

The dd-wrt is functioning as a relay for dns requests also, and works fine 
from the other 2 machines here, all local dns entries are set to 
192.168.71.2.

I can't see the problem, but there sure is one.  Can I buy a clue?

Thanks.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From mb at bu3sch.de  Sat Jan 13 20:51:52 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 13 Jan 2007 20:51:52 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <20070113143033.fi804so8ok04wc4k@webmail.spamcop.net>
References: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
	<200701131509.26877.mb@bu3sch.de>
	<20070113143033.fi804so8ok04wc4k@webmail.spamcop.net>
Message-ID: <200701132051.52559.mb@bu3sch.de>

On Saturday 13 January 2007 20:30, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > I looked more closely at it, but I really can't see why it oopses.
> > Any idea what's happening there?
> 
> I haven't looked at the code yet, but I tried to locate the bad commit.  I tried
> commit a13f85d8a8eb40dfd157ab78c2fb91b5765b7b9d, which is your last merge, just
> before the SSB changes.

Yeah, sure. I know that this is the commit which introduced this.

> The kernel doesn't oops anymore!  But it doesn't connect either.  I reconfigured
> the AP to use WPA-PSK with TKIP.  MadWifi works with it, but bcm43xx fails in
> the same configuration.  The wireless-dev tip has the same problem.

Note that LO calibration is horribly broken in my tree.
So you have a very weak signal, if any. My 4318 has no signal, for example.
So basically don't expect to be able to transmit any data.
This includes association.

But I think you should be able to assoc with a plain linville tree.

> So, the oops was introduced in the transition to the new SSB. 
> bcm43xx_setup_dmaring(), which appears in the stack dump, is affected by the
> patch.

Yeah, but I don't see where we can get such an oops from :)

> I'll try to look closely at the changes.  My immediate suspect is that we have
> too many different fields called "dev".  All it takes is one cast to hide a
> horrible mistake.  Although I think it would have affected you as well (unless

We don't cast devs.

> it's casts to/from integers, something that won't be a problem on 32-bit
> kernels).

dito.

> > Well, ok. So it should work in my tree, too, once we fixed the DMA oops.
> 
> You mean there is a reason for me to think that your changes would fix
> accociation to the AP?

No.


We oops in dma_alloc_coherent, right?
Where can we get a NULL pointer there? I don't see it. Any idea?
Also, regarding to the oops message, it's oopsing somewhere at
the beginning of the function.

-- 
Greetings Michael.


From spitty at gmail.com  Sat Jan 13 21:53:41 2007
From: spitty at gmail.com (Ryan Hurley)
Date: Sat, 13 Jan 2007 15:53:41 -0500
Subject: Testing report for new patches
Message-ID: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>

Hi all,

I'm running a newer Compaq laptop (v3000 series) which has one of these
wonderful broadcom PCI-E 4311 chips in them.  I've been testing the
devicescape bcm43xx  drivers from the wireless-dev tree for awhile, but I
still haven't gotten anything to work.  This is the first time I've
submitted to a development list proper, so I apologize in advance if I've
forgotten anything or done something incorrectly.

Output from lspci -vv:

01:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
        Subsystem: Hewlett-Packard Company Unknown device 1360
        Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr-
Stepping- SERR+ FastB2B-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
<TAbort- <MAbort- >SERR- <PERR-
        Latency: 0, Cache Line Size: 64 bytes
        Interrupt: pin A routed to IRQ 20
        Region 0: Memory at c3000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
                Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=375mA
PME(D0-,D1-,D2-,D3hot-,D3cold-)
                Status: D0 PME-Enable- DSel=0 DScale=2 PME-
        Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0
Enable-
                Address: 00000000  Data: 0000
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
                Device: Supported: MaxPayload 128 bytes, PhantFunc 0,
ExtTag+
                Device: Latency L0s <4us, L1 unlimited
                Device: AtnBtn- AtnInd- PwrInd-
                Device: Errors: Correctable- Non-Fatal- Fatal- Unsupported-
                Device: RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop-
                Device: MaxPayload 128 bytes, MaxReadReq 128 bytes
                Link: Supported Speed 2.5Gb/s, Width x1, ASPM L0s, Port 0
                Link: Latency L0s <4us, L1 <64us
                Link: ASPM Disabled RCB 64 bytes CommClk- ExtSynch-
                Link: Speed 2.5Gb/s, Width x1
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel

Even though lspci identifies this as a BCM4310 (UART), I've been told that
this is actually a 4311 core.

I compiled a 2.6.19.1 kernel to test out the new PCI-E patches this
afternoon, and while it compiled cleanly and was able to scan, I was unable
to associate with any access points, encrypted or otherwise.  The relevant
parts of dmesg are:

....
[  127.078000] bcm43xx driver
[  127.080000] ACPI: PCI Interrupt Link [LK2E] enabled at IRQ 19
[  127.080000] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19
(level, high) -> IRQ 20
[  127.080000] PCI: Setting latency timer of device 0000:01:00.0 to 64
[  127.087000] bcm43xx: Chip ID 0x4311, rev 0x1
[  127.087000] bcm43xx: Number of cores: 4
[  127.087000] bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
[  127.087000] bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, disabled
[  127.087000] bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
[  127.087000] bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
[  127.088000] bcm43xx: PHY connected
[  127.088000] bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
[  127.088000] bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050
Rev: 2)
[  127.088000] bcm43xx: Radio turned off
[  127.088000] bcm43xx: Radio turned off
[  127.153000] bcm43xx: PHY connected
[  127.252000] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
[  127.260000] bcm43xx: Radio turned on
[  127.260000] bcm43xx: Radio enabled by hardware
[  127.449000] bcm43xx: Chip initialized
[  127.449000] bcm43xx: 32-bit DMA initialized
[  127.449000] bcm43xx: Keys cleared
[  127.449000] bcm43xx: Selected 802.11 core (phytype 2)
[  128.758000] SoftMAC: Authentication response received from
00:11:50:a2:14:36 but no queue item exists.
[  129.527000] bcm43xx: set security called, .level = 0, .enabled = 0,
.encrypt = 0
[  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
.encrypt = 0
[  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
.encrypt = 0
[  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
.encrypt = 0
[  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
.encrypt = 0
[  130.899000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  130.899000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  130.900000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  136.380000] SoftMAC: Authentication response received from
00:11:50:a2:14:36 but no queue item exists.
[  137.977000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  137.977000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  137.978000] SoftMAC: Authentication response received from
00:14:6c:03:c5:ff but no queue item exists.
[  141.200000] bcm43xx: Radio turned off

I turned the radio off myself when it failed to authenticate.  I repeated
the process, (rmmod bcm43xx, modprobe 43xx, and then attempt to connect)
but got  an identical result.

Oh, and there's one other thing that I'd like to bring to the attention of
this list.  The bcm43xx driver supplied with the default Ubuntu Edgy kernel
works.  It runs very, very slowly (about 20 KB/s for download and even
slower for upload) but it identifies my chip and authenticates- the whole 9
yards.  Just a heads up.

If anyone needs any other information about my setup or from the logs,
please ask.  Thanks for all the hard work everyone is doing on this driver!

-Ryan Hurley
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070113/7086561c/attachment.html>

From heise2k at gmail.com  Sat Jan 13 22:27:15 2007
From: heise2k at gmail.com (Bob Heise)
Date: Sat, 13 Jan 2007 16:27:15 -0500
Subject: >1GB Bug
In-Reply-To: <459D3A80.1050900@lwfinger.net>
References: <200701022308.55570.heise2k@gmail.com>
	<459D3A80.1050900@lwfinger.net>
Message-ID: <200701131627.15549.heise2k@gmail.com>

torsdag 04 januari 2007 12:33 skrev du:
> Bob Heise wrote:
> > Hello,
> >
> > I am using 2.6.19.1 + wireless-dev git kernel, bcm43xx driver with v.3
> > firmware on an HP zv5000z amd64 with 2GB RAM.
> >
> > lspci -n
> > 02:02.0 Class 0280: 14e4:4320 (rev 03)
> >
> > lspci -vv
> > 02:02.0 Network controller: Broadcom Corporation BCM4306 802.11b/g
> > Wireless LAN Controller (rev 03)
> >         Subsystem: Hewlett-Packard Company NX9500 Built-in Wireless
> >         Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop-
> > ParErr- Stepping- SERR+ FastB2B-
> >         Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
> > <TAbort- <MAbort- >SERR- <PERR-
> >         Latency: 64
> >         Interrupt: pin A routed to IRQ 17
> >         Region 0: Memory at e0104000 (32-bit, non-prefetchable) [size=8K]
>
> Thanks for your report. It seems that the dma_over_1GB patch works on some
> systems, but not on others. I do not know why. I just got a new AMD 64 X2
> computer with a motherboard capable of holding 2GB RAM. It currently has
> only 1GB with a Dell 1390 (BCM4311) that is capable of full 32-bit DMA. I'm
> trying to decide if I could do any debugging of the problem if I got more
> memory and tricked the program into thinking I had only 30-bit DMA

Larry,

I added pci_dma_supported(ring->bcm->pci_dev, 0x3FFFFFFF) and 
pci_set_dma_mask(ring->bcm-pci_dev, 0x3FFFFFFF) after your 64 and 32 bit DMA 
attempts in the bcm43xx_dma.c's map_descbuffer from your patch, both 
indicated that 30-bit DMA was supported, yet when after that I did: 
dmaaddr = pci_map_single(ring->bcm->pci_dev, buf, len, direction) 
pci_dma_mapping_error returned true for that address. Very frustrating 
indeed.

Since that experiment I have upgraded my wireless-dev tree to the latest. I 
thought, na?vely I suppose, that maybe forcing on the iommu would allow the 
correct address mapping since obviously it isn't occurring normally. The 
resultant kernel turned up what seems to be a locking problem. I'm not sure 
if it's a real problem for normal operation, but it did crash my box so... 
hopefully the pursuent /var/log/messages snippet is helpful.

Of course if anyone has any ideas on how to solve this 30-bit DMA problem I 
would be happy to try it out.

-Bob

> capability. There is one other problem in that TX DMA doesn't work with the
> PCI-E hardware with 2.6.20 or wireless-2.6 versions. I need to fix that
> problem first.
>
> Larry
-------------- next part --------------
Jan 12 17:41:01 karnkraft kernel: [  244.935312] bcm43xx: PHY connected
Jan 12 17:41:01 karnkraft kernel: [  245.193785] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
Jan 12 17:41:01 karnkraft kernel: [  245.202613] bcm43xx: Radio turned on
Jan 12 17:41:01 karnkraft kernel: [  245.365505] bcm43xx: Chip initialized
Jan 12 17:41:01 karnkraft kernel: [  245.367889] bcm43xx: 30-bit DMA initialized
Jan 12 17:41:01 karnkraft kernel: [  245.368083] bcm43xx: Keys cleared
Jan 12 17:41:01 karnkraft kernel: [  245.369112] bcm43xx: Selected 802.11 core (phytype 2)
Jan 12 17:41:01 karnkraft kernel: [  245.369163] printk: 4 messages suppressed.
Jan 12 17:41:01 karnkraft kernel: [  245.369171] bcm43xx: FATAL ERROR: Fatal DMA error: 0x00001000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
Jan 12 17:41:01 karnkraft kernel: [  245.369179] bcm43xx: Controller RESET (DMA error) ...
Jan 12 17:41:01 karnkraft kernel: [  245.375182] ADDRCONF(NETDEV_UP): eth3: link is not ready
Jan 12 17:41:01 karnkraft kernel: [  245.375734] 
Jan 12 17:41:01 karnkraft kernel: [  245.375736] =============================================
Jan 12 17:41:01 karnkraft kernel: [  245.375850] [ INFO: possible recursive locking detected ]
Jan 12 17:41:01 karnkraft kernel: [  245.375936] 2.6.20-rc3-30bitDMAtest #1
Jan 12 17:41:01 karnkraft kernel: [  245.375996] ---------------------------------------------
Jan 12 17:41:01 karnkraft kernel: [  245.376081] events/0/3 is trying to acquire lock:
Jan 12 17:41:01 karnkraft kernel: [  245.376156]  (&bcm->mutex){--..}, at: [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.376290] 
Jan 12 17:41:01 karnkraft kernel: [  245.376292] but task is already holding lock:
Jan 12 17:41:01 karnkraft kernel: [  245.376381]  (&bcm->mutex){--..}, at: [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.376510] 
Jan 12 17:41:01 karnkraft kernel: [  245.376512] other info that might help us debug this:
Jan 12 17:41:01 karnkraft kernel: [  245.376612] 2 locks held by events/0/3:
Jan 12 17:41:01 karnkraft kernel: [  245.376672]  #0:  (&bcm->mutex){--..}, at: [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.376807]  #1:  (workqueue_mutex){--..}, at: [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.376946] 
Jan 12 17:41:01 karnkraft kernel: [  245.376949] stack backtrace:
Jan 12 17:41:01 karnkraft kernel: [  245.377014] 
Jan 12 17:41:01 karnkraft kernel: [  245.377017] Call Trace:
Jan 12 17:41:01 karnkraft kernel: [  245.377089]  [<ffffffff80241dcb>] __lock_acquire+0x15c/0xa7b
Jan 12 17:41:01 karnkraft kernel: [  245.377188]  [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.377278]  [<ffffffff80242766>] lock_acquire+0x7c/0xa0
Jan 12 17:41:01 karnkraft kernel: [  245.377365]  [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.377459]  [<ffffffff803db99b>] __mutex_lock_slowpath+0xe4/0x26a
Jan 12 17:41:01 karnkraft kernel: [  245.377572]  [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.377657]  [<ffffffff803dd586>] _spin_unlock_irqrestore+0x3f/0x47
Jan 12 17:41:01 karnkraft kernel: [  245.377790]  [<ffffffff88180585>] :bcm43xx:bcm43xx_periodic_work_handler+0x31/0x3b2
Jan 12 17:41:01 karnkraft kernel: [  245.377917]  [<ffffffff802417c6>] trace_hardirqs_on+0x124/0x14e
Jan 12 17:41:01 karnkraft kernel: [  245.378043]  [<ffffffff88180554>] :bcm43xx:bcm43xx_periodic_work_handler+0x0/0x3b2
Jan 12 17:41:01 karnkraft kernel: [  245.378170]  [<ffffffff802381b9>] run_workqueue+0xa1/0x186
Jan 12 17:41:01 karnkraft kernel: [  245.378286]  [<ffffffff8817f812>] :bcm43xx:bcm43xx_chip_reset+0x0/0xc6
Jan 12 17:41:01 karnkraft kernel: [  245.378395]  [<ffffffff802382c3>] flush_cpu_workqueue+0x25/0xa7
Jan 12 17:41:01 karnkraft kernel: [  245.378499]  [<ffffffff803dbb46>] mutex_lock+0x25/0x29
Jan 12 17:41:01 karnkraft kernel: [  245.378587]  [<ffffffff8023838a>] flush_workqueue+0x45/0x55
Jan 12 17:41:01 karnkraft kernel: [  245.378683]  [<ffffffff802383c5>] cancel_rearming_delayed_workqueue+0x2b/0x2d
Jan 12 17:41:01 karnkraft kernel: [  245.378803]  [<ffffffff802383dd>] cancel_rearming_delayed_work+0x16/0x18
Jan 12 17:41:01 karnkraft kernel: [  245.378935]  [<ffffffff8817d721>] :bcm43xx:bcm43xx_periodic_tasks_delete+0x10/0x12
Jan 12 17:41:01 karnkraft kernel: [  245.379080]  [<ffffffff8817f847>] :bcm43xx:bcm43xx_chip_reset+0x35/0xc6
Jan 12 17:41:01 karnkraft kernel: [  245.379195]  [<ffffffff802381b9>] run_workqueue+0xa1/0x186
Jan 12 17:41:01 karnkraft kernel: [  245.379289]  [<ffffffff80238786>] worker_thread+0x0/0x14b
Jan 12 17:41:01 karnkraft kernel: [  245.379382]  [<ffffffff8023889a>] worker_thread+0x114/0x14b
Jan 12 17:41:01 karnkraft kernel: [  245.379478]  [<ffffffff80225753>] default_wake_function+0x0/0xf
Jan 12 17:41:01 karnkraft kernel: [  245.382136]  [<ffffffff80238786>] worker_thread+0x0/0x14b
Jan 12 17:41:01 karnkraft kernel: [  245.384790]  [<ffffffff8023b52c>] kthread+0xce/0x102
Jan 12 17:41:01 karnkraft kernel: [  245.387443]  [<ffffffff8020a788>] child_rip+0xa/0x12
Jan 12 17:41:01 karnkraft kernel: [  245.390093]  [<ffffffff803dd510>] _spin_unlock_irq+0x2b/0x31
Jan 12 17:41:01 karnkraft kernel: [  245.392757]  [<ffffffff8020a36c>] restore_args+0x0/0x30
Jan 12 17:41:01 karnkraft kernel: [  245.395400]  [<ffffffff8023b45e>] kthread+0x0/0x102
Jan 12 17:41:01 karnkraft kernel: [  245.398026]  [<ffffffff8020a77e>] child_rip+0x0/0x12
Jan 12 17:41:01 karnkraft kernel: [  245.400621] 
Jan 12 17:41:02 karnkraft kernel: [  246.026228] ACPI: EC: evaluating _Q1E
Jan 12 17:41:14 karnkraft kernel: [  258.662553] ACPI: EC: evaluating _Q1E
Jan 12 17:41:28 karnkraft kernel: [  271.954515] ACPI: EC: evaluating _Q1E
Read from remote host karnkraft: Connection reset by peer

From larry.finger at lwfinger.net  Sun Jan 14 07:25:30 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 14 Jan 2007 00:25:30 -0600
Subject: >1GB Bug
In-Reply-To: <200701131627.15549.heise2k@gmail.com>
References: <200701022308.55570.heise2k@gmail.com>
	<459D3A80.1050900@lwfinger.net>
	<200701131627.15549.heise2k@gmail.com>
Message-ID: <45A9CCDA.10703@lwfinger.net>

Bob Heise wrote:
> 
> I added pci_dma_supported(ring->bcm->pci_dev, 0x3FFFFFFF) and 
> pci_set_dma_mask(ring->bcm-pci_dev, 0x3FFFFFFF) after your 64 and 32 bit DMA 
> attempts in the bcm43xx_dma.c's map_descbuffer from your patch, both 
> indicated that 30-bit DMA was supported, yet when after that I did: 
> dmaaddr = pci_map_single(ring->bcm->pci_dev, buf, len, direction) 
> pci_dma_mapping_error returned true for that address. Very frustrating 
> indeed.
> 
> Since that experiment I have upgraded my wireless-dev tree to the latest. I 
> thought, na?vely I suppose, that maybe forcing on the iommu would allow the 
> correct address mapping since obviously it isn't occurring normally. The 
> resultant kernel turned up what seems to be a locking problem. I'm not sure 
> if it's a real problem for normal operation, but it did crash my box so... 
> hopefully the pursuent /var/log/messages snippet is helpful.
> 
> Of course if anyone has any ideas on how to solve this 30-bit DMA problem I 
> would be happy to try it out.

My memory should arrive early next week, which will give me 1.5 GB, and I think I can force my
system to generate dma addresses in the first 1G. Then I should be able to generate the necessary fixes.

I'll let you know when I have a patch to test. Mine will initially be for wireless-2.6, but it
should be simple to add to wireless-dev.

Larry



From evanfoss at gmail.com  Sun Jan 14 07:28:39 2007
From: evanfoss at gmail.com (evan foss)
Date: Sun, 14 Jan 2007 01:28:39 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <4a55afb80701121459q4f23083t6f92a7e3bc85ccb1@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
	<45A7F501.9080202@docksud.com.ar>
	<4a55afb80701121459q4f23083t6f92a7e3bc85ccb1@mail.gmail.com>
Message-ID: <4a55afb80701132228q2e264606mf8948a45507e59ea@mail.gmail.com>

Results so far....
In a word Wow. It still doesn't work but I suspect that is could just
be my configuration. Power levels are not being reported correctly all
the time iwlist works but nothing else to my knowledge. I remember
there being talk of power level reporting patches. Is there anything I
can try adding. For the first time in a long time it does associate
with AP's but I can't dhcpcd eth1. I am using an access point next
door. Mine is down. I will test it with a good one at school on
Tuesday.

####To recap I am on...
MFG: Compaq V3000 (V3019US)
CPU: AMD Turion 64 x2
Kernel: linux-2.6.18-gentoo-r2
	I have SMP on and I am in 64 bit.
BCM Chip: BCM4311
BCM FW: V3 Sorry I don't recall exactly what version

####Patches used
patch_2.6.18.1_fix_leds
patch_2.6.18.1_for_PCI-E
radio_hwenable_for_2.6.18

####The following work
ifconfig eth1 up
iwconfig eth1 essid NAME channel #
kismet -c bcm43xx,eth1,bcm43xx
iwlist eth1 scan	<-the power levels are reported here

####The following don't work
iwconfig		<-the power levels are reported as always being 0
kismet			<-no power levels are reported
LED			<-always off (I have a slider switch on the front to turn radio on/off)
dhcpcd eth1		<-low transmit power???

#####The following don't work but might be my fault (I will get back
to you later on these)
dhcpcd eth1

#####example bad iwconfig power level reporting
eth1      IEEE 802.11b/g  ESSID:"linksys"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.437 GHz  Access Point: 00:16:B6:43:DE:C4
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0



-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From larry.finger at lwfinger.net  Sun Jan 14 07:31:23 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 14 Jan 2007 00:31:23 -0600
Subject: Testing report for new patches
In-Reply-To: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>
References: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>
Message-ID: <45A9CE3B.7060104@lwfinger.net>

Ryan Hurley wrote:
> Hi all,
> 
> I'm running a newer Compaq laptop (v3000 series) which has one of these
> wonderful broadcom PCI-E 4311 chips in them.  I've been testing the
> devicescape bcm43xx  drivers from the wireless-dev tree for awhile, but
> I still haven't gotten anything to work.  This is the first time I've
> submitted to a development list proper, so I apologize in advance if
> I've forgotten anything or done something incorrectly.
> 
--snip--

> 
> Even though lspci identifies this as a BCM4310 (UART), I've been told
> that this is actually a 4311 core.
> 
> I compiled a 2.6.19.1 <http://2.6.19.1> kernel to test out the new PCI-E
> patches this afternoon, and while it compiled cleanly and was able to
> scan, I was unable to associate with any access points, encrypted or
> otherwise.  The relevant parts of dmesg are:
> 
> ....
> [  127.078000] bcm43xx driver
> [  127.080000] ACPI: PCI Interrupt Link [LK2E] enabled at IRQ 19
> [  127.080000] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI
> 19 (level, high) -> IRQ 20
> [  127.080000] PCI: Setting latency timer of device 0000:01:00.0 to 64
> [  127.087000] bcm43xx: Chip ID 0x4311, rev 0x1

It is a 4311.

> [  127.087000] bcm43xx: Number of cores: 4
> [  127.087000] bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
> [  127.087000] bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, disabled
> [  127.087000] bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
> [  127.087000] bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
> [  127.088000] bcm43xx: PHY connected
> [  127.088000] bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> [  127.088000] bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver:
> 2050 Rev: 2)
> [  127.088000] bcm43xx: Radio turned off
> [  127.088000] bcm43xx: Radio turned off
> [  127.153000] bcm43xx: PHY connected
> [  127.252000] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> [  127.260000] bcm43xx: Radio turned on
> [  127.260000 ] bcm43xx: Radio enabled by hardware
> [  127.449000] bcm43xx: Chip initialized
> [  127.449000] bcm43xx: 32-bit DMA initialized
> [  127.449000] bcm43xx: Keys cleared
> [  127.449000] bcm43xx: Selected 802.11 core (phytype 2)
> [  128.758000] SoftMAC: Authentication response received from
> 00:11:50:a2:14:36 but no queue item exists.
> [  129.527000] bcm43xx: set security called, .level = 0, .enabled = 0,
> .encrypt = 0
> [  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
> .encrypt = 0
> [  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
> .encrypt = 0
> [  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
> .encrypt = 0
> [  130.631000] bcm43xx: set security called, .level = 0, .enabled = 0,
> .encrypt = 0
> [  130.899000] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  130.899000] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  130.900000] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  136.380000] SoftMAC: Authentication response received from
> 00:11:50:a2:14:36 but no queue item exists.
> [  137.977000] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  137.977000] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  137.978000 ] SoftMAC: Authentication response received from
> 00:14:6c:03:c5:ff but no queue item exists.
> [  141.200000] bcm43xx: Radio turned off
> 
> I turned the radio off myself when it failed to authenticate.  I
> repeated the process, (rmmod bcm43xx, modprobe 43xx, and then attempt to
> connect)  but got  an identical result.

If you do an 'iwlist s', what do you see? It seems that you have debugging turned on in SoftMAC, but
I see no indication that anything attempted to scan.

> Oh, and there's one other thing that I'd like to bring to the attention
> of this list.  The bcm43xx driver supplied with the default Ubuntu Edgy
> kernel works.  It runs very, very slowly (about 20 KB/s for download and
> even slower for upload) but it identifies my chip and authenticates- the
> whole 9 yards.  Just a heads up.

I'll have to pull that kernel to see what code is in there.

Larry



From gene.heskett at verizon.net  Sun Jan 14 10:27:43 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Sun, 14 Jan 2007 04:27:43 -0500
Subject: New problem with wlan0
In-Reply-To: <200701131435.40000.gene.heskett@verizon.net>
References: <200701131435.40000.gene.heskett@verizon.net>
Message-ID: <200701140427.43827.gene.heskett@verizon.net>

On Saturday 13 January 2007 14:35, Gene Heskett wrote:
>Greetings;
>
>I have bcm43xx setup now, and if I assign its address as opposed to
> using dhcp, it appears to work.
>
>Appears is the correct word I think, because its not receiving anything
>although I can:
>
>ssh into the dd-wrt and watch the packet counts rise with an ifconfig
> for both the ath0 and wifi0 interfaces.

Which is odd, because at the same time, the status page of its web page 
was showing 0 incoming packets, but read on dear friends.

>run etherape on the lappy, which puts the interface wlan0 into
> promiscuous mode, and watch traffic, some of which seems to come to
> addresses only valid outside my local net.  There is currently a
> 239:255:255:250 address being displayed by etherape.  But I note that
> traffic to this machine seems to be missing the final e in this
> machines alias name.  OTOH, a ping -f from here to that machines
> address doesn't show up in the etherape display.  Also the routers
> hostname is missing the final character in the etherape display, so
> maybe that is an etherape bug.
>
>This has the classic case of a bad route stamped all over it, but a
>route -n on the lappy shows:
>Destination	Gateway		genmask		flags	Metric	Use	Iface
>192.168.71.2	0.0.0.0		255.255.255.0	u	0	0	wlan0
>0.0.0.0		192.168.71.2	0.0.0.0		ug	0	0	wlan0
>
>which is correct.  The dd-wrt's address is 192.168.71.2 so it wouldn't
>clash with the old linksys at 192.168.71.1.
>
>The dd-wrt is functioning as a relay for dns requests also, and works
> fine from the other 2 machines here, all local dns entries are set to
> 192.168.71.2.
>
>I can't see the problem, but there sure is one.  Can I buy a clue?

As an experiment, I rmmod'd all the bcm43xx and ieee80211* modules, then 
modprobed ndiswrapper, but that did not appear to connect either.
So I rmmod'd ndiswrapper, and modprobed bcm43xx again.  This with 
NetworkManager turned off.  Several seconds later I noted the dd-wrt's 
web page was showing a packets rx'd count that was non-zero.  And I had a 
working connection!  And, it survived a network restart, and 
NetworkManager being restarted.

But of course its a laptop and will be shut down, which it has been now.
That tells me something in my /etc/modprobe.conf is wrong.  Whats in there 
now is from the bcm43xx-fwcutter packages README.fedora file.  And of 
course it does not work when powered up again.

So there is yet another clue but I don't grok it myself.



>Thanks.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From mb at bu3sch.de  Sun Jan 14 11:15:43 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 14 Jan 2007 11:15:43 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <20070113211030.11zo8cokcsoskccg@webmail.spamcop.net>
References: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
	<200701132051.52559.mb@bu3sch.de>
	<20070113211030.11zo8cokcsoskccg@webmail.spamcop.net>
Message-ID: <200701141115.43799.mb@bu3sch.de>

On Sunday 14 January 2007 03:10, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > > I haven't looked at the code yet, but I tried to locate the bad commit.  I
> > tried
> > > commit a13f85d8a8eb40dfd157ab78c2fb91b5765b7b9d, which is your last merge,
> > just
> > > before the SSB changes.
> >
> > Yeah, sure. I know that this is the commit which introduced this.
> 
> Basically, you set up DMA on the PCI device, but use it on the SSB device.
> That's inconsistent.  dma_alloc_coherent() is very picky on x86_64 and crashes
> if dev->dma_mask is NULL, which was the case for the SSB device.
> 
> Looking at the patch, it's clear that the SSB device is used instead of the PCI
> device in some places.  I restored the old logic.  If you meant to switch to
> SSB devices, then please remove the last PCI references from that file.

Already done. Please pull my tree and check if it still crashes.

> The patch is attached.  It fixes the crash.  I didn't check that it's complete.
> I really don't like the long chain of dereferences, and I hope you'll come up
> with something better.

No. I don't think we have shorter chains in other subsystems like PCI. They
are just hidden.

We could probably get rid of one level in the DMA code, by embedding the DMA
structs into the device struct. But I think there are more important things
to do at the moment.

> I still cannot associate.  The kernel log is attached.  Notice massive assertion
> failures.
> 
> > Note that LO calibration is horribly broken in my tree.
> 
> I guess that's what the assertion failures are about.

You're right.

> > So you have a very weak signal, if any. My 4318 has no signal, for example.
> > So basically don't expect to be able to transmit any data.
> > This includes association.
> 
> Actually, I could scan, and I got 7 access points around.  Only one is in my
> apartment.

RX sensitivity is not quite as bad.

> > But I think you should be able to assoc with a plain linville tree.
> 
> Nope.  Although I got DadWifi to work, and this message will we sent over it.
> So it's not like I'm missing something essential about d80211 stack.

Well, I don't really know what to do all about this.
It's strange. I have people reporting that exactly the same cards work
and people reporting that exactly the same cards don't work over and
over again.
So, well. What to do? :)

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jan 14 16:51:46 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 14 Jan 2007 16:51:46 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <20070114091812.hz2fokosw0o0cc0k@webmail.spamcop.net>
References: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
	<200701141115.43799.mb@bu3sch.de>
	<20070114091812.hz2fokosw0o0cc0k@webmail.spamcop.net>
Message-ID: <200701141651.46705.mb@bu3sch.de>

On Sunday 14 January 2007 15:18, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > Already done. Please pull my tree and check if it still crashes.
> 
> The crash is gone!  Thanks!  Still no association though.

Ok, nice.
Can you send me a complete dmesg log after you brought up the card
and tried to assoc/send some packets?

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jan 14 18:21:36 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 14 Jan 2007 18:21:36 +0100
Subject: What is in bcm43xx-wireless-dev.git?
In-Reply-To: <20070114113910.py9s0gggk8gwskwo@webmail.spamcop.net>
References: <20070113024543.aj2n40s4k0g0cgws@webmail.spamcop.net>
	<200701141651.46705.mb@bu3sch.de>
	<20070114113910.py9s0gggk8gwskwo@webmail.spamcop.net>
Message-ID: <200701141821.36894.mb@bu3sch.de>

On Sunday 14 January 2007 17:39, Pavel Roskin wrote:
> Quoting Michael Buesch <mb at bu3sch.de>:
> 
> > Ok, nice.
> > Can you send me a complete dmesg log after you brought up the card
> > and tried to assoc/send some packets?
> 
> Attached.

Ok, thanks. I don't see something unusual.

You should try to monitor traffic and see if the card is able to
transmit packets. It seems like it's able to receive.

-- 
Greetings Michael.


From evanfoss at gmail.com  Sun Jan 14 19:14:40 2007
From: evanfoss at gmail.com (evan foss)
Date: Sun, 14 Jan 2007 13:14:40 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <4a55afb80701132228q2e264606mf8948a45507e59ea@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>
	<45A7F501.9080202@docksud.com.ar>
	<4a55afb80701121459q4f23083t6f92a7e3bc85ccb1@mail.gmail.com>
	<4a55afb80701132228q2e264606mf8948a45507e59ea@mail.gmail.com>
Message-ID: <4a55afb80701141014n6b0ad36bp70fd6b21d3200eae@mail.gmail.com>

I sent this to the list but I don't know if it got to the list.

On 1/14/07, evan foss <evanfoss at gmail.com> wrote:
> Results so far....
> In a word Wow. It still doesn't work but I suspect that is could just
> be my configuration. Power levels are not being reported correctly all
> the time iwlist works but nothing else to my knowledge. I remember
> there being talk of power level reporting patches. Is there anything I
> can try adding. For the first time in a long time it does associate
> with AP's but I can't dhcpcd eth1. I am using an access point next
> door. Mine is down. I will test it with a good one at school on
> Tuesday.
>
> ####To recap I am on...
> MFG: Compaq V3000 (V3019US)
> CPU: AMD Turion 64 x2
> Kernel: linux-2.6.18-gentoo-r2
>         I have SMP on and I am in 64 bit.
> BCM Chip: BCM4311
> BCM FW: V3 Sorry I don't recall exactly what version
>
> ####Patches used
> patch_2.6.18.1_fix_leds
> patch_2.6.18.1_for_PCI-E
> radio_hwenable_for_2.6.18
>
> ####The following work
> ifconfig eth1 up
> iwconfig eth1 essid NAME channel #
> kismet -c bcm43xx,eth1,bcm43xx
> iwlist eth1 scan        <-the power levels are reported here
>
> ####The following don't work
> iwconfig                <-the power levels are reported as always being 0
> kismet                  <-no power levels are reported
> LED                     <-always off (I have a slider switch on the front to turn radio on/off)
> dhcpcd eth1             <-low transmit power???
>
> #####The following don't work but might be my fault (I will get back
> to you later on these)
> dhcpcd eth1
>
> #####example bad iwconfig power level reporting
> eth1      IEEE 802.11b/g  ESSID:"linksys"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.437 GHz  Access Point: 00:16:B6:43:DE:C4
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
>
>
> --
> http://www.coe.neu.edu/~efoss/
> http://evanfoss.googlepages.com/
>


-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From spitty at gmail.com  Sun Jan 14 19:27:45 2007
From: spitty at gmail.com (Ryan Hurley)
Date: Sun, 14 Jan 2007 13:27:45 -0500
Subject: Testing report for new patches
In-Reply-To: <45A9CE3B.7060104@lwfinger.net>
References: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>
	<45A9CE3B.7060104@lwfinger.net>
Message-ID: <f1a9e67e0701141027i39b51c1duf1f65f6738f9a2d5@mail.gmail.com>

Larry Finger wrote:
>
> If you do an 'iwlist s', what do you see? It seems that you have debugging
> turned on in SoftMAC, but
> I see no indication that anything attempted to scan.
>

The output from iwlist -s is attached, as is the complete dmesg log.
Scanning works fine (actually better than when I'm using ndiswrapper or
windows) but nothing connects.

If you need anything else just ask.
-Ryan Hurley
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070114/82bc3ce2/attachment.html>
-------------- next part --------------
[    0.000000] Linux version 2.6.19.1 (root at Apollo) (gcc version 4.1.2 20060928 (prerelease) (Ubuntu 4.1.1-13ubuntu5)) #1 SMP Sat Jan 13 14:48:50 EST 2007
[    0.000000] BIOS-provided physical RAM map:
[    0.000000]  BIOS-e820: 0000000000000000 - 000000000009dc00 (usable)
[    0.000000]  BIOS-e820: 000000000009dc00 - 00000000000a0000 (reserved)
[    0.000000]  BIOS-e820: 00000000000d2000 - 0000000000100000 (reserved)
[    0.000000]  BIOS-e820: 0000000000100000 - 000000001bf10000 (usable)
[    0.000000]  BIOS-e820: 000000001bf10000 - 000000001bf19000 (ACPI data)
[    0.000000]  BIOS-e820: 000000001bf19000 - 000000001bf80000 (ACPI NVS)
[    0.000000]  BIOS-e820: 000000001bf80000 - 0000000020000000 (reserved)
[    0.000000]  BIOS-e820: 00000000e0000000 - 00000000f0000000 (reserved)
[    0.000000]  BIOS-e820: 00000000fec00000 - 00000000fec10000 (reserved)
[    0.000000]  BIOS-e820: 00000000fee00000 - 00000000fee01000 (reserved)
[    0.000000]  BIOS-e820: 00000000fff80000 - 0000000100000000 (reserved)
[    0.000000] 447MB LOWMEM available.
[    0.000000] found SMP MP-table at 000f8790
[    0.000000] Entering add_active_range(0, 0, 114448) 0 entries of 256 used
[    0.000000] Zone PFN ranges:
[    0.000000]   DMA             0 ->     4096
[    0.000000]   Normal       4096 ->   114448
[    0.000000] early_node_map[1] active PFN ranges
[    0.000000]     0:        0 ->   114448
[    0.000000] On node 0 totalpages: 114448
[    0.000000]   DMA zone: 32 pages used for memmap
[    0.000000]   DMA zone: 0 pages reserved
[    0.000000]   DMA zone: 4064 pages, LIFO batch:0
[    0.000000]   Normal zone: 862 pages used for memmap
[    0.000000]   Normal zone: 109490 pages, LIFO batch:31
[    0.000000] DMI present.
[    0.000000] ACPI: RSDP (v000 HP                                    ) @ 0x000f87c0
[    0.000000] ACPI: RSDT (v001 HP     30B5     0x06040000  LTP 0x00000000) @ 0x1bf131f0
[    0.000000] ACPI: FADT (v001 HP     30B5     0x06040000 PTL_ 0x000f4240) @ 0x1bf18d52
[    0.000000] ACPI: MCFG (v001 HP     30B5     0x06040000  LTP 0x00000000) @ 0x1bf18dc6
[    0.000000] ACPI: MADT (v001 HP     30B5     0x06040000  LTP 0x00000000) @ 0x1bf18e02
[    0.000000] ACPI: BOOT (v001 HP     30B5     0x06040000  LTP 0x00000001) @ 0x1bf18e56
[    0.000000] ACPI: SSDT (v001 HP     30B5     0x06040000  LTP 0x00000001) @ 0x1bf18e7e
[    0.000000] ACPI: DSDT (v001 HP       30B5   0x06040000 MSFT 0x0100000e) @ 0x00000000
[    0.000000] Nvidia board detected. Ignoring ACPI timer override.
[    0.000000] If you got timer trouble try acpi_use_timer_override
[    0.000000] Nvidia board detected. Ignoring ACPI timer override.
[    0.000000] If you got timer trouble try acpi_use_timer_override
[    0.000000] Nvidia board detected. Ignoring ACPI timer override.
[    0.000000] If you got timer trouble try acpi_use_timer_override
[    0.000000] ACPI: PM-Timer IO Port: 0x1008
[    0.000000] ACPI: Local APIC address 0xfee00000
[    0.000000] ACPI: LAPIC (acpi_id[0x00] lapic_id[0x00] enabled)
[    0.000000] Processor #0 15:8 APIC version 16
[    0.000000] ACPI: LAPIC (acpi_id[0x01] lapic_id[0x01] enabled)
[    0.000000] Processor #1 15:8 APIC version 16
[    0.000000] ACPI: LAPIC_NMI (acpi_id[0x00] high edge lint[0x1])
[    0.000000] ACPI: LAPIC_NMI (acpi_id[0x01] high edge lint[0x1])
[    0.000000] ACPI: IOAPIC (id[0x02] address[0xfec00000] gsi_base[0])
[    0.000000] IOAPIC[0]: apic_id 2, version 17, address 0xfec00000, GSI 0-23
[    0.000000] ACPI: IRQ9 used by override.
[    0.000000] Enabling APIC mode:  Flat.  Using 1 I/O APICs
[    0.000000] Using ACPI (MADT) for SMP configuration information
[    0.000000] Allocating PCI resources starting at 30000000 (gap: 20000000:c0000000)
[    0.000000] Detected 1607.434 MHz processor.
[   15.642620] Built 1 zonelists.  Total pages: 113554
[   15.642622] Kernel command line: root=/dev/sda3 ro quiet splash
[   15.642812] mapped APIC to ffffd000 (fee00000)
[   15.642815] mapped IOAPIC to ffffc000 (fec00000)
[   15.642818] Enabling fast FPU save and restore... done.
[   15.642820] Enabling unmasked SIMD FPU exception support... done.
[   15.642823] Initializing CPU#0
[   15.642886] PID hash table entries: 2048 (order: 11, 8192 bytes)
[   15.642968] spurious 8259A interrupt: IRQ7.
[   15.647298] Console: colour VGA+ 80x25
[   15.647450] Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)
[   15.647665] Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)
[   15.655524] Memory: 445788k/457792k available (3372k kernel code, 11416k reserved, 1362k data, 236k init, 0k highmem)
[   15.655534] virtual kernel memory layout:
[   15.655536]     fixmap  : 0xfffb7000 - 0xfffff000   ( 288 kB)
[   15.655537]     vmalloc : 0xdc800000 - 0xfffb5000   ( 567 MB)
[   15.655539]     lowmem  : 0xc0000000 - 0xdbf10000   ( 447 MB)
[   15.655540]       .init : 0xc05a7000 - 0xc05e2000   ( 236 kB)
[   15.655542]       .data : 0xc044b05d - 0xc059fbcc   (1362 kB)
[   15.655543]       .text : 0xc0100000 - 0xc044b05d   (3372 kB)
[   15.655547] Checking if this processor honours the WP bit even in supervisor mode... Ok.
[   15.714873] Calibrating delay using timer specific routine.. 3216.77 BogoMIPS (lpj=1608389)
[   15.714909] Security Framework v1.0.0 initialized
[   15.714913] SELinux:  Disabled at boot.
[   15.714926] Mount-cache hash table entries: 512
[   15.715029] CPU: After generic identify, caps: 178bfbff ebd3fbff 00000000 00000000 00002001 00000000 0000001f
[   15.715038] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)
[   15.715041] CPU: L2 Cache: 256K (64 bytes/line)
[   15.715043] CPU 0(2) -> Core 0
[   15.715046] CPU: After all inits, caps: 178bfbff ebd3fbff 00000000 00000410 00002001 00000000 0000001f
[   15.715055] Compat vDSO mapped to ffffe000.
[   15.715063] Checking 'hlt' instruction... OK.
[   15.719000] Freeing SMP alternatives: 20k freed
[   15.719003] ACPI: Core revision 20060707
[   15.736242] CPU0: AMD Turion(tm) 64 X2  stepping 02
[   15.736260] Booting processor 1/1 eip 2000
[   15.748770] Initializing CPU#1
[   15.809106] Calibrating delay using timer specific routine.. 3214.18 BogoMIPS (lpj=1607093)
[   15.809112] CPU: After generic identify, caps: 178bfbff ebd3fbff 00000000 00000000 00002001 00000000 0000001f
[   15.809119] CPU: L1 I Cache: 64K (64 bytes/line), D cache 64K (64 bytes/line)
[   15.809122] CPU: L2 Cache: 256K (64 bytes/line)
[   15.809124] CPU 1(2) -> Core 1
[   15.809126] CPU: After all inits, caps: 178bfbff ebd3fbff 00000000 00000410 00002001 00000000 0000001f
[   15.806971] CPU1: AMD Turion(tm) 64 X2  stepping 02
[   15.806986] Total of 2 processors activated (6430.96 BogoMIPS).
[   15.807388] ENABLING IO-APIC IRQs
[   15.807662] ..TIMER: vector=0x31 apic1=0 pin1=0 apic2=-1 pin2=-1
[   15.918825] checking TSC synchronization across 2 CPUs: 
[    0.000001] CPU#0 had -1130 usecs TSC skew, fixed it up.
[    0.000004] CPU#1 had 1130 usecs TSC skew, fixed it up.
[    0.000998] Brought up 2 CPUs
[    0.038089] migration_cost=132
[    0.038216] checking if image is initramfs... it is
[    0.255083] Freeing initrd memory: 1953k freed
[    0.255351] NET: Registered protocol family 16
[    0.255428] ACPI: bus type pci registered
[    0.255437] PCI: Using MMCONFIG
[    0.255480] PCI: No mmconfig possible on 0:18
[    0.256082] Setting up standard PCI resources
[    0.264865] ACPI: Interpreter enabled
[    0.264870] ACPI: Using IOAPIC for interrupt routing
[    0.265627] ACPI: PCI Root Bridge [PCI0] (0000:00)
[    0.265632] PCI: Probing PCI hardware (bus 00)
[    0.265757] ACPI: Assume root bridge [\_SB_.PCI0] bus is 0
[    0.270356] Boot video device is 0000:00:05.0
[    0.271329] PCI: Transparent bridge - 0000:00:10.0
[    0.271364] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
[    0.366793] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.P2P0._PRT]
[    0.367477] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.XVR1._PRT]
[    0.367656] ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.XVR2._PRT]
[    0.368073] ACPI: PCI Interrupt Link [LNK1] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.368442] ACPI: PCI Interrupt Link [LNK2] (IRQs 16 17 18 19 20 21 22 23) *10
[    0.368805] ACPI: PCI Interrupt Link [LNK3] (IRQs 5 7 10 11 14 15) *0, disabled.
[    0.369181] ACPI: PCI Interrupt Link [LNK4] (IRQs 5 7 10 11 14 15) *0, disabled.
[    0.369542] ACPI: PCI Interrupt Link [LK1E] (IRQs 20) *0, disabled.
[    0.369908] ACPI: PCI Interrupt Link [LK2E] (IRQs 19) *10
[    0.370266] ACPI: PCI Interrupt Link [LK3E] (IRQs 21) *10
[    0.370625] ACPI: PCI Interrupt Link [LK4E] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.371008] ACPI: PCI Interrupt Link [LSMB] (IRQs 16 17 18 19 20 21 22 23) *10
[    0.371382] ACPI: PCI Interrupt Link [LSMU] (IRQs 16 17 18 19 20 21 22 23) *11
[    0.371742] ACPI: PCI Interrupt Link [LUS0] (IRQs 16 17 18 19 20 21 22 23) *11
[    0.372110] ACPI: PCI Interrupt Link [LUS2] (IRQs 16 17 18 19 20 21 22 23) *7
[    0.372470] ACPI: PCI Interrupt Link [LMAC] (IRQs 16 17 18 19 20 21 22 23) *11
[    0.372840] ACPI: PCI Interrupt Link [LAZA] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.373215] ACPI: PCI Interrupt Link [LACI] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.373578] ACPI: PCI Interrupt Link [LMCI] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.373947] ACPI: PCI Interrupt Link [LPID] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.374320] ACPI: PCI Interrupt Link [LTID] (IRQs 16 17 18 19 20 21 22 23) *5
[    0.374687] ACPI: PCI Interrupt Link [LSI1] (IRQs 16 17 18 19 20 21 22 23) *0, disabled.
[    0.374834] Linux Plug and Play Support v0.97 (c) Adam Belay
[    0.374843] pnp: PnP ACPI init
[    0.377905] pnp: PnP ACPI: found 11 devices
[    0.378066] SCSI subsystem initialized
[    0.378127] libata version 2.00 loaded.
[    0.378188] usbcore: registered new interface driver usbfs
[    0.378214] usbcore: registered new interface driver hub
[    0.378248] usbcore: registered new device driver usb
[    0.378279] PCI: Using ACPI for IRQ routing
[    0.378283] PCI: If a device doesn't work, try "pci=routeirq".  If it helps, post a report
[    0.378900] pnp: 00:03: ioport range 0x1000-0x107f could not be reserved
[    0.378904] pnp: 00:03: ioport range 0x1080-0x10ff has been reserved
[    0.378907] pnp: 00:03: ioport range 0x1400-0x147f has been reserved
[    0.378910] pnp: 00:03: ioport range 0x1480-0x14ff could not be reserved
[    0.378913] pnp: 00:03: ioport range 0x1800-0x187f has been reserved
[    0.378916] pnp: 00:03: ioport range 0x1880-0x18ff has been reserved
[    0.378919] pnp: 00:03: ioport range 0x2000-0x203f has been reserved
[    0.379131] PCI: Bridge: 0000:00:02.0
[    0.379133]   IO window: disabled.
[    0.379137]   MEM window: c3000000-c30fffff
[    0.379140]   PREFETCH window: disabled.
[    0.379142] PCI: Bridge: 0000:00:03.0
[    0.379145]   IO window: 4000-4fff
[    0.379149]   MEM window: c8000000-c87fffff
[    0.379151]   PREFETCH window: disabled.
[    0.379154] PCI: Bridge: 0000:00:10.0
[    0.379155]   IO window: disabled.
[    0.379160]   MEM window: disabled.
[    0.379163]   PREFETCH window: disabled.
[    0.379177] PCI: Setting latency timer of device 0000:00:02.0 to 64
[    0.379185] PCI: Setting latency timer of device 0000:00:03.0 to 64
[    0.379196] PCI: Setting latency timer of device 0000:00:10.0 to 64
[    0.379228] NET: Registered protocol family 2
[    0.390940] IP route cache hash table entries: 4096 (order: 2, 16384 bytes)
[    0.391028] TCP established hash table entries: 16384 (order: 5, 131072 bytes)
[    0.391145] TCP bind hash table entries: 8192 (order: 4, 65536 bytes)
[    0.391207] TCP: Hash tables configured (established 16384 bind 8192)
[    0.391210] TCP reno registered
[    0.391345] Simple Boot Flag at 0x36 set to 0x1
[    0.556000] audit: initializing netlink socket (disabled)
[    0.556000] audit(1168779637.851:1): initialized
[    0.557000] Installing knfsd (copyright (C) 1996 okir at monad.swb.de).
[    0.557000] NTFS driver 2.1.27 [Flags: R/O].
[    0.557000] io scheduler noop registered
[    0.557000] io scheduler cfq registered (default)
[    0.568000] PCI: Setting latency timer of device 0000:00:02.0 to 64
[    0.568000] pcie_portdrv_probe->Dev[02fc:10de] has invalid IRQ. Check vendor BIOS
[    0.568000] assign_interrupt_mode Found MSI capability
[    0.568000] Allocate Port Service[0000:00:02.0:pcie00]
[    0.568000] Allocate Port Service[0000:00:02.0:pcie03]
[    0.568000] PCI: Setting latency timer of device 0000:00:03.0 to 64
[    0.568000] pcie_portdrv_probe->Dev[02fd:10de] has invalid IRQ. Check vendor BIOS
[    0.568000] assign_interrupt_mode Found MSI capability
[    0.568000] Allocate Port Service[0000:00:03.0:pcie00]
[    0.568000] Allocate Port Service[0000:00:03.0:pcie03]
[    0.568000] pci_hotplug: PCI Hot Plug PCI Core version: 0.5
[    0.568000] pciehp: PCI Express Hot Plug Controller Driver version: 0.4
[    0.568000] shpchp: Standard Hot Plug PCI Controller Driver version: 0.4
[    0.569000] ACPI: AC Adapter [ADP1] (on-line)
[    0.611000] ACPI: Battery Slot [BAT0] (battery present)
[    0.611000] ACPI: Power Button (FF) [PWRF]
[    0.611000] ACPI: Lid Switch [LID0]
[    0.611000] ACPI: Sleep Button (CM) [SLPB]
[    0.611000] ACPI: Power Button (CM) [PWRB]
[    0.611000] ACPI: Video Device [VGA] (multi-head: yes  rom: no  post: no)
[    0.611000] Using specific hotkey driver
[    0.611000] ACPI: Processor [CPU0] (supports 8 throttling states)
[    0.611000] ACPI: Processor [CPU1] (supports 8 throttling states)
[    0.623000] ACPI: Thermal Zone [TZS0] (44 C)
[    0.628000] ACPI: Thermal Zone [TZS1] (47 C)
[    0.649000] Real Time Clock Driver v1.12ac
[    0.649000] Linux agpgart interface v0.101 (c) Dave Jones
[    0.649000] [drm] Initialized drm 1.0.1 20051102
[    0.650000] RAMDISK driver initialized: 16 RAM disks of 65536K size 1024 blocksize
[    0.650000] loop: loaded (max 8 devices)
[    0.650000] forcedeth.c: Reverse Engineered nForce ethernet driver. Version 0.57.
[    0.650000] ACPI: PCI Interrupt Link [LMAC] enabled at IRQ 23
[    0.650000] ACPI: PCI Interrupt 0000:00:14.0[A] -> Link [LMAC] -> GSI 23 (level, high) -> IRQ 16
[    0.651000] PCI: Setting latency timer of device 0000:00:14.0 to 64
[    0.651000] forcedeth: using HIGHDMA
[    1.163000] eth0: forcedeth.c: subsystem: 0103c:30b5 bound to 0000:00:14.0
[    1.163000] Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
[    1.163000] ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
[    1.163000] NFORCE-MCP51: IDE controller at PCI slot 0000:00:0d.0
[    1.163000] NFORCE-MCP51: chipset revision 241
[    1.163000] NFORCE-MCP51: not 100% native mode: will probe irqs later
[    1.163000] NFORCE-MCP51: 0000:00:0d.0 (rev f1) UDMA133 controller
[    1.163000]     ide0: BM-DMA at 0x3080-0x3087, BIOS settings: hda:pio, hdb:pio
[    1.163000]     ide1: BM-DMA at 0x3088-0x308f, BIOS settings: hdc:pio, hdd:pio
[    1.163000] Probing IDE interface ide0...
[    1.682000] Probing IDE interface ide1...
[    2.354000] hdc: PHILIPS CD-RW/DVD-ROM SCB5265, ATAPI CD/DVD-ROM drive
[    2.966000] ide1 at 0x170-0x177,0x376 on irq 15
[    2.966000] Probing IDE interface ide0...
[    3.486000] hdc: ATAPI 24X DVD-ROM CD-R/RW drive, 2048kB Cache, DMA
[    3.486000] Uniform CD-ROM driver Revision: 3.20
[    3.492000] Loading iSCSI transport class v2.0-724.<7>sata_nv 0000:00:0e.0: version 2.0
[    3.492000] PCI: Enabling device 0000:00:0e.0 (0005 -> 0007)
[    3.492000] ACPI: PCI Interrupt Link [LTID] enabled at IRQ 22
[    3.492000] ACPI: PCI Interrupt 0000:00:0e.0[A] -> Link [LTID] -> GSI 22 (level, high) -> IRQ 17
[    3.492000] PCI: Setting latency timer of device 0000:00:0e.0 to 64
[    3.492000] ata1: SATA max UDMA/133 cmd 0x30B0 ctl 0x30A6 bmdma 0x3090 irq 17
[    3.492000] ata2: SATA max UDMA/133 cmd 0x30A8 ctl 0x30A2 bmdma 0x3098 irq 17
[    3.492000] scsi0 : sata_nv
[    3.949000] ata1: SATA link up 1.5 Gbps (SStatus 113 SControl 300)
[    3.950000] ata1.00: ATA-7, max UDMA/100, 78165360 sectors: LBA48 
[    3.950000] ata1.00: ata1: dev 0 multi count 16
[    3.954000] ata1.00: configured for UDMA/100
[    3.954000] scsi1 : sata_nv
[    4.257000] ata2: SATA link down (SStatus 0 SControl 300)
[    4.268000] ATA: abnormal status 0x7F on port 0x30AF
[    4.268000] scsi 0:0:0:0: Direct-Access     ATA      ST94813AS        7.24 PQ: 0 ANSI: 5
[    4.268000] SCSI device sda: 78165360 512-byte hdwr sectors (40021 MB)
[    4.268000] sda: Write Protect is off
[    4.268000] sda: Mode Sense: 00 3a 00 00
[    4.268000] SCSI device sda: drive cache: write back
[    4.268000] SCSI device sda: 78165360 512-byte hdwr sectors (40021 MB)
[    4.268000] sda: Write Protect is off
[    4.268000] sda: Mode Sense: 00 3a 00 00
[    4.268000] SCSI device sda: drive cache: write back
[    4.268000]  sda: sda1 sda2 sda3
[    4.364000] sd 0:0:0:0: Attached scsi disk sda
[    4.364000] sd 0:0:0:0: Attached scsi generic sg0 type 0
[    4.365000] ACPI: PCI Interrupt Link [LUS2] enabled at IRQ 21
[    4.365000] ACPI: PCI Interrupt 0000:00:0b.1[B] -> Link [LUS2] -> GSI 21 (level, high) -> IRQ 18
[    4.365000] PCI: Setting latency timer of device 0000:00:0b.1 to 64
[    4.365000] ehci_hcd 0000:00:0b.1: EHCI Host Controller
[    4.365000] ehci_hcd 0000:00:0b.1: new USB bus registered, assigned bus number 1
[    4.365000] ehci_hcd 0000:00:0b.1: debug port 1
[    4.365000] PCI: cache line size of 64 is not supported by device 0000:00:0b.1
[    4.365000] ehci_hcd 0000:00:0b.1: irq 18, io mem 0xc0005000
[    4.365000] ehci_hcd 0000:00:0b.1: USB 2.0 started, EHCI 1.00, driver 10 Dec 2004
[    4.365000] usb usb1: configuration #1 chosen from 1 choice
[    4.365000] hub 1-0:1.0: USB hub found
[    4.365000] hub 1-0:1.0: 8 ports detected
[    4.466000] ohci_hcd: 2006 August 04 USB 1.1 'Open' Host Controller (OHCI) Driver (PCI)
[    4.466000] ACPI: PCI Interrupt Link [LUS0] enabled at IRQ 20
[    4.466000] ACPI: PCI Interrupt 0000:00:0b.0[A] -> Link [LUS0] -> GSI 20 (level, high) -> IRQ 19
[    4.466000] PCI: Setting latency timer of device 0000:00:0b.0 to 64
[    4.466000] ohci_hcd 0000:00:0b.0: OHCI Host Controller
[    4.466000] ohci_hcd 0000:00:0b.0: new USB bus registered, assigned bus number 2
[    4.466000] ohci_hcd 0000:00:0b.0: irq 19, io mem 0xc0004000
[    4.519000] usb usb2: configuration #1 chosen from 1 choice
[    4.519000] hub 2-0:1.0: USB hub found
[    4.519000] hub 2-0:1.0: 8 ports detected
[    4.620000] USB Universal Host Controller Interface driver v3.0
[    4.620000] Initializing USB Mass Storage driver...
[    4.620000] usbcore: registered new interface driver usb-storage
[    4.620000] USB Mass Storage support registered.
[    4.620000] usbcore: registered new interface driver libusual
[    4.620000] usbcore: registered new interface driver hiddev
[    4.620000] usbcore: registered new interface driver usbhid
[    4.620000] drivers/usb/input/hid-core.c: v2.6:USB HID core driver
[    4.620000] PNP: PS/2 Controller [PNP0303:KBD0,PNP0f13:PS2M] at 0x60,0x64 irq 1,12
[    4.620000] i8042.c: Detected active multiplexing controller, rev 1.1.
[    4.620000] serio: i8042 KBD port at 0x60,0x64 irq 1
[    4.620000] serio: i8042 AUX0 port at 0x60,0x64 irq 12
[    4.620000] serio: i8042 AUX1 port at 0x60,0x64 irq 12
[    4.620000] serio: i8042 AUX2 port at 0x60,0x64 irq 12
[    4.620000] serio: i8042 AUX3 port at 0x60,0x64 irq 12
[    4.620000] mice: PS/2 mouse device common for all mice
[    4.620000] input: PC Speaker as /class/input/input0
[    4.620000] Advanced Linux Sound Architecture Driver Version 1.0.13 (Tue Nov 28 14:07:24 2006 UTC).
[    4.621000] ACPI: PCI Interrupt Link [LAZA] enabled at IRQ 19
[    4.621000] ACPI: PCI Interrupt 0000:00:10.1[B] -> Link [LAZA] -> GSI 19 (level, high) -> IRQ 20
[    4.621000] PCI: Setting latency timer of device 0000:00:10.1 to 64
[    4.623000] input: AT Translated Set 2 keyboard as /class/input/input1
[    4.719000] ALSA device list:
[    4.719000]   #0: HDA NVidia at 0xc0000000 irq 20
[    4.719000] IPv4 over IPv4 tunneling driver
[    4.719000] GRE over IPv4 tunneling driver
[    4.719000] TCP cubic registered
[    4.719000] Initializing XFRM netlink socket
[    4.719000] NET: Registered protocol family 1
[    4.719000] NET: Registered protocol family 17
[    4.719000] NET: Registered protocol family 15
[    4.719000] powernow-k8: Found 2 AMD Turion(tm) 64 X2  processors (version 2.00.00)
[    4.719000] powernow-k8:    0 : fid 0x8 (1600 MHz), vid 0x12
[    4.719000] powernow-k8:    1 : fid 0x0 (800 MHz), vid 0x1e
[    4.719000] Starting balanced_irq
[    4.719000] Using IPI Shortcut mode
[    4.719000] drivers/rtc/hctosys.c: unable to open rtc device (rtc0)
[    4.719000] Freeing unused kernel memory: 236k freed
[    4.720000] Time: acpi_pm clocksource has been installed.
[    6.159000] Synaptics Touchpad, model: 1, fw: 6.2, id: 0x1a0b1, caps: 0xa04713/0x200000
[    6.191000] input: SynPS/2 Synaptics TouchPad as /class/input/input2
[    6.193000] psmouse.c: TouchPad at isa0060/serio4/input0 lost sync at byte 1
[    6.391000] kjournald starting.  Commit interval 5 seconds
[    6.392000] EXT3-fs: mounted filesystem with ordered data mode.
[    7.355000] Synaptics Touchpad, model: 1, fw: 6.2, id: 0x1a0b1, caps: 0xa04713/0x200000
[    7.387000] input: SynPS/2 Synaptics TouchPad as /class/input/input3
[   16.603000] eth0: no link during initialization.
[   17.325000] ndiswrapper version 1.33 loaded (preempt=no,smp=yes)
[   17.406000] ndiswrapper: driver bcmwl5 (Broadcom,03/23/2006, 4.40.19.0) loaded
[   17.407000] ACPI: PCI Interrupt Link [LK2E] enabled at IRQ 19
[   17.407000] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19 (level, high) -> IRQ 20
[   17.407000] PCI: Setting latency timer of device 0000:01:00.0 to 64
[   17.413000] ndiswrapper: using IRQ 20
[   18.103000] wlan0: ethernet device 00:14:a5:fd:91:3a using NDIS driver: bcmwl5, version: 0x4281300, NDIS version: 0x501, vendor: '', 14E4:4312.5.conf
[   18.103000] wlan0: encryption modes supported: WEP; TKIP with WPA, WPA2, WPA2PSK; AES/CCMP with WPA, WPA2, WPA2PSK
[   18.103000] usbcore: registered new interface driver ndiswrapper
[   18.108000] ndiswrapper: changing interface name from 'wlan0' to 'eth1'
[   18.172000] Adding 506036k swap on /dev/disk/by-uuid/54eb9453-65ab-4c4d-b89d-88493b86009e.  Priority:-1 extents:1 across:506036k
[   18.271000] EXT3 FS on sda3, internal journal
[   18.459000] NTFS volume version 3.1.
[   31.137000] Capability LSM initialized
[   59.472000] ndiswrapper: device eth1 removed
[   59.472000] ACPI: PCI interrupt for device 0000:01:00.0 disabled
[   59.472000] usbcore: deregistering interface driver ndiswrapper
[   68.204000] ieee80211_crypt: registered algorithm 'NULL'
[   68.208000] ieee80211: 802.11 data/management/control stack, git-1.1.13
[   68.208000] ieee80211: Copyright (C) 2004-2005 Intel Corporation <jketreno at linux.intel.com>
[   68.234000] bcm43xx driver
[   68.235000] ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LK2E] -> GSI 19 (level, high) -> IRQ 20
[   68.235000] PCI: Setting latency timer of device 0000:01:00.0 to 64
[   68.242000] bcm43xx: Chip ID 0x4311, rev 0x1
[   68.242000] bcm43xx: Number of cores: 4
[   68.242000] bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
[   68.242000] bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, disabled
[   68.242000] bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
[   68.242000] bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
[   68.244000] bcm43xx: PHY connected
[   68.244000] bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
[   68.245000] bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
[   68.245000] bcm43xx: Radio turned off
[   68.245000] bcm43xx: Radio turned off
[   68.314000] bcm43xx: PHY connected
[   68.427000] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
[   68.435000] bcm43xx: Radio turned on
[   68.435000] bcm43xx: Radio enabled by hardware
[   68.620000] bcm43xx: Chip initialized
[   68.621000] bcm43xx: 32-bit DMA initialized
[   68.621000] bcm43xx: Keys cleared
[   68.621000] bcm43xx: Selected 802.11 core (phytype 2)
[   70.595000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[   71.627000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[   71.627000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[   71.627000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[   71.627000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[  130.867000] bcm43xx: Radio turned off
[  130.867000] bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
[  130.867000] bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
[  130.867000] bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
[  130.868000] bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
[  130.868000] bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
[  130.868000] bcm43xx: DMA-32 0x0220 (TX) max used slots: 3/512
[  130.869000] bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
[  132.885000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[  133.019000] bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
[  133.027000] bcm43xx: Radio turned on
[  133.027000] bcm43xx: Radio enabled by hardware
[  133.214000] bcm43xx: Chip initialized
[  133.214000] bcm43xx: 32-bit DMA initialized
[  133.214000] bcm43xx: Keys cleared
[  133.214000] bcm43xx: Selected 802.11 core (phytype 2)
[  134.227000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[  134.227000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[  134.227000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
[  134.227000] bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
-------------- next part --------------
eth1      Scan completed :
          Cell 01 - Address: 00:12:17:B0:7D:8E
                    ESSID:"Norman'sNetwork"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-68 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 70ms ago
          Cell 02 - Address: 00:11:50:A2:14:36
                    ESSID:"Neonet"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:3
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-58 dBm  Noise level=-69 dBm
                    IE: WPA Version 1
                        Group Cipher : TKIP 
                        Pairwise Ciphers (1) : TKIP 
                        Authentication Suites (1) : PSK  
                    Extra: Last beacon: 138ms ago
          Cell 03 - Address: 00:18:39:65:19:7C
                    ESSID:"linksys"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-74 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 30ms ago
          Cell 04 - Address: 00:03:93:EA:91:C9
                    ESSID:"dreamland"
                    Protocol:IEEE 802.11g
                    Mode:Master
                    Channel:11
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-77 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 2796ms ago
          Cell 05 - Address: 00:14:BF:2B:A1:EF
                    ESSID:"linksys"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-74 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 61ms ago
          Cell 06 - Address: 00:18:39:E4:3B:45
                    ESSID:"Elroy"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-81 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 254ms ago
          Cell 07 - Address: 00:0F:66:B2:0E:2E
                    ESSID:"<hidden>"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-84 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 267ms ago
          Cell 08 - Address: 00:13:10:0E:DA:13
                    ESSID:"scubear"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-83 dBm  Noise level=-69 dBm
                    Extra: Last beacon: 1800ms ago

From larry.finger at lwfinger.net  Mon Jan 15 00:54:30 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 14 Jan 2007 17:54:30 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <4a55afb80701132228q2e264606mf8948a45507e59ea@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>	<9b3e2dc20701121050p52e13d92r1ec78e1881bbed3@mail.gmail.com>	<45A7F501.9080202@docksud.com.ar>	<4a55afb80701121459q4f23083t6f92a7e3bc85ccb1@mail.gmail.com>
	<4a55afb80701132228q2e264606mf8948a45507e59ea@mail.gmail.com>
Message-ID: <45AAC2B6.50902@lwfinger.net>

evan foss wrote:
> Results so far....
> In a word Wow. It still doesn't work but I suspect that is could just
> be my configuration. Power levels are not being reported correctly all
> the time iwlist works but nothing else to my knowledge. I remember
> there being talk of power level reporting patches. Is there anything I
> can try adding. For the first time in a long time it does associate
> with AP's but I can't dhcpcd eth1. I am using an access point next
> door. Mine is down. I will test it with a good one at school on
> Tuesday.
> 
> ####To recap I am on...
> MFG: Compaq V3000 (V3019US)
> CPU: AMD Turion 64 x2
> Kernel: linux-2.6.18-gentoo-r2
> 	I have SMP on and I am in 64 bit.
> BCM Chip: BCM4311
> BCM FW: V3 Sorry I don't recall exactly what version
> 
> ####Patches used
> patch_2.6.18.1_fix_leds
> patch_2.6.18.1_for_PCI-E
> radio_hwenable_for_2.6.18

To get signal levels reported correctly, you also need patch_2.6.18.1_signal_quality.

> ####The following work
> ifconfig eth1 up
> iwconfig eth1 essid NAME channel #
> kismet -c bcm43xx,eth1,bcm43xx
> iwlist eth1 scan	<-the power levels are reported here
> 
> ####The following don't work
> iwconfig		<-the power levels are reported as always being 0
> kismet			<-no power levels are reported
> LED			<-always off (I have a slider switch on the front to turn radio on/off)

This one needs watching. The LED has worked on previous computers.

> dhcpcd eth1		<-low transmit power???

Most likely. How far are you from the AP?

> #####The following don't work but might be my fault (I will get back
> to you later on these)
> dhcpcd eth1
> 
> #####example bad iwconfig power level reporting
> eth1      IEEE 802.11b/g  ESSID:"linksys"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.437 GHz  Access Point: 00:16:B6:43:DE:C4
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0

The received signal and noise levels should be fixed by the patch listed above.

Larry



From larry.finger at lwfinger.net  Mon Jan 15 01:02:55 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 14 Jan 2007 18:02:55 -0600
Subject: Testing report for new patches
In-Reply-To: <f1a9e67e0701141027i39b51c1duf1f65f6738f9a2d5@mail.gmail.com>
References: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>	
	<45A9CE3B.7060104@lwfinger.net>
	<f1a9e67e0701141027i39b51c1duf1f65f6738f9a2d5@mail.gmail.com>
Message-ID: <45AAC4AF.4090601@lwfinger.net>

Ryan Hurley wrote:
> *Larry Finger* wrote:
> 
>     If you do an 'iwlist s', what do you see? It seems that you have
>     debugging turned on in SoftMAC, but
>     I see no indication that anything attempted to scan.
> 
> 
> The output from iwlist -s is attached, as is the complete dmesg log. 
> Scanning works fine (actually better than when I'm using ndiswrapper or
> windows) but nothing connects.
> 
> If you need anything else just ask.
> -Ryan Hurley
> 
> 
> 
> ------------------------------------------------------------------------
> 
> eth1      Scan completed :
>           Cell 01 - Address: 00:12:17:B0:7D:8E
>                     ESSID:"Norman'sNetwork"
>                     Protocol:IEEE 802.11bg
>                     Mode:Master
>                     Channel:6
>                     Encryption key:off
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
>                               11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>                               48 Mb/s; 54 Mb/s
>                     Quality=100/100  Signal level=-68 dBm  Noise level=-69 dBm
>                     Extra: Last beacon: 70ms ago
>           Cell 02 - Address: 00:11:50:A2:14:36
>                     ESSID:"Neonet"
>                     Protocol:IEEE 802.11bg
>                     Mode:Master
>                     Channel:3
>                     Encryption key:on
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
>                               11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>                               48 Mb/s; 54 Mb/s
>                     Quality=100/100  Signal level=-58 dBm  Noise level=-69 dBm

This is the strongest signal in your scan list. With the minimal TX signal strength
in the current version for 4311's, I doubt that you would be able to authenticate.

Larry



From badmuthahubbard at gmail.com  Mon Jan 15 01:49:45 2007
From: badmuthahubbard at gmail.com (Chuckk Hubbard)
Date: Sun, 14 Jan 2007 19:49:45 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
Message-ID: <8200bab70701141649r1e759859p9d79686ac2c2a1cc@mail.gmail.com>

Thanks, Larry.  Your 2.6.19.1 patch is the first thing that has
allowed Linux to register my card as a wlan.  I will patiently wait
for the support to develop if it does, but for now at the very least I
can use it.

-Chuckk


On 1/12/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> The PCI-E modifications to bcm43xx do not set up the interrupt vector
> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
>
> John,
>
> This fix should be applied to wireless-2.6 _AND_ pushed upstream to
> 2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
> This version incorporates Michael Buesch's comments, and forgoes some
> code clean-ups that were in the first version/
>
> Larry
>
>
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -2704,8 +2704,8 @@ static int bcm43xx_probe_cores(struct bc
>                 sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>
>                 /* extract core_id, core_rev, core_vendor */
> -               core_id = (sb_id_hi & 0xFFF0) >> 4;
> -               core_rev = (sb_id_hi & 0xF);
> +               core_id = (sb_id_hi & 0x8FF0) >> 4;
> +               core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
>                 core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
>
>                 dprintk(KERN_INFO PFX "Core %d: ID 0x%x, rev 0x%x, vendor 0x%x\n",
> @@ -2876,7 +2876,10 @@ static int bcm43xx_wireless_core_init(st
>                 sbimconfiglow = bcm43xx_read32(bcm, BCM43xx_CIR_SBIMCONFIGLOW);
>                 sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_REQUEST_TOUT_MASK;
>                 sbimconfiglow &= ~ BCM43xx_SBIMCONFIGLOW_SERVICE_TOUT_MASK;
> -               sbimconfiglow |= 0x32;
> +               if (bcm->bustype == BCM43xx_BUSTYPE_PCI)
> +                       sbimconfiglow |= 0x32;
> +               else
> +                       sbimconfiglow |= 0x53;
>                 bcm43xx_write32(bcm, BCM43xx_CIR_SBIMCONFIGLOW, sbimconfiglow);
>         }
>
> @@ -3080,7 +3083,7 @@ static int bcm43xx_setup_backplane_pci_c
>         if (err)
>                 goto out;
>
> -       if (bcm->current_core->rev < 6 ||
> +       if (bcm->current_core->rev < 6 &&
>                 bcm->current_core->id == BCM43xx_COREID_PCI) {
>                 value = bcm43xx_read32(bcm, BCM43xx_CIR_SBINTVEC);
>                 value |= (1 << backplane_flag_nr);
>
> ---
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>


-- 
"Far and away the best prize that life has to offer is the chance to
work hard at work worth doing."
-Theodore Roosevelt


From ftoledo at docksud.com.ar  Mon Jan 15 15:27:10 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Mon, 15 Jan 2007 11:27:10 -0300
Subject: 4311 work and timeouts
Message-ID: <45AB8F3E.5020108@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

i testing traffic now
i try nmap 192.168.1.0/24 (to scan my network ) and the device is die
if i try to unload the bcm43xx module, i have a deadlook (cant shutdown,
   only hardware reset)


SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Canceling existing associate request!
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Already associating or associated to 00:0e:2e:64:77:fd
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
ACPI: PCI interrupt for device 0000:10:00.0 disabled
bcm43xx driver
ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:10:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, enabled
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio hardware status changed to enabled
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
NETDEV WATCHDOG: eth1: transmit timed out
bcm43xx: Controller RESET (TX timeout) ...
bcm43xx: select_wireless_core: cleanup
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 411/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: IRQ_READY timeout
bcm43xx: core_up for active 802.11 core failed (-19)
bcm43xx: Controller restart failed
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out
NETDEV WATCHDOG: eth1: transmit timed out

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFq489z8H9Vs7bTsMRAtDIAKCwdn5Tbwt+mLSCSmcVYqedgwkoyQCgx4LY
h3jDY81/gfRyoJdh7psjG/w=
=FOVu
-----END PGP SIGNATURE-----


From ftoledo at docksud.com.ar  Mon Jan 15 15:27:25 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Mon, 15 Jan 2007 11:27:25 -0300
Subject: 4311 softmac auth
Message-ID: <45AB8F4D.6070007@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

i can scan
i see the ap associated:

eth1      IEEE 802.11b/g  ESSID:"prosistem"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.437 GHz  Access Point:
00:0E:2E:64:77:FD
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=111/100  Signal level=-29 dBm  Noise level=-69 dBm
          Rx invalid nwid:0  Rx invalid crypt:344  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

but don't connect,
i see that the bit rate is 1Mb , i can't change it
ntbkragnarok:~# iwconfig eth1 rate 11
Error for wireless request "Set Bit Rate" (8B20) :
    SET failed on device eth1 ; Invalid argument.


some dmesg debug:

SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 9/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio hardware status changed to disabled
bcm43xx: Radio hardware status changed to enabled
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Canceling existing associate request!
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 0/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
bcm43xx: Radio hardware status changed to enabled
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
ACPI: PCI interrupt for device 0000:10:00.0 disabled
bcm43xx driver
ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:10:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, enabled
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 4/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.
printk: 18 messages suppressed.
SoftMAC: Authentication response received from 00:40:f4:de:a5:62 but no
queue item exists.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFq49Mz8H9Vs7bTsMRAv7qAKC6Uwud61ztoabW4tWbzTtDv9e3HwCg7q2T
FCSw8/Rm/J36+7cL68XPew4=
=N+fB
-----END PGP SIGNATURE-----


From larry.finger at lwfinger.net  Mon Jan 15 15:48:44 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 15 Jan 2007 08:48:44 -0600
Subject: 4311 softmac auth
In-Reply-To: <45AB8F4D.6070007@docksud.com.ar>
References: <45AB8F4D.6070007@docksud.com.ar>
Message-ID: <45AB944C.5070809@lwfinger.net>

Fernando Toledo wrote:
> i can scan
> i see the ap associated:
> 
> eth1      IEEE 802.11b/g  ESSID:"prosistem"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.437 GHz  Access Point:
> 00:0E:2E:64:77:FD
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=111/100  Signal level=-29 dBm  Noise level=-69 dBm

With this signal/noise, you should be able to associate and authenticate.

>           Rx invalid nwid:0  Rx invalid crypt:344  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> but don't connect,
> i see that the bit rate is 1Mb , i can't change it
> ntbkragnarok:~# iwconfig eth1 rate 11
> Error for wireless request "Set Bit Rate" (8B20) :
>     SET failed on device eth1 ; Invalid argument.

The syntax is 'iwconfig eth1 rate 11M'.

Please send the output of 'iwlist s', 'iwconfig', and 'ifconfig'. Do other machines and/or OS's
connect to this AP? Have you tried a different channel?

Larry



From larry.finger at lwfinger.net  Mon Jan 15 16:18:58 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 15 Jan 2007 09:18:58 -0600
Subject: 4311 work and timeouts
In-Reply-To: <45AB8F3E.5020108@docksud.com.ar>
References: <45AB8F3E.5020108@docksud.com.ar>
Message-ID: <45AB9B62.9030908@lwfinger.net>

Fernando Toledo wrote:
> i testing traffic now
> i try nmap 192.168.1.0/24 (to scan my network ) and the device is die
> if i try to unload the bcm43xx module, i have a deadlook (cant shutdown,
>    only hardware reset)

When I run nmap, it runs to completion but generates lots of

bcm43xx: ASSERTION FAILED (!ring->suspended) at: drivers/net/wireless/bcm43xx/bcm43xx_dma.c:7
1:request_slot()

messages in my log.

> SoftMAC: Start scanning with channel: 1
>
 SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Associate: Scanning for networks first.
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
> SoftMAC: Cannot associate without being authenticated, requested
> authentication
> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
> SoftMAC: sent association request!
> SoftMAC: associated!
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio enabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio enabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> SoftMAC: Canceling existing associate request!
> SoftMAC: Associate: Scanning for networks first.
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
> SoftMAC: Cannot associate without being authenticated, requested
> authentication
> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
> SoftMAC: sent association request!
> SoftMAC: associated!
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Already associating or associated to 00:0e:2e:64:77:fd
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio enabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
> ACPI: PCI interrupt for device 0000:10:00.0 disabled
> bcm43xx driver
> ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
> PCI: Setting latency timer of device 0000:10:00.0 to 64
> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, enabled
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio disabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> bcm43xx: Radio hardware status changed to enabled
> SoftMAC: Associate: Scanning for networks first.
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
> SoftMAC: Cannot associate without being authenticated, requested
> authentication
> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
> SoftMAC: sent association request!
> SoftMAC: associated!
> NETDEV WATCHDOG: eth1: transmit timed out
> bcm43xx: Controller RESET (TX timeout) ...
> bcm43xx: select_wireless_core: cleanup
> bcm43xx: Radio turned off
> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
> bcm43xx: DMA-32 0x0220 (TX) max used slots: 411/512
______________________________________________^^^^^^^

This looks as if interrupts are not being delivered. Don't you have the PCI-E patch installed? Check
the output of 'cat /proc/interrupts' to see if the number on the bcc43xx line is not zero, and that
it is increasing as you do scans, etc.

Larry



From dmaley at redhat.com  Mon Jan 15 18:16:19 2007
From: dmaley at redhat.com (Dave Maley)
Date: Mon, 15 Jan 2007 12:16:19 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
Message-ID: <1168881379.2481.46.camel@flanders.rdu.redhat.com>

On Fri, 2007-01-12 at 12:08 -0600, Larry Finger wrote:
> The PCI-E modifications to bcm43xx do not set up the interrupt vector
> correctly. Tested with BCM4311 (PCI-E) on x86_64 and BCM4306 (PCI) on i386.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This fix should be applied to wireless-2.6 _AND_ pushed upstream to
> 2.6.20-rcX. Without this patch, none of the PCI-E interfaces will work.
> This version incorporates Michael Buesch's comments, and forgoes some
> code clean-ups that were in the first version/

Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and the .17
linville FC6 test kernel, seems to get bcm43xx working reliably for me.
I'm currently running FC6 (x86) and the card has a 4311 chip
(mini-PCIE).

The connection is painfully slow and I understand this is a separate
known issue.  But w/ this PCI-E interrupts patch I've had 100% success
associating w/ my AP,  and haven't dropped connection in well over 24
hours.

~Dave



From dmaley at redhat.com  Mon Jan 15 18:38:43 2007
From: dmaley at redhat.com (Dave Maley)
Date: Mon, 15 Jan 2007 12:38:43 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <1168881379.2481.46.camel@flanders.rdu.redhat.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
Message-ID: <1168882723.2481.49.camel@flanders.rdu.redhat.com>

On Mon, 2007-01-15 at 12:16 -0500, Dave Maley wrote:
> Larry/Michale/John - 

Apologies Michael - didn't catch my typo before sending .....



From ftoledo at docksud.com.ar  Mon Jan 15 18:40:24 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Mon, 15 Jan 2007 14:40:24 -0300
Subject: 4311 softmac auth
In-Reply-To: <45AB944C.5070809@lwfinger.net>
References: <45AB8F4D.6070007@docksud.com.ar> <45AB944C.5070809@lwfinger.net>
Message-ID: <45ABBC88.5070105@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Larry Finger escribi?:
> Fernando Toledo wrote:
>> i can scan
>> i see the ap associated:
>>
>> eth1      IEEE 802.11b/g  ESSID:"prosistem"  Nickname:"Broadcom 4311"
>>           Mode:Managed  Frequency=2.437 GHz  Access Point:
>> 00:0E:2E:64:77:FD
>>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>>           RTS thr:off   Fragment thr:off
>>           Encryption key:off
>>           Link Quality=111/100  Signal level=-29 dBm  Noise level=-69 dBm
> 
> With this signal/noise, you should be able to associate and authenticate.
> 
yeap the ap is near to me.

>>           Rx invalid nwid:0  Rx invalid crypt:344  Rx invalid frag:0
>>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>>
>> but don't connect,
>> i see that the bit rate is 1Mb , i can't change it
>> ntbkragnarok:~# iwconfig eth1 rate 11
>> Error for wireless request "Set Bit Rate" (8B20) :
>>     SET failed on device eth1 ; Invalid argument.
> 
> The syntax is 'iwconfig eth1 rate 11M'.

sorry , typo error, but it do not change the rate, iwconfig still show 1M

> 
> Please send the output of 'iwlist s', 'iwconfig', and 'ifconfig'. Do other machines and/or OS's
> connect to this AP? Have you tried a different channel?
> 
- ---------------------------------
ntbkragnarok:~# iwconfig eth1
eth1      IEEE 802.11b/g  ESSID:"prosistem"  Nickname:"ragnarok"
          Mode:Managed  Frequency=2.437 GHz  Access Point:
00:0E:2E:64:77:FD
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=100/100  Signal level=-33 dBm  Noise level=-68 dBm
          Rx invalid nwid:0  Rx invalid crypt:4224  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0
- --------------------------------

ntbkragnarok:~# iwlist eth1 s
eth1      Scan completed :
          Cell 01 - Address: 00:40:F4:E0:FE:17
                    ESSID:"Andesur"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=100/100  Signal level=-68 dBm  Noise
level=-70 dBm
                    Extra: Last beacon: 236ms ago
          Cell 02 - Address: 00:0E:2E:64:77:FD
                    ESSID:"prosistem"
                    Protocol:IEEE 802.11b
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s
                    Quality=100/100  Signal level=-29 dBm  Noise
level=-70 dBm
                    Extra: Last beacon: 252ms ago
          Cell 03 - Address: 00:0D:88:3D:04:93
                    ESSID:"MAIZ"
                    Protocol:IEEE 802.11b
                    Mode:Master
                    Channel:6
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s
                    Quality=100/100  Signal level=-77 dBm  Noise
level=-70 dBm
                    Extra: Last beacon: 1916ms ago




> Larry
> 
> 
i connect to prosistem essid

SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
SoftMAC: Cannot associate without being authenticated, requested
authentication
SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
SoftMAC: sent association request!
SoftMAC: associated!
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 4/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
- ------------------------------------------

ntbkragnarok:~# dhclient eth1
Internet Software Consortium DHCP Client 2.0pl5
Copyright 1995, 1996, 1997, 1998, 1999 The Internet Software Consortium.
All rights reserved.

Please contribute if you find this software useful.
For info, please visit http://www.isc.org/dhcp-contrib.html

Listening on LPF/eth1/00:14:a5:f5:85:ed
Sending on   LPF/eth1/00:14:a5:f5:85:ed
Sending on   Socket/fallback/fallback-net
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 7
receive_packet failed on eth1: Network is down
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 8
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 8
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 14
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 14
DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 10
No DHCPOFFERS received.
No working leases in persistent database.

Sleeping.

ntbkragnarok:~#

the "Network is down" message in dhcp client seem to be bad, is see that
the led in blink upon dhcp client statarted, maybe , here the interface
down and up. teh dhcp client is from debian testing.

i connect to this ap with my realtek pcmcia without problems in this
machine, also i have 3 laptops more connected too.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFq7wcz8H9Vs7bTsMRAh/wAJ94OKRh9rm/8CXLZWALgglpaSOXLgCfUjAW
dfpLNg/AbLFWxBEUbO0WJmw=
=h5yx
-----END PGP SIGNATURE-----


From ftoledo at docksud.com.ar  Mon Jan 15 18:44:26 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Mon, 15 Jan 2007 14:44:26 -0300
Subject: 4311 work and timeouts
In-Reply-To: <45AB9B62.9030908@lwfinger.net>
References: <45AB8F3E.5020108@docksud.com.ar> <45AB9B62.9030908@lwfinger.net>
Message-ID: <45ABBD7A.3050601@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Larry Finger escribi?:
> Fernando Toledo wrote:
>> i testing traffic now
>> i try nmap 192.168.1.0/24 (to scan my network ) and the device is die
>> if i try to unload the bcm43xx module, i have a deadlook (cant shutdown,
>>    only hardware reset)
> 
> When I run nmap, it runs to completion but generates lots of
> 
> bcm43xx: ASSERTION FAILED (!ring->suspended) at: drivers/net/wireless/bcm43xx/bcm43xx_dma.c:7
> 1:request_slot()
> 
> messages in my log.
> 
>> SoftMAC: Start scanning with channel: 1
>>
>  SoftMAC: Scanning 14 channels
>> SoftMAC: Scanning finished
>> SoftMAC: Associate: Scanning for networks first.
>> SoftMAC: Start scanning with channel: 1
>> SoftMAC: Scanning 14 channels
>> SoftMAC: Scanning finished
>> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
>> SoftMAC: Cannot associate without being authenticated, requested
>> authentication
>> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
>> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
>> SoftMAC: sent association request!
>> SoftMAC: associated!
>> bcm43xx: Radio turned off
>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
>> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>> bcm43xx: Radio turned on
>> bcm43xx: Radio enabled by hardware
>> bcm43xx: Chip initialized
>> bcm43xx: 32-bit DMA initialized
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>> bcm43xx: Radio turned off
>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
>> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>> bcm43xx: Radio turned on
>> bcm43xx: Radio enabled by hardware
>> bcm43xx: Chip initialized
>> bcm43xx: 32-bit DMA initialized
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>> SoftMAC: Canceling existing associate request!
>> SoftMAC: Associate: Scanning for networks first.
>> SoftMAC: Start scanning with channel: 1
>> SoftMAC: Scanning 14 channels
>> SoftMAC: Scanning finished
>> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
>> SoftMAC: Cannot associate without being authenticated, requested
>> authentication
>> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
>> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
>> SoftMAC: sent association request!
>> SoftMAC: associated!
>> SoftMAC: Start scanning with channel: 1
>> SoftMAC: Scanning 14 channels
>> SoftMAC: Scanning finished
>> SoftMAC: Already associating or associated to 00:0e:2e:64:77:fd
>> bcm43xx: Radio turned off
>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
>> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>> bcm43xx: Radio turned on
>> bcm43xx: Radio enabled by hardware
>> bcm43xx: Chip initialized
>> bcm43xx: 32-bit DMA initialized
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>> bcm43xx: Radio turned off
>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
>> bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
>> ACPI: PCI interrupt for device 0000:10:00.0 disabled
>> bcm43xx driver
>> ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
>> PCI: Setting latency timer of device 0000:10:00.0 to 64
>> bcm43xx: Chip ID 0x4311, rev 0x1
>> bcm43xx: Number of cores: 4
>> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
>> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, enabled
>> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
>> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
>> bcm43xx: PHY connected
>> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
>> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
>> bcm43xx: Radio turned off
>> bcm43xx: Radio turned off
>> bcm43xx: PHY connected
>> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
>> bcm43xx: Radio turned on
>> bcm43xx: Radio disabled by hardware
>> bcm43xx: Chip initialized
>> bcm43xx: 32-bit DMA initialized
>> bcm43xx: Keys cleared
>> bcm43xx: Selected 802.11 core (phytype 2)
>> bcm43xx: Radio hardware status changed to enabled
>> SoftMAC: Associate: Scanning for networks first.
>> SoftMAC: Start scanning with channel: 1
>> SoftMAC: Scanning 14 channels
>> SoftMAC: Scanning finished
>> SoftMAC: Queueing Authentication Request to 00:0e:2e:64:77:fd
>> SoftMAC: Cannot associate without being authenticated, requested
>> authentication
>> SoftMAC: Sent Authentication Request to 00:0e:2e:64:77:fd.
>> SoftMAC: Open Authentication completed with 00:0e:2e:64:77:fd
>> SoftMAC: sent association request!
>> SoftMAC: associated!
>> NETDEV WATCHDOG: eth1: transmit timed out
>> bcm43xx: Controller RESET (TX timeout) ...
>> bcm43xx: select_wireless_core: cleanup
>> bcm43xx: Radio turned off
>> bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
>> bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
>> bcm43xx: DMA-32 0x0220 (TX) max used slots: 411/512
> ______________________________________________^^^^^^^
> 
> This looks as if interrupts are not being delivered. Don't you have the PCI-E patch installed? Check
> the output of 'cat /proc/interrupts' to see if the number on the bcc43xx line is not zero, and that
> it is increasing as you do scans, etc.
> 
> Larry
> 
> 
yes, i apply two patches to 2.6.19.1 (radio and pcie)

ntbkragnarok:/usr/src# cat /proc/interrupts
           CPU0       CPU1
  0:    2956754          0   IO-APIC-edge      timer
  1:      16893          0   IO-APIC-edge      i8042
  8:          1          0   IO-APIC-edge      rtc
  9:      35463          0   IO-APIC-fasteoi   acpi
 12:     856073          0   IO-APIC-edge      i8042
 14:     129178          0   IO-APIC-edge      libata
 15:          0          0   IO-APIC-edge      libata
 16:     739411          0   IO-APIC-fasteoi   HDA Intel,
i915 at pci:0000:00:02.0
 17:     170683          0   IO-APIC-fasteoi   uhci_hcd:usb2, bcm43xx
 18:          1          0   IO-APIC-fasteoi   uhci_hcd:usb4, ohci1394
 19:      75808          0   IO-APIC-fasteoi   yenta, uhci_hcd:usb3, wlan0
 20:          0          0   IO-APIC-fasteoi   uhci_hcd:usb1, ehci_hcd:usb5
220:      51947          0   PCI-MSI-edge      libata
NMI:          0          0
LOC:    2957136    2957215
ERR:          0
MIS:          0

- --------------------------------

ntbkragnarok:/usr/src# lspci -vv


10:00.0 Network controller: Broadcom Corporation Dell Wireless 1390 WLAN
Mini-PCI Card (rev 01)
        Subsystem: Hewlett-Packard Company Unknown device 1364
        Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop-
ParErr- Stepping- SERR- FastB2B-
        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort-
<TAbort- <MAbort- >SERR- <PERR-
        Latency: 0, Cache Line Size: 64 bytes
        Interrupt: pin A routed to IRQ 17
        Region 0: Memory at f4000000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
                Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=375mA
PME(D0-,D1-,D2-,D3hot-,D3cold-)
                Status: D0 PME-Enable- DSel=0 DScale=2 PME-
        Capabilities: [58] Message Signalled Interrupts: Mask- 64bit-
Queue=0/0 Enable-
                Address: 00000000  Data: 0000
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
                Device: Supported: MaxPayload 128 bytes, PhantFunc 0,
ExtTag+
                Device: Latency L0s <4us, L1 unlimited
                Device: AtnBtn- AtnInd- PwrInd-
                Device: Errors: Correctable- Non-Fatal- Fatal- Unsupported-
                Device: RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop-
                Device: MaxPayload 128 bytes, MaxReadReq 128 bytes
                Link: Supported Speed 2.5Gb/s, Width x1, ASPM L0s, Port 0
                Link: Latency L0s <4us, L1 <64us
                Link: ASPM Disabled RCB 64 bytes CommClk+ ExtSynch-
                Link: Speed 2.5Gb/s, Width x1


-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFq716z8H9Vs7bTsMRAn5TAJ43JEKF7QbZEZlftpIdb+UpBLedVACgz8X6
3pqnm1KScS0NyYSaAcEXkFo=
=tjgk
-----END PGP SIGNATURE-----


From larry.finger at lwfinger.net  Mon Jan 15 18:58:45 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 15 Jan 2007 11:58:45 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <1168881379.2481.46.camel@flanders.rdu.redhat.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
Message-ID: <45ABC0D5.3060008@lwfinger.net>

Dave Maley wrote:
> 
> Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and the .17
> linville FC6 test kernel, seems to get bcm43xx working reliably for me.
> I'm currently running FC6 (x86) and the card has a 4311 chip
> (mini-PCIE).
> 
> The connection is painfully slow and I understand this is a separate
> known issue.  But w/ this PCI-E interrupts patch I've had 100% success
> associating w/ my AP,  and haven't dropped connection in well over 24
> hours.

Thanks for your report. The patch is clearly a good one. Now all that remains is for it to be sent
upstream before 2.6.20 is released.

Larry



From evanfoss at gmail.com  Tue Jan 16 00:05:26 2007
From: evanfoss at gmail.com (evan foss)
Date: Mon, 15 Jan 2007 18:05:26 -0500
Subject: Testing report for new patches
In-Reply-To: <45AAC4AF.4090601@lwfinger.net>
References: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>
	<45A9CE3B.7060104@lwfinger.net>
	<f1a9e67e0701141027i39b51c1duf1f65f6738f9a2d5@mail.gmail.com>
	<45AAC4AF.4090601@lwfinger.net>
Message-ID: <4a55afb80701151505s284b154an8323df86b0a99061@mail.gmail.com>

>I'm running a newer Compaq laptop (v3000 series) which has one of
these wonderful broadcom PCI-E 4311 chips in them.

I have a Compaq V3000 to. I am using a V3019US. Just out of curiosity
what version specifically are you using?

-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From spitty at gmail.com  Tue Jan 16 03:07:50 2007
From: spitty at gmail.com (Ryan Hurley)
Date: Mon, 15 Jan 2007 21:07:50 -0500
Subject: Testing report for new patches
In-Reply-To: <4a55afb80701151505s284b154an8323df86b0a99061@mail.gmail.com>
References: <f1a9e67e0701131253g4c011b26jc004a5c1e34b3c45@mail.gmail.com>
	<45A9CE3B.7060104@lwfinger.net>
	<f1a9e67e0701141027i39b51c1duf1f65f6738f9a2d5@mail.gmail.com>
	<45AAC4AF.4090601@lwfinger.net>
	<4a55afb80701151505s284b154an8323df86b0a99061@mail.gmail.com>
Message-ID: <f1a9e67e0701151807l4015dd3aha9e4841380f5a9d1@mail.gmail.com>

On 1/15/07, evan foss <evanfoss at gmail.com> wrote:
>
> I have a Compaq V3000 to. I am using a V3019US. Just out of curiosity
> what version specifically are you using?
>

I bought it directly from Compaq, so it doesn't have a specific model
string- just v3000 CTO (configured to order, I guess.)  If I had known that
it came with a broadcom chip, I probably would have gone with the
Intel-based system, rather than the AMD-based one.  Oh well- the more people
who can test this driver with a PCI-E chip, the better.

-Ryan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070115/ae9f2930/attachment.html>

From hijinks at gmail.com  Tue Jan 16 16:13:12 2007
From: hijinks at gmail.com (Mike Zupan)
Date: Tue, 16 Jan 2007 10:13:12 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45ABC0D5.3060008@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
Message-ID: <7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>

This patch works great against 2.6.20-rc5. I am able to iwlist eth1 scan!

I will try to associate and such when I get home

Mike

On 1/15/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> Dave Maley wrote:
> >
> > Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and the .17
> > linville FC6 test kernel, seems to get bcm43xx working reliably for me.
> > I'm currently running FC6 (x86) and the card has a 4311 chip
> > (mini-PCIE).
> >
> > The connection is painfully slow and I understand this is a separate
> > known issue.  But w/ this PCI-E interrupts patch I've had 100% success
> > associating w/ my AP,  and haven't dropped connection in well over 24
> > hours.
>
> Thanks for your report. The patch is clearly a good one. Now all that
> remains is for it to be sent
> upstream before 2.6.20 is released.
>
> Larry
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070116/64bd4871/attachment.html>

From asil.jinn at gmail.com  Tue Jan 16 17:14:47 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Tue, 16 Jan 2007 17:14:47 +0100
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
Message-ID: <fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>

I thought this patch was already applied to 2.6.20-rc5, but I guess I was
wrong. I will also apply it and try it out on my system.

Archlinux with kernel 2.6.20-rc5
Dell 1490 wlan card (bcm4312)
Dual core 2ghz

Other questions:
1. Does the 2.6.20-rc5 kernel have the new PCI-E patch applied to it, or is
it the old one?
2. Would trying the mm patches be better or stick with the mainline?

Thanks
Yildirim

2007/1/16, Mike Zupan <hijinks at gmail.com>:
>
> This patch works great against 2.6.20-rc5. I am able to iwlist eth1 scan!
>
> I will try to associate and such when I get home
>
> Mike
>
> On 1/15/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> >
> > Dave Maley wrote:
> > >
> > > Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and the
> > .17
> > > linville FC6 test kernel, seems to get bcm43xx working reliably for
> > me.
> > > I'm currently running FC6 (x86) and the card has a 4311 chip
> > > (mini-PCIE).
> > >
> > > The connection is painfully slow and I understand this is a separate
> > > known issue.  But w/ this PCI-E interrupts patch I've had 100% success
> > > associating w/ my AP,  and haven't dropped connection in well over 24
> > > hours.
> >
> > Thanks for your report. The patch is clearly a good one. Now all that
> > remains is for it to be sent
> > upstream before 2.6.20 is released.
> >
> > Larry
> >
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
>
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070116/e7fc3069/attachment.html>

From hijinks at gmail.com  Tue Jan 16 17:18:05 2007
From: hijinks at gmail.com (Mike Zupan)
Date: Tue, 16 Jan 2007 11:18:05 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
Message-ID: <7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>

v2 of the patch was not applied to rc5. the pci-e patch seems to be at least
the 4311 was listing in the bcm43xx_main.c

Mike

On 1/16/07, Asil Jinn <asil.jinn at gmail.com> wrote:
>
> I thought this patch was already applied to 2.6.20-rc5, but I guess I was
> wrong. I will also apply it and try it out on my system.
>
> Archlinux with kernel 2.6.20-rc5
> Dell 1490 wlan card (bcm4312)
> Dual core 2ghz
>
> Other questions:
> 1. Does the 2.6.20-rc5 kernel have the new PCI-E patch applied to it, or
> is it the old one?
> 2. Would trying the mm patches be better or stick with the mainline?
>
> Thanks
> Yildirim
>
> 2007/1/16, Mike Zupan <hijinks at gmail.com>:
> >
> > This patch works great against 2.6.20-rc5. I am able to iwlist eth1
> > scan!
> >
> > I will try to associate and such when I get home
> >
> > Mike
> >
> > On 1/15/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > >
> > > Dave Maley wrote:
> > > >
> > > > Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and the
> > > .17
> > > > linville FC6 test kernel, seems to get bcm43xx working reliably for
> > > me.
> > > > I'm currently running FC6 (x86) and the card has a 4311 chip
> > > > (mini-PCIE).
> > > >
> > > > The connection is painfully slow and I understand this is a separate
> > > > known issue.  But w/ this PCI-E interrupts patch I've had 100%
> > > success
> > > > associating w/ my AP,  and haven't dropped connection in well over
> > > 24
> > > > hours.
> > >
> > > Thanks for your report. The patch is clearly a good one. Now all that
> > > remains is for it to be sent
> > > upstream before 2.6.20 is released.
> > >
> > > Larry
> > >
> > > _______________________________________________
> > > Bcm43xx-dev mailing list
> > > Bcm43xx-dev at lists.berlios.de
> > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > >
> >
> >
> > _______________________________________________
> > Bcm43xx-dev mailing list
> > Bcm43xx-dev at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> >
> >
> >
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070116/48d1c8ad/attachment.html>

From mb at bu3sch.de  Tue Jan 16 18:06:02 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 16 Jan 2007 18:06:02 +0100
Subject: Can someone please try...
Message-ID: <200701161806.02780.mb@bu3sch.de>

...the bcm43xx driver in my tree with a 4318 chip?
The code there works excellent with my 4306 now, but I can't
get it to work with my 4318. It's strange, it doesn't seem
to work at all. I don't seem to be able to TX and RX any packet.
Not sure why.

To get it, please try to avoid cloning the whole tree
from my repository to avoid unnecessary bandwidth wasting.
If you have a linville-wireless-dev tree, you can do the
following:

cd wireless-dev
git branch mb
git checkout mb
git pull http://bu3sch.de/git/wireless-dev.git master

I think this should also work if you have a linus-2.6 tree
checked out somewhere.

-- 
Greetings Michael.


From schwab at suse.de  Tue Jan 16 20:00:55 2007
From: schwab at suse.de (Andreas Schwab)
Date: Tue, 16 Jan 2007 20:00:55 +0100
Subject: Can someone please try...
In-Reply-To: <200701161806.02780.mb@bu3sch.de> (Michael Buesch's message of
	"Tue, 16 Jan 2007 18:06:02 +0100")
References: <200701161806.02780.mb@bu3sch.de>
Message-ID: <jesleabxug.fsf@sykes.suse.de>

Michael Buesch <mb at bu3sch.de> writes:

> ...the bcm43xx driver in my tree with a 4318 chip?
> The code there works excellent with my 4306 now, but I can't
> get it to work with my 4318.

Doesn't work for me either.  I cannot get it to associate to the AP.

Andreas.

-- 
Andreas Schwab, SuSE Labs, schwab at suse.de
SuSE Linux Products GmbH, Maxfeldstra?e 5, 90409 N?rnberg, Germany
PGP key fingerprint = 58CA 54C7 6D53 942B 1756  01D3 44D5 214B 8276 4ED5
"And now for something completely different."


From mb at bu3sch.de  Tue Jan 16 20:23:23 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 16 Jan 2007 20:23:23 +0100
Subject: Can someone please try...
In-Reply-To: <1168972142.8299.11.camel@dv>
References: <200701161806.02780.mb@bu3sch.de> <1168972142.8299.11.camel@dv>
Message-ID: <200701162023.23919.mb@bu3sch.de>

On Tuesday 16 January 2007 19:29, Pavel Roskin wrote:
> On Tue, 2007-01-16 at 18:06 +0100, Michael Buesch wrote:
> > ...the bcm43xx driver in my tree with a 4318 chip?
> 
> Things are progressing for me a bit because I observed an association to
> an AP with no security.  I still had to use wpa_supplicant.
> 
> Unfortunately, there is a bigger issue with the new code.  When I
> interrupt wpa_supplicant, the kernel reports several oopses and then
> panics, so I have to reboot.  I had to use serial console just to
> capture the messages.
> 
> I assume the first message is most relevant.  Here it is:

A patch for that is already upstream.
It's surprising that it doesn't happen for me, though.
Neiter on PPC, nor on i386.

Patch was
[PATCH] bcm43xx-d80211: Fix DMA TX skb doublefree

-- 
Greetings Michael.


From mb at bu3sch.de  Tue Jan 16 20:24:08 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 16 Jan 2007 20:24:08 +0100
Subject: Can someone please try...
In-Reply-To: <jesleabxug.fsf@sykes.suse.de>
References: <200701161806.02780.mb@bu3sch.de> <jesleabxug.fsf@sykes.suse.de>
Message-ID: <200701162024.08729.mb@bu3sch.de>

On Tuesday 16 January 2007 20:00, Andreas Schwab wrote:
> Michael Buesch <mb at bu3sch.de> writes:
> 
> > ...the bcm43xx driver in my tree with a 4318 chip?
> > The code there works excellent with my 4306 now, but I can't
> > get it to work with my 4318.
> 
> Doesn't work for me either.  I cannot get it to associate to the AP.

Ok, let's see.
I found a few other bugs. But I can't make any promises when
I'll find all of them. ;)

-- 
Greetings Michael.


From asil.jinn at gmail.com  Tue Jan 16 20:59:54 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Tue, 16 Jan 2007 20:59:54 +0100
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
	<7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
Message-ID: <fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>

This site it down for now.. atleast I cant connect to it
ftp://lwfinger.dynalias.org/patches

So i thought of copying and pasting the pci-e v2 patch below and try to
patch it but I get 3 failed hunks (against 2.6.20-rc5).. I ran patch -p1 <
pcie.patch.

Yildirim

2007/1/16, Mike Zupan <hijinks at gmail.com>:
>
> v2 of the patch was not applied to rc5. the pci-e patch seems to be at
> least the 4311 was listing in the bcm43xx_main.c
>
> Mike
>
> On 1/16/07, Asil Jinn <asil.jinn at gmail.com> wrote:
> >
> > I thought this patch was already applied to 2.6.20-rc5, but I guess I
> > was wrong. I will also apply it and try it out on my system.
> >
> > Archlinux with kernel 2.6.20-rc5
> > Dell 1490 wlan card (bcm4312)
> > Dual core 2ghz
> >
> > Other questions:
> > 1. Does the 2.6.20-rc5 kernel have the new PCI-E patch applied to it, or
> > is it the old one?
> > 2. Would trying the mm patches be better or stick with the mainline?
> >
> > Thanks
> > Yildirim
> >
> > 2007/1/16, Mike Zupan <hijinks at gmail.com>:
> > >
> > >  This patch works great against 2.6.20-rc5. I am able to iwlist eth1
> > > scan!
> > >
> > > I will try to associate and such when I get home
> > >
> > > Mike
> > >
> > > On 1/15/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> > > >
> > > > Dave Maley wrote:
> > > > >
> > > > > Larry/Michale/John - This patch, applied to both 2.6.20-rc4 and
> > > > the .17
> > > > > linville FC6 test kernel, seems to get bcm43xx working reliably
> > > > for me.
> > > > > I'm currently running FC6 (x86) and the card has a 4311 chip
> > > > > (mini-PCIE).
> > > > >
> > > > > The connection is painfully slow and I understand this is a
> > > > separate
> > > > > known issue.  But w/ this PCI-E interrupts patch I've had 100%
> > > > success
> > > > > associating w/ my AP,  and haven't dropped connection in well over
> > > > 24
> > > > > hours.
> > > >
> > > > Thanks for your report. The patch is clearly a good one. Now all
> > > > that remains is for it to be sent
> > > > upstream before 2.6.20 is released.
> > > >
> > > > Larry
> > > >
> > > > _______________________________________________
> > > > Bcm43xx-dev mailing list
> > > > Bcm43xx-dev at lists.berlios.de
> > > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > > >
> > >
> > >
> > > _______________________________________________
> > > Bcm43xx-dev mailing list
> > > Bcm43xx-dev at lists.berlios.de
> > > https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
> > >
> > >
> > >
> >
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070116/6d4cd012/attachment.html>

From hijinks at gmail.com  Tue Jan 16 21:16:56 2007
From: hijinks at gmail.com (Mike Zupan)
Date: Tue, 16 Jan 2007 15:16:56 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
	<7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
	<fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
Message-ID: <7227c6c70701161216ib5a3836y4a69513ebaf17757@mail.gmail.com>

There is probably a reason its failing.. When you copy and paste it into a
file you are using whitespaces and not tabs..

So if the patch is in the root of my kernel source this worked against
2.6.20-rc5 at least so I'm guessing it should against 2.6.19.1

patch -p1 -l < file.patch

From dmaley at redhat.com  Tue Jan 16 21:22:40 2007
From: dmaley at redhat.com (Dave Maley)
Date: Tue, 16 Jan 2007 15:22:40 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>
	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
	<7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
	<fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
Message-ID: <1168978960.2532.17.camel@flanders.rdu.redhat.com>

On Tue, 2007-01-16 at 20:59 +0100, Asil Jinn wrote:
> This site it down for now.. atleast I cant connect to it
> ftp://lwfinger.dynalias.org/patches
> 
> So i thought of copying and pasting the pci-e v2 patch below and try
> to patch it but I get 3 failed hunks (against 2.6.20-rc5).. I ran
> patch -p1 < pcie.patch.

The whitespace got munged when processed by the mailing list.  I just
applied the changes by hand and then used gendiff to create a patch,
which I've posted to my site in lieu of Larry's being down .....

http://homer.homelinux.net/RPMS/bcm43xx-test-kernels

~Dave



From mb at bu3sch.de  Tue Jan 16 23:07:02 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 16 Jan 2007 23:07:02 +0100
Subject: Can someone please try...
In-Reply-To: <1168984238.16115.9.camel@dv>
References: <200701161806.02780.mb@bu3sch.de>
	<200701162023.23919.mb@bu3sch.de> <1168984238.16115.9.camel@dv>
Message-ID: <200701162307.02891.mb@bu3sch.de>

On Tuesday 16 January 2007 22:50, Pavel Roskin wrote:
> On Tue, 2007-01-16 at 20:23 +0100, Michael Buesch wrote:
> 
> > A patch for that is already upstream.
> 
> I don't see it.  It's not in your tree yet.

It is on its way upstream to linville.

> > It's surprising that it doesn't happen for me, though.
> > Neiter on PPC, nor on i386.
> 
> It did happen for me on i386, as well as on x86_64.  The dump was for
> x86_64, as evidenced by the register size.  Maybe you have less
> debugging options enabled?

All.

> > Patch was
> > [PATCH] bcm43xx-d80211: Fix DMA TX skb doublefree
> 
> Even with this hint, I cannot spot the bug immediately, so it would be
> great if you sync the public repository soon.

Linville has to put the patch into his tree first, so I can pull it.
You can find the patch easily by searching bcm43xx-dev or netdev
archives.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Wed Jan 17 04:11:55 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 16 Jan 2007 21:11:55 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>	<1168881379.2481.46.camel@flanders.rdu.redhat.com>	<45ABC0D5.3060008@lwfinger.net>	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>
	<7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
Message-ID: <45AD93FB.8020704@lwfinger.net>

Mike Zupan wrote:
> v2 of the patch was not applied to rc5. the pci-e patch seems to be at
> least the 4311 was listing in the bcm43xx_main.c
> 
> Mike
> 
> On 1/16/07, *Asil Jinn* <asil.jinn at gmail.com
> <mailto:asil.jinn at gmail.com>> wrote:
> 
>     I thought this patch was already applied to 2.6.20-rc5, but I guess
>     I was wrong. I will also apply it and try it out on my system.


The main routines to add PCI-E code to mainstream was added just before 2.6.20-rc1; however the bug
fixed by "V2" has not yet made it to 2.6.20-rcX. I hope it is there before -rc6, but we will see.
Sometimes these things take longer than expected, depending on the workload of the persons involved.

Larry


From larry.finger at lwfinger.net  Wed Jan 17 04:17:33 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 16 Jan 2007 21:17:33 -0600
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>	<1168881379.2481.46.camel@flanders.rdu.redhat.com>	<45ABC0D5.3060008@lwfinger.net>	<7227c6c70701160713q7f9466fer43d5d872c83c53a1@mail.gmail.com>	<fb1e10a90701160814s3f4b960aqffaf2343b4b87717@mail.gmail.com>	<7227c6c70701160818s6204c6e1v301dfdc2ecea5b8c@mail.gmail.com>
	<fb1e10a90701161159t44a8aed0we03a98ffa4b14529@mail.gmail.com>
Message-ID: <45AD954D.3010404@lwfinger.net>

Asil Jinn wrote:
> This site it down for now.. atleast I cant connect to it
> ftp://lwfinger.dynalias.org/patches
> 
> So i thought of copying and pasting the pci-e v2 patch below and try to
> patch it but I get 3 failed hunks (against 2.6.20-rc5).. I ran patch -p1
> < pcie.patch.

I had a power failure for ~7 hours at my site today. The server is now back up.

As noted later today, copying and pasting will mess up the white space by substituting spaces for
tabs. There are two workarounds: (1) Use the -l switch on patch to ignore whitespace, or (2) Use the
SaveAs feature of your mailer to create a patch file of the mail message. On Thunderbird (at least),
this preserves the tabs.

Larry



From mb at bu3sch.de  Wed Jan 17 10:52:12 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 17 Jan 2007 10:52:12 +0100
Subject: Can someone please try...
In-Reply-To: <1168991519.17787.17.camel@dv>
References: <200701161806.02780.mb@bu3sch.de> <200701162307.02891.mb@bu3sch.de>
	<1168991519.17787.17.camel@dv>
Message-ID: <200701171052.12855.mb@bu3sch.de>

On Wednesday 17 January 2007 00:51, Pavel Roskin wrote:
> On Tue, 2007-01-16 at 23:07 +0100, Michael Buesch wrote:
> > On Tuesday 16 January 2007 22:50, Pavel Roskin wrote:
> > > On Tue, 2007-01-16 at 20:23 +0100, Michael Buesch wrote:
> > > 
> > > > A patch for that is already upstream.
> > > 
> > > I don't see it.  It's not in your tree yet.
> > 
> > It is on its way upstream to linville.
> 
> Well, it's pretty cruel to ask others to test code with known fatal
> bugs, IMHO.

I forgot that the bug was there, because it doesn't trigger on my
machines. I already explained that...

> Even it git were extremely poor at handling a patch applied 
> in two branches.  In fact, git is not so bad at all at handling such
> situations.

I have to wait until linville pulls it. Fullstop.

> > > > It's surprising that it doesn't happen for me, though.
> > > > Neiter on PPC, nor on i386.
> > > 
> > > It did happen for me on i386, as well as on x86_64.  The dump was for
> > > x86_64, as evidenced by the register size.  Maybe you have less
> > > debugging options enabled?
> > 
> > All.
> 
> That's commendable.  I tried the 32-bit kernel without SMP and with
> almost all debugging.  One thing I noticed is that scanning ignores the
> pure 802.11b AP running HostAP that I was going to use for testing.
> Other APs are detected.  The association didn't work, probably for that
> reason.

Probably some d80211 bug. Dunno.

> Scanning may trigger many assertion failures:
> 
> bcm43xx_d80211: ASSERTION FAILED ((lna & ~0x7) == 0)
> at: /home/proski/src/linux-2.6/drivers/net/
> wireless/d80211/bcm43xx/bcm43xx_lo.c:235:lo_measure_feedthrough()

It's not triggered by scanning, it's known and it's nonfatal.

> Finally, interrupting wpa_supplicant hits another bug:
> 
> BUG: unable to handle kernel paging request at virtual address c3e2cbf8
>  printing eip:
> e03835e1
> *pde = 0000f067
> *pte = 03e2c000
> Oops: 0002 [#1]
> DEBUG_PAGEALLOC
> Modules linked in: bcm43xx_d80211 ssb
> CPU:    0
> EIP:    0060:[<e03835e1>]    Not tainted VLI
> EFLAGS: 00210282   (2.6.20-rc3 #3)
> EIP is at bcm43xx_wireless_core_init+0x5a/0x98e [bcm43xx_d80211]
> eax: 00000000   ebx: c3dab740   ecx: 000000e1   edx: c3493808
> esi: c34937f8   edi: c3e2cbf8   ebp: c3e60e38   esp: c3e60db8
> ds: 007b   es: 007b   ss: 0068
> Process wpa_supplicant (pid: 2942, ti=c3e60000 task=c3f92590 task.ti=c3e60000)
> Stack: c0339db6 c0339db6 00000000 c3f92590 c0339db6 00200246 c3e60df0 c3f30000 
>        c3dab740 c0339de4 c3493808 c3e60e0c c3e60e0c 00200246 c3e60e2c c0339dc0 
>        00000000 00000002 c0339de4 c3e60e50 c3f92590 22222222 22222222 22222222 
> Call Trace:
>  [<c010335d>] show_trace_log_lvl+0x1a/0x2f
>  [<c010340d>] show_stack_log_lvl+0x9b/0xa3
>  [<c01035a6>] show_registers+0x191/0x267
>  [<c010378f>] die+0x113/0x212
>  [<c011010a>] do_page_fault+0x43a/0x50c
>  [<c033b47c>] error_code+0x74/0x7c
>  [<e03850bc>] bcm43xx_add_interface+0x4f/0xb7 [bcm43xx_d80211]
>  [<c032022f>] ieee80211_open+0x19d/0x27e
>  [<c02dbb77>] dev_open+0x2d/0x64
>  [<c02da71f>] dev_change_flags+0x51/0xf1
>  [<c030b67a>] devinet_ioctl+0x235/0x53a
>  [<c030bc38>] inet_ioctl+0x73/0x91
>  [<c02d1db8>] sock_ioctl+0x1ac/0x1c9
>  [<c015dd64>] do_ioctl+0x1c/0x51
>  [<c015df94>] vfs_ioctl+0x1fb/0x212
>  [<c015dfdc>] sys_ioctl+0x31/0x49
>  [<c0102cba>] sysenter_past_esp+0x5f/0x99
>  =======================
> Code: 00 80 66 0d ef 8d be 9c 01 00 00 f3 ab 8b 7a 5c 80 62 49 c5 c7 42 4c ff ff ff ff 85 ff c7 
> 42 50 00 00 00 00 74 13 b9 e1 00 00 00 <f3> ab 8b 42 5c 66 c7 80 76 03 00 00 ff ff 8b 4d a8 89 f
> 0 c7 41 
> EIP: [<e03835e1>] bcm43xx_wireless_core_init+0x5a/0x98e [bcm43xx_d80211] SS:ESP 0068:c3e60db8

Doesn't happen for me. I have no idea what's happening.
Care to debug it?
But it's weird that _killing_ the supplicant calls add_interface.
I'd expect it to call remove_interface.

> Then I used MadWifi on the AP side, and "iwpriv scan" picked it.
> Moreover, wpa_supplicant reported connection!  I interrupted
> wpa_supplicant and started it again, and then the kernel oopsed again.
> Strangely, the driver is not even mentioned in the backtrace.
> 
> BUG: unable to handle kernel NULL pointer dereference at virtual address 00000004
>  printing eip:
> c02d8863
> *pde = 00000000
> Oops: 0002 [#1]
> DEBUG_PAGEALLOC
> Modules linked in: bcm43xx_d80211 ssb
> CPU:    0
> EIP:    0060:[<c02d8863>]    Not tainted VLI
> EFLAGS: 00210246   (2.6.20-rc3 #3)
> EIP is at datagram_poll+0xba/0xc5
> eax: 00000000   ebx: cc252bf8   ecx: 00000049   edx: 00000000
> esi: 00000002   edi: 00000004   ebp: cb940b70   esp: cb940b68
> ds: 007b   es: 007b   ss: 0068
> Process wpa_supplicant (pid: 4344, ti=cb940000 task=c2be0590 task.ti=cb940000)
> Stack: c0353220 c9fedf2c cb940b7c c02d1643 00000000 cb940e30 c015ebae c033b3bd
>        cb940e54 cb940e50 cb940f9c cb940f50 cb940be0 00000000 00000000 cb940e5c
>        cb940e60 cb940e64 cb940e50 cb940e54 cb940e58 00000070 00000000 00000000
> Call Trace:
>  [<c010335d>] show_trace_log_lvl+0x1a/0x2f
>  [<c010340d>] show_stack_log_lvl+0x9b/0xa3
>  [<c01035a6>] show_registers+0x191/0x267
>  [<c010378f>] die+0x113/0x212
>  [<c011010a>] do_page_fault+0x43a/0x50c
>  [<c033b47c>] error_code+0x74/0x7c
>  [<c02d1643>] sock_poll+0x12/0x15
>  [<c015ebae>] do_select+0x2b4/0x4cc
>  [<c015f076>] core_sys_select+0x2b0/0x2d5
>  [<c015f631>] sys_select+0x99/0x170
>  [<c0102cba>] sysenter_past_esp+0x5f/0x99
>  =======================
> Code: ca 3c 02 74 2b 8b 83 7c 01 00 00 ba 02 00 00 00 89 d6 99 f7 fe 39 83 cc 00 00 00 7d 08 81
> c9 04 03 00 00 eb 0b 8b 83 44 02 00 00 <0f> ba 68 04 00 5b 89 c8 5e 5d c3 55 89 e5 57 56 89 c6 5
> 3 83 ec
> EIP: [<c02d8863>] datagram_poll+0xba/0xc5 SS:ESP 0068:cb940b68

I have absolutely no idea. Did not happen a single time for me.
In fact. It's all pretty stable on my machines.

-- 
Greetings Michael.


From evanfoss at gmail.com  Thu Jan 18 13:52:39 2007
From: evanfoss at gmail.com (evan foss)
Date: Thu, 18 Jan 2007 07:52:39 -0500
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <45AC41C4.2070401@lwfinger.net>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<4a55afb80701151502q7bf8bbabp7507a42f072efd29@mail.gmail.com>
	<45AC41C4.2070401@lwfinger.net>
Message-ID: <4a55afb80701180452y62b41586xfc56467030e0c0c6@mail.gmail.com>

> One thing I forgot is that the LED will be on only if the switch is in the on position _AND_ the
> interface is UP.

Yes I figured that out. (eventually)

> >>> dhcpcd eth1           <-low transmit power???
> >> Most likely. How far are you from the AP?
> >
> > This is a timeout issue. I tried to apply the timeout patch which I
> > assume is for this and it didn't take. I have logs for both patch
> > applications below. To the distance issue my ap died so I am trying to
> > just connect to one next door. (with permission) The distance is about
> > 50ft. So this could be the main factor. This is why I said it might be
> > my fault. The thing is I can connect to it in windows most of the time
> > so I know it is in range. I will be going to school on Tuesday and
> > will report back then. They have a much better AP.
>
> With the current transmit levels of the 4311, 50 feet through at least one wall is probably too much.

I have tried 3 more AP at much closer distances <9ft and <4ft and it
still won't work. I ether get "Network Down" or a timeout.


> > Presario1600 bcm43xx # patch -p0 <patch_2.6.18.1_signal_quality
...
> > Presario1600 bcm43xx # patch -p0 <patch_2.6.18.1_watchdog_timeout2
...
> Those patches are already applied to your code.

Thanks for the clarification, and assistance.

-- 
http://www.coe.neu.edu/~efoss/
http://evanfoss.googlepages.com/


From asil.jinn at gmail.com  Thu Jan 18 14:24:46 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Thu, 18 Jan 2007 14:24:46 +0100
Subject: [PATCH V2] bcm43xx: Fix failure to deliver PCI-E interrupts
In-Reply-To: <4a55afb80701180452y62b41586xfc56467030e0c0c6@mail.gmail.com>
References: <45a7ceb2.m02aaCgouBsadVk/%Larry.Finger@lwfinger.net>
	<1168881379.2481.46.camel@flanders.rdu.redhat.com>
	<45ABC0D5.3060008@lwfinger.net>
	<4a55afb80701151502q7bf8bbabp7507a42f072efd29@mail.gmail.com>
	<45AC41C4.2070401@lwfinger.net>
	<4a55afb80701180452y62b41586xfc56467030e0c0c6@mail.gmail.com>
Message-ID: <fb1e10a90701180524u2f2c088dsb3dfb309a156685b@mail.gmail.com>

Just tried out the the new pci-e patch. And it works like a charm for me!
Thanks guys. here are some scan results, and data:
I am sitting one room away from the AP. about 8 meters (counted as steps).
Works with 11M aswell but 1M goes faster, as you already know.

Also I get more scanning results (about 6 APs) when not connected to the AP,
but when connected to the AP I get 2 APs.
If you guys need more info let me know.

regards
Yildirim Zaynal

jinn at Estergon:1 > uname
-a
/home/jinn/
Linux Estergon 2.6.20-rc5-ARCH #2 SMP PREEMPT Tue Jan 16 13:20:35 CET 2007
i686 Genuine Intel(R) CPU           T2500  @ 2.00GHz GenuineIntel GNU/Linux
jinn at Estergon:0 >

iwconfig after getting ip from ap:
eth1      IEEE 802.11b/g  ESSID:"Atilla"  Nickname:"Atilla"
          Mode:Managed  Frequency=2.412 GHz  Access Point: 00:14:7F:72:11:25
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Link Quality=60/100  Signal level=-74 dBm  Noise level=-65 dBm
          Rx invalid nwid:0  Rx invalid crypt:12  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

----------------------
lspci
----------------------
jinn at Estergon:0 >
lspci
/home/jinn/
00:00.0 Host bridge: Intel Corporation Mobile 945GM/PM/GMS/940GML and 945GT
Express Memory Controller Hub (rev 03)
00:01.0 PCI bridge: Intel Corporation Mobile 945GM/PM/GMS/940GML and 945GT
Express PCI Express Root Port (rev 03)
00:1b.0 Audio device: Intel Corporation 82801G (ICH7 Family) High Definition
Audio Controller (rev 01)
00:1c.0 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
1 (rev 01)
00:1c.1 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
2 (rev 01)
00:1c.2 PCI bridge: Intel Corporation 82801G (ICH7 Family) PCI Express Port
3 (rev 01)
00:1d.0 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #1
(rev 01)
00:1d.1 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #2
(rev 01)
00:1d.2 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #3
(rev 01)
00:1d.3 USB Controller: Intel Corporation 82801G (ICH7 Family) USB UHCI #4
(rev 01)
00:1d.7 USB Controller: Intel Corporation 82801G (ICH7 Family) USB2 EHCI
Controller (rev 01)
00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev e1)
00:1f.0 ISA bridge: Intel Corporation 82801GBM (ICH7-M) LPC Interface Bridge
(rev 01)
00:1f.2 IDE interface: Intel Corporation 82801GBM/GHM (ICH7 Family) Serial
ATA Storage Controller IDE (rev 01)
00:1f.3 SMBus: Intel Corporation 82801G (ICH7 Family) SMBus Controller (rev
01)
01:00.0 VGA compatible controller: nVidia Corporation Quadro NVS 110M /
GeForce Go 7300 (rev a1)
09:00.0 Ethernet controller: Broadcom Corporation NetXtreme BCM5752 Gigabit
Ethernet PCI Express (rev 02)
0c:00.0 Network controller: Broadcom Corporation BCM4310 UART (rev 01)
------------------------
lspci -n
------------------------
jinn at Estergon:1 > lspci
-n
/home/jinn/
00:00.0 0600: 8086:27a0 (rev 03)
00:01.0 0604: 8086:27a1 (rev 03)
00:1b.0 0403: 8086:27d8 (rev 01)
00:1c.0 0604: 8086:27d0 (rev 01)
00:1c.1 0604: 8086:27d2 (rev 01)
00:1c.2 0604: 8086:27d4 (rev 01)
00:1d.0 0c03: 8086:27c8 (rev 01)
00:1d.1 0c03: 8086:27c9 (rev 01)
00:1d.2 0c03: 8086:27ca (rev 01)
00:1d.3 0c03: 8086:27cb (rev 01)
00:1d.7 0c03: 8086:27cc (rev 01)
00:1e.0 0604: 8086:2448 (rev e1)
00:1f.0 0601: 8086:27b9 (rev 01)
00:1f.2 0101: 8086:27c4 (rev 01)
00:1f.3 0c05: 8086:27da (rev 01)
01:00.0 0300: 10de:01d7 (rev a1)
09:00.0 0200: 14e4:1600 (rev 02)
0c:00.0 0280: 14e4:4312 (rev 01)
jinn at Estergon:0 >

----------------------
SCANNING
----------------------
jinn at Estergon:0 > iwlist eth1
scan
/home/jinn/
eth1      Scan completed :
          Cell 01 - Address: 00:14:7F:72:11:25
                    ESSID:"Atilla"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:1
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=89/100  Signal level=-66 dBm  Noise level=-72
dBm
                    Extra: Last beacon: 92ms ago
          Cell 02 - Address: 00:40:96:27:DD:FB
                    ESSID:"<hidden>"
                    Protocol:IEEE 802.11b
                    Mode:Master
                    Channel:1
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s
                    Quality=75/100  Signal level=-85 dBm  Noise level=-72
dBm
                    Extra: Last beacon: 8412ms ago

-------------------------------------------------------------------------
DMESG, LAST PAGE
-------------------------------------------------------------------------
EXT3 FS on sda6, internal journal
EXT3-fs: mounted filesystem with ordered data mode.
Adding 1076308k swap on /dev/sda5.  Priority:-1 extents:1 across:1076308k
usb 1-2.3.2: new full speed USB device using uhci_hcd and address 9
usb 1-2.3.2: configuration #1 chosen from 1 choice
PM: Writing back config space on device 0000:09:00.0 at offset c (was
90020000, writing 0)
**WARNING** I2C adapter driver [NVIDIA i2c adapter 0 at 1:00.0] forgot to
specify physical device; fix it!
**WARNING** I2C adapter driver [NVIDIA i2c adapter 1 at 1:00.0] forgot to
specify physical device; fix it!
**WARNING** I2C adapter driver [NVIDIA i2c adapter 2 at 1:00.0] forgot to
specify physical device; fix it!
ndiswrapper: device wlan0 removed
ACPI: PCI interrupt for device 0000:0c:00.0 disabled
usbcore: deregistering interface driver ndiswrapper
ieee80211_crypt: registered algorithm 'NULL'
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation <
jketreno at linux.intel.com>
bcm43xx driver
ACPI: PCI Interrupt 0000:0c:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:0c:00.0 to 64
ndiswrapper version 1.34 loaded (preempt=yes,smp=yes)
usbcore: registered new interface driver ndiswrapper
ieee80211_crypt: registered algorithm 'WEP'
printk: 1 messages suppressed.
SoftMAC: Shared Key Authentication completed with 00:14:7f:72:11:25
NET: Registered protocol family 10
lo: Disabled Privacy Extensions
Mobile IPv6
eth1: no IPv6 routers present
jinn at Estergon:0
>

----------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070118/0c375c60/attachment.html>

From Larry.Finger at lwfinger.net  Thu Jan 18 20:09:49 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 13:09:49 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
Message-ID: <45AFC5FD.3090403@lwfinger.net>

For those of you with cards having 30-bit DMA and >1 GB RAM, I think I have good news.

I added memory to bring my x86_64 machine up to 1.5 GB, and tricked the code into thinking I had a
30-bit interface rather than the 32-bit model it really is. The necessary code changes were derived
from drivers/net/b44.c as this hardware has the same problem as bcm43xx. So far this has only been
tested using my hardware, and I look forward to your reports.

The patch is for 2.6.20-rc5. If it does not apply on your kernel version, please let me know.

Larry
---

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
@@ -145,16 +145,14 @@ dma_addr_t map_descbuffer(struct bcm43xx
 			  int tx)
 {
 	dma_addr_t dmaaddr;
+	int direction = PCI_DMA_FROMDEVICE;

-	if (tx) {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
-					 buf, len,
-					 DMA_TO_DEVICE);
-	} else {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
+	if (tx)
+		direction = PCI_DMA_TODEVICE;
+
+	dmaaddr = pci_map_single(ring->bcm->pci_dev,
 					 buf, len,
-					 DMA_FROM_DEVICE);
-	}
+					 direction);

 	return dmaaddr;
 }
@@ -166,13 +164,13 @@ void unmap_descbuffer(struct bcm43xx_dma
 		      int tx)
 {
 	if (tx) {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_TO_DEVICE);
+				 PCI_DMA_TODEVICE);
 	} else {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_FROM_DEVICE);
+				 PCI_DMA_FROMDEVICE);
 	}
 }

@@ -183,8 +181,8 @@ void sync_descbuffer_for_cpu(struct bcm4
 {
 	assert(!ring->tx);

-	dma_sync_single_for_cpu(&ring->bcm->pci_dev->dev,
-				addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_FROMDEVICE);
 }

 static inline
@@ -194,8 +192,8 @@ void sync_descbuffer_for_device(struct b
 {
 	assert(!ring->tx);

-	dma_sync_single_for_device(&ring->bcm->pci_dev->dev,
-				   addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_TODEVICE);
 }

 /* Unmap and free a descriptor buffer. */
@@ -214,17 +212,53 @@ void free_descriptor_buffer(struct bcm43

 static int alloc_ringmemory(struct bcm43xx_dmaring *ring)
 {
-	struct device *dev = &(ring->bcm->pci_dev->dev);
-
-	ring->descbase = dma_alloc_coherent(dev, BCM43xx_DMA_RINGMEMSIZE,
-					    &(ring->dmabase), GFP_KERNEL);
+	ring->descbase = pci_alloc_consistent(ring->bcm->pci_dev, BCM43xx_DMA_RINGMEMSIZE,
+					    &(ring->dmabase));
 	if (!ring->descbase) {
-		printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
-		return -ENOMEM;
+		/* Allocation may have failed due to pci_alloc_consistent
+		   insisting on use of GFP_DMA, which is more restrictive
+		   than necessary...  */
+		struct dma_desc *rx_ring;
+		dma_addr_t rx_ring_dma;
+
+		rx_ring = kzalloc(BCM43xx_DMA_RINGMEMSIZE, GFP_KERNEL);
+		if (!rx_ring)
+			goto out_err;
+
+		rx_ring_dma = pci_map_single(ring->bcm->pci_dev, rx_ring,
+					     BCM43xx_DMA_RINGMEMSIZE,
+					     PCI_DMA_BIDIRECTIONAL);
+
+		if (pci_dma_mapping_error(rx_ring_dma) ||
+		    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+			/* Sigh... */
+			if (!pci_dma_mapping_error(rx_ring_dma))
+				pci_unmap_single(ring->bcm->pci_dev,
+						 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			rx_ring_dma = pci_map_single(ring->bcm->pci_dev,
+						 rx_ring, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			if (pci_dma_mapping_error(rx_ring_dma) ||
+			    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+				assert(0);
+				if (!pci_dma_mapping_error(rx_ring_dma))
+					pci_unmap_single(ring->bcm->pci_dev,
+							 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+							 PCI_DMA_BIDIRECTIONAL);
+                        	goto out_err;
+			}
+                }
+
+                ring->descbase = rx_ring;
+                ring->dmabase = rx_ring_dma;
 	}
 	memset(ring->descbase, 0, BCM43xx_DMA_RINGMEMSIZE);

 	return 0;
+out_err:
+	printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
+	return -ENOMEM;
 }

 static void free_ringmemory(struct bcm43xx_dmaring *ring)
@@ -407,6 +441,29 @@ static int setup_rx_descbuffer(struct bc
 	if (unlikely(!skb))
 		return -ENOMEM;
 	dmaaddr = map_descbuffer(ring, skb->data, ring->rx_buffersize, 0);
+	/* Hardware bug work-around, the chip may be unable to do PCI DMA
+	   to/from anything above 1GB  :-(  */
+	if (pci_dma_mapping_error(dmaaddr) ||
+	    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+		/* Sigh... */
+		if (!pci_dma_mapping_error(dmaaddr))
+			pci_unmap_single(ring->bcm->pci_dev,
+					 dmaaddr, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		dev_kfree_skb_any(skb);
+		skb = __dev_alloc_skb(ring->rx_buffersize,GFP_DMA);
+		if (skb == NULL)
+			return -ENOMEM;
+		dmaaddr = pci_map_single(ring->bcm->pci_dev,
+					 skb->data, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		if (pci_dma_mapping_error(dmaaddr) ||
+		    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+			assert(0);
+			dev_kfree_skb_any(skb);
+			return -ENOMEM;
+		}
+	}
 	meta->skb = skb;
 	meta->dmaaddr = dmaaddr;
 	skb->dev = ring->bcm->net_dev;
@@ -636,8 +693,10 @@ struct bcm43xx_dmaring * bcm43xx_setup_d
 	err = dmacontroller_setup(ring);
 	if (err)
 		goto err_free_ringmemory;
+	return ring;

 out:
+	printk(KERN_ERR PFX "Error in bcm43xx_setup_dmaring\n");
 	return ring;

 err_free_ringmemory:
@@ -705,30 +764,16 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 	struct bcm43xx_dmaring *ring;
 	int err = -ENOMEM;
 	int dma64 = 0;
-	u64 mask = bcm43xx_get_supported_dma_mask(bcm);
-	int nobits;

-	if (mask == DMA_64BIT_MASK) {
+	bcm->dma_mask = bcm43xx_get_supported_dma_mask(bcm);
+	if (bcm->dma_mask == DMA_64BIT_MASK)
 		dma64 = 1;
-		nobits = 64;
-	} else if (mask == DMA_32BIT_MASK)
-		nobits = 32;
-	else
-		nobits = 30;
-	err = pci_set_dma_mask(bcm->pci_dev, mask);
-	err |= pci_set_consistent_dma_mask(bcm->pci_dev, mask);
-	if (err) {
-#ifdef CONFIG_BCM43XX_PIO
-		printk(KERN_WARNING PFX "DMA not supported on this device."
-					" Falling back to PIO.\n");
-		bcm->__using_pio = 1;
-		return -ENOSYS;
-#else
-		printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
-				    "Please recompile the driver with PIO support.\n");
-		return -ENODEV;
-#endif /* CONFIG_BCM43XX_PIO */
-	}
+	err = pci_set_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;
+	err = pci_set_consistent_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;

 	/* setup TX DMA channels. */
 	ring = bcm43xx_setup_dmaring(bcm, 0, 1, dma64);
@@ -774,9 +819,12 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 		dma->rx_ring3 = ring;
 	}

-	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n", nobits);
+	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n",
+		(bcm->dma_mask == DMA_64BIT_MASK) ? 64 :
+		(bcm->dma_mask == DMA_32BIT_MASK) ? 32 : 30);
 	err = 0;
 out:
+	if(err)BUG();
 	return err;

 err_destroy_rx0:
@@ -800,7 +848,18 @@ err_destroy_tx1:
 err_destroy_tx0:
 	bcm43xx_destroy_dmaring(dma->tx_ring0);
 	dma->tx_ring0 = NULL;
-	goto out;
+no_dma:
+#ifdef CONFIG_BCM43XX_PIO
+	printk(KERN_WARNING PFX "DMA not supported on this device."
+				" Falling back to PIO.\n");
+	bcm->__using_pio = 1;
+	BUG();
+	return -ENOSYS;
+#else
+	printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
+			    "Please recompile the driver with PIO support.\n");
+	return -ENODEV;
+#endif /* CONFIG_BCM43XX_PIO */
 }

 /* Generate a cookie for the TX header. */
@@ -905,6 +964,7 @@ static void dma_tx_fragment(struct bcm43
 	struct bcm43xx_dmadesc_generic *desc;
 	struct bcm43xx_dmadesc_meta *meta;
 	dma_addr_t dmaaddr;
+	struct sk_buff *bounce_skb;

 	assert(skb_shinfo(skb)->nr_frags == 0);

@@ -924,9 +984,28 @@ static void dma_tx_fragment(struct bcm43
 			       skb->len - sizeof(struct bcm43xx_txhdr),
 			       (cur_frag == 0),
 			       generate_cookie(ring, slot));
+	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
+	if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+		/* chip cannot handle DMA to/from > 1GB, use bounce buffer */
+		if (!dma_mapping_error(dmaaddr))
+			unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+		bounce_skb = __dev_alloc_skb(skb->len, GFP_ATOMIC|GFP_DMA);
+		if (!bounce_skb)
+			return;
+		dmaaddr = map_descbuffer(ring, bounce_skb->data, bounce_skb->len, 1);
+		if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+			if (!dma_mapping_error(dmaaddr))
+				unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+			dev_kfree_skb_any(bounce_skb);
+			assert(0);
+			return;
+		}
+		memcpy(skb_put(bounce_skb, skb->len), skb->data, skb->len);
+		dev_kfree_skb_any(skb);
+		skb = bounce_skb;
+	}

 	meta->skb = skb;
-	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
 	meta->dmaaddr = dmaaddr;

 	fill_descriptor(ring, desc, dmaaddr,
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -771,6 +771,7 @@ struct bcm43xx_private {
 	 * This is currently always BCM43xx_BUSTYPE_PCI
 	 */
 	u8 bustype;
+	u64 dma_mask;

 	u16 board_vendor;
 	u16 board_type;


From dang at fprintf.net  Fri Jan 19 02:55:21 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Thu, 18 Jan 2007 20:55:21 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45AFC5FD.3090403@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
Message-ID: <1169171722.11134.20.camel@athena.fprintf.net>

On Thu, 2007-01-18 at 13:09 -0600, Larry Finger wrote:
> For those of you with cards having 30-bit DMA and >1 GB RAM, I think I have good news.
> 
> I added memory to bring my x86_64 machine up to 1.5 GB, and tricked the code into thinking I had a
> 30-bit interface rather than the 32-bit model it really is. The necessary code changes were derived
> from drivers/net/b44.c as this hardware has the same problem as bcm43xx. So far this has only been
> tested using my hardware, and I look forward to your reports.
> 
> The patch is for 2.6.20-rc5. If it does not apply on your kernel version, please let me know.

I applied this and radio_enable_2.6.20 to 2.6.20-rc5, and it seems to
work great.  No panics, associates, decent power, and so on.  The only
oddity is that the radio wouldn't turn on until I pressed the button.
This is odd, because it's a soft button, not a hardware button.
However, once pressed, everything worked fine.

Daniel



From larry.finger at lwfinger.net  Fri Jan 19 03:35:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 20:35:26 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <1169171722.11134.20.camel@athena.fprintf.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<1169171722.11134.20.camel@athena.fprintf.net>
Message-ID: <45B02E6E.7070409@lwfinger.net>

Daniel Gryniewicz wrote:
> 
> I applied this and radio_enable_2.6.20 to 2.6.20-rc5, and it seems to
> work great.  No panics, associates, decent power, and so on.  The only
> oddity is that the radio wouldn't turn on until I pressed the button.
> This is odd, because it's a soft button, not a hardware button.
> However, once pressed, everything worked fine.

Do you have debugging turned on for the bcm43xx driver? If so, please send me all the bcm43xx
entries from the output of dmesg. Every card I've seem so far has the readio-enable switch wired
into the hardware. Yours must be the exception.

Larry


From dang at fprintf.net  Fri Jan 19 03:55:25 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Thu, 18 Jan 2007 21:55:25 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B02E6E.7070409@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<1169171722.11134.20.camel@athena.fprintf.net>
	<45B02E6E.7070409@lwfinger.net>
Message-ID: <1169175325.11134.24.camel@athena.fprintf.net>

On Thu, 2007-01-18 at 20:35 -0600, Larry Finger wrote:
> Daniel Gryniewicz wrote:
> > 
> > I applied this and radio_enable_2.6.20 to 2.6.20-rc5, and it seems to
> > work great.  No panics, associates, decent power, and so on.  The only
> > oddity is that the radio wouldn't turn on until I pressed the button.
> > This is odd, because it's a soft button, not a hardware button.
> > However, once pressed, everything worked fine.
> 
> Do you have debugging turned on for the bcm43xx driver? If so, please send me all the bcm43xx
> entries from the output of dmesg. Every card I've seem so far has the readio-enable switch wired
> into the hardware. Yours must be the exception.
> 

Attached.  It worked fine for a while, then just disassociated.  I
assume it's the transmit power problems, but I don't know.  Let me know
if you need something else.

I guess I'm not *sure* it's a soft switch; however, before now, pressing
the button in linux did nothing.  The radio was always on as long as the
interface was up.  On windows, the button enables and disables the
radio.

Daniel
-------------- next part --------------
bcm43xx driver
bcm43xx: Chip ID 0x4318, rev 0x2
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Radio hardware status changed to enabled
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 2/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 29/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 1/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 2/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .active_key = 0, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
bcm43xx: set security called, .active_key = 0, .level = 1, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .level = 1, .enabled = 1, .encrypt = 1, .auth_mode = 0
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 3/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512

From larry.finger at lwfinger.net  Fri Jan 19 04:13:21 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 21:13:21 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <1169175325.11134.24.camel@athena.fprintf.net>
References: <45AFC5FD.3090403@lwfinger.net>	
	<1169171722.11134.20.camel@athena.fprintf.net>	
	<45B02E6E.7070409@lwfinger.net>
	<1169175325.11134.24.camel@athena.fprintf.net>
Message-ID: <45B03751.3020504@lwfinger.net>

Daniel Gryniewicz wrote:
> Attached.  It worked fine for a while, then just disassociated.  I
> assume it's the transmit power problems, but I don't know.  Let me know
> if you need something else.

I think you have the correct answer. The 4318's don't have much power output.
> 
> I guess I'm not *sure* it's a soft switch; however, before now, pressing
> the button in linux did nothing.  The radio was always on as long as the
> interface was up.  On windows, the button enables and disables the
> radio.
> 
> Daniel
> 
> 
> ------------------------------------------------------------------------
> 
> bcm43xx driver
> bcm43xx: Chip ID 0x4318, rev 0x2
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
> bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
> bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
> bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
> bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
> bcm43xx: Radio turned on
> bcm43xx: Radio disabled by hardware

It is a hardware button, but was off when you started.

> bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized

You only need the radio patch, not the DMA one.

> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: Radio hardware status changed to enabled

This is where you turned the radio button on.

> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
> bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0

Thanks for the data.

Larry



From dang at fprintf.net  Fri Jan 19 04:22:45 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Thu, 18 Jan 2007 22:22:45 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B03751.3020504@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<1169171722.11134.20.camel@athena.fprintf.net>
	<45B02E6E.7070409@lwfinger.net>
	<1169175325.11134.24.camel@athena.fprintf.net>
	<45B03751.3020504@lwfinger.net>
Message-ID: <1169176965.11134.29.camel@athena.fprintf.net>

On Thu, 2007-01-18 at 21:13 -0600, Larry Finger wrote:
> Daniel Gryniewicz wrote:
> > Attached.  It worked fine for a while, then just disassociated.  I
> > assume it's the transmit power problems, but I don't know.  Let me know
> > if you need something else.
> 
> I think you have the correct answer. The 4318's don't have much power output.

Probably.  It's not been consistently useful, ever.

> > bcm43xx driver
> > bcm43xx: Chip ID 0x4318, rev 0x2
> > bcm43xx: Number of cores: 4
> > bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243
> > bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243
> > bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243
> > bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243
> > bcm43xx: PHY connected
> > bcm43xx: Detected PHY: Version: 3, Type 2, Revision 7
> > bcm43xx: Detected Radio: ID: 8205017f (Manuf: 17f Ver: 2050 Rev: 8)
> > bcm43xx: Radio turned off
> > bcm43xx: Radio turned off
> > bcm43xx: PHY connected
> > bcm43xx: Microcode rev 0x123, pl 0x21 (2005-01-22  19:48:06)
> > bcm43xx: Radio turned on
> > bcm43xx: Radio disabled by hardware
> 
> It is a hardware button, but was off when you started.

If it's hardware, why did it never do anything before?  I'm curious...
Was the driver overriding it somehow?

> > bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> > bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> > bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at: drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
> > bcm43xx: Chip initialized
> > bcm43xx: 32-bit DMA initialized
> 
> You only need the radio patch, not the DMA one.

I was the original one to report the panics with > 1G of RAM, so I
definitely need something...  But, no panic now, so I'm happy either
way.

> Thanks for the data.

No problem.  Thanks for your work on the driver.  Any info I can give to
help (aside from code; our company has NDAs with Broadcom, even if I've
never seen the data sheets, so I can be considered contaminated...) will
be gladly given.

Daniel



From larry.finger at lwfinger.net  Fri Jan 19 04:36:25 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 21:36:25 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <1169176965.11134.29.camel@athena.fprintf.net>
References: <45AFC5FD.3090403@lwfinger.net>	<1169171722.11134.20.camel@athena.fprintf.net>	<45B02E6E.7070409@lwfinger.net>	<1169175325.11134.24.camel@athena.fprintf.net>	<45B03751.3020504@lwfinger.net>
	<1169176965.11134.29.camel@athena.fprintf.net>
Message-ID: <45B03CB9.9020201@lwfinger.net>

Daniel Gryniewicz wrote:
> 
> If it's hardware, why did it never do anything before?  I'm curious...
> Was the driver overriding it somehow?

No, the driver wasn't overriding it before, but it wasn't turning the light on either. There was no
way for you to know if it was on or off.
> 
> 
> I was the original one to report the panics with > 1G of RAM, so I
> definitely need something...  But, no panic now, so I'm happy either
> way.

There must be something in there that is even better than I thought. Even the blind squirrel gets a
nut once in a while.

>> Thanks for the data.
> 
> No problem.  Thanks for your work on the driver.  Any info I can give to
> help (aside from code; our company has NDAs with Broadcom, even if I've
> never seen the data sheets, so I can be considered contaminated...) will
> be gladly given.

I think this means that you are limited to testing, but that is extremely valuable.

Larry




From gene.heskett at verizon.net  Fri Jan 19 04:38:12 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 18 Jan 2007 22:38:12 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <1169175325.11134.24.camel@athena.fprintf.net>
References: <45AFC5FD.3090403@lwfinger.net> <45B02E6E.7070409@lwfinger.net>
	<1169175325.11134.24.camel@athena.fprintf.net>
Message-ID: <200701182238.12485.gene.heskett@verizon.net>

On Thursday 18 January 2007 21:55, Daniel Gryniewicz wrote:
>On Thu, 2007-01-18 at 20:35 -0600, Larry Finger wrote:
>> Daniel Gryniewicz wrote:
>> > I applied this and radio_enable_2.6.20 to 2.6.20-rc5, and it seems
>> > to work great.  No panics, associates, decent power, and so on.  The
>> > only oddity is that the radio wouldn't turn on until I pressed the
>> > button. This is odd, because it's a soft button, not a hardware
>> > button. However, once pressed, everything worked fine.
>>
>> Do you have debugging turned on for the bcm43xx driver? If so, please
>> send me all the bcm43xx entries from the output of dmesg. Every card
>> I've seem so far has the readio-enable switch wired into the hardware.
>> Yours must be the exception.
>
>Attached.  It worked fine for a while, then just disassociated.  I
>assume it's the transmit power problems, but I don't know.  Let me know
>if you need something else.
>
>I guess I'm not *sure* it's a soft switch; however, before now, pressing
>the button in linux did nothing.  The radio was always on as long as the
>interface was up.  On windows, the button enables and disables the
>radio.
>
>Daniel

I think this must be a fairly common way for HP at least to do it.  The 
switch on my HP dv5120us feels like a momentary of some sort, and in 
windows it turns the radio on and off.  However it seems to be a bit 
confused for linux, if its on, and the led in the hinge is on, then 
there's a 50% chance the radio is on.  Tapping the button in linux turns 
off the led, but never turns it back on, so I have to tap the button and 
restart the network, repeat till the led comes on.  However, iwconfig and 
iwlist appear to report that it is functioning when in fact it is not 
until the magic twanger combo of button taps and network restarts finally 
manages to enable the led again.

In other words, it appears that button status and led status to make it 
work are a real crap shoot.  Communication between the button and the 
radio certainly seems broken on my lappy.  It BTW has a bcm4318 radio in 
it.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From larry.finger at lwfinger.net  Fri Jan 19 04:49:57 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 21:49:57 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <200701182238.12485.gene.heskett@verizon.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<45B02E6E.7070409@lwfinger.net>	<1169175325.11134.24.camel@athena.fprintf.net>
	<200701182238.12485.gene.heskett@verizon.net>
Message-ID: <45B03FE5.5080302@lwfinger.net>

Gene Heskett wrote:
> 
> I think this must be a fairly common way for HP at least to do it.  The 
> switch on my HP dv5120us feels like a momentary of some sort, and in 
> windows it turns the radio on and off.  However it seems to be a bit 
> confused for linux, if its on, and the led in the hinge is on, then 
> there's a 50% chance the radio is on.  Tapping the button in linux turns 
> off the led, but never turns it back on, so I have to tap the button and 
> restart the network, repeat till the led comes on.  However, iwconfig and 
> iwlist appear to report that it is functioning when in fact it is not 
> until the magic twanger combo of button taps and network restarts finally 
> manages to enable the led again.
> 
> In other words, it appears that button status and led status to make it 
> work are a real crap shoot.  Communication between the button and the 
> radio certainly seems broken on my lappy.  It BTW has a bcm4318 radio in 
> it.

With the radio_enable patch, The light should come on when the switch enables the radio; however,
the interface must also be up for the light to be on.

On my HP dv2125nr, I have a slide switch; however, the interface is a Dell 1390, which is a BCM4311
chip.

Larry





From Larry.Finger at lwfinger.net  Fri Jan 19 05:06:59 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 22:06:59 -0600
Subject: [PATCH] bcm43xx: Check error returns in initialization routines
Message-ID: <45b043e3.NGzJyc7WBaqk9U0D%Larry.Finger@lwfinger.net>

A number of the calls in the initialization routines fail to check the returned value for
errors. This patch adds the necessary checks and logs any errors found when appropriate.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

To be applied to wireless-2.6.


Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -2980,8 +2980,10 @@ static int bcm43xx_chipset_attach(struct
 	err = bcm43xx_pctl_set_crystal(bcm, 1);
 	if (err)
 		goto out;
-	bcm43xx_pci_read_config16(bcm, PCI_STATUS, &pci_status);
-	bcm43xx_pci_write_config16(bcm, PCI_STATUS, pci_status & ~PCI_STATUS_SIG_TARGET_ABORT);
+	err = bcm43xx_pci_read_config16(bcm, PCI_STATUS, &pci_status);
+	if (err)
+		goto out;
+	err = bcm43xx_pci_write_config16(bcm, PCI_STATUS, pci_status & ~PCI_STATUS_SIG_TARGET_ABORT);
 
 out:
 	return err;
@@ -3793,12 +3795,18 @@ static int bcm43xx_attach_board(struct b
 	}
 	net_dev->base_addr = (unsigned long)bcm->mmio_addr;
 
-	bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_VENDOR_ID,
+	err = bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_VENDOR_ID,
 	                          &bcm->board_vendor);
-	bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_ID,
+	if (err)
+		goto err_iounmap;
+	err = bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_ID,
 	                          &bcm->board_type);
-	bcm43xx_pci_read_config16(bcm, PCI_REVISION_ID,
+	if (err)
+		goto err_iounmap;
+	err = bcm43xx_pci_read_config16(bcm, PCI_REVISION_ID,
 	                          &bcm->board_revision);
+	if (err)
+		goto err_iounmap;
 
 	err = bcm43xx_chipset_attach(bcm);
 	if (err)
@@ -3889,6 +3897,7 @@ err_pci_release:
 	pci_release_regions(pci_dev);
 err_pci_disable:
 	pci_disable_device(pci_dev);
+	printk(KERN_ERR PFX "Unable to attach board\n");
 	goto out;
 }

--- 


From gene.heskett at verizon.net  Fri Jan 19 06:00:37 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 19 Jan 2007 00:00:37 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B03FE5.5080302@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<200701182238.12485.gene.heskett@verizon.net>
	<45B03FE5.5080302@lwfinger.net>
Message-ID: <200701190000.37890.gene.heskett@verizon.net>

On Thursday 18 January 2007 22:49, Larry Finger wrote:
>Gene Heskett wrote:
>> I think this must be a fairly common way for HP at least to do it. 
>> The switch on my HP dv5120us feels like a momentary of some sort, and
>> in windows it turns the radio on and off.  However it seems to be a
>> bit confused for linux, if its on, and the led in the hinge is on,
>> then there's a 50% chance the radio is on.  Tapping the button in
>> linux turns off the led, but never turns it back on, so I have to tap
>> the button and restart the network, repeat till the led comes on. 
>> However, iwconfig and iwlist appear to report that it is functioning
>> when in fact it is not until the magic twanger combo of button taps
>> and network restarts finally manages to enable the led again.
>>
>> In other words, it appears that button status and led status to make
>> it work are a real crap shoot.  Communication between the button and
>> the radio certainly seems broken on my lappy.  It BTW has a bcm4318
>> radio in it.
>
>With the radio_enable patch, The light should come on when the switch
> enables the radio; however, the interface must also be up for the light
> to be on.
>
Humm, how long till that patch makes it to a fedora kernel?  I haven't 
built a kernel yet for that lappy. I figure one or two a week on this box 
costs me enough blood.

>On my HP dv2125nr, I have a slide switch; however, the interface is a
> Dell 1390, which is a BCM4311 chip.
>
>Larry

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From larry.finger at lwfinger.net  Fri Jan 19 06:29:22 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 18 Jan 2007 23:29:22 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <200701190000.37890.gene.heskett@verizon.net>
References: <45AFC5FD.3090403@lwfinger.net>	<200701182238.12485.gene.heskett@verizon.net>	<45B03FE5.5080302@lwfinger.net>
	<200701190000.37890.gene.heskett@verizon.net>
Message-ID: <45B05732.70800@lwfinger.net>

Gene Heskett wrote:
>
> Humm, how long till that patch makes it to a fedora kernel?  I haven't 
> built a kernel yet for that lappy. I figure one or two a week on this box 
> costs me enough blood.

I'm not sure about Fedora, but most distros won't touch a patch until it makes it past Linus and
appears in the "stable" kernel. For this fix, that will be 2.6.21 that should be out in about 3-4
months. This one hasn't made it though review yet, and there hasn't been much testing. If testing
goes well, I will push it to the wireless-2.6 git tree in about a week. Things happen slowly in this
business.

Larry


From gene.heskett at verizon.net  Fri Jan 19 07:15:28 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 19 Jan 2007 01:15:28 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B05732.70800@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<200701190000.37890.gene.heskett@verizon.net>
	<45B05732.70800@lwfinger.net>
Message-ID: <200701190115.29378.gene.heskett@verizon.net>

On Friday 19 January 2007 00:29, Larry Finger wrote:
>Gene Heskett wrote:
>> Humm, how long till that patch makes it to a fedora kernel?  I haven't
>> built a kernel yet for that lappy. I figure one or two a week on this
>> box costs me enough blood.
>
>I'm not sure about Fedora, but most distros won't touch a patch until it
> makes it past Linus and appears in the "stable" kernel. For this fix,
> that will be 2.6.21 that should be out in about 3-4 months. This one
> hasn't made it though review yet, and there hasn't been much testing.
> If testing goes well, I will push it to the wireless-2.6 git tree in
> about a week. Things happen slowly in this business.
>
>Larry

So I've noted, Larry.  Are you offering snapshots packed as tar.gz's from 
time to time, something I can just nuke the existing kernel stuff and 
replace that whole subdir with your's?

That could tempt me to try making a kernel for that lappy.

But not till after I get this transmitter combo hooked up and actually 
running at WDTV-5.  Our 50 year old GE tx uses 2 pairs of 4-1000 tubes, 
and I have the last tubes on the planet in that transmitter now and they 
are fading.  So we've bought a newer Harris I'm going to use for a driver 
since its too small to make full power.  I won't have a lot of breathing 
room till at least a month on down the log.  Maybe longer what with 
needing to build the control interfaces from scratch too.

Thanks.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From larry.finger at lwfinger.net  Fri Jan 19 16:33:17 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Jan 2007 09:33:17 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <200701190115.29378.gene.heskett@verizon.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<200701190000.37890.gene.heskett@verizon.net>
	<45B05732.70800@lwfinger.net>
	<200701190115.29378.gene.heskett@verizon.net>
Message-ID: <45B0E4BD.6050505@lwfinger.net>

Gene Heskett wrote:
> 
> So I've noted, Larry.  Are you offering snapshots packed as tar.gz's from 
> time to time, something I can just nuke the existing kernel stuff and 
> replace that whole subdir with your's?

Usually, I offer patches for kernel versions from 2.6.18 forward to incorporate the latest
revisions. That is what I'm doing to keep the openSUSE-released kernel (2.6.18.2) working on my
laptop. I usually run 2.6.20-rcX or wireless-2.6, but the "official" kernel of my distro is always
available. The patches are always available on my ftp server.
> 
> That could tempt me to try making a kernel for that lappy.
> 
> But not till after I get this transmitter combo hooked up and actually 
> running at WDTV-5.  Our 50 year old GE tx uses 2 pairs of 4-1000 tubes, 
> and I have the last tubes on the planet in that transmitter now and they 
> are fading.  So we've bought a newer Harris I'm going to use for a driver 
> since its too small to make full power.  I won't have a lot of breathing 
> room till at least a month on down the log.  Maybe longer what with 
> needing to build the control interfaces from scratch too.

That brings a thought to mind. What does any multi-kilowatt transmitter use for output devices?
Obviously, you cannot just use a solid-state device.

Larry

> 
> Thanks.
> 





From gene.heskett at verizon.net  Fri Jan 19 19:34:06 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 19 Jan 2007 13:34:06 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B0E4BD.6050505@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<200701190115.29378.gene.heskett@verizon.net>
	<45B0E4BD.6050505@lwfinger.net>
Message-ID: <200701191334.07322.gene.heskett@verizon.net>

On Friday 19 January 2007 10:33, Larry Finger wrote:
>Gene Heskett wrote:
>> So I've noted, Larry.  Are you offering snapshots packed as tar.gz's
>> from time to time, something I can just nuke the existing kernel stuff
>> and replace that whole subdir with your's?
>
>Usually, I offer patches for kernel versions from 2.6.18 forward to
> incorporate the latest revisions. That is what I'm doing to keep the
> openSUSE-released kernel (2.6.18.2) working on my laptop. I usually run
> 2.6.20-rcX or wireless-2.6, but the "official" kernel of my distro is
> always available. The patches are always available on my ftp server.
>
>> That could tempt me to try making a kernel for that lappy.
>>
>> But not till after I get this transmitter combo hooked up and actually
>> running at WDTV-5.  Our 50 year old GE tx uses 2 pairs of 4-1000
>> tubes, and I have the last tubes on the planet in that transmitter now
>> and they are fading.  So we've bought a newer Harris I'm going to use
>> for a driver since its too small to make full power.  I won't have a
>> lot of breathing room till at least a month on down the log.  Maybe
>> longer what with needing to build the control interfaces from scratch
>> too.
>
>That brings a thought to mind. What does any multi-kilowatt transmitter
> use for output devices? Obviously, you cannot just use a solid-state
> device.

Chuckle, yes you can, but the method does take many of the available 
output devices, usually a power fet type, and the combiner networks are 
2/3rds of the weight of the whole transmitter.  But yes, I can buy, from 
Larcan for instance, all solid stage transmitters at vhf power levels up 
to 50kw.  An individual device failure costs the output of 2 of them 
because of the combiner physics, but the failure is what we call 
gracefull in that you are still on the air, and at full power until quite 
a few devices have failed.  Oh, bring money too, this is 6 digit stuff 
and the first one is probably more than 3 these days...

In our case, the final is a glass triode originally made by Eimac but now 
they are all being rebuilt from time to time by people such as Econco.  
Its a water cooled anode tube, with about 40 gallons of water a minute 
being pumped through it, then out to a big fan cooled radiator and dumped 
back into about a 200 gallon copper tank that the 10 horse pump pulls 
from.  The fan is quad of torrington wheels about 16" in diameter & 9" or 
so deep on each side, keeping a 15 horse motor around nameplate current 
per phase.  So in the end we move a lot of air.  And we keep the water 
very pure because pure water is an insulator, those 1" id hoses that hook 
to the bottom of the socket have 7200 volts on them. We intercept the 
hoses before they hit grounded stuff so we can read the leakage & know 
when to change the deionizer cartridge, typically reading less than 1 
milliamp, we change the cartridge when it gets up to 2 mills.  Even so we 
change the hose barbs and hoses every so often because the hose barbs are 
corroded away inside the hose where you can't see them.  Blowing a hose 
off whats left of a hose barb makes a mess & takes quite a bit of drying. 

This tube weighs about 30 lbs, 20 of which is the copper anode and water 
jacket, stands about 28" tall, 10" maximum diameter for the grid contact 
ring which is at rf ground, but about -275 volts of bias.  Operated as a 
grounded grid stage, the driver power (about 3 to 4 kw) we feed in not 
only drives the tube, but also comes out as output, that's the nature of 
grounded grid amplifiers.  The tube itself is rated to 75kw 6 mhz wide in 
the low vhf band.  We only need 27kw sync tip peak, so I don't run the 
heaters at full power which would be at 12 volts and 180 amps current.  
Overbuilt for the job, the last one ran for a bit over 10 years.  It 
costs us in the area of $7k to get one rebuilt.  This is the visual, the 
aural is actually a separate transmitter that due to the physics 
of 'intercarrier sound' has been running at about 900 watts for the last 
12 years, its sufficient.

I think the visuao tube we have in now will handily finish out the ntsc 
days which are scheduled to be turned off January 2009 now, only 2 years 
hence.  But stay tuned, the dems are now in power and we're hearing 
rumors of yet another extension, so we're starting to arrange to get one 
of our duds rebuilt just in case.

By now we're what I think could be called off topic though.  The power 
level of this "radio" is about 10ee+07 of what a bcm43xx can do. :-)

>Larry
>
>> Thanks.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From will.dyson at gmail.com  Fri Jan 19 20:53:32 2007
From: will.dyson at gmail.com (Will Dyson)
Date: Fri, 19 Jan 2007 14:53:32 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45AFC5FD.3090403@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
Message-ID: <8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>

On 1/18/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> For those of you with cards having 30-bit DMA and >1 GB RAM, I think I have good news.

Hi Larry,

I just tried the patch, and I can confirm that it allows me to run
with my full 3GB!

You rock!

-- 
Will Dyson
http://www.lucidts.com/
Linux/Mac/Win consulting


From larry.finger at lwfinger.net  Fri Jan 19 21:47:16 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Jan 2007 14:47:16 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>
References: <45AFC5FD.3090403@lwfinger.net>
	<8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>
Message-ID: <45B12E54.1060404@lwfinger.net>

Will Dyson wrote:
> Hi Larry,
> 
> I just tried the patch, and I can confirm that it allows me to run
> with my full 3GB!

No criticism of your efforts are implied, but it was a lot easier to debug with a machine having the
problem on my desk. Keeping a train of thought over several days is beyond me now.

Enjoy.

Larry


From larry.finger at lwfinger.net  Fri Jan 19 23:28:02 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Jan 2007 16:28:02 -0600
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <200701191719.02965.gene.heskett@verizon.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>
	<45B12E54.1060404@lwfinger.net>
	<200701191719.02965.gene.heskett@verizon.net>
Message-ID: <45B145F2.90705@lwfinger.net>

Gene Heskett wrote:
> On Friday 19 January 2007 15:47, Larry Finger wrote:
>> Will Dyson wrote:
>>> Hi Larry,
>>>
>>> I just tried the patch, and I can confirm that it allows me to run
>>> with my full 3GB!
>> No criticism of your efforts are implied, but it was a lot easier to
>> debug with a machine having the problem on my desk. Keeping a train of
>> thought over several days is beyond me now.
> 
> Hey Larry, that's my line.  My excuse is that I'm 72.  Whats your's? :-)

I'm 66.

Larry


From gene.heskett at verizon.net  Fri Jan 19 23:19:02 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 19 Jan 2007 17:19:02 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B12E54.1060404@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>
	<45B12E54.1060404@lwfinger.net>
Message-ID: <200701191719.02965.gene.heskett@verizon.net>

On Friday 19 January 2007 15:47, Larry Finger wrote:
>Will Dyson wrote:
>> Hi Larry,
>>
>> I just tried the patch, and I can confirm that it allows me to run
>> with my full 3GB!
>
>No criticism of your efforts are implied, but it was a lot easier to
> debug with a machine having the problem on my desk. Keeping a train of
> thought over several days is beyond me now.

Hey Larry, that's my line.  My excuse is that I'm 72.  Whats your's? :-)

>Enjoy.
>
>Larry
>_______________________________________________
>Bcm43xx-dev mailing list
>Bcm43xx-dev at lists.berlios.de
>https://lists.berlios.de/mailman/listinfo/bcm43xx-dev

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From gene.heskett at verizon.net  Sat Jan 20 00:30:05 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Fri, 19 Jan 2007 18:30:05 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B145F2.90705@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<200701191719.02965.gene.heskett@verizon.net>
	<45B145F2.90705@lwfinger.net>
Message-ID: <200701191830.05360.gene.heskett@verizon.net>

On Friday 19 January 2007 17:28, Larry Finger wrote:
>Gene Heskett wrote:
>> On Friday 19 January 2007 15:47, Larry Finger wrote:
>>> Will Dyson wrote:
>>>> Hi Larry,
>>>>
>>>> I just tried the patch, and I can confirm that it allows me to run
>>>> with my full 3GB!
>>>
>>> No criticism of your efforts are implied, but it was a lot easier to
>>> debug with a machine having the problem on my desk. Keeping a train
>>> of thought over several days is beyond me now.
>>
>> Hey Larry, that's my line.  My excuse is that I'm 72.  Whats your's?
>> :-)
>
>I'm 66.
>
>Larry

Oh. Chuckle, so you too get a giggle out of them tender 'sweet young 
things' at fast food places when you ask for the OFD (and then have to 
explain that its stands for Old Fart Discount).  I once saw a sweat shirt 
on an elderly lady at the local Dunkin Donuts shop that said "Yes, I'm a 
Senior Citizen, now gimme the damn discount".

I've been looking for one of them in the 10 years since and coming up 
empty.  I guess I don't shop at the boutique places often enough or 
something.

But, generally speaking, I've had a ball getting here. :)

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From ftoledo at docksud.com.ar  Sat Jan 20 02:12:15 2007
From: ftoledo at docksud.com.ar (Fernando Toledo)
Date: Fri, 19 Jan 2007 22:12:15 -0300
Subject: 4311 tests - No scan results -
Message-ID: <45B16C6F.9050400@docksud.com.ar>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi i have a problem to see an Dlink ap900+ in my house (that have the
latest revision "B" firmware and basic ap configuration)

i have a zd1211 usb dongle and my onboard 4311PCIE (the zydas dongle
connect fine, but not the 4311)

wlan1 : zd1211rw
eth1: bcm43xx

i can connect to another ap (Noganet vendor), but not here

ntbkragnarok:/usr/src# iwlist wlan1 s
wlan1     Scan completed :
          Cell 01 - Address: 00:80:C8:AC:AA:06
                    ESSID:"docksud"
                    Protocol:IEEE 802.11b
                    Mode:Master
                    Channel:6
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 22 Mb/s
                    Quality=100/100  Signal level=82/100
                    Extra: Last beacon: 180ms ago

ntbkragnarok:/usr/src# iwlist eth1 s
eth1      No scan results
ntbkragnarok:/usr/src#

ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:10:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, disabled
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio disabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: Radio hardware status changed to enabled
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished

i test it on 2.6.19.2 (with the las two larry patches for 2.6.19.1)
these patch's was apply succesfully on 2.6.19.2
ntbkragnarok:/usr/src# iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

eth1      IEEE 802.11b/g  ESSID:"docksud"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

wlan1     IEEE 802.11b/g  ESSID:"docksud"  Nickname:"zd1211"
          Mode:Managed  Frequency:2.437 GHz  Access Point:
00:80:C8:AC:AA:06
          Bit Rate=11 Mb/s
          Encryption key:off
          Link Quality=60/100  Signal level=24/100
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0


Saludos!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFFsWxvz8H9Vs7bTsMRAty+AJ4oR5cRPmEyTzLk1BBCU88W3O80ogCfVlvH
j2krhHGSJcL8mIlrWfPAj8M=
=doPd
-----END PGP SIGNATURE-----



From will.dyson at gmail.com  Sat Jan 20 02:30:45 2007
From: will.dyson at gmail.com (Will Dyson)
Date: Fri, 19 Jan 2007 20:30:45 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45B12E54.1060404@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
	<8e6f94720701191153y58f30ab0h86fcf2e9df2d9ee6@mail.gmail.com>
	<45B12E54.1060404@lwfinger.net>
Message-ID: <8e6f94720701191730k1db47276l672ddf0ec6f89ce3@mail.gmail.com>

On 1/19/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Will Dyson wrote:
> > Hi Larry,
> >
> > I just tried the patch, and I can confirm that it allows me to run
> > with my full 3GB!
>
> No criticism of your efforts are implied, but it was a lot easier to debug with a machine having the
> problem on my desk. Keeping a train of thought over several days is beyond me now.

Haha :)

Unfortunately, my debugging efforts over the past few weeks have gone like this:

1) Setup computer for development (latest git kernel etc).
2) Trace the failures a few steps.
3) Get interrupted by Real Life.
4) Wait a few days, goto step 1.

-- 
Will Dyson
http://www.lucidts.com/
Linux/Mac/Win consulting


From larry.finger at lwfinger.net  Sat Jan 20 03:24:43 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Jan 2007 20:24:43 -0600
Subject: 4311 tests - No scan results -
In-Reply-To: <45B16C6F.9050400@docksud.com.ar>
References: <45B16C6F.9050400@docksud.com.ar>
Message-ID: <45B17D6B.1000602@lwfinger.net>

Fernando Toledo wrote:
> Hi i have a problem to see an Dlink ap900+ in my house (that have the
> latest revision "B" firmware and basic ap configuration)
> 
> i have a zd1211 usb dongle and my onboard 4311PCIE (the zydas dongle
> connect fine, but not the 4311)
> 
> wlan1 : zd1211rw
> eth1: bcm43xx
> 
> i can connect to another ap (Noganet vendor), but not here
> 
> ntbkragnarok:/usr/src# iwlist wlan1 s
> wlan1     Scan completed :
>           Cell 01 - Address: 00:80:C8:AC:AA:06
>                     ESSID:"docksud"
>                     Protocol:IEEE 802.11b
>                     Mode:Master
>                     Channel:6
>                     Encryption key:off
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 22 Mb/s
>                     Quality=100/100  Signal level=82/100
>                     Extra: Last beacon: 180ms ago
> 
> ntbkragnarok:/usr/src# iwlist eth1 s
> eth1      No scan results
> ntbkragnarok:/usr/src#
> 
> ACPI: PCI Interrupt 0000:10:00.0[A] -> GSI 17 (level, low) -> IRQ 17
> PCI: Setting latency timer of device 0000:10:00.0 to 64
> bcm43xx: Chip ID 0x4311, rev 0x1
> bcm43xx: Number of cores: 4
> bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243, enabled
> bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243, disabled
> bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243, disabled
> bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243, enabled
> bcm43xx: PHY connected
> bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
> bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
> bcm43xx: Radio turned off
> bcm43xx: Radio turned off
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: Radio turned on
> bcm43xx: Radio disabled by hardware
> bcm43xx: Chip initialized
> bcm43xx: 32-bit DMA initialized
> bcm43xx: Keys cleared
> bcm43xx: Selected 802.11 core (phytype 2)
> bcm43xx: Radio hardware status changed to enabled
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> SoftMAC: Start scanning with channel: 1
> SoftMAC: Scanning 14 channels
> SoftMAC: Scanning finished
> 
> i test it on 2.6.19.2 (with the las two larry patches for 2.6.19.1)
> these patch's was apply succesfully on 2.6.19.2
> ntbkragnarok:/usr/src# iwconfig
> lo        no wireless extensions.
> 
> eth0      no wireless extensions.
> 
> eth1      IEEE 802.11b/g  ESSID:"docksud"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.484 GHz  Access Point: Invalid
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> wlan1     IEEE 802.11b/g  ESSID:"docksud"  Nickname:"zd1211"
>           Mode:Managed  Frequency:2.437 GHz  Access Point:
> 00:80:C8:AC:AA:06
>           Bit Rate=11 Mb/s
>           Encryption key:off
>           Link Quality=60/100  Signal level=24/100
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0

I asked you once before for the output of ifconfig. We have no way to know if your interface is up
or down.

Larry


From ubq7 at stud.uni-karlsruhe.de  Sat Jan 20 03:48:03 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Sat, 20 Jan 2007 03:48:03 +0100
Subject: 4311 tests - No scan results -
In-Reply-To: <45B17D6B.1000602@lwfinger.net>
References: <45B16C6F.9050400@docksud.com.ar> <45B17D6B.1000602@lwfinger.net>
Message-ID: <200701200348.03306.ubq7@stud.uni-karlsruhe.de>

Am Samstag 20 Januar 2007 03:24 schrieb Larry Finger:
> Fernando Toledo wrote:
> >           Link Quality=60/100  Signal level=24/100
> >           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
> >           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>
> I asked you once before for the output of ifconfig. We have no way to know
> if your interface is up or down.

Well, is link quality reported on interfaces that are down? Mine show only "0" 
on wlan interfaces that are down.

HS


From larry.finger at lwfinger.net  Sat Jan 20 05:05:06 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 19 Jan 2007 22:05:06 -0600
Subject: 4311 tests - No scan results -
In-Reply-To: <200701200348.03306.ubq7@stud.uni-karlsruhe.de>
References: <45B16C6F.9050400@docksud.com.ar> <45B17D6B.1000602@lwfinger.net>
	<200701200348.03306.ubq7@stud.uni-karlsruhe.de>
Message-ID: <45B194F2.6050704@lwfinger.net>

Hendrik Sattler wrote:
> Am Samstag 20 Januar 2007 03:24 schrieb Larry Finger:
>> Fernando Toledo wrote:
>>>           Link Quality=60/100  Signal level=24/100
>>>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>>>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
>> I asked you once before for the output of ifconfig. We have no way to know
>> if your interface is up or down.
> 
> Well, is link quality reported on interfaces that are down? Mine show only "0" 
> on wlan interfaces that are down.

True, but those numbers come from the zd1211, not the 4311.

Larry


From mzt at alludra.com  Sat Jan 20 09:05:08 2007
From: mzt at alludra.com (Zahir Toufie)
Date: Sat, 20 Jan 2007 10:05:08 +0200
Subject: [PATCH] AMD x86_64 >1GB RAM DMA problem solved?
Message-ID: <1169280308.13919.7.camel@localhost.localdomain>

Larry Finger wrote:
> Zahir Toufie wrote:
> > 
> > Larry,
> > 
> > Had some free time and tried your patch.
> > 
> > Works like a charm. Good work! Now hopefully this patch finds it way
> > into my distro sooner than later. 
> > 
> > In round about which kernel version will this patch make it's
> > appearance?
>
> I'll try to get it into 2.6.19. Glad it worked and thanks for testing.
>
> Larry

Hi larry,

FC6 finally released there 2.6.19 kernel version 2.6.19-1.2895. I've
tested that patch from the 22 Sep 2006 which we worked on and it seems
to be working great now.

I've tested the patch on the following hardware:
- - - - -
Acer Ferrari 4000
AMD Turion 64
2GB RAM
Network controller: Broadcom Corporation BCM4318 [AirForce One 54g]  
  802.11g Wireless LAN Controller (rev 02)

Anyone elses milage may vary on different hardware, but for me it work
and finally I can use my wireless card.

Thanx for that.

I also see that there is a newer patch for 2.6.21-rc5 floating around,
will give that a try when it arrives and see if anything is better or
worse.



From mactalla.obair at gmail.com  Sat Jan 20 16:17:05 2007
From: mactalla.obair at gmail.com (Andrew Fuller)
Date: Sat, 20 Jan 2007 10:17:05 -0500
Subject: RFC/T bcm43xx-softmac: Fix for >1 GB RAM
In-Reply-To: <45AFC5FD.3090403@lwfinger.net>
References: <45AFC5FD.3090403@lwfinger.net>
Message-ID: <ae67fd3f0701200717r4d510afdv9cdca8be9b77574@mail.gmail.com>

On 1/18/07, Larry Finger <Larry.Finger at lwfinger.net> wrote:
> For those of you with cards having 30-bit DMA and >1 GB RAM, I think I have good news.
>
> I added memory to bring my x86_64 machine up to 1.5 GB, and tricked the code into thinking I had a
> 30-bit interface rather than the 32-bit model it really is. The necessary code changes were derived
> from drivers/net/b44.c as this hardware has the same problem as bcm43xx. So far this has only been
> tested using my hardware, and I look forward to your reports.
>
> The patch is for 2.6.20-rc5. If it does not apply on your kernel version, please let me know.
>
> Larry

Sorry it too me so long to test this, but all I have to say is "Golden!"

It scans, it associates, it does tricks.  And all this without a
message about dropping down to PIO mode or panicing the kernel!

It appears others have tested this already and so far all reports are
positive.  Time to push it to mainline?

Tested with vanilla kernel 2.6.20-rc5 with only this patch.
eMachines m6809 notebook with a bcm4306 rev03, 1.2GB RAM

Thanks again,
-Andrew

(Sorry, Larry, as usual I clicked "reply" rather than "reply all"...)


From Larry.Finger at lwfinger.net  Sat Jan 20 17:18:30 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 20 Jan 2007 10:18:30 -0600
Subject: [PATCH] bcm43xx: Fix problem with >1 GB RAM
Message-ID: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>

Some versions of the bcm43xx chips only support 30-bit DMA, which means
that the descriptors and buffers must be in the first 1 GB of RAM. On
the i386 and x86_64 architectures with more than 1 GB RAM, an incorrect
assignment may occur. This patch ensures that the various DMA addresses
are within the capability of the chip. Testing has been limited to x86_64
as no one has an i386 system with more than 1 GB RAM.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This patch should be applied to wireless-2.6 and pushed up to 2.6.20.

Thanks,

Larry

Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
@@ -145,16 +145,14 @@ dma_addr_t map_descbuffer(struct bcm43xx
 			  int tx)
 {
 	dma_addr_t dmaaddr;
+	int direction = PCI_DMA_FROMDEVICE;
 
-	if (tx) {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
-					 buf, len,
-					 DMA_TO_DEVICE);
-	} else {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
+	if (tx)
+		direction = PCI_DMA_TODEVICE;
+
+	dmaaddr = pci_map_single(ring->bcm->pci_dev,
 					 buf, len,
-					 DMA_FROM_DEVICE);
-	}
+					 direction);
 
 	return dmaaddr;
 }
@@ -166,13 +164,13 @@ void unmap_descbuffer(struct bcm43xx_dma
 		      int tx)
 {
 	if (tx) {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_TO_DEVICE);
+				 PCI_DMA_TODEVICE);
 	} else {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_FROM_DEVICE);
+				 PCI_DMA_FROMDEVICE);
 	}
 }
 
@@ -183,8 +181,8 @@ void sync_descbuffer_for_cpu(struct bcm4
 {
 	assert(!ring->tx);
 
-	dma_sync_single_for_cpu(&ring->bcm->pci_dev->dev,
-				addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_FROMDEVICE);
 }
 
 static inline
@@ -194,8 +192,8 @@ void sync_descbuffer_for_device(struct b
 {
 	assert(!ring->tx);
 
-	dma_sync_single_for_device(&ring->bcm->pci_dev->dev,
-				   addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_TODEVICE);
 }
 
 /* Unmap and free a descriptor buffer. */
@@ -214,17 +212,53 @@ void free_descriptor_buffer(struct bcm43
 
 static int alloc_ringmemory(struct bcm43xx_dmaring *ring)
 {
-	struct device *dev = &(ring->bcm->pci_dev->dev);
-
-	ring->descbase = dma_alloc_coherent(dev, BCM43xx_DMA_RINGMEMSIZE,
-					    &(ring->dmabase), GFP_KERNEL);
+	ring->descbase = pci_alloc_consistent(ring->bcm->pci_dev, BCM43xx_DMA_RINGMEMSIZE,
+					    &(ring->dmabase));
 	if (!ring->descbase) {
-		printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
-		return -ENOMEM;
+		/* Allocation may have failed due to pci_alloc_consistent
+		   insisting on use of GFP_DMA, which is more restrictive
+		   than necessary...  */
+		struct dma_desc *rx_ring;
+		dma_addr_t rx_ring_dma;
+
+		rx_ring = kzalloc(BCM43xx_DMA_RINGMEMSIZE, GFP_KERNEL);
+		if (!rx_ring)
+			goto out_err;
+
+		rx_ring_dma = pci_map_single(ring->bcm->pci_dev, rx_ring,
+					     BCM43xx_DMA_RINGMEMSIZE,
+					     PCI_DMA_BIDIRECTIONAL);
+
+		if (pci_dma_mapping_error(rx_ring_dma) ||
+		    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+			/* Sigh... */
+			if (!pci_dma_mapping_error(rx_ring_dma))
+				pci_unmap_single(ring->bcm->pci_dev,
+						 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			rx_ring_dma = pci_map_single(ring->bcm->pci_dev,
+						 rx_ring, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			if (pci_dma_mapping_error(rx_ring_dma) ||
+			    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+				assert(0);
+				if (!pci_dma_mapping_error(rx_ring_dma))
+					pci_unmap_single(ring->bcm->pci_dev,
+							 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+							 PCI_DMA_BIDIRECTIONAL);
+                        	goto out_err;
+			}
+                }
+
+                ring->descbase = rx_ring;
+                ring->dmabase = rx_ring_dma;
 	}
 	memset(ring->descbase, 0, BCM43xx_DMA_RINGMEMSIZE);
 
 	return 0;
+out_err:
+	printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
+	return -ENOMEM;
 }
 
 static void free_ringmemory(struct bcm43xx_dmaring *ring)
@@ -407,6 +441,29 @@ static int setup_rx_descbuffer(struct bc
 	if (unlikely(!skb))
 		return -ENOMEM;
 	dmaaddr = map_descbuffer(ring, skb->data, ring->rx_buffersize, 0);
+	/* This hardware bug work-around adapted from the b44 driver.
+	   The chip may be unable to do PCI DMA to/from anything above 1GB */
+	if (pci_dma_mapping_error(dmaaddr) ||
+	    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+		/* This one has 30-bit addressing... */
+		if (!pci_dma_mapping_error(dmaaddr))
+			pci_unmap_single(ring->bcm->pci_dev,
+					 dmaaddr, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		dev_kfree_skb_any(skb);
+		skb = __dev_alloc_skb(ring->rx_buffersize,GFP_DMA);
+		if (skb == NULL)
+			return -ENOMEM;
+		dmaaddr = pci_map_single(ring->bcm->pci_dev,
+					 skb->data, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		if (pci_dma_mapping_error(dmaaddr) ||
+		    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+			assert(0);
+			dev_kfree_skb_any(skb);
+			return -ENOMEM;
+		}
+	}
 	meta->skb = skb;
 	meta->dmaaddr = dmaaddr;
 	skb->dev = ring->bcm->net_dev;
@@ -636,8 +693,10 @@ struct bcm43xx_dmaring * bcm43xx_setup_d
 	err = dmacontroller_setup(ring);
 	if (err)
 		goto err_free_ringmemory;
+	return ring;
 
 out:
+	printk(KERN_ERR PFX "Error in bcm43xx_setup_dmaring\n");
 	return ring;
 
 err_free_ringmemory:
@@ -705,30 +764,16 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 	struct bcm43xx_dmaring *ring;
 	int err = -ENOMEM;
 	int dma64 = 0;
-	u64 mask = bcm43xx_get_supported_dma_mask(bcm);
-	int nobits;
 
-	if (mask == DMA_64BIT_MASK) {
+	bcm->dma_mask = bcm43xx_get_supported_dma_mask(bcm);
+	if (bcm->dma_mask == DMA_64BIT_MASK)
 		dma64 = 1;
-		nobits = 64;
-	} else if (mask == DMA_32BIT_MASK)
-		nobits = 32;
-	else
-		nobits = 30;
-	err = pci_set_dma_mask(bcm->pci_dev, mask);
-	err |= pci_set_consistent_dma_mask(bcm->pci_dev, mask);
-	if (err) {
-#ifdef CONFIG_BCM43XX_PIO
-		printk(KERN_WARNING PFX "DMA not supported on this device."
-					" Falling back to PIO.\n");
-		bcm->__using_pio = 1;
-		return -ENOSYS;
-#else
-		printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
-				    "Please recompile the driver with PIO support.\n");
-		return -ENODEV;
-#endif /* CONFIG_BCM43XX_PIO */
-	}
+	err = pci_set_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;
+	err = pci_set_consistent_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;
 
 	/* setup TX DMA channels. */
 	ring = bcm43xx_setup_dmaring(bcm, 0, 1, dma64);
@@ -774,9 +819,12 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 		dma->rx_ring3 = ring;
 	}
 
-	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n", nobits);
+	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n",
+		(bcm->dma_mask == DMA_64BIT_MASK) ? 64 :
+		(bcm->dma_mask == DMA_32BIT_MASK) ? 32 : 30);
 	err = 0;
 out:
+	if(err)BUG();
 	return err;
 
 err_destroy_rx0:
@@ -800,7 +848,18 @@ err_destroy_tx1:
 err_destroy_tx0:
 	bcm43xx_destroy_dmaring(dma->tx_ring0);
 	dma->tx_ring0 = NULL;
-	goto out;
+no_dma:
+#ifdef CONFIG_BCM43XX_PIO
+	printk(KERN_WARNING PFX "DMA not supported on this device."
+				" Falling back to PIO.\n");
+	bcm->__using_pio = 1;
+	BUG();
+	return -ENOSYS;
+#else
+	printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
+			    "Please recompile the driver with PIO support.\n");
+	return -ENODEV;
+#endif /* CONFIG_BCM43XX_PIO */
 }
 
 /* Generate a cookie for the TX header. */
@@ -905,6 +964,7 @@ static void dma_tx_fragment(struct bcm43
 	struct bcm43xx_dmadesc_generic *desc;
 	struct bcm43xx_dmadesc_meta *meta;
 	dma_addr_t dmaaddr;
+	struct sk_buff *bounce_skb;
 
 	assert(skb_shinfo(skb)->nr_frags == 0);
 
@@ -924,9 +984,28 @@ static void dma_tx_fragment(struct bcm43
 			       skb->len - sizeof(struct bcm43xx_txhdr),
 			       (cur_frag == 0),
 			       generate_cookie(ring, slot));
+	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
+	if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+		/* chip cannot handle DMA to/from > 1GB, use bounce buffer (copied from b44 driver) */
+		if (!dma_mapping_error(dmaaddr))
+			unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+		bounce_skb = __dev_alloc_skb(skb->len, GFP_ATOMIC|GFP_DMA);
+		if (!bounce_skb)
+			return;
+		dmaaddr = map_descbuffer(ring, bounce_skb->data, bounce_skb->len, 1);
+		if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+			if (!dma_mapping_error(dmaaddr))
+				unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+			dev_kfree_skb_any(bounce_skb);
+			assert(0);
+			return;
+		}
+		memcpy(skb_put(bounce_skb, skb->len), skb->data, skb->len);
+		dev_kfree_skb_any(skb);
+		skb = bounce_skb;
+	}
 
 	meta->skb = skb;
-	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
 	meta->dmaaddr = dmaaddr;
 
 	fill_descriptor(ring, desc, dmaaddr,
Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -771,6 +771,7 @@ struct bcm43xx_private {
 	 * This is currently always BCM43xx_BUSTYPE_PCI
 	 */
 	u8 bustype;
+	u64 dma_mask;
 
 	u16 board_vendor;
 	u16 board_type;

---


From Larry.Finger at lwfinger.net  Sat Jan 20 20:29:36 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sat, 20 Jan 2007 13:29:36 -0600
Subject: Patches for > 1 GB RAM
Message-ID: <45B26DA0.6000705@lwfinger.net>

Patches to fix the problems associated with having > 1 GB RAM have been posted at
ftp://lwfinger.dynalias.org/patches. There are versions for 2.6.18, 2.6.19, and 2.6.20. I hope that
the fix actually makes it into 2.6.20-rc6, which would make this patch unnecessary, but we'll see
what happens.

Larry


From asil.jinn at gmail.com  Sat Jan 20 21:27:26 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Sat, 20 Jan 2007 21:27:26 +0100
Subject: bcm43xx debugging
Message-ID: <fb1e10a90701201227p70366addk41819907bbcfdb7e@mail.gmail.com>

I was thinking of trying to learn some debugging and contributing. So I
thought I first should start with reading some of the bcm-specs. I have some
knowledge in C programming (still learning ).

Since you guys are experienced patch makers, debuggers of the bcm43xx I was
hoping you could give some good hints, I would appreciate it.

I am interested in checking the power issues of the bcm4311/bcm4312/bcm4318
cards. I do own the bcm4312 and I guess this is always a start.


regards
Yildirim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070120/b4ef05a0/attachment.html>

From larry.finger at lwfinger.net  Sun Jan 21 00:24:30 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 20 Jan 2007 17:24:30 -0600
Subject: bcm43xx debugging
In-Reply-To: <fb1e10a90701201227p70366addk41819907bbcfdb7e@mail.gmail.com>
References: <fb1e10a90701201227p70366addk41819907bbcfdb7e@mail.gmail.com>
Message-ID: <45B2A4AE.5090709@lwfinger.net>

Asil Jinn wrote:
> I was thinking of trying to learn some debugging and contributing. So I
> thought I first should start with reading some of the bcm-specs. I have
> some knowledge in C programming (still learning ).
> 
> Since you guys are experienced patch makers, debuggers of the bcm43xx I
> was hoping you could give some good hints, I would appreciate it.
> 
> I am interested in checking the power issues of the
> bcm4311/bcm4312/bcm4318 cards. I do own the bcm4312 and I guess this is
> always a start.

The first thing is to use git to download the latest copy of wireless-2.6. Next go to the
Documentation directory and read CodingStyle, SubmittingPatches, and anything else that catches your
eye. Then you can start reading the code and figuring out how the various pieces work. I would also
learn how to use quilt for handling your patches.

The power issues are the main problem remaining, and I wish you luck with them. You will need to
compare the code with the V3 specifications at http://bcm-specs.sipsolutions.net, which are our
master document. Be aware that some of the specs are vastly different than what they were when the
original driver was written. Before you do a lot of work on anything not meeting those specs, check
with me. I have patches that update almost all the lo (local oscillator) stuff to match the new
specs. These are the softmac equivalent of the things Michael is developing for d80211.

Good luck,

Larry




From Larry.Finger at lwfinger.net  Mon Jan 22 05:27:35 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 21 Jan 2007 22:27:35 -0600
Subject: [PATCH V2] bcm43xx: Fix problem with >1 GB RAM
Message-ID: <45b43d37.gvStpHbmNO0lQLad%Larry.Finger@lwfinger.net>

Some versions of the bcm43xx chips only support 30-bit DMA, which means
that the descriptors and buffers must be in the first 1 GB of RAM. On
the i386 and x86_64 architectures with more than 1 GB RAM, an incorrect
assignment may occur. This patch ensures that the various DMA addresses
are within the capability of the chip. Testing has been limited to x86_64
as no one has an i386 system with more than 1 GB RAM.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This patch should be applied to wireless-2.6 and pushed up to 2.6.20.
V2 removes a couple of BUG statements that were used for debugging, and
accidentally left in.

Thanks,

Larry

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
@@ -145,16 +145,14 @@ dma_addr_t map_descbuffer(struct bcm43xx
 			  int tx)
 {
 	dma_addr_t dmaaddr;
+	int direction = PCI_DMA_FROMDEVICE;
 
-	if (tx) {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
-					 buf, len,
-					 DMA_TO_DEVICE);
-	} else {
-		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
+	if (tx)
+		direction = PCI_DMA_TODEVICE;
+
+	dmaaddr = pci_map_single(ring->bcm->pci_dev,
 					 buf, len,
-					 DMA_FROM_DEVICE);
-	}
+					 direction);
 
 	return dmaaddr;
 }
@@ -166,13 +164,13 @@ void unmap_descbuffer(struct bcm43xx_dma
 		      int tx)
 {
 	if (tx) {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_TO_DEVICE);
+				 PCI_DMA_TODEVICE);
 	} else {
-		dma_unmap_single(&ring->bcm->pci_dev->dev,
+		pci_unmap_single(ring->bcm->pci_dev,
 				 addr, len,
-				 DMA_FROM_DEVICE);
+				 PCI_DMA_FROMDEVICE);
 	}
 }
 
@@ -183,8 +181,8 @@ void sync_descbuffer_for_cpu(struct bcm4
 {
 	assert(!ring->tx);
 
-	dma_sync_single_for_cpu(&ring->bcm->pci_dev->dev,
-				addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_FROMDEVICE);
 }
 
 static inline
@@ -194,8 +192,8 @@ void sync_descbuffer_for_device(struct b
 {
 	assert(!ring->tx);
 
-	dma_sync_single_for_device(&ring->bcm->pci_dev->dev,
-				   addr, len, DMA_FROM_DEVICE);
+	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
+				    addr, len, PCI_DMA_TODEVICE);
 }
 
 /* Unmap and free a descriptor buffer. */
@@ -214,17 +212,53 @@ void free_descriptor_buffer(struct bcm43
 
 static int alloc_ringmemory(struct bcm43xx_dmaring *ring)
 {
-	struct device *dev = &(ring->bcm->pci_dev->dev);
-
-	ring->descbase = dma_alloc_coherent(dev, BCM43xx_DMA_RINGMEMSIZE,
-					    &(ring->dmabase), GFP_KERNEL);
+	ring->descbase = pci_alloc_consistent(ring->bcm->pci_dev, BCM43xx_DMA_RINGMEMSIZE,
+					    &(ring->dmabase));
 	if (!ring->descbase) {
-		printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
-		return -ENOMEM;
+		/* Allocation may have failed due to pci_alloc_consistent
+		   insisting on use of GFP_DMA, which is more restrictive
+		   than necessary...  */
+		struct dma_desc *rx_ring;
+		dma_addr_t rx_ring_dma;
+
+		rx_ring = kzalloc(BCM43xx_DMA_RINGMEMSIZE, GFP_KERNEL);
+		if (!rx_ring)
+			goto out_err;
+
+		rx_ring_dma = pci_map_single(ring->bcm->pci_dev, rx_ring,
+					     BCM43xx_DMA_RINGMEMSIZE,
+					     PCI_DMA_BIDIRECTIONAL);
+
+		if (pci_dma_mapping_error(rx_ring_dma) ||
+		    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+			/* Sigh... */
+			if (!pci_dma_mapping_error(rx_ring_dma))
+				pci_unmap_single(ring->bcm->pci_dev,
+						 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			rx_ring_dma = pci_map_single(ring->bcm->pci_dev,
+						 rx_ring, BCM43xx_DMA_RINGMEMSIZE,
+						 PCI_DMA_BIDIRECTIONAL);
+			if (pci_dma_mapping_error(rx_ring_dma) ||
+			    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
+				assert(0);
+				if (!pci_dma_mapping_error(rx_ring_dma))
+					pci_unmap_single(ring->bcm->pci_dev,
+							 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
+							 PCI_DMA_BIDIRECTIONAL);
+                        	goto out_err;
+			}
+                }
+
+                ring->descbase = rx_ring;
+                ring->dmabase = rx_ring_dma;
 	}
 	memset(ring->descbase, 0, BCM43xx_DMA_RINGMEMSIZE);
 
 	return 0;
+out_err:
+	printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
+	return -ENOMEM;
 }
 
 static void free_ringmemory(struct bcm43xx_dmaring *ring)
@@ -407,6 +441,29 @@ static int setup_rx_descbuffer(struct bc
 	if (unlikely(!skb))
 		return -ENOMEM;
 	dmaaddr = map_descbuffer(ring, skb->data, ring->rx_buffersize, 0);
+	/* This hardware bug work-around adapted from the b44 driver.
+	   The chip may be unable to do PCI DMA to/from anything above 1GB */
+	if (pci_dma_mapping_error(dmaaddr) ||
+	    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+		/* This one has 30-bit addressing... */
+		if (!pci_dma_mapping_error(dmaaddr))
+			pci_unmap_single(ring->bcm->pci_dev,
+					 dmaaddr, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		dev_kfree_skb_any(skb);
+		skb = __dev_alloc_skb(ring->rx_buffersize,GFP_DMA);
+		if (skb == NULL)
+			return -ENOMEM;
+		dmaaddr = pci_map_single(ring->bcm->pci_dev,
+					 skb->data, ring->rx_buffersize,
+					 PCI_DMA_FROMDEVICE);
+		if (pci_dma_mapping_error(dmaaddr) ||
+		    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
+			assert(0);
+			dev_kfree_skb_any(skb);
+			return -ENOMEM;
+		}
+	}
 	meta->skb = skb;
 	meta->dmaaddr = dmaaddr;
 	skb->dev = ring->bcm->net_dev;
@@ -636,8 +693,10 @@ struct bcm43xx_dmaring * bcm43xx_setup_d
 	err = dmacontroller_setup(ring);
 	if (err)
 		goto err_free_ringmemory;
+	return ring;
 
 out:
+	printk(KERN_ERR PFX "Error in bcm43xx_setup_dmaring\n");
 	return ring;
 
 err_free_ringmemory:
@@ -705,30 +764,16 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 	struct bcm43xx_dmaring *ring;
 	int err = -ENOMEM;
 	int dma64 = 0;
-	u64 mask = bcm43xx_get_supported_dma_mask(bcm);
-	int nobits;
 
-	if (mask == DMA_64BIT_MASK) {
+	bcm->dma_mask = bcm43xx_get_supported_dma_mask(bcm);
+	if (bcm->dma_mask == DMA_64BIT_MASK)
 		dma64 = 1;
-		nobits = 64;
-	} else if (mask == DMA_32BIT_MASK)
-		nobits = 32;
-	else
-		nobits = 30;
-	err = pci_set_dma_mask(bcm->pci_dev, mask);
-	err |= pci_set_consistent_dma_mask(bcm->pci_dev, mask);
-	if (err) {
-#ifdef CONFIG_BCM43XX_PIO
-		printk(KERN_WARNING PFX "DMA not supported on this device."
-					" Falling back to PIO.\n");
-		bcm->__using_pio = 1;
-		return -ENOSYS;
-#else
-		printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
-				    "Please recompile the driver with PIO support.\n");
-		return -ENODEV;
-#endif /* CONFIG_BCM43XX_PIO */
-	}
+	err = pci_set_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;
+	err = pci_set_consistent_dma_mask(bcm->pci_dev, bcm->dma_mask);
+	if (err)
+		goto no_dma;
 
 	/* setup TX DMA channels. */
 	ring = bcm43xx_setup_dmaring(bcm, 0, 1, dma64);
@@ -774,7 +819,9 @@ int bcm43xx_dma_init(struct bcm43xx_priv
 		dma->rx_ring3 = ring;
 	}
 
-	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n", nobits);
+	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n",
+		(bcm->dma_mask == DMA_64BIT_MASK) ? 64 :
+		(bcm->dma_mask == DMA_32BIT_MASK) ? 32 : 30);
 	err = 0;
 out:
 	return err;
@@ -800,7 +847,17 @@ err_destroy_tx1:
 err_destroy_tx0:
 	bcm43xx_destroy_dmaring(dma->tx_ring0);
 	dma->tx_ring0 = NULL;
-	goto out;
+no_dma:
+#ifdef CONFIG_BCM43XX_PIO
+	printk(KERN_WARNING PFX "DMA not supported on this device."
+				" Falling back to PIO.\n");
+	bcm->__using_pio = 1;
+	return -ENOSYS;
+#else
+	printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
+			    "Please recompile the driver with PIO support.\n");
+	return -ENODEV;
+#endif /* CONFIG_BCM43XX_PIO */
 }
 
 /* Generate a cookie for the TX header. */
@@ -905,6 +962,7 @@ static void dma_tx_fragment(struct bcm43
 	struct bcm43xx_dmadesc_generic *desc;
 	struct bcm43xx_dmadesc_meta *meta;
 	dma_addr_t dmaaddr;
+	struct sk_buff *bounce_skb;
 
 	assert(skb_shinfo(skb)->nr_frags == 0);
 
@@ -924,9 +982,28 @@ static void dma_tx_fragment(struct bcm43
 			       skb->len - sizeof(struct bcm43xx_txhdr),
 			       (cur_frag == 0),
 			       generate_cookie(ring, slot));
+	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
+	if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+		/* chip cannot handle DMA to/from > 1GB, use bounce buffer (copied from b44 driver) */
+		if (!dma_mapping_error(dmaaddr))
+			unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+		bounce_skb = __dev_alloc_skb(skb->len, GFP_ATOMIC|GFP_DMA);
+		if (!bounce_skb)
+			return;
+		dmaaddr = map_descbuffer(ring, bounce_skb->data, bounce_skb->len, 1);
+		if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
+			if (!dma_mapping_error(dmaaddr))
+				unmap_descbuffer(ring, dmaaddr, skb->len, 1);
+			dev_kfree_skb_any(bounce_skb);
+			assert(0);
+			return;
+		}
+		memcpy(skb_put(bounce_skb, skb->len), skb->data, skb->len);
+		dev_kfree_skb_any(skb);
+		skb = bounce_skb;
+	}
 
 	meta->skb = skb;
-	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
 	meta->dmaaddr = dmaaddr;
 
 	fill_descriptor(ring, desc, dmaaddr,
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
@@ -771,6 +771,7 @@ struct bcm43xx_private {
 	 * This is currently always BCM43xx_BUSTYPE_PCI
 	 */
 	u8 bustype;
+	u64 dma_mask;
 
 	u16 board_vendor;
 	u16 board_type;


From mb at bu3sch.de  Mon Jan 22 19:11:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Jan 2007 19:11:20 +0100
Subject: [PATCH] bcm43xx: Check error returns in initialization routines
In-Reply-To: <45b043e3.NGzJyc7WBaqk9U0D%Larry.Finger@lwfinger.net>
References: <45b043e3.NGzJyc7WBaqk9U0D%Larry.Finger@lwfinger.net>
Message-ID: <200701221911.20544.mb@bu3sch.de>

On Friday 19 January 2007 05:06, Larry Finger wrote:
> A number of the calls in the initialization routines fail to check the returned value for
> errors. This patch adds the necessary checks and logs any errors found when appropriate.

ACK

> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> To be applied to wireless-2.6.
> 
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -2980,8 +2980,10 @@ static int bcm43xx_chipset_attach(struct
>  	err = bcm43xx_pctl_set_crystal(bcm, 1);
>  	if (err)
>  		goto out;
> -	bcm43xx_pci_read_config16(bcm, PCI_STATUS, &pci_status);
> -	bcm43xx_pci_write_config16(bcm, PCI_STATUS, pci_status & ~PCI_STATUS_SIG_TARGET_ABORT);
> +	err = bcm43xx_pci_read_config16(bcm, PCI_STATUS, &pci_status);
> +	if (err)
> +		goto out;
> +	err = bcm43xx_pci_write_config16(bcm, PCI_STATUS, pci_status & ~PCI_STATUS_SIG_TARGET_ABORT);
>  
>  out:
>  	return err;
> @@ -3793,12 +3795,18 @@ static int bcm43xx_attach_board(struct b
>  	}
>  	net_dev->base_addr = (unsigned long)bcm->mmio_addr;
>  
> -	bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_VENDOR_ID,
> +	err = bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_VENDOR_ID,
>  	                          &bcm->board_vendor);
> -	bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_ID,
> +	if (err)
> +		goto err_iounmap;
> +	err = bcm43xx_pci_read_config16(bcm, PCI_SUBSYSTEM_ID,
>  	                          &bcm->board_type);
> -	bcm43xx_pci_read_config16(bcm, PCI_REVISION_ID,
> +	if (err)
> +		goto err_iounmap;
> +	err = bcm43xx_pci_read_config16(bcm, PCI_REVISION_ID,
>  	                          &bcm->board_revision);
> +	if (err)
> +		goto err_iounmap;
>  
>  	err = bcm43xx_chipset_attach(bcm);
>  	if (err)
> @@ -3889,6 +3897,7 @@ err_pci_release:
>  	pci_release_regions(pci_dev);
>  err_pci_disable:
>  	pci_disable_device(pci_dev);
> +	printk(KERN_ERR PFX "Unable to attach board\n");
>  	goto out;
>  }
> 
> --- 
> 
> 

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Jan 22 19:20:28 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Jan 2007 19:20:28 +0100
Subject: [PATCH] bcm43xx: Fix problem with >1 GB RAM
In-Reply-To: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>
References: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>
Message-ID: <200701221920.28938.mb@bu3sch.de>

On Saturday 20 January 2007 17:18, Larry Finger wrote:
> Some versions of the bcm43xx chips only support 30-bit DMA, which means
> that the descriptors and buffers must be in the first 1 GB of RAM. On
> the i386 and x86_64 architectures with more than 1 GB RAM, an incorrect
> assignment may occur. This patch ensures that the various DMA addresses
> are within the capability of the chip. Testing has been limited to x86_64
> as no one has an i386 system with more than 1 GB RAM.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This patch should be applied to wireless-2.6 and pushed up to 2.6.20.
> 
> Thanks,
> 
> Larry
> 
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx_dma.c
> @@ -145,16 +145,14 @@ dma_addr_t map_descbuffer(struct bcm43xx
>  			  int tx)
>  {
>  	dma_addr_t dmaaddr;
> +	int direction = PCI_DMA_FROMDEVICE;
>  
> -	if (tx) {
> -		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
> -					 buf, len,
> -					 DMA_TO_DEVICE);
> -	} else {
> -		dmaaddr = dma_map_single(&ring->bcm->pci_dev->dev,
> +	if (tx)
> +		direction = PCI_DMA_TODEVICE;
> +
> +	dmaaddr = pci_map_single(ring->bcm->pci_dev,
>  					 buf, len,
> -					 DMA_FROM_DEVICE);
> -	}
> +					 direction);
>  
>  	return dmaaddr;
>  }
> @@ -166,13 +164,13 @@ void unmap_descbuffer(struct bcm43xx_dma
>  		      int tx)
>  {
>  	if (tx) {
> -		dma_unmap_single(&ring->bcm->pci_dev->dev,
> +		pci_unmap_single(ring->bcm->pci_dev,
>  				 addr, len,
> -				 DMA_TO_DEVICE);
> +				 PCI_DMA_TODEVICE);
>  	} else {
> -		dma_unmap_single(&ring->bcm->pci_dev->dev,
> +		pci_unmap_single(ring->bcm->pci_dev,
>  				 addr, len,
> -				 DMA_FROM_DEVICE);
> +				 PCI_DMA_FROMDEVICE);
>  	}
>  }
>  
> @@ -183,8 +181,8 @@ void sync_descbuffer_for_cpu(struct bcm4
>  {
>  	assert(!ring->tx);
>  
> -	dma_sync_single_for_cpu(&ring->bcm->pci_dev->dev,
> -				addr, len, DMA_FROM_DEVICE);
> +	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
> +				    addr, len, PCI_DMA_FROMDEVICE);
>  }

Any special reason why you convert the DMA operations to the PCI
stuff? I ask, because if this makes a difference, it affects the
new SSB subsystem as well.

>  static inline
> @@ -194,8 +192,8 @@ void sync_descbuffer_for_device(struct b
>  {
>  	assert(!ring->tx);
>  
> -	dma_sync_single_for_device(&ring->bcm->pci_dev->dev,
> -				   addr, len, DMA_FROM_DEVICE);
> +	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
> +				    addr, len, PCI_DMA_TODEVICE);
>  }
>  
>  /* Unmap and free a descriptor buffer. */
> @@ -214,17 +212,53 @@ void free_descriptor_buffer(struct bcm43
>  
>  static int alloc_ringmemory(struct bcm43xx_dmaring *ring)
>  {
> -	struct device *dev = &(ring->bcm->pci_dev->dev);
> -
> -	ring->descbase = dma_alloc_coherent(dev, BCM43xx_DMA_RINGMEMSIZE,
> -					    &(ring->dmabase), GFP_KERNEL);
> +	ring->descbase = pci_alloc_consistent(ring->bcm->pci_dev, BCM43xx_DMA_RINGMEMSIZE,
> +					    &(ring->dmabase));
>  	if (!ring->descbase) {
> -		printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
> -		return -ENOMEM;
> +		/* Allocation may have failed due to pci_alloc_consistent
> +		   insisting on use of GFP_DMA, which is more restrictive
> +		   than necessary...  */
> +		struct dma_desc *rx_ring;
> +		dma_addr_t rx_ring_dma;
> +
> +		rx_ring = kzalloc(BCM43xx_DMA_RINGMEMSIZE, GFP_KERNEL);
> +		if (!rx_ring)
> +			goto out_err;
> +
> +		rx_ring_dma = pci_map_single(ring->bcm->pci_dev, rx_ring,
> +					     BCM43xx_DMA_RINGMEMSIZE,
> +					     PCI_DMA_BIDIRECTIONAL);
> +
> +		if (pci_dma_mapping_error(rx_ring_dma) ||
> +		    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
> +			/* Sigh... */
> +			if (!pci_dma_mapping_error(rx_ring_dma))
> +				pci_unmap_single(ring->bcm->pci_dev,
> +						 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
> +						 PCI_DMA_BIDIRECTIONAL);
> +			rx_ring_dma = pci_map_single(ring->bcm->pci_dev,
> +						 rx_ring, BCM43xx_DMA_RINGMEMSIZE,
> +						 PCI_DMA_BIDIRECTIONAL);
> +			if (pci_dma_mapping_error(rx_ring_dma) ||
> +			    rx_ring_dma + BCM43xx_DMA_RINGMEMSIZE > ring->bcm->dma_mask) {
> +				assert(0);
> +				if (!pci_dma_mapping_error(rx_ring_dma))
> +					pci_unmap_single(ring->bcm->pci_dev,
> +							 rx_ring_dma, BCM43xx_DMA_RINGMEMSIZE,
> +							 PCI_DMA_BIDIRECTIONAL);
> +                        	goto out_err;
> +			}
> +                }
> +
> +                ring->descbase = rx_ring;
> +                ring->dmabase = rx_ring_dma;
>  	}
>  	memset(ring->descbase, 0, BCM43xx_DMA_RINGMEMSIZE);
>  
>  	return 0;
> +out_err:
> +	printk(KERN_ERR PFX "DMA ringmemory allocation failed\n");
> +	return -ENOMEM;
>  }
>  
>  static void free_ringmemory(struct bcm43xx_dmaring *ring)
> @@ -407,6 +441,29 @@ static int setup_rx_descbuffer(struct bc
>  	if (unlikely(!skb))
>  		return -ENOMEM;
>  	dmaaddr = map_descbuffer(ring, skb->data, ring->rx_buffersize, 0);
> +	/* This hardware bug work-around adapted from the b44 driver.
> +	   The chip may be unable to do PCI DMA to/from anything above 1GB */
> +	if (pci_dma_mapping_error(dmaaddr) ||
> +	    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
> +		/* This one has 30-bit addressing... */
> +		if (!pci_dma_mapping_error(dmaaddr))
> +			pci_unmap_single(ring->bcm->pci_dev,
> +					 dmaaddr, ring->rx_buffersize,
> +					 PCI_DMA_FROMDEVICE);
> +		dev_kfree_skb_any(skb);
> +		skb = __dev_alloc_skb(ring->rx_buffersize,GFP_DMA);
> +		if (skb == NULL)
> +			return -ENOMEM;
> +		dmaaddr = pci_map_single(ring->bcm->pci_dev,
> +					 skb->data, ring->rx_buffersize,
> +					 PCI_DMA_FROMDEVICE);
> +		if (pci_dma_mapping_error(dmaaddr) ||
> +		    dmaaddr + ring->rx_buffersize > ring->bcm->dma_mask) {
> +			assert(0);
> +			dev_kfree_skb_any(skb);
> +			return -ENOMEM;
> +		}
> +	}
>  	meta->skb = skb;
>  	meta->dmaaddr = dmaaddr;
>  	skb->dev = ring->bcm->net_dev;
> @@ -636,8 +693,10 @@ struct bcm43xx_dmaring * bcm43xx_setup_d
>  	err = dmacontroller_setup(ring);
>  	if (err)
>  		goto err_free_ringmemory;
> +	return ring;
>  
>  out:
> +	printk(KERN_ERR PFX "Error in bcm43xx_setup_dmaring\n");
>  	return ring;
>  
>  err_free_ringmemory:
> @@ -705,30 +764,16 @@ int bcm43xx_dma_init(struct bcm43xx_priv
>  	struct bcm43xx_dmaring *ring;
>  	int err = -ENOMEM;
>  	int dma64 = 0;
> -	u64 mask = bcm43xx_get_supported_dma_mask(bcm);
> -	int nobits;
>  
> -	if (mask == DMA_64BIT_MASK) {
> +	bcm->dma_mask = bcm43xx_get_supported_dma_mask(bcm);
> +	if (bcm->dma_mask == DMA_64BIT_MASK)
>  		dma64 = 1;
> -		nobits = 64;
> -	} else if (mask == DMA_32BIT_MASK)
> -		nobits = 32;
> -	else
> -		nobits = 30;
> -	err = pci_set_dma_mask(bcm->pci_dev, mask);
> -	err |= pci_set_consistent_dma_mask(bcm->pci_dev, mask);
> -	if (err) {
> -#ifdef CONFIG_BCM43XX_PIO
> -		printk(KERN_WARNING PFX "DMA not supported on this device."
> -					" Falling back to PIO.\n");
> -		bcm->__using_pio = 1;
> -		return -ENOSYS;
> -#else
> -		printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
> -				    "Please recompile the driver with PIO support.\n");
> -		return -ENODEV;
> -#endif /* CONFIG_BCM43XX_PIO */
> -	}
> +	err = pci_set_dma_mask(bcm->pci_dev, bcm->dma_mask);
> +	if (err)
> +		goto no_dma;
> +	err = pci_set_consistent_dma_mask(bcm->pci_dev, bcm->dma_mask);
> +	if (err)
> +		goto no_dma;
>  
>  	/* setup TX DMA channels. */
>  	ring = bcm43xx_setup_dmaring(bcm, 0, 1, dma64);
> @@ -774,9 +819,12 @@ int bcm43xx_dma_init(struct bcm43xx_priv
>  		dma->rx_ring3 = ring;
>  	}
>  
> -	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n", nobits);
> +	dprintk(KERN_INFO PFX "%d-bit DMA initialized\n",
> +		(bcm->dma_mask == DMA_64BIT_MASK) ? 64 :
> +		(bcm->dma_mask == DMA_32BIT_MASK) ? 32 : 30);
>  	err = 0;
>  out:
> +	if(err)BUG();
>  	return err;
>  
>  err_destroy_rx0:
> @@ -800,7 +848,18 @@ err_destroy_tx1:
>  err_destroy_tx0:
>  	bcm43xx_destroy_dmaring(dma->tx_ring0);
>  	dma->tx_ring0 = NULL;
> -	goto out;
> +no_dma:
> +#ifdef CONFIG_BCM43XX_PIO
> +	printk(KERN_WARNING PFX "DMA not supported on this device."
> +				" Falling back to PIO.\n");
> +	bcm->__using_pio = 1;
> +	BUG();

That isn't a BUG. Just remove this call, please.

> +	return -ENOSYS;
> +#else
> +	printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
> +			    "Please recompile the driver with PIO support.\n");
> +	return -ENODEV;
> +#endif /* CONFIG_BCM43XX_PIO */
>  }
>  
>  /* Generate a cookie for the TX header. */
> @@ -905,6 +964,7 @@ static void dma_tx_fragment(struct bcm43
>  	struct bcm43xx_dmadesc_generic *desc;
>  	struct bcm43xx_dmadesc_meta *meta;
>  	dma_addr_t dmaaddr;
> +	struct sk_buff *bounce_skb;
>  
>  	assert(skb_shinfo(skb)->nr_frags == 0);
>  
> @@ -924,9 +984,28 @@ static void dma_tx_fragment(struct bcm43
>  			       skb->len - sizeof(struct bcm43xx_txhdr),
>  			       (cur_frag == 0),
>  			       generate_cookie(ring, slot));
> +	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
> +	if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
> +		/* chip cannot handle DMA to/from > 1GB, use bounce buffer (copied from b44 driver) */
> +		if (!dma_mapping_error(dmaaddr))
> +			unmap_descbuffer(ring, dmaaddr, skb->len, 1);
> +		bounce_skb = __dev_alloc_skb(skb->len, GFP_ATOMIC|GFP_DMA);
> +		if (!bounce_skb)
> +			return;
> +		dmaaddr = map_descbuffer(ring, bounce_skb->data, bounce_skb->len, 1);
> +		if (dma_mapping_error(dmaaddr) || dmaaddr + skb->len > ring->bcm->dma_mask) {
> +			if (!dma_mapping_error(dmaaddr))
> +				unmap_descbuffer(ring, dmaaddr, skb->len, 1);
> +			dev_kfree_skb_any(bounce_skb);
> +			assert(0);
> +			return;
> +		}
> +		memcpy(skb_put(bounce_skb, skb->len), skb->data, skb->len);
> +		dev_kfree_skb_any(skb);
> +		skb = bounce_skb;
> +	}
>  
>  	meta->skb = skb;
> -	dmaaddr = map_descbuffer(ring, skb->data, skb->len, 1);
>  	meta->dmaaddr = dmaaddr;
>  
>  	fill_descriptor(ring, desc, dmaaddr,
> Index: linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> ===================================================================
> --- linux-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx.h
> +++ linux-2.6/drivers/net/wireless/bcm43xx/bcm43xx.h
> @@ -771,6 +771,7 @@ struct bcm43xx_private {
>  	 * This is currently always BCM43xx_BUSTYPE_PCI
>  	 */
>  	u8 bustype;
> +	u64 dma_mask;
>  
>  	u16 board_vendor;
>  	u16 board_type;

The rest is OK, I think.
Thanks for the nice work.

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Jan 22 21:06:24 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Jan 2007 21:06:24 +0100
Subject: Can someone please try...
In-Reply-To: <1169193247.9908.34.camel@dv>
References: <200701161806.02780.mb@bu3sch.de> <1169113274.10770.18.camel@dv>
	<1169193247.9908.34.camel@dv>
Message-ID: <200701222106.24329.mb@bu3sch.de>

On Friday 19 January 2007 08:54, Pavel Roskin wrote:
> Hello, Michael!
> 
> I did more testing, and the results are following.  It looks like the
> oopses and panics on i386 were triggered by 4k stacks.  x86_64 doesn't
> have this option.
> 
> Now that I enabled other debug options on both platforms. but not 4k
> stacks, I'm seeing exactly the same problem on each platform.  When run
> initially, wpa_supplicant connects with no problems (except very poor
> reception of the data packets, but it's another story).  If interrupted
> and restarted, wpa_supplicant reconnects, but I'm getting messages like
> this (i386):

That's a very interresting discover.
Partly, because I don't see this on my i386 machine. ;)

It's obviously some stack/memory corruption. But I'm not
sure if this is a stackoverflow. I'd rather say no, it isn't.

Could probably be triggered by something like kfree()ing
a dangling pointer or something...

> Slab corruption: start=cfdaece0, len=1024
> Redzone: 0x5a2cf071/0x5a2cf071.
> Last user: [<c02d70c2>](skb_release_data+0x7b/0x7f)
> 000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> Prev obj: start=cfdae8d4, len=1024
> Redzone: 0x170fc2a5/0x170fc2a5.
> Last user: [<c026ea5a>](device_create+0x2c/0x98)
> 000: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 010: ad 4e ad de ff ff ff ff ff ff ff ff 10 3a 6d c0
> Next obj: start=cfdaf0ec, len=1024
> Redzone: 0x170fc2a5/0x170fc2a5.
> Last user: [<c0165730>](expand_files+0x95/0x2c2)
> 000: 78 55 39 c7 78 55 39 c7 78 55 39 c7 88 da 52 df
> 010: d8 18 3b c7 00 00 00 00 00 00 00 00 00 00 00 00
> 
> and this (x86_64):
> 
> Slab corruption: start=ffff81000ec8a198, len=1024
> Redzone: 0x5a2cf071/0x5a2cf071.
> Last user: [<ffffffff8042e916>](skb_release_data+0x94/0x99)
> 000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> Next obj: start=ffff81000ec8a5b0, len=1024
> Redzone: 0x170fc2a5/0x170fc2a5.
> Last user: [<ffffffff803be6e9>](device_create+0x5f/0x110)
> 000: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
> 
> I can restart wpa_supplicant again, and it would show similar messages.
> The first "Last user" is inevitably skb_release_data.
> 
> I have no idea how to deal with it.  I think I need a stack trace at the
> time when skb_release_data is called.
> 
> This is a stack trace at the time when slab corruption is detected.
> It's actually incorrect closer to the top, perhaps from gcc
> optimizations for static functions.
> 
> Slab corruption: start=ffff8100066f81d8, len=1024
> 
> Call Trace:
>  [<ffffffff80218636>] vsnprintf+0x338/0x5a8
>  [<ffffffff8020713d>] check_poison_obj+0x69/0x1ae
>  [<ffffffff803c3ff2>] _request_firmware+0x8f/0x326
>  [<ffffffff803c3ff2>] _request_firmware+0x8f/0x326
> 
> 
>  [<ffffffff8020c09a>] cache_alloc_debugcheck_after+0x32/0x1a2
>  [<ffffffff803c3ff2>] _request_firmware+0x8f/0x326
>  [<ffffffff802aaae2>] kmem_cache_zalloc+0xaf/0xd8
>  [<ffffffff803c3ff2>] _request_firmware+0x8f/0x326
>  [<ffffffff880111ea>] :bcm43xx_d80211:bcm43xx_phy_init_tssi2dbm_table
> +0xf0/0x2ca
>  [<ffffffff803c432a>] request_firmware+0xe/0x10
>  [<ffffffff88007d75>] :bcm43xx_d80211:bcm43xx_chip_init+0x96/0xaba
>  [<ffffffff8020a03d>] kmem_cache_alloc+0xaf/0xbe
>  [<ffffffff88009c97>] :bcm43xx_d80211:bcm43xx_wireless_core_init
> +0x4de/0xa3d
>  [<ffffffff8800b4e8>] :bcm43xx_d80211:bcm43xx_add_interface+0x64/0xde
>  [<ffffffff8046eaa0>] ieee80211_open+0x1c7/0x2cc
>  [<ffffffff804330da>] dev_open+0x36/0x76
>  [<ffffffff8043185b>] dev_change_flags+0x5d/0x122
>  [<ffffffff8045a1a3>] devinet_ioctl+0x259/0x5e8
>  [<ffffffff8045a7f2>] inet_ioctl+0x71/0x8f
>  [<ffffffff8042a395>] sock_ioctl+0x1db/0x1fd
>  [<ffffffff8023bfa7>] do_ioctl+0x1b/0x50
>  [<ffffffff8022c9b2>] vfs_ioctl+0x22a/0x23c
>  [<ffffffff80289975>] trace_hardirqs_on+0x124/0x14e
>  [<ffffffff802459a2>] sys_ioctl+0x42/0x65
>  [<ffffffff8025531e>] system_call+0x7e/0x83
> 
> Anyway, I could narrow down this message to the first kzalloc() call in
> fw_register_device(), file drivers/base/firmware_class.c.  This only
> seems to confirm my suspicion that the actual corruption happened before
> this point.  We are just hitting it when trying to allocate more memory.
> 
> Help with debugging this problem will be appreciated.  I've never hunted
> down such problems, especially in kernel space.
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Jan 22 21:18:57 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 22 Jan 2007 14:18:57 -0600
Subject: [PATCH] bcm43xx: Fix problem with >1 GB RAM
In-Reply-To: <200701221920.28938.mb@bu3sch.de>
References: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>
	<200701221920.28938.mb@bu3sch.de>
Message-ID: <45B51C31.10000@lwfinger.net>

Michael Buesch wrote:
> On Saturday 20 January 2007 17:18, Larry Finger wrote:
>> Some versions of the bcm43xx chips only support 30-bit DMA, which means
>> that the descriptors and buffers must be in the first 1 GB of RAM. On
>> the i386 and x86_64 architectures with more than 1 GB RAM, an incorrect
>> assignment may occur. This patch ensures that the various DMA addresses
>> are within the capability of the chip. Testing has been limited to x86_64
>> as no one has an i386 system with more than 1 GB RAM.
>>
>> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
>> ---

..snip..

>>  	assert(!ring->tx);
>>  
>> -	dma_sync_single_for_cpu(&ring->bcm->pci_dev->dev,
>> -				addr, len, DMA_FROM_DEVICE);
>> +	pci_dma_sync_single_for_cpu(ring->bcm->pci_dev,
>> +				    addr, len, PCI_DMA_FROMDEVICE);
>>  }
> 
> Any special reason why you convert the DMA operations to the PCI
> stuff? I ask, because if this makes a difference, it affects the
> new SSB subsystem as well.

When I looked at the b44 driver to see how that code handled the problem, it used the pci-form of
the calls rather than the dma-version. Thus I switched early in the debug process - even before I
had the necessary hardware. Once I got it working and understood the problem, I never tried
restoring the dma-forms.

At present, I have a problem getting NetworkManager to see the d80211 wireless interface. Once I get
that solved, I plan to use my system to test with > 1 GB RAM on your git tree. In that case, I'll
switch to the pci-form only if necessary.

> 
>>  static inline
>> @@ -194,8 +192,8 @@ void sync_descbuffer_for_device(struct b

..snip..

>> -	goto out;
>> +no_dma:
>> +#ifdef CONFIG_BCM43XX_PIO
>> +	printk(KERN_WARNING PFX "DMA not supported on this device."
>> +				" Falling back to PIO.\n");
>> +	bcm->__using_pio = 1;
>> +	BUG();
> 
> That isn't a BUG. Just remove this call, please.

It was accidentally left in from my debugging. I have already submitted a revised version to
Linville that removes this, and one other BUG statement that you didn't note.


>> +	return -ENOSYS;
>> +#else
>> +	printk(KERN_ERR PFX "FATAL: DMA not supported and PIO not configured. "
>> +			    "Please recompile the driver with PIO support.\n");
>> +	return -ENODEV;
>> +#endif /* CONFIG_BCM43XX_PIO */
>>  }

..snip..

>>  	u16 board_vendor;
>>  	u16 board_type;
> 
> The rest is OK, I think.
> Thanks for the nice work.

Thank you. It certainly was a lot easier with the necessary hardware in house.

Larry



From mb at bu3sch.de  Mon Jan 22 21:35:59 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Jan 2007 21:35:59 +0100
Subject: [PATCH] bcm43xx: Fix problem with >1 GB RAM
In-Reply-To: <45B51C31.10000@lwfinger.net>
References: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>
	<200701221920.28938.mb@bu3sch.de> <45B51C31.10000@lwfinger.net>
Message-ID: <200701222135.59314.mb@bu3sch.de>

On Monday 22 January 2007 21:18, Larry Finger wrote:
> When I looked at the b44 driver to see how that code handled the problem, it used the pci-form of
> the calls rather than the dma-version. Thus I switched early in the debug process - even before I
> had the necessary hardware. Once I got it working and understood the problem, I never tried
> restoring the dma-forms.

Ok, I see. I'm OK with that.

> > That isn't a BUG. Just remove this call, please.
> 
> It was accidentally left in from my debugging. I have already submitted a revised version to
> Linville that removes this, and one other BUG statement that you didn't note.

Yeah, saw it too late. That patch is ACKed then by me.

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Jan 22 22:00:19 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 22 Jan 2007 22:00:19 +0100
Subject: Can someone please try...
In-Reply-To: <1169498676.4453.14.camel@dv>
References: <200701161806.02780.mb@bu3sch.de>
	<200701222106.24329.mb@bu3sch.de> <1169498676.4453.14.camel@dv>
Message-ID: <200701222200.19784.mb@bu3sch.de>

On Monday 22 January 2007 21:44, Pavel Roskin wrote:
> Hello, Michael!
> 
> On Mon, 2007-01-22 at 21:06 +0100, Michael Buesch wrote: 
> > It's obviously some stack/memory corruption. But I'm not
> > sure if this is a stackoverflow. I'd rather say no, it isn't.
> > 
> > Could probably be triggered by something like kfree()ing
> > a dangling pointer or something...
> 
> Yes.  That's what my patch was for ("Fix major memory corruption bug").
> It was pretty hard to catch because I would find the consequences rather
> than to the offending code.  I got lucky after I enabled some weird
> options, such as 64Gb support and highmem debugging.  Whether it played
> any role or not, the oops finally happened where the driver tried to
> erase memory pointed to by the stale phy->lo_control pointer.
> 
> Now the situation is following.
> 
> No more random crashes.  There is still a crash if I rmmod the driver
> while wlan0 is up, but it's a separate issue, and it's easy to avoid
> (unlike the interface going down).  I hope to look at it soon.

Did you apply that d80211 rmmod crash fix that Michael Wu posted
recently. I bet it will fix your issue.

> The driver connects to a 802.11b Linksys router just fine.  I can send
> and receive data.  The driver is fully functional.  128-bit WEP is
> supported.

Nice.

> There are periodic bursts of assertion failures.  Looking at the driver,
> I see three places where lna a.k.a. phy->lo_gain[0] is assigned the
> value of 32 (written as 0x20 in one place).  It's not surprising that it
> exceeds 7 in lo_measure_feedthrough().

I know about these and I am going to fix that, soon.
Ignore it for the time being, please.

> I think the assert() should be replaced with a FIXME, which would not
> annoy end users so much.

Well, no. It's kind of: Michael, go ahead and fix that crap!
So I'd like to keep it to get me to fix it. :D

> And while at that, it would be great to 
> replace phy->lo_gain with four fields with descriptive names.
> phy->lo_gain is never used as an array.  Alternatively, you could make
> it a structure within bcm43xx_phy.

Yeah, one step after the other. ;)
We didn't know the meanings of the values until recently. Of course
I am going to rename them.

> The problems with a MadWifi based AP turn out to be related to 802.11g.
> If the AP is configured for 802.11b only, everything is working.  If
> 802.11g is enabled, strange things are happening.  Judging by what's on
> the air, it looks like the driver loses the data frames is receives.
> wpa_supplicant connects instantly, but ARP and ping packets from AP to
> STA are lost.  The frames are even acknowledged, but not seen on the
> station side.  It takes from one to ten minutes util ping suddenly
> starts working.

Hm, is this 4318? It is known to loose lots of packets.

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Jan 22 23:04:41 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 22 Jan 2007 16:04:41 -0600
Subject: Can someone please try...
In-Reply-To: <200701222200.19784.mb@bu3sch.de>
References: <200701161806.02780.mb@bu3sch.de>	<200701222106.24329.mb@bu3sch.de>
	<1169498676.4453.14.camel@dv> <200701222200.19784.mb@bu3sch.de>
Message-ID: <45B534F9.5090608@lwfinger.net>

Michael Buesch wrote:
> On Monday 22 January 2007 21:44, Pavel Roskin wrote:
>> The problems with a MadWifi based AP turn out to be related to 802.11g.
>> If the AP is configured for 802.11b only, everything is working.  If
>> 802.11g is enabled, strange things are happening.  Judging by what's on
>> the air, it looks like the driver loses the data frames is receives.
>> wpa_supplicant connects instantly, but ARP and ping packets from AP to
>> STA are lost.  The frames are even acknowledged, but not seen on the
>> station side.  It takes from one to ten minutes util ping suddenly
>> starts working.
> 
> Hm, is this 4318? It is known to loose lots of packets.

On my 4311 with softmac, the throughput is increased by a factor of 6 by reducing the rate from the
default 11M to 1M. Obviously the success rate is greatly improved. Perhaps the same effect will
happen for 4318's. Does the d80211 version let you change the rate?

Larry


From proski at gnu.org  Tue Jan 23 07:14:40 2007
From: proski at gnu.org (Pavel Roskin)
Date: Tue, 23 Jan 2007 01:14:40 -0500
Subject: Can someone please try...
In-Reply-To: <200701222200.19784.mb@bu3sch.de>
References: <200701161806.02780.mb@bu3sch.de>
	<200701222106.24329.mb@bu3sch.de> <1169498676.4453.14.camel@dv>
	<200701222200.19784.mb@bu3sch.de>
Message-ID: <1169532880.8258.2.camel@dv>

On Mon, 2007-01-22 at 22:00 +0100, Michael Buesch wrote: 
> > No more random crashes.  There is still a crash if I rmmod the driver
> > while wlan0 is up, but it's a separate issue, and it's easy to avoid
> > (unlike the interface going down).  I hope to look at it soon.
> 
> Did you apply that d80211 rmmod crash fix that Michael Wu posted
> recently. I bet it will fix your issue.

I have tried the patch, and it doesn't fix the problem.  It's a separate
problem.  It happens when bcm43xx_interrupt_handler() is called on a
device that has already been removed.  It looks like
bcm43xx_wireless_core_stop() should be called from
bcm43xx_one_core_detach().

Unfortunately, I cannot come to a satisfactory solution yet.  If I call
bcm43xx_wireless_core_stop() with the mutex held, the driver won't
unload if the interface is down.  If I don't hold the mutex, it would
happen when the interface is up.

By the way, I think it's a bad idea to unlock any mutexes or other locks
set outside the function.  The caller assumes that the lock is held
until it (the caller) unlocks it.  Unlocking locks from other functions
breaks this convention. 

> > I think the assert() should be replaced with a FIXME, which would not
> > annoy end users so much.
> 
> Well, no. It's kind of: Michael, go ahead and fix that crap!
> So I'd like to keep it to get me to fix it. :D

I, for one, prefer to keep my to-do items in my to-do list, but I don't
want to distract you with petty arguments from fixing the real problem.

> > And while at that, it would be great to 
> > replace phy->lo_gain with four fields with descriptive names.
> > phy->lo_gain is never used as an array.  Alternatively, you could make
> > it a structure within bcm43xx_phy.
> 
> Yeah, one step after the other. ;)
> We didn't know the meanings of the values until recently. Of course
> I am going to rename them.

Great!

> > The problems with a MadWifi based AP turn out to be related to 802.11g.
> > If the AP is configured for 802.11b only, everything is working.  If
> > 802.11g is enabled, strange things are happening.  Judging by what's on
> > the air, it looks like the driver loses the data frames is receives.
> > wpa_supplicant connects instantly, but ARP and ping packets from AP to
> > STA are lost.  The frames are even acknowledged, but not seen on the
> > station side.  It takes from one to ten minutes util ping suddenly
> > starts working.
> 
> Hm, is this 4318? It is known to loose lots of packets.

No, it's 4312.

-- 
Regards,
Pavel Roskin




From mb at bu3sch.de  Tue Jan 23 10:21:34 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 23 Jan 2007 10:21:34 +0100
Subject: Can someone please try...
In-Reply-To: <1169532880.8258.2.camel@dv>
References: <200701161806.02780.mb@bu3sch.de>
	<200701222200.19784.mb@bu3sch.de> <1169532880.8258.2.camel@dv>
Message-ID: <200701231021.34995.mb@bu3sch.de>

On Tuesday 23 January 2007 07:14, Pavel Roskin wrote:
> On Mon, 2007-01-22 at 22:00 +0100, Michael Buesch wrote: 
> > > No more random crashes.  There is still a crash if I rmmod the driver
> > > while wlan0 is up, but it's a separate issue, and it's easy to avoid
> > > (unlike the interface going down).  I hope to look at it soon.
> > 
> > Did you apply that d80211 rmmod crash fix that Michael Wu posted
> > recently. I bet it will fix your issue.
> 
> I have tried the patch, and it doesn't fix the problem.  It's a separate
> problem.  It happens when bcm43xx_interrupt_handler() is called on a
> device that has already been removed.

That shouldn't happen and doesn't for me.

> It looks like 
> bcm43xx_wireless_core_stop() should be called from
> bcm43xx_one_core_detach().

No, well... . remove_interface should have been called by the stack, no?

> Unfortunately, I cannot come to a satisfactory solution yet.  If I call
> bcm43xx_wireless_core_stop() with the mutex held, the driver won't
> unload if the interface is down.  If I don't hold the mutex, it would
> happen when the interface is up.
> 
> By the way, I think it's a bad idea to unlock any mutexes or other locks
> set outside the function.  The caller assumes that the lock is held
> until it (the caller) unlocks it.  Unlocking locks from other functions
> breaks this convention. 

It would result in a deadlock, if we don't unlock it there. That's
perfectly fine.

> > > I think the assert() should be replaced with a FIXME, which would not
> > > annoy end users so much.
> > 
> > Well, no. It's kind of: Michael, go ahead and fix that crap!
> > So I'd like to keep it to get me to fix it. :D
> 
> I, for one, prefer to keep my to-do items in my to-do list, but I don't
> want to distract you with petty arguments from fixing the real problem.

Well, assert() statements are there to find bugs. And if there is a bug,
they trigger. That's pretty much the semantics of an assert() statement.
I'm not sure why you want to hide a bug.

Either way, in this case it seems like the code is right
and just the assert() mask is wrong. But that's only this way by luck.
Could easily have been the other way around. ;)
Specs were slightly wrong at this point.

But as I said, I will commit a fix today.

> > Hm, is this 4318? It is known to loose lots of packets.
> 
> No, it's 4312.

That has got the same problems.

-- 
Greetings Michael.


From mb at bu3sch.de  Tue Jan 23 16:22:23 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 23 Jan 2007 16:22:23 +0100
Subject: [PATCH] bcm43xx: Fix problem with >1 GB RAM
In-Reply-To: <1169565516.2777.13.camel@localhost.localdomain>
References: <45b240d6.SHryQ/4Jr/1MvQso%Larry.Finger@lwfinger.net>
	<45B51C31.10000@lwfinger.net>
	<1169565516.2777.13.camel@localhost.localdomain>
Message-ID: <200701231622.24054.mb@bu3sch.de>

On Tuesday 23 January 2007 16:18, Dan Williams wrote:
> > At present, I have a problem getting NetworkManager to see the d80211 wireless interface. Once I get
> > that solved, I plan to use my system to test with > 1 GB RAM on your git tree. In that case, I'll
> > switch to the pci-form only if necessary.
> 
> NM should show the interface if HAL sees the interface and has assigned
> it a "net.80211" capability.  We had all agreed that HAL should be a bit
> smarter about detecting d80211 devices, but we were postponing that
> until we figured out what to do with the master device.  Now that we

Jiri already has a working patch for that.
I think he will commit it, soon.

-- 
Greetings Michael.


From mb at bu3sch.de  Tue Jan 23 17:40:18 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Tue, 23 Jan 2007 17:40:18 +0100
Subject: [PATCH resend] bcm43xx-d80211: Fix DMA TX skb doublefree
Message-ID: <200701231740.18708.mb@bu3sch.de>

This fixes a possible double-free of the TX skb buffers.
Always NULL the pointer after freeing.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

--

I already sent this patch to you on 21 Dec 2006.
This is a pretty critical patch, so I'd like to make sure
it's in your merge queue and is not lost.


Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_dma.c
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_dma.c	2006-12-07 17:25:19.000000000 +0100
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_dma.c	2006-12-21 19:05:28.000000000 +0100
@@ -388,6 +388,7 @@ void free_descriptor_buffer(struct bcm43
 			dev_kfree_skb_irq(meta->skb);
 		else
 			dev_kfree_skb(meta->skb);
+		meta->skb = NULL;
 	}
 }
 
@@ -1131,6 +1132,7 @@ void bcm43xx_dma_handle_txstatus(struct 
 			meta->txstat.retry_count = status->frame_count - 1;
 			ieee80211_tx_status_irqsafe(bcm->ieee, meta->skb, &(meta->txstat));
 			/* skb is freed by ieee80211_tx_status_irqsafe() */
+			meta->skb = NULL;
 		} else {
 			/* No need to call free_descriptor_buffer here, as
 			 * this is only the txhdr, which is not allocated.


-- 
Greetings Michael.



From rjw at sisk.pl  Tue Jan 23 18:17:46 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 23 Jan 2007 18:17:46 +0100
Subject: bcm43xx on HPC nx6325 - partial success
Message-ID: <200701231817.46430.rjw@sisk.pl>

Hi,

First, thanks a lot for your work on the driver.

Now, my observations: With the patch from

https://lists.berlios.de/pipermail/bcm43xx-dev/2007-January/003484.html

and the patch radio_enable_2.6.20 from

ftp://lwfinger.dynalias.org/patches

on top of 2.6.20-rc5 (x86_64), the bcm4311 card in my HPC nx6325 partially
works (I use the ieee80211softmac version of the driver).  Namely, everything
seems to be going on well and and interrupts are coming, I can run
"iwlist eth2 scan" and it reports something like the following:

eth2      Scan completed :
          Cell 01 - Address: 00:13:46:85:46:F9
                    ESSID:"[edited]"
                    Protocol:IEEE 802.11bg
                    Mode:Master
                    Channel:6
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
                    Quality=82/100  Signal level=-71 dBm  Noise level=-68 dBm
                    IE: WPA Version 1
                        Group Cipher : WEP-40
                        Pairwise Ciphers (2) : WEP-40 TKIP
                        Authentication Suites (1) : PSK
                    Extra: Last beacon: 280ms ago

but strangely enough this is someone else's access point, not mine.
My access point is a D-Link DI-624+ router, with different ESSID and
different MAC.   It stands just next to my machine and yet it is not detected
(it is detected by my second maching with bcm4306, though, and works with it).

Also, the interface is not automatically associated with the listed AP, but I
can run "iwconfig eth2 essid [edited]" and it seems to work (although please
note the link quality reported vs the one above):

albercik:~/src/wireless/wireless_tools.29 # iwconfig eth2
eth2      IEEE 802.11b/g  ESSID:"[edited]"  Nickname:"Broadcom 4311"
          Mode:Managed  Frequency=2.437 GHz  Access Point: 00:13:46:85:46:F9
          Bit Rate=1 Mb/s   Tx-Power=18 dBm
          RTS thr:off   Fragment thr:off
          Encryption key:off
          Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0

However, if I attempt to change the bit rate with "iwconfig eth2 rate 11M" it
just doesn't work (iwconfig still reports "Bit Rate=1 Mb/s"), and then
"iwlist rate" says:

eth2      12 available bit-rates :
          0.012 kb/s
          0.018 kb/s
          0.024 kb/s
          0.036 kb/s
          0.048 kb/s
          0.072 kb/s
          0.096 kb/s
          0.108 kb/s
          0.002 kb/s
          0.004 kb/s
          0.011 kb/s
          0.022 kb/s
          Current Bit Rate:1 Mb/s

The first problem is the D-Link router not being detected, but I think someone
else has already reported similar problems with a D-Link access point, so it
seems there's something wrong with the bcm4311 vs D-Link APs in general.

Of course the second one is the bit rates, but I have no idea if they are
related to each other.

Please let me know what I can do to debug the problems further.

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From larry.finger at lwfinger.net  Tue Jan 23 20:59:34 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Jan 2007 13:59:34 -0600
Subject: bcm43xx on HPC nx6325 - partial success
In-Reply-To: <200701231817.46430.rjw@sisk.pl>
References: <200701231817.46430.rjw@sisk.pl>
Message-ID: <45B66926.2000007@lwfinger.net>

Rafael J. Wysocki wrote:
> Hi,
> 
> First, thanks a lot for your work on the driver.
> 
> Now, my observations: With the patch from
> 
> https://lists.berlios.de/pipermail/bcm43xx-dev/2007-January/003484.html
> 
> and the patch radio_enable_2.6.20 from
> 
> ftp://lwfinger.dynalias.org/patches
> 
> on top of 2.6.20-rc5 (x86_64), the bcm4311 card in my HPC nx6325 partially
> works (I use the ieee80211softmac version of the driver).  Namely, everything
> seems to be going on well and and interrupts are coming, I can run
> "iwlist eth2 scan" and it reports something like the following:
> 
> eth2      Scan completed :
>           Cell 01 - Address: 00:13:46:85:46:F9
>                     ESSID:"[edited]"
>                     Protocol:IEEE 802.11bg
>                     Mode:Master
>                     Channel:6
>                     Encryption key:on
>                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
>                               11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
>                               48 Mb/s; 54 Mb/s
>                     Quality=82/100  Signal level=-71 dBm  Noise level=-68 dBm
>                     IE: WPA Version 1
>                         Group Cipher : WEP-40
>                         Pairwise Ciphers (2) : WEP-40 TKIP
>                         Authentication Suites (1) : PSK
>                     Extra: Last beacon: 280ms ago
> 
> but strangely enough this is someone else's access point, not mine.
> My access point is a D-Link DI-624+ router, with different ESSID and
> different MAC.   It stands just next to my machine and yet it is not detected
> (it is detected by my second maching with bcm4306, though, and works with it).

First of all, please don't bother editing out the ESSID's from your postings. That information can
be deduced by anyone in your vicinity very quickly, even if your ESSID is hidden.
> 
> Also, the interface is not automatically associated with the listed AP, but I
> can run "iwconfig eth2 essid [edited]" and it seems to work (although please
> note the link quality reported vs the one above):
> 
> albercik:~/src/wireless/wireless_tools.29 # iwconfig eth2
> eth2      IEEE 802.11b/g  ESSID:"[edited]"  Nickname:"Broadcom 4311"
>           Mode:Managed  Frequency=2.437 GHz  Access Point: 00:13:46:85:46:F9
>           Bit Rate=1 Mb/s   Tx-Power=18 dBm
>           RTS thr:off   Fragment thr:off
>           Encryption key:off
>           Link Quality=0/100  Signal level=-256 dBm  Noise level=-256 dBm
>           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
>           Tx excessive retries:0  Invalid misc:0   Missed beacon:0
> 
> However, if I attempt to change the bit rate with "iwconfig eth2 rate 11M" it
> just doesn't work (iwconfig still reports "Bit Rate=1 Mb/s"), and then
> "iwlist rate" says:
> 
> eth2      12 available bit-rates :
>           0.012 kb/s
>           0.018 kb/s
>           0.024 kb/s
>           0.036 kb/s
>           0.048 kb/s
>           0.072 kb/s
>           0.096 kb/s
>           0.108 kb/s
>           0.002 kb/s
>           0.004 kb/s
>           0.011 kb/s
>           0.022 kb/s
>           Current Bit Rate:1 Mb/s
> 
> The first problem is the D-Link router not being detected, but I think someone
> else has already reported similar problems with a D-Link access point, so it
> seems there's something wrong with the bcm4311 vs D-Link APs in general.

You might try using kismet or ethereal on another wireless device to capture the traffic from the 4311.

> Of course the second one is the bit rates, but I have no idea if they are
> related to each other.

The bit rate output is a bug. Mine does it too - I'll find the problem.

Larry



From Larry.Finger at lwfinger.net  Tue Jan 23 21:26:35 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Jan 2007 14:26:35 -0600
Subject: [PATCH] bcm43xx: Fix scaling error for 'iwlist rate' information
Message-ID: <45b66f7b.qEvXToJSJL5WnxfG%Larry.Finger@lwfinger.net>

The bcm43xx scales the rate information supplied to a WE iwlist rate call incorrectly.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This fix should be applied to wireless-2.6. As it is a bug fix, it could also be sent
to 2.6.20; however, it has no real effect on system operations, and it doesn't mtter.

Larry
---
 
Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
@@ -261,22 +261,22 @@ static int bcm43xx_wx_get_rangeparams(st
 	if (phy->type == BCM43xx_PHYTYPE_A ||
 	    phy->type == BCM43xx_PHYTYPE_G) {
 		range->num_bitrates = 8;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_6MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_9MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_12MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_18MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_24MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_36MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_48MB;
-		range->bitrate[i++] = IEEE80211_OFDM_RATE_54MB;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_6MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_9MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_12MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_18MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_24MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_36MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_48MB * 500000;
+		range->bitrate[i++] = IEEE80211_OFDM_RATE_54MB * 500000;
 	}
 	if (phy->type == BCM43xx_PHYTYPE_B ||
 	    phy->type == BCM43xx_PHYTYPE_G) {
 		range->num_bitrates += 4;
-		range->bitrate[i++] = IEEE80211_CCK_RATE_1MB;
-		range->bitrate[i++] = IEEE80211_CCK_RATE_2MB;
-		range->bitrate[i++] = IEEE80211_CCK_RATE_5MB;
-		range->bitrate[i++] = IEEE80211_CCK_RATE_11MB;
+		range->bitrate[i++] = IEEE80211_CCK_RATE_1MB * 500000;
+		range->bitrate[i++] = IEEE80211_CCK_RATE_2MB * 500000;
+		range->bitrate[i++] = IEEE80211_CCK_RATE_5MB * 500000;
+		range->bitrate[i++] = IEEE80211_CCK_RATE_11MB * 500000;
 	}
 
 	geo = ieee80211_get_geo(bcm->ieee);

---



From rjw at sisk.pl  Tue Jan 23 22:18:39 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 23 Jan 2007 22:18:39 +0100
Subject: bcm43xx on HPC nx6325 - partial success
In-Reply-To: <45B66926.2000007@lwfinger.net>
References: <200701231817.46430.rjw@sisk.pl> <45B66926.2000007@lwfinger.net>
Message-ID: <200701232218.39898.rjw@sisk.pl>

Hi,

On Tuesday, 23 January 2007 20:59, Larry Finger wrote:
> Rafael J. Wysocki wrote:
> > Hi,
> > 
> > First, thanks a lot for your work on the driver.
> > 
> > Now, my observations: With the patch from
> > 
> > https://lists.berlios.de/pipermail/bcm43xx-dev/2007-January/003484.html
> > 
> > and the patch radio_enable_2.6.20 from
> > 
> > ftp://lwfinger.dynalias.org/patches
> > 
> > on top of 2.6.20-rc5 (x86_64), the bcm4311 card in my HPC nx6325 partially
> > works (I use the ieee80211softmac version of the driver).  Namely, everything
> > seems to be going on well and and interrupts are coming, I can run
> > "iwlist eth2 scan" and it reports something like the following:
> > 
> > eth2      Scan completed :
> >           Cell 01 - Address: 00:13:46:85:46:F9
> >                     ESSID:"[edited]"
> >                     Protocol:IEEE 802.11bg
> >                     Mode:Master
> >                     Channel:6
> >                     Encryption key:on
> >                     Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
> >                               11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
> >                               48 Mb/s; 54 Mb/s
> >                     Quality=82/100  Signal level=-71 dBm  Noise level=-68 dBm
> >                     IE: WPA Version 1
> >                         Group Cipher : WEP-40
> >                         Pairwise Ciphers (2) : WEP-40 TKIP
> >                         Authentication Suites (1) : PSK
> >                     Extra: Last beacon: 280ms ago
> > 
> > but strangely enough this is someone else's access point, not mine.
> > My access point is a D-Link DI-624+ router, with different ESSID and
> > different MAC.   It stands just next to my machine and yet it is not detected
> > (it is detected by my second maching with bcm4306, though, and works with it).
> 
> First of all, please don't bother editing out the ESSID's from your postings. That information can
> be deduced by anyone in your vicinity very quickly, even if your ESSID is hidden.

This isn't mine, as I said, and that's why it's been edited.  Well, I should
have edited the MAC too, but that isn't so easy to google out. ;-)

[--snip--]
 
> > The first problem is the D-Link router not being detected, but I think someone
> > else has already reported similar problems with a D-Link access point, so it
> > seems there's something wrong with the bcm4311 vs D-Link APs in general.
> 
> You might try using kismet or ethereal on another wireless device to capture the traffic from the 4311.

Yes, that sounds promising.

In the meantime I carried out another experiment.  I found an unencrypted AP close
to me and tried to associate with it.  That seemed to work, so I configured the
interface manually with ifconfig and ran tcpdump on it.  Then I received some
traffic from that network and figured out from it that there was the IP 192.168.1.101
in there, so I reconfigured my interface with the address 192.168.1.15 and tried
to ping the other host.  There was no reply (Destination Host Unreachable), so
I started a network monitor (gkrellm) and ran a continuous ping from the
wireless interface.  Then, no transmits were reported by the monitor.

So, it seems, the card is still unable to transmit, although it evidently
receives packets.

> > Of course the second one is the bit rates, but I have no idea if they are
> > related to each other.
> 
> The bit rate output is a bug. Mine does it too - I'll find the problem.

Ah, I see there's a patch already.  I'll try it and report back.

Greetings,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From rjw at sisk.pl  Tue Jan 23 22:34:16 2007
From: rjw at sisk.pl (Rafael J. Wysocki)
Date: Tue, 23 Jan 2007 22:34:16 +0100
Subject: [PATCH] bcm43xx: Fix scaling error for 'iwlist rate' information
In-Reply-To: <45b66f7b.qEvXToJSJL5WnxfG%Larry.Finger@lwfinger.net>
References: <45b66f7b.qEvXToJSJL5WnxfG%Larry.Finger@lwfinger.net>
Message-ID: <200701232234.16703.rjw@sisk.pl>

On Tuesday, 23 January 2007 21:26, Larry Finger wrote:
> The bcm43xx scales the rate information supplied to a WE iwlist rate call incorrectly.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This fix should be applied to wireless-2.6. As it is a bug fix, it could also be sent
> to 2.6.20; however, it has no real effect on system operations, and it doesn't mtter.

Fixes the output of 'iwlist rate' for me.

Thanks,
Rafael


-- 
If you don't have the time to read,
you don't have the time or the tools to write.
		- Stephen King


From Larry.Finger at lwfinger.net  Tue Jan 23 23:43:26 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Tue, 23 Jan 2007 16:43:26 -0600
Subject: [PATCH] bcm43xx: Fix scaling error for 'iwlist freq' information
Message-ID: <45b68f8e.m8+Bl9ZfRL/zvhGv%Larry.Finger@lwfinger.net>

The bcm43xx driver returns the available frequencies to 'iwlist freq' with the wrong scaling.

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---

John,

This is to be applied to wireless-2.6. It could also be sent upstream to 2.6.20,
but it is not very important.

Larry
---

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
@@ -286,7 +286,7 @@ static int bcm43xx_wx_get_rangeparams(st
 		if (j == IW_MAX_FREQUENCIES)
 			break;
 		range->freq[j].i = j + 1;
-		range->freq[j].m = geo->a[i].freq;//FIXME?
+		range->freq[j].m = geo->a[i].freq * 100000;
 		range->freq[j].e = 1;
 		j++;
 	}
@@ -294,7 +294,7 @@ static int bcm43xx_wx_get_rangeparams(st
 		if (j == IW_MAX_FREQUENCIES)
 			break;
 		range->freq[j].i = j + 1;
-		range->freq[j].m = geo->bg[i].freq;//FIXME?
+		range->freq[j].m = geo->bg[i].freq * 100000;
 		range->freq[j].e = 1;
 		j++;
 	}

---



From mb at bu3sch.de  Wed Jan 24 00:04:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 24 Jan 2007 00:04:01 +0100
Subject: [PATCH] bcm43xx: Fix scaling error for 'iwlist freq' information
In-Reply-To: <45b68f8e.m8+Bl9ZfRL/zvhGv%Larry.Finger@lwfinger.net>
References: <45b68f8e.m8+Bl9ZfRL/zvhGv%Larry.Finger@lwfinger.net>
Message-ID: <200701240004.01943.mb@bu3sch.de>

On Tuesday 23 January 2007 23:43, Larry Finger wrote:
> The bcm43xx driver returns the available frequencies to 'iwlist freq' with the wrong scaling.
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> John,
> 
> This is to be applied to wireless-2.6. It could also be sent upstream to 2.6.20,
> but it is not very important.

ACKed. The previous rates-fix patch is also ACKed.

> Larry
> ---
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_wx.c
> @@ -286,7 +286,7 @@ static int bcm43xx_wx_get_rangeparams(st
>  		if (j == IW_MAX_FREQUENCIES)
>  			break;
>  		range->freq[j].i = j + 1;
> -		range->freq[j].m = geo->a[i].freq;//FIXME?
> +		range->freq[j].m = geo->a[i].freq * 100000;
>  		range->freq[j].e = 1;
>  		j++;
>  	}
> @@ -294,7 +294,7 @@ static int bcm43xx_wx_get_rangeparams(st
>  		if (j == IW_MAX_FREQUENCIES)
>  			break;
>  		range->freq[j].i = j + 1;
> -		range->freq[j].m = geo->bg[i].freq;//FIXME?
> +		range->freq[j].m = geo->bg[i].freq * 100000;
>  		range->freq[j].e = 1;
>  		j++;
>  	}
> 
> ---
> 
> 
> 

-- 
Greetings Michael.


From proski at gnu.org  Wed Jan 24 06:43:10 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 24 Jan 2007 00:43:10 -0500
Subject: Can someone please try...
In-Reply-To: <200701231021.34995.mb@bu3sch.de>
References: <200701161806.02780.mb@bu3sch.de>
	<200701222200.19784.mb@bu3sch.de> <1169532880.8258.2.camel@dv>
	<200701231021.34995.mb@bu3sch.de>
Message-ID: <1169617390.30511.27.camel@dv>

On Tue, 2007-01-23 at 10:21 +0100, Michael Buesch wrote:
> On Tuesday 23 January 2007 07:14, Pavel Roskin wrote:
> > I have tried the patch, and it doesn't fix the problem.  It's a separate
> > problem.  It happens when bcm43xx_interrupt_handler() is called on a
> > device that has already been removed.
> 
> That shouldn't happen and doesn't for me.
> 
> > It looks like 
> > bcm43xx_wireless_core_stop() should be called from
> > bcm43xx_one_core_detach().
> 
> No, well... . remove_interface should have been called by the stack, no?

It is not.  It's called if I bring the interface down with ifconfig.  If
I remove live interface with "rmmod bcm43xx_d80211",
bcm43xx_one_core_detach() is called first, followed by kernel panic in 
bcm43xx_interrupt_handler().

And that's what I see in the code.  Module removal calls bcm43xx_exit().
It unregisters the ssb driver first.  The ssb layer calls
bcm43xx_remove(), which calls bcm43xx_one_core_detach() before doing
anything with the wireless stack or with interrupts.

I tried to put bcm43xx_one_core_detach() to the end of bcm43xx_remove(),
but the result was the same.  Still, I think the solution lies in that
direction.  We should stop the hardware before dismantling any data
structures.

-- 
Regards,
Pavel Roskin




From mb at bu3sch.de  Wed Jan 24 09:43:24 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 24 Jan 2007 09:43:24 +0100
Subject: Can someone please try...
In-Reply-To: <1169617390.30511.27.camel@dv>
References: <200701161806.02780.mb@bu3sch.de> <200701231021.34995.mb@bu3sch.de>
	<1169617390.30511.27.camel@dv>
Message-ID: <200701240943.24141.mb@bu3sch.de>

On Wednesday 24 January 2007 06:43, Pavel Roskin wrote:
> On Tue, 2007-01-23 at 10:21 +0100, Michael Buesch wrote:
> > On Tuesday 23 January 2007 07:14, Pavel Roskin wrote:
> > > I have tried the patch, and it doesn't fix the problem.  It's a separate
> > > problem.  It happens when bcm43xx_interrupt_handler() is called on a
> > > device that has already been removed.
> > 
> > That shouldn't happen and doesn't for me.
> > 
> > > It looks like 
> > > bcm43xx_wireless_core_stop() should be called from
> > > bcm43xx_one_core_detach().
> > 
> > No, well... . remove_interface should have been called by the stack, no?
> 
> It is not.  It's called if I bring the interface down with ifconfig.  If
> I remove live interface with "rmmod bcm43xx_d80211",
> bcm43xx_one_core_detach() is called first, followed by kernel panic in 
> bcm43xx_interrupt_handler().
> 
> And that's what I see in the code.  Module removal calls bcm43xx_exit().
> It unregisters the ssb driver first.  The ssb layer calls
> bcm43xx_remove(), which calls bcm43xx_one_core_detach() before doing
> anything with the wireless stack or with interrupts.
> 
> I tried to put bcm43xx_one_core_detach() to the end of bcm43xx_remove(),
> but the result was the same.  Still, I think the solution lies in that
> direction.  We should stop the hardware before dismantling any data
> structures.

Ok, I see. I will try to debug this.

-- 
Greetings Michael.


From Larry.Finger at lwfinger.net  Wed Jan 24 19:39:26 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Jan 2007 12:39:26 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
Message-ID: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>

The current bcm43xx-d80211 driver ignores any wireless-enable switches on mini-PCI
and mini-PCI-E cards. This patch implements a new routine to interrogate the
radio hardware enabled bit in the interface, logs the initial state and any
changes in the switch (if debugging enabled), activates the LED to show the
state, and changes the periodic work handler to provide 1 second response
to switch changes. The changes in the periodic work specs have not been implemented.

This should be applied to http://bu3sch.de/git/wireless-dev.git. 

Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
---



Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
@@ -238,6 +238,9 @@ enum {
 #define BCM43xx_UCODEFLAG_UNKPACTRL	0x0040
 #define BCM43xx_UCODEFLAG_JAPAN		0x0080
 
+/* Hardware Radio Enable masks */
+#define BCM43xx_MMIO_RADIO_HWENABLED_HI_MASK (1 << 16)
+#define BCM43xx_MMIO_RADIO_HWENABLED_LO_MASK (1 << 4)
 
 /* HostFlags. See bcm43xx_hf_read/write() */
 #define BCM43xx_HF_ANTDIVHELP		0x00000001 /* ucode antenna div helper */
@@ -735,7 +738,8 @@ struct bcm43xx_wldev {
 	    reg124_set_0x4:1,		/* Some variable to keep track of IRQ stuff. */
 	    short_preamble:1,		/* TRUE, if short preamble is enabled. */
 	    short_slot:1,		/* TRUE, if short slot timing is enabled. */
-	    firmware_norelease:1;	/* Do not release the firmware. Used on suspend. */
+	    firmware_norelease:1,       /* Do not release the firmware. Used on suspend. */
+	    radio_hw_enable:1;          /* saved state of radio hardware enabled state */
 
 	/* PHY/Radio device. */
 	struct bcm43xx_phy phy;
Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
@@ -27,7 +27,7 @@
 
 #include "bcm43xx_leds.h"
 #include "bcm43xx.h"
-
+#include "bcm43xx_main.h"
 
 static void bcm43xx_led_changestate(struct bcm43xx_led *led)
 {
@@ -108,6 +108,7 @@ static void bcm43xx_led_init_hardcoded(s
 	switch (led_index) {
 	case 0:
 		led->behaviour = BCM43xx_LED_ACTIVITY;
+		led->activelow = 1;
 		if (bus->board_vendor == PCI_VENDOR_ID_COMPAQ)
 			led->behaviour = BCM43xx_LED_RADIO_ALL;
 		break;
@@ -196,18 +197,19 @@ void bcm43xx_leds_update(struct bcm43xx_
 			turn_on = activity;
 			break;
 		case BCM43xx_LED_RADIO_ALL:
-			turn_on = phy->radio_on;
+			turn_on = phy->radio_on && bcm43xx_is_hw_radio_enabled(dev);
 			break;
 		case BCM43xx_LED_RADIO_A:
-			turn_on = (phy->radio_on && phy->type == BCM43xx_PHYTYPE_A);
+			turn_on = (phy->radio_on && bcm43xx_is_hw_radio_enabled(dev)
+				   && phy->type == BCM43xx_PHYTYPE_A);
 			break;
 		case BCM43xx_LED_RADIO_B:
-			turn_on = (phy->radio_on &&
+			turn_on = (phy->radio_on && bcm43xx_is_hw_radio_enabled(dev) &&
 				   (phy->type == BCM43xx_PHYTYPE_B ||
 				    phy->type == BCM43xx_PHYTYPE_G));
 			break;
 		case BCM43xx_LED_MODE_BG:
-			if (phy->type == BCM43xx_PHYTYPE_G &&
+			if (phy->type == BCM43xx_PHYTYPE_G && bcm43xx_is_hw_radio_enabled(dev) &&
 			    1/*FIXME: using G rates.*/)
 				turn_on = 1;
 			break;
Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
@@ -2080,6 +2080,9 @@ static int bcm43xx_chip_init(struct bcm4
 	if (err)
 		goto err_gpio_cleanup;
 	bcm43xx_radio_turn_on(dev);
+	dev->radio_hw_enable = bcm43xx_is_hw_radio_enabled(dev);
+	dprintk(KERN_INFO PFX "Radio %s by hardware\n",
+		(dev->radio_hw_enable == 0) ? "disabled" : "enabled");
 
 	bcm43xx_write16(dev, 0x03E6, 0x0000);
 	err = bcm43xx_phy_init(dev);
@@ -2226,22 +2229,38 @@ static void bcm43xx_periodic_every15sec(
 	//TODO for APHY (temperature?)
 }
 
+static void bcm43xx_periodic_every1sec(struct bcm43xx_wldev *dev)
+{
+	int radio_hw_enable;
+
+	/* check if radio hardware enabled status changed */
+	radio_hw_enable = bcm43xx_is_hw_radio_enabled(dev);
+	if (unlikely(dev->radio_hw_enable != radio_hw_enable)) {
+		dev->radio_hw_enable = radio_hw_enable;
+		dprintk(KERN_INFO PFX "Radio hardware status changed to %s\n",
+			(radio_hw_enable == 0) ? "disabled" : "enabled");
+		bcm43xx_leds_update(dev, 0);
+	}
+}
+
 static void do_periodic_work(struct bcm43xx_wldev *dev)
 {
 	unsigned int state;
 
 	state = dev->periodic_state;
-	if (state % 8 == 0)
+	if (state % 120 == 0)
 		bcm43xx_periodic_every120sec(dev);
-	if (state % 4 == 0)
+	if (state % 60 == 0)
 		bcm43xx_periodic_every60sec(dev);
-	if (state % 2 == 0)
+	if (state % 30 == 0)
 		bcm43xx_periodic_every30sec(dev);
-	if (state % 1 == 0)
+	if (state % 15 == 0)
 		bcm43xx_periodic_every15sec(dev);
+	bcm43xx_periodic_every1sec(dev);
+
 	dev->periodic_state = state + 1;
 
-	schedule_delayed_work(&dev->periodic_work, HZ * 15);
+	schedule_delayed_work(&dev->periodic_work, HZ);
 }
 
 /* Estimate a "Badness" value based on the periodic work
@@ -2252,13 +2271,13 @@ static int estimate_periodic_work_badnes
 {
 	int badness = 0;
 
-	if (state % 8 == 0) /* every 120 sec */
+	if (state % 120 == 0) /* every 120 sec */
 		badness += 10;
-	if (state % 4 == 0) /* every 60 sec */
+	if (state % 60 == 0) /* every 60 sec */
 		badness += 5;
-	if (state % 2 == 0) /* every 30 sec */
+	if (state % 30 == 0) /* every 30 sec */
 		badness += 1;
-	if (state % 1 == 0) /* every 15 sec */
+	if (state % 15 == 0) /* every 15 sec */
 		badness += 1;
 
 #define BADNESS_LIMIT	4
Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.h
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.h
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.h
@@ -109,6 +109,24 @@ int bcm43xx_is_ofdm_rate(int rate)
 	return !bcm43xx_is_cck_rate(rate);
 }
 
+static inline
+int bcm43xx_is_hw_radio_enabled(struct bcm43xx_wldev *dev)
+{
+	/* function to return state of hardware enable of radio
+	 * returns 0 if radio disabled, 1 if radio enabled
+	 */
+	struct bcm43xx_phy *phy = &dev->phy;
+
+	if (phy->rev >= 3)
+		return ((bcm43xx_read32(dev, BCM43xx_MMIO_RADIO_HWENABLED_HI)
+					& BCM43xx_MMIO_RADIO_HWENABLED_HI_MASK)
+					== 0) ? 1 : 0;
+	else
+		return ((bcm43xx_read16(dev, BCM43xx_MMIO_RADIO_HWENABLED_LO)
+					& BCM43xx_MMIO_RADIO_HWENABLED_LO_MASK)
+					== 0) ? 0 : 1;
+}
+
 void bcm43xx_tsf_read(struct bcm43xx_wldev *dev, u64 *tsf);
 void bcm43xx_tsf_write(struct bcm43xx_wldev *dev, u64 tsf);
 


From mb at bu3sch.de  Wed Jan 24 19:47:27 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 24 Jan 2007 19:47:27 +0100
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
Message-ID: <200701241947.27280.mb@bu3sch.de>

On Wednesday 24 January 2007 19:39, Larry Finger wrote:
> The current bcm43xx-d80211 driver ignores any wireless-enable switches on mini-PCI
> and mini-PCI-E cards. This patch implements a new routine to interrogate the
> radio hardware enabled bit in the interface, logs the initial state and any
> changes in the switch (if debugging enabled), activates the LED to show the
> state, and changes the periodic work handler to provide 1 second response
> to switch changes. The changes in the periodic work specs have not been implemented.
> 
> This should be applied to http://bu3sch.de/git/wireless-dev.git. 
> 
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> ---
> 
> 
> 
> Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
> ===================================================================
> --- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
> +++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx.h
> @@ -238,6 +238,9 @@ enum {
>  #define BCM43xx_UCODEFLAG_UNKPACTRL	0x0040
>  #define BCM43xx_UCODEFLAG_JAPAN		0x0080
>  
> +/* Hardware Radio Enable masks */
> +#define BCM43xx_MMIO_RADIO_HWENABLED_HI_MASK (1 << 16)
> +#define BCM43xx_MMIO_RADIO_HWENABLED_LO_MASK (1 << 4)
>  
>  /* HostFlags. See bcm43xx_hf_read/write() */
>  #define BCM43xx_HF_ANTDIVHELP		0x00000001 /* ucode antenna div helper */
> @@ -735,7 +738,8 @@ struct bcm43xx_wldev {
>  	    reg124_set_0x4:1,		/* Some variable to keep track of IRQ stuff. */
>  	    short_preamble:1,		/* TRUE, if short preamble is enabled. */
>  	    short_slot:1,		/* TRUE, if short slot timing is enabled. */
> -	    firmware_norelease:1;	/* Do not release the firmware. Used on suspend. */
> +	    firmware_norelease:1,       /* Do not release the firmware. Used on suspend. */
> +	    radio_hw_enable:1;          /* saved state of radio hardware enabled state */
>  
>  	/* PHY/Radio device. */
>  	struct bcm43xx_phy phy;
> Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
> ===================================================================
> --- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
> +++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_leds.c
> @@ -27,7 +27,7 @@
>  
>  #include "bcm43xx_leds.h"
>  #include "bcm43xx.h"
> -
> +#include "bcm43xx_main.h"
>  
>  static void bcm43xx_led_changestate(struct bcm43xx_led *led)
>  {
> @@ -108,6 +108,7 @@ static void bcm43xx_led_init_hardcoded(s
>  	switch (led_index) {
>  	case 0:
>  		led->behaviour = BCM43xx_LED_ACTIVITY;
> +		led->activelow = 1;

Why activelow?

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Wed Jan 24 20:08:13 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Jan 2007 13:08:13 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <200701241947.27280.mb@bu3sch.de>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701241947.27280.mb@bu3sch.de>
Message-ID: <45B7AE9D.7080909@lwfinger.net>

Michael Buesch wrote:
> On Wednesday 24 January 2007 19:39, Larry Finger wrote:
>>  	switch (led_index) {
>>  	case 0:
>>  		led->behaviour = BCM43xx_LED_ACTIVITY;
>> +		led->activelow = 1;
> 
> Why activelow?

It makes the light be on when there is no activity and blink off when there is. With that behavior,
it is a lot easier to see that the switch is on.

Larry




From mb at bu3sch.de  Wed Jan 24 21:06:53 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 24 Jan 2007 21:06:53 +0100
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B7AE9D.7080909@lwfinger.net>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701241947.27280.mb@bu3sch.de> <45B7AE9D.7080909@lwfinger.net>
Message-ID: <200701242106.53886.mb@bu3sch.de>

On Wednesday 24 January 2007 20:08, Larry Finger wrote:
> Michael Buesch wrote:
> > On Wednesday 24 January 2007 19:39, Larry Finger wrote:
> >>  	switch (led_index) {
> >>  	case 0:
> >>  		led->behaviour = BCM43xx_LED_ACTIVITY;
> >> +		led->activelow = 1;
> > 
> > Why activelow?
> 
> It makes the light be on when there is no activity and blink off when there is. With that behavior,
> it is a lot easier to see that the switch is on.

Ah, ok.
It's debatable if that behaviour is desireable.
I don't like it, but if people want to have it, we can implement it.

-- 
Greetings Michael.


From geekypenguin at gmail.com  Wed Jan 24 23:59:46 2007
From: geekypenguin at gmail.com (Jory A. Pratt)
Date: Wed, 24 Jan 2007 16:59:46 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <200701242106.53886.mb@bu3sch.de>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>	<200701241947.27280.mb@bu3sch.de>
	<45B7AE9D.7080909@lwfinger.net> <200701242106.53886.mb@bu3sch.de>
Message-ID: <45B7E4E2.1050301@gmail.com>

Michael Buesch wrote:
> On Wednesday 24 January 2007 20:08, Larry Finger wrote:
>   
>> Michael Buesch wrote:
>>     
>>> On Wednesday 24 January 2007 19:39, Larry Finger wrote:
>>>       
>>>>  	switch (led_index) {
>>>>  	case 0:
>>>>  		led->behaviour = BCM43xx_LED_ACTIVITY;
>>>> +		led->activelow = 1;
>>>>         
>>> Why activelow?
>>>       
>> It makes the light be on when there is no activity and blink off when there is. With that behavior,
>> it is a lot easier to see that the switch is on.
>>     
>
> Ah, ok.
> It's debatable if that behaviour is desireable.
> I don't like it, but if people want to have it, we can implement it.
>
>   
I do not think this is what people want. If the radio is off the light
should just be off, when radio is on turn the light on, is a much more
desirable.

Thanks,
-Jory


From mb at bu3sch.de  Thu Jan 25 00:04:16 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 25 Jan 2007 00:04:16 +0100
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B7E4E2.1050301@gmail.com>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701242106.53886.mb@bu3sch.de> <45B7E4E2.1050301@gmail.com>
Message-ID: <200701250004.16626.mb@bu3sch.de>

On Wednesday 24 January 2007 23:59, Jory A. Pratt wrote:
> Michael Buesch wrote:
> > On Wednesday 24 January 2007 20:08, Larry Finger wrote:
> >   
> >> Michael Buesch wrote:
> >>     
> >>> On Wednesday 24 January 2007 19:39, Larry Finger wrote:
> >>>       
> >>>>  	switch (led_index) {
> >>>>  	case 0:
> >>>>  		led->behaviour = BCM43xx_LED_ACTIVITY;
> >>>> +		led->activelow = 1;
> >>>>         
> >>> Why activelow?
> >>>       
> >> It makes the light be on when there is no activity and blink off when there is. With that behavior,
> >> it is a lot easier to see that the switch is on.
> >>     
> >
> > Ah, ok.
> > It's debatable if that behaviour is desireable.
> > I don't like it, but if people want to have it, we can implement it.
> >
> >   
> I do not think this is what people want. If the radio is off the light
> should just be off, when radio is on turn the light on, is a much more
> desirable.

Well, we are talking about the "activity" LED, not about the "radio on"
LED. There are many cards out there (including ethernet cards) which
always have the LED on and flash it for activity. So it's not _that_
wrong to do it.
Personally, I think it's more intuitive to have a LED off, when there
is no activity, but hey... .
It could also save a little bit of power on notebooks, if we leave
it activehigh. But on the other side, if someone is concerned about
the LEDs drawing too much current, he can as well completely disable
the LEDs with the module parameter.

-- 
Greetings Michael.


From sbrown at ewol.com  Thu Jan 25 00:16:00 2007
From: sbrown at ewol.com (Steve Brown)
Date: Wed, 24 Jan 2007 18:16:00 -0500
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B7E4E2.1050301@gmail.com>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>	<200701241947.27280.mb@bu3sch.de>	<45B7AE9D.7080909@lwfinger.net>
	<200701242106.53886.mb@bu3sch.de> <45B7E4E2.1050301@gmail.com>
Message-ID: <45B7E8B0.2070909@ewol.com>

Jory A. Pratt wrote:
> Michael Buesch wrote:
>   
>> On Wednesday 24 January 2007 20:08, Larry Finger wrote:
>>   
>>     
>>> Michael Buesch wrote:
>>>     
>>>       
>>>> On Wednesday 24 January 2007 19:39, Larry Finger wrote:
>>>>       
>>>>         
>>>>>  	switch (led_index) {
>>>>>  	case 0:
>>>>>  		led->behaviour = BCM43xx_LED_ACTIVITY;
>>>>> +		led->activelow = 1;
>>>>>         
>>>>>           
>>>> Why activelow?
>>>>       
>>>>         
>>> It makes the light be on when there is no activity and blink off when there is. With that behavior,
>>> it is a lot easier to see that the switch is on.
>>>     
>>>       
>> Ah, ok.
>> It's debatable if that behaviour is desireable.
>> I don't like it, but if people want to have it, we can implement it.
>>
>>   
>>     
> I do not think this is what people want. If the radio is off the light
> should just be off, when radio is on turn the light on, is a much more
> desirable.
>
> Thanks,
> -Jory
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
> !DSPAM:6251,45b7e6db63428126216758!
>
>
>   
My understanding of the proposed behavior is:
    Radio on: led on
    Radio off: led off
    Activity: flash on-off-on ...

This is the same behavior as my Buffalo WHR-HP-G54 and seems reasonable.

Steve




From mb at bu3sch.de  Thu Jan 25 00:24:48 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 25 Jan 2007 00:24:48 +0100
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B7E8B0.2070909@ewol.com>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<45B7E4E2.1050301@gmail.com> <45B7E8B0.2070909@ewol.com>
Message-ID: <200701250024.48378.mb@bu3sch.de>

On Thursday 25 January 2007 00:16, Steve Brown wrote: 
> My understanding of the proposed behavior is:
>     Radio on: led on
>     Radio off: led off
>     Activity: flash on-off-on ...
> 
> This is the same behavior as my Buffalo WHR-HP-G54 and seems reasonable.

That's not what is implemented in larry's patch.
In this patch the "activity" led does only indicate activity
and not radio status. (Well, it also indicates a the-card-is-up
state, but that's not necessarily indicating that the radio
is switched on).

-- 
Greetings Michael.


From wirelessnet at chubb.wattle.id.au  Thu Jan 25 01:21:25 2007
From: wirelessnet at chubb.wattle.id.au (Peter Chubb)
Date: Thu, 25 Jan 2007 11:21:25 +1100
Subject: Can someone please try...
In-Reply-To: <1169617390.30511.27.camel@dv>
References: <200701161806.02780.mb@bu3sch.de> <200701222200.19784.mb@bu3sch.de>
	<1169532880.8258.2.camel@dv> <200701231021.34995.mb@bu3sch.de>
	<1169617390.30511.27.camel@dv>
Message-ID: <87irew0xdm.wl%peter@chubb.wattle.id.au>



Hi,
	I tried your tree.  It doesn't work too well with my bcm4306
chip.


I see not one but two interfaces created: eth1 and wlan0_rename.

eth1      Link encap:UNSPEC  HWaddr 00-03-C9-53-89-50-30-3A-00-00-00-00-00-00-00-00  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

wlan0_ren Link encap:Ethernet  HWaddr 00:03:C9:53:89:50  
          MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)


Dmesg output after "ifconfig wlan0_rename up" is:

ACPI: PCI Interrupt 0000:02:03.0[A] -> Link [LNKB] -> GSI 5 (level, low) -> IRQ 5
ssb: Sonics Silicon Backplane found on PCI device 0000:02:03.0
ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x04, vendor 0x4243)
ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x05, vendor 0x4243)
ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x02, vendor 0x4243)
ssb: Core 3 found: V90 (cc 0x807, rev 0x02, vendor 0x4243)
ssb: Core 4 found: PCI (cc 0x804, rev 0x09, vendor 0x4243)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to PCI core, index 4
wmaster0: Selected rate control algorithm 'simple'
bcm43xx_d80211: Broadcom 4306 WLAN found
ssb: Switching to IEEE 802.11 core, index 1
ssb: Switching to PCI core, index 4
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Found PHY: Version 2, Type 2, Revision 2
bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
bcm43xx_d80211: Loading firmware version 319.102 (2005-10-15 22:46:19)
ssb: Switching to ChipCommon core, index 0
ssb: Switching to IEEE 802.11 core, index 1
bcm43xx_d80211: Radio turned on
bcm43xx_d80211: Chip initialized
bcm43xx_d80211: 30-bit DMA initialized
bcm43xx_d80211: Wireless interface started
eth1: Does not support passive scan, disabled
wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00
wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00
wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00

"iwlist scan" shows many access points in range, but neither interface
apparently attached  to this card will associate, even if I explicitly
set access point and ESSID:

# iwconfig wlan0_rename essid nicta_wireless ap 00:13:5F:54:EB:70
# dmesg 
wlan0_rename: Initial auth_alg=0
wlan0_rename: authenticate with AP 00:13:5f:54:eb:70
wlan0_rename: RX authentication from 00:13:5f:54:eb:70 (alg=0 transaction=2 status=0)
wlan0_rename: authenticated
wlan0_rename: associate with AP 00:13:5f:54:eb:70
wlan0_rename: authentication frame received from 00:13:5f:54:eb:70, but not in authenticate state - ignored
wlan0_rename: RX AssocResp from 00:13:5f:54:eb:70 (capab=0x421 status=0 aid=116)
wlan0_rename: associated
eth1: Added STA 00:13:5f:54:eb:70
wlan0_rename: WMM queue=2 aci=0 acm=0 aifs=3 cWmin=15 cWmax=1023 burst=0
wlan0_rename: WMM queue=3 aci=1 acm=0 aifs=7 cWmin=15 cWmax=1023 burst=0
wlan0_rename: WMM queue=1 aci=2 acm=0 aifs=2 cWmin=7 cWmax=15 burst=30
wlan0_rename: WMM queue=0 aci=3 acm=0 aifs=2 cWmin=3 cWmax=7 burst=15
wlan0_rename: association frame received from 00:13:5f:54:eb:70, but not in associate state - ignored


--
Dr Peter Chubb  http://www.gelato.unsw.edu.au  peterc AT gelato.unsw.edu.au
http://www.ertos.nicta.com.au           ERTOS within National ICT Australia


From larry.finger at lwfinger.net  Thu Jan 25 04:18:57 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Jan 2007 21:18:57 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <200701250004.16626.mb@bu3sch.de>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>	<200701242106.53886.mb@bu3sch.de>
	<45B7E4E2.1050301@gmail.com> <200701250004.16626.mb@bu3sch.de>
Message-ID: <45B821A1.4010202@lwfinger.net>

Michael Buesch wrote:
> On Wednesday 24 January 2007 23:59, Jory A. Pratt wrote:
>> Michael Buesch wrote:
>>> On Wednesday 24 January 2007 20:08, Larry Finger wrote:
>>>   
>>>> Michael Buesch wrote:
>>>>     
>>>>> On Wednesday 24 January 2007 19:39, Larry Finger wrote:
>>>>>       
>>>>>>  	switch (led_index) {
>>>>>>  	case 0:
>>>>>>  		led->behaviour = BCM43xx_LED_ACTIVITY;
>>>>>> +		led->activelow = 1;
>>>>>>         
>>>>> Why activelow?
>>>>>       
>>>> It makes the light be on when there is no activity and blink off when there is. With that behavior,
>>>> it is a lot easier to see that the switch is on.
>>>>     
>>> Ah, ok.
>>> It's debatable if that behaviour is desireable.
>>> I don't like it, but if people want to have it, we can implement it.
>>>
>>>   
>> I do not think this is what people want. If the radio is off the light
>> should just be off, when radio is on turn the light on, is a much more
>> desirable.
> 
> Well, we are talking about the "activity" LED, not about the "radio on"
> LED. There are many cards out there (including ethernet cards) which
> always have the LED on and flash it for activity. So it's not _that_
> wrong to do it.
> Personally, I think it's more intuitive to have a LED off, when there
> is no activity, but hey... .
> It could also save a little bit of power on notebooks, if we leave
> it activehigh. But on the other side, if someone is concerned about
> the LEDs drawing too much current, he can as well completely disable
> the LEDs with the module parameter.

If the LED that shows the radio switch state were different than the one used to show activity, then
I would agree with you; however, it is the same one. If we want the light on when the switch is on
(and the interface is up) and I think we do, then we need the behavior I coded.

If there were a way to determine if the hardware-enabled bit were determined by a switch, then we
could make activelow conditional, but that is not the case. It doesn't matter to me as my switch is
a slide, and I always know if the radio is enabled; however, a lot of them are momentary switches
that seem to toggle a bit in the hardware. Those people need positive feedback that the radio is
enabled. Without the activelow, their light would be on if the radio were off, and vice versa. That
would be too much confusion!

Larry




From larry.finger at lwfinger.net  Thu Jan 25 04:21:46 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 24 Jan 2007 21:21:46 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <200701250024.48378.mb@bu3sch.de>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>	<45B7E4E2.1050301@gmail.com>
	<45B7E8B0.2070909@ewol.com> <200701250024.48378.mb@bu3sch.de>
Message-ID: <45B8224A.2070203@lwfinger.net>

Michael Buesch wrote:
> On Thursday 25 January 2007 00:16, Steve Brown wrote: 
>> My understanding of the proposed behavior is:
>>     Radio on: led on
>>     Radio off: led off
>>     Activity: flash on-off-on ...
>>
>> This is the same behavior as my Buffalo WHR-HP-G54 and seems reasonable.
> 
> That's not what is implemented in larry's patch.
> In this patch the "activity" led does only indicate activity
> and not radio status. (Well, it also indicates a the-card-is-up
> state, but that's not necessarily indicating that the radio
> is switched on).

Actually, it is what is in my patch. The LED is on if the hardware-enable switch is on and the
interface is up.

Larry




From proski at gnu.org  Thu Jan 25 05:20:31 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 24 Jan 2007 23:20:31 -0500
Subject: Can someone please try...
In-Reply-To: <87irew0xdm.wl%peter@chubb.wattle.id.au>
References: <200701161806.02780.mb@bu3sch.de>
	<200701222200.19784.mb@bu3sch.de> <1169532880.8258.2.camel@dv>
	<200701231021.34995.mb@bu3sch.de> <1169617390.30511.27.camel@dv>
	<87irew0xdm.wl%peter@chubb.wattle.id.au>
Message-ID: <1169698831.10504.6.camel@dv>

On Thu, 2007-01-25 at 11:21 +1100, Peter Chubb wrote:

> "iwlist scan" shows many access points in range, but neither interface
> apparently attached  to this card will associate, even if I explicitly
> set access point and ESSID:
> 
> # iwconfig wlan0_rename essid nicta_wireless ap 00:13:5F:54:EB:70

You should also set the channel.  The rumors are that you should set the
channel first, then essid, then ap.  I believe setting essid or ap
triggers the association, and the channel should be known at that point.

Also, if the interface goes down and up, you should set the channel
again, even though it's reported to be correct.  I think it's a bug in
d80211.

This work for me with 802.11b-only APs.  The traffic can be passed
immediately.

My device (PCIe 4312) has trouble with 802.11g access points.  it takes
several minutes before any traffic can pass through.  Strangely,
wpa_supplicant associates immediately, but it still takes minutes before
the data traffic starts passing.

Your mileage may vary.

-- 
Regards,
Pavel Roskin




From proski at gnu.org  Thu Jan 25 07:50:54 2007
From: proski at gnu.org (Pavel Roskin)
Date: Thu, 25 Jan 2007 01:50:54 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
Message-ID: <1169707854.10593.41.camel@dv>

Hello!

I have discovered that while I can indeed associate without
wpa_supplicant using bcm43xx_d80211 driver, I have to set the channel
every time the interface is brought down and up.

It turns out d80211 uses the "config" method of the hardware drivers
very sparingly.  It's only used for scanning and in ioctl commands.  It
is not called after the interface has been brought up with the "open"
method.

I don't know whose responsibility it should be to apply the
configuration when the interface is brought up.  I'm not familiar with
d80211 design principles.

If the hardware drivers are supposed to do it, here's my patch.  It is
working fine for me and ready to be applied.  The changelog is in the
subject.

Signed-off-by: Pavel Roskin <proski at gnu.org>
---

 drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
index 9f4d51d..d408e38 100644
--- a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
+++ b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
@@ -2809,6 +2809,9 @@ static int bcm43xx_dev_open(struct ieee80211_hw *hw)
 	}
 	mutex_unlock(&wl->mutex);
 
+	if (!err)
+		err = bcm43xx_dev_config(hw, &hw->conf);
+
 	return err;
 }
 


-- 
Regards,
Pavel Roskin




From mb at bu3sch.de  Thu Jan 25 10:45:04 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 25 Jan 2007 10:45:04 +0100
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B8224A.2070203@lwfinger.net>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701250024.48378.mb@bu3sch.de> <45B8224A.2070203@lwfinger.net>
Message-ID: <200701251045.04882.mb@bu3sch.de>

On Thursday 25 January 2007 04:21, Larry Finger wrote:
> Michael Buesch wrote:
> > On Thursday 25 January 2007 00:16, Steve Brown wrote: 
> >> My understanding of the proposed behavior is:
> >>     Radio on: led on
> >>     Radio off: led off
> >>     Activity: flash on-off-on ...
> >>
> >> This is the same behavior as my Buffalo WHR-HP-G54 and seems reasonable.
> > 
> > That's not what is implemented in larry's patch.
> > In this patch the "activity" led does only indicate activity
> > and not radio status. (Well, it also indicates a the-card-is-up
> > state, but that's not necessarily indicating that the radio
> > is switched on).
> 
> Actually, it is what is in my patch. The LED is on if the hardware-enable switch is on and the
> interface is up.

The activity LED switches off, if you turn off the rf through rfkill button?
I don't think it does. I'd say it would always stay on, if you
switch rf off.

-- 
Greetings Michael.


From mb at bu3sch.de  Thu Jan 25 10:45:39 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Thu, 25 Jan 2007 10:45:39 +0100
Subject: Can someone please try...
In-Reply-To: <87irew0xdm.wl%peter@chubb.wattle.id.au>
References: <200701161806.02780.mb@bu3sch.de> <1169617390.30511.27.camel@dv>
	<87irew0xdm.wl%peter@chubb.wattle.id.au>
Message-ID: <200701251045.39273.mb@bu3sch.de>

On Thursday 25 January 2007 01:21, Peter Chubb wrote:
> 
> Hi,
> 	I tried your tree.  It doesn't work too well with my bcm4306
> chip.

Known issues. Thanks for testing.

> 
> I see not one but two interfaces created: eth1 and wlan0_rename.
> 
> eth1      Link encap:UNSPEC  HWaddr 00-03-C9-53-89-50-30-3A-00-00-00-00-00-00-00-00  
>           BROADCAST MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:1000 
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> 
> wlan0_ren Link encap:Ethernet  HWaddr 00:03:C9:53:89:50  
>           MULTICAST  MTU:1500  Metric:1
>           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
>           collisions:0 txqueuelen:0 
>           RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
> 
> 
> Dmesg output after "ifconfig wlan0_rename up" is:
> 
> ACPI: PCI Interrupt 0000:02:03.0[A] -> Link [LNKB] -> GSI 5 (level, low) -> IRQ 5
> ssb: Sonics Silicon Backplane found on PCI device 0000:02:03.0
> ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x04, vendor 0x4243)
> ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x05, vendor 0x4243)
> ssb: Core 2 found: PCMCIA (cc 0x80D, rev 0x02, vendor 0x4243)
> ssb: Core 3 found: V90 (cc 0x807, rev 0x02, vendor 0x4243)
> ssb: Core 4 found: PCI (cc 0x804, rev 0x09, vendor 0x4243)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to PCI core, index 4
> wmaster0: Selected rate control algorithm 'simple'
> bcm43xx_d80211: Broadcom 4306 WLAN found
> ssb: Switching to IEEE 802.11 core, index 1
> ssb: Switching to PCI core, index 4
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_d80211: Found PHY: Version 2, Type 2, Revision 2
> bcm43xx_d80211: Found Radio: Manuf 0x17F, Version 0x2050, Revision 2
> bcm43xx_d80211: Loading firmware version 319.102 (2005-10-15 22:46:19)
> ssb: Switching to ChipCommon core, index 0
> ssb: Switching to IEEE 802.11 core, index 1
> bcm43xx_d80211: Radio turned on
> bcm43xx_d80211: Chip initialized
> bcm43xx_d80211: 30-bit DMA initialized
> bcm43xx_d80211: Wireless interface started
> eth1: Does not support passive scan, disabled
> wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00
> wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00
> wlan0_rename: dropped data frame to not associated station 00:00:00:00:00:00
> 
> "iwlist scan" shows many access points in range, but neither interface
> apparently attached  to this card will associate, even if I explicitly
> set access point and ESSID:
> 
> # iwconfig wlan0_rename essid nicta_wireless ap 00:13:5F:54:EB:70
> # dmesg 
> wlan0_rename: Initial auth_alg=0
> wlan0_rename: authenticate with AP 00:13:5f:54:eb:70
> wlan0_rename: RX authentication from 00:13:5f:54:eb:70 (alg=0 transaction=2 status=0)
> wlan0_rename: authenticated
> wlan0_rename: associate with AP 00:13:5f:54:eb:70
> wlan0_rename: authentication frame received from 00:13:5f:54:eb:70, but not in authenticate state - ignored
> wlan0_rename: RX AssocResp from 00:13:5f:54:eb:70 (capab=0x421 status=0 aid=116)
> wlan0_rename: associated
> eth1: Added STA 00:13:5f:54:eb:70
> wlan0_rename: WMM queue=2 aci=0 acm=0 aifs=3 cWmin=15 cWmax=1023 burst=0
> wlan0_rename: WMM queue=3 aci=1 acm=0 aifs=7 cWmin=15 cWmax=1023 burst=0
> wlan0_rename: WMM queue=1 aci=2 acm=0 aifs=2 cWmin=7 cWmax=15 burst=30
> wlan0_rename: WMM queue=0 aci=3 acm=0 aifs=2 cWmin=3 cWmax=7 burst=15
> wlan0_rename: association frame received from 00:13:5f:54:eb:70, but not in associate state - ignored
> 
> 
> --
> Dr Peter Chubb  http://www.gelato.unsw.edu.au  peterc AT gelato.unsw.edu.au
> http://www.ertos.nicta.com.au           ERTOS within National ICT Australia
> 
> 

-- 
Greetings Michael.


From jbenc at suse.cz  Thu Jan 25 10:30:39 2007
From: jbenc at suse.cz (Jiri Benc)
Date: Thu, 25 Jan 2007 10:30:39 +0100
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <1169707854.10593.41.camel@dv>
References: <1169707854.10593.41.camel@dv>
Message-ID: <20070125103039.325dd757@griffin.suse.cz>

On Thu, 25 Jan 2007 01:50:54 -0500, Pavel Roskin wrote:
> It turns out d80211 uses the "config" method of the hardware drivers
> very sparingly.  It's only used for scanning and in ioctl commands.  It
> is not called after the interface has been brought up with the "open"
> method.
> 
> I don't know whose responsibility it should be to apply the
> configuration when the interface is brought up.  I'm not familiar with
> d80211 design principles.

I think it should be done in the stack (actually, it's on todo list for
quite some time). However, I don't consider this as a big problem -
just do it in a driver (like your patch does) for now.

 Jiri

-- 
Jiri Benc
SUSE Labs


From jbenc at suse.cz  Thu Jan 25 13:50:33 2007
From: jbenc at suse.cz (Jiri Benc)
Date: Thu, 25 Jan 2007 13:50:33 +0100
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <a32f33a40701250347q5c9aa5fby785181f77fc9bb4@mail.gmail.com>
References: <1169707854.10593.41.camel@dv>
	<a32f33a40701250347q5c9aa5fby785181f77fc9bb4@mail.gmail.com>
Message-ID: <20070125135033.7d7d7baf@griffin.suse.cz>

On Thu, 25 Jan 2007 12:47:08 +0100, Ivo Van Doorn wrote:
> Correct, similar problems have been detected in rt2x00. The temporary
> solution in there is to demand a scanning operation after the interface
> has been brought up.

Scanning? No no no, please! That would be a clear bug and misbehaviour.

 Jiri

-- 
Jiri Benc
SUSE Labs


From larry.finger at lwfinger.net  Thu Jan 25 15:01:47 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 25 Jan 2007 08:01:47 -0600
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <200701251045.04882.mb@bu3sch.de>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701250024.48378.mb@bu3sch.de> <45B8224A.2070203@lwfinger.net>
	<200701251045.04882.mb@bu3sch.de>
Message-ID: <45B8B84B.8070406@lwfinger.net>

Michael Buesch wrote:
> On Thursday 25 January 2007 04:21, Larry Finger wrote:
>> Michael Buesch wrote:
>>> On Thursday 25 January 2007 00:16, Steve Brown wrote: 
>>>> My understanding of the proposed behavior is:
>>>>     Radio on: led on
>>>>     Radio off: led off
>>>>     Activity: flash on-off-on ...
>>>>
>>>> This is the same behavior as my Buffalo WHR-HP-G54 and seems reasonable.
>>> That's not what is implemented in larry's patch.
>>> In this patch the "activity" led does only indicate activity
>>> and not radio status. (Well, it also indicates a the-card-is-up
>>> state, but that's not necessarily indicating that the radio
>>> is switched on).
>> Actually, it is what is in my patch. The LED is on if the hardware-enable switch is on and the
>> interface is up.
> 
> The activity LED switches off, if you turn off the rf through rfkill button?
> I don't think it does. I'd say it would always stay on, if you
> switch rf off.

On both mini-PCI interfaces here, and on every other one that has been reported to me, the LED used
to show activity (number 0) is also the one used in the rfkill switch. With the activelow and the
rest of my patch, it is on when the rf is enabled, and off when the rf is disabled. As Michael would
say "Full stop!".

Larry




From gene.heskett at verizon.net  Thu Jan 25 15:05:32 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 09:05:32 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <20070125135033.7d7d7baf@griffin.suse.cz>
References: <1169707854.10593.41.camel@dv>
	<a32f33a40701250347q5c9aa5fby785181f77fc9bb4@mail.gmail.com>
	<20070125135033.7d7d7baf@griffin.suse.cz>
Message-ID: <200701250905.33129.gene.heskett@verizon.net>

On Thursday 25 January 2007 07:50, Jiri Benc wrote:
>On Thu, 25 Jan 2007 12:47:08 +0100, Ivo Van Doorn wrote:
>> Correct, similar problems have been detected in rt2x00. The temporary
>> solution in there is to demand a scanning operation after the
>> interface has been brought up.
>
>Scanning? No no no, please! That would be a clear bug and misbehaviour.
>
> Jiri

Oh?  I'm sitting here watching the tty0 screen of my lappy after x has 
been started, and I have established a connection, but SoftMAC is still 
logging its scan activity, starting with channel 1 and scanning 14 
channels.  Its doing this at approximately 2 minute intervals.  So I 
think we have your definition of a clear bug and misbehaviour.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From jbenc at suse.cz  Thu Jan 25 15:23:21 2007
From: jbenc at suse.cz (Jiri Benc)
Date: Thu, 25 Jan 2007 15:23:21 +0100
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <200701250905.33129.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>
	<a32f33a40701250347q5c9aa5fby785181f77fc9bb4@mail.gmail.com>
	<20070125135033.7d7d7baf@griffin.suse.cz>
	<200701250905.33129.gene.heskett@verizon.net>
Message-ID: <20070125152321.434bb17c@griffin.suse.cz>

On Thu, 25 Jan 2007 09:05:32 -0500, Gene Heskett wrote:
> Oh?  I'm sitting here watching the tty0 screen of my lappy after x has 
> been started, and I have established a connection, but SoftMAC is still 
> logging its scan activity, starting with channel 1 and scanning 14 
> channels.  Its doing this at approximately 2 minute intervals.  So I 
> think we have your definition of a clear bug and misbehaviour.

Yes. As well as some other wireless drivers. But that's not worth
fixing.

Also, please note that softmac isn't going to do user space MLME so
it is not relevant at all.

 Jiri

-- 
Jiri Benc
SUSE Labs


From gene.heskett at verizon.net  Thu Jan 25 15:33:30 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 09:33:30 -0500
Subject: RFC: bcm43xx-d80211: Add radio hardware switch code to mb tree
In-Reply-To: <45B8B84B.8070406@lwfinger.net>
References: <45b7a7de.62J5SIUzoiX1nbF8%Larry.Finger@lwfinger.net>
	<200701251045.04882.mb@bu3sch.de> <45B8B84B.8070406@lwfinger.net>
Message-ID: <200701250933.30541.gene.heskett@verizon.net>

On Thursday 25 January 2007 09:01, Larry Finger wrote:
>Michael Buesch wrote:
>> On Thursday 25 January 2007 04:21, Larry Finger wrote:
>>> Michael Buesch wrote:
>>>> On Thursday 25 January 2007 00:16, Steve Brown wrote:
>>>>> My understanding of the proposed behavior is:
>>>>>     Radio on: led on
>>>>>     Radio off: led off
>>>>>     Activity: flash on-off-on ...
>>>>>
>>>>> This is the same behavior as my Buffalo WHR-HP-G54 and seems
>>>>> reasonable.
>>>>
>>>> That's not what is implemented in larry's patch.
>>>> In this patch the "activity" led does only indicate activity
>>>> and not radio status. (Well, it also indicates a the-card-is-up
>>>> state, but that's not necessarily indicating that the radio
>>>> is switched on).
>>>
>>> Actually, it is what is in my patch. The LED is on if the
>>> hardware-enable switch is on and the interface is up.
>>
>> The activity LED switches off, if you turn off the rf through rfkill
>> button? I don't think it does. I'd say it would always stay on, if you
>> switch rf off.
>
>On both mini-PCI interfaces here, and on every other one that has been
> reported to me, the LED used to show activity (number 0) is also the
> one used in the rfkill switch. With the activelow and the rest of my
> patch, it is on when the rf is enabled, and off when the rf is
> disabled. As Michael would say "Full stop!".
>
>Larry
>
If I'm allowed to dip and oar in this water, I'd vote for something that 
indicates the connection is up AND working.  I'm sitting here looking at 
an ancient wap11, and its third led blinks with either beacon or link 
activity.  If such an action could be added to the on/off led in the 
hinge of an HP lappy, that would be great.  Make it flash on 1 sec, off 1 
sec when the hardware is enabled but no connection, and flash with the 
reception of the beacon when connected but idle, and get brighter with 
each packet of traffic would be a great 'at a glance' status indicator.

As to how much coding trouble it is to get to that led, I have no idea.  
Clearly if its 100+ lines of assembly code to pick ones way thru the 
hardware and do it, that's certainly not productive use of cpu time IMO.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From gene.heskett at verizon.net  Thu Jan 25 15:34:51 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 09:34:51 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <20070125152321.434bb17c@griffin.suse.cz>
References: <1169707854.10593.41.camel@dv>
	<200701250905.33129.gene.heskett@verizon.net>
	<20070125152321.434bb17c@griffin.suse.cz>
Message-ID: <200701250934.51302.gene.heskett@verizon.net>

On Thursday 25 January 2007 09:23, Jiri Benc wrote:
>On Thu, 25 Jan 2007 09:05:32 -0500, Gene Heskett wrote:
>> Oh?  I'm sitting here watching the tty0 screen of my lappy after x has
>> been started, and I have established a connection, but SoftMAC is
>> still logging its scan activity, starting with channel 1 and scanning
>> 14 channels.  Its doing this at approximately 2 minute intervals.  So
>> I think we have your definition of a clear bug and misbehaviour.
>
>Yes. As well as some other wireless drivers. But that's not worth
>fixing.
>
>Also, please note that softmac isn't going to do user space MLME so
>it is not relevant at all.

MLME?  More acronyms I've not put in my wet dictionary.. :)

> Jiri

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From larry.finger at lwfinger.net  Thu Jan 25 16:36:14 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 25 Jan 2007 09:36:14 -0600
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <200701250905.33129.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>	<a32f33a40701250347q5c9aa5fby785181f77fc9bb4@mail.gmail.com>	<20070125135033.7d7d7baf@griffin.suse.cz>
	<200701250905.33129.gene.heskett@verizon.net>
Message-ID: <45B8CE6E.1030508@lwfinger.net>

Gene Heskett wrote:
> On Thursday 25 January 2007 07:50, Jiri Benc wrote:
>> On Thu, 25 Jan 2007 12:47:08 +0100, Ivo Van Doorn wrote:
>>> Correct, similar problems have been detected in rt2x00. The temporary
>>> solution in there is to demand a scanning operation after the
>>> interface has been brought up.
>> Scanning? No no no, please! That would be a clear bug and misbehaviour.
>>
>> Jiri
> 
> Oh?  I'm sitting here watching the tty0 screen of my lappy after x has 
> been started, and I have established a connection, but SoftMAC is still 
> logging its scan activity, starting with channel 1 and scanning 14 
> channels.  Its doing this at approximately 2 minute intervals.  So I 
> think we have your definition of a clear bug and misbehaviour.
> 

Are you running NetworkManager? If so, that is the source of the scanning.

Larry



From larry.finger at lwfinger.net  Thu Jan 25 18:19:54 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Thu, 25 Jan 2007 11:19:54 -0600
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <200701251158.33561.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>
	<200701250905.33129.gene.heskett@verizon.net>
	<45B8CE6E.1030508@lwfinger.net>
	<200701251158.33561.gene.heskett@verizon.net>
Message-ID: <45B8E6BA.9060304@lwfinger.net>

Gene Heskett wrote:
> On Thursday 25 January 2007 10:36, Larry Finger wrote:
>> Gene Heskett wrote:
>>> On Thursday 25 January 2007 07:50, Jiri Benc wrote:
>>>> On Thu, 25 Jan 2007 12:47:08 +0100, Ivo Van Doorn wrote:
>>>>> Correct, similar problems have been detected in rt2x00. The
>>>>> temporary solution in there is to demand a scanning operation after
>>>>> the interface has been brought up.
>>>> Scanning? No no no, please! That would be a clear bug and
>>>> misbehaviour.
>>>>
>>>> Jiri
>>> Oh?  I'm sitting here watching the tty0 screen of my lappy after x has
>>> been started, and I have established a connection, but SoftMAC is
>>> still logging its scan activity, starting with channel 1 and scanning
>>> 14 channels.  Its doing this at approximately 2 minute intervals.  So
>>> I think we have your definition of a clear bug and misbehaviour.
>> Are you running NetworkManager? If so, that is the source of the
>> scanning.
>>
>> Larry
> 
> yes, but AFAIAC its broken, the hoops I have to go through by hand from a 
> cli to get a working connection are shall we say, excessive.

It is straight-forward for me with SoftMAC using openSUSE 10.2 with KDE. In YaST, I told
NetworkServices/NetworkDevices that I was using NM to configure, rather than the ifcfg method. After
logging in, I clicked on the NM helper applet and clicked on the item for my AP. Up popped up a box
for encryption type and key information. I also checked the box saying I wanted my key saved. Now
when I first boot, I need to enter my password for the KDE wallet; however, the much longer WPA
passphrase does not need to be reentered. NM then associates and authenticates with my AP without
further actions by me.

Of course, your distro may be different; however, on my system, NM is easier than anything I've ever
had with any other OS, including Windows XP and openSUSE 10.0. I'm really pleased with it. ATM it
doesn't work with d80211; however, Jiri is working on a fix for that.

Larry



From gene.heskett at verizon.net  Thu Jan 25 18:30:51 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 12:30:51 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <45B8E6BA.9060304@lwfinger.net>
References: <1169707854.10593.41.camel@dv>
	<200701251158.33561.gene.heskett@verizon.net>
	<45B8E6BA.9060304@lwfinger.net>
Message-ID: <200701251230.51614.gene.heskett@verizon.net>

On Thursday 25 January 2007 12:19, Larry Finger wrote:
>Gene Heskett wrote:
>> On Thursday 25 January 2007 10:36, Larry Finger wrote:
>>> Gene Heskett wrote:
>>>> On Thursday 25 January 2007 07:50, Jiri Benc wrote:
>>>>> On Thu, 25 Jan 2007 12:47:08 +0100, Ivo Van Doorn wrote:
>>>>>> Correct, similar problems have been detected in rt2x00. The
>>>>>> temporary solution in there is to demand a scanning operation
>>>>>> after the interface has been brought up.
>>>>>
>>>>> Scanning? No no no, please! That would be a clear bug and
>>>>> misbehaviour.
>>>>>
>>>>> Jiri
>>>>
>>>> Oh?  I'm sitting here watching the tty0 screen of my lappy after x
>>>> has been started, and I have established a connection, but SoftMAC
>>>> is still logging its scan activity, starting with channel 1 and
>>>> scanning 14 channels.  Its doing this at approximately 2 minute
>>>> intervals.  So I think we have your definition of a clear bug and
>>>> misbehaviour.
>>>
>>> Are you running NetworkManager? If so, that is the source of the
>>> scanning.
>>>
>>> Larry
>>
>> yes, but AFAIAC its broken, the hoops I have to go through by hand
>> from a cli to get a working connection are shall we say, excessive.
>
>It is straight-forward for me with SoftMAC using openSUSE 10.2 with KDE.
> In YaST, I told NetworkServices/NetworkDevices that I was using NM to
> configure, rather than the ifcfg method. After logging in, I clicked on
> the NM helper applet and clicked on the item for my AP. Up popped up a
> box for encryption type and key information. I also checked the box
> saying I wanted my key saved. Now when I first boot, I need to enter my
> password for the KDE wallet; however, the much longer WPA passphrase
> does not need to be reentered. NM then associates and authenticates
> with my AP without further actions by me.
>
>Of course, your distro may be different; however, on my system, NM is
> easier than anything I've ever had with any other OS, including Windows
> XP and openSUSE 10.0. I'm really pleased with it. ATM it doesn't work
> with d80211; however, Jiri is working on a fix for that.
>
>Larry

I think mine (FC5) is different Larry.  I sure don't recall seeing a 'save 
key' checkmark, and it sure isn't saving them.

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From dang at fprintf.net  Thu Jan 25 18:32:50 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Thu, 25 Jan 2007 12:32:50 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <45B8E6BA.9060304@lwfinger.net>
References: <1169707854.10593.41.camel@dv>
	<200701250905.33129.gene.heskett@verizon.net>
	<45B8CE6E.1030508@lwfinger.net>
	<200701251158.33561.gene.heskett@verizon.net>
	<45B8E6BA.9060304@lwfinger.net>
Message-ID: <1169746370.11178.8.camel@athena.fprintf.net>

On Thu, 2007-01-25 at 11:19 -0600, Larry Finger wrote:

> 
> It is straight-forward for me with SoftMAC using openSUSE 10.2 with KDE. In YaST, I told
> NetworkServices/NetworkDevices that I was using NM to configure, rather than the ifcfg method. After
> logging in, I clicked on the NM helper applet and clicked on the item for my AP. Up popped up a box
> for encryption type and key information. I also checked the box saying I wanted my key saved. Now
> when I first boot, I need to enter my password for the KDE wallet; however, the much longer WPA
> passphrase does not need to be reentered. NM then associates and authenticates with my AP without
> further actions by me.
> 
> Of course, your distro may be different; however, on my system, NM is easier than anything I've ever
> had with any other OS, including Windows XP and openSUSE 10.0. I'm really pleased with it. ATM it
> doesn't work with d80211; however, Jiri is working on a fix for that.
> 

It works similarly with Gnome and Gentoo.  I start the NetworkManager
service, and tell the boot scripts not to autostart the network script
for that NIC.  Then, nm-applet stores the keys in the Gnome Keyring.  I
have pam_keyring setup, so I can log in with my keyring passphrase, and
my keyring is automatically unlocked; but if you can't (or don't want)
to do that, you'll just get the password dialog for keyring, same as KDE
wallet.

I have to say, NM is great to use, and I miss it when I can't use it. (I
have a 4318, so I can only use it at work where it's sitting right next
to my AP.  Otherwise, I have to use prism54, which doesn't work with
wpa_supplicant/NM right now, for some reason I haven't tracked down
yet.)

Daniel



From dmaley at redhat.com  Thu Jan 25 18:44:44 2007
From: dmaley at redhat.com (Dave Maley)
Date: Thu, 25 Jan 2007 12:44:44 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <200701251230.51614.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>
	<200701251158.33561.gene.heskett@verizon.net>
	<45B8E6BA.9060304@lwfinger.net>
	<200701251230.51614.gene.heskett@verizon.net>
Message-ID: <1169747084.2672.44.camel@flanders.rdu.redhat.com>

On Thu, 2007-01-25 at 12:30 -0500, Gene Heskett wrote:
> > It is straight-forward for me with SoftMAC using openSUSE 10.2 with KDE.
> > In YaST, I told NetworkServices/NetworkDevices that I was using NM to
> > configure, rather than the ifcfg method. After logging in, I clicked on
> > the NM helper applet and clicked on the item for my AP. Up popped up a
> > box for encryption type and key information. I also checked the box
> > saying I wanted my key saved. Now when I first boot, I need to enter my
> > password for the KDE wallet; however, the much longer WPA passphrase
> > does not need to be reentered. NM then associates and authenticates
> > with my AP without further actions by me.
> >
> > Of course, your distro may be different; however, on my system, NM is
> > easier than anything I've ever had with any other OS, including Windows
> > XP and openSUSE 10.0. I'm really pleased with it. ATM it doesn't work
> > with d80211; however, Jiri is working on a fix for that.
> >
> >Larry
> 
> I think mine (FC5) is different Larry.  I sure don't recall seeing a 'save 
> key' checkmark, and it sure isn't saving them.

NM in FC5 and FC6 should offer you the option of storing the key in the
gnome-keyring.  Maybe you don't have the gnome-keyring package
installed?

This is assuming you're running gnome, not exactly sure how this works
in KDE.

~Dave



From gene.heskett at verizon.net  Thu Jan 25 19:33:08 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 13:33:08 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought	up
In-Reply-To: <1169746370.11178.8.camel@athena.fprintf.net>
References: <1169707854.10593.41.camel@dv> <45B8E6BA.9060304@lwfinger.net>
	<1169746370.11178.8.camel@athena.fprintf.net>
Message-ID: <200701251333.08345.gene.heskett@verizon.net>

On Thursday 25 January 2007 12:32, Daniel Gryniewicz wrote:
>On Thu, 2007-01-25 at 11:19 -0600, Larry Finger wrote:
>> It is straight-forward for me with SoftMAC using openSUSE 10.2 with
>> KDE. In YaST, I told NetworkServices/NetworkDevices that I was using
>> NM to configure, rather than the ifcfg method. After logging in, I
>> clicked on the NM helper applet and clicked on the item for my AP. Up
>> popped up a box for encryption type and key information. I also
>> checked the box saying I wanted my key saved. Now when I first boot, I
>> need to enter my password for the KDE wallet; however, the much longer
>> WPA passphrase does not need to be reentered. NM then associates and
>> authenticates with my AP without further actions by me.
>>
>> Of course, your distro may be different; however, on my system, NM is
>> easier than anything I've ever had with any other OS, including
>> Windows XP and openSUSE 10.0. I'm really pleased with it. ATM it
>> doesn't work with d80211; however, Jiri is working on a fix for that.
>
>It works similarly with Gnome and Gentoo.  I start the NetworkManager
>service, and tell the boot scripts not to autostart the network script
>for that NIC.

How precisely do you do that?  In the ifcfg-device file, or by disabling 
networking in the runlevel?

>Then, nm-applet stores the keys in the Gnome Keyring.  I 
>have pam_keyring setup, so I can log in with my keyring passphrase, and
>my keyring is automatically unlocked; but if you can't (or don't want)
>to do that, you'll just get the password dialog for keyring, same as KDE
>wallet.
>
>I have to say, NM is great to use, and I miss it when I can't use it. (I
>have a 4318, so I can only use it at work where it's sitting right next
>to my AP.  Otherwise, I have to use prism54, which doesn't work with
>wpa_supplicant/NM right now, for some reason I haven't tracked down
>yet.)
>
>Daniel

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From gene.heskett at verizon.net  Thu Jan 25 19:34:06 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 13:34:06 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought	up
In-Reply-To: <1169747084.2672.44.camel@flanders.rdu.redhat.com>
References: <1169707854.10593.41.camel@dv>
	<200701251230.51614.gene.heskett@verizon.net>
	<1169747084.2672.44.camel@flanders.rdu.redhat.com>
Message-ID: <200701251334.07129.gene.heskett@verizon.net>

On Thursday 25 January 2007 12:44, Dave Maley wrote:
>On Thu, 2007-01-25 at 12:30 -0500, Gene Heskett wrote:
>> > It is straight-forward for me with SoftMAC using openSUSE 10.2 with
>> > KDE. In YaST, I told NetworkServices/NetworkDevices that I was using
>> > NM to configure, rather than the ifcfg method. After logging in, I
>> > clicked on the NM helper applet and clicked on the item for my AP.
>> > Up popped up a box for encryption type and key information. I also
>> > checked the box saying I wanted my key saved. Now when I first boot,
>> > I need to enter my password for the KDE wallet; however, the much
>> > longer WPA passphrase does not need to be reentered. NM then
>> > associates and authenticates with my AP without further actions by
>> > me.
>> >
>> > Of course, your distro may be different; however, on my system, NM
>> > is easier than anything I've ever had with any other OS, including
>> > Windows XP and openSUSE 10.0. I'm really pleased with it. ATM it
>> > doesn't work with d80211; however, Jiri is working on a fix for
>> > that.
>> >
>> >Larry
>>
>> I think mine (FC5) is different Larry.  I sure don't recall seeing a
>> 'save key' checkmark, and it sure isn't saving them.
>
>NM in FC5 and FC6 should offer you the option of storing the key in the
>gnome-keyring.  Maybe you don't have the gnome-keyring package
>installed?
>
>This is assuming you're running gnome, not exactly sure how this works
>in KDE.
>
I hate to admit it, but this may be one place where gnome is ahead of kde 
in that case.

>~Dave

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From dang at fprintf.net  Thu Jan 25 19:43:37 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Thu, 25 Jan 2007 13:43:37 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought	up
In-Reply-To: <200701251333.08345.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv> <45B8E6BA.9060304@lwfinger.net>
	<1169746370.11178.8.camel@athena.fprintf.net>
	<200701251333.08345.gene.heskett@verizon.net>
Message-ID: <1169750617.11178.13.camel@athena.fprintf.net>

On Thu, 2007-01-25 at 13:33 -0500, Gene Heskett wrote:
> On Thursday 25 January 2007 12:32, Daniel Gryniewicz wrote:
> >It works similarly with Gnome and Gentoo.  I start the NetworkManager
> >service, and tell the boot scripts not to autostart the network script
> >for that NIC.
> 
> How precisely do you do that?  In the ifcfg-device file, or by disabling 
> networking in the runlevel?

This is Gentoo, so I just set:
RC_PLUG_SERVICES="!net.*"
in /etc/conf.d/rc so that network devices aren't configured by hotplug,
and make sure I didn't add net.eth1 (or whatever device it is) to
default:
rc-update del net.eth1
That's it.  ifcfg-device is, I believe, a RedHat/Fedora thing.  I don't
use those (at least not with wireless), so I can't help you there.

Daniel



From ubq7 at stud.uni-karlsruhe.de  Fri Jan 26 00:38:35 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Fri, 26 Jan 2007 00:38:35 +0100
Subject: [RFC PATCH] bcm43xx: set channel when the interface is
	=?utf-8?q?brought=09up?=
In-Reply-To: <200701251334.07129.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>
	<1169747084.2672.44.camel@flanders.rdu.redhat.com>
	<200701251334.07129.gene.heskett@verizon.net>
Message-ID: <200701260038.35850.ubq7@stud.uni-karlsruhe.de>

Am Donnerstag 25 Januar 2007 19:34 schrieb Gene Heskett:
> >NM in FC5 and FC6 should offer you the option of storing the key in the
> >gnome-keyring. ?Maybe you don't have the gnome-keyring package
> >installed?
> >
> >This is assuming you're running gnome, not exactly sure how this works
> >in KDE.
>
> I hate to admit it, but this may be one place where gnome is ahead of kde
> in that case.

Hmm, no. Kwallet is used by knetworkmanager and kwallet exists for quite some 
time ;)
Gnome is never ahead of KDE ;-P

HS


From gene.heskett at verizon.net  Fri Jan 26 04:03:58 2007
From: gene.heskett at verizon.net (Gene Heskett)
Date: Thu, 25 Jan 2007 22:03:58 -0500
Subject: [RFC PATCH] bcm43xx: set channel when the interface is
	=?utf-8?q?brought=09up?=
In-Reply-To: <200701260038.35850.ubq7@stud.uni-karlsruhe.de>
References: <1169707854.10593.41.camel@dv>
	<200701251334.07129.gene.heskett@verizon.net>
	<200701260038.35850.ubq7@stud.uni-karlsruhe.de>
Message-ID: <200701252203.58906.gene.heskett@verizon.net>

On Thursday 25 January 2007 18:38, Hendrik Sattler wrote:
>Am Donnerstag 25 Januar 2007 19:34 schrieb Gene Heskett:
>> >NM in FC5 and FC6 should offer you the option of storing the key in
>> > the gnome-keyring. ?Maybe you don't have the gnome-keyring package
>> > installed?
>> >
>> >This is assuming you're running gnome, not exactly sure how this
>> > works in KDE.
>>
>> I hate to admit it, but this may be one place where gnome is ahead of
>> kde in that case.
>
>Hmm, no. Kwallet is used by knetworkmanager and kwallet exists for quite
> some time ;)
>Gnome is never ahead of KDE ;-P
>
Well, lets see, I'm hitting the power button to turn it on now. Booting 
2.6.18-01.2257
No problems indicated when it brought up wlan0 during the boot.
Scanning output to tty0.  Every 20 seconds it appears.
logged in.  Ping this box. Network is unreachable.  And none of that stuff 
wants to run before X is started, so I just did.  It looks normal, and 
knetworkmanager's icon in the tray has a red X.

Clicking on it.  It displays 2 essids. I click on mine.  Kwallet password 
requester opens up.  I enter roots pw, and knetworkmanagers main window 
opens, displaying the name and device, and a multiselector that defaults 
to WEP Passphase.  I change it to 'WEP 40/104-bit hex', and change the 
Authentication multiselector to 'shared key' and click on Show 
credentials.  There is no 'save to wallet' option anywhere in this 
window.  Next I have to grab another shell, and do 
a 'cat /etc/sysconfig/network-scripts/keys-wlan0'  This file contains 4 
keys, with key=duplicate of key1.  I grab that top key with a mouseover, 
paste it into the KEY line of that screen which unghosts the connect 
button.  I click on it, there being no other buttons showing.

That window closes and the Activation progress display opens, it goes thru 
the connection setup and I'm connected.  No place in this dialog am I 
offered the chance to save it in the wallet, and once I've given it the 
password the only thing left is the wallet icon, showing opened, in the 
system tray.  And apparently noplace in the wallet is the correct 
settings for the multiselectors saved.

Saved as an .xml file, its fubared IMO. This is it:
-----------------
<wallet name="kdewallet">
  <folder name="knetworkmanager">
    <map name="my ESSID string">
      <mapentry name="password">my KEY</mapentry>
    </map>
  </folder>
</wallet>
------------------
Clicking on it, I see 2 wallets, kdewallet and rootswallet.  To look at 
rootswallet, I had to enter the passwd again, and when displayed, there 
is only the forms templates.

When I click on kdewallet, there is a knetworkmanager entry, and it 
contains the essid and the key I entered as an ESSID->password entry and 
its correct.  Since rootswallet is empty, I just deleted it.

So, the storage portion seems to be working, now the question is, why is 
it not being used once I give it a valid passwd?

See the above xml file, that doesn't look right to me.

Under passwords in kdewallet, a right click lets me add a new one, I name 
root, and click OK.  But that enters a password of root apparently so I 
delete it.  Then I change the existing passwd just to refresh it, but 
that window on the right never asks me if I want to see it in plaintext, 
which it did when I'd added a new one.

I'm plumb bummfuzzeld, this is a pita having to reconfigure and re-enter 
the proper configuration and key everytime...

-- 
Cheers, Gene
"There are four boxes to be used in defense of liberty:
 soap, ballot, jury, and ammo. Please use in that order."
-Ed Howdershelt (Author)
Yahoo.com and AOL/TW attorneys please note, additions to the above
message by Gene Heskett are:
Copyright 2007 by Maurice Eugene Heskett, all rights reserved.


From joerg at alea.gnuu.de  Fri Jan 26 07:30:44 2007
From: joerg at alea.gnuu.de (=?iso-8859-1?Q?J=F6rg?= Sommer)
Date: Fri, 26 Jan 2007 07:30:44 +0100
Subject: wpasupplicant says: Driver did not support SIOCSIWENCODEEXT
Message-ID: <20070126063044.GB19558@alea.gnuu.de>

Good morning,

I want to connect to a WPA-EPA-TTLS encrypted network, but wpasupplicant
(0.5.7) says: Driver did not support SIOCSIWENCODEEXT. What does he mean?
Can someone read the wpa_supplicant log and see why it can't connect to
the network?

http://www.minet.uni-jena.de/~joergs/wlan16.wpa_s

Have a nice day, J?rg.
-- 
Gott hat den Menschen erschaffen, weil er vom Affen entt?uscht war.
Danach hat er auf weitere Experimente verzichtet.
                                                          (Mark Twain)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 481 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/e5231492/attachment.pgp>

From mb at bu3sch.de  Fri Jan 26 10:01:20 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 26 Jan 2007 10:01:20 +0100
Subject: [PATCH] bcm43xx-d80211: Interrogate hardware-enable switch and
	update LEDs
In-Reply-To: <20070126024451.GK10282@tuxdriver.com>
References: <459749bb.q8/+AsgXLhurTs3u%Larry.Finger@lwfinger.net>
	<20070126024451.GK10282@tuxdriver.com>
Message-ID: <200701261001.20677.mb@bu3sch.de>

On Friday 26 January 2007 03:44, John W. Linville wrote:
> On Sat, Dec 30, 2006 at 11:25:15PM -0600, Larry Finger wrote:
> > The current bcm43xx driver ignores any wireless-enable switches on mini-PCI
> > and mini-PCI-E cards. This patch implements a new routine to interrogate the
> > radio hardware enabled bit in the interface, logs the initial state and any
> > changes in the switch (if debugging enabled), activates the LED to show the
> > state, and changes the periodic work handler to provide 1 second response
> > to switch changes and to account for changes in the periodic work specs. It
> > also incorporates changes in the LED state that were accepted into mainline
> > some time ago.
> 
> Larry,
> 
> I wanted to merge this, but a slew of changes pulled from Michael
> makes this patch fail to apply.

Hm? What did you pull?

-- 
Greetings Michael.


From johannes at sipsolutions.net  Fri Jan 26 14:45:20 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 26 Jan 2007 14:45:20 +0100
Subject: [RFC PATCH] bcm43xx: set channel when the interface is brought up
In-Reply-To: <200701250934.51302.gene.heskett@verizon.net>
References: <1169707854.10593.41.camel@dv>
	<200701250905.33129.gene.heskett@verizon.net>
	<20070125152321.434bb17c@griffin.suse.cz>
	<200701250934.51302.gene.heskett@verizon.net>
Message-ID: <1169819120.15413.3.camel@johannes.berg>

On Thu, 2007-01-25 at 09:34 -0500, Gene Heskett wrote:

> MLME?  More acronyms I've not put in my wet dictionary.. :)

The 802.11 specs have a huge list of acronyms you might want to be
somewhat familiar with. I think I have a printout somewhere, can't ever
remember them either ;)

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/7e9f086b/attachment.pgp>

From johannes at sipsolutions.net  Fri Jan 26 13:51:15 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 26 Jan 2007 13:51:15 +0100
Subject: USB device protocol
Message-ID: <1169815875.15413.1.camel@johannes.berg>

Interesting. I looked at the USB dump a bit and compared it to the RNDIS
structures in the Linux rndis gadget driver... The device is a fullmac
device using 802.3 framing.

Most of the interesting things are apparently done via private OIDs and
variables...

Attached are three files to dump the data. If you have a snoopy pro
export log, use:

./rndis-dump.py < SnoopyProExport.log | less

For other logs, this'll need to be adjusted...
You can also give --xml as a command line parameter, then it'll replace
the <payloadbytes> tag contents only instead of stripping all the xml.

If anyone else wants to reverse engineer this protocol I'll send him my
device. Probably not really too hard to do, but absolutely not what I
expected -- I had expected a custom proprietary access interface to the
registers. I'm not too inclined to look at it much as it's a completely
different device. Based on the variables they send to the device, I'd
think they have their driver running on it.

Have fun,
johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rndis.py
Type: text/x-python
Size: 6258 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/7d73fd77/attachment.py>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rndis-dump.py
Type: text/x-python
Size: 1088 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/7d73fd77/attachment-0001.py>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rndis_oids.py
Type: text/x-python
Size: 5971 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/7d73fd77/attachment-0002.py>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/7d73fd77/attachment.pgp>

From mjg59 at srcf.ucam.org  Fri Jan 26 14:51:27 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 26 Jan 2007 13:51:27 +0000
Subject: [RFC PATCH 1/2] Rename V4 firmware
Message-ID: <20070126135127.GA3050@srcf.ucam.org>

The dscape driver requires v4 firmware, while the mainline driver 
prefers v3. Giving the two different names makes it easier to support 
parallel installation. This patches fwcutter to dump v4 firmware with a 
different name - the second patch alters the dscape driver to request 
it.

Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>

---

diff -urp bcm43xx-fwcutter-006/fwcutter.c bcm43xx-fwcutter-006.new/fwcutter.c
--- bcm43xx-fwcutter-006/fwcutter.c	2006-12-08 21:00:28.000000000 +0000
+++ bcm43xx-fwcutter-006.new/fwcutter.c	2007-01-26 13:42:08.000000000 +0000
@@ -28,6 +28,7 @@
 
 static struct cmdline_args cmdargs;
 int big_endian_cpu;
+int v4_firmware;
 
 static void write_little_endian(FILE *f, byte *buffer, int len, uint8_t flags) 
 {
@@ -110,11 +111,18 @@ static void write_iv(uint8_t flags, uint
 				ivnum = 0;
 		}
 
-		snprintf(ivfilename, sizeof(ivfilename),
-			 "%s/bcm43xx_initval%02d%s.fw",
-			 cmdargs.target_dir,
-			 ivnum,
-			 cmdargs.postfix);
+		if (v4_firmware) 
+			snprintf(ivfilename, sizeof(ivfilename),
+				 "%s/bcm43xx_v4_initval%02d%s.fw",
+				 cmdargs.target_dir,
+				 ivnum,
+				 cmdargs.postfix);
+		else
+			snprintf(ivfilename, sizeof(ivfilename),
+				 "%s/bcm43xx_initval%02d%s.fw",
+				 cmdargs.target_dir,
+				 ivnum,
+				 cmdargs.postfix);
 
 		/* don't extract initval 0 */
 		if ( ivnum == 0 ) {
@@ -289,16 +297,27 @@ static void extract_fw(uint8_t fwtype, u
 	case FIRMWARE_UCODE_5:
 	case FIRMWARE_UCODE_11:
 	case FIRMWARE_UCODE_13:
-		snprintf(outfile, sizeof(outfile), "bcm43xx_microcode%i%s.fw", 
-			 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
+		if (v4_firmware)
+			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_microcode%i%s.fw", 
+				 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
+		else
+			snprintf(outfile, sizeof(outfile), "bcm43xx_microcode%i%s.fw", 
+				 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
 		break;
 	case FIRMWARE_PCM_4:
 	case FIRMWARE_PCM_5:
-		snprintf(outfile, sizeof(outfile), "bcm43xx_pcm%i%s.fw", 
-			 fwtype, cmdargs.postfix);
+		if (v4_firmware)
+			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_pcm%i%s.fw", 
+				 fwtype, cmdargs.postfix);
+		else
+			snprintf(outfile, sizeof(outfile), "bcm43xx_pcm%i%s.fw", 
+				 fwtype, cmdargs.postfix);
 		break;
 	default:
-		snprintf(outfile, sizeof(outfile), "bcm43xx_unknown.fw");
+		if (v4_firmware)
+			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_unknown.fw");
+		else
+			snprintf(outfile, sizeof(outfile), "bcm43xx_unknown.fw");
 	}
 
 	if (length > 0) {
@@ -577,6 +596,7 @@ static const struct file * find_file(FIL
 				       "(wireless-dev kernel tree). If you don't know what \n"
 				       "this warning is about, use a 3.xx.xx.xx driver version \n"
 				       "instead to extract the firmware.\n");
+				v4_firmware = 1;
 			}
 			printf("\n  filename   :  %s\n", files[i].name);
 			printf("  version    :  %s\n", files[i].version);

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mjg59 at srcf.ucam.org  Fri Jan 26 14:53:18 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 26 Jan 2007 13:53:18 +0000
Subject: [RFC PATCH 2/2] Rename V4 firmware
In-Reply-To: <20070126135127.GA3050@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
Message-ID: <20070126135318.GB3050@srcf.ucam.org>

This patch alters the dscape version of the bcm43xx driver to explicitly 
request version 4 firmware.

Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>

---
diff --git a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
index 9f4d51d..4f11ce8 100644
--- a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
+++ b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
@@ -1544,7 +1544,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
 	char buf[22 + sizeof(modparam_fwpostfix) - 1] = { 0 };
 
 	if (!phy->ucode) {
-		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_microcode%d%s.fw",
+		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_microcode%d%s.fw",
 			 (rev >= 5 ? 5 : rev),
 			 modparam_fwpostfix);
 		err = request_firmware(&phy->ucode, buf, &dev->dev->dev);
@@ -1558,7 +1558,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
 
 	if (!phy->pcm) {
 		snprintf(buf, ARRAY_SIZE(buf),
-			 "bcm43xx_pcm%d%s.fw",
+			 "bcm43xx_v4_pcm%d%s.fw",
 			 (rev < 5 ? 4 : 5),
 			 modparam_fwpostfix);
 		err = request_firmware(&phy->pcm, buf, &dev->dev->dev);
@@ -1598,7 +1598,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
 			}
 		} else
 			goto err_noinitval;
-		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_initval%02d%s.fw",
+		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_initval%02d%s.fw",
 			 nr, modparam_fwpostfix);
 
 		err = request_firmware(&phy->initvals0, buf, &dev->dev->dev);
@@ -1633,7 +1633,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
 			default:
 				goto err_noinitval;
 			}
-			snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_initval%02d%s.fw",
+			snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_initval%02d%s.fw",
 				 nr, modparam_fwpostfix);
 
 			err = request_firmware(&phy->initvals1, buf, &dev->dev->dev);


-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From larry.finger at lwfinger.net  Fri Jan 26 16:42:29 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 09:42:29 -0600
Subject: wpasupplicant says: Driver did not support SIOCSIWENCODEEXT
In-Reply-To: <20070126063044.GB19558@alea.gnuu.de>
References: <20070126063044.GB19558@alea.gnuu.de>
Message-ID: <45BA2165.3080701@lwfinger.net>

J?rg Sommer wrote:
> Good morning,
> 
> I want to connect to a WPA-EPA-TTLS encrypted network, but wpasupplicant
> (0.5.7) says: Driver did not support SIOCSIWENCODEEXT. What does he mean?
> Can someone read the wpa_supplicant log and see why it can't connect to
> the network?

Could we please have more details such as distro, kernel version, and an extract of the wireless
details from dmesg? The SIOCSIWENCODEEXT wireless-extension support has been in bcm43xx for a very
long time. I cannot recall seeing that anyone has used WPA-EPA-TTLs; however, a number of people, me
included, are using WPA-PSK TKIP, which also relies on the SIOCSIWENCODEEXT call.

Larry


From larry.finger at lwfinger.net  Fri Jan 26 16:49:15 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 09:49:15 -0600
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070126135127.GA3050@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
Message-ID: <45BA22FB.5050008@lwfinger.net>

Matthew Garrett wrote:
> The dscape driver requires v4 firmware, while the mainline driver 
> prefers v3. Giving the two different names makes it easier to support 
> parallel installation. This patches fwcutter to dump v4 firmware with a 
> different name - the second patch alters the dscape driver to request 
> it.
> 
> Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>

NACK. The --postfix switch for fwcutter, and the postfix option for bcm43xx-d80211 driver handle
this case perfectly well.

Larry



From larry.finger at lwfinger.net  Fri Jan 26 16:55:23 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 09:55:23 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>
Message-ID: <45BA246B.6030505@lwfinger.net>

roucaries bastien wrote:
>> Do you have the log stuff that precedes this part? In particular, was
>> there a assertion that failed?
>>
> It is oops on resume and no asseertion failled this boot. However I
> have usually a lot of
> bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at:
> drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()

Those are well known and do not affect this problem.

> Moreover after the first oops I have a second oops (Surelly a
> consequence of the first).

I think that is right.

Unfortunately, I cannot test for this problem on my system as it doesn't suspend at all.

Does this oops happen every time, or is it intermittent? I'm looking at the code to find places to
insert debugging statements. At present, I don't understand how it gets to the shutdown code while
resuming!

Larry




From mjg59 at srcf.ucam.org  Fri Jan 26 17:01:16 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 26 Jan 2007 16:01:16 +0000
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <45BA22FB.5050008@lwfinger.net>
References: <20070126135127.GA3050@srcf.ucam.org>
	<45BA22FB.5050008@lwfinger.net>
Message-ID: <20070126160116.GA5326@srcf.ucam.org>

On Fri, Jan 26, 2007 at 09:49:15AM -0600, Larry Finger wrote:

> NACK. The --postfix switch for fwcutter, and the postfix option for bcm43xx-d80211 driver handle
> this case perfectly well.

It would be helpful to standardise - the default behaviour at the moment 
makes the upgrade path difficult. The alternative is that distributions 
are going to have to ship modprobe.d files for the dscape driver, which 
will probably result in different vendors choosing different suffixes. 
The two firmwares are incompatible in any meaningful way, so surely they 
should have different names?

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From larry.finger at lwfinger.net  Fri Jan 26 17:15:52 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 10:15:52 -0600
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070126160116.GA5326@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>	<45BA22FB.5050008@lwfinger.net>
	<20070126160116.GA5326@srcf.ucam.org>
Message-ID: <45BA2938.9030307@lwfinger.net>

Matthew Garrett wrote:
> On Fri, Jan 26, 2007 at 09:49:15AM -0600, Larry Finger wrote:
> 
>> NACK. The --postfix switch for fwcutter, and the postfix option for bcm43xx-d80211 driver handle
>> this case perfectly well.
> 
> It would be helpful to standardise - the default behaviour at the moment 
> makes the upgrade path difficult. The alternative is that distributions 
> are going to have to ship modprobe.d files for the dscape driver, which 
> will probably result in different vendors choosing different suffixes. 
> The two firmwares are incompatible in any meaningful way, so surely they 
> should have different names?

At present, the firmware is the intellectual property of Broadcom, and I doubt that any distro is
going to ship it. AFAIK, it will always be the responsibility of the user to acquire a binary driver
and install their own firmware. Of course, if the reverse engineering of the firmware also succeeds,
then the picture changes.

Larry



From martin-langer at gmx.de  Fri Jan 26 18:44:19 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Fri, 26 Jan 2007 18:44:19 +0100
Subject: [RFC PATCH 2/2] Rename V4 firmware
In-Reply-To: <20070126135318.GB3050@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<20070126135318.GB3050@srcf.ucam.org>
Message-ID: <20070126174419.GA3518@tuba>

On Fri, Jan 26, 2007 at 01:53:18PM +0000, Matthew Garrett wrote:

> This patch alters the dscape version of the bcm43xx driver to explicitly 
> request version 4 firmware.

> -			 "bcm43xx_pcm%d%s.fw",
> +			 "bcm43xx_v4_pcm%d%s.fw",

There's no difference between pcm files v3 and v4. They are 
identical. For all versions from 3.90 up to 4.102 you will get the 
same pcm file from the broadcom binaries.

Martin


From martin-langer at gmx.de  Fri Jan 26 18:49:48 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Fri, 26 Jan 2007 18:49:48 +0100
Subject: USB device protocol
In-Reply-To: <1169815875.15413.1.camel@johannes.berg>
References: <1169815875.15413.1.camel@johannes.berg>
Message-ID: <20070126174948.GB3518@tuba>

On Fri, Jan 26, 2007 at 01:51:15PM +0100, Johannes Berg wrote:

> If you have a snoopy pro

Be careful. Last time I played with SnoopyPro it didn't save the whole 
traffic. So, usbsnoopy was a better choice for me.

Martin


From johannes at sipsolutions.net  Fri Jan 26 19:14:18 2007
From: johannes at sipsolutions.net (Johannes Berg)
Date: Fri, 26 Jan 2007 19:14:18 +0100
Subject: USB device protocol
In-Reply-To: <20070126174948.GB3518@tuba>
References: <1169815875.15413.1.camel@johannes.berg>
	<20070126174948.GB3518@tuba>
Message-ID: <1169835258.15413.15.camel@johannes.berg>

On Fri, 2007-01-26 at 18:49 +0100, Martin Langer wrote:
> On Fri, Jan 26, 2007 at 01:51:15PM +0100, Johannes Berg wrote:
> 
> > If you have a snoopy pro
> 
> Be careful. Last time I played with SnoopyPro it didn't save the whole 
> traffic. So, usbsnoopy was a better choice for me.

Joe created the logs, I don't have either. But the script should be
trivial to change for other output as long as the output contains
hexdumps of the data.

johannes
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 190 bytes
Desc: This is a digitally signed message part
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070126/8e5a6a99/attachment.pgp>

From larry.finger at lwfinger.net  Fri Jan 26 19:55:58 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 12:55:58 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900701261028w35961506wc15280b3faa86d82@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>	
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>	
	<45BA246B.6030505@lwfinger.net>
	<195c7a900701261028w35961506wc15280b3faa86d82@mail.gmail.com>
Message-ID: <45BA4EBE.4000204@lwfinger.net>

roucaries bastien wrote:
> On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>> roucaries bastien wrote:
>> >> Do you have the log stuff that precedes this part? In particular, was
>> >> there a assertion that failed?
>> >>
>> > It is oops on resume and no asseertion failled this boot. However I
>> > have usually a lot of
>> > bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at:
>> > drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
>>
>> Those are well known and do not affect this problem.
>>
>> > Moreover after the first oops I have a second oops (Surelly a
>> > consequence of the first).
>>
>> I think that is right.
>>
>> Unfortunately, I cannot test for this problem on my system as it
>> doesn't suspend at all.
>>
>> Does this oops happen every time, or is it intermittent? I'm looking
>> at the code to find places to
>> insert debugging statements. At present, I don't understand how it
>> gets to the shutdown code while
>> resuming!
> Perhaps because syslog log it after resume...
> I will investigate this evening

Thanks. One other thing to try is booting with the 'maxcpus=1' kernel option.

Larry


From mb at bu3sch.de  Fri Jan 26 20:30:57 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 26 Jan 2007 20:30:57 +0100
Subject: bcm43xx-d80211: remove_interface bug
In-Reply-To: <20070126165816.7d97cf3d@griffin.suse.cz>
References: <20070126165816.7d97cf3d@griffin.suse.cz>
Message-ID: <200701262030.57545.mb@bu3sch.de>

On Friday 26 January 2007 16:58, Jiri Benc wrote:
> (The latest wireless-dev tree. How to reproduce: associate (probably
> bringing the interface up is enough) and eject the cardbus card.)

Is this linville's tree or mine?
Either way, did you apply that DMA skb doublefree patch? It fixes
memory corruption, which could probablb cause this.

> wlan0: Initial auth_alg=0
> wlan0: authenticate with AP 00:11:2f:a2:96:da
> wlan0: RX authentication from 00:11:2f:a2:96:da (alg=0 transaction=2
> status=0) wlan0: authenticated
> wlan0: associate with AP 00:11:2f:a2:96:da
> wlan0: RX AssocResp from 00:11:2f:a2:96:da (capab=0x1 status=0 aid=3)
> wlan0: associated
> wmaster0: Added STA 00:11:2f:a2:96:da
> wlan0: CTS protection enabled (BSSID=00:11:2f:a2:96:da)
> pccard: card ejected from slot 0
> bcm43xx_d80211: Removing Interface type 2
> bcm43xx_d80211: ASSERTION FAILED (!dev->started) at:
> drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c:3255:bcm43xx_remove_interface()

But this assertion failure should not happen.
Do we call remove_interface after hw->stop was called? I did not
check d80211 code, but my assumption in the code is that
hw->open is always called after the first add_interface and hw->stop
is called before the last remove_interface. Is that a wrong assumption?
If yes, it should probably be fixed in the stack.

> BUG: unable to handle kernel paging request at virtual address 6b6b6b87
> printing eip: c0137202
> *pde = 00000000
> Oops: 0000 [#1]
> SMP 
> Modules linked in: arc4 ecb blkcipher rc80211_simple bcm43xx_d80211 ssb
> 80211 netconsole CPU:    0
> EIP:    0060:[<c0137202>]    Not tainted VLI
> EFLAGS: 00010046   (2.6.20-rc6-test #74)
> EIP is at __lock_acquire+0x42/0xe60
> eax: 00000002   ebx: 00000046   ecx: 00000000   edx: 00000000
> esi: 00000000   edi: 6b6b6b83   ebp: c1eafbcc   esp: c1eafb54
> ds: 007b   es: 007b   ss: 0068
> Process pccardd (pid: 797, ti=c1eae000 task=c1d34070 task.ti=c1eae000)
> Stack: c1e11eac c1eafb68 00000046 c1d34070 00000251 00000000 00000000
> 00000000 c03455c7 c1d34070 f70f5960 c1eafb8c c0272c2f 00000097 c1eafc04
> c0279278 00000000 00000000 c1d34070 c06b72c0 c1d34670 00000000 c1d345a8
> c1e11e44 Call Trace:
>  [<c0103f3a>] show_trace_log_lvl+0x1a/0x30
>  [<c0104006>] show_stack_log_lvl+0xb6/0x100
>  [<c010433f>] show_registers+0x1af/0x2b0
>  [<c0104691>] die+0x111/0x220
>  [<c03c4105>] do_page_fault+0x2c5/0x630
>  [<c03c2734>] error_code+0x7c/0x84
>  [<c0138397>] lock_acquire+0x57/0x70
>  [<c03c1f4c>] _spin_lock+0x2c/0x40
>  [<f8b4cf0c>] bcm43xx_interrupt_handler+0x1c/0x2f0 [bcm43xx_d80211]
>  [<c0141758>] handle_IRQ_event+0x28/0x60
>  [<c0143338>] handle_level_irq+0x88/0x120
>  [<c01051b4>] do_IRQ+0x64/0xc0
>  [<c01039d2>] common_interrupt+0x2e/0x34
>  [<c011c73b>] printk+0x1b/0x20
>  [<f8b485b5>] bcm43xx_remove_interface+0x185/0x190 [bcm43xx_d80211]
>  [<f8b2158e>] ieee80211_stop+0x6e/0x110 [80211]
>  [<c03452d4>] dev_close+0x44/0x90
>  [<c0345e90>] unregister_netdevice+0x170/0x210
>  [<f8b31d0c>] __ieee80211_if_del+0x1c/0x20 [80211]
>  [<f8b20aaa>] ieee80211_unregister_hw+0x8a/0x280 [80211]
>  [<f8b470d9>] bcm43xx_wireless_exit+0x19/0x40 [bcm43xx_d80211]
>  [<f8b4724a>] bcm43xx_remove+0x7a/0xc0 [bcm43xx_d80211]
>  [<f883819c>] ssb_device_remove+0x1c/0x30 [ssb]
>  [<c026bb3a>] __device_release_driver+0x6a/0x90
>  [<c026beb5>] device_release_driver+0x35/0x50
>  [<c026b348>] bus_remove_device+0x68/0x90
>  [<c0269c29>] device_del+0x189/0x1f0
>  [<c0269c9b>] device_unregister+0xb/0x20
>  [<f8838311>] ssb_bus_unregister+0x61/0xa0 [ssb]
>  [<f8b5b9f3>] bcm43xx_pci_remove+0x23/0x50 [bcm43xx_d80211]
>  [<c0203af9>] pci_device_remove+0x19/0x40
>  [<c026bb3a>] __device_release_driver+0x6a/0x90
>  [<c026beb5>] device_release_driver+0x35/0x50
>  [<c026b348>] bus_remove_device+0x68/0x90
>  [<c0269c29>] device_del+0x189/0x1f0
>  [<c0269c9b>] device_unregister+0xb/0x20
>  [<c0200846>] pci_stop_dev+0x26/0x60
>  [<c020090b>] pci_remove_bus_device+0x2b/0xa0
>  [<c02009aa>] pci_remove_behind_bridge+0x2a/0x40
>  [<c02c459a>] cb_free+0x1a/0x20
>  [<c02c0b07>] socket_shutdown+0x77/0xd0
>  [<c02c0cf6>] socket_remove+0x26/0x30
>  [<c02c144d>] pccardd+0x21d/0x250
>  [<c012f8ba>] kthread+0xda/0xe0
>  [<c0103c4b>] kernel_thread_helper+0x7/0x1c
>  =======================
> Code: 40 19 4c c0 89 4d a4 85 c0 0f 84 8a 04 00 00 9c 58 f6 c4 02 0f 85
> 13 0a 00 00 83 fa 07 0f 87 3c 0a 00 00 85 d2 0f 85 70 02 00 00 <8b> 57
> 04 85 d2 89 55 b0 0f 84 62 02 00 00 8b 45 b0 e8 88 de ff EIP:
> [<c0137202>] __lock_acquire+0x42/0xe60 SS:ESP 0068:c1eafb54 <0>Kernel
> panic - not syncing: Fatal exception in interrupt
> 
> 

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Fri Jan 26 21:56:52 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 14:56:52 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900701261243j2eddfa60h6e7bc76bdf1feefb@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>	
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>	
	<45BA246B.6030505@lwfinger.net>	
	<195c7a900701261028w35961506wc15280b3faa86d82@mail.gmail.com>	
	<45BA4EBE.4000204@lwfinger.net>
	<195c7a900701261243j2eddfa60h6e7bc76bdf1feefb@mail.gmail.com>
Message-ID: <45BA6B14.5070709@lwfinger.net>

roucaries bastien wrote:
> On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>> roucaries bastien wrote:
>> > On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>> >> roucaries bastien wrote:
>> >> >> Do you have the log stuff that precedes this part? In
>> particular, was
>> >> >> there a assertion that failed?
>> >> >>
>> >> > It is oops on resume and no asseertion failled this boot. However I
>> >> > have usually a lot of
>> >> > bcm43xx: ASSERTION FAILED (radio_attenuation < 10) at:
>> >> >
>> drivers/net/wireless/bcm43xx/bcm43xx_phy.c:1496:bcm43xx_find_lopair()
>> >>
>> >> Those are well known and do not affect this problem.
>> >>
>> >> > Moreover after the first oops I have a second oops (Surelly a
>> >> > consequence of the first).
>> >>
>> >> I think that is right.
>> >>
>> >> Unfortunately, I cannot test for this problem on my system as it
>> >> doesn't suspend at all.
>> >>
>> >> Does this oops happen every time, or is it intermittent? I'm looking
>> >> at the code to find places to
>> >> insert debugging statements. At present, I don't understand how it
>> >> gets to the shutdown code while
>> >> resuming!
>> > Perhaps because syslog log it after resume...
>> > I will investigate this evening
> 
> Her the crash scenario:
> o suspend to disk (s2disk)
> o down the wifi card
> o oopps all the time
> Therefore it llok like a bad reinitialisation...

Does it help to down the wifi card before the s2disk?

Larry


From mb at bu3sch.de  Fri Jan 26 21:59:19 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 26 Jan 2007 21:59:19 +0100
Subject: [RFC PATCH 2/2] Rename V4 firmware
In-Reply-To: <20070126135318.GB3050@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<20070126135318.GB3050@srcf.ucam.org>
Message-ID: <200701262159.19297.mb@bu3sch.de>

On Friday 26 January 2007 14:53, Matthew Garrett wrote:
> This patch alters the dscape version of the bcm43xx driver to explicitly 
> request version 4 firmware.

NACK.
Use "fwpostfix" module parameter.
This patch as absolutely zero chance to get in.

> Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>
> 
> ---
> diff --git a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
> index 9f4d51d..4f11ce8 100644
> --- a/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
> +++ b/drivers/net/wireless/d80211/bcm43xx/bcm43xx_main.c
> @@ -1544,7 +1544,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
>  	char buf[22 + sizeof(modparam_fwpostfix) - 1] = { 0 };
>  
>  	if (!phy->ucode) {
> -		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_microcode%d%s.fw",
> +		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_microcode%d%s.fw",
>  			 (rev >= 5 ? 5 : rev),
>  			 modparam_fwpostfix);
>  		err = request_firmware(&phy->ucode, buf, &dev->dev->dev);
> @@ -1558,7 +1558,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
>  
>  	if (!phy->pcm) {
>  		snprintf(buf, ARRAY_SIZE(buf),
> -			 "bcm43xx_pcm%d%s.fw",
> +			 "bcm43xx_v4_pcm%d%s.fw",
>  			 (rev < 5 ? 4 : 5),
>  			 modparam_fwpostfix);
>  		err = request_firmware(&phy->pcm, buf, &dev->dev->dev);
> @@ -1598,7 +1598,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
>  			}
>  		} else
>  			goto err_noinitval;
> -		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_initval%02d%s.fw",
> +		snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_initval%02d%s.fw",
>  			 nr, modparam_fwpostfix);
>  
>  		err = request_firmware(&phy->initvals0, buf, &dev->dev->dev);
> @@ -1633,7 +1633,7 @@ static int bcm43xx_request_firmware(struct bcm43xx_wldev *dev)
>  			default:
>  				goto err_noinitval;
>  			}
> -			snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_initval%02d%s.fw",
> +			snprintf(buf, ARRAY_SIZE(buf), "bcm43xx_v4_initval%02d%s.fw",
>  				 nr, modparam_fwpostfix);
>  
>  			err = request_firmware(&phy->initvals1, buf, &dev->dev->dev);
> 
> 

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jan 26 22:00:42 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 26 Jan 2007 22:00:42 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070126135127.GA3050@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
Message-ID: <200701262200.42663.mb@bu3sch.de>

On Friday 26 January 2007 14:51, Matthew Garrett wrote:
> The dscape driver requires v4 firmware, while the mainline driver 
> prefers v3. Giving the two different names makes it easier to support 
> parallel installation. This patches fwcutter to dump v4 firmware with a 
> different name - the second patch alters the dscape driver to request 
> it.

NACK.
Learn about "fwpostfix" module parameter.
Besides that, this patch is buggy.

> Signed-off-by: Matthew Garrett <mjg59 at srcf.ucam.org>
> 
> ---
> 
> diff -urp bcm43xx-fwcutter-006/fwcutter.c bcm43xx-fwcutter-006.new/fwcutter.c
> --- bcm43xx-fwcutter-006/fwcutter.c	2006-12-08 21:00:28.000000000 +0000
> +++ bcm43xx-fwcutter-006.new/fwcutter.c	2007-01-26 13:42:08.000000000 +0000
> @@ -28,6 +28,7 @@
>  
>  static struct cmdline_args cmdargs;
>  int big_endian_cpu;
> +int v4_firmware;
>  
>  static void write_little_endian(FILE *f, byte *buffer, int len, uint8_t flags) 
>  {
> @@ -110,11 +111,18 @@ static void write_iv(uint8_t flags, uint
>  				ivnum = 0;
>  		}
>  
> -		snprintf(ivfilename, sizeof(ivfilename),
> -			 "%s/bcm43xx_initval%02d%s.fw",
> -			 cmdargs.target_dir,
> -			 ivnum,
> -			 cmdargs.postfix);
> +		if (v4_firmware) 
> +			snprintf(ivfilename, sizeof(ivfilename),
> +				 "%s/bcm43xx_v4_initval%02d%s.fw",
> +				 cmdargs.target_dir,
> +				 ivnum,
> +				 cmdargs.postfix);
> +		else
> +			snprintf(ivfilename, sizeof(ivfilename),
> +				 "%s/bcm43xx_initval%02d%s.fw",
> +				 cmdargs.target_dir,
> +				 ivnum,
> +				 cmdargs.postfix);
>  
>  		/* don't extract initval 0 */
>  		if ( ivnum == 0 ) {
> @@ -289,16 +297,27 @@ static void extract_fw(uint8_t fwtype, u
>  	case FIRMWARE_UCODE_5:
>  	case FIRMWARE_UCODE_11:
>  	case FIRMWARE_UCODE_13:
> -		snprintf(outfile, sizeof(outfile), "bcm43xx_microcode%i%s.fw", 
> -			 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
> +		if (v4_firmware)
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_microcode%i%s.fw", 
> +				 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
> +		else
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_microcode%i%s.fw", 
> +				 fwtype - FIRMWARE_UCODE_OFFSET, cmdargs.postfix);
>  		break;
>  	case FIRMWARE_PCM_4:
>  	case FIRMWARE_PCM_5:
> -		snprintf(outfile, sizeof(outfile), "bcm43xx_pcm%i%s.fw", 
> -			 fwtype, cmdargs.postfix);
> +		if (v4_firmware)
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_pcm%i%s.fw", 
> +				 fwtype, cmdargs.postfix);
> +		else
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_pcm%i%s.fw", 
> +				 fwtype, cmdargs.postfix);
>  		break;
>  	default:
> -		snprintf(outfile, sizeof(outfile), "bcm43xx_unknown.fw");
> +		if (v4_firmware)
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_v4_unknown.fw");
> +		else
> +			snprintf(outfile, sizeof(outfile), "bcm43xx_unknown.fw");
>  	}
>  
>  	if (length > 0) {
> @@ -577,6 +596,7 @@ static const struct file * find_file(FIL
>  				       "(wireless-dev kernel tree). If you don't know what \n"
>  				       "this warning is about, use a 3.xx.xx.xx driver version \n"
>  				       "instead to extract the firmware.\n");
> +				v4_firmware = 1;
>  			}
>  			printf("\n  filename   :  %s\n", files[i].name);
>  			printf("  version    :  %s\n", files[i].version);
> 

-- 
Greetings Michael.


From mb at bu3sch.de  Fri Jan 26 22:03:03 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Fri, 26 Jan 2007 22:03:03 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070126160116.GA5326@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<45BA22FB.5050008@lwfinger.net>
	<20070126160116.GA5326@srcf.ucam.org>
Message-ID: <200701262203.04084.mb@bu3sch.de>

On Friday 26 January 2007 17:01, Matthew Garrett wrote:
> On Fri, Jan 26, 2007 at 09:49:15AM -0600, Larry Finger wrote:
> 
> > NACK. The --postfix switch for fwcutter, and the postfix option for bcm43xx-d80211 driver handle
> > this case perfectly well.
> 
> It would be helpful to standardise - the default behaviour at the moment 
> makes the upgrade path difficult. The alternative is that distributions 
> are going to have to ship modprobe.d files for the dscape driver, which 
> will probably result in different vendors choosing different suffixes. 
> The two firmwares are incompatible in any meaningful way, so surely they 
> should have different names?

It _is_ standardized.
bcm43xx-softmac only supports v3, bcm43xx-d80211 only supports v4.
So if you want to use both drivers in parallel, use fwpostfix modparam
and install both firmware with different postfix (I use .v3 and .v4 postfix).

-- 
Greetings Michael.


From pmarks at purdue.edu  Fri Jan 26 22:31:33 2007
From: pmarks at purdue.edu (Paul Marks)
Date: Fri, 26 Jan 2007 16:31:33 -0500
Subject: BCM4311 and Hidden SSIDs?
Message-ID: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>

I have a BCM4311 card, and ever since the PCI-E interrupts patch, I've been
able to associate just fine with my own WPA2-PSK access point, using
wpa_supplicant with ap_scan=1.

However, the access points at my school (Purdue) are all WPA-Enterprise with
a hidden SSID, and I so far haven't had any luck getting bcm43xx to connect
to these.  If I use ndiswrapper instead, then these APs work as expected.

Am I doing something wrong, or is this a limitation in the driver?  Has
anyone gotten bcm43xx to work in a hidden-SSID situation?


Here's my wpa_supplicant.conf:

ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=wheel

ap_scan=2
fast_reauth=1

network={
  ssid="PAL2.0"
  proto=WPA
  key_mgmt=WPA-EAP
  pairwise=TKIP
  group=TKIP
  eap=PEAP
  ca_cert="/etc/ssl/certs/ca-certificates.crt"
  identity="pmarks"
  password="..."
}


Here's the output from wpa_supplicant:

# wpa_supplicant -ieth1 -Dwext -c /etc/wpa_supplicant/wpa_supplicant.conf
-dd
Initializing interface 'eth1' conf '/etc/wpa_supplicant/wpa_supplicant.conf'
driver 'wext' ctrl_interface 'N/A' bridge 'N/A'
Configuration file '/etc/wpa_supplicant/wpa_supplicant.conf' ->
'/etc/wpa_supplicant/wpa_supplicant.conf'
Reading configuration file '/etc/wpa_supplicant/wpa_supplicant.conf'
ctrl_interface='/var/run/wpa_supplicant'
ctrl_interface_group='wheel' (DEPRECATED)
ap_scan=2
fast_reauth=1
Line: 10 - start of a new network block
ssid - hexdump_ascii(len=6):
     50 41 4c 32 2e 30                                 PAL2.0
proto: 0x1
key_mgmt: 0x1
pairwise: 0x8
group: 0x8
eap methods - hexdump(len=16): 00 00 00 00 19 00 00 00 00 00 00 00 00 00 00
00
ca_cert - hexdump_ascii(len=34):
     2f 65 74 63 2f 73 73 6c 2f 63 65 72 74 73 2f 63   /etc/ssl/certs/c
     61 2d 63 65 72 74 69 66 69 63 61 74 65 73 2e 63   a-certificates.c
     72 74                                             rt
identity - hexdump_ascii(len=6):
     70 6d 61 72 6b 73                                 pmarks
password - hexdump_ascii(len=8): [REMOVED]
Priority group 0
   id=0 ssid='PAL2.0'
Initializing interface (2) 'eth1'
EAPOL: SUPP_PAE entering state DISCONNECTED
EAPOL: KEY_RX entering state NO_KEY_RECEIVE
EAPOL: SUPP_BE entering state INITIALIZE
EAP: EAP entering state DISABLED
EAPOL: External notification - portEnabled=0
EAPOL: External notification - portValid=0
SIOCGIWRANGE: WE(compiled)=21 WE(source)=18 enc_capa=0xf
  capabilities: key_mgmt 0xf enc 0xf
WEXT: Operstate: linkmode=1, operstate=5
Own MAC address: 00:16:cf:8f:61:00
wpa_driver_wext_set_wpa
wpa_driver_wext_set_key: alg=0 key_idx=0 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=1 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=2 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=3 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_countermeasures
wpa_driver_wext_set_drop_unencrypted
Setting scan request: 0 sec 100000 usec
ctrl_interface_group=10 (from group name 'wheel')
Added interface eth1
RTM_NEWLINK: operstate=0 ifi_flags=0x1002 ()
Wireless event: cmd=0x8b06 len=8
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'eth1' added
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'eth1' added
State: DISCONNECTED -> SCANNING
Trying to associate with SSID 'PAL2.0'
Cancelling scan request
WPA: clearing own WPA/RSN IE
Automatic auth_alg selection: 0x1
WPA: No WPA/RSN IE available from association info
WPA: Set cipher suites based on configuration
WPA: Selected cipher suites: group 8 pairwise 8 key_mgmt 1 proto 1
WPA: clearing AP WPA IE
WPA: clearing AP RSN IE
WPA: using GTK TKIP
WPA: using PTK TKIP
WPA: using KEY_MGMT 802.1X
WPA: Set own WPA IE default - hexdump(len=24): dd 16 00 50 f2 01 01 00 00 50
f2 02 01 00 00 50 f2 02 01 00 00 50 f2 01
No keys have been configured - skip key clearing
wpa_driver_wext_set_drop_unencrypted
State: SCANNING -> ASSOCIATING
wpa_driver_wext_set_operstate: operstate 0->0 (DORMANT)
WEXT: Operstate: linkmode=-1, operstate=5
wpa_driver_wext_associate
Setting authentication timeout: 60 sec 0 usec
EAPOL: External notification - portControl=Auto
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8b06 len=8
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8b1a len=14
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8b19 len=8
ioctl[SIOCGIWSCAN]: Resource temporarily unavailable
Scan results: -1
Failed to get scan results
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8b19 len=8
ioctl[SIOCGIWSCAN]: Resource temporarily unavailable
Scan results: -1
Failed to get scan results
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8b19 len=8
Received 154 bytes of scan results (1 BSSes)
Scan results: 1
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
Wireless event: cmd=0x8c02 len=64
WEXT: Custom wireless event: 'associating failed because no suitable network
was found'


And here's my dmesg output during that time:

bcm43xx driver
ACPI: PCI Interrupt 0000:0c:00.0[A] -> GSI 17 (level, low) -> IRQ 17
PCI: Setting latency timer of device 0000:0c:00.0 to 64
bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x123, pl 0x23 (2005-03-22  00:11:18)
bcm43xx: Radio turned on
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
ADDRCONF(NETDEV_UP): eth1: link is not ready
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: Unable to find matching network after scan!


From larry.finger at lwfinger.net  Fri Jan 26 23:05:15 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 16:05:15 -0600
Subject: BCM4311 and Hidden SSIDs?
In-Reply-To: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>
References: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>
Message-ID: <45BA7B1A.1040504@lwfinger.net>

Paul Marks wrote:
> I have a BCM4311 card, and ever since the PCI-E interrupts patch, I've been
> able to associate just fine with my own WPA2-PSK access point, using
> wpa_supplicant with ap_scan=1.
> 
> However, the access points at my school (Purdue) are all WPA-Enterprise with
> a hidden SSID, and I so far haven't had any luck getting bcm43xx to connect
> to these.  If I use ndiswrapper instead, then these APs work as expected.
> 
> Am I doing something wrong, or is this a limitation in the driver?  Has
> anyone gotten bcm43xx to work in a hidden-SSID situation?
> 
> 
> Here's my wpa_supplicant.conf:
> 
> ctrl_interface=/var/run/wpa_supplicant
> ctrl_interface_group=wheel
> 
> ap_scan=2
> fast_reauth=1
> 
> network={
>   ssid="PAL2.0"
>   proto=WPA
>   key_mgmt=WPA-EAP
>   pairwise=TKIP
>   group=TKIP
>   eap=PEAP
>   ca_cert="/etc/ssl/certs/ca-certificates.crt"
>   identity="pmarks"
>   password="..."
> }

It should work. I just hid my SSID and had no trouble seeing the AP when scanning nor any problem
with associating or authenticating.

How close are you to the AP at Purdue? The 4311's don't broadcast with much power and you might not
be in reach. I'm also not sure about the ap_scan=2 in your .conf file. Please try a value of 1.

One other thing to test. Once the system is trying to authenticate, do an 'iwlist s' command to see
if any scans are getting through. It doesn't seem as if they are, but this is another way to see.

Larry


From larry.finger at lwfinger.net  Fri Jan 26 23:25:21 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 16:25:21 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900701261323y33f88dcaw807115738414a9d7@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>	
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>	
	<45BA246B.6030505@lwfinger.net>	
	<195c7a900701261028w35961506wc15280b3faa86d82@mail.gmail.com>	
	<45BA4EBE.4000204@lwfinger.net>	
	<195c7a900701261243j2eddfa60h6e7bc76bdf1feefb@mail.gmail.com>	
	<45BA6B14.5070709@lwfinger.net>
	<195c7a900701261323y33f88dcaw807115738414a9d7@mail.gmail.com>
Message-ID: <45BA7FD1.6050803@lwfinger.net>

roucaries bastien wrote:
> On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>>
>> Does it help to down the wifi card before the s2disk?
> 
> Yes no oops but I can't associate to the network after suspend. But at
> least no oops.

Did you use an ifup after resuming?

Please send me the log information that comes from the ifdown, s2disk, resume, ifup sequence.

Thanks,

Larry



From mjg59 at srcf.ucam.org  Sat Jan 27 00:25:23 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Fri, 26 Jan 2007 23:25:23 +0000
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <200701262203.04084.mb@bu3sch.de>
References: <20070126135127.GA3050@srcf.ucam.org>
	<45BA22FB.5050008@lwfinger.net>
	<20070126160116.GA5326@srcf.ucam.org>
	<200701262203.04084.mb@bu3sch.de>
Message-ID: <20070126232523.GB12370@srcf.ucam.org>

On Fri, Jan 26, 2007 at 10:03:03PM +0100, Michael Buesch wrote:

> It _is_ standardized.
> bcm43xx-softmac only supports v3, bcm43xx-d80211 only supports v4.
> So if you want to use both drivers in parallel, use fwpostfix modparam
> and install both firmware with different postfix (I use .v3 and .v4 postfix).

But while you use .v3, most people use the softmac driver without a 
postfix at all. So it's not really standardised :) It's not especially 
important, so I'm not going to get into any sort of extended argument or 
anything - but it's something that would make the driver switchover 
easier for distributions to handle. Adding a suggestion to the docs that 
people use v4 as the postfix for dscape would probably be adequate, I 
just want to avoid the situation where different distributions use 
different postfixes and everyone gets confused.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From pmarks at purdue.edu  Sat Jan 27 01:18:30 2007
From: pmarks at purdue.edu (Paul Marks)
Date: Fri, 26 Jan 2007 19:18:30 -0500
Subject: BCM4311 and Hidden SSIDs?
In-Reply-To: <45BA7B1A.1040504@lwfinger.net>
References: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>
	<45BA7B1A.1040504@lwfinger.net>
Message-ID: <8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>

On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Paul Marks wrote:
> > I have a BCM4311 card, and ever since the PCI-E interrupts patch, I've been
> > able to associate just fine with my own WPA2-PSK access point, using
> > wpa_supplicant with ap_scan=1.
> >
> > However, the access points at my school (Purdue) are all WPA-Enterprise with
> > a hidden SSID, and I so far haven't had any luck getting bcm43xx to connect
> > to these.  If I use ndiswrapper instead, then these APs work as expected.
> >
> > Am I doing something wrong, or is this a limitation in the driver?  Has
> > anyone gotten bcm43xx to work in a hidden-SSID situation?
> >
> > -snip-
>
> It should work. I just hid my SSID and had no trouble seeing the AP when scanning nor any problem
> with associating or authenticating.
>
> How close are you to the AP at Purdue? The 4311's don't broadcast with much power and you might not
> be in reach. I'm also not sure about the ap_scan=2 in your .conf file. Please try a value of 1.
>
> One other thing to test. Once the system is trying to authenticate, do an 'iwlist s' command to see
> if any scans are getting through. It doesn't seem as if they are, but this is another way to see.

In order to get around the (possible) transmit power problem, I set my
own AP to have a hidden SSID, and it's currently sitting about 1 meter
from the laptop.

I've been skimming through the wpa_supplicant source code to try to
get a handle on what's going on.   When ap_scan is set to 1,
wpa_supplicant will walk through all of the entries in the config file
that have "scan_ssid=1" set.  For each of these SSIDs, it tells the
driver to scan for that specific SSID, and when the results come back,
it compares each resulting SSID with the SSID that it was originally
scanning for, looking for an exact string match.

So, it looks like it's the driver's job to scan for a specific SSID,
and insert its name into one of the fields that would ordinarily be
"<hidden>".  The problem is, even after scanning for a specific SSID,
the results from the driver never contain the SSID that we searched
for.  In the debug output for wpa_supplicant, I see:

0: 00:16:01:11:42:11 ssid='<hidden>' wpa_ie_len=26 rsn_ie_len=22 caps=0x11
   skip - SSID mismatch

That's definitely my access point, but as you can see, the driver
never inserted the correct SSID.


From larry.finger at lwfinger.net  Sat Jan 27 03:56:08 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Fri, 26 Jan 2007 20:56:08 -0600
Subject: BCM4311 and Hidden SSIDs?
In-Reply-To: <8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>
References: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>	
	<45BA7B1A.1040504@lwfinger.net>
	<8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>
Message-ID: <45BABF48.5070207@lwfinger.net>

Paul Marks wrote:
> On 1/26/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>> Paul Marks wrote:
>> > I have a BCM4311 card, and ever since the PCI-E interrupts patch,
>> I've been
>> > able to associate just fine with my own WPA2-PSK access point, using
>> > wpa_supplicant with ap_scan=1.
>> >
>> > However, the access points at my school (Purdue) are all
>> WPA-Enterprise with
>> > a hidden SSID, and I so far haven't had any luck getting bcm43xx to
>> connect
>> > to these.  If I use ndiswrapper instead, then these APs work as
>> expected.
>> >
>> > Am I doing something wrong, or is this a limitation in the driver?  Has
>> > anyone gotten bcm43xx to work in a hidden-SSID situation?
>> >
>> > -snip-
>>
>> It should work. I just hid my SSID and had no trouble seeing the AP
>> when scanning nor any problem
>> with associating or authenticating.
>>
>> How close are you to the AP at Purdue? The 4311's don't broadcast with
>> much power and you might not
>> be in reach. I'm also not sure about the ap_scan=2 in your .conf file.
>> Please try a value of 1.
>>
>> One other thing to test. Once the system is trying to authenticate, do
>> an 'iwlist s' command to see
>> if any scans are getting through. It doesn't seem as if they are, but
>> this is another way to see.
> 
> In order to get around the (possible) transmit power problem, I set my
> own AP to have a hidden SSID, and it's currently sitting about 1 meter
> from the laptop.
> 
> I've been skimming through the wpa_supplicant source code to try to
> get a handle on what's going on.   When ap_scan is set to 1,
> wpa_supplicant will walk through all of the entries in the config file
> that have "scan_ssid=1" set.  For each of these SSIDs, it tells the
> driver to scan for that specific SSID, and when the results come back,
> it compares each resulting SSID with the SSID that it was originally
> scanning for, looking for an exact string match.
> 
> So, it looks like it's the driver's job to scan for a specific SSID,
> and insert its name into one of the fields that would ordinarily be
> "<hidden>".  The problem is, even after scanning for a specific SSID,
> the results from the driver never contain the SSID that we searched
> for.  In the debug output for wpa_supplicant, I see:
> 
> 0: 00:16:01:11:42:11 ssid='<hidden>' wpa_ie_len=26 rsn_ie_len=22 caps=0x11
>   skip - SSID mismatch
> 
> That's definitely my access point, but as you can see, the driver
> never inserted the correct SSID.

I will inquire what the software should insert when the SSID is hidden. The piece of code that
inserts the "<hidden>" is ieee80211, which is not part of bcm43xx-softmac, but was written by Intel
and is used by a number of drivers besides bcm43xx.

My system is working with the SSID hidden and the following conf file for wpa_supplicant. It can
take a long time to authenticate as the scan doesn't always find the AP. That is probably a problem
with the driver.

ctrl_interface=/var/run/wpa_supplicant
ap_scan=1
network={
  scan_ssid=1
  ssid="lwfdjf"
  key_mgmt=WPA-PSK
  psk="<removed>"
}

Larry


From larry.finger at lwfinger.net  Sat Jan 27 16:49:01 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sat, 27 Jan 2007 09:49:01 -0600
Subject: BCM4311 and Hidden SSIDs?
In-Reply-To: <8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>
References: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>	
	<45BA7B1A.1040504@lwfinger.net>
	<8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>
Message-ID: <45BB746D.9050603@lwfinger.net>

Paul Marks wrote:
> 
> 0: 00:16:01:11:42:11 ssid='<hidden>' wpa_ie_len=26 rsn_ie_len=22 caps=0x11
>   skip - SSID mismatch
> 
> That's definitely my access point, but as you can see, the driver
> never inserted the correct SSID.

According to Dan Williams at RedHat, the insertion of "<hidden>" by ieee80211 is wrong and no SSID
should be inserted. It may, however, be difficult to remove there. In that case, I'll have to
recapture that message in bcm43xx and strip the faulty part out.

When you connect to the AP's at Purdue with ndiswrapper, please send me the output of 'iwlist s'. I
would like to see what the Windows driver and its MAC layer return.

Larry





From mb at bu3sch.de  Sat Jan 27 18:36:07 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Jan 2007 18:36:07 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070126232523.GB12370@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<200701262203.04084.mb@bu3sch.de>
	<20070126232523.GB12370@srcf.ucam.org>
Message-ID: <200701271836.07819.mb@bu3sch.de>

On Saturday 27 January 2007 00:25, Matthew Garrett wrote:
> On Fri, Jan 26, 2007 at 10:03:03PM +0100, Michael Buesch wrote:
> 
> > It _is_ standardized.
> > bcm43xx-softmac only supports v3, bcm43xx-d80211 only supports v4.
> > So if you want to use both drivers in parallel, use fwpostfix modparam
> > and install both firmware with different postfix (I use .v3 and .v4 postfix).
> 
> But while you use .v3, most people use the softmac driver without a 
> postfix at all.

I'm sorry. That's not our problem. ;)
That's either a distro or user problem.

> So it's not really standardised :) It's not especially  

It is.

> important, so I'm not going to get into any sort of extended argument or 
> anything - but it's something that would make the driver switchover 
> easier for distributions to handle.

I don't think this is easier than module parameters.

> Adding a suggestion to the docs that  

Which docs? ;)

> people use v4 as the postfix for dscape would probably be adequate, I 
> just want to avoid the situation where different distributions use 
> different postfixes and everyone gets confused.

http://bu3sch.de/bcm43xx_fw.php

-- 
Greetings Michael.


From mjg59 at srcf.ucam.org  Sat Jan 27 23:45:40 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Sat, 27 Jan 2007 22:45:40 +0000
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <200701271836.07819.mb@bu3sch.de>
References: <20070126135127.GA3050@srcf.ucam.org>
	<200701262203.04084.mb@bu3sch.de>
	<20070126232523.GB12370@srcf.ucam.org>
	<200701271836.07819.mb@bu3sch.de>
Message-ID: <20070127224540.GB26241@srcf.ucam.org>

On Sat, Jan 27, 2007 at 06:36:07PM +0100, Michael Buesch wrote:
> On Saturday 27 January 2007 00:25, Matthew Garrett wrote:
> > But while you use .v3, most people use the softmac driver without a 
> > postfix at all.
> 
> I'm sorry. That's not our problem. ;)
> That's either a distro or user problem.

The idea is to define a standard so that all the distros use the same 
naming scheme. That way, we avoid situations where some distros document 
that people use one scheme, and people try to use that with another 
distro. The unfortunate truth of things is that most distributions don't 
coordinate with each other, so it helps things hugely if upstream 
provides information about how to define names. A simple note on the 
driver website would probably be sufficient, if you'd prefer not to 
enforce this in the code.

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Sat Jan 27 23:59:27 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sat, 27 Jan 2007 23:59:27 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070127224540.GB26241@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<200701271836.07819.mb@bu3sch.de>
	<20070127224540.GB26241@srcf.ucam.org>
Message-ID: <200701272359.27456.mb@bu3sch.de>

On Saturday 27 January 2007 23:45, Matthew Garrett wrote:
> On Sat, Jan 27, 2007 at 06:36:07PM +0100, Michael Buesch wrote:
> > On Saturday 27 January 2007 00:25, Matthew Garrett wrote:
> > > But while you use .v3, most people use the softmac driver without a 
> > > postfix at all.
> > 
> > I'm sorry. That's not our problem. ;)
> > That's either a distro or user problem.
> 
> The idea is to define a standard so that all the distros use the same 
> naming scheme. That way, we avoid situations where some distros document 
> that people use one scheme, and people try to use that with another 
> distro. The unfortunate truth of things is that most distributions don't 
> coordinate with each other, so it helps things hugely if upstream 
> provides information about how to define names. A simple note on the 
> driver website would probably be sufficient, if you'd prefer not to 
> enforce this in the code.

Distros can not ship firmware anyway, so I don't really see your problem here.

-- 
Greetings Michael.


From martin-langer at gmx.de  Sun Jan 28 02:56:03 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Sun, 28 Jan 2007 02:56:03 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070127224540.GB26241@srcf.ucam.org>
References: <20070126135127.GA3050@srcf.ucam.org>
	<200701262203.04084.mb@bu3sch.de>
	<20070126232523.GB12370@srcf.ucam.org>
	<200701271836.07819.mb@bu3sch.de>
	<20070127224540.GB26241@srcf.ucam.org>
Message-ID: <20070128015603.GA3298@tuba>

On Sat, Jan 27, 2007 at 10:45:40PM +0000, Matthew Garrett wrote:
> On Sat, Jan 27, 2007 at 06:36:07PM +0100, Michael Buesch wrote:
> > On Saturday 27 January 2007 00:25, Matthew Garrett wrote:
> > > But while you use .v3, most people use the softmac driver without a 
> > > postfix at all.
> > 
> > I'm sorry. That's not our problem. ;)
> > That's either a distro or user problem.
> 
> The idea is to define a standard so that all the distros use the same 
> naming scheme. That way, we avoid situations where some distros document 
> that people use one scheme, and people try to use that with another 
> distro. The unfortunate truth of things is that most distributions don't 
> coordinate with each other, so it helps things hugely if upstream 
> provides information about how to define names. A simple note on the 
> driver website would probably be sufficient, if you'd prefer not to 
> enforce this in the code.

Defining standards is a bad way in Open Source. I think we should offer 
as much freedom as we can. That's the reason why fwcutter comes with a 
large list of binaries, which are ready for extraction, instead of only 
one candidate....


I would vote for a fwcutter option --autopostfix where the complete 
version numbers will be taken as postfix. Then you can easily install a 
bunch of v4 firmware files. But such an option makes only sense 
if fwcutter was executed from a higher level distro fwmanager. I mean a 
fwmanager which can set bcm43xx module options, print which fw versions 
are actually installed, say which fw version is running now and switch 
graphically between fw versions. But this is just a dream and I still 
prefer commandlines. ;)

Martin


From pmarks at purdue.edu  Sun Jan 28 05:16:13 2007
From: pmarks at purdue.edu (Paul Marks)
Date: Sat, 27 Jan 2007 23:16:13 -0500
Subject: BCM4311 and Hidden SSIDs?
In-Reply-To: <45BB746D.9050603@lwfinger.net>
References: <8e5b27790701261331x3a457853h3a320f7ea4de623c@mail.gmail.com>
	<45BA7B1A.1040504@lwfinger.net>
	<8e5b27790701261618m6272d4d5v8a629b71bbfc0445@mail.gmail.com>
	<45BB746D.9050603@lwfinger.net>
Message-ID: <8e5b27790701272016w50280ea9g91dd7b2a65377c32@mail.gmail.com>

On 1/27/07, Larry Finger <larry.finger at lwfinger.net> wrote:
> Paul Marks wrote:
> >
> > 0: 00:16:01:11:42:11 ssid='<hidden>' wpa_ie_len=26 rsn_ie_len=22 caps=0x11
> >   skip - SSID mismatch
> >
> > That's definitely my access point, but as you can see, the driver
> > never inserted the correct SSID.
>
> According to Dan Williams at RedHat, the insertion of "<hidden>" by ieee80211 is wrong and no SSID
> should be inserted. It may, however, be difficult to remove there. In that case, I'll have to
> recapture that message in bcm43xx and strip the faulty part out.
>


From ikorot at earthlink.net  Sun Jan 28 11:02:23 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 28 Jan 2007 02:02:23 -0800 (GMT-08:00)
Subject: Code different?
Message-ID: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>

Hi, Larry,

In the patch ftp://lwfinger.dynalias.org/patches/patch_2.6.18.1_for_PCI-E, there is a following code:

@@ -2582,8 +2586,9 @@ static int bcm43xx_probe_cores(struct bc
 	/* fetch sb_id_hi from core information registers */
 	sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
 
-	core_id = (sb_id_hi & 0xFFF0) >> 4;
-	core_rev = (sb_id_hi & 0xF);
+	core_id = (sb_id_hi & 0x8FF0) >> 4;
+	core_rev = (sb_id_hi & 0x7000) >> 8;
+	core_rev |= (sb_id_hi & 0xF);
 	core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;

However, in this patch https://lists.berlios.de/pipermail/bcm43xx-dev/2007-January/003484.html, there is a following code:

@@ -2704,8 +2704,8 @@ static int bcm43xx_probe_cores(struct bc
 		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
 
 		/* extract core_id, core_rev, core_vendor */
-		core_id = (sb_id_hi & 0xFFF0) >> 4;
-		core_rev = (sb_id_hi & 0xF);
+		core_id = (sb_id_hi & 0x8FF0) >> 4;
+		core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
 		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
 
Notice the difference in the calculation of the core_rev variable.

Which version is correct one?

Thank you.


From pmarks at purdue.edu  Sun Jan 28 11:18:59 2007
From: pmarks at purdue.edu (Paul Marks)
Date: Sun, 28 Jan 2007 05:18:59 -0500
Subject: Code different?
In-Reply-To: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
References: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
Message-ID: <8e5b27790701280218y5ba24bbcqe27a53901ac9eedc@mail.gmail.com>

On 1/28/07, Igor Korot <ikorot at earthlink.net> wrote:
>-snip-
>
> +       core_rev = (sb_id_hi & 0x7000) >> 8;
> +       core_rev |= (sb_id_hi & 0xF);
>
> -snip-
>
> +               core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
>
> Notice the difference in the calculation of the core_rev variable.
>
> Which version is correct one?

Those appear to be functionally equivalent to me.


From mb at bu3sch.de  Sun Jan 28 11:41:37 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Jan 2007 11:41:37 +0100
Subject: [RFC PATCH 1/2] Rename V4 firmware
In-Reply-To: <20070128015603.GA3298@tuba>
References: <20070126135127.GA3050@srcf.ucam.org>
	<20070127224540.GB26241@srcf.ucam.org> <20070128015603.GA3298@tuba>
Message-ID: <200701281141.38107.mb@bu3sch.de>

On Sunday 28 January 2007 02:56, Martin Langer wrote:
> On Sat, Jan 27, 2007 at 10:45:40PM +0000, Matthew Garrett wrote:
> > On Sat, Jan 27, 2007 at 06:36:07PM +0100, Michael Buesch wrote:
> > > On Saturday 27 January 2007 00:25, Matthew Garrett wrote:
> > > > But while you use .v3, most people use the softmac driver without a 
> > > > postfix at all.
> > > 
> > > I'm sorry. That's not our problem. ;)
> > > That's either a distro or user problem.
> > 
> > The idea is to define a standard so that all the distros use the same 
> > naming scheme. That way, we avoid situations where some distros document 
> > that people use one scheme, and people try to use that with another 
> > distro. The unfortunate truth of things is that most distributions don't 
> > coordinate with each other, so it helps things hugely if upstream 
> > provides information about how to define names. A simple note on the 
> > driver website would probably be sufficient, if you'd prefer not to 
> > enforce this in the code.
> 
> Defining standards is a bad way in Open Source. I think we should offer 
> as much freedom as we can. That's the reason why fwcutter comes with a 
> large list of binaries, which are ready for extraction, instead of only 
> one candidate....
> 
> 
> I would vote for a fwcutter option --autopostfix where the complete 
> version numbers will be taken as postfix. Then you can easily install a 

Ok, that's a rather good idea. If you want to implement it, go for it. ;)

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jan 28 11:42:33 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Jan 2007 11:42:33 +0100
Subject: Code different?
In-Reply-To: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
References: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
Message-ID: <200701281142.34081.mb@bu3sch.de>

On Sunday 28 January 2007 11:02, Igor Korot wrote:
> Hi, Larry,
> 
> In the patch ftp://lwfinger.dynalias.org/patches/patch_2.6.18.1_for_PCI-E, there is a following code:
> 
> @@ -2582,8 +2586,9 @@ static int bcm43xx_probe_cores(struct bc
>  	/* fetch sb_id_hi from core information registers */
>  	sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>  
> -	core_id = (sb_id_hi & 0xFFF0) >> 4;
> -	core_rev = (sb_id_hi & 0xF);
> +	core_id = (sb_id_hi & 0x8FF0) >> 4;
> +	core_rev = (sb_id_hi & 0x7000) >> 8;
> +	core_rev |= (sb_id_hi & 0xF);
>  	core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
> 
> However, in this patch https://lists.berlios.de/pipermail/bcm43xx-dev/2007-January/003484.html, there is a following code:
> 
> @@ -2704,8 +2704,8 @@ static int bcm43xx_probe_cores(struct bc
>  		sb_id_hi = bcm43xx_read32(bcm, BCM43xx_CIR_SB_ID_HI);
>  
>  		/* extract core_id, core_rev, core_vendor */
> -		core_id = (sb_id_hi & 0xFFF0) >> 4;
> -		core_rev = (sb_id_hi & 0xF);
> +		core_id = (sb_id_hi & 0x8FF0) >> 4;
> +		core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));
>  		core_vendor = (sb_id_hi & 0xFFFF0000) >> 16;
>  
> Notice the difference in the calculation of the core_rev variable.
> 
> Which version is correct one?

The latter one.

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jan 28 11:47:33 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Jan 2007 11:47:33 +0100
Subject: Code different?
Message-ID: <200701281147.33636.mb@bu3sch.de>

On Sunday 28 January 2007 11:44, ikorot at earthlink.net wrote:
> I apologize for this automatic reply to your email.
> 
> To control spam, I now allow incoming messages only from senders I
> have approved beforehand.
> 
> If you would like to be added to my list of approved senders, please
> fill out the short request form (see link below). Once I approve you,
> I will receive your original message in my inbox. You do not need to
> resend your message. I apologize for this one-time inconvenience.
> 
> Click the link below to fill out the request:
> 
> https://webmail.pas.earthlink.net/wam/addme?a=ikorot at earthlink.net&id=1hb7vX6El3Nl34l1


Igor, this is more than annoying.
What if everybody did this? It would be even worse than spam!
I am not going to sign up on this.

-- 
Greetings Michael.


From mb at bu3sch.de  Sun Jan 28 15:26:07 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Jan 2007 15:26:07 +0100
Subject: [PATCH] bcm43xx: Enable fwpostfix in nondebug bcm43xx
Message-ID: <200701281526.07956.mb@bu3sch.de>

This enables fwpostfix module parameter for nondebugging
bcm43xx driver.

It _might_ ease transition from softmac to d80211 for distributions.

Signed-off-by: Michael Buesch <mb at bu3sch.de>

--

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 13:59:51.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c	2007-01-28 14:02:41.000000000 +0100
@@ -95,13 +95,9 @@ static int modparam_noleds;
 module_param_named(noleds, modparam_noleds, int, 0444);
 MODULE_PARM_DESC(noleds, "Turn off all LED activity");
 
-#ifdef CONFIG_BCM43XX_DEBUG
 static char modparam_fwpostfix[64];
 module_param_string(fwpostfix, modparam_fwpostfix, 64, 0444);
-MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for debugging.");
-#else
-# define modparam_fwpostfix  ""
-#endif /* CONFIG_BCM43XX_DEBUG*/
+MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for using multiple firmware image versions.");
 
 
 /* If you want to debug with just a single device, enable this,


-- 
Greetings Michael.


From larry.finger at lwfinger.net  Sun Jan 28 18:03:52 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Jan 2007 11:03:52 -0600
Subject: Code different?
In-Reply-To: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
References: <27595391.1169978544310.JavaMail.root@elwamui-hound.atl.sa.earthlink.net>
Message-ID: <45BCD778.7000305@lwfinger.net>

Igor Korot wrote:
> Hi, Larry,
> 
> In the patch ftp://lwfinger.dynalias.org/patches/patch_2.6.18.1_for_PCI-E, there is a following code:

> +	core_rev = (sb_id_hi & 0x7000) >> 8;
> +	core_rev |= (sb_id_hi & 0xF);

> +		core_rev = ((sb_id_hi & 0xF) | ((sb_id_hi & 0x7000) >> 8));

> Notice the difference in the calculation of the core_rev variable.
> 
> Which version is correct one?

To my eye they result in the same thing, and the only difference is one line or two and some
additional parentheses. Am I missing something?


Larry


From larry.finger at lwfinger.net  Sun Jan 28 20:47:14 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Jan 2007 13:47:14 -0600
Subject: [PATCH] bcm43xx: Enable fwpostfix in nondebug bcm43xx
In-Reply-To: <200701281526.07956.mb@bu3sch.de>
References: <200701281526.07956.mb@bu3sch.de>
Message-ID: <45BCFDC2.3060703@lwfinger.net>

Michael Buesch wrote:

ACK on the patch.

I changed the commit message. Is the new version OK?

Larry

====================================


From: Michael Buesch <mb at bu3sch.de>

The in-kernel bcm43xx driver only works with V3 firmware, whereas the
experimental version that incorporates the d80211 stack requires V4
firmware. In bcm43xx-d80211, the fwpostfix module parameter is used
to differentiate between the versions. In bcm43xx-softmac, this
module parameter is only enabled when debugging is on. This patch
makes the module parameter available unconditionaly, and should
ease the future transition from softmac to d80211.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
--

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -96,13 +96,9 @@ static int modparam_noleds;
 module_param_named(noleds, modparam_noleds, int, 0444);
 MODULE_PARM_DESC(noleds, "Turn off all LED activity");

-#ifdef CONFIG_BCM43XX_DEBUG
 static char modparam_fwpostfix[64];
 module_param_string(fwpostfix, modparam_fwpostfix, 64, 0444);
-MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for debugging.");
-#else
-# define modparam_fwpostfix  ""
-#endif /* CONFIG_BCM43XX_DEBUG*/
+MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for using multiple firmware image
versions.");


 /* If you want to debug with just a single device, enable this,

---




From mb at bu3sch.de  Sun Jan 28 21:05:54 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Sun, 28 Jan 2007 21:05:54 +0100
Subject: [PATCH] bcm43xx: Enable fwpostfix in nondebug bcm43xx
In-Reply-To: <45BCFDC2.3060703@lwfinger.net>
References: <200701281526.07956.mb@bu3sch.de> <45BCFDC2.3060703@lwfinger.net>
Message-ID: <200701282105.54479.mb@bu3sch.de>

On Sunday 28 January 2007 20:47, Larry Finger wrote:
> Michael Buesch wrote:
> 
> ACK on the patch.
> 
> I changed the commit message. Is the new version OK?

Yeah, I don't care for commit messages. ;)
Please forward this to linville to get it into the next kernel.

> Larry
> 
> ====================================
> 
> 
> From: Michael Buesch <mb at bu3sch.de>
> 
> The in-kernel bcm43xx driver only works with V3 firmware, whereas the
> experimental version that incorporates the d80211 stack requires V4
> firmware. In bcm43xx-d80211, the fwpostfix module parameter is used
> to differentiate between the versions. In bcm43xx-softmac, this
> module parameter is only enabled when debugging is on. This patch
> makes the module parameter available unconditionaly, and should
> ease the future transition from softmac to d80211.
> 
> Signed-off-by: Michael Buesch <mb at bu3sch.de>
> Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
> --
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
> @@ -96,13 +96,9 @@ static int modparam_noleds;
>  module_param_named(noleds, modparam_noleds, int, 0444);
>  MODULE_PARM_DESC(noleds, "Turn off all LED activity");
> 
> -#ifdef CONFIG_BCM43XX_DEBUG
>  static char modparam_fwpostfix[64];
>  module_param_string(fwpostfix, modparam_fwpostfix, 64, 0444);
> -MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for debugging.");
> -#else
> -# define modparam_fwpostfix  ""
> -#endif /* CONFIG_BCM43XX_DEBUG*/
> +MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for using multiple firmware image
> versions.");
> 
> 
>  /* If you want to debug with just a single device, enable this,
> 
> ---
> 
> 
> 
> 

-- 
Greetings Michael.


From ikorot at earthlink.net  Sun Jan 28 21:12:49 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 28 Jan 2007 12:12:49 -0800 (GMT-08:00)
Subject: Problem with the lid closing event
Message-ID: <28835219.1170015169864.JavaMail.root@elwamui-rustique.atl.sa.earthlink.net>

Hi, Larry,
I did a quick test and, indeed, the value calculation is the same in both cases. Sorry about the confusion.

However, I found another problem.
I am running Gentoo with 2.6.18 kernel with the LED activation and interrupt enabled patches.
After running "ifconfig eth1 up", the card is up, the WiFi LED is on, and everything works as expected.

However, when I close and re-open the lid of my laptop, I lost the ability to restore it.

I am not running the suspend software, I have a 'vbetool' installed on top of GNOME.
Since evrything was working, I was able to capture the dmesg output, which is attached.

If you need anything else, let me know.

Thank you.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: null/dmesg.out
Type: application/octet-stream
Size: 17146 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070128/fb1882a8/attachment.obj>

From Larry.Finger at lwfinger.net  Sun Jan 28 21:32:52 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Jan 2007 14:32:52 -0600
Subject: [PATCH] bcm43xx: Enable fwpostfix in nondebug bcm43xx
Message-ID: <45bd0874.hBM9rX68Vq5hLGwU%Larry.Finger@lwfinger.net>

From: Michael Buesch <mb at bu3sch.de>

The in-kernel bcm43xx driver only works with V3 firmware, whereas the
experimental version that incorporates the d80211 stack requires V4
firmware. In bcm43xx-d80211, the fwpostfix module parameter is used
to differentiate between the versions. In bcm43xx-softmac, this
module parameter is only enabled when debugging is on. This patch
makes the module parameter available unconditionaly, and should
ease the future transition from softmac to d80211.

Signed-off-by: Michael Buesch <mb at bu3sch.de>
Signed-off-by: Larry Finger <Larry.Finger at lwfinger.net>
--

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_main.c
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_main.c
@@ -96,13 +96,9 @@ static int modparam_noleds;
 module_param_named(noleds, modparam_noleds, int, 0444);
 MODULE_PARM_DESC(noleds, "Turn off all LED activity");
 
-#ifdef CONFIG_BCM43XX_DEBUG
 static char modparam_fwpostfix[64];
 module_param_string(fwpostfix, modparam_fwpostfix, 64, 0444);
-MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for debugging.");
-#else
-# define modparam_fwpostfix  ""
-#endif /* CONFIG_BCM43XX_DEBUG*/
+MODULE_PARM_DESC(fwpostfix, "Postfix for .fw files. Useful for using multiple firmware image versions.");
 
 
 /* If you want to debug with just a single device, enable this,

---



From larry.finger at lwfinger.net  Mon Jan 29 00:17:27 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Jan 2007 17:17:27 -0600
Subject: Problem with the lid closing event
In-Reply-To: <28835219.1170015169864.JavaMail.root@elwamui-rustique.atl.sa.earthlink.net>
References: <28835219.1170015169864.JavaMail.root@elwamui-rustique.atl.sa.earthlink.net>
Message-ID: <45BD2F07.6000502@lwfinger.net>

Igor Korot wrote:
> Hi, Larry,
> I did a quick test and, indeed, the value calculation is the same in both cases. Sorry about the confusion.
> 
> However, I found another problem.
> I am running Gentoo with 2.6.18 kernel with the LED activation and interrupt enabled patches.
> After running "ifconfig eth1 up", the card is up, the WiFi LED is on, and everything works as expected.
> 
> However, when I close and re-open the lid of my laptop, I lost the ability to restore it.
> 
> I am not running the suspend software, I have a 'vbetool' installed on top of GNOME.
> Since evrything was working, I was able to capture the dmesg output, which is attached.
> 

I didn't see anything in the log that indicates an error. Is this dmesg output from before or after
the lid closing? I don't see either the suspend or resume debug messages from bcm43xx.

There is a report of bcm43xx not resuming correctly after suspend to disk. Unfortunately, my
graphics system crashes when I try to suspend and I have to do a power off. That prevents me from
testing the suspend or resume code.

Larry


From mcclosk at ucsc.edu  Mon Jan 29 01:05:42 2007
From: mcclosk at ucsc.edu (Jim McCloskey)
Date: Sun, 28 Jan 2007 16:05:42 -0800
Subject: 4318 (LinkSys WPC54GS) progress
Message-ID: <20070129000542.GE15459@ohlone>


Hello. I am the owner of a card (a LinkSys Wireless-G WPC54GS (ver.2))
which has a 4318 chip:

kernel: bcm43xx: Chip ID 0x4318, rev 0x2kernel: bcm43xx: Number of cores: 4
kernel: bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
kernel: bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243, disabled
kernel: bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled

Last July I wrote to this list about the level of success I was having
with getting the card to work under Debian testing [1]. At that point,
the card was managing to associate with the access point and obtain an
IP address about one time in ten.  That was with kernel version 2.6.17.

I have barely used the card since then---because it wasn't really
usable, and because I scan or read the digest version of this list
every day and my impression from that was that the issues around the
4318 chipsets hadn't really been addressed yet.

However, three days ago, I thought I should try again. I've been using
the card with two slightly different kernel versions: 2.6.18.1
hand-compiled from kernel.org and 2.6.18.3 packaged for Debian.

And it's been working just fine. True, I can't use Debian's ifup
script, and automation utilities like network-manager and KDE's
kwifi-manager also can't create a working connection, but if I do:

  ifconfig wlan up
  iwconfig essid ESSID-NAME
  dhclient wlan

all works consistently very well. That is, I have had no failures of
association at all over the past 3 days, despite more or less
continuous use and despite the fact that I have been deliberately
connecting and disconnecting, suspending and resuming, and so on to
try to test the card (I'm listening to an Irish radio stream with it
just now). Also: `iwlist wlan scan' used to regularly cause hard
lockups of the system, but I haven't been able to induce that
behaviour over the 3 day period either.

The only change here is the kernel version---same laptop, same access
point, same number of access points in the vicinity.

I haven't tried with 2.6.19, but obviously I should.

So this is just a progress report and a note of thanks to you all for
your work. Obviously, I'm happy. But am I wrong to be also a little
bit puzzled?

Jim

[1] https://lists.berlios.de/pipermail/bcm43xx-dev/2006-July/002095.html


From ikorot at earthlink.net  Mon Jan 29 02:14:18 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Sun, 28 Jan 2007 20:14:18 -0500 (EST)
Subject: Problem with the lid closing event
Message-ID: <19133466.1170033259287.JavaMail.root@elwamui-rustique.atl.sa.earthlink.net>

Larry,

-----Original Message-----
>From: Larry Finger <larry.finger at lwfinger.net>
>Sent: Jan 28, 2007 6:17 PM
>To: Igor Korot <ikorot at earthlink.net>
>Cc: Michael Buesch <mb at bu3sch.de>, Bcm43xx-dev at lists.berlios.de
>Subject: Re: Problem with the lid closing event
>
>Igor Korot wrote:
>> Hi, Larry,
>> I did a quick test and, indeed, the value calculation is the same in both cases. Sorry about the confusion.
>> 
>> However, I found another problem.
>> I am running Gentoo with 2.6.18 kernel with the LED activation and interrupt enabled patches.
>> After running "ifconfig eth1 up", the card is up, the WiFi LED is on, and everything works as expected.
>> 
>> However, when I close and re-open the lid of my laptop, I lost the ability to restore it.
>> 
>> I am not running the suspend software, I have a 'vbetool' installed on top of GNOME.
>> Since evrything was working, I was able to capture the dmesg output, which is attached.
>> 
>
>I didn't see anything in the log that indicates an error. Is this dmesg output from before or after
>the lid closing? I don't see either the suspend or resume debug messages from bcm43xx.

This dmesg is after the lid has been open. The WiFi LED was still "on".
However, the screen was not restored.

>
>There is a report of bcm43xx not resuming correctly after suspend to disk. Unfortunately, my
>graphics system crashes when I try to suspend and I have to do a power off. That prevents me from
>testing the suspend or resume code.

It might be the same issue, or the different one.
You can try to install the vbetool on you laptop, and check if it won't crash.
Then we can check for the bcm43xx driver behavior....

>
>Larry

Thank you.



From larry.finger at lwfinger.net  Mon Jan 29 04:18:46 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Sun, 28 Jan 2007 21:18:46 -0600
Subject: 4318 (LinkSys WPC54GS) progress
In-Reply-To: <20070129000542.GE15459@ohlone>
References: <20070129000542.GE15459@ohlone>
Message-ID: <45BD6796.5010502@lwfinger.net>

Jim McCloskey wrote:
> Hello. I am the owner of a card (a LinkSys Wireless-G WPC54GS (ver.2))
> which has a 4318 chip:
> 
> kernel: bcm43xx: Chip ID 0x4318, rev 0x2kernel: bcm43xx: Number of cores: 4
> kernel: bcm43xx: Core 0: ID 0x800, rev 0xd, vendor 0x4243, enabled
> kernel: bcm43xx: Core 1: ID 0x812, rev 0x9, vendor 0x4243, disabled
> kernel: bcm43xx: Core 2: ID 0x804, rev 0xc, vendor 0x4243, enabled
> kernel: bcm43xx: Core 3: ID 0x80d, rev 0x7, vendor 0x4243, enabled
> 
> Last July I wrote to this list about the level of success I was having
> with getting the card to work under Debian testing [1]. At that point,
> the card was managing to associate with the access point and obtain an
> IP address about one time in ten.  That was with kernel version 2.6.17.
> 
> I have barely used the card since then---because it wasn't really
> usable, and because I scan or read the digest version of this list
> every day and my impression from that was that the issues around the
> 4318 chipsets hadn't really been addressed yet.
> 
> However, three days ago, I thought I should try again. I've been using
> the card with two slightly different kernel versions: 2.6.18.1
> hand-compiled from kernel.org and 2.6.18.3 packaged for Debian.
> 
> And it's been working just fine. True, I can't use Debian's ifup
> script, and automation utilities like network-manager and KDE's
> kwifi-manager also can't create a working connection, but if I do:
> 
>   ifconfig wlan up
>   iwconfig essid ESSID-NAME
>   dhclient wlan
> 
> all works consistently very well. That is, I have had no failures of
> association at all over the past 3 days, despite more or less
> continuous use and despite the fact that I have been deliberately
> connecting and disconnecting, suspending and resuming, and so on to
> try to test the card (I'm listening to an Irish radio stream with it
> just now). Also: `iwlist wlan scan' used to regularly cause hard
> lockups of the system, but I haven't been able to induce that
> behaviour over the 3 day period either.
> 
> The only change here is the kernel version---same laptop, same access
> point, same number of access points in the vicinity.
> 
> I haven't tried with 2.6.19, but obviously I should.
> 
> So this is just a progress report and a note of thanks to you all for
> your work. Obviously, I'm happy. But am I wrong to be also a little
> bit puzzled?

Although we have not made any progress on the transmit strength problem with 4318, 4311 and 4312
chips, we have fixed a great number of bugs that led to lockups, and we continue to make advances.
Kernel 2.6.19 is better than 2.6.18 and 2.6.20 will be even better. In addition, there is a lot of
stuff waiting for 2.6.21, and so on.

Larry


From ikorot at earthlink.net  Mon Jan 29 10:10:15 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Mon, 29 Jan 2007 01:10:15 -0800 (GMT-08:00)
Subject: Another strange thing with the driver
Message-ID: <30782580.1170061815531.JavaMail.root@elwamui-polski.atl.sa.earthlink.net>

Hi, Larry,
I found another strange thing with the driver.
I was able to successfully establish the connection using "wireless tools".
I just installed wpa_supplicant", and here is what happened:

IgorsGentooOnNetwork igor # ifconfig eth1 up
SIOCSIFFLAGS: Protocol error


Looking at dmesg, I found that the problem is in the firmware:

bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.
bcm43xx: core_up for active 802.11 core failed (-71)


Here is my /etc/conf.d/net

# This blank configuration will automatically use DHCP for any net.*
# scripts in /etc/init.d.  To create a more complete configuration,
# please review /etc/conf.d/net.example and save your configuration
# in /etc/conf.d/net (this file :]!).

#Wireless-tools
#nis_domain_lo="IgorsGentoo"
#modules=("iwconfig")
#key_ESSID1="[1] s:IgorsNetwork key [1] enc open"
#key_ESSID2="[1] aaaa-bbbb-cccc-dd key [1] enc estricted"
#preferred_aps=("ESSID1" "ESSID2")

#Wpa_supplicant
modules=( "wpa_supplicant" )
wpa_supplicant_eth1="-Dbcm43xx"

Here is my /etc/wpa_supplicant.conf

ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=0
ap_scan=1
network={
  ssid="IgorsNetwork"
  psk="abcdef"
  priority=5
}

Do I need to re-install the firmware going from wireless tools to wpa_supplicant?


Thank you.


From joerg at alea.gnuu.de  Mon Jan 29 11:14:49 2007
From: joerg at alea.gnuu.de (=?iso-8859-1?Q?J=F6rg?= Sommer)
Date: Mon, 29 Jan 2007 11:14:49 +0100
Subject: wpasupplicant says: Driver did not support SIOCSIWENCODEEXT
In-Reply-To: <45BA2165.3080701@lwfinger.net>
References: <20070126063044.GB19558@alea.gnuu.de>
	<45BA2165.3080701@lwfinger.net>
Message-ID: <20070129101449.GC19558@alea.gnuu.de>

Hello Larry,

Larry Finger schrieb am Fri 26. Jan, 09:42 (-0600):
> J?rg Sommer wrote:
> > I want to connect to a WPA-EPA-TTLS encrypted network, but wpasupplicant
> > (0.5.7) says: Driver did not support SIOCSIWENCODEEXT. What does he mean?
> > Can someone read the wpa_supplicant log and see why it can't connect to
> > the network?
> 
> Could we please have more details such as distro, kernel version, and an extract of the wireless
> details from dmesg?

Sorry. I wrote this message before leaving the house and I forgot to
add this infos.

% uname -a
Linux ibook 2.6.20-rc5 #1 Fri Jan 19 12:33:45 CET 2007 ppc GNU/Linux
# lspci -s 10:12 -v
0001:10:12.0 Network controller: Broadcom Corporation BCM4306 802.11b/g Wireless LAN Controller (rev 03)
        Subsystem: Apple Computer Inc. AirPort Extreme
        Flags: bus master, fast devsel, latency 16, IRQ 52
        Memory at 80084000 (32-bit, non-prefetchable) [size=8K]
        Capabilities: [40] Power Management version 2

ADB mouse at 3, handler set to 4 (trackpad)SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
SoftMAC: Canceling existing associate request!
SoftMAC: Associate: Scanning for networks first.

SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: Queueing Authentication Request to 00:12:da:9e:5c:b0
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:12:da:9e:5c:b0.
SoftMAC: Open Authentication completed with 00:12:da:9e:5c:b0
SoftMAC: sent association request!
SoftMAC: associated!
bcm43xx: set security called, .enabled = 1, .encrypt = 1
SoftMAC: Associate: Scanning for networks first.
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
SoftMAC: Queueing Authentication Request to 00:12:da:9e:5c:b0
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:12:da:9e:5c:b0.
SoftMAC: generic IE set to dd160050f20101000050f20201000050f20201000050f201
SoftMAC: Open Authentication completed with 00:12:da:9e:5c:b0
SoftMAC: sent association request!
SoftMAC: Already associating or associated to 00:12:da:9e:5c:b0
SoftMAC: Associate: Scanning for networks first.
SoftMAC: associated!
SoftMAC: Scanning finished: scanned 14 channels starting with channel 1
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 3/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512

Today, I've run a new test on a different access point. I couldn't
connect, too, but I didn't get the SIOCSIWENCODEEXT message.
wpa_supplicant said:

Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Associated with 00:14:1b:5b:b0:60
CTRL-EVENT-EAP-STARTED EAP authentication started
CTRL-EVENT-EAP-METHOD EAP vendor 0 method 21 (TTLS) selected
OpenSSL: tls_connection_handshake - Failed to read possible Application Data error:00000000:lib(0):func(0):reason(0)
CTRL-EVENT-EAP-SUCCESS EAP authentication completed successfully
WPA: Failed to set PTK to the driver.
CTRL-EVENT-DISCONNECTED - Disconnect event - remove keys
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Associated with 00:14:1b:5b:b0:60
CTRL-EVENT-EAP-STARTED EAP authentication started
CTRL-EVENT-EAP-FAILURE EAP authentication failed
Authentication with 00:14:1b:5b:b0:60 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:60:64:60 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:f2:fc:0f:70 (SSID='802.1X' freq=2412 MHz)
Association request to the driver failed
Authentication with 00:00:00:00:00:00 timed out.
Trying to associate with 00:14:1b:5b:b0:60 (SSID='802.1X' freq=2462 MHz)
Association request to the driver failed
CTRL-EVENT-TERMINATING - signal 2 received

The debug log is at http://www.minet.uni-jena.de/~joergs/wlan17.wpa_s2
The dmesg log is at http://www.minet.uni-jena.de/~joergs/wlan17.dmesg1
and http://www.minet.uni-jena.de/~joergs/wlan17.dmesg2

Thanks and kind regards, J?rg.
-- 
Es ist au?erdem ein weit verbreiteter Irrtum das USENET ?helfen? soll.
Tats?chlich wurde USENET nachweislich zur pers?nlichen Belustigung
seiner Erfinder geschaffen.
J?rg Klemenz <joerg at gmx.net>, <b4ai4o$1u8vmt$2 at ID-21915.news.dfncis.de>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 481 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070129/e0d77c9f/attachment.pgp>

From mjg59 at srcf.ucam.org  Mon Jan 29 15:04:08 2007
From: mjg59 at srcf.ucam.org (Matthew Garrett)
Date: Mon, 29 Jan 2007 14:04:08 +0000
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <195c7a900701290455o3ff9fc15k305637f8ced24caf@mail.gmail.com>
References: <45B92488.6090908@lwfinger.net> <45B92536.2080909@lwfinger.net>
	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>
	<45BA246B.6030505@lwfinger.net> <20070129115842.GA4928@ucw.cz>
	<195c7a900701290455o3ff9fc15k305637f8ced24caf@mail.gmail.com>
Message-ID: <20070129140408.GA19379@srcf.ucam.org>

On Mon, Jan 29, 2007 at 01:55:41PM +0100, roucaries bastien wrote:
> -       return 0;
> +       return bcm43xx_init_one(pdev, NULL);
> }

While this may well work (it's basically equivalent to unloading and 
reloading the module), it's not a long-term fix - userspace is going to 
notice the interface vanishing and reappearing. Larry, I guess you just 
mean this as a test patch?

-- 
Matthew Garrett | mjg59 at srcf.ucam.org


From mb at bu3sch.de  Mon Jan 29 15:31:25 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 29 Jan 2007 15:31:25 +0100
Subject: Another strange thing with the driver
In-Reply-To: <30782580.1170061815531.JavaMail.root@elwamui-polski.atl.sa.earthlink.net>
References: <30782580.1170061815531.JavaMail.root@elwamui-polski.atl.sa.earthlink.net>
Message-ID: <200701291531.25799.mb@bu3sch.de>

On Monday 29 January 2007 10:10, Igor Korot wrote:
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.

Rather self-explaining, no?
What do I have to say additionally to the dmesg log?

-- 
Greetings Michael.


From mb at bu3sch.de  Mon Jan 29 15:35:01 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Mon, 29 Jan 2007 15:35:01 +0100
Subject: 4318 (LinkSys WPC54GS) progress
In-Reply-To: <45BD6796.5010502@lwfinger.net>
References: <20070129000542.GE15459@ohlone> <45BD6796.5010502@lwfinger.net>
Message-ID: <200701291535.01500.mb@bu3sch.de>

On Monday 29 January 2007 04:18, Larry Finger wrote:
> Although we have not made any progress on the transmit strength problem with 4318, 4311 and 4312

That's not true. We are doing progress, but we didn't solve the
issue completely, yet. It's a complicated issue. ;)

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Mon Jan 29 16:26:59 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 29 Jan 2007 09:26:59 -0600
Subject: Another strange thing with the driver
In-Reply-To: <30782580.1170061815531.JavaMail.root@elwamui-polski.atl.sa.earthlink.net>
References: <30782580.1170061815531.JavaMail.root@elwamui-polski.atl.sa.earthlink.net>
Message-ID: <45BE1243.2080606@lwfinger.net>

Igor Korot wrote:
> Hi, Larry,
> I found another strange thing with the driver.
> I was able to successfully establish the connection using "wireless tools".
> I just installed wpa_supplicant", and here is what happened:
> 
> IgorsGentooOnNetwork igor # ifconfig eth1 up
> SIOCSIFFLAGS: Protocol error
> 
> 
> Looking at dmesg, I found that the problem is in the firmware:
> 
> bcm43xx: PHY connected
> bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
> bcm43xx: InitVals (bcm43xx_initvalXX.fw) file-format error. Please fix your bcm43xx firmware files.
> bcm43xx: core_up for active 802.11 core failed (-71)
> 
> 
> Here is my /etc/conf.d/net
> 
> # This blank configuration will automatically use DHCP for any net.*
> # scripts in /etc/init.d.  To create a more complete configuration,
> # please review /etc/conf.d/net.example and save your configuration
> # in /etc/conf.d/net (this file :]!).
> 
> #Wireless-tools
> #nis_domain_lo="IgorsGentoo"
> #modules=("iwconfig")
> #key_ESSID1="[1] s:IgorsNetwork key [1] enc open"
> #key_ESSID2="[1] aaaa-bbbb-cccc-dd key [1] enc estricted"
> #preferred_aps=("ESSID1" "ESSID2")
> 
> #Wpa_supplicant
> modules=( "wpa_supplicant" )
> wpa_supplicant_eth1="-Dbcm43xx"
> 
> Here is my /etc/wpa_supplicant.conf
> 
> ctrl_interface=/var/run/wpa_supplicant
> ctrl_interface_group=0
> ap_scan=1
> network={
>   ssid="IgorsNetwork"
>   psk="abcdef"
>   priority=5
> }
> 
> Do I need to re-install the firmware going from wireless tools to wpa_supplicant?

No. Changing the connection tools did not cause this problem. Your firmware got corrupted by some
event, which is the reason you need to re-install the firmware. In any case, the log message is clear.

Larry


From larry.finger at lwfinger.net  Mon Jan 29 16:43:53 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 29 Jan 2007 09:43:53 -0600
Subject: Bcm43xx oops after suspend to disk
In-Reply-To: <20070129140408.GA19379@srcf.ucam.org>
References: <45B92488.6090908@lwfinger.net>
	<45B92536.2080909@lwfinger.net>	<195c7a900701251530m409878a8id301c7cada76f342@mail.gmail.com>	<45BA246B.6030505@lwfinger.net>
	<20070129115842.GA4928@ucw.cz>	<195c7a900701290455o3ff9fc15k305637f8ced24caf@mail.gmail.com>
	<20070129140408.GA19379@srcf.ucam.org>
Message-ID: <45BE1639.6040106@lwfinger.net>

Matthew Garrett wrote:
> On Mon, Jan 29, 2007 at 01:55:41PM +0100, roucaries bastien wrote:
>> -       return 0;
>> +       return bcm43xx_init_one(pdev, NULL);
>> }
> 
> While this may well work (it's basically equivalent to unloading and 
> reloading the module), it's not a long-term fix - userspace is going to 
> notice the interface vanishing and reappearing. Larry, I guess you just 
> mean this as a test patch?
> 

Yes. If this doesn't work, then we have real problems. If it does, then I try to find the part that
is missing in the current code.

Larry



From larry.finger at lwfinger.net  Mon Jan 29 16:47:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Mon, 29 Jan 2007 09:47:26 -0600
Subject: 4318 (LinkSys WPC54GS) progress
In-Reply-To: <200701291535.01500.mb@bu3sch.de>
References: <20070129000542.GE15459@ohlone> <45BD6796.5010502@lwfinger.net>
	<200701291535.01500.mb@bu3sch.de>
Message-ID: <45BE170E.4040705@lwfinger.net>

Michael Buesch wrote:
> On Monday 29 January 2007 04:18, Larry Finger wrote:
>> Although we have not made any progress on the transmit strength problem with 4318, 4311 and 4312
> 
> That's not true. We are doing progress, but we didn't solve the
> issue completely, yet. It's a complicated issue. ;)

I know. I'm following your developments on the mb git tree and putting the relevant changes into a
patch-in-progress for the softmac version. So far, it doesn't make my 4311 fly.

Larry





From ikorot at earthlink.net  Mon Jan 29 19:34:41 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Mon, 29 Jan 2007 13:34:41 -0500 (EST)
Subject: Problem with the lid closing event
Message-ID: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>

Larry,

-----Original Message-----
>From: Igor Korot <ikorot at earthlink.net>
>Sent: Jan 28, 2007 8:14 PM
>To: Larry Finger <larry.finger at lwfinger.net>
>Cc: Michael Buesch <mb at bu3sch.de>, Bcm43xx-dev at lists.berlios.de
>Subject: Re: Problem with the lid closing event
>
>Larry,
>
>-----Original Message-----
>>From: Larry Finger <larry.finger at lwfinger.net>
>>Sent: Jan 28, 2007 6:17 PM
>>To: Igor Korot <ikorot at earthlink.net>
>>Cc: Michael Buesch <mb at bu3sch.de>, Bcm43xx-dev at lists.berlios.de
>>Subject: Re: Problem with the lid closing event
>>
>>Igor Korot wrote:
>>> Hi, Larry,
>>> I did a quick test and, indeed, the value calculation is the same in both cases. Sorry about the confusion.
>>> 
>>> However, I found another problem.
>>> I am running Gentoo with 2.6.18 kernel with the LED activation and interrupt enabled patches.
>>> After running "ifconfig eth1 up", the card is up, the WiFi LED is on, and everything works as expected.
>>> 
>>> However, when I close and re-open the lid of my laptop, I lost the ability to restore it.
>>> 
>>> I am not running the suspend software, I have a 'vbetool' installed on top of GNOME.
>>> Since evrything was working, I was able to capture the dmesg output, which is attached.
>>> 
>>
>>I didn't see anything in the log that indicates an error. Is this dmesg output from before or after
>>the lid closing? I don't see either the suspend or resume debug messages from bcm43xx.
>
>This dmesg is after the lid has been open. The WiFi LED was still "on".
>However, the screen was not restored.
>
>>
>>There is a report of bcm43xx not resuming correctly after suspend to disk. Unfortunately, my
>>graphics system crashes when I try to suspend and I have to do a power off. That prevents me from
>>testing the suspend or resume code.
>
>It might be the same issue, or the different one.
>You can try to install the vbetool on you laptop, and check if it won't crash.
>Then we can check for the bcm43xx driver behavior....

This is the software I installed:
http://www.srcf.ucam.org/~mjg59/vbetool/

Maybe it will run fine on you video.

Also, I tried to turn the card on, then off, and then close/open the lid. It didn't work as well.
Which means that any card activity stops this software from restoring the screen.

Thank you.
>
>>
>>Larry
>
>Thank you.



From larry.finger at lwfinger.net  Tue Jan 30 16:22:26 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 30 Jan 2007 09:22:26 -0600
Subject: Problem with the lid closing event
In-Reply-To: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
Message-ID: <45BF62B2.3070600@lwfinger.net>

Igor Korot wrote:
> Larry,
> 
> -----Original Message-----
>> From: Igor Korot <ikorot at earthlink.net>
>> Sent: Jan 28, 2007 8:14 PM
>> To: Larry Finger <larry.finger at lwfinger.net>
>> Cc: Michael Buesch <mb at bu3sch.de>, Bcm43xx-dev at lists.berlios.de
>> Subject: Re: Problem with the lid closing event
>>
>> Larry,
>>
>> -----Original Message-----
>>> From: Larry Finger <larry.finger at lwfinger.net>
>>> Sent: Jan 28, 2007 6:17 PM
>>> To: Igor Korot <ikorot at earthlink.net>
>>> Cc: Michael Buesch <mb at bu3sch.de>, Bcm43xx-dev at lists.berlios.de
>>> Subject: Re: Problem with the lid closing event
>>>
>>> Igor Korot wrote:
>>>> Hi, Larry,
>>>> I did a quick test and, indeed, the value calculation is the same in both cases. Sorry about the confusion.
>>>>
>>>> However, I found another problem.
>>>> I am running Gentoo with 2.6.18 kernel with the LED activation and interrupt enabled patches.
>>>> After running "ifconfig eth1 up", the card is up, the WiFi LED is on, and everything works as expected.
>>>>
>>>> However, when I close and re-open the lid of my laptop, I lost the ability to restore it.
>>>>
>>>> I am not running the suspend software, I have a 'vbetool' installed on top of GNOME.
>>>> Since evrything was working, I was able to capture the dmesg output, which is attached.
>>>>
>>> I didn't see anything in the log that indicates an error. Is this dmesg output from before or after
>>> the lid closing? I don't see either the suspend or resume debug messages from bcm43xx.
>> This dmesg is after the lid has been open. The WiFi LED was still "on".
>> However, the screen was not restored.
>>
>>> There is a report of bcm43xx not resuming correctly after suspend to disk. Unfortunately, my
>>> graphics system crashes when I try to suspend and I have to do a power off. That prevents me from
>>> testing the suspend or resume code.
>> It might be the same issue, or the different one.
>> You can try to install the vbetool on you laptop, and check if it won't crash.
>> Then we can check for the bcm43xx driver behavior....
> 
> This is the software I installed:
> http://www.srcf.ucam.org/~mjg59/vbetool/

It won't even compile here. Perhaps it is because I have an x86_64 system. I don't have time to
debug that program.

Larry



From ubq7 at stud.uni-karlsruhe.de  Tue Jan 30 18:18:49 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Tue, 30 Jan 2007 18:18:49 +0100
Subject: Problem with the lid closing event
In-Reply-To: <45BF62B2.3070600@lwfinger.net>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
	<45BF62B2.3070600@lwfinger.net>
Message-ID: <200701301818.49856.ubq7@stud.uni-karlsruhe.de>

Am Dienstag 30 Januar 2007 16:22 schrieb Larry Finger:
> > This is the software I installed:
> > http://www.srcf.ucam.org/~mjg59/vbetool/
>
> It won't even compile here. Perhaps it is because I have an x86_64 system.
> I don't have time to debug that program.

You can use the debian package or its source:
http://packages.debian.org/testing/utils/vbetool

They have an amd64 package thus it should compile just fine.

HS


From geekypenguin at gmail.com  Tue Jan 30 19:59:40 2007
From: geekypenguin at gmail.com (Jory A. Pratt)
Date: Tue, 30 Jan 2007 12:59:40 -0600
Subject: Problem with the lid closing event
In-Reply-To: <200701301818.49856.ubq7@stud.uni-karlsruhe.de>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>	<45BF62B2.3070600@lwfinger.net>
	<200701301818.49856.ubq7@stud.uni-karlsruhe.de>
Message-ID: <45BF959C.2050809@gmail.com>

Hendrik Sattler wrote:
> Am Dienstag 30 Januar 2007 16:22 schrieb Larry Finger:
>   
>>> This is the software I installed:
>>> http://www.srcf.ucam.org/~mjg59/vbetool/
>>>       
>> It won't even compile here. Perhaps it is because I have an x86_64 system.
>> I don't have time to debug that program.
>>     
>
> You can use the debian package or its source:
> http://packages.debian.org/testing/utils/vbetool
>
> They have an amd64 package thus it should compile just fine.
>
>   
VBETOOLS is useless on x86_64, the package is only for i386 to i686
32bit machines, so your suggestion is useless in this case.

Jory



From ubq7 at stud.uni-karlsruhe.de  Tue Jan 30 20:32:28 2007
From: ubq7 at stud.uni-karlsruhe.de (Hendrik Sattler)
Date: Tue, 30 Jan 2007 20:32:28 +0100
Subject: Problem with the lid closing event
In-Reply-To: <45BF959C.2050809@gmail.com>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
	<200701301818.49856.ubq7@stud.uni-karlsruhe.de>
	<45BF959C.2050809@gmail.com>
Message-ID: <200701302032.29202.ubq7@stud.uni-karlsruhe.de>

Am Dienstag 30 Januar 2007 19:59 schrieb Jory A. Pratt:
> Hendrik Sattler wrote:
> > Am Dienstag 30 Januar 2007 16:22 schrieb Larry Finger:
> >>> This is the software I installed:
> >>> http://www.srcf.ucam.org/~mjg59/vbetool/
> >>
> >> It won't even compile here. Perhaps it is because I have an x86_64
> >> system. I don't have time to debug that program.
> >
> > You can use the debian package or its source:
> > http://packages.debian.org/testing/utils/vbetool
> >
> > They have an amd64 package thus it should compile just fine.
>
> VBETOOLS is useless on x86_64, the package is only for i386 to i686
> 32bit machines, so your suggestion is useless in this case.

Don't tell me, I only have i386, tell the debian maintainer. He obviously sees 
some usage, there.

HS


From androsyn at ratbox.org  Tue Jan 30 21:21:12 2007
From: androsyn at ratbox.org (Aaron Sethman)
Date: Tue, 30 Jan 2007 15:21:12 -0500 (EST)
Subject: Problem with the lid closing event
In-Reply-To: <45BF959C.2050809@gmail.com>
References: <10305175.1170095682386.JavaMail.root@elwamui-muscovy.atl.sa.earthlink.net>
	<45BF62B2.3070600@lwfinger.net>
	<200701301818.49856.ubq7@stud.uni-karlsruhe.de>
	<45BF959C.2050809@gmail.com>
Message-ID: <Pine.LNX.4.64.0701301517520.20569@squeaker.ratbox.org>


On Tue, 30 Jan 2007, Jory A. Pratt wrote:
>>
>> They have an amd64 package thus it should compile just fine.
>>
>>
> VBETOOLS is useless on x86_64, the package is only for i386 to i686
> 32bit machines, so your suggestion is useless in this case.
>

Funny that, it seems to work quite fine here on my system.

$ file /usr/sbin/vbetool
/usr/sbin/vbetool: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), 
for GNU/Linux 2.6.0, dynamically linked (uses shared libs), stripped

I end up needing it to get my backlight to turn back on when opening my 
laptop, I've got an ACPI script calling

/usr/sbin/vbetool dpms on

So....

-Aaron



From wilyeo at gmail.com  Wed Jan 31 02:22:51 2007
From: wilyeo at gmail.com (wy)
Date: Tue, 30 Jan 2007 17:22:51 -0800
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
Message-ID: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>

Hi,
    I just joined the list.  Recently, I upgraded to Fedora Core 6 from
Redhat 9.  My wireless card works fine on Redhat 9 after I went with
Linuxant drivers.
With Fedora Core 6, bcm43xx-fwcutter is available and performing the same
function as Linuxant was providing.  I was hoping this is an easy upgrade.
After 1 week, I still cannot get Core 6 to work with my wireless card.
Below is the message I get when I first try to use the original driver that
came with the notebook.

root at localhost r46482]# bcm43xx-fwcutter -w /lib/firmware bcmwl5.sys
Sorry, the input file is either wrong or not supported by bcm43xx-fwcutter.
This file has an unknown MD5sum 208a33d5a52040b5401d48b8e974f901.

This may be due to the driver version I have. This is pulled from the
bcmwl5.inf file.

DriverVer=07/09/2002, 3.08.27.0

I had tried other version of the firmware found in README.Fedora but none of
them works. Extracting the firmware works fine but it still cannot activate
the wireless card.

Has anyone got TrueMobile 1180 to run successfully on Core 6?  Thanks!

Will
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070130/6fdc640c/attachment.html>

From larry.finger at lwfinger.net  Wed Jan 31 03:32:55 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Tue, 30 Jan 2007 20:32:55 -0600
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
Message-ID: <45BFFFD7.2050006@lwfinger.net>

wy wrote:
> Hi,
>     I just joined the list.  Recently, I upgraded to Fedora Core 6 from
> Redhat 9.  My wireless card works fine on Redhat 9 after I went with
> Linuxant drivers.
> With Fedora Core 6, bcm43xx-fwcutter is available and performing the
> same function as Linuxant was providing.  I was hoping this is an easy
> upgrade. 

Linuxant provides an entirely different function than fwcutter.

> After 1 week, I still cannot get Core 6 to work with my wireless
> card.    Below is the message I get when I first try to use the original
> driver that came with the notebook.
> 
> root at localhost r46482]# bcm43xx-fwcutter -w /lib/firmware bcmwl5.sys
> Sorry, the input file is either wrong or not supported by bcm43xx-fwcutter.
> This file has an unknown MD5sum 208a33d5a52040b5401d48b8e974f901.
> 
> This may be due to the driver version I have. This is pulled from the
> bcmwl5.inf file.
> 
> DriverVer=07/09/2002, 3.08.27.0 <http://3.08.27.0>
> 
> I had tried other version of the firmware found in README.Fedora but
> none of them works. Extracting the firmware works fine but it still
> cannot activate the wireless card.
> 
> Has anyone got TrueMobile 1180 to run successfully on Core 6?  Thanks!

Unless you send us the output of dmesg and lspci -v, we cannot help you. I don't know which chip is
in your wireless device. Once I know that and the output of 'uname -r', then I can help you get started.

Larry


From Larry.Finger at lwfinger.net  Wed Jan 31 07:43:35 2007
From: Larry.Finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 00:43:35 -0600
Subject: Fix for code in mb git tree
Message-ID: <45C03A97.5070005@lwfinger.net>

Michael,

I think the patch below is needed. On my 4311 system, including this change improves throughput at
least by a factor of 5 at 1 Mb/s. It also matches the old specifications where txctl1 was multiplied
by 0x10.

Larry


Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
===================================================================
--- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
+++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
@@ -401,7 +401,7 @@ static void lo_measure_txctl_values(stru
 						       & 0xFFF0) | txctl2);
 				tmp0 = lo_measure_feedthrough(dev, lna, pga, trsw_rx);
 				if (tmp0 < minimum) {
-					lo->txctl1 = txctl1;
+					lo->txctl1 = txctl1 << 4;
 					lo->txctl2 = txctl2;
 					minimum = tmp0;
 				}



From wilyeo at gmail.com  Wed Jan 31 09:16:22 2007
From: wilyeo at gmail.com (wy)
Date: Wed, 31 Jan 2007 00:16:22 -0800
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <45BFFFD7.2050006@lwfinger.net>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
	<45BFFFD7.2050006@lwfinger.net>
Message-ID: <cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>

> Linuxant provides an entirely different function than fwcutter.
>
> Unless you send us the output of dmesg and lspci -v, we cannot help you. I
> don't know which chip is
> in your wireless device. Once I know that and the output of 'uname -r',
> then I can help you get started.
>
> Larry
>

Hi,
  I currently running on kernel 2.6.19-1.2895.fc6.  Let me know if some
information is needed.

dmesg content is

Linux version 2.6.19-1.2895.fc6 (brewbuilder at hs20-bc2-2.build.redhat.com)
(gcc version 4.1.1 20070105 (Red Hat 4.1.1-51)) #1 SMP Wed Jan 10 19:28:18
EST 2007
BIOS-provided physical RAM map:
 BIOS-e820: 0000000000000000 - 000000000009fc00 (usable)
 BIOS-e820: 000000000009fc00 - 00000000000a0000 (reserved)
 BIOS-e820: 0000000000100000 - 000000001ffe2800 (usable)
 BIOS-e820: 000000001ffe2800 - 0000000020000000 (reserved)
 BIOS-e820: 00000000feda0000 - 00000000fee00000 (reserved)
 BIOS-e820: 00000000ffb80000 - 0000000100000000 (reserved)
0MB HIGHMEM available.
511MB LOWMEM available.
Using x86 segment limits to approximate NX protection
Entering add_active_range(0, 0, 131042) 0 entries of 256 used
Zone PFN ranges:
  DMA             0 ->     4096
  Normal       4096 ->   131042
  HighMem    131042 ->   131042
early_node_map[1] active PFN ranges
    0:        0 ->   131042
On node 0 totalpages: 131042
  DMA zone: 32 pages used for memmap
  DMA zone: 0 pages reserved
  DMA zone: 4064 pages, LIFO batch:0
  Normal zone: 991 pages used for memmap
  Normal zone: 125955 pages, LIFO batch:31
  HighMem zone: 0 pages used for memmap
DMI 2.3 present.
Using APIC driver default
ACPI: RSDP (v000 DELL                                  ) @ 0x000fde50
ACPI: RSDT (v001 DELL    CPi R   0x27d20817 ASL  0x00000061) @ 0x000fde64
ACPI: FADT (v001 DELL    CPi R   0x27d20817 ASL  0x00000061) @ 0x000fde90
ACPI: DSDT (v001 INT430 SYSFexxx 0x00001001 MSFT 0x0100000e) @ 0x00000000
ACPI: PM-Timer IO Port: 0x808
Allocating PCI resources starting at 30000000 (gap: 20000000:deda0000)
Detected 1694.598 MHz processor.
Built 1 zonelists.  Total pages: 130019
Kernel command line: ro root=LABEL=/ rhgb quiet
Local APIC disabled by BIOS -- you can enable it with "lapic"
mapped APIC to ffffd000 (01425000)
Enabling fast FPU save and restore... done.
Enabling unmasked SIMD FPU exception support... done.
Initializing CPU#0
CPU 0 irqstacks, hard=c0808000 soft=c07e8000
PID hash table entries: 2048 (order: 11, 8192 bytes)
Console: colour VGA+ 80x25
Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)
Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)
Memory: 512712k/524168k available (2210k kernel code, 10868k reserved, 1135k
data, 244k init, 0k highmem)
virtual kernel memory layout:
    fixmap  : 0xffc56000 - 0xfffff000   (3748 kB)
    pkmap   : 0xff800000 - 0xffc00000   (4096 kB)
    vmalloc : 0xe0800000 - 0xff7fe000   ( 495 MB)
    lowmem  : 0xc0000000 - 0xdffe2000   ( 511 MB)
      .init : 0xc07a6000 - 0xc07e3000   ( 244 kB)
      .data : 0xc0628bff - 0xc07448f4   (1135 kB)
      .text : 0xc0400000 - 0xc0628bff   (2210 kB)
Checking if this processor honours the WP bit even in supervisor mode... Ok.
Calibrating delay using timer specific routine.. 3391.36 BogoMIPS
(lpj=1695684)
Security Framework v1.0.0 initialized
SELinux:  Initializing.
SELinux:  Starting in permissive mode
selinux_register_security:  Registering secondary module capability
Capability LSM initialized as secondary
Mount-cache hash table entries: 512
CPU: After generic identify, caps: bfebf9ff 00000000 00000000 00000000
00000400 00000000 00000000
CPU: Trace cache: 12K uops, L1 D cache: 8K
CPU: L2 cache: 512K
CPU: Hyper-Threading is disabled
CPU: After all inits, caps: bfebf1ff 00000000 00000000 00000080 00000400
00000000 00000000
Intel machine check architecture supported.
Intel machine check reporting enabled on CPU#0.
CPU0: Intel P4/Xeon Extended MCE MSRs (12) available
CPU0: Thermal monitoring enabled
Checking 'hlt' instruction... OK.
SMP alternatives: switching to UP code
Freeing SMP alternatives: 12k freed
ACPI: Core revision 20060707
ACPI: setting ELCR to 0200 (from 0800)
CPU0: Intel Mobile Intel(R) Pentium(R) 4 - M CPU 1.70GHz stepping 07
SMP motherboard not detected.
Local APIC not detected. Using dummy APIC emulation.
Brought up 1 CPUs
sizeof(vma)=84 bytes
sizeof(page)=32 bytes
sizeof(inode)=424 bytes
sizeof(dentry)=144 bytes
sizeof(ext3inode)=600 bytes
sizeof(buffer_head)=56 bytes
sizeof(skbuff)=172 bytes
sizeof(task_struct)=1376 bytes
checking if image is initramfs... it is
Freeing initrd memory: 1490k freed
NET: Registered protocol family 16
ACPI: bus type pci registered
PCI: PCI BIOS revision 2.10 entry at 0xfbfee, last bus=2
PCI: Using configuration type 1
Setting up standard PCI resources
ACPI: Interpreter enabled
ACPI: Using PIC for interrupt routing
ACPI: PCI Root Bridge [PCI0] (0000:00)
PCI: Probing PCI hardware (bus 00)
ACPI: Assume root bridge [\_SB_.PCI0] bus is 0
PCI quirk: region 0800-087f claimed by ICH4 ACPI/GPIO/TCO
PCI quirk: region 0880-08bf claimed by ICH4 GPIO
PCI: Ignoring BAR0-3 of IDE controller 0000:00:1f.1
Boot video device is 0000:01:00.0
PCI: Transparent bridge - 0000:00:1e.0
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
ACPI: PCI Interrupt Link [LNKA] (IRQs 9 10 *11)
ACPI: PCI Interrupt Link [LNKB] (IRQs 5 7) *11
ACPI: PCI Interrupt Link [LNKC] (IRQs 9 10 *11)
ACPI: PCI Interrupt Link [LNKD] (IRQs 5 7 9 10 *11)
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.AGP_._PRT]
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCIE._PRT]
ACPI: Power Resource [PADA] (on)
Linux Plug and Play Support v0.97 (c) Adam Belay
pnp: PnP ACPI init
pnp: PnP ACPI: found 18 devices
usbcore: registered new interface driver usbfs
usbcore: registered new interface driver hub
usbcore: registered new device driver usb
PCI: Using ACPI for IRQ routing
PCI: If a device doesn't work, try "pci=routeirq".  If it helps, post a
report
NetLabel: Initializing
NetLabel:  domain hash size = 128
NetLabel:  protocols = UNLABELED CIPSOv4
NetLabel:  unlabeled traffic allowed by default
pnp: 00:02: ioport range 0x4d0-0x4d1 has been reserved
pnp: 00:02: ioport range 0x800-0x805 could not be reserved
pnp: 00:02: ioport range 0x808-0x80f could not be reserved
pnp: 00:03: ioport range 0x806-0x807 has been reserved
pnp: 00:03: ioport range 0x810-0x85f could not be reserved
pnp: 00:03: ioport range 0x860-0x87f has been reserved
pnp: 00:03: ioport range 0x880-0x8bf has been reserved
pnp: 00:03: ioport range 0x8c0-0x8df has been reserved
pnp: 00:03: ioport range 0x8e0-0x8ff has been reserved
pnp: 00:04: ioport range 0xf000-0xf0fe has been reserved
pnp: 00:04: ioport range 0xf100-0xf1fe has been reserved
pnp: 00:04: ioport range 0xf200-0xf2fe has been reserved
pnp: 00:04: ioport range 0xf400-0xf4fe has been reserved
pnp: 00:04: ioport range 0xf500-0xf5fe has been reserved
pnp: 00:04: ioport range 0xf600-0xf6fe has been reserved
pnp: 00:04: ioport range 0xf800-0xf8fe has been reserved
pnp: 00:04: ioport range 0xf900-0xf9fe has been reserved
pnp: 00:09: ioport range 0x900-0x91f has been reserved
pnp: 00:09: ioport range 0x3f0-0x3f1 has been reserved
pnp: 00:10: ioport range 0xbf40-0xbf5f has been reserved
pnp: 00:10: ioport range 0xbf20-0xbf3f has been reserved
PCI: Bridge: 0000:00:01.0
  IO window: c000-cfff
  MEM window: fc000000-fdffffff
  PREFETCH window: e0000000-e7ffffff
PCI: Bus 3, cardbus bridge: 0000:02:01.0
  IO window: 0000e000-0000e0ff
  IO window: 0000e400-0000e4ff
  PREFETCH window: 30000000-31ffffff
  MEM window: f4000000-f5ffffff
PCI: Bus 7, cardbus bridge: 0000:02:01.1
  IO window: 0000e800-0000e8ff
  IO window: 00001000-000010ff
  PREFETCH window: 32000000-33ffffff
  MEM window: f6000000-f7ffffff
PCI: Bridge: 0000:00:1e.0
  IO window: e000-ffff
  MEM window: f4000000-fbffffff
  PREFETCH window: 30000000-34ffffff
PCI: Setting latency timer of device 0000:00:1e.0 to 64
PCI: Enabling device 0000:02:01.0 (0000 -> 0003)
ACPI: PCI Interrupt Link [LNKD] enabled at IRQ 11
PCI: setting IRQ 11 as level-triggered
ACPI: PCI Interrupt 0000:02:01.0[A] -> Link [LNKD] -> GSI 11 (level, low) ->
IRQ 11
PCI: Enabling device 0000:02:01.1 (0000 -> 0003)
ACPI: PCI Interrupt 0000:02:01.1[A] -> Link [LNKD] -> GSI 11 (level, low) ->
IRQ 11
NET: Registered protocol family 2
IP route cache hash table entries: 4096 (order: 2, 16384 bytes)
TCP established hash table entries: 16384 (order: 6, 327680 bytes)
TCP bind hash table entries: 8192 (order: 5, 163840 bytes)
TCP: Hash tables configured (established 16384 bind 8192)
TCP reno registered
speedstep: frequency transition measured seems out of range (0 nSec),
falling back to a safe one of 500000 nSec.
apm: BIOS version 1.2 Flags 0x03 (Driver version 1.16ac)
apm: overridden by ACPI.
audit: initializing netlink socket (disabled)
audit(1170201195.205:1): initialized
Total HugeTLB memory allocated, 0
VFS: Disk quotas dquot_6.5.1
Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)
SELinux:  Registering netfilter hooks
ksign: Installing public key data
Loading keyring
- Added public key A803A00FB8A89D68
- User ID: Red Hat, Inc. (Kernel Module GPG key)
io scheduler noop registered
io scheduler anticipatory registered
io scheduler deadline registered
io scheduler cfq registered (default)
pci_hotplug: PCI Hot Plug PCI Core version: 0.5
ACPI: CPU0 (power states: C1[C1] C2[C2])
ACPI: Processor [CPU0] (supports 8 throttling states)
ACPI: Thermal Zone [THM] (74 C)
isapnp: Scanning for PnP cards...
isapnp: No Plug & Play device found
Real Time Clock Driver v1.12ac
Non-volatile memory driver v1.2
Linux agpgart interface v0.101 (c) Dave Jones
agpgart: Detected an Intel i845 Chipset.
agpgart: AGP aperture is 64M @ 0xe8000000
Serial: 8250/16550 driver $Revision: 1.90 $ 4 ports, IRQ sharing enabled
serial8250: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A
serial8250: ttyS1 at I/O 0x2f8 (irq = 3) is a 16550A
00:0d: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A
ACPI: PCI Interrupt Link [LNKB] enabled at IRQ 5
PCI: setting IRQ 5 as level-triggered
ACPI: PCI Interrupt 0000:00:1f.6[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
ACPI: PCI interrupt for device 0000:00:1f.6 disabled
RAMDISK driver initialized: 16 RAM disks of 16384K size 4096 blocksize
Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
ICH3M: IDE controller at PCI slot 0000:00:1f.1
PCI: Enabling device 0000:00:1f.1 (0005 -> 0007)
ACPI: PCI Interrupt Link [LNKA] enabled at IRQ 11
ACPI: PCI Interrupt 0000:00:1f.1[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
ICH3M: chipset revision 2
ICH3M: not 100% native mode: will probe irqs later
    ide0: BM-DMA at 0xbfa0-0xbfa7, BIOS settings: hda:DMA, hdb:pio
    ide1: BM-DMA at 0xbfa8-0xbfaf, BIOS settings: hdc:DMA, hdd:pio
Probing IDE interface ide0...
hda: HITACHI_DK23EA-30, ATA DISK drive
ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
Probing IDE interface ide1...
hdc: HL-DT-STCD-RW/DVD-ROM GCC-4240N, ATAPI CD/DVD-ROM drive
ide1 at 0x170-0x177,0x376 on irq 15
hda: max request size: 128KiB
hda: 58605120 sectors (30005 MB) w/2048KiB Cache, CHS=58140/16/63, UDMA(100)
hda: cache flushes supported
 hda: hda1 hda2 hda3 hda4 < hda5 hda6 >
ide-floppy driver 0.99.newide
Yenta: CardBus bridge found at 0000:02:01.0 [1028:012b]
Yenta: Using CSCINT to route CSC interrupts to PCI
Yenta: Routing CardBus interrupts to PCI
Yenta TI: socket 0000:02:01.0, mfunc 0x01261222, devctl 0x64
Yenta: ISA IRQ mask 0x0498, PCI irq 11
Socket status: 30000006
pcmcia: parent PCI bridge I/O window: 0xe000 - 0xffff
cs: IO port probe 0xe000-0xffff: clean.
pcmcia: parent PCI bridge Memory window: 0xf4000000 - 0xfbffffff
pcmcia: parent PCI bridge Memory window: 0x30000000 - 0x34ffffff
Yenta: CardBus bridge found at 0000:02:01.1 [1028:012b]
Yenta: Using CSCINT to route CSC interrupts to PCI
Yenta: Routing CardBus interrupts to PCI
Yenta TI: socket 0000:02:01.1, mfunc 0x01261222, devctl 0x64
Yenta: ISA IRQ mask 0x0498, PCI irq 11
Socket status: 30000006
pcmcia: parent PCI bridge I/O window: 0xe000 - 0xffff
cs: IO port probe 0xe000-0xffff: clean.
pcmcia: parent PCI bridge Memory window: 0xf4000000 - 0xfbffffff
pcmcia: parent PCI bridge Memory window: 0x30000000 - 0x34ffffff
usbcore: registered new interface driver libusual
usbcore: registered new interface driver hiddev
usbcore: registered new interface driver usbhid
drivers/usb/input/hid-core.c: v2.6:USB HID core driver
PNP: PS/2 Controller [PNP0303:KBC,PNP0f13:PS2M] at 0x60,0x64 irq 1,12
serio: i8042 KBD port at 0x60,0x64 irq 1
serio: i8042 AUX port at 0x60,0x64 irq 12
mice: PS/2 mouse device common for all mice
TCP bic registered
Initializing XFRM netlink socket
NET: Registered protocol family 1
NET: Registered protocol family 17
Using IPI No-Shortcut mode
Time: tsc clocksource has been installed.
ACPI: (supports S0 S1 S3 S4 S5)
Freeing unused kernel memory: 244k freed
Write protecting the kernel read-only data: 416k
Time: acpi_pm clocksource has been installed.
input: AT Translated Set 2 keyboard as /class/input/input0
USB Universal Host Controller Interface driver v3.0
ACPI: PCI Interrupt 0000:00:1d.0[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
PCI: Setting latency timer of device 0000:00:1d.0 to 64
uhci_hcd 0000:00:1d.0: UHCI Host Controller
uhci_hcd 0000:00:1d.0: new USB bus registered, assigned bus number 1
uhci_hcd 0000:00:1d.0: irq 11, io base 0x0000bf80
usb usb1: configuration #1 chosen from 1 choice
hub 1-0:1.0: USB hub found
hub 1-0:1.0: 2 ports detected
ohci_hcd: 2006 August 04 USB 1.1 'Open' Host Controller (OHCI) Driver (PCI)
usb 1-1: new low speed USB device using uhci_hcd and address 2
SCSI subsystem initialized
libata version 2.00 loaded.
Synaptics Touchpad, model: 1, fw: 5.9, id: 0x9b4cb1, caps: 0x884793/0x0
serio: Synaptics pass-through port at isa0060/serio1/input0
input: SynPS/2 Synaptics TouchPad as /class/input/input1
kjournald starting.  Commit interval 5 seconds
EXT3-fs: mounted filesystem with ordered data mode.
usb 1-1: configuration #1 chosen from 1 choice
input: HID 0461:4d03 as /class/input/input2
input: USB HID v1.00 Mouse [HID 0461:4d03] on usb-0000:00:1d.0-1
input: PS/2 Generic Mouse as /class/input/input3
audit(1170201204.739:2): enforcing=1 old_enforcing=0 auid=4294967295
security:  3 users, 6 roles, 1586 types, 172 bools, 1 sens, 1024 cats
security:  59 classes, 49636 rules
SELinux:  Completing initialization.
SELinux:  Setting up existing superblocks.
SELinux: initialized (dev hda3, type ext3), uses xattr
SELinux: initialized (dev usbfs, type usbfs), uses genfs_contexts
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
SELinux: initialized (dev debugfs, type debugfs), uses genfs_contexts
SELinux: initialized (dev selinuxfs, type selinuxfs), uses genfs_contexts
SELinux: initialized (dev mqueue, type mqueue), uses transition SIDs
SELinux: initialized (dev hugetlbfs, type hugetlbfs), uses genfs_contexts
SELinux: initialized (dev devpts, type devpts), uses transition SIDs
SELinux: initialized (dev eventpollfs, type eventpollfs), uses task SIDs
SELinux: initialized (dev inotifyfs, type inotifyfs), uses genfs_contexts
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
SELinux: initialized (dev futexfs, type futexfs), uses genfs_contexts
SELinux: initialized (dev pipefs, type pipefs), uses task SIDs
SELinux: initialized (dev sockfs, type sockfs), uses task SIDs
SELinux: initialized (dev cpuset, type cpuset), not configured for labeling
SELinux: initialized (dev proc, type proc), uses genfs_contexts
SELinux: initialized (dev bdev, type bdev), uses genfs_contexts
SELinux: initialized (dev rootfs, type rootfs), uses genfs_contexts
SELinux: initialized (dev sysfs, type sysfs), uses genfs_contexts
audit(1170201205.089:3): policy loaded auid=4294967295
iTCO_wdt: Intel TCO WatchDog Timer Driver v1.00 (08-Oct-2006)
iTCO_wdt: Found a ICH3-M TCO device (Version=1, TCOBASE=0x0860)
iTCO_wdt: initialized. heartbeat=30 sec (nowayout=0)
intel_rng: FWH not detected
input: PC Speaker as /class/input/input4
cs: IO port probe 0x100-0x3af:ACPI: PCI Interrupt Link [LNKC] enabled at IRQ
11
ACPI: PCI Interrupt 0000:02:00.0[A] -> Link [LNKC] -> GSI 11 (level, low) ->
IRQ 11
3c59x: Donald Becker and others. www.scyld.com/network/vortex.html
0000:02:00.0: 3Com PCI 3c905C Tornado at e084cc00.
 excluding 0x280-0x287 0x378-0x37f
cs: IO port probe 0x3e0-0x4ff: clean.
cs: IO port probe 0x820-0x8ff: clean.
cs: IO port probe 0xc00-0xcf7: clean.
cs: IO port probe 0xa00-0xaff: clean.
hdc: ATAPI 24X DVD-ROM CD-R/RW drive, 2048kB Cache, UDMA(33)
Uniform CD-ROM driver Revision: 3.20
NET: Registered protocol family 23
ieee80211_crypt: registered algorithm 'NULL'
found SMC SuperIO Chip (devid=0x0e rev=01 base=0x002e): LPC47N252
smsc_ircc_present: can't get sir_base of 0x2f8
parport: PnPBIOS parport detected.
parport0: PC-style at 0x378 (0x778), irq 7 [PCSPP,TRISTATE]
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation <
jketreno at linux.intel.com>
Floppy drive(s): fd0 is 1.44M
cs: IO port probe 0x100-0x3af: excluding 0x280-0x287
cs: IO port probe 0x3e0-0x4ff: clean.
cs: IO port probe 0x820-0x8ff: clean.
cs: IO port probe 0xc00-0xcf7: clean.
cs: IO port probe 0xa00-0xaff: clean.
FDC 0 is a post-1991 82077
ACPI: PCI Interrupt 0000:00:1f.5[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
PCI: Setting latency timer of device 0000:00:1f.5 to 64
intel8x0_measure_ac97_clock: measured 50388 usecs
intel8x0: clocking to 48000
ACPI: PCI Interrupt 0000:00:1f.6[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
PCI: Setting latency timer of device 0000:00:1f.6 to 64
MC'97 1 converters and GPIO not ready (0xff00)
lp0: using parport0 (interrupt-driven).
lp0: console ready
sonypi: Sony Programmable I/O Controller Driver v1.26.
SELinux: initialized (dev ramfs, type ramfs), uses genfs_contexts
NET: Registered protocol family 10
lo: Disabled Privacy Extensions
Mobile IPv6
[drm] Initialized drm 1.0.1 20051102
ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
[drm] Initialized radeon 1.25.0 20060524 on minor 0
ACPI: AC Adapter [AC] (on-line)
ACPI: Battery Slot [BAT0] (battery present)
ACPI: Battery Slot [BAT1] (battery absent)
ACPI: Lid Switch [LID]
ACPI: Power Button (CM) [PBTN]
ACPI: Sleep Button (CM) [SBTN]
ACPI: ACPI Dock Station Driver
ibm_acpi: ec object not found
ACPI: Video Device [VID] (multi-head: yes  rom: no  post: no)
md: Autodetecting RAID arrays.
md: autorun ...
md: ... autorun DONE.
device-mapper: ioctl: 4.10.0-ioctl (2006-09-14) initialised:
dm-devel at redhat.com
device-mapper: multipath: version 1.0.5 loaded
EXT3 FS on hda3, internal journal
kjournald starting.  Commit interval 5 seconds
EXT3 FS on hda2, internal journal
EXT3-fs: mounted filesystem with ordered data mode.
SELinux: initialized (dev hda2, type ext3), uses xattr
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
kjournald starting.  Commit interval 5 seconds
EXT3 FS on hda6, internal journal
EXT3-fs: mounted filesystem with ordered data mode.
SELinux: initialized (dev hda6, type ext3), uses xattr
Adding 1052216k swap on /dev/hda5.  Priority:-1 extents:1 across:1052216k
SELinux: initialized (dev binfmt_misc, type binfmt_misc), uses
genfs_contexts


Here is the lspci -v output

00:00.0 Host bridge: Intel Corporation 82845 845 (Brookdale) Chipset Host
Bridge (rev 04)
    Flags: bus master, fast devsel, latency 0
    Memory at e8000000 (32-bit, prefetchable) [size=64M]
    Capabilities: <access denied>

00:01.0 PCI bridge: Intel Corporation 82845 845 (Brookdale) Chipset AGP
Bridge (rev 04) (prog-if 00 [Normal decode])
    Flags: bus master, 66MHz, fast devsel, latency 32
    Bus: primary=00, secondary=01, subordinate=01, sec-latency=32
    I/O behind bridge: 0000c000-0000cfff
    Memory behind bridge: fc000000-fdffffff
    Prefetchable memory behind bridge: e0000000-e7ffffff

00:1d.0 USB Controller: Intel Corporation 82801CA/CAM USB (Hub #1) (rev 02)
(prog-if 00 [UHCI])
    Subsystem: Intel Corporation Latitude C640
    Flags: bus master, medium devsel, latency 0, IRQ 11
    I/O ports at bf80 [size=32]

00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev 42)
(prog-if 00 [Normal decode])
    Flags: bus master, fast devsel, latency 0
    Bus: primary=00, secondary=02, subordinate=10, sec-latency=32
    I/O behind bridge: 0000e000-0000ffff
    Memory behind bridge: f4000000-fbffffff
    Prefetchable memory behind bridge: 30000000-34ffffff

00:1f.0 ISA bridge: Intel Corporation 82801CAM ISA Bridge (LPC) (rev 02)
    Flags: bus master, medium devsel, latency 0

00:1f.1 IDE interface: Intel Corporation 82801CAM IDE U100 (rev 02) (prog-if
8a [Master SecP PriP])
    Subsystem: Intel Corporation Latitude C640
    Flags: bus master, medium devsel, latency 0, IRQ 11
    I/O ports at <ignored>
    I/O ports at <ignored>
    I/O ports at <ignored>
    I/O ports at <ignored>
    I/O ports at bfa0 [size=16]
    Memory at 35000000 (32-bit, non-prefetchable) [size=1K]

00:1f.5 Multimedia audio controller: Intel Corporation 82801CA/CAM AC'97
Audio Controller (rev 02)
    Subsystem: Cirrus Logic Crystal WMD Audio Codec
    Flags: bus master, medium devsel, latency 0, IRQ 5
    I/O ports at d800 [size=256]
    I/O ports at dc80 [size=64]

00:1f.6 Modem: Intel Corporation 82801CA/CAM AC'97 Modem Controller (rev 02)
(prog-if 00 [Generic])
    Subsystem: Conexant MD56ORD V.92 MDC Modem
    Flags: bus master, medium devsel, latency 0, IRQ 5
    I/O ports at d400 [size=256]
    I/O ports at dc00 [size=128]

01:00.0 VGA compatible controller: ATI Technologies Inc Radeon Mobility M7
LW [Radeon Mobility 7500] (prog-if 00 [VGA])
    Subsystem: Dell Unknown device 012b
    Flags: bus master, VGA palette snoop, stepping, 66MHz, medium devsel,
latency 32, IRQ 11
    Memory at e0000000 (32-bit, prefetchable) [size=128M]
    I/O ports at c000 [size=256]
    Memory at fcff0000 (32-bit, non-prefetchable) [size=64K]
    [virtual] Expansion ROM at fc000000 [disabled] [size=128K]
    Capabilities: <access denied>

02:00.0 Ethernet controller: 3Com Corporation 3c905C-TX/TX-M [Tornado] (rev
78)
    Subsystem: Dell 3C920 Integrated Fast Ethernet Controller [Latitude
C640]
    Flags: bus master, medium devsel, latency 32, IRQ 11
    I/O ports at ec80 [size=128]
    Memory at f8fffc00 (32-bit, non-prefetchable) [size=128]
    Expansion ROM at 34000000 [disabled] [size=128K]
    Capabilities: <access denied>

02:01.0 CardBus bridge: Texas Instruments PCI1420
    Subsystem: Dell Unknown device 012b
    Flags: bus master, medium devsel, latency 168, IRQ 11
    Memory at f8000000 (32-bit, non-prefetchable) [size=4K]
    Bus: primary=02, secondary=03, subordinate=06, sec-latency=176
    Memory window 0: 30000000-31fff000 (prefetchable)
    Memory window 1: f4000000-f5fff000
    I/O window 0: 0000e000-0000e0ff
    I/O window 1: 0000e400-0000e4ff
    16-bit legacy interface ports at 0001

02:01.1 CardBus bridge: Texas Instruments PCI1420
    Subsystem: Dell Unknown device 012b
    Flags: bus master, medium devsel, latency 168, IRQ 11
    Memory at f8001000 (32-bit, non-prefetchable) [size=4K]
    Bus: primary=02, secondary=07, subordinate=0a, sec-latency=176
    Memory window 0: 32000000-33fff000 (prefetchable)
    Memory window 1: f6000000-f7fff000
    I/O window 0: 0000e800-0000e8ff
    I/O window 1: 00001000-000010ff
    16-bit legacy interface ports at 0001

02:03.0 Network controller: Broadcom Corporation BCM4303 802.11b Wireless
LAN Controller (rev 01)
    Subsystem: Dell TrueMobile 1180 Onboard WLAN
    Flags: bus master, fast devsel, latency 32, IRQ 11
    Memory at f8ffc000 (32-bit, non-prefetchable) [size=8K]
    Capabilities: <access denied>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070131/74cd6ef6/attachment.html>

From mb at bu3sch.de  Wed Jan 31 15:21:47 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 31 Jan 2007 15:21:47 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <45C03A97.5070005@lwfinger.net>
References: <45C03A97.5070005@lwfinger.net>
Message-ID: <200701311521.47614.mb@bu3sch.de>

On Wednesday 31 January 2007 07:43, Larry Finger wrote:
> Michael,
> 
> I think the patch below is needed. On my 4311 system, including this change improves throughput at
> least by a factor of 5 at 1 Mb/s. It also matches the old specifications where txctl1 was multiplied
> by 0x10.
> 
> Larry
> 
> 
> Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> ===================================================================
> --- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> +++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> @@ -401,7 +401,7 @@ static void lo_measure_txctl_values(stru
>  						       & 0xFFF0) | txctl2);
>  				tmp0 = lo_measure_feedthrough(dev, lna, pga, trsw_rx);
>  				if (tmp0 < minimum) {
> -					lo->txctl1 = txctl1;
> +					lo->txctl1 = txctl1 << 4;
>  					lo->txctl2 = txctl2;
>  					minimum = tmp0;
>  				}

I don't think this is correct, because the txctl1 value is bits 0-3
in the lo->txctl1 variable. So this would mean you get a better TX by using
a txctl1 value of zero. Your TX power improvement may come from other
bugs that are now hidden by the txctl1==0 thing.
Specs might also be wrong here. Afaik the broadcom driver indeed stores the
txctl1 value in bits 4-7. We don't do this. So we need to be careful
with changes like the above.

Anyway, all the txctl related code will be completely rewritten really
soon, as there are other bigger bugs than that. ;)

The txctl stuff currently is really confusing, as we are using the
name "txctl" for a few different things. But I think Joseph is doing
good progress at actually cleaning it up in v4 specs by assigning
more meaningful names to the variables.

-- 
Greetings Michael.


From asil.jinn at gmail.com  Wed Jan 31 16:18:14 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Wed, 31 Jan 2007 16:18:14 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <45C03A97.5070005@lwfinger.net>
References: <45C03A97.5070005@lwfinger.net>
Message-ID: <fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>

I tried again to run the wireless-dev on my dual core machine, but it still
crashes on bootup.. Is there any progress on smp with wireless-dev?

Regards
Yildirim

2007/1/31, Larry Finger < Larry.Finger at lwfinger.net>:
>
> Michael,
>
> I think the patch below is needed. On my 4311 system, including this
> change improves throughput at
> least by a factor of 5 at 1 Mb/s. It also matches the old specifications
> where txctl1 was multiplied
> by 0x10.
>
> Larry
>
>
> Index: wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> ===================================================================
> --- wireless-dev.orig/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> +++ wireless-dev/drivers/net/wireless/d80211/bcm43xx/bcm43xx_lo.c
> @@ -401,7 +401,7 @@ static void lo_measure_txctl_values(stru
>                                                        & 0xFFF0) |
> txctl2);
>                                 tmp0 = lo_measure_feedthrough(dev, lna,
> pga, trsw_rx);
>                                 if (tmp0 < minimum) {
> -                                       lo->txctl1 = txctl1;
> +                                       lo->txctl1 = txctl1 << 4;
>                                         lo->txctl2 = txctl2;
>                                         minimum = tmp0;
>                                 }
>
> _______________________________________________
> Bcm43xx-dev mailing list
> Bcm43xx-dev at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/bcm43xx-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070131/1c64bede/attachment.html>

From larry.finger at lwfinger.net  Wed Jan 31 16:46:39 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 09:46:39 -0600
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net>
	<fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>
Message-ID: <45C0B9DF.2090301@lwfinger.net>

Asil Jinn wrote:
> I tried again to run the wireless-dev on my dual core machine, but it
> still crashes on bootup.. Is there any progress on smp with wireless-dev?

There is lots of progress. I have an AMD 64 X2 (dual core) system running an SMP x86_64 system. I am
unable to authenticate with a WPA AP using wireless-dev; however, it doesn't crash.

What happens if you use a 'maxcpus=1' lin on bootup?

Larry





From mb at bu3sch.de  Wed Jan 31 16:52:55 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 31 Jan 2007 16:52:55 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net>
	<fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>
Message-ID: <200701311652.55238.mb@bu3sch.de>

On Wednesday 31 January 2007 16:18, Asil Jinn wrote:
> I tried again to run the wireless-dev on my dual core machine, but it still
> crashes on bootup.. Is there any progress on smp with wireless-dev?

There can't be any progress if we get this kind of bugreports...

It doesn't crash for me, so what should I do??

-- 
Greetings Michael.


From larry.finger at lwfinger.net  Wed Jan 31 17:00:50 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 10:00:50 -0600
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>	
	<45BFFFD7.2050006@lwfinger.net>
	<cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>
Message-ID: <45C0BD32.50500@lwfinger.net>

wy wrote:
> Hi,
>   I currently running on kernel 2.6.19-1.2895.fc6.  Let me know if some
> information is needed.

Your lspci -v output tells me that your device is a BCM4303, which is an 802.11b interface. Your
kernel should be OK for that device. From the dmesg output, the bcm43xx driver has not been loaded,
but there is no indication as to why.

Please send the output of 'lspci -n' and lsmod.

Larry



From mb at bu3sch.de  Wed Jan 31 17:04:43 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 31 Jan 2007 17:04:43 +0100
Subject: Need testing help
Message-ID: <200701311704.43955.mb@bu3sch.de>

I need some real-life data to estimate what the
ITSSI value usually is on different cards.
(ITSSI is called savedpctlreg in softmac driver).

Please run this patch on your machine, bring up
the interface and send dmesg back to me. Thanks.

Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
===================================================================
--- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-28 13:59:51.000000000 +0100
+++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-31 17:01:59.000000000 +0100
@@ -235,6 +235,7 @@ static void bcm43xx_phy_init_pctl(struct
 	bcm43xx_dummy_transmission(bcm);
 
 	phy->savedpctlreg = bcm43xx_phy_read(bcm, BCM43xx_PHY_G_PCTL);
+printk("savedpctlreg == %d\n", phy->savedpctlreg);
 
 	if (must_reset_txpower)
 		bcm43xx_radio_set_txpower_bg(bcm, saved_batt, saved_ratt, saved_txctl1);


-- 
Greetings Michael.


From martin-langer at gmx.de  Wed Jan 31 17:25:29 2007
From: martin-langer at gmx.de (Martin Langer)
Date: Wed, 31 Jan 2007 17:25:29 +0100
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
Message-ID: <20070131162529.GA3307@tuba>

On Tue, Jan 30, 2007 at 05:22:51PM -0800, wy wrote:

> root at localhost r46482]# bcm43xx-fwcutter -w /lib/firmware bcmwl5.sys
> Sorry, the input file is either wrong or not supported by bcm43xx-fwcutter.
> This file has an unknown MD5sum 208a33d5a52040b5401d48b8e974f901.
> 
> DriverVer=07/09/2002, 3.08.27.0

You can send me your bcmwl5.sys and I will add fwcutter support. But I'm 
afraid that it doesn't has a pcm image inside. Those old images 
shouldn't be the first choice nowadays. It should be the last option...

Martin


From larry.finger at lwfinger.net  Wed Jan 31 17:55:18 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 10:55:18 -0600
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <45C0C9F6.1050202@lwfinger.net>

Michael Buesch wrote:
> I need some real-life data to estimate what the
> ITSSI value usually is on different cards.
> (ITSSI is called savedpctlreg in softmac driver).
> 
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-28 13:59:51.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-31 17:01:59.000000000 +0100
> @@ -235,6 +235,7 @@ static void bcm43xx_phy_init_pctl(struct
>  	bcm43xx_dummy_transmission(bcm);
>  
>  	phy->savedpctlreg = bcm43xx_phy_read(bcm, BCM43xx_PHY_G_PCTL);
> +printk("savedpctlreg == %d\n", phy->savedpctlreg);
>  
>  	if (must_reset_txpower)
>  		bcm43xx_radio_set_txpower_bg(bcm, saved_batt, saved_ratt, saved_txctl1);
> 
> 
On a BCM4311, I get

Jan 31 10:53:53 larrylap2 kernel: bcm43xx: savedpctlreg = 0x17

Larry


From proski at gnu.org  Wed Jan 31 17:56:52 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 31 Jan 2007 11:56:52 -0500
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <45C0BD32.50500@lwfinger.net>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
	<45BFFFD7.2050006@lwfinger.net>
	<cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>
	<45C0BD32.50500@lwfinger.net>
Message-ID: <1170262612.22595.16.camel@dv>

On Wed, 2007-01-31 at 10:00 -0600, Larry Finger wrote:
> wy wrote:
> > Hi,
> >   I currently running on kernel 2.6.19-1.2895.fc6.  Let me know if some
> > information is needed.
> 
> Your lspci -v output tells me that your device is a BCM4303, which is an 802.11b interface. Your
> kernel should be OK for that device. From the dmesg output, the bcm43xx driver has not been loaded,
> but there is no indication as to why.

Larry, while you are talking about dmesg _output_, wy referred to dmesg
_content_, presumably the contents of /var/log/dmesg, which includes
only kernel messages at boot.

wy, you need to run the "dmesg" command to get the kernel messages.  The
part you sent is actually the least useful part of the kernel log.  The
useful part is what happens after the driver is loaded.  Oh, and please
write in plain text without HTML, otherwise your logs double in side.

-- 
Regards,
Pavel Roskin




From larry.finger at lwfinger.net  Wed Jan 31 18:11:13 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 11:11:13 -0600
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <1170262612.22595.16.camel@dv>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>	
	<45BFFFD7.2050006@lwfinger.net>	
	<cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>	
	<45C0BD32.50500@lwfinger.net> <1170262612.22595.16.camel@dv>
Message-ID: <45C0CDB1.60203@lwfinger.net>

Pavel Roskin wrote:
> On Wed, 2007-01-31 at 10:00 -0600, Larry Finger wrote:
>> wy wrote:
>>> Hi,
>>>   I currently running on kernel 2.6.19-1.2895.fc6.  Let me know if some
>>> information is needed.
>> Your lspci -v output tells me that your device is a BCM4303, which is an 802.11b interface. Your
>> kernel should be OK for that device. From the dmesg output, the bcm43xx driver has not been loaded,
>> but there is no indication as to why.
> 
> Larry, while you are talking about dmesg _output_, wy referred to dmesg
> _content_, presumably the contents of /var/log/dmesg, which includes
> only kernel messages at boot.
> 
> wy, you need to run the "dmesg" command to get the kernel messages.  The
> part you sent is actually the least useful part of the kernel log.  The
> useful part is what happens after the driver is loaded.  Oh, and please
> write in plain text without HTML, otherwise your logs double in side.
> 

I was not aware that some distros make /var/log/'dmesg. I've only run SuSE, which puts that stuff in
/var/log/boot.msg. Yes, I do want the output of the dmesg command. I'll be more clear next time.

Larry



From asil.jinn at gmail.com  Wed Jan 31 18:27:47 2007
From: asil.jinn at gmail.com (Asil Jinn)
Date: Wed, 31 Jan 2007 18:27:47 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <200701311652.55238.mb@bu3sch.de>
References: <45C03A97.5070005@lwfinger.net>
	<fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>
	<200701311652.55238.mb@bu3sch.de>
Message-ID: <fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>

Micheal.. but my email was not a bug report, which you will also notice if
you read it again. It was a simple status check of how it was going with the
smp part.

However it is a good idea to add the logs either way, but I have checked
kernel.log, and other log messages in /var/log/ and couldnt find the
specific information of the wireless-dev kernel crash. I have to hard reboot
every time it crashes.. I am using syslog-ng, Is there anything else I
should be using to get kernel crash logs?

Larry, maxcpus=1 did not help, nor did nosmp.


2007/1/31, Michael Buesch <mb at bu3sch.de>:
>
> On Wednesday 31 January 2007 16:18, Asil Jinn wrote:
> > I tried again to run the wireless-dev on my dual core machine, but it
> still
> > crashes on bootup.. Is there any progress on smp with wireless-dev?
>
> There can't be any progress if we get this kind of bugreports...
>
> It doesn't crash for me, so what should I do??
>
> --
> Greetings Michael.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070131/585c78fa/attachment.html>

From larry.finger at lwfinger.net  Wed Jan 31 18:42:37 2007
From: larry.finger at lwfinger.net (Larry Finger)
Date: Wed, 31 Jan 2007 11:42:37 -0600
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net>	
	<fb1e10a90701310718l12bdd8d3u46b63d169f12211f@mail.gmail.com>	
	<200701311652.55238.mb@bu3sch.de>
	<fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
Message-ID: <45C0D50D.8070601@lwfinger.net>

Asil Jinn wrote:
> Micheal.. but my email was not a bug report, which you will also notice
> if you read it again. It was a simple status check of how it was going
> with the smp part.
> 
> However it is a good idea to add the logs either way, but I have checked
> kernel.log, and other log messages in /var/log/ and couldnt find the
> specific information of the wireless-dev kernel crash. I have to hard
> reboot every time it crashes.. I am using syslog-ng, Is there anything
> else I should be using to get kernel crash logs?
> 
> Larry, maxcpus=1 did not help, nor did nosmp.

Does the SoftMAC version work for you?

Larry



From dang at fprintf.net  Wed Jan 31 20:31:55 2007
From: dang at fprintf.net (Daniel Gryniewicz)
Date: Wed, 31 Jan 2007 14:31:55 -0500
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <1170271916.1749.81.camel@athena.fprintf.net>

On Wed, 2007-01-31 at 17:04 +0100, Michael Buesch wrote:
> I need some real-life data to estimate what the
> ITSSI value usually is on different cards.
> (ITSSI is called savedpctlreg in softmac driver).
> 
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.
> 
> Index: wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c
> ===================================================================
> --- wireless-2.6.orig/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-28 13:59:51.000000000 +0100
> +++ wireless-2.6/drivers/net/wireless/bcm43xx/bcm43xx_phy.c	2007-01-31 17:01:59.000000000 +0100
> @@ -235,6 +235,7 @@ static void bcm43xx_phy_init_pctl(struct
>  	bcm43xx_dummy_transmission(bcm);
>  
>  	phy->savedpctlreg = bcm43xx_phy_read(bcm, BCM43xx_PHY_G_PCTL);
> +printk("savedpctlreg == %d\n", phy->savedpctlreg);
>  
>  	if (must_reset_txpower)
>  		bcm43xx_radio_set_txpower_bg(bcm, saved_batt, saved_ratt, saved_txctl1);
> 
> 

On bcm4318 (on x86_64) I get:

Jan 31 14:30:00 athena savedpctlreg == 49

Daniel



From mb at bu3sch.de  Wed Jan 31 20:55:14 2007
From: mb at bu3sch.de (Michael Buesch)
Date: Wed, 31 Jan 2007 20:55:14 +0100
Subject: Fix for code in mb git tree
In-Reply-To: <fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
References: <45C03A97.5070005@lwfinger.net> <200701311652.55238.mb@bu3sch.de>
	<fb1e10a90701310927o3db132d3q2d9f382bde5a7d3e@mail.gmail.com>
Message-ID: <200701312055.14492.mb@bu3sch.de>

On Wednesday 31 January 2007 18:27, Asil Jinn wrote:
> Micheal.. but my email was not a bug report, which you will also notice if
> you read it again. It was a simple status check of how it was going with the
> smp part.

Well, nobody here on the list wants to know about your private testing sessions.
If you are making your testing results public, _please_ do it completely or
avoid sending any mail in the first place. It's only these two options to
not waste people's time. Things like "It crashes for me, but I won't say what's
going on" is just annoying and wasting other peoples time. I can't see any
valueable information in such an email.

> However it is a good idea to add the logs either way, but I have checked
> kernel.log, and other log messages in /var/log/ and couldnt find the
> specific information of the wireless-dev kernel crash. I have to hard reboot
> every time it crashes.. I am using syslog-ng, Is there anything else I
> should be using to get kernel crash logs?

Ok, I think you need to setup a netconsole or serial console to live-capture
the oops message. Crash messages usually don't appear in the syslogs.
Or you can use a digital camera and take a photo of the screen.

-- 
Greetings Michael.


From wilyeo at gmail.com  Wed Jan 31 22:02:45 2007
From: wilyeo at gmail.com (wy)
Date: Wed, 31 Jan 2007 13:02:45 -0800
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <45C0CDB1.60203@lwfinger.net>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
	<45BFFFD7.2050006@lwfinger.net>
	<cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>
	<45C0BD32.50500@lwfinger.net> <1170262612.22595.16.camel@dv>
	<45C0CDB1.60203@lwfinger.net>
Message-ID: <cc2477a0701311302h65fdf950o170c37d8148bf056@mail.gmail.com>

On 1/31/07, Larry Finger <larry.finger at lwfinger.net> wrote:
>
> Pavel Roskin wrote:
> > On Wed, 2007-01-31 at 10:00 -0600, Larry Finger wrote:
> >> wy wrote:
> >>> Hi,
> >>>   I currently running on kernel 2.6.19-1.2895.fc6.  Let me know if
> some
> >>> information is needed.
> >> Your lspci -v output tells me that your device is a BCM4303, which is
> an 802.11b interface. Your
> >> kernel should be OK for that device. From the dmesg output, the bcm43xx
> driver has not been loaded,
> >> but there is no indication as to why.
> >
> > Larry, while you are talking about dmesg _output_, wy referred to dmesg
> > _content_, presumably the contents of /var/log/dmesg, which includes
> > only kernel messages at boot.
> >
> > wy, you need to run the "dmesg" command to get the kernel messages.  The
> > part you sent is actually the least useful part of the kernel log.  The
> > useful part is what happens after the driver is loaded.  Oh, and please
> > write in plain text without HTML, otherwise your logs double in side.
> >
>
> I was not aware that some distros make /var/log/'dmesg. I've only run
> SuSE, which puts that stuff in
> /var/log/boot.msg. Yes, I do want the output of the dmesg command. I'll be
> more clear next time.
>
> Larry



Here is the out of the dmesg .


Linux version 2.6.19-1.2895.fc6 (brewbuilder at hs20-bc2-2.build.redhat.com)
(gcc version 4.1.1 20070105 (Red Hat 4.1.1-51)) #1 SMP Wed Jan 10 19:28:18
EST 2007
BIOS-provided physical RAM map:
 BIOS-e820: 0000000000000000 - 000000000009fc00 (usable)
 BIOS-e820: 000000000009fc00 - 00000000000a0000 (reserved)
 BIOS-e820: 0000000000100000 - 000000001ffe2800 (usable)
 BIOS-e820: 000000001ffe2800 - 0000000020000000 (reserved)
 BIOS-e820: 00000000feda0000 - 00000000fee00000 (reserved)
 BIOS-e820: 00000000ffb80000 - 0000000100000000 (reserved)
0MB HIGHMEM available.
511MB LOWMEM available.
Using x86 segment limits to approximate NX protection
Entering add_active_range(0, 0, 131042) 0 entries of 256 used
Zone PFN ranges:
  DMA             0 ->     4096
  Normal       4096 ->   131042
  HighMem    131042 ->   131042
early_node_map[1] active PFN ranges
    0:        0 ->   131042
On node 0 totalpages: 131042
  DMA zone: 32 pages used for memmap
  DMA zone: 0 pages reserved
  DMA zone: 4064 pages, LIFO batch:0
  Normal zone: 991 pages used for memmap
  Normal zone: 125955 pages, LIFO batch:31
  HighMem zone: 0 pages used for memmap
DMI 2.3 present.
Using APIC driver default
ACPI: RSDP (v000 DELL                                  ) @ 0x000fde50
ACPI: RSDT (v001 DELL    CPi R   0x27d20817 ASL  0x00000061) @ 0x000fde64
ACPI: FADT (v001 DELL    CPi R   0x27d20817 ASL  0x00000061) @ 0x000fde90
ACPI: DSDT (v001 INT430 SYSFexxx 0x00001001 MSFT 0x0100000e) @ 0x00000000
ACPI: PM-Timer IO Port: 0x808
Allocating PCI resources starting at 30000000 (gap: 20000000:deda0000)
Detected 1196.157 MHz processor.
Built 1 zonelists.  Total pages: 130019
Kernel command line: ro root=LABEL=/ rhgb quiet
Local APIC disabled by BIOS -- you can enable it with "lapic"
mapped APIC to ffffd000 (01425000)
Enabling fast FPU save and restore... done.
Enabling unmasked SIMD FPU exception support... done.
Initializing CPU#0
CPU 0 irqstacks, hard=c0808000 soft=c07e8000
PID hash table entries: 2048 (order: 11, 8192 bytes)
Console: colour VGA+ 80x25
Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)
Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)
Memory: 512712k/524168k available (2210k kernel code, 10868k reserved, 1135k
data, 244k init, 0k highmem)
virtual kernel memory layout:
    fixmap  : 0xffc56000 - 0xfffff000   (3748 kB)
    pkmap   : 0xff800000 - 0xffc00000   (4096 kB)
    vmalloc : 0xe0800000 - 0xff7fe000   ( 495 MB)
    lowmem  : 0xc0000000 - 0xdffe2000   ( 511 MB)
      .init : 0xc07a6000 - 0xc07e3000   ( 244 kB)
      .data : 0xc0628bff - 0xc07448f4   (1135 kB)
      .text : 0xc0400000 - 0xc0628bff   (2210 kB)
Checking if this processor honours the WP bit even in supervisor mode... Ok.
Calibrating delay using timer specific routine.. 2394.37 BogoMIPS
(lpj=1197189)
Security Framework v1.0.0 initialized
SELinux:  Initializing.
SELinux:  Starting in permissive mode
selinux_register_security:  Registering secondary module capability
Capability LSM initialized as secondary
Mount-cache hash table entries: 512
CPU: After generic identify, caps: bfebf9ff 00000000 00000000 00000000
00000400 00000000 00000000
CPU: Trace cache: 12K uops, L1 D cache: 8K
CPU: L2 cache: 512K
CPU: Hyper-Threading is disabled
CPU: After all inits, caps: bfebf1ff 00000000 00000000 00000080 00000400
00000000 00000000
Intel machine check architecture supported.
Intel machine check reporting enabled on CPU#0.
CPU0: Intel P4/Xeon Extended MCE MSRs (12) available
CPU0: Thermal monitoring enabled
Checking 'hlt' instruction... OK.
SMP alternatives: switching to UP code
Freeing SMP alternatives: 12k freed
ACPI: Core revision 20060707
ACPI: setting ELCR to 0200 (from 0800)
CPU0: Intel Mobile Intel(R) Pentium(R) 4 - M CPU 1.70GHz stepping 07
SMP motherboard not detected.
Local APIC not detected. Using dummy APIC emulation.
Brought up 1 CPUs
sizeof(vma)=84 bytes
sizeof(page)=32 bytes
sizeof(inode)=424 bytes
sizeof(dentry)=144 bytes
sizeof(ext3inode)=600 bytes
sizeof(buffer_head)=56 bytes
sizeof(skbuff)=172 bytes
sizeof(task_struct)=1376 bytes
checking if image is initramfs... it is
Freeing initrd memory: 1490k freed
NET: Registered protocol family 16
ACPI: bus type pci registered
PCI: PCI BIOS revision 2.10 entry at 0xfbfee, last bus=2
PCI: Using configuration type 1
Setting up standard PCI resources
ACPI: Interpreter enabled
ACPI: Using PIC for interrupt routing
ACPI: PCI Root Bridge [PCI0] (0000:00)
PCI: Probing PCI hardware (bus 00)
ACPI: Assume root bridge [\_SB_.PCI0] bus is 0
PCI quirk: region 0800-087f claimed by ICH4 ACPI/GPIO/TCO
PCI quirk: region 0880-08bf claimed by ICH4 GPIO
PCI: Ignoring BAR0-3 of IDE controller 0000:00:1f.1
Boot video device is 0000:01:00.0
PCI: Transparent bridge - 0000:00:1e.0
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
ACPI: PCI Interrupt Link [LNKA] (IRQs 9 10 *11)
ACPI: PCI Interrupt Link [LNKB] (IRQs 5 7) *11
ACPI: PCI Interrupt Link [LNKC] (IRQs 9 10 *11)
ACPI: PCI Interrupt Link [LNKD] (IRQs 5 7 9 10 *11)
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.AGP_._PRT]
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCIE._PRT]
ACPI: Power Resource [PADA] (on)
Linux Plug and Play Support v0.97 (c) Adam Belay
pnp: PnP ACPI init
pnp: PnP ACPI: found 18 devices
usbcore: registered new interface driver usbfs
usbcore: registered new interface driver hub
usbcore: registered new device driver usb
PCI: Using ACPI for IRQ routing
PCI: If a device doesn't work, try "pci=routeirq".  If it helps, post a
report
NetLabel: Initializing
NetLabel:  domain hash size = 128
NetLabel:  protocols = UNLABELED CIPSOv4
NetLabel:  unlabeled traffic allowed by default
pnp: 00:02: ioport range 0x4d0-0x4d1 has been reserved
pnp: 00:02: ioport range 0x800-0x805 could not be reserved
pnp: 00:02: ioport range 0x808-0x80f could not be reserved
pnp: 00:03: ioport range 0x806-0x807 has been reserved
pnp: 00:03: ioport range 0x810-0x85f could not be reserved
pnp: 00:03: ioport range 0x860-0x87f has been reserved
pnp: 00:03: ioport range 0x880-0x8bf has been reserved
pnp: 00:03: ioport range 0x8c0-0x8df has been reserved
pnp: 00:03: ioport range 0x8e0-0x8ff has been reserved
pnp: 00:04: ioport range 0xf000-0xf0fe has been reserved
pnp: 00:04: ioport range 0xf100-0xf1fe has been reserved
pnp: 00:04: ioport range 0xf200-0xf2fe has been reserved
pnp: 00:04: ioport range 0xf400-0xf4fe has been reserved
pnp: 00:04: ioport range 0xf500-0xf5fe has been reserved
pnp: 00:04: ioport range 0xf600-0xf6fe has been reserved
pnp: 00:04: ioport range 0xf800-0xf8fe has been reserved
pnp: 00:04: ioport range 0xf900-0xf9fe has been reserved
pnp: 00:09: ioport range 0x900-0x91f has been reserved
pnp: 00:09: ioport range 0x3f0-0x3f1 has been reserved
pnp: 00:10: ioport range 0xbf40-0xbf5f has been reserved
pnp: 00:10: ioport range 0xbf20-0xbf3f has been reserved
PCI: Bridge: 0000:00:01.0
  IO window: c000-cfff
  MEM window: fc000000-fdffffff
  PREFETCH window: e0000000-e7ffffff
PCI: Bus 3, cardbus bridge: 0000:02:01.0
  IO window: 0000e000-0000e0ff
  IO window: 0000e400-0000e4ff
  PREFETCH window: 30000000-31ffffff
  MEM window: f4000000-f5ffffff
PCI: Bus 7, cardbus bridge: 0000:02:01.1
  IO window: 0000e800-0000e8ff
  IO window: 00001000-000010ff
  PREFETCH window: 32000000-33ffffff
  MEM window: f6000000-f7ffffff
PCI: Bridge: 0000:00:1e.0
  IO window: e000-ffff
  MEM window: f4000000-fbffffff
  PREFETCH window: 30000000-34ffffff
PCI: Setting latency timer of device 0000:00:1e.0 to 64
PCI: Enabling device 0000:02:01.0 (0000 -> 0003)
ACPI: PCI Interrupt Link [LNKD] enabled at IRQ 11
PCI: setting IRQ 11 as level-triggered
ACPI: PCI Interrupt 0000:02:01.0[A] -> Link [LNKD] -> GSI 11 (level, low) ->
IRQ 11
PCI: Enabling device 0000:02:01.1 (0000 -> 0003)
ACPI: PCI Interrupt 0000:02:01.1[A] -> Link [LNKD] -> GSI 11 (level, low) ->
IRQ 11
NET: Registered protocol family 2
IP route cache hash table entries: 4096 (order: 2, 16384 bytes)
TCP established hash table entries: 16384 (order: 6, 327680 bytes)
TCP bind hash table entries: 8192 (order: 5, 163840 bytes)
TCP: Hash tables configured (established 16384 bind 8192)
TCP reno registered
speedstep: frequency transition measured seems out of range (0 nSec),
falling back to a safe one of 500000 nSec.
apm: BIOS version 1.2 Flags 0x03 (Driver version 1.16ac)
apm: overridden by ACPI.
audit: initializing netlink socket (disabled)
audit(1170247476.363:1): initialized
Total HugeTLB memory allocated, 0
VFS: Disk quotas dquot_6.5.1
Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)
SELinux:  Registering netfilter hooks
ksign: Installing public key data
Loading keyring
- Added public key A803A00FB8A89D68
- User ID: Red Hat, Inc. (Kernel Module GPG key)
io scheduler noop registered
io scheduler anticipatory registered
io scheduler deadline registered
io scheduler cfq registered (default)
pci_hotplug: PCI Hot Plug PCI Core version: 0.5
ACPI: CPU0 (power states: C1[C1] C2[C2])
ACPI: Processor [CPU0] (supports 8 throttling states)
ACPI: Thermal Zone [THM] (32 C)
isapnp: Scanning for PnP cards...
isapnp: No Plug & Play device found
Real Time Clock Driver v1.12ac
Non-volatile memory driver v1.2
Linux agpgart interface v0.101 (c) Dave Jones
agpgart: Detected an Intel i845 Chipset.
agpgart: AGP aperture is 64M @ 0xe8000000
Serial: 8250/16550 driver $Revision: 1.90 $ 4 ports, IRQ sharing enabled
serial8250: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A
serial8250: ttyS1 at I/O 0x2f8 (irq = 3) is a 16550A
00:0d: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A
ACPI: PCI Interrupt Link [LNKB] enabled at IRQ 5
PCI: setting IRQ 5 as level-triggered
ACPI: PCI Interrupt 0000:00:1f.6[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
ACPI: PCI interrupt for device 0000:00:1f.6 disabled
RAMDISK driver initialized: 16 RAM disks of 16384K size 4096 blocksize
Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
ICH3M: IDE controller at PCI slot 0000:00:1f.1
PCI: Enabling device 0000:00:1f.1 (0005 -> 0007)
ACPI: PCI Interrupt Link [LNKA] enabled at IRQ 11
ACPI: PCI Interrupt 0000:00:1f.1[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
ICH3M: chipset revision 2
ICH3M: not 100% native mode: will probe irqs later
    ide0: BM-DMA at 0xbfa0-0xbfa7, BIOS settings: hda:DMA, hdb:pio
    ide1: BM-DMA at 0xbfa8-0xbfaf, BIOS settings: hdc:DMA, hdd:pio
Probing IDE interface ide0...
hda: HITACHI_DK23EA-30, ATA DISK drive
ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
Probing IDE interface ide1...
hdc: HL-DT-STCD-RW/DVD-ROM GCC-4240N, ATAPI CD/DVD-ROM drive
ide1 at 0x170-0x177,0x376 on irq 15
hda: max request size: 128KiB
hda: 58605120 sectors (30005 MB) w/2048KiB Cache, CHS=58140/16/63, UDMA(100)
hda: cache flushes supported
 hda: hda1 hda2 hda3 hda4 < hda5 hda6 >
ide-floppy driver 0.99.newide
Yenta: CardBus bridge found at 0000:02:01.0 [1028:012b]
Yenta: Using CSCINT to route CSC interrupts to PCI
Yenta: Routing CardBus interrupts to PCI
Yenta TI: socket 0000:02:01.0, mfunc 0x01261222, devctl 0x64
Yenta: ISA IRQ mask 0x0498, PCI irq 11
Socket status: 30000006
pcmcia: parent PCI bridge I/O window: 0xe000 - 0xffff
cs: IO port probe 0xe000-0xffff: clean.
pcmcia: parent PCI bridge Memory window: 0xf4000000 - 0xfbffffff
pcmcia: parent PCI bridge Memory window: 0x30000000 - 0x34ffffff
Yenta: CardBus bridge found at 0000:02:01.1 [1028:012b]
Yenta: Using CSCINT to route CSC interrupts to PCI
Yenta: Routing CardBus interrupts to PCI
Yenta TI: socket 0000:02:01.1, mfunc 0x01261222, devctl 0x64
Yenta: ISA IRQ mask 0x0498, PCI irq 11
Socket status: 30000006
pcmcia: parent PCI bridge I/O window: 0xe000 - 0xffff
cs: IO port probe 0xe000-0xffff: clean.
pcmcia: parent PCI bridge Memory window: 0xf4000000 - 0xfbffffff
pcmcia: parent PCI bridge Memory window: 0x30000000 - 0x34ffffff
usbcore: registered new interface driver libusual
usbcore: registered new interface driver hiddev
usbcore: registered new interface driver usbhid
drivers/usb/input/hid-core.c: v2.6:USB HID core driver
PNP: PS/2 Controller [PNP0303:KBC,PNP0f13:PS2M] at 0x60,0x64 irq 1,12
serio: i8042 KBD port at 0x60,0x64 irq 1
serio: i8042 AUX port at 0x60,0x64 irq 12
mice: PS/2 mouse device common for all mice
TCP bic registered
Initializing XFRM netlink socket
NET: Registered protocol family 1
NET: Registered protocol family 17
Using IPI No-Shortcut mode
ACPI: (supports S0 S1 S3 S4 S5)
Time: tsc clocksource has been installed.
Freeing unused kernel memory: 244k freed
Write protecting the kernel read-only data: 416k
Time: acpi_pm clocksource has been installed.
input: AT Translated Set 2 keyboard as /class/input/input0
USB Universal Host Controller Interface driver v3.0
ACPI: PCI Interrupt 0000:00:1d.0[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
PCI: Setting latency timer of device 0000:00:1d.0 to 64
uhci_hcd 0000:00:1d.0: UHCI Host Controller
uhci_hcd 0000:00:1d.0: new USB bus registered, assigned bus number 1
uhci_hcd 0000:00:1d.0: irq 11, io base 0x0000bf80
usb usb1: configuration #1 chosen from 1 choice
hub 1-0:1.0: USB hub found
hub 1-0:1.0: 2 ports detected
ohci_hcd: 2006 August 04 USB 1.1 'Open' Host Controller (OHCI) Driver (PCI)
usb 1-1: new full speed USB device using uhci_hcd and address 2
SCSI subsystem initialized
libata version 2.00 loaded.
Synaptics Touchpad, model: 1, fw: 5.9, id: 0x9b4cb1, caps: 0x884793/0x0
serio: Synaptics pass-through port at isa0060/serio1/input0
usb 1-1: configuration #1 chosen from 1 choice
input: SynPS/2 Synaptics TouchPad as /class/input/input1
libusual: request for usb-storage succeeded, but module is not present
kjournald starting.  Commit interval 5 seconds
EXT3-fs: mounted filesystem with ordered data mode.
input: PS/2 Generic Mouse as /class/input/input2
audit(1170247485.560:2): enforcing=1 old_enforcing=0 auid=4294967295
security:  3 users, 6 roles, 1586 types, 172 bools, 1 sens, 1024 cats
security:  59 classes, 49636 rules
SELinux:  Completing initialization.
SELinux:  Setting up existing superblocks.
SELinux: initialized (dev hda3, type ext3), uses xattr
SELinux: initialized (dev usbfs, type usbfs), uses genfs_contexts
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
SELinux: initialized (dev debugfs, type debugfs), uses genfs_contexts
SELinux: initialized (dev selinuxfs, type selinuxfs), uses genfs_contexts
SELinux: initialized (dev mqueue, type mqueue), uses transition SIDs
SELinux: initialized (dev hugetlbfs, type hugetlbfs), uses genfs_contexts
SELinux: initialized (dev devpts, type devpts), uses transition SIDs
SELinux: initialized (dev eventpollfs, type eventpollfs), uses task SIDs
SELinux: initialized (dev inotifyfs, type inotifyfs), uses genfs_contexts
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
SELinux: initialized (dev futexfs, type futexfs), uses genfs_contexts
SELinux: initialized (dev pipefs, type pipefs), uses task SIDs
SELinux: initialized (dev sockfs, type sockfs), uses task SIDs
SELinux: initialized (dev cpuset, type cpuset), not configured for labeling
SELinux: initialized (dev proc, type proc), uses genfs_contexts
SELinux: initialized (dev bdev, type bdev), uses genfs_contexts
SELinux: initialized (dev rootfs, type rootfs), uses genfs_contexts
SELinux: initialized (dev sysfs, type sysfs), uses genfs_contexts
audit(1170247485.925:3): policy loaded auid=4294967295
Initializing USB Mass Storage driver...
scsi0 : SCSI emulation for USB Mass Storage devices
usbcore: registered new interface driver usb-storage
USB Mass Storage support registered.
usb-storage: device found at 2
usb-storage: waiting for device to settle before scanning
hdc: ATAPI 24X DVD-ROM CD-R/RW drive, 2048kB Cache, UDMA(33)
Uniform CD-ROM driver Revision: 3.20
NET: Registered protocol family 23
found SMC SuperIO Chip (devid=0x0e rev=01 base=0x002e): LPC47N252
smsc_ircc_present: can't get sir_base of 0x2f8
parport: PnPBIOS parport detected.
parport0: PC-style at 0x378 (0x778), irq 7 [PCSPP,TRISTATE]
iTCO_wdt: Intel TCO WatchDog Timer Driver v1.00 (08-Oct-2006)
iTCO_wdt: Found a ICH3-M TCO device (Version=1, TCOBASE=0x0860)
iTCO_wdt: initialized. heartbeat=30 sec (nowayout=0)
input: PC Speaker as /class/input/input3
ieee80211_crypt: registered algorithm 'NULL'
intel_rng: FWH not detected
ACPI: PCI Interrupt Link [LNKC] enabled at IRQ 11
ACPI: PCI Interrupt 0000:02:00.0[A] -> Link [LNKC] -> GSI 11 (level, low) ->
IRQ 11
3c59x: Donald Becker and others. www.scyld.com/network/vortex.html
0000:02:00.0: 3Com PCI 3c905C Tornado at e0852c00.
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation <
jketreno at linux.intel.com>
Floppy drive(s): fd0 is 1.44M
FDC 0 is a post-1991 82077
cs: IO port probe 0x100-0x3af: excluding 0x280-0x287
cs: IO port probe 0x3e0-0x4ff: clean.
cs: IO port probe 0x820-0x8ff: clean.
cs: IO port probe 0xc00-0xcf7: clean.
cs: IO port probe 0xa00-0xaff: clean.
cs: IO port probe 0x100-0x3af: excluding 0x280-0x287
cs: IO port probe 0x3e0-0x4ff: clean.
cs: IO port probe 0x820-0x8ff: clean.
cs: IO port probe 0xc00-0xcf7: clean.
cs: IO port probe 0xa00-0xaff: clean.
ACPI: PCI Interrupt 0000:00:1f.5[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
PCI: Setting latency timer of device 0000:00:1f.5 to 64
scsi 0:0:0:0: Direct-Access     Flash    Drive UT_USB20   0.00 PQ: 0 ANSI: 2
SCSI device sda: 1008000 512-byte hdwr sectors (516 MB)
sda: Write Protect is off
sda: Mode Sense: 00 00 00 00
sda: assuming drive cache: write through
SCSI device sda: 1008000 512-byte hdwr sectors (516 MB)
sda: Write Protect is off
sda: Mode Sense: 00 00 00 00
sda: assuming drive cache: write through
 sda: sda1
sd 0:0:0:0: Attached scsi removable disk sda
usb-storage: device scan complete
intel8x0_measure_ac97_clock: measured 50335 usecs
intel8x0: clocking to 48000
ACPI: PCI Interrupt 0000:00:1f.6[B] -> Link [LNKB] -> GSI 5 (level, low) ->
IRQ 5
PCI: Setting latency timer of device 0000:00:1f.6 to 64
MC'97 1 converters and GPIO not ready (0xff00)
sd 0:0:0:0: Attached scsi generic sg0 type 0
lp0: using parport0 (interrupt-driven).
lp0: console ready
sonypi: Sony Programmable I/O Controller Driver v1.26.
SELinux: initialized (dev ramfs, type ramfs), uses genfs_contexts
NET: Registered protocol family 10
lo: Disabled Privacy Extensions
Mobile IPv6
[drm] Initialized drm 1.0.1 20051102
ACPI: PCI Interrupt 0000:01:00.0[A] -> Link [LNKA] -> GSI 11 (level, low) ->
IRQ 11
[drm] Initialized radeon 1.25.0 20060524 on minor 0
ACPI: AC Adapter [AC] (off-line)
ACPI: Battery Slot [BAT0] (battery present)
ACPI: Battery Slot [BAT1] (battery absent)
ACPI: Lid Switch [LID]
ACPI: Power Button (CM) [PBTN]
ACPI: Sleep Button (CM) [SBTN]
ACPI: ACPI Dock Station Driver
ibm_acpi: ec object not found
ACPI: Video Device [VID] (multi-head: yes  rom: no  post: no)
md: Autodetecting RAID arrays.
md: autorun ...
md: ... autorun DONE.
device-mapper: ioctl: 4.10.0-ioctl (2006-09-14) initialised:
dm-devel at redhat.com
device-mapper: multipath: version 1.0.5 loaded
EXT3 FS on hda3, internal journal
kjournald starting.  Commit interval 5 seconds
EXT3 FS on hda2, internal journal
EXT3-fs: mounted filesystem with ordered data mode.
SELinux: initialized (dev hda2, type ext3), uses xattr
SELinux: initialized (dev tmpfs, type tmpfs), uses transition SIDs
kjournald starting.  Commit interval 5 seconds
EXT3 FS on hda6, internal journal
EXT3-fs: mounted filesystem with ordered data mode.
SELinux: initialized (dev hda6, type ext3), uses xattr
Adding 1052216k swap on /dev/hda5.  Priority:-1 extents:1 across:1052216k
SELinux: initialized (dev binfmt_misc, type binfmt_misc), uses
genfs_contexts
ip6_tables: (C) 2000-2006 Netfilter Core Team
ip_tables: (C) 2000-2006 Netfilter Core Team
Netfilter messages via NETLINK v0.30.
ip_conntrack version 2.4 (4095 buckets, 32760 max) - 232 bytes per conntrack
process `sysctl' is using deprecated sysctl (syscall)
net.ipv6.neigh.lo.base_reachable_time; Use
net.ipv6.neigh.lo.base_reachable_time_ms instead.
eth0:  setting half-duplex.
ADDRCONF(NETDEV_UP): eth0: link is not ready
SELinux: initialized (dev rpc_pipefs, type rpc_pipefs), uses genfs_contexts
Bluetooth: Core ver 2.11
NET: Registered protocol family 31
Bluetooth: HCI device and connection manager initialized
Bluetooth: HCI socket layer initialized
Bluetooth: L2CAP ver 2.8
Bluetooth: L2CAP socket layer initialized
Bluetooth: RFCOMM socket layer initialized
Bluetooth: RFCOMM TTY layer initialized
Bluetooth: RFCOMM ver 1.8
Bluetooth: HIDP (Human Interface Emulation) ver 1.1
SELinux: initialized (dev autofs, type autofs), uses genfs_contexts
SELinux: initialized (dev autofs, type autofs), uses genfs_contexts
SELinux: initialized (dev autofs, type autofs), uses genfs_contexts
mtrr: 0xe0000000,0x8000000 overlaps existing 0xe0000000,0x1000000
mtrr: 0xe0000000,0x8000000 overlaps existing 0xe0000000,0x1000000
mtrr: 0xe0000000,0x8000000 overlaps existing 0xe0000000,0x1000000
agpgart: Found an AGP 2.0 compliant device at 0000:00:00.0.
agpgart: Putting AGP V2 device at 0000:00:00.0 into 1x mode
agpgart: Putting AGP V2 device at 0000:01:00.0 into 1x mode
[drm] Setting GART location based on new memory map
[drm] writeback test succeeded in 2 usecs
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/bcm43xx-dev/attachments/20070131/088dbad8/attachment.html>

From proski at gnu.org  Wed Jan 31 22:18:54 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 31 Jan 2007 16:18:54 -0500
Subject: bcm43xx-fwcutter and Dell TrueMobile 1180
In-Reply-To: <cc2477a0701311302h65fdf950o170c37d8148bf056@mail.gmail.com>
References: <cc2477a0701301722n79722f98tb4f2bc7523b5b3ec@mail.gmail.com>
	<45BFFFD7.2050006@lwfinger.net>
	<cc2477a0701310016l415b6a53y42c0f88480adc6f7@mail.gmail.com>
	<45C0BD32.50500@lwfinger.net> <1170262612.22595.16.camel@dv>
	<45C0CDB1.60203@lwfinger.net>
	<cc2477a0701311302h65fdf950o170c37d8148bf056@mail.gmail.com>
Message-ID: <1170278334.22595.30.camel@dv>

On Wed, 2007-01-31 at 13:02 -0800, wy wrote:

>         Pavel Roskin wrote:
[skip]
>         > wy, you need to run the "dmesg" command to get the kernel
>         messages.  The
>         > part you sent is actually the least useful part of the
>         kernel log.  The
>         > useful part is what happens after the driver is loaded.  Oh,
>         and please 
>         > write in plain text without HTML, otherwise your logs double
>         in side.

Oh well.  You sent the same log again, you didn't include messages from
the driver (presumably because it was never loaded), and you sent it in
text and HTML again.  I'm sorry but I'll have to ignore this thread.

-- 
Regards,
Pavel Roskin




From proski at gnu.org  Wed Jan 31 21:50:34 2007
From: proski at gnu.org (Pavel Roskin)
Date: Wed, 31 Jan 2007 15:50:34 -0500
Subject: Need testing help
In-Reply-To: <200701311704.43955.mb@bu3sch.de>
References: <200701311704.43955.mb@bu3sch.de>
Message-ID: <1170276634.22595.23.camel@dv>

On Wed, 2007-01-31 at 17:04 +0100, Michael Buesch wrote:
> I need some real-life data to estimate what the
> ITSSI value usually is on different cards.
> (ITSSI is called savedpctlreg in softmac driver).
> 
> Please run this patch on your machine, bring up
> the interface and send dmesg back to me. Thanks.

bcm43xx: Chip ID 0x4311, rev 0x1
bcm43xx: Number of cores: 4
bcm43xx: Core 0: ID 0x800, rev 0x11, vendor 0x4243
bcm43xx: Core 1: ID 0x812, rev 0xa, vendor 0x4243
bcm43xx: Core 2: ID 0x817, rev 0x3, vendor 0x4243
bcm43xx: Core 3: ID 0x820, rev 0x1, vendor 0x4243
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 4, Type 2, Revision 8
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x123, pl 0x23 (2005-03-22  00:11:18)
bcm43xx: Radio turned on
savedpctlreg == 49
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)

# lspci -n -v -s 0c:00.0
0c:00.0 0280: 14e4:4312 (rev 01)
        Subsystem: 1028:0007
        Flags: bus master, fast devsel, latency 0, IRQ 17
        Memory at efdfc000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel

Dell Latitude D-520 with internal PCIe card, Fedora Core 6 x86_64.

P.S. savedpctlreg is 49 under 32-bit kernel as well.

-- 
Regards,
Pavel Roskin




From ikorot at earthlink.net  Wed Jan 31 23:25:22 2007
From: ikorot at earthlink.net (Igor Korot)
Date: Wed, 31 Jan 2007 14:25:22 -0800 (GMT-08:00)
Subject: Connected, but...
Message-ID: <30868456.1170282322900.JavaMail.root@elwamui-mouette.atl.sa.earthlink.net>

Hi,
I have very strange problem. Maybe it's because I'm running 2.6.18 kernel, but I think I saw somebody connected and worked with this version.

I have a bcm4311 card (Dell 1390 mini-PCI).

0b:00.0 Network controller: Broadcom Corporation Unknown device 4311 (rev 01)
        Subsystem: Dell Unknown device 0007
        Flags: bus master, fast devsel, latency 0, IRQ 16
        Memory at dfdfc000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Power Management version 2
        Capabilities: [58] Message Signalled Interrupts: 64bit- Queue=0/0 Enable-
        Capabilities: [d0] Express Legacy Endpoint IRQ 0
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [13c] Virtual Channel

I am using the 2.6.18 gentoo kernel with the PCIE, LED and interrupt patches.

Also, I have a wpa_supplicant version 0.5.4.

After the following commands:

ifconfig eth1 up
iwlist eth1 scan
iwconfig eth1 essid "IgorNetwork"

my GNOME shows connection for the eth1 interface. However, there is no transmission. I can't ping, I can't load the page using the wireless connection. The WiFi LED is on after the interface was brought up.

Issuing the command:

iwconfig eth1 enc <key1>

gives following:

Error for wireless request "Set Encode" (8B2A) :
    SET failed on device eth1 ; Operation not supported.

I don't have a passphrase setup apparently, so I am using the key that was generated.

The dmesg output is as follows:

bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Radio enabled by hardware
bcm43xx: Chip initialized
bcm43xx: 32-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bridge-eth1: enabling the bridge
bridge-eth1: is a Wireless Adapter
vmnet: You are trying to use wireless bridged networking together with
vmnet: vmware-any-any-update.  This is not supported configuration, and
vmnet: your wireless bridge will probably not work.
bridge-eth1: up
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:0f:d0:c0:05:b0
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:0f:d0:c0:05:b0.
SoftMAC: Sent Authentication Request to 00:0f:d0:c0:05:b0.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Sent Authentication Request to 00:0f:d0:c0:05:b0.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Sent Authentication Request to 00:0f:d0:c0:05:b0.
SoftMAC: Sent Authentication Request to 00:0f:d0:c0:05:b0.
SoftMAC: Authentication timed out with 00:0f:d0:c0:05:b0
eth1: could not initialize WEP: load module ieee80211_crypt_wep
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Queueing Authentication Request to 00:16:b6:c6:85:27
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:16:b6:c6:85:27.
SoftMAC: Open Authentication completed with 00:16:b6:c6:85:27
SoftMAC: sent association request!
SoftMAC: associated!
b44: eth0: Link is down.
SoftMAC: Authentication response received from 00:12:f0:7c:e7:63 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:12:f0:7c:e7:63 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:12:f0:7c:e7:63 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:12:f0:7c:e7:63 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:12:f0:7c:e7:63 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.
SoftMAC: Authentication response received from 00:16:b6:c6:85:27 but no queue item exists.

I attached only the relevant portion of the dmesg output.
If you need I can attach dmesg output after every single command.

Thank you in advance for any suggestion.



